<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>ClinicConnect - ‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</title>
  <link rel="icon" type="image/x-icon" href="./favicon.ico" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600;700&family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet" />

  <!-- Shared Styles -->
  <link rel="stylesheet" href="./shared/styles.css" />
</head>
<body>
  <div id="app">
    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen">
      <div class="loading-logo">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 2L2 7l10 5 10-5-10-5z" />
          <path d="m2 17 10 5 10-5" />
          <path d="m2 12 10 5 10-5" />
        </svg>
      </div>
      <div class="spinner"></div>
      <p id="loading-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
    </div>

    <!-- Error Screen -->
    <div id="error-screen" class="error-screen hidden">
      <div class="error-icon">‚ö†Ô∏è</div>
      <h2 class="error-title">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</h2>
      <p class="error-message">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
      <div class="error-actions">
        <button class="btn btn-primary" onclick="router.navigate('#/patient')">
          <span class="btn-icon">üë§</span>
          ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ
        </button>
        <button class="btn btn-outline" onclick="router.navigate('#/doctor')">
          <span class="btn-icon">üë®‚Äç‚öïÔ∏è</span>
          ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå
        </button>
      </div>
    </div>

    <!-- Role Selection (Auto-redirect based on role) -->
    <div id="role-selection" class="role-selection hidden">
      <div class="role-card">
        <div class="role-header">
          <h1>üè• ClinicConnect</h1>
          <p>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
        </div>
        <div class="role-buttons">
          <button class="role-btn patient" onclick="router.navigate('#/patient')">
            <span class="role-icon">üë§</span>
            <span class="role-name">‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ</span>
            <span class="role-desc">‡∏à‡∏≠‡∏á‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢ / ‡∏î‡∏π‡∏Ñ‡∏¥‡∏ß</span>
          </button>
          <button class="role-btn doctor" onclick="router.navigate('#/doctor')">
            <span class="role-icon">üë®‚Äç‚öïÔ∏è</span>
            <span class="role-name">‡πÅ‡∏û‡∏ó‡∏¢‡πå</span>
            <span class="role-desc">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏ß / ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Main App Container -->
    <div id="main-app" class="main-app hidden">
      <!-- Dynamic content loaded here -->
      <main id="app-content"></main>
    </div>
  </div>

  <!-- LIFF SDK -->
  <script>
    // Fallback if LIFF SDK fails to load
    window.liffLoadTimeout = setTimeout(() => {
      console.warn('LIFF SDK load timeout - app will run without LIFF');
      window.liff = null;
    }, 3000);
  </script>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/3/sdk.js" onload="clearTimeout(window.liffLoadTimeout)"></script>

  <!-- Router Script -->
  <script>
    // =====================================================
    // CLINIC CONNECT SAAS - UNIFIED ROUTER
    // =====================================================
    // Single LIFF ID with Hash Routing
    // Usage:
    //   #/patient     -> Patient app
    //   #/doctor      -> Doctor app
    //   (no hash)     -> Role selection
    // =====================================================

    const router = {
      // Configuration
      config: {
        liffId: '2009024944-uEXRao6i',
        apiBaseUrl: 'https://xklcronrzcervtjnodzs.supabase.co',
        defaultRole: 'patient' // Default if no role detected
      },

      // Current route info
      current: null,
      userRole: null,

      // Route definitions
      routes: {
        '/patient': {
          title: 'ClinicConnect - ‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ',
          component: 'patient-app',
          requireAuth: true,
          allowedRoles: ['patient', 'all']
        },
        '/doctor': {
          title: 'ClinicConnect - ‡πÅ‡∏û‡∏ó‡∏¢‡πå',
          component: 'doctor-app',
          requireAuth: true,
          allowedRoles: ['doctor', 'all']
        },
        '/': {
          title: 'ClinicConnect',
          component: 'role-selection',
          requireAuth: false
        }
      },

      // Initialize router
      async init() {
        this.showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô...');

        try {
          // Initialize LIFF (will skip if not available)
          await this.initLiff();

          // Hide loading now that init is done
          this.hideLoading();

          // Handle hash change
          window.addEventListener('hashchange', () => this.handleRoute());

          // Initial route
          this.handleRoute();

        } catch (error) {
          console.error('Router init error:', error);
          this.hideLoading();
          this.handleRoute(); // Show role selection on error
        }
      },

      // Initialize LIFF SDK
      async initLiff() {
        const liffId = this.config.liffId;

        // Use window.liff since we've ensured it's loaded
        const liff = window.liff;

        // If LIFF SDK didn't load, just continue without it
        if (!liff) {
          console.warn('LIFF SDK not available, running without LINE integration');
          this.currentUser = null;
          this.userRole = this.config.defaultRole;
          return;
        }

        if (!liffId || liffId === 'YOUR_LIFF_ID_HERE') {
          console.warn('LIFF ID not configured, running in dev mode');
          return;
        }

        try {
          await liff.init({ liffId });
          console.log('LIFF initialized successfully');
        } catch (error) {
          console.error('LIFF init error:', error);
          // Continue without LIFF
          return;
        }

        // Check if logged in
        if (!liff.isLoggedIn()) {
          console.log('User not logged in to LINE');
          // Continue without LIFF
          return;
        }

        console.log('User is logged in to LINE');

        // Get user profile
        try {
          const profile = await liff.getProfile();
          this.currentUser = profile;
          console.log('User profile loaded:', profile);
        } catch (error) {
          console.error('Get profile error:', error);
          // Continue without profile
        }

        // Detect user role from ID or profile
        await this.detectUserRole();
      },

      // Detect user role (can be extended)
      async detectUserRole() {
        // TODO: Implement role detection from your backend
        // Example:
        // const { data } = await supabase
        //   .from('user_profiles')
        //   .select('role')
        //   .eq('line_user_id', this.currentUser.userId)
        //   .single();
        // this.userRole = data?.role;

        // For now, use hash or default
        this.userRole = this.config.defaultRole;
      },

      // Handle route change
      handleRoute() {
        const hash = window.location.hash || '#/';
        const path = hash.substring(1); // Remove #
        const route = this.routes[path] || this.routes['/'];

        this.current = { path, route };

        // Update title
        document.title = route.title;

        // Render route
        this.render(route);
      },

      // Render route component
      async render(route) {
        this.hideAllScreens();

        switch (route.component) {
          case 'patient-app':
            await this.loadPatientApp();
            break;
          case 'doctor-app':
            await this.loadDoctorApp();
            break;
          case 'role-selection':
            this.showRoleSelection();
            break;
          default:
            this.showError('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£');
        }
      },

      // Load Patient App
      async loadPatientApp() {
        this.showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...');

        try {
          // Load patient app HTML
          const response = await fetch('./liff-patient/dist/index.html');
          if (!response.ok) throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ‡πÑ‡∏î‡πâ');

          const html = await response.text();
          const content = this.extractBodyContent(html);

          document.getElementById('app-content').innerHTML = content;
          this.showMainApp();

          // Initialize patient app scripts
          await this.loadScripts('./liff-patient/dist/assets/', 'patient');

        } catch (error) {
          console.error('Load patient app error:', error);
          this.showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ‡πÑ‡∏î‡πâ');
        }
      },

      // Load Doctor App
      async loadDoctorApp() {
        this.showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...');

        try {
          // Load doctor app HTML
          const response = await fetch('./liff-doctor/dist/index.html');
          if (!response.ok) throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÑ‡∏î‡πâ');

          const html = await response.text();
          const content = this.extractBodyContent(html);

          document.getElementById('app-content').innerHTML = content;
          this.showMainApp();

          // Initialize doctor app scripts
          await this.loadScripts('./liff-doctor/dist/assets/', 'doctor');

        } catch (error) {
          console.error('Load doctor app error:', error);
          this.showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÑ‡∏î‡πâ');
        }
      },

      // Extract body content from HTML
      extractBodyContent(html) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');

        // Get the app div
        const appDiv = doc.querySelector('#app');
        if (appDiv) {
          return appDiv.innerHTML;
        }

        // Fallback to body content
        return doc.body.innerHTML;
      },

      // Load scripts dynamically
      async loadScripts(basePath, appType) {
        // Scripts will be loaded by the app's own entry point
        // This is a placeholder for any shared initialization
        console.log(`${appType} app loaded`);

        // Emit custom event for app initialization
        window.dispatchEvent(new CustomEvent('appLoaded', {
          detail: { appType, user: this.currentUser }
        }));
      },

      // Navigation helper
      navigate(hash) {
        window.location.hash = hash;
      },

      // UI Helpers
      showLoading(text = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...') {
        document.getElementById('loading-text').textContent = text;
        document.getElementById('loading-screen').classList.remove('hidden');
      },

      hideLoading() {
        document.getElementById('loading-screen').classList.add('hidden');
      },

      hideAllScreens() {
        document.getElementById('loading-screen').classList.add('hidden');
        document.getElementById('error-screen').classList.add('hidden');
        document.getElementById('role-selection').classList.add('hidden');
        document.getElementById('main-app').classList.add('hidden');
      },

      showMainApp() {
        this.hideLoading();
        document.getElementById('main-app').classList.remove('hidden');
      },

      showRoleSelection() {
        this.hideLoading();
        document.getElementById('role-selection').classList.remove('hidden');
      },

      showError(message) {
        this.hideLoading();
        const errorScreen = document.getElementById('error-screen');
        const errorMsg = errorScreen.querySelector('.error-message');
        errorMsg.textContent = message;
        errorScreen.classList.remove('hidden');
      }
    };

    // =====================================================
    // EXPORTS
    // =====================================================
    window.router = router;

    // Auto-start router when DOM ready AND LIFF SDK loaded
    function startApp() {
      let attempts = 0;
      const maxAttempts = 100; // 10 seconds max wait

      // Check if both DOM is ready and LIFF is loaded
      const checkReady = () => {
        attempts++;

        // Check DOM is ready and LIFF SDK is loaded
        if (document.readyState !== 'loading' && typeof window.liff !== 'undefined') {
          console.log('Starting app...');
          router.init();
        } else if (attempts < maxAttempts) {
          // Check again in 100ms
          setTimeout(checkReady, 100);
        } else {
          // Timeout - start anyway with role selection
          console.warn('LIFF SDK failed to load, showing role selection');
          router.init();
        }
      };

      checkReady();
    }

    // Start checking for readiness
    startApp();
  </script>

  <!-- Role Selection Styles -->
  <style>
    .role-selection {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .role-card {
      background: white;
      border-radius: 20px;
      padding: 30px 20px;
      max-width: 320px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
    }

    .role-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .role-header h1 {
      font-size: 28px;
      margin-bottom: 8px;
      color: #333;
    }

    .role-header p {
      color: #666;
    }

    .role-buttons {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .role-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      padding: 20px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      background: white;
      cursor: pointer;
      transition: all 0.2s;
    }

    .role-btn:hover {
      border-color: #667eea;
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.2);
    }

    .role-btn.patient {
      border-left: 4px solid #667eea;
    }

    .role-btn.doctor {
      border-left: 4px solid #10b981;
    }

    .role-icon {
      font-size: 40px;
    }

    .role-name {
      font-size: 18px;
      font-weight: 600;
      color: #333;
    }

    .role-desc {
      font-size: 13px;
      color: #888;
    }

    .error-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
      text-align: center;
      background: #f5f5f5;
    }

    .error-icon {
      font-size: 60px;
      margin-bottom: 20px;
    }

    .error-title {
      font-size: 22px;
      font-weight: 600;
      color: #333;
      margin-bottom: 10px;
    }

    .error-message {
      color: #666;
      margin-bottom: 25px;
    }

    .error-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .error-actions .btn {
      display: flex;
      align-items: center;
      gap: 8px;
    }
  </style>
</body>
</html>
