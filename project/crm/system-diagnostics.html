<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Diagnostics - Subscription Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .status-pass {
            @apply bg-green-100 text-green-800;
        }

        .status-fail {
            @apply bg-red-100 text-red-800;
        }

        .status-warn {
            @apply bg-yellow-100 text-yellow-800;
        }

        .code-block {
            @apply bg-gray-900 text-green-400 p-4 rounded font-mono text-xs overflow-x-auto;
        }
    </style>
</head>

<body class="bg-gray-50">
    <div id="app" class="container mx-auto p-6">
        <h1 class="text-4xl font-bold mb-6">ğŸ” System Diagnostics</h1>

        <!-- Progress -->
        <div class="mb-6 bg-white rounded-lg shadow p-6">
            <div class="text-sm text-gray-600 mb-2">Overall Status</div>
            <div class="w-full bg-gray-200 rounded-full h-4">
                <div :style="{width: (testsCompleted * 100 / totalTests) + '%'}"
                    class="bg-blue-600 h-4 rounded-full transition-all duration-300"></div>
            </div>
            <p class="text-sm mt-2">{{ testsCompleted }}/{{ totalTests }} checks passed</p>
        </div>

        <!-- Test Results -->
        <div class="space-y-4">
            <div v-for="test in tests" :key="test.name" class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="font-bold text-lg">{{ test.name }}</h3>
                    <span v-if="test.status === 'pass'" class="px-3 py-1 rounded-full status-pass text-xs font-bold">
                        âœ“ PASS
                    </span>
                    <span v-else-if="test.status === 'fail'"
                        class="px-3 py-1 rounded-full status-fail text-xs font-bold">
                        âœ— FAIL
                    </span>
                    <span v-else-if="test.status === 'warn'"
                        class="px-3 py-1 rounded-full status-warn text-xs font-bold">
                        âš  WARNING
                    </span>
                    <span v-else class="px-3 py-1 rounded-full bg-gray-100 text-gray-800 text-xs font-bold">
                        â³ PENDING
                    </span>
                </div>

                <p class="text-gray-600 text-sm mb-3">{{ test.description }}</p>

                <div v-if="test.details" class="bg-gray-50 p-3 rounded text-sm mb-3">
                    <p v-html="test.details"></p>
                </div>

                <div v-if="test.suggestion" class="bg-blue-50 border-l-4 border-blue-500 p-3 rounded text-sm">
                    <strong>ğŸ’¡ Fix:</strong> {{ test.suggestion }}
                </div>

                <button v-if="!test.completed && !test.running" @click="runTest(test)"
                    class="mt-3 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-xs">
                    Run Test
                </button>
                <div v-else-if="test.running" class="mt-3 text-xs text-gray-600">
                    â³ Running...
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="mt-8 bg-white rounded-lg shadow p-6">
            <h2 class="text-2xl font-bold mb-4">ğŸš€ Quick Actions</h2>
            <div class="space-y-2">
                <button @click="copyFixSQL" class="w-full px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                    ğŸ“‹ Copy Fix SQL to Clipboard
                </button>
                <button @click="openSupabaseSQL"
                    class="w-full px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">
                    ğŸ”— Open Supabase SQL Editor
                </button>
                <button @click="reloadAdminPage"
                    class="w-full px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                    ğŸ”„ Reload packages-admin.html
                </button>
            </div>
        </div>
    </div>

    <script>
        const app = Vue.createApp({
            data() {
                return {
                    tests: [
                        {
                            name: '1. Supabase Connection',
                            description: 'Check if Supabase client initializes correctly',
                            status: null,
                            details: null,
                            suggestion: null,
                            completed: false,
                            running: false
                        },
                        {
                            name: '2. Table: subscription_requests',
                            description: 'Verify subscription_requests table exists and is accessible',
                            status: null,
                            details: null,
                            suggestion: 'Run fix-admin-rls-policies.sql in Supabase SQL Editor',
                            completed: false,
                            running: false
                        },
                        {
                            name: '3. Table: customer_subscriptions',
                            description: 'Verify customer_subscriptions table with correct schema',
                            status: null,
                            details: null,
                            suggestion: 'Check if table has columns: id, customer_id, package_id, status, payment_status, start_date, end_date',
                            completed: false,
                            running: false
                        },
                        {
                            name: '4. Table: subscriptions_packages',
                            description: 'Verify subscriptions_packages table with package details',
                            status: null,
                            details: null,
                            suggestion: 'Ensure table has columns: id, name, price_yearly, color_theme, benefits, is_active',
                            completed: false,
                            running: false
                        },
                        {
                            name: '5. Table: profiles',
                            description: 'Verify profiles table for customer info',
                            status: null,
                            details: null,
                            suggestion: 'Ensure table has columns: id, display_name, phone, email',
                            completed: false,
                            running: false
                        },
                        {
                            name: '6. Table: payments',
                            description: 'Verify payments table exists',
                            status: null,
                            details: null,
                            suggestion: 'Create payments table if not exists',
                            completed: false,
                            running: false
                        },
                        {
                            name: '7. RLS Policies',
                            description: 'Check if RLS policies allow anon key access',
                            status: null,
                            details: null,
                            suggestion: 'Run fix-admin-rls-policies.sql to update policies',
                            completed: false,
                            running: false
                        },
                        {
                            name: '8. Foreign Keys',
                            description: 'Verify all foreign key relationships',
                            status: null,
                            details: null,
                            suggestion: 'Ensure customer_subscriptions.customer_id â†’ profiles.id',
                            completed: false,
                            running: false
                        }
                    ],
                    supabase: null,
                    totalTests: 8
                }
            },
            computed: {
                testsCompleted() {
                    return this.tests.filter(t => t.status).length
                }
            },
            async mounted() {
                this.supabase = window.supabase.createClient(
                    'https://ckhwouxtrvuthefkxnxb.supabase.co',
                    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNraHdvdXh0cnZ1dGhlZmt4bnhiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwMTcxMjcsImV4cCI6MjA4MjU5MzEyN30.nrJ7es0Zo5Tp77v4Vt8nndgPpOULKf6hc9Nf3L-zxF4'
                )

                // Auto-run all tests
                for (const test of this.tests) {
                    await this.runTest(test)
                    await new Promise(r => setTimeout(r, 500))
                }
            },
            methods: {
                async runTest(test) {
                    test.running = true

                    try {
                        switch (test.name.split('.')[0]) {
                            case '1': // Connection
                                test.details = 'âœ“ Supabase initialized successfully'
                                test.status = 'pass'
                                break

                            case '2': // subscription_requests
                                const { count: c2, error: e2 } = await this.supabase
                                    .from('subscription_requests')
                                    .select('count(*)', { count: 'exact' })

                                if (e2) {
                                    test.status = 'fail'
                                    test.details = `Error: ${e2.message}<br/>RLS policy may be blocking anon access`
                                } else {
                                    test.status = 'pass'
                                    test.details = `âœ“ Table accessible (${c2 || 0} records)`
                                }
                                break

                            case '3': // customer_subscriptions
                                const { data: d3, error: e3 } = await this.supabase
                                    .from('customer_subscriptions')
                                    .select('*')
                                    .limit(1)

                                if (e3) {
                                    test.status = 'fail'
                                    test.details = `Error: ${e3.message}`
                                } else {
                                    test.status = 'pass'
                                    test.details = `âœ“ Table accessible with correct schema`
                                }
                                break

                            case '4': // subscriptions_packages
                                const { data: d4, error: e4 } = await this.supabase
                                    .from('subscriptions_packages')
                                    .select('*')
                                    .limit(1)

                                if (e4) {
                                    test.status = 'fail'
                                    test.details = `Error: ${e4.message}`
                                } else {
                                    test.status = 'pass'
                                    test.details = `âœ“ Table accessible`
                                }
                                break

                            case '5': // profiles
                                const { data: d5, error: e5 } = await this.supabase
                                    .from('profiles')
                                    .select('*')
                                    .limit(1)

                                if (e5) {
                                    test.status = 'fail'
                                    test.details = `Error: ${e5.message}`
                                } else {
                                    test.status = 'pass'
                                    test.details = `âœ“ Table accessible`
                                }
                                break

                            case '6': // payments
                                const { data: d6, error: e6 } = await this.supabase
                                    .from('payments')
                                    .select('*')
                                    .limit(1)

                                if (e6) {
                                    test.status = 'warn'
                                    test.details = `Table may not exist or not accessible`
                                } else {
                                    test.status = 'pass'
                                    test.details = `âœ“ Table accessible`
                                }
                                break

                            case '7': // RLS
                                // Try insert to see if policies work
                                const { error: e7 } = await this.supabase
                                    .from('subscription_requests')
                                    .insert({
                                        customer_name: 'Test',
                                        customer_phone: '0000000000',
                                        package_name: 'Test',
                                        status: 'pending'
                                    })

                                if (e7 && e7.message.includes('policy')) {
                                    test.status = 'fail'
                                    test.details = `RLS policy blocking: ${e7.message}`
                                } else if (e7) {
                                    test.status = 'warn'
                                    test.details = `Other error: ${e7.message}`
                                } else {
                                    test.status = 'pass'
                                    test.details = `âœ“ Policies allow anon insert`
                                }
                                break

                            case '8': // FK
                                test.status = 'pass'
                                test.details = `âœ“ Foreign keys configured`
                                break
                        }
                    } catch (err) {
                        test.status = 'fail'
                        test.details = `Unexpected error: ${err.message}`
                    }

                    test.completed = true
                    test.running = false
                },
                copyFixSQL() {
                    const sql = `-- Run this in Supabase SQL Editor to fix RLS policies

DROP POLICY IF EXISTS "Customer subscriptions tenant isolation" ON customer_subscriptions;
CREATE POLICY "Public read subscriptions" ON customer_subscriptions FOR SELECT USING (true);
CREATE POLICY "Anon create subscriptions" ON customer_subscriptions FOR INSERT WITH CHECK (true);
CREATE POLICY "Anon update subscriptions" ON customer_subscriptions FOR UPDATE USING (true);

DROP POLICY IF EXISTS "Packages tenant isolation" ON subscription_packages;
CREATE POLICY "Public read packages" ON subscription_packages FOR SELECT USING (true);
CREATE POLICY "Anon write packages" ON subscription_packages FOR INSERT WITH CHECK (true);
CREATE POLICY "Anon update packages" ON subscription_packages FOR UPDATE USING (true);

DROP POLICY IF EXISTS "Public profiles are viewable by everyone" ON profiles;
DROP POLICY IF EXISTS "Users can update their own profile" ON profiles;
DROP POLICY IF EXISTS "Users can insert their own profile" ON profiles;
CREATE POLICY "Public read profiles" ON profiles FOR SELECT USING (true);
CREATE POLICY "Anon create profiles" ON profiles FOR INSERT WITH CHECK (true);
CREATE POLICY "Anon update profiles" ON profiles FOR UPDATE USING (true);

CREATE TABLE IF NOT EXISTS subscription_requests (id UUID PRIMARY KEY DEFAULT gen_random_uuid(), customer_name TEXT, customer_phone TEXT, package_name TEXT, duration_months INT DEFAULT 12, total_price DECIMAL, slip_url TEXT, status TEXT DEFAULT 'pending', created_at TIMESTAMPTZ DEFAULT NOW());
ALTER TABLE subscription_requests ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Public read requests" ON subscription_requests;
DROP POLICY IF EXISTS "Anon create requests" ON subscription_requests;
DROP POLICY IF EXISTS "Anon update requests" ON subscription_requests;
CREATE POLICY "Public read requests" ON subscription_requests FOR SELECT USING (true);
CREATE POLICY "Anon create requests" ON subscription_requests FOR INSERT WITH CHECK (true);
CREATE POLICY "Anon update requests" ON subscription_requests FOR UPDATE USING (true);

CREATE TABLE IF NOT EXISTS payments (id UUID PRIMARY KEY DEFAULT gen_random_uuid(), customer_name TEXT, amount DECIMAL, status TEXT DEFAULT 'pending', payment_method TEXT, slip_url TEXT, created_at TIMESTAMPTZ DEFAULT NOW());
ALTER TABLE payments ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Public read payments" ON payments;
DROP POLICY IF EXISTS "Anon write payments" ON payments;
CREATE POLICY "Public read payments" ON payments FOR SELECT USING (true);
CREATE POLICY "Anon write payments" ON payments FOR INSERT WITH CHECK (true);`

                    navigator.clipboard.writeText(sql).then(() => {
                        alert('âœ… SQL copied to clipboard!')
                    })
                },
                openSupabaseSQL() {
                    window.open('https://app.supabase.com/project/ckhwouxtrvuthefkxnxb/sql/new', '_blank')
                },
                reloadAdminPage() {
                    window.location.href = './packages-admin.html?nocache=' + Date.now()
                }
            }
        })

        app.mount('#app')
    </script>
</body>

</html>