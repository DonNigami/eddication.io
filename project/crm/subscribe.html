<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å - {{ shopName }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.omise.co/omise.js"></script>
</head>

<body class="bg-gradient-to-br from-blue-50 to-purple-50 min-h-screen">

    <div id="app" class="container mx-auto px-4 py-8 max-w-6xl">

        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">üéâ ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</h1>
            <p class="text-gray-600">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏û‡∏Ñ‡πÄ‡∏Å‡∏à‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏°‡∏≤‡∏Å‡∏°‡∏≤‡∏¢!</p>
        </div>

        <!-- Packages Selection -->
        <div v-if="!selectedPackage" class="grid md:grid-cols-3 gap-6 mb-8">
            <div v-for="pkg in packages" :key="pkg.id"
                class="bg-white rounded-lg shadow-xl overflow-hidden transform transition-all hover:scale-105 cursor-pointer border-4"
                :class="pkg.is_recommended ? 'border-yellow-400' : 'border-transparent'"
                :style="`border-top: 6px solid ${pkg.color_theme}`" @click="selectPackage(pkg)">

                <div v-if="pkg.is_recommended" class="bg-yellow-400 text-yellow-900 text-center py-2 text-sm font-bold">
                    ‚≠ê ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
                </div>

                <div class="p-6">
                    <div class="text-center mb-6">
                        <h3 class="text-2xl font-bold mb-1" :style="`color: ${pkg.color_theme}`">
                            {{ pkg.name }}
                        </h3>
                        <p class="text-gray-500 text-sm">{{ pkg.name_en }}</p>
                    </div>

                    <div class="text-center mb-6">
                        <div class="text-5xl font-bold text-gray-800 mb-2">
                            ‡∏ø{{ pkg.price_yearly.toLocaleString() }}
                        </div>
                        <div class="text-sm text-gray-600">
                            /‡∏õ‡∏µ
                        </div>
                        <div class="text-xs text-gray-500 mt-1">
                            (‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ‡∏ø{{ (pkg.price_yearly / 12).toFixed(0) }}/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)
                        </div>
                    </div>

                    <!-- Highlights -->
                    <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-4 mb-4">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm text-gray-600">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span>
                            <span class="text-xl font-bold text-green-600">{{ pkg.discount_percent }}%</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-600">‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°</span>
                            <span class="text-xl font-bold text-blue-600">{{ pkg.points_multiplier }}x</span>
                        </div>
                    </div>

                    <!-- Benefits -->
                    <div class="space-y-3 mb-6">
                        <div v-for="(benefit, idx) in pkg.benefits" :key="idx" class="flex items-start">
                            <span class="text-green-500 mr-2 mt-0.5">‚úì</span>
                            <span class="text-gray-700 text-sm">{{ benefit }}</span>
                        </div>
                    </div>

                    <button class="w-full py-3 rounded-lg font-semibold transition-colors"
                        :style="`background-color: ${pkg.color_theme}; color: white`">
                        ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏û‡∏Ñ‡πÄ‡∏Å‡∏à‡∏ô‡∏µ‡πâ
                    </button>
                </div>
            </div>
        </div>

        <!-- Payment Step -->
        <div v-if="selectedPackage && !paymentCompleted" class="max-w-2xl mx-auto">
            <div class="bg-white rounded-lg shadow-xl p-8">

                <!-- Back Button -->
                <button @click="selectedPackage = null"
                    class="mb-6 text-blue-600 hover:text-blue-800 flex items-center">
                    ‚Üê ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏û‡∏Ñ‡πÄ‡∏Å‡∏à
                </button>

                <div class="text-center mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏ú‡πà‡∏≤‡∏ô PromptPay</h2>
                    <p class="text-gray-600">‡∏™‡πÅ‡∏Å‡∏ô QR Code ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</p>
                </div>

                <!-- Selected Package Summary -->
                <div class="bg-gray-50 rounded-lg p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <div class="font-bold text-xl" :style="`color: ${selectedPackage.color_theme}`">
                                {{ selectedPackage.name }}
                            </div>
                            <div class="text-sm text-gray-600">{{ selectedPackage.name_en }}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-3xl font-bold text-gray-800">
                                ‡∏ø{{ selectedPackage.price_yearly.toLocaleString() }}
                            </div>
                            <div class="text-sm text-gray-600">/‡∏õ‡∏µ</div>
                        </div>
                    </div>

                    <div class="border-t pt-4">
                        <div class="text-sm text-gray-600 mb-2">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö:</div>
                        <div class="grid grid-cols-2 gap-2">
                            <div class="flex items-center text-sm">
                                <span class="text-green-500 mr-1">‚úì</span>
                                <span>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î {{ selectedPackage.discount_percent }}%</span>
                            </div>
                            <div class="flex items-center text-sm">
                                <span class="text-green-500 mr-1">‚úì</span>
                                <span>‡πÅ‡∏ï‡πâ‡∏° {{ selectedPackage.points_multiplier }}x</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- QR Code Display -->
                <div v-if="qrCodeUrl" class="text-center mb-6">
                    <div class="bg-white p-6 rounded-lg border-4 border-blue-500 inline-block mb-4">
                        <img :src="qrCodeUrl" alt="PromptPay QR Code" class="w-64 h-64">
                    </div>

                    <div class="text-sm text-gray-600 mb-2">
                        ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ú‡πà‡∏≤‡∏ô PromptPay
                    </div>
                    <div class="font-mono font-bold text-xl text-gray-800 mb-4">
                        {{ selectedPackage.promptpay_phone || '065-698-7889' }}
                    </div>

                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                        <p class="text-sm text-yellow-800">
                            ‚ö†Ô∏è ‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
                        </p>
                    </div>
                </div>

                <!-- Upload Slip -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô *
                    </label>
                    <input type="file" @change="handleSlipUpload" accept="image/*"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg">

                    <div v-if="slipPreview" class="mt-4">
                        <img :src="slipPreview" alt="Slip Preview" class="max-w-xs mx-auto rounded-lg shadow">
                    </div>
                </div>

                <!-- Contact Info -->
                <div class="space-y-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• *</label>
                        <input v-model="contactInfo.name" type="text"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå *</label>
                        <input v-model="contactInfo.phone" type="tel"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="0812345678">
                    </div>
                </div>

                <!-- Submit Button -->
                <button @click="submitSubscription" :disabled="!canSubmit || isSubmitting"
                    class="w-full py-4 bg-green-500 text-white font-bold rounded-lg hover:bg-green-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors">
                    {{ isSubmitting ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...' : '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å' }}
                </button>

                <p class="text-xs text-center text-gray-500 mt-4">
                    * ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô 1-2 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á ‡∏´‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
                </p>
            </div>
        </div>

        <!-- Success Step -->
        <div v-if="paymentCompleted" class="max-w-2xl mx-auto">
            <div class="bg-white rounded-lg shadow-xl p-8 text-center">
                <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
                    <span class="text-4xl">‚úÖ</span>
                </div>

                <h2 class="text-3xl font-bold text-gray-800 mb-4">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h2>
                <p class="text-gray-600 mb-8">
                    ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß<br>
                    ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 1-2 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
                </p>

                <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
                    <div class="text-sm text-gray-600 mb-2">‡πÅ‡∏û‡∏Ñ‡πÄ‡∏Å‡∏à‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>
                    <div class="text-xl font-bold" :style="`color: ${selectedPackage.color_theme}`">
                        {{ selectedPackage.name }}
                    </div>
                    <div class="text-2xl font-bold text-gray-800 mt-2">
                        ‡∏ø{{ selectedPackage.price_yearly.toLocaleString() }}
                    </div>
                </div>

                <div class="space-y-3 text-sm text-gray-600 mb-8">
                    <p>‚úì ‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡πà‡∏≤‡∏ô LINE ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</p>
                    <p>‚úì ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏°‡∏µ‡∏≠‡∏≤‡∏¢‡∏∏ 1 ‡∏õ‡∏µ ‡∏ô‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</p>
                    <p>‚úì ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</p>
                </div>

                <button @click="goToHome"
                    class="px-8 py-3 bg-blue-500 text-white font-bold rounded-lg hover:bg-blue-600 transition-colors">
                    ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
                </button>
            </div>
        </div>

    </div>

    <script>
        const { createApp } = Vue

        // Initialize Omise
        Omise.setPublicKey('pkey_test_5wox4qrw56h1jiwb0gl')

        createApp({
            data() {
                return {
                    packages: [],
                    selectedPackage: null,
                    qrCodeUrl: null,
                    chargeId: null,
                    slipFile: null,
                    slipPreview: null,
                    contactInfo: {
                        name: '',
                        phone: ''
                    },
                    paymentCompleted: false,
                    isSubmitting: false,
                    supabase: null,
                    lineUserId: null,
                    tenantId: null
                }
            },
            computed: {
                canSubmit() {
                    return this.slipFile &&
                        this.contactInfo.name &&
                        this.contactInfo.phone
                }
            },
            async mounted() {
                // Initialize Supabase
                this.supabase = window.supabase.createClient(
                    'https://ckhwouxtrvuthefkxnxb.supabase.co',
                    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNraHdvdXh0cnZ1dGhlZmt4bnhiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQ1MzU4NDAsImV4cCI6MjA1MDExMTg0MH0.Vn-V7nDXON7vRCEp2KzPQwvTv2X_nFZxlq6nZBK8jpw'
                )

                // Initialize LIFF
                try {
                    await liff.init({ liffId: '2006652117-vZO91aAk' })
                    if (liff.isLoggedIn()) {
                        const profile = await liff.getProfile()
                        this.lineUserId = profile.userId
                        this.contactInfo.name = profile.displayName
                    }
                } catch (err) {
                    console.error('LIFF init failed:', err)
                }

                // TODO: Get tenantId from URL or context
                this.tenantId = 'demo-tenant-id'

                await this.loadPackages()
            },
            methods: {
                async loadPackages() {
                    // TODO: Load from Supabase
                    // const { data } = await this.supabase
                    //     .from('subscription_packages')
                    //     .select('*')
                    //     .eq('tenant_id', this.tenantId)
                    //     .eq('is_active', true)
                    //     .order('sort_order')

                    this.packages = [
                        {
                            id: '1',
                            name: '‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô',
                            name_en: 'Silver Member',
                            description: '‡πÅ‡∏û‡∏Ñ‡πÄ‡∏Å‡∏à‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô',
                            price_yearly: 499,
                            discount_percent: 3,
                            points_multiplier: 1.2,
                            color_theme: '#C0C0C0',
                            benefits: [
                                '‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î 3% ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
                                '‡∏™‡∏∞‡∏™‡∏°‡πÅ‡∏ï‡πâ‡∏° 1.2 ‡πÄ‡∏ó‡πà‡∏≤',
                                '‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏ü‡∏£‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ã‡∏∑‡πâ‡∏≠‡∏Ñ‡∏£‡∏ö 500‡∏ø'
                            ],
                            promptpay_phone: '0656987889',
                            is_active: true
                        },
                        {
                            id: '2',
                            name: '‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏≠‡∏á',
                            name_en: 'Gold Member',
                            description: '‡πÅ‡∏û‡∏Ñ‡πÄ‡∏Å‡∏à‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°',
                            price_yearly: 999,
                            discount_percent: 5,
                            points_multiplier: 1.5,
                            color_theme: '#FFD700',
                            benefits: [
                                '‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î 5% ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
                                '‡∏™‡∏∞‡∏™‡∏°‡πÅ‡∏ï‡πâ‡∏° 1.5 ‡πÄ‡∏ó‡πà‡∏≤',
                                '‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏ü‡∏£‡∏µ‡∏ó‡∏∏‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå',
                                '‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç'
                            ],
                            promptpay_phone: '0656987889',
                            is_active: true,
                            is_recommended: true
                        },
                        {
                            id: '3',
                            name: '‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÄ‡∏û‡∏ä‡∏£',
                            name_en: 'Diamond Member',
                            description: '‡πÅ‡∏û‡∏Ñ‡πÄ‡∏Å‡∏à‡∏û‡∏£‡∏µ‡πÄ‡∏°‡∏µ‡∏¢‡∏°',
                            price_yearly: 2999,
                            discount_percent: 10,
                            points_multiplier: 2.0,
                            color_theme: '#B9F2FF',
                            benefits: [
                                '‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î 10% ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
                                '‡∏™‡∏∞‡∏™‡∏°‡πÅ‡∏ï‡πâ‡∏° 2 ‡πÄ‡∏ó‡πà‡∏≤',
                                '‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏ü‡∏£‡∏µ‡πÅ‡∏ö‡∏ö‡∏î‡πà‡∏ß‡∏ô',
                                '‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î VIP',
                                '‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏Ñ‡∏£',
                                '‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß'
                            ],
                            promptpay_phone: '0656987889',
                            is_active: true
                        }
                    ]
                },
                async selectPackage(pkg) {
                    this.selectedPackage = pkg
                    await this.generateQRCode()
                },
                async generateQRCode() {
                    try {
                        const amount = this.selectedPackage.price_yearly

                        // Create PromptPay charge via Omise
                        const response = await fetch('https://api.omise.co/charges', {
                            method: 'POST',
                            headers: {
                                'Authorization': 'Basic ' + btoa('skey_test_5wox4qrhdxqjxpyhnuy:'),
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                amount: amount * 100, // convert to satang
                                currency: 'THB',
                                source: {
                                    type: 'promptpay'
                                },
                                description: `${this.selectedPackage.name} - Subscription`,
                                metadata: {
                                    package_id: this.selectedPackage.id,
                                    line_user_id: this.lineUserId
                                }
                            })
                        })

                        const charge = await response.json()

                        if (charge.source && charge.source.scannable_code) {
                            this.qrCodeUrl = charge.source.scannable_code.image.download_uri
                            this.chargeId = charge.id
                        }
                    } catch (error) {
                        console.error('QR generation failed:', error)
                        Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code ‡πÑ‡∏î‡πâ', 'error')
                    }
                },
                handleSlipUpload(event) {
                    const file = event.target.files[0]
                    if (file) {
                        this.slipFile = file
                        const reader = new FileReader()
                        reader.onload = (e) => {
                            this.slipPreview = e.target.result
                        }
                        reader.readAsDataURL(file)
                    }
                },
                async submitSubscription() {
                    this.isSubmitting = true

                    try {
                        // Upload slip to Supabase Storage
                        const fileName = `slips/${Date.now()}_${this.slipFile.name}`
                        const { data: uploadData, error: uploadError } = await this.supabase.storage
                            .from('payment-slips')
                            .upload(fileName, this.slipFile)

                        if (uploadError) throw uploadError

                        const { data: { publicUrl } } = this.supabase.storage
                            .from('payment-slips')
                            .getPublicUrl(fileName)

                        // Create subscription record
                        // TODO: Call Edge Function to create subscription
                        const { data, error } = await this.supabase.functions.invoke('subscription-manager', {
                            body: {
                                action: 'create-customer-subscription',
                                package_id: this.selectedPackage.id,
                                customer_info: this.contactInfo,
                                slip_url: publicUrl,
                                charge_id: this.chargeId,
                                line_user_id: this.lineUserId
                            }
                        })

                        if (error) throw error

                        this.paymentCompleted = true

                    } catch (error) {
                        console.error('Submission failed:', error)
                        Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÑ‡∏î‡πâ: ' + error.message, 'error')
                    } finally {
                        this.isSubmitting = false
                    }
                },
                goToHome() {
                    if (liff.isInClient()) {
                        liff.closeWindow()
                    } else {
                        window.location.href = '/'
                    }
                }
            }
        }).mount('#app')
    </script>
</body>

</html>