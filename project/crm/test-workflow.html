<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>End-to-End Workflow Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-gray-100">
    <div id="app" class="container mx-auto p-6">
        <h1 class="text-4xl font-bold mb-2">ğŸ”„ End-to-End Workflow Test</h1>
        <p class="text-gray-600 mb-6">Test the complete subscription flow: Submit â†’ Approve â†’ Verify</p>

        <div class="grid md:grid-cols-2 gap-6">
            <!-- Step 1: Create Test Submission -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-2xl font-bold mb-4">ğŸ“ Step 1: Create Test Submission</h2>
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium mb-1">Customer Name</label>
                        <input v-model="testData.customer_name" type="text" 
                            class="w-full px-3 py-2 border rounded" placeholder="Test Customer">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Phone</label>
                        <input v-model="testData.customer_phone" type="text" 
                            class="w-full px-3 py-2 border rounded" placeholder="0899999999">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Package</label>
                        <select v-model="testData.package_name" class="w-full px-3 py-2 border rounded">
                            <option>Select package...</option>
                            <option v-for="pkg in packages" :key="pkg.id" :value="pkg.name">
                                {{ pkg.name }}
                            </option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Duration (months)</label>
                        <input v-model.number="testData.duration_months" type="number" 
                            class="w-full px-3 py-2 border rounded" placeholder="12">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Price</label>
                        <input v-model.number="testData.total_price" type="number" 
                            class="w-full px-3 py-2 border rounded" placeholder="1000">
                    </div>
                    <button @click="createSubmission" class="w-full px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-bold">
                        ğŸ“¤ Create Test Submission
                    </button>
                    <div v-if="status.step1" :class="status.step1.includes('âœ“') ? 'text-green-600' : 'text-red-600'" class="text-sm font-mono">
                        {{ status.step1 }}
                    </div>
                </div>
            </div>

            <!-- Step 2: Load and Approve -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-2xl font-bold mb-4">âœ… Step 2: Load & Approve Submission</h2>
                <div class="space-y-3">
                    <button @click="loadSubmissions" class="w-full px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 font-bold">
                        ğŸ”„ Load Pending Submissions
                    </button>
                    <div v-if="submissions.length > 0" class="bg-gray-50 rounded p-3">
                        <p class="text-sm font-bold mb-2">Latest Submission:</p>
                        <div class="text-xs space-y-1">
                            <p>ğŸ“ <strong>{{ submissions[0].customer_name }}</strong></p>
                            <p>ğŸ“± {{ submissions[0].customer_phone }}</p>
                            <p>ğŸ’ {{ submissions[0].package_name }}</p>
                            <p>ğŸ’° à¸¿{{ submissions[0].total_price }}</p>
                            <p>â³ {{ submissions[0].status }}</p>
                        </div>
                        <button @click="approveSubmission(submissions[0])" 
                            class="mt-3 w-full px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 font-bold text-sm">
                            âœ… Approve This Submission
                        </button>
                    </div>
                    <div v-else class="text-gray-600 text-sm">
                        No pending submissions yet
                    </div>
                    <div v-if="status.step2" :class="status.step2.includes('âœ“') ? 'text-green-600' : 'text-red-600'" class="text-sm font-mono">
                        {{ status.step2 }}
                    </div>
                </div>
            </div>

            <!-- Step 3: Verify Subscription -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-2xl font-bold mb-4">ğŸ” Step 3: Verify Subscription Created</h2>
                <div class="space-y-3">
                    <button @click="verifySubscription" class="w-full px-4 py-2 bg-orange-600 text-white rounded hover:bg-orange-700 font-bold">
                        ğŸ“Š Load Subscriptions (customer_subscriptions table)
                    </button>
                    <div v-if="subscriptions.length > 0" class="bg-gray-50 rounded p-3">
                        <p class="text-sm font-bold mb-2">Active Subscriptions:</p>
                        <div v-for="sub in subscriptions" :key="sub.id" class="text-xs mb-2 pb-2 border-b">
                            <p>ğŸ‘¤ {{ sub.customer_name }}</p>
                            <p>ğŸ’ {{ sub.package_name }}</p>
                            <p>ğŸ“… {{ formatDate(sub.start_date) }} â†’ {{ formatDate(sub.end_date) }}</p>
                            <p>ğŸ’š <span class="px-2 py-0.5 bg-green-100 rounded">{{ sub.status }}</span></p>
                        </div>
                    </div>
                    <div v-else class="text-gray-600 text-sm">
                        No subscriptions found
                    </div>
                    <div v-if="status.step3" :class="status.step3.includes('âœ“') ? 'text-green-600' : 'text-red-600'" class="text-sm font-mono">
                        {{ status.step3 }}
                    </div>
                </div>
            </div>

            <!-- Step 4: Check Payments -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-2xl font-bold mb-4">ğŸ’³ Step 4: Check Payment Record</h2>
                <div class="space-y-3">
                    <button @click="verifyPayment" class="w-full px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 font-bold">
                        ğŸ’° Load Payments
                    </button>
                    <div v-if="payments.length > 0" class="bg-gray-50 rounded p-3">
                        <p class="text-sm font-bold mb-2">Payment Records:</p>
                        <div v-for="pay in payments" :key="pay.id" class="text-xs mb-2 pb-2 border-b">
                            <p>ğŸ‘¤ {{ pay.customer_name }}</p>
                            <p>ğŸ’µ à¸¿{{ pay.amount }}</p>
                            <p>ğŸ“… {{ formatDate(pay.created_at) }}</p>
                            <p>âœ… <span class="px-2 py-0.5" :class="pay.status === 'paid' ? 'bg-green-100' : 'bg-yellow-100'">{{ pay.status }}</span></p>
                        </div>
                    </div>
                    <div v-else class="text-gray-600 text-sm">
                        No payments found
                    </div>
                    <div v-if="status.step4" :class="status.step4.includes('âœ“') ? 'text-green-600' : 'text-red-600'" class="text-sm font-mono">
                        {{ status.step4 }}
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary -->
        <div class="mt-6 bg-white rounded-lg shadow p-6">
            <h2 class="text-2xl font-bold mb-4">ğŸ“‹ Test Summary</h2>
            <div class="grid md:grid-cols-4 gap-4">
                <div class="text-center">
                    <div class="text-3xl mb-2" :class="status.step1?.includes('âœ“') ? 'âœ…' : 'â³'"></div>
                    <p class="font-bold">Step 1: Submit</p>
                    <p class="text-xs text-gray-600">Create test data</p>
                </div>
                <div class="text-center">
                    <div class="text-3xl mb-2" :class="status.step2?.includes('âœ“') ? 'âœ…' : 'â³'"></div>
                    <p class="font-bold">Step 2: Approve</p>
                    <p class="text-xs text-gray-600">Admin approval</p>
                </div>
                <div class="text-center">
                    <div class="text-3xl mb-2" :class="status.step3?.includes('âœ“') ? 'âœ…' : 'â³'"></div>
                    <p class="font-bold">Step 3: Verify Sub</p>
                    <p class="text-xs text-gray-600">Check creation</p>
                </div>
                <div class="text-center">
                    <div class="text-3xl mb-2" :class="status.step4?.includes('âœ“') ? 'âœ…' : 'â³'"></div>
                    <p class="font-bold">Step 4: Verify Pay</p>
                    <p class="text-xs text-gray-600">Check payment</p>
                </div>
            </div>

            <!-- Overall Result -->
            <div class="mt-4 p-4 rounded text-center" :class="allPassed ? 'bg-green-100' : 'bg-yellow-100'">
                <p class="font-bold" :class="allPassed ? 'text-green-800' : 'text-yellow-800'">
                    {{ allPassed ? 'âœ… All Tests Passed!' : 'â³ Tests In Progress...' }}
                </p>
            </div>
        </div>

        <!-- Debug Console -->
        <div class="mt-6 bg-gray-900 text-green-400 p-6 rounded font-mono text-xs overflow-y-auto max-h-64">
            <div v-for="(log, idx) in logs" :key="idx" class="mb-1">
                {{ log }}
            </div>
        </div>
    </div>

    <script>
        const app = Vue.createApp({
            data() {
                return {
                    supabase: null,
                    packages: [],
                    submissions: [],
                    subscriptions: [],
                    payments: [],
                    logs: [],
                    testData: {
                        customer_name: 'Test Customer ' + Math.floor(Math.random() * 1000),
                        customer_phone: '0899999' + Math.floor(Math.random() * 1000),
                        package_name: '',
                        duration_months: 12,
                        total_price: 1000
                    },
                    status: {
                        step1: null,
                        step2: null,
                        step3: null,
                        step4: null
                    }
                }
            },
            computed: {
                allPassed() {
                    return this.status.step1?.includes('âœ“') && 
                           this.status.step2?.includes('âœ“') && 
                           this.status.step3?.includes('âœ“') && 
                           this.status.step4?.includes('âœ“')
                }
            },
            async mounted() {
                this.log('ğŸš€ Initializing test environment...')
                
                this.supabase = window.supabase.createClient(
                    'https://ckhwouxtrvuthefkxnxb.supabase.co',
                    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNraHdvdXh0cnZ1dGhlZmt4bnhiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwMTcxMjcsImV4cCI6MjA4MjU5MzEyN30.nrJ7es0Zo5Tp77v4Vt8nndgPpOULKf6hc9Nf3L-zxF4'
                )

                this.log('âœ… Supabase initialized')
                await this.loadPackages()
            },
            methods: {
                log(msg) {
                    const time = new Date().toLocaleTimeString()
                    this.logs.push(`[${time}] ${msg}`)
                    if (this.logs.length > 50) this.logs.shift()
                },
                async loadPackages() {
                    try {
                        const {data, error} = await this.supabase
                            .from('subscriptions_packages')
                            .select('*')
                            .eq('is_active', true)

                        if (error) throw error
                        this.packages = data || []
                        this.log(`âœ… Loaded ${this.packages.length} packages`)
                        if (this.packages.length > 0) {
                            this.testData.package_name = this.packages[0].name
                        }
                    } catch (err) {
                        this.log(`âŒ Error loading packages: ${err.message}`)
                    }
                },
                async createSubmission() {
                    try {
                        this.log('ğŸ“ Creating subscription request...')
                        const {data, error} = await this.supabase
                            .from('subscription_requests')
                            .insert({
                                customer_name: this.testData.customer_name,
                                customer_phone: this.testData.customer_phone,
                                package_name: this.testData.package_name,
                                duration_months: this.testData.duration_months,
                                total_price: this.testData.total_price,
                                status: 'pending'
                            })
                            .select()

                        if (error) throw error
                        this.log(`âœ… Created submission: ${data[0].id}`)
                        this.status.step1 = `âœ“ Submission created (ID: ${data[0].id.slice(0, 8)}...)`
                        await this.loadSubmissions()
                    } catch (err) {
                        this.log(`âŒ Error: ${err.message}`)
                        this.status.step1 = `âœ— Failed: ${err.message}`
                    }
                },
                async loadSubmissions() {
                    try {
                        this.log('ğŸ”„ Loading pending submissions...')
                        const {data, error} = await this.supabase
                            .from('subscription_requests')
                            .select('*')
                            .eq('status', 'pending')
                            .order('created_at', {ascending: false})

                        if (error) throw error
                        this.submissions = data || []
                        this.log(`âœ… Loaded ${this.submissions.length} pending submissions`)
                    } catch (err) {
                        this.log(`âŒ Error: ${err.message}`)
                    }
                },
                async approveSubmission(submission) {
                    try {
                        this.log(`âœ… Approving submission: ${submission.customer_name}...`)
                        
                        // Update status
                        const {error: updateError} = await this.supabase
                            .from('subscription_requests')
                            .update({status: 'approved'})
                            .eq('id', submission.id)

                        if (updateError) throw updateError
                        this.log('âœ… Updated subscription_requests status')

                        // Create or find customer
                        let customerId
                        const {data: existing} = await this.supabase
                            .from('profiles')
                            .select('id')
                            .eq('phone', submission.customer_phone)
                            .maybeSingle()

                        if (existing) {
                            customerId = existing.id
                            this.log('âœ… Found existing customer')
                        } else {
                            const {data: newCust, error: custErr} = await this.supabase
                                .from('profiles')
                                .insert({
                                    display_name: submission.customer_name,
                                    phone: submission.customer_phone
                                })
                                .select()
                                .single()

                            if (custErr) throw custErr
                            customerId = newCust.id
                            this.log('âœ… Created new customer')
                        }

                        // Find package
                        const {data: pkg, error: pkgErr} = await this.supabase
                            .from('subscriptions_packages')
                            .select('id')
                            .eq('name', submission.package_name)
                            .single()

                        if (pkgErr) throw pkgErr
                        this.log('âœ… Found package')

                        // Create subscription
                        const startDate = new Date()
                        const endDate = new Date()
                        endDate.setMonth(endDate.getMonth() + submission.duration_months)

                        const {data: newSub, error: subErr} = await this.supabase
                            .from('customer_subscriptions')
                            .insert({
                                customer_id: customerId,
                                package_id: pkg.id,
                                status: 'active',
                                payment_status: 'paid',
                                paid_amount: submission.total_price,
                                start_date: startDate.toISOString(),
                                end_date: endDate.toISOString()
                            })
                            .select()

                        if (subErr) throw subErr
                        this.log(`âœ… Created subscription: ${newSub[0].id.slice(0, 8)}...`)

                        // Create payment
                        await this.supabase
                            .from('payments')
                            .insert({
                                customer_name: submission.customer_name,
                                amount: submission.total_price,
                                status: 'paid'
                            })

                        this.log('âœ… Created payment record')
                        this.status.step2 = `âœ“ Approved & subscription created`

                        Swal.fire('Success!', 'Submission approved successfully', 'success')
                    } catch (err) {
                        this.log(`âŒ Error: ${err.message}`)
                        this.status.step2 = `âœ— Failed: ${err.message}`
                    }
                },
                async verifySubscription() {
                    try {
                        this.log('ğŸ” Loading subscriptions...')
                        const {data, error} = await this.supabase
                            .from('customer_subscriptions')
                            .select(`
                                id,
                                customer_id,
                                status,
                                start_date,
                                end_date,
                                profiles:customer_id(display_name, phone),
                                subscriptions_packages:package_id(name)
                            `)
                            .order('created_at', {ascending: false})
                            .limit(10)

                        if (error) throw error

                        this.subscriptions = (data || []).map(s => ({
                            id: s.id,
                            customer_name: s.profiles?.display_name || 'Unknown',
                            package_name: s.subscriptions_packages?.name || 'Unknown',
                            status: s.status,
                            start_date: s.start_date,
                            end_date: s.end_date
                        }))

                        this.log(`âœ… Loaded ${this.subscriptions.length} subscriptions`)
                        this.status.step3 = `âœ“ Found ${this.subscriptions.length} subscriptions`
                    } catch (err) {
                        this.log(`âŒ Error: ${err.message}`)
                        this.status.step3 = `âœ— Failed: ${err.message}`
                    }
                },
                async verifyPayment() {
                    try {
                        this.log('ğŸ’³ Loading payments...')
                        const {data, error} = await this.supabase
                            .from('payments')
                            .select('*')
                            .order('created_at', {ascending: false})
                            .limit(10)

                        if (error) throw error
                        this.payments = data || []
                        this.log(`âœ… Loaded ${this.payments.length} payments`)
                        this.status.step4 = `âœ“ Found ${this.payments.length} payments`
                    } catch (err) {
                        this.log(`âŒ Error: ${err.message}`)
                        this.status.step4 = `âœ— Failed: ${err.message}`
                    }
                },
                formatDate(date) {
                    if (!date) return '-'
                    return new Date(date).toLocaleDateString('th-TH', {
                        year: 'numeric', month: 'short', day: 'numeric'
                    })
                }
            }
        })

        app.mount('#app')
    </script>
</body>
</html>
