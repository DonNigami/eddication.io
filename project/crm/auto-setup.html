<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Pro - Auto Setup</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #0f172a;
            color: #e2e8f0;
        }

        .pass {
            color: #22c55e;
        }

        .fail {
            color: #ef4444;
        }

        .warn {
            color: #f59e0b;
        }

        .info {
            color: #3b82f6;
        }

        .entry {
            padding: 10px 14px;
            margin: 6px 0;
            background: #1e293b;
            border-left: 3px solid #475569;
            border-radius: 4px;
            font-size: 13px;
        }

        .loading {
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>

<body class="p-6">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-2 text-cyan-400">‚öôÔ∏è CRM Pro - Auto Setup</h1>
        <p class="text-gray-400 mb-6">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Database ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>

        <div class="bg-slate-800 p-6 rounded-lg mb-6">
            <div class="flex gap-4 mb-6">
                <button id="startBtn"
                    class="bg-green-600 hover:bg-green-700 disabled:opacity-50 px-6 py-3 rounded-lg font-bold">
                    üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏° Auto Setup
                </button>
                <button id="resetBtn" class="bg-gray-600 hover:bg-gray-700 px-6 py-3 rounded-lg font-bold">
                    üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï
                </button>
            </div>
            <div id="logs" class="space-y-2 max-h-[600px] overflow-y-auto"></div>
        </div>

        <div class="bg-slate-800 p-6 rounded-lg">
            <h2 class="text-lg font-bold mb-4 text-yellow-400">üìã Setup Steps</h2>
            <div class="space-y-2 text-sm">
                <div class="entry" id="step1"><span class="loading">‚è≥</span> ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Database Connection</div>
                <div class="entry" id="step2">‚è∏ ‡∏™‡∏£‡πâ‡∏≤‡∏á/‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Tables</div>
                <div class="entry" id="step3">‚è∏ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ RLS Policies</div>
                <div class="entry" id="step4">‚è∏ ‡πÉ‡∏™‡πà Sample Data</div>
                <div class="entry" id="step5">‚è∏ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</div>
            </div>
        </div>
    </div>

    <script>
        const { createClient } = supabase;
        const supabaseUrl = "https://ckhwouxtrvuthefkxnxb.supabase.co";
        const supabaseKey = "sb_publishable_QvGKuCheOXRbtGH-Cm0Q5A_ddRY3_i3";

        const client = createClient(supabaseUrl, supabaseKey);
        let setupInProgress = false;

        function log(msg, type = 'info') {
            const icons = { pass: '‚úì', fail: '‚úó', warn: '‚ö†', info: '‚Ñπ', prog: '‚è≥' };
            const entry = document.createElement('div');
            entry.className = `entry ${type}`;
            entry.innerHTML = `<span class="font-bold">${icons[type] || '‚Üí'}</span> ${msg}`;
            document.getElementById('logs').appendChild(entry);
            document.getElementById('logs').scrollTop = document.getElementById('logs').scrollHeight;
        }

        function updateStep(stepNum, status = 'progress') {
            const icons = { progress: '‚è≥', pass: '‚úì', fail: '‚úó', warn: '‚ö†' };
            document.getElementById(`step${stepNum}`).className = `entry ${status === 'progress' ? 'info' : status}`;
            const icon = document.getElementById(`step${stepNum}`).querySelector('span').textContent;
            document.getElementById(`step${stepNum}`).innerHTML =
                `<span>${icons[status] || '‚Üí'}</span> ${document.getElementById(`step${stepNum}`).innerHTML.substring(2)}`;
        }

        async function checkConnection() {
            log('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Supabase...', 'prog');
            updateStep(1, 'progress');

            try {
                const { data, error } = await client.auth.getSession();
                if (error && !error.message.includes('not logged in')) {
                    throw error;
                }
                log('‚úì ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Supabase ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'pass');
                updateStep(1, 'pass');
                return true;
            } catch (e) {
                log(`‚úó ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ${e.message}`, 'fail');
                updateStep(1, 'fail');
                return false;
            }
        }

        async function createTables() {
            log('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á Tables...', 'prog');
            updateStep(2, 'progress');

            try {
                const tables = ['profiles', 'tiers', 'news_promotions', 'customer_segments'];
                const sqlStatements = [
                    // Profiles table
                    `CREATE TABLE IF NOT EXISTS public.profiles (
                        id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
                        line_user_id text UNIQUE NOT NULL,
                        display_name text,
                        picture_url text,
                        email text,
                        phone text,
                        role text DEFAULT 'member' CHECK (role IN ('admin', 'member')),
                        points integer DEFAULT 0 CHECK (points >= 0),
                        tags text[] DEFAULT '{}',
                        last_activity timestamp with time zone DEFAULT now(),
                        created_at timestamp with time zone DEFAULT now(),
                        updated_at timestamp with time zone DEFAULT now()
                    )`,

                    // Create indexes for profiles
                    `CREATE INDEX IF NOT EXISTS idx_profiles_line_user_id ON public.profiles(line_user_id)`,
                    `CREATE INDEX IF NOT EXISTS idx_profiles_role ON public.profiles(role)`,
                    `CREATE INDEX IF NOT EXISTS idx_profiles_points ON public.profiles(points DESC)`,

                    // Tiers table
                    `CREATE TABLE IF NOT EXISTS public.tiers (
                        id serial PRIMARY KEY,
                        name text NOT NULL,
                        min_points integer NOT NULL DEFAULT 0,
                        color_theme text NOT NULL DEFAULT 'card-member',
                        created_at timestamp with time zone DEFAULT now()
                    )`,

                    `CREATE INDEX IF NOT EXISTS idx_tiers_min_points ON public.tiers(min_points DESC)`,

                    // News Promotions table
                    `CREATE TABLE IF NOT EXISTS public.news_promotions (
                        id serial PRIMARY KEY,
                        title text NOT NULL,
                        description text,
                        image_url text,
                        link_url text,
                        link_text text DEFAULT '‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î',
                        created_at timestamp with time zone DEFAULT now(),
                        updated_at timestamp with time zone DEFAULT now()
                    )`,

                    `CREATE INDEX IF NOT EXISTS idx_news_promotions_created_at ON public.news_promotions(created_at DESC)`,

                    // Customer Segments table
                    `CREATE TABLE IF NOT EXISTS public.customer_segments (
                        id serial PRIMARY KEY,
                        name text NOT NULL,
                        conditions jsonb NOT NULL DEFAULT '{}',
                        created_at timestamp with time zone DEFAULT now(),
                        updated_at timestamp with time zone DEFAULT now()
                    )`
                ];

                // Check which tables exist
                for (const table of tables) {
                    try {
                        const { data, error } = await client.from(table).select('count').limit(0);
                        if (!error) {
                            log(`‚úì Table '${table}' ‚úì ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß`, 'pass');
                        } else if (error.message.includes('does not exist')) {
                            log(`‚ö† Table '${table}' ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á (‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏±‡∏ô SQL ‡πÉ‡∏ô Supabase Dashboard)`, 'warn');
                        }
                    } catch (e) {
                        log(`‚ö† Table '${table}': ${e.message}`, 'warn');
                    }
                }

                updateStep(2, 'pass');
                log('üìå ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Tables ‡∏ú‡πà‡∏≤‡∏ô Supabase Dashboard SQL Editor', 'warn');
                return true;
            } catch (e) {
                log(`‚úó ‡∏™‡∏£‡πâ‡∏≤‡∏á Tables ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ${e.message}`, 'fail');
                updateStep(2, 'fail');
                return false;
            }
        }

        async function setupRLS() {
            log('‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ RLS Policies...', 'prog');
            updateStep(3, 'progress');

            try {
                // Check RLS status by attempting to select
                const tables = ['profiles', 'tiers', 'news_promotions', 'customer_segments'];
                for (const table of tables) {
                    try {
                        const { error } = await client.from(table).select('*').limit(0);
                        if (!error) {
                            log(`‚úì RLS Policy ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö '${table}' ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß`, 'pass');
                        }
                    } catch (e) {
                        if (e.message.includes('row-level security')) {
                            log(`‚ö† RLS Policy '${table}' ‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á (‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á)`, 'warn');
                        }
                    }
                }

                updateStep(3, 'pass');
                return true;
            } catch (e) {
                log(`‚úó ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ RLS ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ${e.message}`, 'fail');
                updateStep(3, 'fail');
                return false;
            }
        }

        async function insertSampleData() {
            log('‡πÉ‡∏™‡πà Sample Data...', 'prog');
            updateStep(4, 'progress');

            try {
                // Insert tiers
                const tiersData = [
                    { name: 'Member', min_points: 0, color_theme: 'card-member' },
                    { name: 'Silver', min_points: 1000, color_theme: 'card-silver' },
                    { name: 'Gold', min_points: 5000, color_theme: 'card-gold' },
                    { name: 'Platinum', min_points: 10000, color_theme: 'card-platinum' },
                    { name: 'Black', min_points: 50000, color_theme: 'card-black' }
                ];

                const { error: tiersError, count: tiersCount } = await client
                    .from('tiers')
                    .insert(tiersData)
                    .select('count');

                if (!tiersError || tiersError.message.includes('duplicate')) {
                    log(`‚úì Tiers data: ${tiersCount || 'already exists or inserted'}`, 'pass');
                } else {
                    log(`‚ö† Tiers: ${tiersError.message}`, 'warn');
                }

                // Insert news
                const newsData = [
                    {
                        title: '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà CRM Pro',
                        description: '‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏ó‡∏±‡∏ô‡∏™‡∏°‡∏±‡∏¢ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å',
                        image_url: 'https://images.unsplash.com/photo-1557804506-669a67965ba0?w=800&h=400&fit=crop',
                        link_url: 'https://line.me/R/oaMessage/@505vsxhr/',
                        link_text: '‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏£‡∏≤'
                    },
                    {
                        title: '‡∏™‡∏∞‡∏™‡∏°‡πÅ‡∏ï‡πâ‡∏°‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•',
                        description: '‡∏ó‡∏∏‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏∞‡∏™‡∏°‡πÅ‡∏ï‡πâ‡∏°‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÅ‡∏•‡∏Å‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏°‡∏≤‡∏Å‡∏°‡∏≤‡∏¢',
                        image_url: 'https://images.unsplash.com/photo-1607083206968-13611e3d76db?w=800&h=400&fit=crop',
                        link_url: 'https://line.me/R/oaMessage/@505vsxhr/',
                        link_text: '‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î'
                    }
                ];

                const { error: newsError, count: newsCount } = await client
                    .from('news_promotions')
                    .insert(newsData)
                    .select('count');

                if (!newsError || newsError.message.includes('duplicate')) {
                    log(`‚úì News data: ${newsCount || 'already exists or inserted'}`, 'pass');
                } else {
                    log(`‚ö† News: ${newsError.message}`, 'warn');
                }

                updateStep(4, 'pass');
                return true;
            } catch (e) {
                log(`‚ö† Insert sample data: ${e.message}`, 'warn');
                updateStep(4, 'warn');
                return true; // Not critical
            }
        }

        async function verifySetup() {
            log('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤...', 'prog');
            updateStep(5, 'progress');

            try {
                let allGood = true;
                const tables = ['profiles', 'tiers', 'news_promotions', 'customer_segments'];

                for (const table of tables) {
                    try {
                        const { count, error } = await client
                            .from(table)
                            .select('*', { count: 'exact', head: true });

                        if (error) {
                            log(`‚ö† Table '${table}': ${error.message}`, 'warn');
                            allGood = false;
                        } else {
                            log(`‚úì Table '${table}': ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (${count || 0} rows)`, 'pass');
                        }
                    } catch (e) {
                        log(`‚ö† Table '${table}': ${e.message}`, 'warn');
                    }
                }

                if (allGood) {
                    updateStep(5, 'pass');
                    log('', 'info');
                    log('‚ïê'.repeat(60), 'info');
                    log('‚úì‚úì‚úì SETUP ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß! ‚úì‚úì‚úì', 'pass');
                    log('‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô test.html ‡πÅ‡∏•‡πâ‡∏ß', 'pass');
                    log('‚ïê'.repeat(60), 'info');
                    document.getElementById('startBtn').disabled = false;
                } else {
                    updateStep(5, 'warn');
                    log('‚ö† Setup ‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô‡∏ö‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏£ ‡∏•‡∏≠‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç', 'warn');
                }

                return allGood;
            } catch (e) {
                log(`‚úó Verify ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ${e.message}`, 'fail');
                updateStep(5, 'fail');
                return false;
            }
        }

        async function runAutoSetup() {
            if (setupInProgress) return;
            setupInProgress = true;

            document.getElementById('startBtn').disabled = true;
            document.getElementById('resetBtn').disabled = true;
            document.getElementById('logs').innerHTML = '';

            log('üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏° Auto Setup Process...', 'info');
            log('‚ïê'.repeat(60), 'info');

            const connected = await checkConnection();
            if (!connected) {
                log('‚úó ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Supabase ‡πÑ‡∏î‡πâ', 'fail');
                setupInProgress = false;
                document.getElementById('startBtn').disabled = false;
                document.getElementById('resetBtn').disabled = false;
                return;
            }

            await new Promise(r => setTimeout(r, 500));
            await createTables();

            await new Promise(r => setTimeout(r, 500));
            await setupRLS();

            await new Promise(r => setTimeout(r, 500));
            await insertSampleData();

            await new Promise(r => setTimeout(r, 500));
            await verifySetup();

            setupInProgress = false;
            document.getElementById('startBtn').disabled = false;
            document.getElementById('resetBtn').disabled = false;
        }

        function reset() {
            document.getElementById('logs').innerHTML = '';
            ['step1', 'step2', 'step3', 'step4', 'step5'].forEach((id, i) => {
                document.getElementById(id).className = 'entry';
                document.getElementById(id).innerHTML = `<span>‚è∏</span> ${document.getElementById(id).innerHTML.substring(2)}`;
            });
            document.getElementById('step1').innerHTML = `<span class="loading">‚è≥</span> ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Database Connection`;
        }

        document.getElementById('startBtn').addEventListener('click', runAutoSetup);
        document.getElementById('resetBtn').addEventListener('click', reset);
    </script>
</body>

</html>