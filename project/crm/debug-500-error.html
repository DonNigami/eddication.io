<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Pro - 500 Error Debugger</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #0f172a;
            color: #e2e8f0;
        }

        .pass {
            color: #22c55e;
        }

        .fail {
            color: #ef4444;
        }

        .warn {
            color: #f59e0b;
        }

        .info {
            color: #3b82f6;
        }

        .entry {
            padding: 10px 14px;
            margin: 6px 0;
            background: #1e293b;
            border-left: 3px solid #475569;
            border-radius: 4px;
            font-size: 13px;
            font-family: monospace;
        }

        .code-block {
            background: #0f172a;
            border: 1px solid #334155;
            padding: 12px;
            border-radius: 4px;
            margin: 10px 0;
            overflow-x: auto;
        }

        button {
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
        }

        .btn-primary {
            background: #06C755;
            color: white;
        }

        .btn-secondary {
            background: #3b82f6;
            color: white;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .solution {
            background: #166534;
            border-left: 4px solid #22c55e;
            padding: 12px;
            margin: 10px 0;
            border-radius: 4px;
        }
    </style>
</head>

<body class="p-6">
    <div class="max-w-5xl mx-auto">
        <h1 class="text-3xl font-bold mb-2 text-red-400">üî¥ 500 Error Debugger</h1>
        <p class="text-gray-400 mb-6">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤ 500 Internal Server Error</p>

        <div class="bg-slate-800 p-6 rounded-lg mb-6">
            <div class="flex gap-3 mb-6 flex-wrap">
                <button class="btn-primary" onclick="checkDatabaseStructure()">üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Database</button>
                <button class="btn-secondary" onclick="testQueries()">üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Queries</button>
                <button class="btn-danger" onclick="fixRLS()">‚öôÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç RLS</button>
                <button class="btn-secondary" onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
            </div>
            <div id="logs" class="space-y-2 max-h-[600px] overflow-y-auto"></div>
        </div>

        <div class="bg-slate-800 p-6 rounded-lg">
            <h2 class="text-lg font-bold mb-4 text-yellow-400">üìã Solutions Found</h2>
            <div id="solutions" class="space-y-4"></div>
        </div>
    </div>

    <script>
        const { createClient } = supabase;
        const supabaseUrl = "https://ckhwouxtrvuthefkxnxb.supabase.co";
        const supabaseKey = "sb_publishable_QvGKuCheOXRbtGH-Cm0Q5A_ddRY3_i3";

        const client = createClient(supabaseUrl, supabaseKey);

        function log(msg, type = 'info') {
            const icons = { pass: '‚úì', fail: '‚úó', warn: '‚ö†', info: '‚Ñπ', error: '‚ùå' };
            const entry = document.createElement('div');
            entry.className = `entry ${type}`;
            entry.innerHTML = `<span class="font-bold">${icons[type] || '‚Üí'}</span> ${msg}`;
            document.getElementById('logs').appendChild(entry);
            document.getElementById('logs').scrollTop = document.getElementById('logs').scrollHeight;
        }

        function addSolution(title, description, sqlCode = null, steps = null) {
            const sol = document.createElement('div');
            sol.className = 'solution';
            let content = `<div class="font-bold text-green-400 mb-2">${title}</div>
                          <div class="text-sm mb-2">${description}</div>`;

            if (sqlCode) {
                content += `<div class="code-block text-xs text-green-300 mb-2"><pre>${sqlCode}</pre></div>`;
            }

            if (steps) {
                content += `<div class="text-xs"><strong>Steps:</strong><ol style="margin-left: 20px;">`;
                steps.forEach(step => {
                    content += `<li>${step}</li>`;
                });
                content += `</ol></div>`;
            }

            sol.innerHTML = content;
            document.getElementById('solutions').appendChild(sol);
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
            document.getElementById('solutions').innerHTML = '';
        }

        async function checkDatabaseStructure() {
            clearLogs();
            log('üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Database...', 'info');

            const tables = ['profiles', 'tiers', 'news_promotions', 'customer_segments'];
            let issues = [];

            for (const table of tables) {
                try {
                    const { data, error, status } = await client
                        .from(table)
                        .select('*')
                        .limit(1);

                    if (error) {
                        log(`‚úó Table '${table}': ${error.message}`, 'fail');
                        issues.push({ table, error: error.message });
                    } else {
                        log(`‚úì Table '${table}' ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ query ‡πÑ‡∏î‡πâ`, 'pass');
                    }
                } catch (e) {
                    log(`‚úó Table '${table}': ${e.message}`, 'fail');
                    issues.push({ table, error: e.message });
                }
            }

            // Check RLS policies
            log('', 'info');
            log('üîê ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö RLS Policies...', 'info');

            try {
                // Try to insert a test record
                const { error } = await client
                    .from('profiles')
                    .insert({
                        line_user_id: 'test_debug_' + Date.now(),
                        display_name: 'Debug Test',
                        role: 'member'
                    })
                    .select();

                if (error) {
                    if (error.message.includes('row-level security')) {
                        log(`‚ö† RLS Policy ‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏Å‡∏≤‡∏£ INSERT`, 'warn');
                        issues.push({ issue: 'RLS Policy too restrictive' });
                        addSolution(
                            '‚ùå RLS Policy ‡∏ö‡∏•‡πá‡∏≠‡∏Å INSERT',
                            'Profiles table ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ INSERT policy ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô',
                            `CREATE POLICY "Enable insert for all users" 
ON public.profiles 
FOR INSERT 
WITH CHECK (true);`,
                            [
                                '‡πÄ‡∏õ‡∏¥‡∏î Supabase Dashboard SQL Editor',
                                'Copy ‡πÅ‡∏•‡∏∞ paste SQL code ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô',
                                'Click RUN'
                            ]
                        );
                    } else {
                        log(`‚ö† Insert error: ${error.message}`, 'warn');
                        issues.push({ issue: error.message });
                    }
                } else {
                    log(`‚úì RLS Policy allows INSERT`, 'pass');
                }
            } catch (e) {
                log(`‚úó RLS check error: ${e.message}`, 'fail');
            }

            if (issues.length === 0) {
                log('', 'info');
                log('‚úì ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤ - Database structure ‡∏î‡∏µ‡πÅ‡∏•‡πâ‡∏ß', 'pass');
            } else {
                log('', 'info');
                log(`‚ö† ‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ${issues.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'warn');
            }
        }

        async function testQueries() {
            clearLogs();
            log('üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Queries...', 'info');

            // Test 1: Simple select
            log('', 'info');
            log('Test 1: SELECT * FROM profiles', 'info');
            try {
                const { data, error } = await client
                    .from('profiles')
                    .select('*');

                if (error) {
                    log(`‚úó Error: ${error.message} (${error.code})`, 'fail');
                    addSolution(
                        '‚ùå SELECT Query ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß',
                        '‡∏õ‡∏±‡∏ç‡∏´‡∏≤: ' + error.message,
                        null,
                        [
                            '‡πÄ‡∏õ‡∏¥‡∏î Supabase Dashboard > SQL Editor',
                            '‡∏£‡∏±‡∏ô: SELECT * FROM public.profiles LIMIT 1;',
                            '‡∏î‡∏π‡∏ß‡πà‡∏≤ error message ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£'
                        ]
                    );
                } else {
                    log(`‚úì Query ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (${data.length} rows)`, 'pass');
                }
            } catch (e) {
                log(`‚úó Exception: ${e.message}`, 'fail');
            }

            // Test 2: Select with where clause
            log('', 'info');
            log('Test 2: SELECT with WHERE clause', 'info');
            try {
                const { data, error } = await client
                    .from('profiles')
                    .select('*')
                    .eq('line_user_id', 'test_non_existent');

                if (error) {
                    log(`‚úó Error: ${error.message}`, 'fail');
                } else {
                    log(`‚úì Query ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (${data.length} rows)`, 'pass');
                }
            } catch (e) {
                log(`‚úó Exception: ${e.message}`, 'fail');
            }

            // Test 3: Check column definitions
            log('', 'info');
            log('Test 3: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Column Definitions', 'info');
            try {
                const { data, error } = await client
                    .from('profiles')
                    .select('*')
                    .limit(0);

                if (error) {
                    log(`‚úó Cannot fetch schema: ${error.message}`, 'fail');
                } else {
                    log(`‚úì Columns found:`, 'pass');
                }
            } catch (e) {
                log(`‚úó Exception: ${e.message}`, 'fail');
            }

            // Test 4: Other tables
            log('', 'info');
            log('Test 4: ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Tables ‡∏≠‡∏∑‡πà‡∏ô', 'info');
            const testTables = ['tiers', 'news_promotions', 'customer_segments'];
            for (const table of testTables) {
                try {
                    const { data, error } = await client
                        .from(table)
                        .select('*')
                        .limit(1);

                    if (error) {
                        log(`‚úó ${table}: ${error.message}`, 'fail');
                    } else {
                        log(`‚úì ${table}: OK (${data.length} rows)`, 'pass');
                    }
                } catch (e) {
                    log(`‚úó ${table}: ${e.message}`, 'fail');
                }
            }
        }

        async function fixRLS() {
            clearLogs();
            log('‚öôÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç RLS Policies...', 'info');
            log('', 'info');
            log('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:', 'info');

            addSolution(
                'üîß Option 1: Enable RLS but allow public read',
                '‡πÉ‡∏´‡πâ public read ‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà insert/update/delete ‡∏ï‡πâ‡∏≠‡∏á authenticated',
                `-- Drop existing policies
DROP POLICY IF EXISTS "Public profiles are viewable by everyone" ON public.profiles;
DROP POLICY IF EXISTS "Users can update their own profile" ON public.profiles;
DROP POLICY IF EXISTS "Users can insert their own profile" ON public.profiles;

-- Create new policies
CREATE POLICY "Allow public select" 
ON public.profiles FOR SELECT 
USING (true);

CREATE POLICY "Allow authenticated insert" 
ON public.profiles FOR INSERT 
WITH CHECK (true);

CREATE POLICY "Allow authenticated update" 
ON public.profiles FOR UPDATE 
USING (true) 
WITH CHECK (true);`,
                [
                    '‡πÄ‡∏õ‡∏¥‡∏î Supabase Dashboard > SQL Editor',
                    'Copy SQL code ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô',
                    'Click RUN',
                    'Refresh test.html'
                ]
            );

            addSolution(
                'üîß Option 2: Disable RLS completely (‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)',
                '‡∏õ‡∏¥‡∏î RLS ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö (‡πÑ‡∏°‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡∏î‡∏±‡∏Å‡∏ä‡∏±‡πà‡∏ô)',
                `ALTER TABLE public.profiles DISABLE ROW LEVEL SECURITY;
ALTER TABLE public.tiers DISABLE ROW LEVEL SECURITY;
ALTER TABLE public.news_promotions DISABLE ROW LEVEL SECURITY;
ALTER TABLE public.customer_segments DISABLE ROW LEVEL SECURITY;`,
                [
                    '‡πÄ‡∏õ‡∏¥‡∏î Supabase Dashboard > SQL Editor',
                    'Copy SQL code ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô',
                    'Click RUN',
                    'Refresh test.html',
                    '‚ö†Ô∏è ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: Enable RLS ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏£‡πá‡∏à‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö!'
                ]
            );

            addSolution(
                'üîç Option 3: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö RLS Policies ‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà',
                '‡∏î‡∏π‡∏ß‡πà‡∏≤ RLS policies ‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
                `-- Check RLS status
SELECT schemaname, tablename, rowsecurity 
FROM pg_tables 
WHERE tablename IN ('profiles', 'tiers', 'news_promotions', 'customer_segments');

-- Check policies
SELECT schemaname, tablename, policyname, permissive, roles, qual, with_check
FROM pg_policies 
WHERE tablename IN ('profiles', 'tiers', 'news_promotions', 'customer_segments');`,
                [
                    '‡πÄ‡∏õ‡∏¥‡∏î Supabase Dashboard > SQL Editor',
                    'Copy SQL code ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô',
                    'Click RUN',
                    '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå'
                ]
            );

            log('', 'info');
            log('‚úì ‡∏ó‡∏≥‡∏ï‡∏≤‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô Solutions ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô', 'info');
        }

        // Auto run check on load
        window.addEventListener('load', () => {
            log('üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...', 'info');
            setTimeout(checkDatabaseStructure, 500);
        });
    </script>
</body>

</html>