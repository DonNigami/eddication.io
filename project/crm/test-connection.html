<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ CRM Test - Connection Diagnostic</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #0f172a;
            color: #e2e8f0;
        }

        .test-pass {
            color: #22c55e;
        }

        .test-fail {
            color: #ef4444;
        }

        .test-warn {
            color: #f59e0b;
        }

        .test-info {
            color: #3b82f6;
        }

        .log-entry {
            padding: 8px 12px;
            margin: 4px 0;
            background: #1e293b;
            border-left: 3px solid #475569;
            border-radius: 4px;
        }
    </style>
</head>

<body class="p-6">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6 text-cyan-400">üß™ CRM Pro - Connection Diagnostic Tool</h1>

        <div id="testResults" class="space-y-4"></div>

        <div class="mt-8 p-4 bg-slate-800 rounded-lg">
            <h2 class="text-xl font-bold mb-4 text-yellow-400">üìä Test Summary</h2>
            <div id="summary" class="space-y-2"></div>
        </div>

        <div class="mt-6 p-4 bg-slate-800 rounded-lg">
            <h2 class="text-xl font-bold mb-4 text-purple-400">üîß Quick Fixes</h2>
            <div id="fixes" class="space-y-2 text-sm"></div>
        </div>
    </div>

    <script>
        const { createClient } = supabase;

        // Config from test.html
        const CONFIG = {
            LIFF_ID: "2006397073-kK6uCiwf",
            SUPABASE_URL: "https://ckhwouxtrvuthefkxnxb.supabase.co",
            SUPABASE_KEY: "sb_publishable_QvGKuCheOXRbtGH-Cm0Q5A_ddRY3_i3"
        };

        let testsPassed = 0;
        let testsFailed = 0;
        let testsWarning = 0;

        function log(message, type = 'info') {
            const colors = {
                pass: 'test-pass',
                fail: 'test-fail',
                warn: 'test-warn',
                info: 'test-info'
            };
            const icons = {
                pass: '‚úì',
                fail: '‚úó',
                warn: '‚ö†',
                info: '‚Ñπ'
            };

            const entry = document.createElement('div');
            entry.className = `log-entry ${colors[type]}`;
            entry.innerHTML = `<span class="font-bold">${icons[type]}</span> ${message}`;
            document.getElementById('testResults').appendChild(entry);

            if (type === 'pass') testsPassed++;
            if (type === 'fail') testsFailed++;
            if (type === 'warn') testsWarning++;
        }

        function addFix(message) {
            const fix = document.createElement('div');
            fix.className = 'text-orange-300';
            fix.innerHTML = `‚Üí ${message}`;
            document.getElementById('fixes').appendChild(fix);
        }

        async function runTests() {
            log('üöÄ Starting diagnostic tests...', 'info');
            log('‚ïê'.repeat(60), 'info');

            // Test 1: Supabase Connection
            log('Test 1: Testing Supabase connection...', 'info');
            try {
                const client = createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);
                log(`‚úì Supabase client initialized`, 'pass');

                // Test basic connectivity
                const { data, error } = await client.from('profiles').select('count').limit(0);
                if (error) {
                    if (error.message.includes('relation "public.profiles" does not exist')) {
                        log(`‚úó Table 'profiles' does not exist!`, 'fail');
                        addFix('Execute SQL: CREATE TABLE profiles (id uuid primary key default gen_random_uuid(), line_user_id text unique, display_name text, picture_url text, email text, phone text, role text default \'member\', points int default 0, tags text[], last_activity timestamp, created_at timestamp default now())');
                    } else {
                        log(`‚úó Supabase error: ${error.message}`, 'fail');
                    }
                } else {
                    log(`‚úì Successfully connected to 'profiles' table`, 'pass');
                }
            } catch (e) {
                log(`‚úó Supabase connection failed: ${e.message}`, 'fail');
                addFix('Check Supabase URL and API key');
            }

            // Test 2: Check Required Tables
            log('‚îÄ'.repeat(60), 'info');
            log('Test 2: Checking required tables...', 'info');
            const requiredTables = ['profiles', 'tiers', 'news_promotions', 'customer_segments'];
            const client = createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);

            for (const table of requiredTables) {
                try {
                    const { data, error } = await client.from(table).select('count').limit(0);
                    if (error) {
                        if (error.message.includes('does not exist')) {
                            log(`‚úó Table '${table}' missing`, 'fail');
                            if (table === 'profiles') {
                                addFix(`Create profiles table first (used for user data)`);
                            } else if (table === 'tiers') {
                                addFix(`Create tiers table: CREATE TABLE tiers (id serial primary key, name text, min_points int, color_theme text)`);
                            } else if (table === 'news_promotions') {
                                addFix(`Create news_promotions table: CREATE TABLE news_promotions (id serial primary key, title text, description text, image_url text, link_url text, link_text text, created_at timestamp default now())`);
                            } else if (table === 'customer_segments') {
                                addFix(`Create customer_segments table: CREATE TABLE customer_segments (id serial primary key, name text, conditions jsonb, created_at timestamp default now())`);
                            }
                        } else {
                            log(`‚ö† Table '${table}' - RLS policy issue: ${error.message}`, 'warn');
                            addFix(`Check RLS policies for '${table}' table - may need to allow public read access for anon key`);
                        }
                    } else {
                        log(`‚úì Table '${table}' exists and accessible`, 'pass');
                    }
                } catch (e) {
                    log(`‚úó Error checking '${table}': ${e.message}`, 'fail');
                }
            }

            // Test 3: Check Edge Functions
            log('‚îÄ'.repeat(60), 'info');
            log('Test 3: Checking Edge Functions...', 'info');
            const functions = ['crm-core', 'crm-pro'];

            for (const funcName of functions) {
                try {
                    const { data, error } = await client.functions.invoke(funcName, {
                        body: { action: 'ping' }
                    });
                    if (error) {
                        log(`‚ö† Function '${funcName}' - ${error.message}`, 'warn');
                        addFix(`Deploy Edge Function: supabase functions deploy ${funcName}`);
                    } else {
                        log(`‚úì Function '${funcName}' is accessible`, 'pass');
                    }
                } catch (e) {
                    log(`‚ö† Function '${funcName}' - ${e.message}`, 'warn');
                }
            }

            // Test 4: LIFF Configuration
            log('‚îÄ'.repeat(60), 'info');
            log('Test 4: Testing LIFF configuration...', 'info');
            try {
                await liff.init({ liffId: CONFIG.LIFF_ID });
                log(`‚úì LIFF initialized successfully`, 'pass');
                log(`‚Ñπ LIFF ID: ${CONFIG.LIFF_ID}`, 'info');
                log(`‚Ñπ Is In Client: ${liff.isInClient()}`, 'info');
                log(`‚Ñπ Is Logged In: ${liff.isLoggedIn()}`, 'info');

                if (!liff.isLoggedIn()) {
                    log(`‚ö† User not logged in to LINE`, 'warn');
                    addFix('Open this page through LINE LIFF URL to test full functionality');
                } else {
                    const profile = await liff.getProfile();
                    log(`‚úì LINE Profile retrieved: ${profile.displayName}`, 'pass');
                }
            } catch (e) {
                log(`‚úó LIFF initialization failed: ${e.message}`, 'fail');
                addFix('Check LIFF_ID configuration in LINE Developers Console');
            }

            // Test 5: Check Sample Data
            log('‚îÄ'.repeat(60), 'info');
            log('Test 5: Checking for sample data...', 'info');
            try {
                const { data: profiles, error: profileError } = await client.from('profiles').select('count');
                if (!profileError && profiles) {
                    log(`‚Ñπ Profiles count: ${profiles.length > 0 ? profiles[0].count : 0}`, 'info');
                }

                const { data: tiers, error: tierError } = await client.from('tiers').select('*');
                if (!tierError && tiers) {
                    log(`‚Ñπ Tiers count: ${tiers.length}`, 'info');
                    if (tiers.length === 0) {
                        log(`‚ö† No tiers configured`, 'warn');
                        addFix('Insert default tiers: INSERT INTO tiers (name, min_points, color_theme) VALUES (\'Member\', 0, \'card-member\'), (\'Silver\', 1000, \'card-silver\'), (\'Gold\', 5000, \'card-gold\')');
                    }
                }
            } catch (e) {
                log(`‚Ñπ Skipping sample data check`, 'info');
            }

            // Summary
            log('‚ïê'.repeat(60), 'info');
            document.getElementById('summary').innerHTML = `
                <div class="test-pass">‚úì Passed: ${testsPassed}</div>
                <div class="test-fail">‚úó Failed: ${testsFailed}</div>
                <div class="test-warn">‚ö† Warnings: ${testsWarning}</div>
                <div class="mt-4 text-lg font-bold ${testsFailed === 0 ? 'test-pass' : 'test-fail'}">
                    ${testsFailed === 0 ? '‚úì All critical tests passed!' : '‚úó Critical issues found - see fixes below'}
                </div>
            `;

            if (document.getElementById('fixes').children.length === 0) {
                document.getElementById('fixes').innerHTML = '<div class="test-pass">No issues found! System should be working correctly.</div>';
            }
        }

        // Run tests on page load
        window.addEventListener('load', runTests);
    </script>
</body>

</html>