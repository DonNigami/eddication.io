<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏Ñ‡πÄ‡∏Å‡∏à‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å - CRM Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body class="bg-gray-50">
    <div id="app" class="container mx-auto px-4 py-8">

        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏Ñ‡πÄ‡∏Å‡∏à‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h1>
            <p class="text-gray-600 mt-2">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏Ñ‡πÄ‡∏Å‡∏à‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏£‡∏≤‡∏¢‡∏õ‡∏µ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
        </div>

        <!-- Stats Cards -->
        <div class="grid md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-sm text-gray-600">‡πÅ‡∏û‡∏Ñ‡πÄ‡∏Å‡∏à‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                <div class="text-3xl font-bold text-blue-600 mt-2">{{ packages.length }}</div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-sm text-gray-600">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
                <div class="text-3xl font-bold text-green-600 mt-2">{{ activeSubscribers }}</div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-sm text-gray-600">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°/‡∏õ‡∏µ</div>
                <div class="text-3xl font-bold text-purple-600 mt-2">‡∏ø{{ totalRevenue.toLocaleString() }}</div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-sm text-gray-600">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏£‡πá‡∏ß‡πÜ‡∏ô‡∏µ‡πâ</div>
                <div class="text-3xl font-bold text-orange-600 mt-2">{{ expiringCount }}</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="bg-white rounded-lg shadow mb-6">
            <div class="border-b border-gray-200">
                <nav class="flex">
                    <button @click="currentTab = 'packages'"
                        :class="currentTab === 'packages' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                        class="px-6 py-4 text-sm font-medium border-b-2 transition-colors">
                        ‡πÅ‡∏û‡∏Ñ‡πÄ‡∏Å‡∏à
                    </button>
                    <button @click="currentTab = 'submissions'"
                        :class="currentTab === 'submissions' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                        class="px-6 py-4 text-sm font-medium border-b-2 transition-colors">
                        üÜï ‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏´‡∏°‡πà <span class="ml-2 bg-red-500 text-white text-xs rounded-full px-2 py-0.5">{{
                            pendingSubmissions.length }}</span>
                    </button>
                    <button @click="currentTab = 'subscribers'"
                        :class="currentTab === 'subscribers' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                        class="px-6 py-4 text-sm font-medium border-b-2 transition-colors">
                        ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
                    </button>
                    <button @click="currentTab = 'payments'"
                        :class="currentTab === 'payments' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                        class="px-6 py-4 text-sm font-medium border-b-2 transition-colors">
                        ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
                    </button>
                </nav>
            </div>
        </div>

        <!-- Packages Tab -->
        <div v-if="currentTab === 'packages'">
            <div class="mb-6 flex justify-between items-center">
                <h2 class="text-xl font-bold text-gray-800">‡πÅ‡∏û‡∏Ñ‡πÄ‡∏Å‡∏à‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h2>
                <button @click="showPackageModal = true; editingPackage = null"
                    class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                    + ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏û‡∏Ñ‡πÄ‡∏Å‡∏à‡πÉ‡∏´‡∏°‡πà
                </button>
            </div>

            <div class="grid md:grid-cols-3 gap-6">
                <div v-for="pkg in sortedPackages" :key="pkg.id"
                    class="bg-white rounded-lg shadow-lg overflow-hidden border-t-4"
                    :style="`border-color: ${pkg.color_theme}`">
                    <div class="p-6">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-2xl font-bold" :style="`color: ${pkg.color_theme}`">
                                    {{ pkg.name }}
                                </h3>
                                <p class="text-gray-500 text-sm">{{ pkg.name_en }}</p>
                            </div>
                            <span v-if="pkg.is_active"
                                class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">
                                ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
                            </span>
                            <span v-else class="px-2 py-1 bg-gray-100 text-gray-800 text-xs rounded-full">
                                ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
                            </span>
                        </div>

                        <div class="mb-4">
                            <div class="text-4xl font-bold text-gray-800">
                                ‡∏ø{{ pkg.price_yearly.toLocaleString() }}
                                <span class="text-lg text-gray-500 font-normal">/‡∏õ‡∏µ</span>
                            </div>
                            <div class="text-sm text-gray-600 mt-1">
                                (‡∏ø{{ (pkg.price_yearly / 12).toFixed(0) }}/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)
                            </div>
                        </div>

                        <div class="space-y-2 mb-6">
                            <div class="flex items-center text-sm">
                                <span class="text-gray-600">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î:</span>
                                <span class="ml-2 font-semibold text-green-600">{{ pkg.discount_percent }}%</span>
                            </div>
                            <div class="flex items-center text-sm">
                                <span class="text-gray-600">‡∏Ñ‡∏π‡∏ì‡πÅ‡∏ï‡πâ‡∏°:</span>
                                <span class="ml-2 font-semibold text-blue-600">{{ pkg.points_multiplier }}x</span>
                            </div>
                        </div>

                        <div class="border-t pt-4 mb-4">
                            <div class="text-sm font-semibold text-gray-700 mb-2">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏û‡∏¥‡πÄ‡∏®‡∏©:</div>
                            <ul class="space-y-1">
                                <li v-for="(benefit, idx) in pkg.benefits" :key="idx" class="flex items-start text-sm">
                                    <span class="text-green-500 mr-2">‚úì</span>
                                    <span class="text-gray-600">{{ benefit }}</span>
                                </li>
                            </ul>
                        </div>

                        <div class="flex gap-2">
                            <button @click="editPackage(pkg)"
                                class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors text-sm">
                                ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                            </button>
                            <button @click="togglePackageStatus(pkg)"
                                class="flex-1 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors text-sm">
                                {{ pkg.is_active ? '‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : '‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' }}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- New Submissions Tab -->
        <div v-if="currentTab === 'submissions'">
            <div class="bg-white rounded-lg shadow">
                <div class="p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">üìã ‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏´‡∏°‡πà (‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö)</h2>

                    <div v-if="pendingSubmissions.length === 0" class="text-center py-8 text-gray-500">
                        <p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</p>
                    </div>

                    <div v-else class="grid gap-6">
                        <div v-for="submission in pendingSubmissions" :key="submission.id"
                            class="border-2 border-yellow-200 rounded-lg p-6 bg-yellow-50">

                            <!-- Customer Info -->
                            <div class="mb-6">
                                <div class="grid md:grid-cols-2 gap-4">
                                    <div>
                                        <h3 class="font-bold text-lg text-gray-800">{{ submission.customer_info.name }}
                                        </h3>
                                        <p class="text-gray-600">üì± {{ submission.customer_info.phone }}</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-sm text-gray-500">‡∏™‡πà‡∏á‡∏°‡∏≤ {{ formatDate(submission.submission_time)
                                            }}</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Package Details -->
                            <div class="bg-white rounded-lg p-4 mb-6 border border-gray-200">
                                <div class="grid md:grid-cols-2 gap-4">
                                    <div>
                                        <div class="text-sm text-gray-600">‡πÅ‡∏û‡∏Ñ‡πÄ‡∏Å‡∏à</div>
                                        <div class="text-lg font-bold text-gray-800">{{ submission.package_name }}</div>
                                    </div>
                                    <div>
                                        <div class="text-sm text-gray-600">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</div>
                                        <div class="text-lg font-bold text-gray-800">{{ submission.duration_months }}
                                            ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
                                    </div>
                                    <div>
                                        <div class="text-sm text-gray-600">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô</div>
                                        <div class="text-lg font-bold text-gray-800">‡∏ø{{
                                            submission.original_price.toLocaleString() }}</div>
                                    </div>
                                    <div>
                                        <div class="text-sm text-gray-600">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î / ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢</div>
                                        <div class="text-lg font-bold text-green-600">-{{ submission.discount_percent
                                            }}% / ‡∏ø{{ submission.total_price.toLocaleString() }}</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Slip Preview -->
                            <div v-if="submission.slip_url" class="mb-6">
                                <p class="text-sm font-bold text-gray-700 mb-2">üñºÔ∏è ‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</p>
                                <a :href="submission.slip_url" target="_blank" rel="noopener noreferrer">
                                    <img :src="submission.slip_url" alt="Payment slip"
                                        class="max-h-48 rounded-lg border border-gray-300 hover:border-blue-500 transition-colors">
                                </a>
                            </div>

                            <!-- Action Buttons -->
                            <div class="flex gap-3">
                                <button @click="approveSubmission(submission)"
                                    class="flex-1 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-semibold">
                                    ‚úì ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                                </button>
                                <button @click="rejectSubmission(submission)"
                                    class="flex-1 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors font-semibold">
                                    ‚úó ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò
                                </button>
                                <button @click="viewDetails(submission)"
                                    class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                                    üìã ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Subscribers Tab -->
        <div v-if="currentTab === 'subscribers'">
            <div class="bg-white rounded-lg shadow">
                <div class="p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h2>

                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">‡∏ä‡∏∑‡πà‡∏≠
                                    </th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">‡πÅ‡∏û‡∏Ñ‡πÄ‡∏Å‡∏à
                                    </th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                                    </th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">‡πÄ‡∏£‡∏¥‡πà‡∏°
                                    </th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏
                                    </th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                        ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£
                                    </th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                <tr v-for="sub in subscriptions" :key="sub.id" class="hover:bg-gray-50">
                                    <td class="px-4 py-3">
                                        <div class="font-medium text-gray-900">{{ sub.customer_name || '-' }}</div>
                                        <div class="text-sm text-gray-500">{{ sub.customer_phone }}</div>
                                    </td>
                                    <td class="px-4 py-3">
                                        <span class="px-2 py-1 text-xs font-medium rounded-full"
                                            :style="`background-color: ${sub.package_color}20; color: ${sub.package_color}`">
                                            {{ sub.package_name }}
                                        </span>
                                    </td>
                                    <td class="px-4 py-3">
                                        <span v-if="sub.status === 'active'"
                                            class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">
                                            ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
                                        </span>
                                        <span v-else-if="sub.status === 'pending'"
                                            class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded-full">
                                            ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
                                        </span>
                                        <span v-else class="px-2 py-1 bg-gray-100 text-gray-800 text-xs rounded-full">
                                            {{ sub.status }}
                                        </span>
                                    </td>
                                    <td class="px-4 py-3 text-sm text-gray-600">
                                        {{ formatDate(sub.start_date) }}
                                    </td>
                                    <td class="px-4 py-3 text-sm">
                                        <span
                                            :class="isExpiringSoon(sub.end_date) ? 'text-orange-600 font-semibold' : 'text-gray-600'">
                                            {{ formatDate(sub.end_date) }}
                                        </span>
                                    </td>
                                    <td class="px-4 py-3">
                                        <span v-if="sub.payment_status === 'paid'"
                                            class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">
                                            ‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß
                                        </span>
                                        <span v-else class="px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full">
                                            ‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞
                                        </span>
                                    </td>
                                    <td class="px-4 py-3 text-right">
                                        <button @click="viewSubscription(sub)"
                                            class="text-blue-600 hover:text-blue-800 text-sm">
                                            ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payments Tab -->
        <div v-if="currentTab === 'payments'">
            <div class="bg-white rounded-lg shadow">
                <div class="p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h2>

                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
                                    </th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
                                    </th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">‡πÅ‡∏û‡∏Ñ‡πÄ‡∏Å‡∏à
                                    </th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                        ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£
                                    </th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                                    </th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£
                                    </th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                <tr v-for="payment in payments" :key="payment.id" class="hover:bg-gray-50">
                                    <td class="px-4 py-3 text-sm text-gray-600">
                                        {{ formatDateTime(payment.created_at) }}
                                    </td>
                                    <td class="px-4 py-3 text-sm text-gray-900">
                                        {{ payment.customer_name }}
                                    </td>
                                    <td class="px-4 py-3 text-sm text-gray-600">
                                        {{ payment.package_name }}
                                    </td>
                                    <td class="px-4 py-3 text-sm font-medium text-gray-900">
                                        ‡∏ø{{ payment.amount.toLocaleString() }}
                                    </td>
                                    <td class="px-4 py-3">
                                        <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">
                                            {{ payment.payment_method === 'promptpay' ? 'PromptPay' :
                                            payment.payment_method }}
                                        </span>
                                    </td>
                                    <td class="px-4 py-3">
                                        <span v-if="payment.status === 'verified'"
                                            class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">
                                            ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß
                                        </span>
                                        <span v-else-if="payment.status === 'pending'"
                                            class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded-full">
                                            ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
                                        </span>
                                        <span v-else class="px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full">
                                            ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò
                                        </span>
                                    </td>
                                    <td class="px-4 py-3 text-right space-x-2">
                                        <button v-if="payment.slip_url" @click="viewSlip(payment.slip_url)"
                                            class="text-blue-600 hover:text-blue-800 text-sm">
                                            ‡∏î‡∏π‡∏™‡∏•‡∏¥‡∏õ
                                        </button>
                                        <button v-if="payment.status === 'pending'" @click="verifyPayment(payment)"
                                            class="text-green-600 hover:text-green-800 text-sm">
                                            ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Package Modal -->
        <div v-if="showPackageModal"
            class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <div class="p-6 border-b">
                    <h3 class="text-xl font-bold text-gray-800">
                        {{ editingPackage ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏û‡∏Ñ‡πÄ‡∏Å‡∏à' : '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏û‡∏Ñ‡πÄ‡∏Å‡∏à‡πÉ‡∏´‡∏°‡πà' }}
                    </h3>
                </div>

                <div class="p-6 space-y-4">
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏û‡∏Ñ‡πÄ‡∏Å‡∏à (‡πÑ‡∏ó‡∏¢) *</label>
                            <input v-model="packageForm.name" type="text"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏≠‡∏á">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏û‡∏Ñ‡πÄ‡∏Å‡∏à (EN)</label>
                            <input v-model="packageForm.name_en" type="text"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Gold Member">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</label>
                        <textarea v-model="packageForm.description" rows="3"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg"></textarea>
                    </div>

                    <div class="grid md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏õ‡∏µ (‡∏ø) *</label>
                            <input v-model="packageForm.price_yearly" type="number"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="999">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (%) *</label>
                            <input v-model="packageForm.discount_percent" type="number" step="0.01"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="5.00">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏Ñ‡∏π‡∏ì‡πÅ‡∏ï‡πâ‡∏° *</label>
                            <input v-model="packageForm.points_multiplier" type="number" step="0.1"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="1.5">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏™‡∏µ‡∏ò‡∏µ‡∏°</label>
                        <input v-model="packageForm.color_theme" type="color"
                            class="h-10 w-20 border border-gray-300 rounded-lg">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏ö‡∏≠‡∏£‡πå PromptPay</label>
                        <input v-model="packageForm.promptpay_phone" type="text"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="0656987889">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏û‡∏¥‡πÄ‡∏®‡∏© (‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 1
                            ‡∏Ç‡πâ‡∏≠)</label>
                        <textarea v-model="benefitsText" rows="5"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg"
                            placeholder="‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î 5% ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á&#10;‡∏™‡∏∞‡∏™‡∏°‡πÅ‡∏ï‡πâ‡∏° 1.5 ‡πÄ‡∏ó‡πà‡∏≤&#10;‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏ü‡∏£‡∏µ"></textarea>
                    </div>

                    <div class="flex items-center">
                        <input v-model="packageForm.is_active" type="checkbox" class="mr-2">
                        <label class="text-sm text-gray-700">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</label>
                    </div>
                </div>

                <div class="p-6 border-t flex justify-end space-x-4">
                    <button @click="showPackageModal = false"
                        class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                    <button @click="savePackage" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                        {{ editingPackage ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å' : '‡∏™‡∏£‡πâ‡∏≤‡∏á' }}
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp } = Vue

        createApp({
            data() {
                return {
                    currentTab: 'packages',
                    packages: [],
                    subscriptions: [],
                    payments: [],
                    pendingSubmissions: [],
                    showPackageModal: false,
                    editingPackage: null,
                    packageForm: this.getEmptyPackageForm(),
                    benefitsText: '',
                    supabase: null,
                    tenantId: null
                }
            },
            computed: {
                sortedPackages() {
                    return [...this.packages].sort((a, b) => a.sort_order - b.sort_order)
                },
                activeSubscribers() {
                    return this.subscriptions.filter(s => s.status === 'active').length
                },
                totalRevenue() {
                    return this.subscriptions
                        .filter(s => s.payment_status === 'paid')
                        .reduce((sum, s) => sum + parseFloat(s.paid_amount || 0), 0)
                },
                expiringCount() {
                    const thirtyDaysFromNow = new Date()
                    thirtyDaysFromNow.setDate(thirtyDaysFromNow.getDate() + 30)
                    return this.subscriptions.filter(s =>
                        s.status === 'active' &&
                        new Date(s.end_date) <= thirtyDaysFromNow
                    ).length
                }
            },
            async mounted() {
                // Initialize Supabase
                this.supabase = window.supabase.createClient(
                    'https://ckhwouxtrvuthefkxnxb.supabase.co',
                    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNraHdvdXh0cnZ1dGhlZmt4bnhiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwMTcxMjcsImV4cCI6MjA4MjU5MzEyN30.nrJ7es0Zo5Tp77v4Vt8nndgPpOULKf6hc9Nf3L-zxF4'
                )

                // TODO: Get tenantId from session
                this.tenantId = 'demo-tenant-id'

                await this.loadData()
            },
            methods: {
                async loadData() {
                    await Promise.all([
                        this.loadPackages(),
                        this.loadSubscriptions(),
                        this.loadPayments(),
                        this.loadPendingSubmissions()
                    ])
                },
                async loadPendingSubmissions() {
                    try {
                        console.log('üîç Loading pending submissions...')
                        const { data, error } = await this.supabase
                            .from('subscription_requests')
                            .select('*')
                            .eq('status', 'pending')
                            .order('created_at', { ascending: false })

                        if (error) {
                            console.error('‚ùå Supabase error:', error)
                            throw error
                        }

                        this.pendingSubmissions = data || []
                        console.log('‚úÖ Loaded pending submissions:', this.pendingSubmissions.length, data)

                        if (this.pendingSubmissions.length === 0) {
                            console.warn('‚ö†Ô∏è No pending submissions found. Check if data exists in table.')
                        }
                    } catch (err) {
                        console.error('‚ùå Error loading submissions:', err.message, err)
                        this.pendingSubmissions = []

                        // Show error to user
                        Swal.fire({
                            icon: 'error',
                            title: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ',
                            text: err.message,
                            footer: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Console (F12) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î'
                        })
                    }
                },
                async loadPackages() {
                    // TODO: Load from Supabase
                    this.packages = [
                        {
                            id: '1',
                            name: '‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏≠‡∏á',
                            name_en: 'Gold Member',
                            description: '‡πÅ‡∏û‡∏Ñ‡πÄ‡∏Å‡∏à‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ó‡∏≠‡∏á',
                            price_yearly: 999,
                            discount_percent: 5.00,
                            points_multiplier: 1.5,
                            color_theme: '#FFD700',
                            benefits: ['‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î 5% ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', '‡∏™‡∏∞‡∏™‡∏°‡πÅ‡∏ï‡πâ‡∏° 1.5 ‡πÄ‡∏ó‡πà‡∏≤', '‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏ü‡∏£‡∏µ'],
                            is_active: true,
                            sort_order: 1
                        }
                    ]
                },
                async loadSubscriptions() {
                    this.subscriptions = []
                },
                async loadPayments() {
                    this.payments = []
                },
                getEmptyPackageForm() {
                    return {
                        name: '',
                        name_en: '',
                        description: '',
                        price_yearly: 999,
                        discount_percent: 5.00,
                        points_multiplier: 1.5,
                        color_theme: '#3B82F6',
                        promptpay_phone: '0656987889',
                        is_active: true,
                        benefits: []
                    }
                },
                editPackage(pkg) {
                    this.editingPackage = pkg
                    this.packageForm = { ...pkg }
                    this.benefitsText = pkg.benefits.join('\n')
                    this.showPackageModal = true
                },
                async savePackage() {
                    // Parse benefits
                    this.packageForm.benefits = this.benefitsText
                        .split('\n')
                        .filter(b => b.trim())

                    // TODO: Save to Supabase
                    Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏û‡∏Ñ‡πÄ‡∏Å‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success')
                    this.showPackageModal = false
                    this.packageForm = this.getEmptyPackageForm()
                    this.benefitsText = ''
                    await this.loadPackages()
                },
                async togglePackageStatus(pkg) {
                    // TODO: Update in Supabase
                    pkg.is_active = !pkg.is_active
                    Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', pkg.is_active ? '‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß' : '‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß', 'success')
                },
                viewSubscription(sub) {
                    Swal.fire({
                        title: '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å',
                        html: `
                            <div class="text-left">
                                <p><strong>‡∏ä‡∏∑‡πà‡∏≠:</strong> ${sub.customer_name}</p>
                                <p><strong>‡πÅ‡∏û‡∏Ñ‡πÄ‡∏Å‡∏à:</strong> ${sub.package_name}</p>
                                <p><strong>‡πÄ‡∏£‡∏¥‡πà‡∏°:</strong> ${this.formatDate(sub.start_date)}</p>
                                <p><strong>‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏:</strong> ${this.formatDate(sub.end_date)}</p>
                            </div>
                        `
                    })
                },
                viewSlip(url) {
                    window.open(url, '_blank')
                },
                async verifyPayment(payment) {
                    const result = await Swal.fire({
                        title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô?',
                        text: `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ‡∏ø${payment.amount.toLocaleString()}`,
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô',
                        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
                    })

                    if (result.isConfirmed) {
                        try {
                            // Call subscription-manager to verify payment
                            const { data, error } = await this.supabase.functions.invoke('subscription-manager', {
                                body: {
                                    action: 'verify-payment',
                                    payment_id: payment.id,
                                    verified_by: 'admin' // TODO: Get actual admin ID
                                }
                            })

                            if (error) throw error

                            Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á Telegram', 'success')
                            await this.loadPayments()
                            await this.loadSubscriptions()
                        } catch (error) {
                            Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ: ' + error.message, 'error')
                        }
                    }
                },
                formatDate(date) {
                    if (!date) return '-'
                    return new Date(date).toLocaleDateString('th-TH', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    })
                },
                formatDateTime(date) {
                    if (!date) return '-'
                    return new Date(date).toLocaleString('th-TH', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    })
                },
                isExpiringSoon(date) {
                    const thirtyDaysFromNow = new Date()
                    thirtyDaysFromNow.setDate(thirtyDaysFromNow.getDate() + 30)
                    return new Date(date) <= thirtyDaysFromNow
                },
                async approveSubmission(submission) {
                    const result = await Swal.fire({
                        title: '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å?',
                        text: `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏Ç‡∏≠‡∏á ${submission.customer_info.name}`,
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonText: '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥',
                        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
                    })

                    if (result.isConfirmed) {
                        // TODO: Update submission status in database
                        // TODO: Send LINE notification to customer
                        Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß', 'success')
                        // Remove from pending list
                        this.pendingSubmissions = this.pendingSubmissions.filter(s => s.id !== submission.id)
                    }
                },
                async rejectSubmission(submission) {
                    const { value: reason } = await Swal.fire({
                        title: '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£',
                        input: 'textarea',
                        inputLabel: '‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò',
                        inputPlaceholder: '‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•...',
                        showCancelButton: true,
                        inputValidator: (value) => {
                            if (!value) {
                                return '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•'
                            }
                        }
                    })

                    if (reason) {
                        // TODO: Update submission status and reason in database
                        // TODO: Send LINE notification to customer with reason
                        Swal.fire('‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß', 'success')
                        this.pendingSubmissions = this.pendingSubmissions.filter(s => s.id !== submission.id)
                    }
                },
                async viewDetails(submission) {
                    await Swal.fire({
                        title: '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£',
                        html: `
                            <div style="text-align: left">
                                <p><strong>‡∏ä‡∏∑‡πà‡∏≠:</strong> ${submission.customer_info.name}</p>
                                <p><strong>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:</strong> ${submission.customer_info.phone}</p>
                                <p><strong>LINE User ID:</strong> ${submission.line_user_id || '-'}</p>
                                <p><strong>‡πÅ‡∏û‡∏Ñ‡πÄ‡∏Å‡∏à:</strong> ${submission.package_name}</p>
                                <p><strong>‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤:</strong> ${submission.duration_months} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</p>
                                <p><strong>‡∏£‡∏≤‡∏Ñ‡∏≤:</strong> ‡∏ø${submission.total_price.toLocaleString()}</p>
                                <p><strong>‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡πà‡∏á:</strong> ${this.formatDateTime(submission.submission_time)}</p>
                            </div>
                        `,
                        icon: 'info'
                    })
                }
            }
        }).mount('#app')
    </script>
</body>

</html>