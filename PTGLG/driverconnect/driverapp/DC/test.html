<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>DC Log ‚Äì ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà DC & ‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤ & ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Booking</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    :root {
      --bg: #f3f4f6;
      --bg-card: #ffffff;
      --border-subtle: #d1d5db;
      --accent: #2563eb;
      --accent-soft: rgba(37, 99, 235, 0.08);
      --accent-strong: #1d4ed8;
      --text-main: #111827;
      --text-muted: #6b7280;
      --danger: #b91c1c;
      --radius-lg: 18px;
      --shadow-soft: 0 10px 25px rgba(15, 23, 42, 0.12);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      justify-content: center;
    }

    .app {
      width: 100%;
      max-width: 520px;
      padding: 16px 12px 24px;
    }

    .card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: 18px 16px 20px;
      box-shadow: var(--shadow-soft);
      border: 1px solid var(--border-subtle);
    }

    .card-header-main { margin-bottom: 12px; }

    h1 {
      font-size: 20px;
      margin: 4px 0 4px;
    }

    .badge {
      display: inline-block;
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent-strong);
      border: 1px solid rgba(37, 99, 235, 0.4);
      margin-bottom: 4px;
    }

    .subtitle {
      font-size: 13px;
      color: var(--text-muted);
      margin: 0;
      line-height: 1.4;
    }

    /* Tabs */
    .tabs {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px;
      border-radius: 999px;
      background: #e5e7eb;
      border: 1px solid #d1d5db;
      margin: 14px 0 12px;
      overflow-x: auto;
    }

    .tab-btn {
      flex: 1 1 0;
      border-radius: 999px;
      padding: 8px 10px;
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: background 0.12s ease, color 0.12s ease, box-shadow 0.12s ease, transform 0.12s ease;
      white-space: nowrap;
    }

    .tab-btn span.icon {
      font-size: 16px;
    }

    .tab-btn.active {
      background: #ffffff;
      color: var(--accent-strong);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.4);
      transform: translateY(-1px);
    }

    .panel { margin-top: 4px; }
    .hidden { display: none !important; }

    .section-title {
      font-size: 15px;
      font-weight: 600;
      margin: 18px 0 6px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: var(--text-main);
      gap: 8px;
      flex-wrap: wrap;
    }

    .section-title span.hint {
      font-size: 12px;
      font-weight: 400;
      color: var(--text-muted);
    }

    .grid-2 {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }

    @media (min-width: 480px) {
      .grid-2.inline-desktop {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    label {
      display: block;
      font-size: 14px;
      margin-bottom: 4px;
      color: var(--text-main);
    }

    .field { margin-bottom: 12px; }

    .field-inline {
      display: flex;
      gap: 8px;
      align-items: stretch;
    }

    input[type="text"],
    input[type="date"],
    input[type="file"],
    input[type="time"],
    textarea,
    select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border-subtle);
      background: #f9fafb;
      color: var(--text-main);
      font-size: 14px;
      outline: none;
      transition: border 0.15s, box-shadow 0.15s, background 0.15s;
    }

    input:focus,
    textarea:focus,
    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.25);
      background: #ffffff;
    }

    textarea {
      min-height: 70px;
      resize: vertical;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 10px 16px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.12s ease, opacity 0.12s ease;
      white-space: nowrap;
    }

    .btn-xs {
      padding: 8px 12px;
      font-size: 13px;
    }

    .btn-accent,
    .btn-primary {
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      color: #ffffff;
      box-shadow: 0 8px 20px rgba(37, 99, 235, 0.35);
    }

    .btn-ghost {
      background: #e5e7eb;
      color: var(--text-main);
      border: 1px solid #d1d5db;
    }

    .btn:active {
      transform: translateY(1px) scale(0.99);
      box-shadow: none;
    }

    .btn-full {
      width: 100%;
      justify-content: center;
      margin-top: 14px;
    }

    .note {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 6px;
      line-height: 1.4;
    }

    .note strong { color: #b45309; }

    .image-preview {
      margin-top: 8px;
      border-radius: 12px;
      border: 1px dashed #cbd5f5;
      padding: 8px;
      display: none;
      background: #eff6ff;
    }

    .image-preview img {
      max-width: 100%;
      border-radius: 10px;
      display: block;
    }

    .image-preview span {
      font-size: 12px;
      color: var(--text-muted);
      display: block;
      margin-bottom: 4px;
    }

    .footer-hint {
      margin-top: 10px;
      font-size: 12px;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    .required { color: var(--danger); margin-left: 2px; }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 999px;
      background: #fef3c7;
      color: #92400e;
      border: 1px solid #facc15;
    }

    #timeError {
      font-size: 12px;
      color: var(--danger);
      margin-top: 4px;
      padding: 6px 8px;
      border-radius: 8px;
      background: #fee2e2;
      border: 1px solid #fecaca;
      display: none;
    }

    .input-error {
      border-color: var(--danger) !important;
      box-shadow: 0 0 0 2px rgba(185, 28, 28, 0.25) !important;
      background: #fef2f2 !important;
    }

    .problem-preview-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .problem-preview-list img {
      width: 70px;
      height: 70px;
      object-fit: cover;
      border-radius: 8px;
      border: 1px solid #d1d5db;
    }

    /* Booking result */
    .booking-result-box {
      margin-top: 12px;
      padding: 12px;
      border-radius: 12px;
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      font-size: 13px;
    }

    .booking-result-title {
      font-weight: 700;
      margin-bottom: 6px;
      color: #1d4ed8;
    }

    .booking-result-meta {
      font-size: 12px;
      color: #4b5563;
      margin-bottom: 8px;
    }

    .booking-table-wrapper {
      margin-top: 6px;
      border-radius: 10px;
      border: 1px solid #c4d3f6;
      overflow-x: auto;
      background: #ffffff;
    }

    .booking-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      min-width: 480px;
    }

    .booking-table th,
    .booking-table td {
      padding: 6px 8px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      white-space: nowrap;
    }

    .booking-table th {
      background: #eff6ff;
      font-weight: 600;
      color: #1f2937;
    }

    .booking-table tr:nth-child(even) td {
      background: #f9fafb;
    }

    .booking-table tr:nth-child(odd) td {
      background: #ffffff;
    }

    .booking-empty {
      font-size: 13px;
      color: #6b7280;
      margin-top: 6px;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <div class="card-header-main">
        <span class="badge">DC Log</span>
        <h1>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà DC ¬∑ ‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ¬∑ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Booking</h1>
        <p class="subtitle">
          ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà DC ‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏ó‡πâ‡∏≤‡∏¢‡∏£‡∏ñ ‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Ç‡∏ô‡∏™‡πà‡∏á ‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Booking ‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
        </p>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <button class="tab-btn active" data-tab="form">
          <span class="icon">üìù</span>
          <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å DC ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</span>
        </button>
        <button class="tab-btn" data-tab="problem">
          <span class="icon">‚ö†Ô∏è</span>
          <span>‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Ç‡∏ô‡∏™‡πà‡∏á</span>
        </button>
        <button class="tab-btn" data-tab="booking">
          <span class="icon">üîé</span>
          <span>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Booking</span>
        </button>
      </div>

      <!-- Panel: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å DC -->
      <div class="panel" data-panel="form">
        <form id="dcForm">
          <div class="grid-2">
            <div class="field">
              <label for="reference">
                ‡πÄ‡∏•‡∏Ç Booking (9 ‡∏´‡∏•‡∏±‡∏Å‡∏ó‡πâ‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢ -)<span class="required">*</span>
              </label>
              <input
                type="text"
                id="reference"
                name="reference"
                placeholder="‡πÄ‡∏ä‡πà‡∏ô 251243448 (‡∏à‡∏≤‡∏Å B001-251243448)"
                inputmode="numeric"
                maxlength="9"
                required
                oninput="enforceBookingDigits(this)"
              />
              <div class="note">
                ‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏•‡∏Ç 9 ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ <strong>‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å B001-</strong>
              </div>
            </div>

            <div class="field">
              <label for="truckPlate">
                ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ<span class="required">*</span>
              </label>
              <input
                type="text"
                id="truckPlate"
                name="truckPlate"
                placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏ó-1234 / 70-xxxx"
                required
              />
            </div>
          </div>

          <div class="section-title">
            <span>‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà DC</span>
            <span class="hint">
              ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î ‚Äú‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‚Äù ‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö
            </span>
          </div>

          <div id="timeError"></div>

          <div class="field">
            <label for="arriveDcTime">‡∏ñ‡∏∂‡∏á DC <span class="required">*</span></label>
            <div class="field-inline">
              <input
                type="time"
                id="arriveDcTime"
                name="arriveDcTime"
                required
              />
              <button type="button" class="btn btn-xs btn-ghost" onclick="setNow('arriveDcTime')">
                ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
              </button>
            </div>
          </div>

          <div class="grid-2 inline-desktop">
            <div class="field">
              <label for="loadStartTime">‡∏Ç‡∏∂‡πâ‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÄ‡∏£‡∏¥‡πà‡∏°)</label>
              <div class="field-inline">
                <input type="time" id="loadStartTime" name="loadStartTime" />
                <button type="button" class="btn btn-xs btn-ghost" onclick="setNow('loadStartTime')">
                  ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
                </button>
              </div>
            </div>
            <div class="field">
              <label for="loadEndTime">‡∏Ç‡∏∂‡πâ‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÄ‡∏™‡∏£‡πá‡∏à)</label>
              <div class="field-inline">
                <input type="time" id="loadEndTime" name="loadEndTime" />
                <button type="button" class="btn btn-xs btn-ghost" onclick="setNow('loadEndTime')">
                  ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
                </button>
              </div>
            </div>
          </div>

          <div class="grid-2 inline-desktop">
            <div class="field">
              <label for="docStartTime">‡∏¢‡∏∑‡πà‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (‡πÄ‡∏£‡∏¥‡πà‡∏°)</label>
              <div class="field-inline">
                <input type="time" id="docStartTime" name="docStartTime" />
                <button type="button" class="btn btn-xs btn-ghost" onclick="setNow('docStartTime')">
                  ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
                </button>
              </div>
            </div>
            <div class="field">
              <label for="docEndTime">‡∏¢‡∏∑‡πà‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (‡πÄ‡∏™‡∏£‡πá‡∏à)</label>
              <div class="field-inline">
                <input type="time" id="docEndTime" name="docEndTime" />
                <button type="button" class="btn btn-xs btn-ghost" onclick="setNow('docEndTime')">
                  ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
                </button>
              </div>
            </div>
          </div>

          <div class="field">
            <label for="departTime">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å DC</label>
            <div class="field-inline">
              <input type="time" id="departTime" name="departTime" />
              <button type="button" class="btn btn-xs btn-ghost" onclick="setNow('departTime')">
                ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
              </button>
            </div>
          </div>

          <div class="field">
            <label for="remark">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
            <textarea
              id="remark"
              name="remark"
              placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏≠‡∏Ñ‡∏¥‡∏ß‡πÇ‡∏´‡∏•‡∏î‡∏ô‡∏≤‡∏ô / ‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô ‡∏Ø‡∏•‡∏Ø"
            ></textarea>
          </div>

          <div class="section-title">
            <span>‡∏£‡∏π‡∏õ‡∏ó‡πâ‡∏≤‡∏¢‡∏£‡∏ñ‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏¥‡∏î‡∏ï‡∏π‡πâ</span>
            <span class="tag">‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÅ‡∏ô‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span>
          </div>

          <div class="field">
            <label for="photoRear">
              ‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏ó‡πâ‡∏≤‡∏¢‡∏£‡∏ñ <span class="required">*</span>
            </label>
            <input
              type="file"
              id="photoRear"
              name="photoRear"
              accept="image/*"
              capture="environment"
              required
            />
            <div class="note">
              ‚Ä¢ ‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏ó‡∏±‡πâ‡∏á <strong>‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡∏´‡∏•‡∏±‡∏á + ‡∏ã‡∏µ‡∏•/‡∏Å‡∏∏‡∏ç‡πÅ‡∏à</strong><br />
              ‚Ä¢ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            </div>

            <div id="previewBox" class="image-preview">
              <span>‡∏£‡∏π‡∏õ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:</span>
              <img id="previewImage" alt="‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏ó‡πâ‡∏≤‡∏¢‡∏£‡∏ñ" />
            </div>
          </div>

          <button type="submit" class="btn btn-accent btn-full">
            ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô DC
          </button>

          <div class="footer-hint">
            <div>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö <code>HH:mm ‡∏ô.</code></div>
            <div>‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤ 5‚Äì10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</div>
          </div>
        </form>
      </div>

      <!-- Panel: ‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Ç‡∏ô‡∏™‡πà‡∏á -->
      <div class="panel hidden" data-panel="problem">
        <form id="problemForm">
          <div class="field">
            <label for="problemReference">‡πÄ‡∏•‡∏Ç Booking (9 ‡∏´‡∏•‡∏±‡∏Å‡∏ó‡πâ‡∏≤‡∏¢)<span class="required">*</span></label>
            <input
              type="text"
              id="problemReference"
              placeholder="‡πÄ‡∏ä‡πà‡∏ô 251243448"
              inputmode="numeric"
              maxlength="9"
              required
              oninput="enforceBookingDigits(this)"
            />
          </div>

          <div class="field">
            <label for="problemTruckPlate">‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ<span class="required">*</span></label>
            <input
              type="text"
              id="problemTruckPlate"
              placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏ó-1234 / 70-xxxx"
              required
            />
          </div>

          <div class="field">
            <label for="problemType">
              ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤<span class="required">*</span>
            </label>
            <select id="problemType" required>
              <option value="">-- ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤ --</option>
            </select>
            <div class="note">
              ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ó <strong>problem list (B2:B)</strong> ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ó‡πá‡∏ö‡∏ô‡∏µ‡πâ
            </div>
          </div>

          <div class="field">
            <label for="problemDetail">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤<span class="required">*</span></label>
            <textarea
              id="problemDetail"
              placeholder="‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå / ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤ / ‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô ‡∏Ø‡∏•‡∏Ø"
              required
            ></textarea>
          </div>

          <div class="section-title">
            <span>‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö</span>
            <span class="hint">‡πÅ‡∏ô‡∏ö‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏π‡∏õ ‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô / ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ / ‡∏™‡∏†‡∏≤‡∏û‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
          </div>

          <div class="field">
            <label for="problemPhotos">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</label>
            <input
              type="file"
              id="problemPhotos"
              accept="image/*"
              multiple
            />
            <div class="note">
              ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏¢‡πà‡∏≠‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
            </div>
            <div id="problemPreview" class="problem-preview-list"></div>
          </div>

          <button type="submit" class="btn btn-primary btn-full">
            ‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Ç‡∏ô‡∏™‡πà‡∏á
          </button>
        </form>
      </div>

      <!-- Panel: ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Booking -->
      <div class="panel hidden" data-panel="booking">
        <div class="field">
          <label for="searchBooking">
            ‡πÄ‡∏•‡∏Ç Booking (9 ‡∏´‡∏•‡∏±‡∏Å‡∏ó‡πâ‡∏≤‡∏¢)<span class="required">*</span>
          </label>
          <input
            type="text"
            id="searchBooking"
            placeholder="‡πÄ‡∏ä‡πà‡∏ô 251243448"
            inputmode="numeric"
            maxlength="9"
            oninput="enforceBookingDigits(this)"
          />
          <div class="note">
            ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏Ç 9 ‡∏´‡∏•‡∏±‡∏Å‡∏ó‡πâ‡∏≤‡∏¢‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ DC Log
          </div>
        </div>
        <button id="btnSearchBooking" class="btn btn-primary btn-full">
          ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Booking
        </button>

        <div id="bookingResult" class="booking-result-box" style="display:none;"></div>
      </div>
    </div>
  </div>

  <script>
    // üëá ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô URL Web App ‡∏Ç‡∏≠‡∏á Apps Script
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxQDbS5JZyzkbYxfdDLz8q2XCvBbRqQ9fE36Mn_dgvdabzzDcl4R5oV0tliQo_rLfv8RA/exec";

    /* -------- Tabs -------- */
    const tabButtons = document.querySelectorAll(".tab-btn");
    const panels = document.querySelectorAll(".panel");

    tabButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const tab = btn.getAttribute("data-tab");
        tabButtons.forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");

        panels.forEach((p) => {
          if (p.getAttribute("data-panel") === tab) {
            p.classList.remove("hidden");
          } else {
            p.classList.add("hidden");
          }
        });

        if (tab === "problem") {
          loadProblemTopics();
          const refDC = document.getElementById("reference").value.trim();
          const plateDC = document.getElementById("truckPlate").value.trim();
          if (refDC) document.getElementById("problemReference").value = refDC.replace(/\D/g, "").slice(0, 9);
          if (plateDC) document.getElementById("problemTruckPlate").value = plateDC;
        }

        if (tab === "booking") {
          const refDC = document.getElementById("reference").value.trim();
          if (refDC) document.getElementById("searchBooking").value = refDC.replace(/\D/g, "").slice(0, 9);
        }
      });
    });

    /* -------- Booking enforce digits -------- */
    function enforceBookingDigits(el) {
      el.value = el.value.replace(/\D/g, "").slice(0, 9);
    }
    window.enforceBookingDigits = enforceBookingDigits;

    /* -------- Time helpers & validation -------- */
    function setNow(fieldId) {
      const el = document.getElementById(fieldId);
      if (!el) return;
      const now = new Date();
      const hh = String(now.getHours()).padStart(2, "0");
      const mm = String(now.getMinutes()).padStart(2, "0");
      el.value = `${hh}:${mm}`;
      validateTimeSteps(false);
    }
    window.setNow = setNow;

    const timeInputsConfig = [
      { id: "arriveDcTime", label: "‡∏ñ‡∏∂‡∏á DC" },
      { id: "loadStartTime", label: "‡∏Ç‡∏∂‡πâ‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÄ‡∏£‡∏¥‡πà‡∏°)" },
      { id: "loadEndTime", label: "‡∏Ç‡∏∂‡πâ‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÄ‡∏™‡∏£‡πá‡∏à)" },
      { id: "docStartTime", label: "‡∏¢‡∏∑‡πà‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (‡πÄ‡∏£‡∏¥‡πà‡∏°)" },
      { id: "docEndTime", label: "‡∏¢‡∏∑‡πà‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (‡πÄ‡∏™‡∏£‡πá‡∏à)" },
      { id: "departTime", label: "‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å DC" },
    ];

    function timeToMinutes(t) {
      if (!t) return null;
      const [h, m] = t.split(":").map(Number);
      return h * 60 + m;
    }

    function isValidCrossDay(prevMin, nextMin) {
      return (prevMin >= 23 * 60 && prevMin <= 23 * 60 + 59) &&
             (nextMin >= 0 && nextMin <= 5 * 60);
    }

    function clearTimeErrors() {
      const errorBox = document.getElementById("timeError");
      errorBox.style.display = "none";
      errorBox.textContent = "";
      timeInputsConfig.forEach(({ id }) => {
        const el = document.getElementById(id);
        if (el) el.classList.remove("input-error");
      });
    }

    function showTimeError(message, errorInputId, showAlert) {
      const errorBox = document.getElementById("timeError");
      errorBox.textContent = message;
      errorBox.style.display = "block";

      if (errorInputId) {
        const el = document.getElementById(errorInputId);
        if (el) el.classList.add("input-error");
      }

      if (showAlert) {
        Swal.fire({
          icon: "warning",
          title: "‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á",
          text: message,
        });
      }
    }

    function validateTimeSteps(showAlert = true) {
      clearTimeErrors();

      const steps = timeInputsConfig.map(({ id, label }) => {
        const el = document.getElementById(id);
        const val = el ? el.value.trim() : "";
        return { id, label, minutes: timeToMinutes(val), hasValue: !!val };
      });

      for (let i = 0; i < steps.length - 1; i++) {
        const prev = steps[i];
        const next = steps[i + 1];

        if (!prev.hasValue && next.hasValue) {
          showTimeError(
            `‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤ "${prev.label}" ‡∏Å‡πà‡∏≠‡∏ô "${next.label}"`,
            next.id,
            showAlert
          );
          return false;
        }

        if (!prev.hasValue || !next.hasValue) continue;

        const prevMin = prev.minutes;
        const nextMin = next.minutes;

        if (isValidCrossDay(prevMin, nextMin)) continue;

        if (nextMin < prevMin) {
          showTimeError(
            `"${next.label}" ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ "${prev.label}"`,
            next.id,
            showAlert
          );
          return false;
        }
      }

      return true;
    }

    timeInputsConfig.forEach(({ id }) => {
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener("change", () => validateTimeSteps(false));
      el.addEventListener("blur", () => validateTimeSteps(false));
    });

    /* -------- Preview ‡∏£‡∏π‡∏õ DC -------- */
    const photoInput = document.getElementById("photoRear");
    const previewBox = document.getElementById("previewBox");
    const previewImage = document.getElementById("previewImage");

    photoInput.addEventListener("change", function () {
      const file = this.files && this.files[0];
      if (!file) {
        previewBox.style.display = "none";
        previewImage.src = "";
        return;
      }
      const reader = new FileReader();
      reader.onload = function (e) {
        previewImage.src = e.target.result;
        previewBox.style.display = "block";
      };
      reader.readAsDataURL(file);
    });

    /* -------- Resize ‡∏£‡∏π‡∏õ -------- */
    function resizeImage(file, maxSize = 1280) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        const reader = new FileReader();
        reader.onload = (e) => {
          img.onload = () => {
            let { width, height } = img;
            if (width <= maxSize && height <= maxSize) {
              return resolve(e.target.result);
            }
            const canvas = document.createElement("canvas");
            if (width > height) {
              canvas.width = maxSize;
              canvas.height = (height * maxSize) / width;
            } else {
              canvas.height = maxSize;
              canvas.width = (width * maxSize) / height;
            }
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            const dataUrl = canvas.toDataURL("image/jpeg", 0.7);
            resolve(dataUrl);
          };
          img.onerror = reject;
          img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    function formatTimeForPayload(value) {
      if (!value) return "";
      return `${value} ‡∏ô.`;
    }

    /* -------- Submit: DC Form -------- */
    const dcForm = document.getElementById("dcForm");
    dcForm.addEventListener("submit", async function (e) {
      e.preventDefault();

      const referenceRaw = document.getElementById("reference").value.trim();
      const numericRef   = referenceRaw.replace(/\D/g, "");
      const truckPlate   = document.getElementById("truckPlate").value.trim();

      const arriveRaw    = document.getElementById("arriveDcTime").value.trim();
      const loadStartRaw = document.getElementById("loadStartTime").value.trim();
      const loadEndRaw   = document.getElementById("loadEndTime").value.trim();
      const docStartRaw  = document.getElementById("docStartTime").value.trim();
      const docEndRaw    = document.getElementById("docEndTime").value.trim();
      const departRaw    = document.getElementById("departTime").value.trim();

      const remark       = document.getElementById("remark").value.trim();
      const file         = photoInput.files && photoInput.files[0];

      if (!numericRef || numericRef.length !== 9) {
        Swal.fire(
          "‡πÄ‡∏•‡∏Ç Booking ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á",
          "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç Booking ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 9 ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢ - ‡πÄ‡∏ä‡πà‡∏ô 251243448",
          "warning"
        );
        return;
      }

      if (!truckPlate) {
        Swal.fire("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ", "", "warning");
        return;
      }
      if (!arriveRaw) {
        Swal.fire('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤ "‡∏ñ‡∏∂‡∏á DC"', "", "warning");
        return;
      }
      if (!file) {
        Swal.fire("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏ó‡πâ‡∏≤‡∏¢‡∏£‡∏ñ‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏¥‡∏î‡∏ï‡∏π‡πâ", "", "warning");
        return;
      }

      if (!validateTimeSteps(true)) {
        return;
      }

      try {
        Swal.fire({
          title: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...",
          html: "‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤ 5‚Äì10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ",
          allowOutsideClick: false,
          didOpen: () => Swal.showLoading(),
        });

        let imageBase64;
        try {
          imageBase64 = await resizeImage(file);
        } catch (err) {
          console.warn("Resize ‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°", err);
          imageBase64 = await new Promise((resolve, reject) => {
            const r = new FileReader();
            r.onload = (e) => resolve(e.target.result);
            r.onerror = reject;
            r.readAsDataURL(file);
          });
        }

        const payload = {
          action: "saveDcLog",
          reference: numericRef,
          truckPlate: truckPlate,
          arriveDcTime: formatTimeForPayload(arriveRaw),
          loadStartTime: formatTimeForPayload(loadStartRaw),
          loadEndTime: formatTimeForPayload(loadEndRaw),
          docStartTime: formatTimeForPayload(docStartRaw),
          docEndTime: formatTimeForPayload(docEndRaw),
          departTime: formatTimeForPayload(departRaw),
          remark: remark,
          imageBase64: imageBase64,
        };

        const res = await fetch(SCRIPT_URL, {
          method: "POST",
          headers: {
            "Content-Type": "text/plain;charset=utf-8",
          },
          body: JSON.stringify(payload),
        });

        const result = await res.json().catch(() => ({}));
        Swal.close();

        if (result && result.success) {
          Swal.fire({
            icon: "success",
            title: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à",
            text: result.message || "‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô DC ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß",
          });

          dcForm.reset();
          previewBox.style.display = "none";
          previewImage.src = "";
          clearTimeErrors();
        } else {
          Swal.fire({
            icon: "error",
            title: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à",
            text:
              (result && result.message) ||
              "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö",
          });
        }
      } catch (err) {
        console.error(err);
        Swal.close();
        Swal.fire({
          icon: "error",
          title: "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î",
          text: "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô",
        });
      }
    });

    /* -------- Problem tab: load topics -------- */
    const problemTypeSelect = document.getElementById("problemType");
    let isLoadingTopics = false;

    async function loadProblemTopics() {
      if (isLoadingTopics) return;
      isLoadingTopics = true;
      try {
        problemTypeSelect.innerHTML = '<option value="">-- ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤ --</option>';

        const params = new URLSearchParams();
        params.set("action", "getProblemList");

        const res = await fetch(`${SCRIPT_URL}?${params.toString()}`, { method: "GET" });
        const result = await res.json().catch(() => ({}));

        if (!result || !result.success) {
          problemTypeSelect.innerHTML = '<option value="">‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</option>';
          return;
        }

        const topics = Array.isArray(result.data) ? result.data : [];
        if (!topics.length) {
          problemTypeSelect.innerHTML = '<option value="">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏ô problem list</option>';
          return;
        }

        problemTypeSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤ --</option>';
        topics.forEach((t) => {
          const opt = document.createElement("option");
          opt.value = t;
          opt.textContent = t;
          problemTypeSelect.appendChild(opt);
        });
      } catch (err) {
        console.error(err);
        problemTypeSelect.innerHTML = '<option value="">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</option>';
      } finally {
        isLoadingTopics = false;
      }
    }

    /* -------- Problem: preview multi images -------- */
    const problemPhotosInput = document.getElementById("problemPhotos");
    const problemPreview = document.getElementById("problemPreview");

    problemPhotosInput.addEventListener("change", () => {
      problemPreview.innerHTML = "";
      const files = Array.from(problemPhotosInput.files || []);
      if (!files.length) return;
      files.forEach((file) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = document.createElement("img");
          img.src = e.target.result;
          problemPreview.appendChild(img);
        };
        reader.readAsDataURL(file);
      });
    });

    /* -------- Submit: Problem Form -------- */
    const problemForm = document.getElementById("problemForm");
    problemForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const refRaw       = document.getElementById("problemReference").value.trim();
      const numericRef   = refRaw.replace(/\D/g, "");
      const truckPlate   = document.getElementById("problemTruckPlate").value.trim();
      const problemType  = problemTypeSelect.value.trim();
      const detail       = document.getElementById("problemDetail").value.trim();
      const files        = Array.from(problemPhotosInput.files || []);

      if (!numericRef || numericRef.length !== 9) {
        Swal.fire(
          "‡πÄ‡∏•‡∏Ç Booking ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á",
          "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç Booking ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 9 ‡∏´‡∏•‡∏±‡∏Å ‡πÄ‡∏ä‡πà‡∏ô 251243448",
          "warning"
        );
        return;
      }
      if (!truckPlate) {
        Swal.fire("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ", "", "warning");
        return;
      }
      if (!problemType) {
        Swal.fire("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤", "", "warning");
        return;
      }
      if (!detail) {
        Swal.fire("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤", "", "warning");
        return;
      }

      try {
        Swal.fire({
          title: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤...",
          html: "‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•",
          allowOutsideClick: false,
          didOpen: () => Swal.showLoading(),
        });

        let imagesBase64 = [];
        if (files.length) {
          imagesBase64 = await Promise.all(files.map((f) => resizeImage(f).catch(() => null)));
          imagesBase64 = imagesBase64.filter((v) => !!v);
        }

        const payload = {
          action: "saveProblem",
          reference: numericRef,
          truckPlate: truckPlate,
          problemType: problemType,
          detail: detail,
          imagesBase64: imagesBase64,
        };

        const res = await fetch(SCRIPT_URL, {
          method: "POST",
          headers: {
            "Content-Type": "text/plain;charset=utf-8",
          },
          body: JSON.stringify(payload),
        });

        const result = await res.json().catch(() => ({}));
        Swal.close();

        if (result && result.success) {
          Swal.fire({
            icon: "success",
            title: "‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à",
            text: result.message || "‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Ç‡∏ô‡∏™‡πà‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß",
          });
          problemForm.reset();
          problemPreview.innerHTML = "";
        } else {
          Swal.fire({
            icon: "error",
            title: "‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à",
            text:
              (result && result.message) ||
              "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö",
          });
        }
      } catch (err) {
        console.error(err);
        Swal.close();
        Swal.fire({
          icon: "error",
          title: "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î",
          text: "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô",
        });
      }
    });

    /* -------- Booking Status: fetch (MULTI WAVE) -------- */
    const searchBookingInput = document.getElementById("searchBooking");
    const btnSearchBooking = document.getElementById("btnSearchBooking");
    const bookingResultBox = document.getElementById("bookingResult");

    btnSearchBooking.addEventListener("click", fetchBookingStatus);

    async function fetchBookingStatus() {
      const raw = searchBookingInput.value.trim();
      const numericRef = raw.replace(/\D/g, "");
      if (!numericRef || numericRef.length !== 9) {
        Swal.fire(
          "‡πÄ‡∏•‡∏Ç Booking ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á",
          "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç Booking ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 9 ‡∏´‡∏•‡∏±‡∏Å ‡πÄ‡∏ä‡πà‡∏ô 251243448",
          "warning"
        );
        return;
      }

      try {
        Swal.fire({
          title: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Booking...",
          html: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Wave",
          allowOutsideClick: false,
          didOpen: () => Swal.showLoading(),
        });

        const params = new URLSearchParams();
        params.set("action", "getBookingStatus");
        params.set("booking", numericRef);

        const res = await fetch(`${SCRIPT_URL}?${params.toString()}`, {
          method: "GET",
        });

        const result = await res.json().catch(() => ({}));
        Swal.close();

        if (!result || !result.success) {
          bookingResultBox.style.display = "block";
          bookingResultBox.innerHTML = `
            <div class="booking-result-title">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</div>
            <div>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</div>
          `;
          return;
        }

        if (!result.found) {
          bookingResultBox.style.display = "block";
          bookingResultBox.innerHTML = `
            <div class="booking-result-title">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Booking ‡∏ô‡∏µ‡πâ</div>
            <div>${result.message || ''}</div>
          `;
          return;
        }

        const d = result.data || {};
        const waves = Array.isArray(d.waves) ? d.waves : [];

        if (!waves.length) {
          bookingResultBox.style.display = "block";
          bookingResultBox.innerHTML = `
            <div class="booking-result-title">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Booking: ${d.booking || numericRef}</div>
            <div class="booking-empty">‡πÑ‡∏°‡πà‡∏û‡∏ö Wave Number ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Booking ‡∏ô‡∏µ‡πâ</div>
          `;
          return;
        }

        const rowsHtml = waves.map(w => `
          <tr>
            <td>${w.waveNumber || '-'}</td>
            <td>${w.loadingStatus || '-'}</td>
            <td>${w.waveStatus || '-'}</td>
            <td>${w.pickUpDate || '-'}</td>
            <td>${w.pickUpTime || '-'}</td>
            <td>${w.logistics || '-'}</td>
            <td>${w.dock || '-'}</td>
          </tr>
        `).join("");

        bookingResultBox.style.display = "block";
        bookingResultBox.innerHTML = `
          <div class="booking-result-title">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Booking: ${d.booking || numericRef}</div>
          <div class="booking-result-meta">
            ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà Wave: ${d.pickDate || '-'} ¬∑ ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á: ${d.owner || '-'}<br/>
            ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î Wave: ${d.waveDescription || '-'} ¬∑ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏´‡∏•‡∏±‡∏Å: ${d.status || '-'}
          </div>
          <div class="booking-table-wrapper">
            <table class="booking-table">
              <thead>
                <tr>
                  <th>Wave Number</th>
                  <th>Loading Status</th>
                  <th>Wave Status</th>
                  <th>Pick-up date</th>
                  <th>Pick-up time</th>
                  <th>Logistics</th>
                  <th>Dock</th>
                </tr>
              </thead>
              <tbody>
                ${rowsHtml}
              </tbody>
            </table>
          </div>
        `;
      } catch (err) {
        console.error(err);
        Swal.close();
        bookingResultBox.style.display = "block";
        bookingResultBox.innerHTML = `
          <div class="booking-result-title">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</div>
          <div>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
        `;
      }
    }
  </script>
</body>
</html>
