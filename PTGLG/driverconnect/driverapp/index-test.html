<!DOCTYPE html>
<html lang="th">

<head>
  <base target="_top" />
  <meta charset="UTF-8" />
  <title>Driver Tracking</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    :root {
      --primary: #1abc9c;
      --primary-dark: #16a085;
      --bg: #f4f8f7;
      --text-main: #222;
      --text-sub: #666;
      --card-bg: #ffffff;
      --border-radius: 14px;
      --input-bg: #f7faf9;
      --input-border: #dce2e0;
      --shadow-color: rgba(0, 0, 0, 0.06);
      --timeline-border: #e4ece9;
      --timeline-bg: #f7faf9;
    }

    /* Dark Mode */
    [data-theme="dark"] {
      --bg: #1a1a2e;
      --text-main: #eaeaea;
      --text-sub: #a0a0a0;
      --card-bg: #16213e;
      --input-bg: #1a1a2e;
      --input-border: #2a2a4a;
      --shadow-color: rgba(0, 0, 0, 0.3);
      --timeline-border: #2a2a4a;
      --timeline-bg: #1a1a2e;
    }

    [data-theme="dark"] .badge {
      background: rgba(26, 188, 156, 0.2);
    }

    [data-theme="dark"] .summary-card {
      background: var(--timeline-bg);
      border-color: var(--timeline-border);
    }

    [data-theme="dark"] .timeline-content {
      background: var(--card-bg);
      border-color: var(--timeline-border);
    }

    [data-theme="dark"] .gps-status.checking {
      background: rgba(52, 152, 219, 0.15);
    }

    [data-theme="dark"] .gps-status.good {
      background: rgba(26, 188, 156, 0.15);
    }

    [data-theme="dark"] .gps-status.weak {
      background: rgba(243, 156, 18, 0.15);
    }

    [data-theme="dark"] .gps-status.error {
      background: rgba(231, 76, 60, 0.15);
    }

    [data-theme="dark"] .last-updated {
      background: rgba(26, 188, 156, 0.12);
    }

    [data-theme="dark"] .ptr-indicator {
      background: var(--card-bg);
    }

    [data-theme="dark"] .inline-flex {
      background: var(--card-bg);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI',
        sans-serif;
      background: var(--bg);
      color: var(--text-main);
    }

    .app-shell {
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 12px;
    }

    .container {
      width: 100%;
      max-width: 520px;
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 16px 18px 20px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.06);
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .title {
      font-size: 1.2rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .badge {
      font-size: 0.75rem;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(26, 188, 156, 0.1);
      color: var(--primary-dark);
    }

    .status-text {
      font-size: 0.9rem;
      color: var(--text-sub);
      margin-bottom: 10px;
    }

    .field-group {
      margin-bottom: 10px;
    }

    label {
      display: block;
      font-size: 0.8rem;
      color: var(--text-sub);
      margin-bottom: 4px;
    }

    input[type='text'],
    input[type='number'] {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--input-border);
      font-size: 0.95rem;
      outline: none;
      transition: border 0.2s, box-shadow 0.2s, background 0.2s;
      background: var(--input-bg);
      color: var(--text-main);
    }

    input[type='text']:focus,
    input[type='number']:focus {
      border-color: var(--primary);
      background: var(--card-bg);
      box-shadow: 0 0 0 2px rgba(26, 188, 156, 0.18);
    }

    /* Theme Toggle Button */
    .theme-toggle {
      background: none;
      border: none;
      width: 36px;
      height: 36px;
      padding: 0;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      transition: background 0.2s, transform 0.2s;
    }

    .theme-toggle:hover {
      background: rgba(26, 188, 156, 0.1);
      transform: scale(1.1);
    }

    .theme-toggle:active {
      transform: scale(0.95);
    }

    /* Offline Mode Indicator */
    .offline-bar {
      display: none;
      background: linear-gradient(135deg, #e74c3c, #c0392b);
      color: white;
      padding: 8px 16px;
      text-align: center;
      font-size: 0.85rem;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 2px 8px rgba(231, 76, 60, 0.3);
    }

    .offline-bar.show {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .offline-bar .offline-icon {
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .queue-badge {
      background: rgba(255, 255, 255, 0.25);
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      margin-left: 4px;
    }

    .syncing-bar {
      display: none;
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: white;
      padding: 8px 16px;
      text-align: center;
      font-size: 0.85rem;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .syncing-bar.show {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .syncing-bar .spin {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    [data-theme="dark"] .offline-bar {
      background: linear-gradient(135deg, #c0392b, #962d22);
    }

    [data-theme="dark"] .syncing-bar {
      background: linear-gradient(135deg, #2980b9, #1f6391);
    }

    /* Quick Actions Floating Bar */
    .quick-actions {
      display: none;
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--card-bg);
      border-radius: 16px;
      padding: 12px 16px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 0, 0, 0.05);
      z-index: 900;
      max-width: calc(100% - 32px);
      width: auto;
      min-width: 280px;
    }

    .quick-actions.show {
      display: block;
      animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }

    .quick-actions-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--timeline-border);
    }

    .quick-actions-title {
      font-size: 0.8rem;
      color: var(--text-sub);
      font-weight: 600;
    }

    .quick-actions-stop {
      font-size: 0.85rem;
      color: var(--text-main);
      font-weight: 700;
      max-width: 180px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .quick-actions-buttons {
      display: flex;
      gap: 10px;
    }

    .quick-actions-buttons button {
      flex: 1;
      padding: 10px 16px;
      font-size: 0.9rem;
      border-radius: 10px;
      min-width: 0;
    }

    .quick-actions-buttons .btn-checkin {
      background: linear-gradient(135deg, #27ae60, #219a52);
    }

    .quick-actions-buttons .btn-checkout {
      background: linear-gradient(135deg, #e67e22, #d35400);
    }

    .quick-actions-close {
      position: absolute;
      top: -8px;
      right: -8px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--text-sub);
      color: white;
      border: none;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      line-height: 1;
    }

    .quick-actions-close:hover {
      background: #e74c3c;
    }

    [data-theme="dark"] .quick-actions {
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.1);
    }

    /* Notification Settings Button */
    .notification-btn {
      background: none;
      border: none;
      width: 36px;
      height: 36px;
      padding: 0;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      transition: background 0.2s, transform 0.2s;
      position: relative;
    }

    .notification-btn:hover {
      background: rgba(26, 188, 156, 0.1);
      transform: scale(1.1);
    }

    .notification-btn .notif-badge {
      position: absolute;
      top: 2px;
      right: 2px;
      width: 10px;
      height: 10px;
      background: #e74c3c;
      border-radius: 50%;
      border: 2px solid var(--card-bg);
    }

    /* In-App Toast Notification */
    .toast-container {
      position: fixed;
      top: 70px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1100;
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: calc(100% - 32px);
      width: 350px;
      pointer-events: none;
    }

    .toast {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 14px 16px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: flex-start;
      gap: 12px;
      animation: toastIn 0.3s ease-out;
      pointer-events: auto;
      border-left: 4px solid var(--primary);
    }

    .toast.toast-warning {
      border-left-color: #f39c12;
    }

    .toast.toast-error {
      border-left-color: #e74c3c;
    }

    .toast.toast-out {
      animation: toastOut 0.3s ease-in forwards;
    }

    @keyframes toastIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes toastOut {
      from {
        opacity: 1;
        transform: translateY(0);
      }
      to {
        opacity: 0;
        transform: translateY(-20px);
      }
    }

    .toast-icon {
      font-size: 1.5rem;
      flex-shrink: 0;
    }

    .toast-content {
      flex: 1;
      min-width: 0;
    }

    .toast-title {
      font-weight: 700;
      font-size: 0.9rem;
      color: var(--text-main);
      margin-bottom: 2px;
    }

    .toast-message {
      font-size: 0.8rem;
      color: var(--text-sub);
    }

    .toast-close {
      background: none;
      border: none;
      color: var(--text-sub);
      cursor: pointer;
      padding: 0;
      font-size: 1rem;
      line-height: 1;
      opacity: 0.6;
      transition: opacity 0.2s;
    }

    .toast-close:hover {
      opacity: 1;
    }

    /* Notification Settings Modal Content */
    .notif-settings {
      text-align: left;
    }

    .notif-option {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid var(--timeline-border);
    }

    .notif-option:last-child {
      border-bottom: none;
    }

    .notif-option-label {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .notif-option-icon {
      font-size: 1.3rem;
    }

    .notif-option-text {
      font-size: 0.9rem;
      color: var(--text-main);
    }

    .notif-option-desc {
      font-size: 0.75rem;
      color: var(--text-sub);
    }

    /* Toggle Switch */
    .toggle-switch {
      position: relative;
      width: 50px;
      height: 28px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: 0.3s;
      border-radius: 28px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 22px;
      width: 22px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
    }

    .toggle-switch input:checked + .toggle-slider {
      background-color: var(--primary);
    }

    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(22px);
    }

    [data-theme="dark"] .toggle-slider {
      background-color: #444;
    }

    /* Trip Dashboard */
    .trip-dashboard {
      display: none;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      border-radius: var(--border-radius);
      padding: 16px;
      margin-bottom: 16px;
      color: white;
    }

    .trip-dashboard.show {
      display: block;
    }

    .trip-dashboard-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .trip-dashboard-title {
      font-size: 1rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .trip-dashboard-ref {
      font-size: 0.8rem;
      opacity: 0.9;
      background: rgba(255,255,255,0.2);
      padding: 2px 8px;
      border-radius: 8px;
    }

    .trip-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 14px;
    }

    .trip-stat {
      background: rgba(255,255,255,0.15);
      border-radius: 10px;
      padding: 10px 12px;
      text-align: center;
    }

    .trip-stat-value {
      font-size: 1.4rem;
      font-weight: 700;
      line-height: 1.2;
    }

    .trip-stat-label {
      font-size: 0.7rem;
      opacity: 0.85;
      margin-top: 2px;
    }

    .trip-progress {
      margin-bottom: 12px;
    }

    .trip-progress-header {
      display: flex;
      justify-content: space-between;
      font-size: 0.75rem;
      margin-bottom: 6px;
      opacity: 0.9;
    }

    .trip-progress-bar {
      height: 8px;
      background: rgba(255,255,255,0.25);
      border-radius: 4px;
      overflow: hidden;
    }

    .trip-progress-fill {
      height: 100%;
      background: white;
      border-radius: 4px;
      transition: width 0.5s ease;
    }

    .trip-stops-mini {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .trip-stop-dot {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.65rem;
      font-weight: 700;
      background: rgba(255,255,255,0.25);
      border: 2px solid transparent;
    }

    .trip-stop-dot.completed {
      background: white;
      color: var(--primary);
    }

    .trip-stop-dot.in-progress {
      background: rgba(255,255,255,0.4);
      border-color: white;
      animation: dotPulse 1.5s infinite;
    }

    @keyframes dotPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.15); }
    }

    .trip-stop-dot.pending {
      opacity: 0.6;
    }

    .trip-extra-info {
      display: flex;
      gap: 10px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid rgba(255,255,255,0.2);
      font-size: 0.75rem;
    }

    .trip-extra-item {
      display: flex;
      align-items: center;
      gap: 4px;
      background: rgba(255,255,255,0.15);
      padding: 4px 8px;
      border-radius: 6px;
    }

    button {
      width: 100%;
      padding: 11px 12px;
      border-radius: 999px;
      border: none;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: #ffffff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: transform 0.12s ease-out, box-shadow 0.12s ease-out,
        opacity 0.15s;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 18px rgba(22, 160, 133, 0.28);
    }

    button:active {
      transform: translateY(0);
      box-shadow: none;
      opacity: 0.9;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    .btn-small {
      width: auto;
      padding: 10px 16px;
      font-size: 0.95rem;
      border-radius: 999px;
      margin: 4px 6px 0 0;
    }

    .btn-outline {
      background: #ffffff;
      color: var(--primary-dark);
      border: 1px solid rgba(26, 188, 156, 0.35);
      box-shadow: none;
    }

    .btn-outline:hover {
      background: rgba(26, 188, 156, 0.06);
    }

    .btn-warning {
      background: #f39c12;
      background: linear-gradient(135deg, #f39c12, #d35400);
    }

    .btn-secondary {
      background: #95a5a6;
      background: linear-gradient(135deg, #95a5a6, #7f8c8d);
    }

    .summary-card {
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 10px;
      background: #f7faf9;
      border: 1px solid #e3ebe8;
      font-size: 0.88rem;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    .summary-label {
      color: var(--text-sub);
    }

    .summary-value {
      font-weight: 600;
    }

    .timeline-container {
      margin-top: 14px;
    }

    .timeline-title {
      font-weight: 600;
      font-size: 0.95rem;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .timeline {
      position: relative;
      margin: 0;
      padding: 4px 0 0 20px;
      list-style: none;
    }

    .timeline::before {
      content: '';
      position: absolute;
      left: 9px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: linear-gradient(to bottom,
          rgba(26, 188, 156, 0.6),
          rgba(26, 188, 156, 0.1));
    }

    .timeline-item {
      position: relative;
      margin-bottom: 14px;
    }

    .timeline-marker {
      position: absolute;
      left: -1px;
      top: 6px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #ffffff;
      border: 2px solid var(--primary);
      box-shadow: 0 0 0 2px rgba(26, 188, 156, 0.15);
    }

    .timeline-content {
      margin-left: 14px;
      background: #ffffff;
      border-radius: 12px;
      padding: 8px 10px;
      border: 1px solid #e4ece9;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.04);
    }

    .timeline-header-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 4px;
    }

    .timeline-stop-label {
      font-size: 0.9rem;
      font-weight: 800;
      color: var(--primary-dark);
    }

    .timeline-status {
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(22, 160, 133, 0.06);
      color: var(--primary-dark);
    }

    .timeline-sub {
      font-size: 0.82rem;
      color: var(--text-sub);
      margin-bottom: 2px;
    }

    .materials-text {
      font-size: 0.8rem;
      color: #444;
      margin-top: 4px;
    }

    .action-row {
      margin-top: 6px;
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      align-items: stretch;
    }

    .action-row button {
      flex: 1;
    }

    .btn-nav {
      flex: 0 0 25%;
      background: #0d6efd;
      color: #fff;
      border-radius: 8px;
      padding: 8px 6px;
      text-align: center;
      font-size: 0.8rem;
      border: none;
      width: auto;
    }

    .btn-nav:hover {
      opacity: 0.9;
    }

    .footer-note {
      margin-top: 8px;
      font-size: 0.78rem;
      color: var(--text-sub);
      text-align: center;
    }

    .last-updated {
      margin-top: 10px;
      padding: 8px 12px;
      background: rgba(26, 188, 156, 0.08);
      border-radius: 8px;
      font-size: 0.8rem;
      color: var(--text-sub);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .last-updated-text {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .auto-refresh-badge {
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--primary);
      color: #fff;
    }

    .auto-refresh-badge.paused {
      background: #95a5a6;
    }

    /* Pull-to-Refresh Styles */
    .ptr-container {
      position: relative;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .ptr-indicator {
      position: absolute;
      top: -50px;
      left: 50%;
      transform: translateX(-50%);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--card-bg);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s ease, opacity 0.2s ease;
      opacity: 0;
      z-index: 100;
    }

    .ptr-indicator.visible {
      opacity: 1;
    }

    .ptr-indicator.refreshing {
      top: 10px;
      opacity: 1;
    }

    .ptr-arrow {
      font-size: 1.2rem;
      transition: transform 0.2s ease;
      color: var(--primary);
    }

    .ptr-arrow.flipped {
      transform: rotate(180deg);
    }

    .ptr-spinner {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(26, 188, 156, 0.2);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: ptr-spin 0.8s linear infinite;
    }

    @keyframes ptr-spin {
      to { transform: rotate(360deg); }
    }

    /* GPS Status Indicator */
    .gps-status {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 8px;
      font-size: 0.75rem;
      font-weight: 500;
      margin-bottom: 10px;
      transition: all 0.3s ease;
    }

    .gps-status.checking {
      background: rgba(52, 152, 219, 0.1);
      color: #3498db;
    }

    .gps-status.good {
      background: rgba(26, 188, 156, 0.1);
      color: var(--primary-dark);
    }

    .gps-status.weak {
      background: rgba(243, 156, 18, 0.1);
      color: #d68910;
    }

    .gps-status.error {
      background: rgba(231, 76, 60, 0.1);
      color: #c0392b;
    }

    .gps-icon {
      font-size: 1rem;
    }

    .gps-accuracy {
      margin-left: auto;
      font-size: 0.7rem;
      opacity: 0.8;
    }

    .gps-bars {
      display: flex;
      align-items: flex-end;
      gap: 2px;
      height: 14px;
    }

    .gps-bar {
      width: 4px;
      background: currentColor;
      border-radius: 1px;
      opacity: 0.3;
      transition: opacity 0.2s ease;
    }

    .gps-bar.active {
      opacity: 1;
    }

    .gps-bar:nth-child(1) { height: 4px; }
    .gps-bar:nth-child(2) { height: 7px; }
    .gps-bar:nth-child(3) { height: 10px; }
    .gps-bar:nth-child(4) { height: 14px; }

    @keyframes gps-pulse {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 1; }
    }

    .gps-status.checking .gps-bar {
      animation: gps-pulse 1s ease-in-out infinite;
    }

    .gps-status.checking .gps-bar:nth-child(2) { animation-delay: 0.1s; }
    .gps-status.checking .gps-bar:nth-child(3) { animation-delay: 0.2s; }
    .gps-status.checking .gps-bar:nth-child(4) { animation-delay: 0.3s; }

    .hidden {
      display: none;
    }

    .inline-flex {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%) translateY(-20px);
      width: calc(100% - 24px);
      max-width: 520px;
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.18);
      border-left: 4px solid var(--primary);
      padding: 10px 12px 11px;
      z-index: 9999;
      opacity: 0;
      pointer-events: none;
    }

    .inline-flex-bar {
      width: 42px;
      height: 4px;
      border-radius: 99px;
      background: rgba(26, 188, 156, 0.2);
      margin: 0 auto 6px;
    }

    .inline-flex-title {
      font-size: 0.95rem;
      font-weight: 700;
      color: var(--primary-dark);
      margin-bottom: 2px;
      text-align: left;
    }

    .inline-flex-text {
      font-size: 0.8rem;
      color: var(--text-sub);
      margin-bottom: 2px;
    }

    .inline-flex-sub {
      font-size: 0.76rem;
      color: #555;
    }

    .inline-flex.show {
      animation: dropIn 0.35s ease-out forwards;
    }

    .inline-flex.hide {
      animation: fadeOutUp 0.25s ease-in forwards;
    }

    @keyframes dropIn {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(-20px);
      }

      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }

    @keyframes fadeOutUp {
      from {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }

      to {
        opacity: 0;
        transform: translateX(-50%) translateY(-15px);
      }
    }

    @media (max-width: 480px) {
      .card {
        padding: 14px 14px 18px;
      }

      .title {
        font-size: 1.05rem;
      }

      button {
        font-size: 0.9rem;
      }
    }
  </style>
</head>

<body>
  <!-- Offline Mode Bar -->
  <div id="offlineBar" class="offline-bar">
    <span class="offline-icon">üìµ</span>
    <span>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï</span>
    <span id="queueBadge" class="queue-badge" style="display:none;">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏™‡πà‡∏á</span>
  </div>

  <!-- Syncing Bar -->
  <div id="syncingBar" class="syncing-bar">
    <span class="spin">üîÑ</span>
    <span id="syncingText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ...</span>
  </div>

  <!-- Toast Notification Container -->
  <div id="toastContainer" class="toast-container"></div>

  <!-- Quick Actions Floating Bar -->
  <div id="quickActions" class="quick-actions">
    <button class="quick-actions-close" onclick="hideQuickActions()" title="‡∏õ‡∏¥‡∏î">‚úï</button>
    <div class="quick-actions-header">
      <span class="quick-actions-title">‚ö° ‡∏à‡∏∏‡∏î‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</span>
      <span id="quickActionsStop" class="quick-actions-stop"></span>
    </div>
    <div id="quickActionsButtons" class="quick-actions-buttons">
      <!-- Buttons will be inserted here -->
    </div>
  </div>

  <!-- Inline Flex Notification -->
  <div id="inlineFlex" class="inline-flex hidden">
    <div class="inline-flex-bar"></div>
    <div class="inline-flex-title" id="inlineFlexTitle"></div>
    <div class="inline-flex-text" id="inlineFlexMain"></div>
    <div class="inline-flex-sub" id="inlineFlexSub"></div>
  </div>

  <div class="app-shell" id="appShell">
    <!-- Pull-to-Refresh Indicator -->
    <div id="ptrIndicator" class="ptr-indicator">
      <span id="ptrIcon" class="ptr-arrow">‚Üì</span>
    </div>

    <div class="container">
      <div class="card">
        <div class="header">
          <div class="title">
            üöö Driver Tracking
            <span class="badge">Online</span>
          </div>
          <div style="display:flex;gap:4px;">
            <button id="notificationBtn" class="notification-btn" onclick="openNotificationSettings()" title="‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô">
              üîî
            </button>
            <button id="themeToggle" class="theme-toggle" onclick="toggleTheme()" title="‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô">
              üåô
            </button>
          </div>
        </div>

        <div id="status" class="status-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å LINE...</div>

        <!-- GPS Status Indicator (‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠ refresh) -->
        <div id="gpsStatus" class="gps-status checking" onclick="checkGpsStatus()" style="cursor:pointer;" title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö GPS ‡πÉ‡∏´‡∏°‡πà">
          <span class="gps-icon">üìç</span>
          <span id="gpsText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö GPS...</span>
          <div class="gps-bars">
            <div class="gps-bar"></div>
            <div class="gps-bar"></div>
            <div class="gps-bar"></div>
            <div class="gps-bar"></div>
          </div>
          <span id="gpsAccuracy" class="gps-accuracy"></span>
        </div>

        <div class="field-group">
          <label for="keyword">‡πÄ‡∏•‡∏Ç‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏á‡∏≤‡∏ô (Reference No.)</label>
          <input id="keyword" type="text" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç Reference ‡πÄ‡∏ä‡πà‡∏ô 2511S15403" />
        </div>

        <button id="btnSearch">
          <span>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ / ‡∏î‡∏∂‡∏á‡∏á‡∏≤‡∏ô</span>
        </button>

        <div id="summary" class="summary-card hidden"></div>

        <div id="alcoholContainer" class="summary-card hidden" style="margin-top:10px;"></div>

        <!-- Trip Dashboard -->
        <div id="tripDashboard" class="trip-dashboard">
          <div class="trip-dashboard-header">
            <div class="trip-dashboard-title">
              üìä ‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß
            </div>
            <div id="tripRef" class="trip-dashboard-ref"></div>
          </div>

          <div class="trip-stats">
            <div class="trip-stat">
              <div id="tripCompleted" class="trip-stat-value">0/0</div>
              <div class="trip-stat-label">‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à</div>
            </div>
            <div class="trip-stat">
              <div id="tripDuration" class="trip-stat-value">-</div>
              <div class="trip-stat-label">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</div>
            </div>
          </div>

          <div class="trip-progress">
            <div class="trip-progress-header">
              <span>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</span>
              <span id="tripProgressPercent">0%</span>
            </div>
            <div class="trip-progress-bar">
              <div id="tripProgressFill" class="trip-progress-fill" style="width:0%"></div>
            </div>
          </div>

          <div id="tripStopsMini" class="trip-stops-mini">
            <!-- Stop dots will be inserted here -->
          </div>

          <div id="tripExtraInfo" class="trip-extra-info" style="display:none;">
            <!-- Extra info like fees will be shown here -->
          </div>
        </div>

        <div id="timelineContainer" class="timeline-container hidden">
          <div class="timeline-title">
            ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
            <span style="font-size:0.8rem;color:var(--text-sub);">
              (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á)
            </span>
          </div>
          <ul id="timeline" class="timeline"></ul>

          <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô + ‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ -->
          <div id="closeJobContainer" class="hidden" style="margin-top:8px;">
            <button id="btnCloseJob" class="btn-secondary" style="width:100%;margin-bottom:6px;">
              ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô (‡∏£‡∏ñ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô)
            </button>
            <button id="btnEndTrip" class="btn-secondary" style="width:100%;display:none;">
              ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ (‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå + ‡∏à‡∏∏‡∏î‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ)
            </button>
          </div>
        </div>

        <!-- Last Updated & Auto-refresh Status -->
        <div id="lastUpdatedContainer" class="last-updated hidden">
          <div class="last-updated-text">
            <span>üîÑ</span>
            <span id="lastUpdatedText">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: -</span>
          </div>
          <span id="autoRefreshBadge" class="auto-refresh-badge">Auto</span>
        </div>

        <div class="footer-note">
          ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Check-in / Check-out ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ö‡∏ô‡∏à‡∏≠
        </div>
      </div>
    </div>
  </div>

  <script>
    const LIFF_ID = '2007705394-y4mV76Gv';
    const WEB_APP_URL =
      'https://script.google.com/macros/s/AKfycbwUsEd4lcJ6DD_eYitJ3QCO_nO6Io86IytuSe27bTzQLfVk_Z16wJE6Pn2X1a40yU8J/exec';

    let currentUserId = '';
    let currentReference = '';
    let currentVehicleDesc = '';
    let lastStops = [];
    let inlineFlexTimer = null;

    let currentDrivers = [];
    let currentCheckedDrivers = [];
    let alcoholAllDone = false;
    let jobClosed = false;
    let tripEnded = false;

    // Auto-refresh variables
    const AUTO_REFRESH_INTERVAL = 5 * 60 * 1000; // 5 ‡∏ô‡∏≤‡∏ó‡∏µ
    let autoRefreshTimer = null;
    let lastUpdatedTime = null;
    let lastUpdatedDisplayTimer = null;

    // Pull-to-Refresh variables
    const PTR_THRESHOLD = 80; // ‡∏£‡∏∞‡∏¢‡∏∞‡∏î‡∏∂‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ (px) ‡πÄ‡∏û‡∏∑‡πà‡∏≠ trigger refresh
    const PTR_MAX_PULL = 120; // ‡∏£‡∏∞‡∏¢‡∏∞‡∏î‡∏∂‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (px)
    let ptrStartY = 0;
    let ptrCurrentY = 0;
    let ptrIsPulling = false;
    let ptrIsRefreshing = false;

    // GPS Status variables
    const GPS_CHECK_INTERVAL = 30000; // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏∏‡∏Å 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
    let gpsWatchId = null;
    let gpsCheckTimer = null;
    let lastGpsStatus = 'checking';

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô XSS ‡πÇ‡∏î‡∏¢ escape HTML special characters
    function escapeHtml(str) {
      if (str === null || str === undefined) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    // ===== Auto-refresh Functions =====
    function formatTimeAgo(date) {
      if (!date) return '-';
      const now = new Date();
      const diffMs = now - date;
      const diffSec = Math.floor(diffMs / 1000);
      const diffMin = Math.floor(diffSec / 60);

      if (diffSec < 10) return '‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà';
      if (diffSec < 60) return `${diffSec} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
      if (diffMin < 60) return `${diffMin} ‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;

      // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏£‡∏¥‡∏á‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô 1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
      return date.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
    }

    function updateLastUpdatedDisplay() {
      const textEl = document.getElementById('lastUpdatedText');
      if (textEl && lastUpdatedTime) {
        textEl.textContent = `‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${formatTimeAgo(lastUpdatedTime)}`;
      }
    }

    function showLastUpdatedContainer() {
      const container = document.getElementById('lastUpdatedContainer');
      if (container) {
        container.classList.remove('hidden');
      }
    }

    function hideLastUpdatedContainer() {
      const container = document.getElementById('lastUpdatedContainer');
      if (container) {
        container.classList.add('hidden');
      }
    }

    function startAutoRefresh() {
      // ‡∏´‡∏¢‡∏∏‡∏î timer ‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡πà‡∏≠‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
      stopAutoRefresh();

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï badge
      const badge = document.getElementById('autoRefreshBadge');
      if (badge) {
        badge.textContent = 'Auto';
        badge.classList.remove('paused');
      }

      // ‡πÄ‡∏£‡∏¥‡πà‡∏° auto-refresh ‡∏ó‡∏∏‡∏Å 5 ‡∏ô‡∏≤‡∏ó‡∏µ
      autoRefreshTimer = setInterval(() => {
        if (currentReference) {
          console.log('üîÑ Auto-refresh triggered');
          search(true); // silent refresh
        }
      }, AUTO_REFRESH_INTERVAL);

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï display ‡∏ó‡∏∏‡∏Å 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
      lastUpdatedDisplayTimer = setInterval(updateLastUpdatedDisplay, 30000);

      console.log('‚úÖ Auto-refresh started (every 5 minutes)');
    }

    function stopAutoRefresh() {
      if (autoRefreshTimer) {
        clearInterval(autoRefreshTimer);
        autoRefreshTimer = null;
      }
      if (lastUpdatedDisplayTimer) {
        clearInterval(lastUpdatedDisplayTimer);
        lastUpdatedDisplayTimer = null;
      }

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï badge
      const badge = document.getElementById('autoRefreshBadge');
      if (badge) {
        badge.textContent = 'Paused';
        badge.classList.add('paused');
      }

      console.log('‚è∏Ô∏è Auto-refresh stopped');
    }

    function recordLastUpdated() {
      lastUpdatedTime = new Date();
      updateLastUpdatedDisplay();
      showLastUpdatedContainer();
    }

    // ===== Pull-to-Refresh Functions =====
    function initPullToRefresh() {
      const appShell = document.getElementById('appShell');
      if (!appShell) return;

      appShell.addEventListener('touchstart', handlePtrTouchStart, { passive: true });
      appShell.addEventListener('touchmove', handlePtrTouchMove, { passive: false });
      appShell.addEventListener('touchend', handlePtrTouchEnd, { passive: true });
    }

    function handlePtrTouchStart(e) {
      // ‡πÄ‡∏£‡∏¥‡πà‡∏° pull ‡πÄ‡∏°‡∏∑‡πà‡∏≠ scroll ‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏™‡∏∏‡∏î‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
      if (window.scrollY === 0 && !ptrIsRefreshing) {
        ptrStartY = e.touches[0].clientY;
        ptrIsPulling = true;
      }
    }

    function handlePtrTouchMove(e) {
      if (!ptrIsPulling || ptrIsRefreshing) return;

      ptrCurrentY = e.touches[0].clientY;
      const pullDistance = ptrCurrentY - ptrStartY;

      // ‡∏î‡∏∂‡∏á‡∏•‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (pullDistance > 0) ‡πÅ‡∏•‡∏∞ scroll ‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏™‡∏∏‡∏î
      if (pullDistance > 0 && window.scrollY === 0) {
        // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô scroll ‡∏õ‡∏Å‡∏ï‡∏¥‡∏Ç‡∏ì‡∏∞ pull
        e.preventDefault();

        const indicator = document.getElementById('ptrIndicator');
        const icon = document.getElementById('ptrIcon');

        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞ pull (‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô PTR_MAX_PULL)
        const actualPull = Math.min(pullDistance, PTR_MAX_PULL);
        const progress = actualPull / PTR_THRESHOLD;

        // ‡πÅ‡∏™‡∏î‡∏á indicator
        indicator.classList.add('visible');
        indicator.style.transform = `translateX(-50%) translateY(${actualPull}px)`;

        // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô icon ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ñ‡∏∂‡∏á threshold
        if (pullDistance >= PTR_THRESHOLD) {
          icon.classList.add('flipped');
          icon.textContent = '‚Üë';
        } else {
          icon.classList.remove('flipped');
          icon.textContent = '‚Üì';
        }
      }
    }

    function handlePtrTouchEnd(e) {
      if (!ptrIsPulling || ptrIsRefreshing) return;

      const pullDistance = ptrCurrentY - ptrStartY;
      const indicator = document.getElementById('ptrIndicator');
      const icon = document.getElementById('ptrIcon');

      if (pullDistance >= PTR_THRESHOLD && currentReference) {
        // ‡∏ñ‡∏∂‡∏á threshold ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏¢‡∏π‡πà - ‡∏ó‡∏≥ refresh
        ptrIsRefreshing = true;

        // ‡πÅ‡∏™‡∏î‡∏á spinner
        icon.outerHTML = '<div id="ptrIcon" class="ptr-spinner"></div>';
        indicator.classList.add('refreshing');
        indicator.style.transform = 'translateX(-50%) translateY(60px)';

        // ‡∏ó‡∏≥ refresh
        search(true).finally(() => {
          // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï indicator ‡∏´‡∏•‡∏±‡∏á refresh ‡πÄ‡∏™‡∏£‡πá‡∏à
          setTimeout(() => {
            resetPtrIndicator();
          }, 300);
        });
      } else {
        // ‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á threshold - ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï
        resetPtrIndicator();
      }

      ptrIsPulling = false;
      ptrStartY = 0;
      ptrCurrentY = 0;
    }

    function resetPtrIndicator() {
      const indicator = document.getElementById('ptrIndicator');
      const iconEl = document.getElementById('ptrIcon');

      // ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà spinner ‡∏î‡πâ‡∏ß‡∏¢ arrow ‡πÉ‡∏´‡∏°‡πà
      if (iconEl && iconEl.classList.contains('ptr-spinner')) {
        iconEl.outerHTML = '<span id="ptrIcon" class="ptr-arrow">‚Üì</span>';
      }

      indicator.classList.remove('visible', 'refreshing');
      indicator.style.transform = 'translateX(-50%) translateY(0)';

      const icon = document.getElementById('ptrIcon');
      if (icon) {
        icon.classList.remove('flipped');
        icon.textContent = '‚Üì';
      }

      ptrIsRefreshing = false;
    }

    // ===== GPS Status Functions =====
    function initGpsMonitor() {
      if (!navigator.geolocation) {
        updateGpsStatus('error', '‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS', null);
        return;
      }

      // ‡πÄ‡∏ä‡πá‡∏Ñ GPS ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
      checkGpsStatus();

      // ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∞‡∏¢‡∏∞
      gpsCheckTimer = setInterval(checkGpsStatus, GPS_CHECK_INTERVAL);
    }

    function checkGpsStatus() {
      updateGpsStatus('checking', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö GPS...', null);

      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const accuracy = pos.coords.accuracy;
          handleGpsSuccess(accuracy);
        },
        (err) => {
          handleGpsError(err);
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
      );
    }

    function handleGpsSuccess(accuracy) {
      let status, text, bars;

      if (accuracy <= 20) {
        // ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏î‡∏µ‡∏°‡∏≤‡∏Å (‚â§20 ‡πÄ‡∏°‡∏ï‡∏£)
        status = 'good';
        text = 'GPS ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
        bars = 4;
      } else if (accuracy <= 50) {
        // ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏î‡∏µ (‚â§50 ‡πÄ‡∏°‡∏ï‡∏£)
        status = 'good';
        text = 'GPS ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
        bars = 3;
      } else if (accuracy <= 100) {
        // ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á (‚â§100 ‡πÄ‡∏°‡∏ï‡∏£)
        status = 'weak';
        text = '‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì GPS ‡∏≠‡πà‡∏≠‡∏ô';
        bars = 2;
      } else {
        // ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏ï‡πà‡∏≥ (>100 ‡πÄ‡∏°‡∏ï‡∏£)
        status = 'weak';
        text = '‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì GPS ‡∏≠‡πà‡∏≠‡∏ô‡∏°‡∏≤‡∏Å';
        bars = 1;
      }

      const accuracyText = accuracy < 1000
        ? `¬±${Math.round(accuracy)}m`
        : `¬±${(accuracy / 1000).toFixed(1)}km`;

      updateGpsStatus(status, text, accuracyText, bars);
    }

    function handleGpsError(err) {
      let text;
      switch (err.code) {
        case err.PERMISSION_DENIED:
          text = '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á GPS';
          break;
        case err.POSITION_UNAVAILABLE:
          text = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì GPS';
          break;
        case err.TIMEOUT:
          text = '‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ GPS';
          break;
        default:
          text = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î GPS';
      }
      updateGpsStatus('error', text, null, 0);
    }

    function updateGpsStatus(status, text, accuracy, activeBars = 0) {
      const container = document.getElementById('gpsStatus');
      const textEl = document.getElementById('gpsText');
      const accuracyEl = document.getElementById('gpsAccuracy');
      const bars = container.querySelectorAll('.gps-bar');

      if (!container) return;

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï class
      container.classList.remove('checking', 'good', 'weak', 'error');
      container.classList.add(status);

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï icon
      const iconEl = container.querySelector('.gps-icon');
      if (iconEl) {
        if (status === 'good') iconEl.textContent = 'üìç';
        else if (status === 'weak') iconEl.textContent = 'üì°';
        else if (status === 'error') iconEl.textContent = '‚ö†Ô∏è';
        else iconEl.textContent = 'üìç';
      }

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï text
      if (textEl) textEl.textContent = text;

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï accuracy
      if (accuracyEl) {
        accuracyEl.textContent = accuracy || '';
      }

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï bars
      bars.forEach((bar, index) => {
        if (index < activeBars) {
          bar.classList.add('active');
        } else {
          bar.classList.remove('active');
        }
      });

      lastGpsStatus = status;
    }

    function stopGpsMonitor() {
      if (gpsWatchId !== null) {
        navigator.geolocation.clearWatch(gpsWatchId);
        gpsWatchId = null;
      }
      if (gpsCheckTimer) {
        clearInterval(gpsCheckTimer);
        gpsCheckTimer = null;
      }
    }

    function showLoading(message) {
      Swal.fire({
        title: message || '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...',
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        },
      });
    }

    function closeLoading() {
      Swal.close();
    }

    function showError(message) {
      Swal.fire({
        icon: 'error',
        title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
        text: message || '‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
        confirmButtonColor: '#1abc9c',
      });
    }

    function showSuccess(title, text) {
      return Swal.fire({
        icon: 'success',
        title: title || '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
        text: text || '',
        confirmButtonColor: '#1abc9c',
      });
    }

    function showInfo(title, text) {
      Swal.fire({
        icon: 'info',
        title: title || '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô',
        text: text || '',
        confirmButtonColor: '#1abc9c',
      });
    }

    function showInlineFlex(type, stop) {
      const container = document.getElementById('inlineFlex');
      const titleEl = document.getElementById('inlineFlexTitle');
      const mainEl = document.getElementById('inlineFlexMain');
      const subEl = document.getElementById('inlineFlexSub');

      const labelMap = {
        checkin: 'Check-in ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
        fuel: '‡∏•‡∏á‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
        unload: '‡∏•‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
        processdata: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
        checkout: 'Check-out ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
        closejob: '‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
        endtrip: '‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á
      };

      const title = labelMap[type] || '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';

      let timeText = '';
      if (type === 'checkin') timeText = stop.checkInTime || '';
      else if (type === 'fuel') timeText = stop.fuelingTime || '';
      else if (type === 'unload') timeText = stop.unloadDoneTime || '';
      else if (type === 'processdata') timeText = stop.processdataTime || '';
      else if (type === 'checkout') timeText = stop.checkOutTime || '';

      const odoText =
        type === 'checkin' && stop.checkInOdo
          ? ` ‚Ä¢ ‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå: ${stop.checkInOdo}`
          : '';

      titleEl.textContent = title;
      mainEl.textContent = `Reference: ${stop.referenceNo || '-'} | Shipment: ${stop.shipmentNo || '-'
        }`;
      subEl.textContent = `${stop.destination2 || stop.destination1 || '‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á'
        }${timeText ? ' ‚Ä¢ ‡πÄ‡∏ß‡∏•‡∏≤: ' + timeText : ''}${odoText}`;

      container.classList.remove('hide', 'hidden');
      void container.offsetWidth;
      container.classList.add('show');

      if (inlineFlexTimer) {
        clearTimeout(inlineFlexTimer);
      }
      inlineFlexTimer = setTimeout(() => {
        container.classList.remove('show');
        container.classList.add('hide');
        setTimeout(() => {
          container.classList.add('hidden');
        }, 250);
      }, 4000);
    }

    // ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á Flex message ‡∏•‡∏á‡πÅ‡∏ä‡∏ó LINE (disabled)
    function sendFlexCheckInOut(type, stop) {
      // no-op
    }

    async function initLiff() {
      try {
        await liff.init({ liffId: LIFF_ID });

        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        const profile = await liff.getProfile();
        currentUserId = profile.userId;
        const statusEl = document.getElementById('status');
        statusEl.textContent = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏∏‡∏ì ${profile.displayName} üëã`;
      } catch (err) {
        console.error(err);
        document.getElementById('status').innerText =
          '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î LIFF';
        showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å LIFF ‡πÑ‡∏î‡πâ');
      }
    }

    async function search(silent = false) {
      // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ silent ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö event object ‡∏à‡∏≤‡∏Å addEventListener
      const isSilent = silent === true;

      const keywordInput = document.getElementById('keyword');
      const keyword = keywordInput.value.trim();
      const btn = document.getElementById('btnSearch');

      if (!keyword) {
        showInfo('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç Reference', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡πÄ‡∏•‡∏Ç‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤');
        return;
      }

      btn.disabled = true;

      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì delay
      let startTime;
      if (!isSilent) {
        showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö...‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà');
        // ‡∏£‡∏≠‡πÉ‡∏´‡πâ SweetAlert render ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏° fetch
        await new Promise(resolve => setTimeout(resolve, 100));
        startTime = Date.now();
      }

      try {
        const url =
          WEB_APP_URL +
          '?action=search&keyword=' +
          encodeURIComponent(keyword) +
          '&userId=' +
          encodeURIComponent(currentUserId);

        const res = await fetch(url);
        const json = await res.json();

        // ‡∏£‡∏≠‡πÉ‡∏´‡πâ loader ‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 800ms ‡∏ô‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏™‡∏î‡∏á
        if (!isSilent) {
          const elapsed = Date.now() - startTime;
          const remainingTime = Math.max(0, 800 - elapsed);
          if (remainingTime > 0) {
            await new Promise(resolve => setTimeout(resolve, remainingTime));
          }
          closeLoading();
        }

        if (!json.success) {
          clearResult();
          showError(json.message || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô');
          return;
        }

        const d = json.data;
        let stops = d.stops || [];

        // ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ ‡∏ñ‡πâ‡∏≤ backend ‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏°‡∏≤ (‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏´‡∏≤‡∏¢)
        if (lastStops && Array.isArray(lastStops) && lastStops.length > 0) {
          const prevMap = new Map(lastStops.map((s) => [s.rowIndex, s]));
          stops = stops.map((s) => {
            const prev = prevMap.get(s.rowIndex);
            if (!prev) return s;
            if (!s.destLat) s.destLat = prev.destLat;
            if (!s.destLng) s.destLng = prev.destLng;
            return s;
          });
        }

        lastStops = stops;
        currentReference = d.referenceNo || keyword;
        currentVehicleDesc = d.vehicleDesc || '';

        currentDrivers =
          (d.alcohol && Array.isArray(d.alcohol.drivers) && d.alcohol.drivers) ||
          [];
        currentCheckedDrivers =
          (d.alcohol &&
            Array.isArray(d.alcohol.checkedDrivers) &&
            d.alcohol.checkedDrivers) ||
          [];
        currentCheckedDrivers = [...new Set(currentCheckedDrivers)];
        alcoholAllDone =
          currentDrivers.length > 0 &&
          currentDrivers.every((n) => currentCheckedDrivers.includes(n));

        jobClosed = !!d.jobClosed;
        tripEnded = !!d.tripEnded;

        renderSummary(d);
        renderAlcoholSection();
        renderTimeline(stops);

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏° auto-refresh
        recordLastUpdated();
        if (!autoRefreshTimer) {
          startAutoRefresh();
        }
      } catch (err) {
        console.error(err);
        if (!isSilent) {
          closeLoading();
        }
        showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå');
      } finally {
        btn.disabled = false;
      }
    }

    function clearResult() {
      document.getElementById('summary').classList.add('hidden');
      document.getElementById('timelineContainer').classList.add('hidden');
      document.getElementById('summary').innerHTML = '';
      document.getElementById('timeline').innerHTML = '';
      document.getElementById('closeJobContainer').classList.add('hidden');
      document.getElementById('alcoholContainer').classList.add('hidden');
      document.getElementById('alcoholContainer').innerHTML = '';
      lastStops = [];
      currentDrivers = [];
      currentCheckedDrivers = [];
      alcoholAllDone = false;
      jobClosed = false;
      tripEnded = false;

      // ‡∏´‡∏¢‡∏∏‡∏î auto-refresh ‡πÅ‡∏•‡∏∞‡∏ã‡πà‡∏≠‡∏ô last updated
      stopAutoRefresh();
      hideLastUpdatedContainer();
      lastUpdatedTime = null;
    }

    function renderSummary(d) {
      const summaryEl = document.getElementById('summary');
      const stops = d.stops || [];
      const shipmentNos = d.shipmentNos || [];

      let shipmentSummary = '-';
      if (shipmentNos.length === 1) {
        shipmentSummary = shipmentNos[0];
      } else if (shipmentNos.length > 1) {
        shipmentSummary = shipmentNos.join(', ');
      }

      const totalQtyAll = stops.reduce(function (acc, s) {
        if (typeof s.totalQty === 'number') return acc + s.totalQty;
        return acc;
      }, 0);

      summaryEl.innerHTML = `
          <div class="summary-row">
            <span class="summary-label">Reference</span>
            <span class="summary-value">${escapeHtml(d.referenceNo) || '-'}</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏ñ</span>
            <span class="summary-value">${escapeHtml(d.vehicleDesc) || '-'}</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Shipment</span>
            <span class="summary-value">${escapeHtml(shipmentSummary)}</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á</span>
            <span class="summary-value">${escapeHtml(d.totalStops || stops.length)} ‡∏à‡∏∏‡∏î</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏£‡∏ß‡∏°‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</span>
            <span class="summary-value">${escapeHtml(totalQtyAll || 0)}</span>
          </div>
        `;

      summaryEl.classList.remove('hidden');
    }

    function renderAlcoholSection() {
      const container = document.getElementById('alcoholContainer');
      if (!container) return;

      if (!currentDrivers || currentDrivers.length === 0) {
        container.classList.add('hidden');
        container.innerHTML = '';
        return;
      }

      let html = `
          <div style="font-weight:600;margin-bottom:4px;">‡πÄ‡∏õ‡πà‡∏≤‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô</div>
          <div style="font-size:0.8rem;color:var(--text-sub);margin-bottom:6px;">
            ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç) ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÉ‡∏´‡πâ
          </div>
        `;

      currentDrivers.forEach((name) => {
        const checked = currentCheckedDrivers.includes(name);
        const displayName = escapeHtml(name);
        // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö onclick ‡∏ï‡πâ‡∏≠‡∏á escape ‡∏ó‡∏±‡πâ‡∏á HTML ‡πÅ‡∏•‡∏∞ JS string
        const jsName = escapeHtml(name.replace(/\\/g, '\\\\').replace(/'/g, "\\'"));
        if (checked) {
          html += `
              <div style="margin-bottom:4px;display:flex;justify-content:space-between;align-items:center;">
                <span>${displayName}</span>
                <button class="btn-small btn-secondary" disabled>‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>
              </div>
            `;
        } else {
          html += `
              <div style="margin-bottom:4px;display:flex;justify-content:space-between;align-items:center;">
                <span>${displayName}</span>
                <button class="btn-small btn-outline" onclick="doAlcoholCheck('${jsName}')">
                  ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå
                </button>
              </div>
            `;
        }
      });

      alcoholAllDone =
        currentDrivers.length > 0 &&
        currentDrivers.every((n) => currentCheckedDrivers.includes(n));

      if (alcoholAllDone) {
        html += `
            <div style="margin-top:4px;font-size:0.78rem;color:var(--primary-dark);">
              ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ
            </div>
          `;
      } else {
        html += `
            <div style="margin-top:4px;font-size:0.78rem;color:#c0392b;">
              ‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô
            </div>
          `;
      }

      container.innerHTML = html;
      container.classList.remove('hidden');
    }

    function resizeAndCompressImage(file, maxWidth, quality) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
          const img = new Image();
          img.src = event.target.result;
          img.onload = () => {
            let width = img.width;
            let height = img.height;

            if (width > maxWidth) {
              height = Math.round((height * maxWidth) / width);
              width = maxWidth;
            }

            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);

            // quality: 0.0 - 1.0 (e.g., 0.7 = 70%)
            const dataUrl = canvas.toDataURL('image/jpeg', quality);
            const base64 = dataUrl.split(',')[1];
            resolve(base64);
          };
          img.onerror = (err) => reject(new Error('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'));
        };
        reader.onerror = (err) => reject(new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ'));
      });
    }

    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const result = reader.result || '';
          const base64 = result.toString().split(',')[1] || '';
          resolve(base64);
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    async function doAlcoholCheck(driverName) {
      if (!currentReference) {
        showInfo('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏•‡∏Ç‡∏á‡∏≤‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô');
        return;
      }

      const { value: formValues } = await Swal.fire({
        title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå',
        html: `
            <div style="text-align:left;">
              <label style="font-size:0.8rem;color:#555;">‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö</label>
              <div style="font-size:0.9rem;font-weight:600;margin-bottom:6px;">${escapeHtml(driverName)}</div>

              <label style="font-size:0.8rem;color:#555;">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå (‡∏°‡∏Å./‡∏•‡∏¥‡∏ï‡∏£‡∏•‡∏°‡∏´‡∏≤‡∏¢‡πÉ‡∏à)</label>
              <input id="swalAlcoholValue" type="number" min="0" step="0.01"
                class="swal2-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô 0.00"
                style="width:100%;margin:4px 0 10px;">

              <label style="font-size:0.8rem;color:#555;">‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô</label>
              <input id="swalAlcoholImage" type="file" accept="image/*" capture="environment"
                style="margin-top:4px;font-size:0.8rem;">
            </div>
          `,
        focusConfirm: false,
        showCancelButton: true,
        confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•',
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
        confirmButtonColor: '#1abc9c',
        preConfirm: () => {
          const val = document
            .getElementById('swalAlcoholValue')
            .value.trim();
          const file = document.getElementById('swalAlcoholImage').files[0];

          if (!val) {
            Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå');
            return false;
          }
          if (isNaN(parseFloat(val))) {
            Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç');
            return false;
          }
          if (!file) {
            Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô');
            return false;
          }

          return { alcoholValue: val, file: file };
        },
      });

      if (!formValues) {
        return;
      }

      const { alcoholValue, file } = formValues;

      try {
        showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏à‡∏≤‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå...');

        let pos;
        try {
          pos = await getCurrentPositionAsync();
        } catch (err) {
          console.error(err);
          closeLoading();
          showError(
            '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏à‡∏≤‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î GPS ‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á'
          );
          return;
        }

        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;

        // ‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á (Max width 800px, Quality 70%)
        const base64 = await resizeAndCompressImage(file, 800, 0.7);

        showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå...');

        const formData = new URLSearchParams();
        formData.append('action', 'uploadalcohol');
        formData.append('reference', currentReference);
        formData.append('driverName', driverName);
        formData.append('userId', currentUserId);
        formData.append('alcoholValue', alcoholValue);
        formData.append('lat', String(lat));
        formData.append('lng', String(lng));
        formData.append('imageBase64', base64);

        const res = await fetch(WEB_APP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
          body: formData,
        });

        const json = await res.json();

        closeLoading();

        if (!json.success) {
          showError(json.message || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
          return;
        }

        if (json.checkedDrivers && Array.isArray(json.checkedDrivers)) {
          currentCheckedDrivers = [...new Set(json.checkedDrivers)];
        } else {
          currentCheckedDrivers = [
            ...new Set(currentCheckedDrivers.concat([driverName])),
          ];
        }

        renderAlcoholSection();
        showSuccess('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
      } catch (err) {
        console.error(err);
        closeLoading();
        showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå');
      }
    }

    function renderTimeline(stops) {
      const container = document.getElementById('timelineContainer');
      const ul = document.getElementById('timeline');
      const closeJobContainer = document.getElementById('closeJobContainer');
      const btnCloseJob = document.getElementById('btnCloseJob');
      const btnEndTrip = document.getElementById('btnEndTrip');

      ul.innerHTML = '';

      // reset ‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
      closeJobContainer.classList.add('hidden');
      if (btnCloseJob) {
        btnCloseJob.style.display = 'none';
        btnCloseJob.disabled = true;
      }
      if (btnEndTrip) {
        btnEndTrip.style.display = 'none';
        btnEndTrip.disabled = true;
      }

      if (!stops || stops.length === 0) {
        container.classList.add('hidden');
        return;
      }

      let allCheckout = true;

      stops.forEach(function (stop) {
        const hasCheckIn = !!stop.checkInTime;
        const hasFuel = !!stop.fuelingTime;
        const hasUnloadDone = !!stop.unloadDoneTime;
        const hasCheckOut = !!stop.checkOutTime;
        const isOrigin = !!stop.isOriginStop;

        if (!hasCheckOut) {
          allCheckout = false;
        }

        const statusLabel = stop.status || '-';

        let btnHtml = '';

        if (isOrigin) {
          if (!hasCheckIn) {
            btnHtml +=
              '<button class="btn-small btn-outline" ' +
              'onclick="startCheckin(' +
              stop.rowIndex +
              ', ' +
              stop.seq +
              ')">Check-in</button>';
          } else if (!hasCheckOut) {
            btnHtml +=
              '<button class="btn-small" ' +
              'onclick="startCheckout(' +
              stop.rowIndex +
              ', ' +
              stop.seq +
              ')">Check-out</button>';
          }
        } else {
          if (!hasCheckIn) {
            btnHtml +=
              '<button class="btn-small btn-outline" ' +
              'onclick="startCheckin(' +
              stop.rowIndex +
              ', ' +
              stop.seq +
              ')">Check-in</button>';
          } else if (!hasFuel) {
            btnHtml +=
              '<button class="btn-small btn-warning" ' +
              'onclick="updateStopStatus(' +
              stop.rowIndex +
              ", 'FUELING', 'fuel', " +
              stop.seq +
              ')">‡∏•‡∏á‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô</button>';
          } else if (!hasUnloadDone) {
            btnHtml +=
              '<button class="btn-small btn-outline" ' +
              'onclick="updateStopStatus(' +
              stop.rowIndex +
              ", 'UNLOAD_DONE', 'unload', " +
              stop.seq +
              ')">‡∏•‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à</button>';
          } else if (!hasCheckOut) {
            btnHtml +=
              '<button class="btn-small" ' +
              'onclick="startCheckout(' +
              stop.rowIndex +
              ', ' +
              stop.seq +
              ')">Check-out</button>';
          }
        }

        let materialsBlock = '';
        if (stop.materials && stop.materials.length > 0) {
          const parts = stop.materials.map(function (m) {
            const name = escapeHtml(m.materialDesc || m.material || '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤');
            const qty = escapeHtml(m.totalQty || 0);
            return '- ' + name + ' ' + qty;
          });
          materialsBlock =
            '<div class="materials-text"><b>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</b><br>' +
            parts.join('<br>') +
            '</div>';
        }

        const distanceText =
          stop.distanceKm !== undefined &&
            stop.distanceKm !== null &&
            stop.distanceKm !== ''
            ? stop.distanceKm
            : '-';

        const odoText =
          stop.checkInOdo !== undefined &&
            stop.checkInOdo !== null &&
            stop.checkInOdo !== ''
            ? stop.checkInOdo
            : '-';

        let navBtnHtml = '';
        if (
          stop.destLat !== undefined &&
          stop.destLat !== '' &&
          stop.destLng !== undefined &&
          stop.destLng !== ''
        ) {
          navBtnHtml =
            '<button class="btn-nav" onclick="navigateToStop(' +
            stop.rowIndex +
            ')">‡∏ô‡∏≥‡∏ó‡∏≤‡∏á</button>';
        }

        const li = document.createElement('li');
        li.className = 'timeline-item';
        li.innerHTML =
          '<span class="timeline-marker"></span>' +
          '<div class="timeline-content">' +
          '<div class="timeline-header-row">' +
          '<div class="timeline-stop-label">' +
          'Stop ' +
          escapeHtml(stop.seq) +
          ' ‚Ä¢ ' +
          escapeHtml(stop.destination2 || '-') +
          '</div>' +
          '<div class="timeline-status">' +
          escapeHtml(statusLabel) +
          '</div>' +
          '</div>' +
          '<div class="timeline-sub">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ: ' +
          escapeHtml(stop.destination1 || '-') +
          '</div>' +
          '<div class="timeline-sub"><b>Shipment:</b> ' +
          escapeHtml(stop.shipmentNo || '-') +
          '</div>' +
          '<div class="timeline-sub"><b>Distance (‡∏£‡∏∞‡∏ö‡∏ö):</b> ' +
          escapeHtml(distanceText) +
          '</div>' +
          '<div class="timeline-sub"><b>Check-in:</b> ' +
          escapeHtml(stop.checkInTime || '-') +
          '</div>' +
          '<div class="timeline-sub"><b>‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå Check-in:</b> ' +
          escapeHtml(odoText) +
          '</div>' +
          '<div class="timeline-sub"><b>‡∏•‡∏á‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô:</b> ' +
          escapeHtml(stop.fuelingTime || '-') +
          '</div>' +
          '<div class="timeline-sub"><b>‡∏•‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à:</b> ' +
          escapeHtml(stop.unloadDoneTime || '-') +
          '</div>' +
          '<div class="timeline-sub"><b>Check-out:</b> ' +
          escapeHtml(stop.checkOutTime || '-') +
          '</div>' +
          materialsBlock +
          '<div class="action-row">' +
          btnHtml +
          navBtnHtml +
          '</div>' +
          '</div>';
        ul.appendChild(li);
      });

      // ‚úÖ Logic ‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô / ‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ
      if (stops.length > 0) {
        if (tripEnded) {
          // ‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
          closeJobContainer.classList.add('hidden');
          if (btnCloseJob) {
            btnCloseJob.style.display = 'none';
            btnCloseJob.disabled = true;
          }
          if (btnEndTrip) {
            btnEndTrip.style.display = 'none';
            btnEndTrip.disabled = true;
          }
        } else if (jobClosed) {
          // ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏õ‡∏∏‡πà‡∏° "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ"
          closeJobContainer.classList.remove('hidden');
          if (btnCloseJob) {
            btnCloseJob.style.display = 'none';
            btnCloseJob.disabled = true;
          }
          if (btnEndTrip) {
            btnEndTrip.style.display = 'block';
            btnEndTrip.disabled = false;
          }
        } else if (allCheckout) {
          // Checkout ‡∏Ñ‡∏£‡∏ö ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô ‚Üí ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏° "‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô"
          closeJobContainer.classList.remove('hidden');
          if (btnCloseJob) {
            btnCloseJob.style.display = 'block';
            btnCloseJob.disabled = false;
          }
          if (btnEndTrip) {
            btnEndTrip.style.display = 'none';
            btnEndTrip.disabled = true;
          }
        } else {
          closeJobContainer.classList.add('hidden');
        }
      } else {
        closeJobContainer.classList.add('hidden');
      }

      container.classList.remove('hidden');

      // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó Trip Dashboard
      updateTripDashboard(stops);

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
      checkForChanges(stops);

      // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó Quick Actions
      updateQuickActions();
    }

    function getCurrentPositionAsync() {
      return new Promise(function (resolve, reject) {
        if (!navigator.geolocation) {
          reject(new Error('‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á'));
          return;
        }
        navigator.geolocation.getCurrentPosition(
          function (pos) {
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏î‡πâ‡∏û‡∏¥‡∏Å‡∏±‡∏î 0,0 ‡∏ã‡∏∂‡πà‡∏á‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å error ‡∏ö‡∏≤‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á
            if (pos.coords.latitude === 0 && pos.coords.longitude === 0) {
              reject(new Error('‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (0,0) ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà'));
              return;
            }
            resolve(pos);
          },
          function (err) {
            let msg = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ (' + err.code + ')';
            switch (err.code) {
              case err.PERMISSION_DENIED:
                msg = '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå GPS';
                break;
              case err.POSITION_UNAVAILABLE:
                msg = '‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì GPS ‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏¢‡∏∑‡∏ô‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏•‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á';
                break;
              case err.TIMEOUT:
                msg = '‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏û‡∏¥‡∏Å‡∏±‡∏î (Timeout) ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
                break;
            }
            reject(new Error(msg));
          },
          // ‡∏•‡∏î Timeout ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô
          { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
        );
      });
    }

    async function startCheckin(rowIndex, seq) {
      if (currentDrivers.length > 0 && currentCheckedDrivers.length === 0) {
        showInfo(
          '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô',
          '‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ñ‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ Check-in ‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á‡πÅ‡∏£‡∏Å'
        );
        return;
      }

      const stop = (lastStops || []).find((s) => s.rowIndex === rowIndex);
      if (!stop) {
        showError('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
        return;
      }
      const isOrigin = !!stop.isOriginStop;

      if (isOrigin) {
        // Origin Stop: ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå
        const { value: formValues } = await Swal.fire({
          icon: 'question',
          title: '‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡∏£‡∏ñ',
          html: `
              <div style="text-align:left;">
                <label style="font-size:0.8rem;color:#555;">‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡∏£‡∏ñ ‡∏ì ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà Check-in</label>
                <input id="swalOdoInput" type="number" inputmode="numeric"
                  class="swal2-input"
                  placeholder="‡πÄ‡∏ä‡πà‡∏ô 123456"
                  style="width:100%;margin:6px 0 4px;">
              </div>
            `,
          focusConfirm: false,
          showCancelButton: true,
          confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô Check-in',
          cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
          confirmButtonColor: '#1abc9c',
          preConfirm: () => {
            const val = document.getElementById('swalOdoInput').value.trim();
            if (!val) {
              Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡∏£‡∏ñ');
              return false;
            }
            return { odo: val };
          },
        });

        if (!formValues) {
          return;
        }

        const { odo } = formValues;
        await updateStopStatus(rowIndex, 'CHECKIN', 'checkin', seq, odo);
      } else {
        // Non-Origin Stop: ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå + ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô + ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö
        const { value: formValues } = await Swal.fire({
          icon: 'question',
          title: 'Check-in ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
          html: `
              <div style="text-align:left;">
                <label style="font-size:0.8rem;color:#555;">‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡∏£‡∏ñ ‡∏ì ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà Check-in</label>
                <input id="swalOdoInput" type="number" inputmode="numeric"
                  class="swal2-input"
                  placeholder="‡πÄ‡∏ä‡πà‡∏ô 123456"
                  style="width:100%;margin:4px 0 8px;">

                <label style="font-size:0.8rem;color:#555;">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô *</label>
                <input id="swalReceiverName" type="text"
                  class="swal2-input"
                  placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏¥‡∏ó‡∏£ ‡πÉ‡∏à‡∏î‡∏µ"
                  style="width:100%;margin:4px 0 8px;">

                <label style="font-size:0.8rem;color:#555;"><b>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô</b></label>
                <div style="margin:4px 0 10px;font-size:0.85rem;">
                  <label style="display:block;margin-bottom:4px;">
                    <input type="radio" name="receiverType" value="manager"> ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏Ç‡∏≤
                  </label>
                  <label style="display:block;margin-bottom:4px;">
                    <input type="radio" name="receiverType" value="frontHasCard"> ‡∏´‡∏ô‡πâ‡∏≤‡∏•‡∏≤‡∏ô‡∏°‡∏µ‡∏ö‡∏±‡∏ï‡∏£
                  </label>
                  <label style="display:block;">
                    <input type="radio" name="receiverType" value="frontNoCard"> ‡∏´‡∏ô‡πâ‡∏≤‡∏•‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ï‡∏£
                  </label>
                </div>
              </div>
            `,
          focusConfirm: false,
          showCancelButton: true,
          confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô Check-in',
          cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
          confirmButtonColor: '#1abc9c',
          preConfirm: () => {
            const odo = document.getElementById('swalOdoInput').value.trim();
            const receiverName = document.getElementById('swalReceiverName').value.trim();
            const typeRadio = document.querySelector('input[name="receiverType"]:checked');

            if (!odo) {
              Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡∏£‡∏ñ');
              return false;
            }
            if (!receiverName) {
              Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô');
              return false;
            }
            if (!typeRadio) {
              Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô');
              return false;
            }

            return {
              odo: odo,
              receiverName: receiverName,
              receiverType: typeRadio.value,
            };
          },
        });

        if (!formValues) {
          return;
        }

        const { odo, receiverName, receiverType } = formValues;
        await updateStopStatus(
          rowIndex,
          'CHECKIN',
          'checkin',
          seq,
          odo,
          receiverName,
          receiverType
        );
      }
    }

    async function startCheckout(rowIndex, seq) {
      const stop = (lastStops || []).find((s) => s.rowIndex === rowIndex);
      if (!stop) {
        showError('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
        return;
      }
      const isOrigin = !!stop.isOriginStop;

      if (isOrigin) {
        // Origin Stop: checkout ‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡∏≤‡∏°‡∏≠‡∏∞‡πÑ‡∏£
        await updateStopStatus(rowIndex, 'CHECKOUT', 'checkout', seq);
      } else {
        // Non-Origin Stop: ‡∏ñ‡∏≤‡∏°‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏±‡πà‡∏ô‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÇ‡∏¢‡∏Å‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô
        const { value: formValues } = await Swal.fire({
          icon: 'question',
          title: 'Check-out ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
          html: `
              <div style="text-align:left;">
                <label style="font-size:0.8rem;color:#555;"><b>‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏õ‡∏±‡πà‡∏ô‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</b></label>
                <div style="margin:4px 0 10px;font-size:0.85rem;">
                  <label style="display:block;margin-bottom:4px;">
                    <input type="radio" name="hasPumping" value="no" checked> ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏õ‡∏±‡πà‡∏ô‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô
                  </label>
                  <label style="display:block;">
                    <input type="radio" name="hasPumping" value="yes"> ‡∏°‡∏µ‡∏õ‡∏±‡πà‡∏ô‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô
                  </label>
                </div>

                <label style="font-size:0.8rem;color:#555;"><b>‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÇ‡∏¢‡∏Å‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</b></label>
                <div style="margin:4px 0 10px;font-size:0.85rem;">
                  <label style="display:block;margin-bottom:4px;">
                    <input type="radio" name="hasTransfer" value="no" checked> ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏¢‡∏Å‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô
                  </label>
                  <label style="display:block;">
                    <input type="radio" name="hasTransfer" value="yes"> ‡∏°‡∏µ‡πÇ‡∏¢‡∏Å‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô
                  </label>
                </div>
              </div>
            `,
          focusConfirm: false,
          showCancelButton: true,
          confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô Check-out',
          cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
          confirmButtonColor: '#1abc9c',
          preConfirm: () => {
            const pumpingRadio = document.querySelector('input[name="hasPumping"]:checked');
            const transferRadio = document.querySelector('input[name="hasTransfer"]:checked');

            return {
              hasPumping: pumpingRadio ? pumpingRadio.value : 'no',
              hasTransfer: transferRadio ? transferRadio.value : 'no',
            };
          },
        });

        if (!formValues) {
          return;
        }

        const { hasPumping, hasTransfer } = formValues;
        await updateStopStatus(
          rowIndex,
          'CHECKOUT',
          'checkout',
          seq,
          null,
          null,
          null,
          hasPumping,
          hasTransfer
        );
      }
    }

    async function updateStopStatus(rowIndex, newStatus, type, seq, odo, receiverName, receiverType, hasPumping, hasTransfer) {
      if (!currentUserId) {
        showError('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (User ID) ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠');
        return;
      }
      if (rowIndex === undefined || rowIndex === null) {
        showError('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ñ‡∏ß (Row Index) ‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ');
        return;
      }

      // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏ã‡πâ‡∏≥‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏£‡∏≠‡∏ú‡∏•
      const actionButtons = Array.from(
        document.querySelectorAll('.timeline .action-row button')
      );
      const buttonsToReenable = actionButtons.filter((btn) => !btn.disabled);
      buttonsToReenable.forEach((btn) => {
        btn.disabled = true;
      });

      try {
        showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏à‡∏≤‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå...');

        let pos;
        try {
          pos = await getCurrentPositionAsync();
        } catch (err) {
          console.error(err);
          closeLoading();
          showError(
            '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏à‡∏≤‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î GPS ‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á'
          );
          return;
        }

        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;

        showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á...');

        const formData = new URLSearchParams();
        formData.append('action', 'updatestop'); // ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡πá‡∏Å‡∏ï‡∏≤‡∏° Backend
        formData.append('rowIndex', rowIndex);
        formData.append('status', newStatus);
        formData.append('type', type);
        formData.append('userId', currentUserId);
        formData.append('lat', String(lat));
        formData.append('lng', String(lng));

        if (type === 'checkin') {
          formData.append('odo', odo || '');
          if (receiverName) formData.append('receiverName', receiverName);
          if (receiverType) formData.append('receiverType', receiverType);
        } else if (type === 'checkout') {
          if (hasPumping) formData.append('hasPumping', hasPumping);
          if (hasTransfer) formData.append('hasTransfer', hasTransfer);
        }

        console.log('Attempting POST:', Array.from(formData.entries()));

        // ‡∏ñ‡πâ‡∏≤ Offline ‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡πá‡∏ö‡∏•‡∏á Queue ‡πÅ‡∏ó‡∏ô
        if (!isOnline) {
          closeLoading();
          const queueData = {
            action: 'updatestop',
            data: Object.fromEntries(formData.entries()),
            description: type === 'checkin' ? '‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà ' + seq : '‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà ' + seq,
          };
          addToOfflineQueue(queueData);

          await Swal.fire({
            icon: 'info',
            title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏Ñ‡∏¥‡∏ß',
            html: '<b>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï</b><br>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå',
            confirmButtonColor: '#1abc9c',
          });
          return;
        }

        const res = await fetch(WEB_APP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
          body: formData,
        });

        let text = await res.text();
        let json;

        // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÄ‡∏õ‡πá‡∏ô JSON ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (text.trim().startsWith('{')) {
          json = JSON.parse(text);
        } else {
          // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà JSON (‡πÄ‡∏ä‡πà‡∏ô NO_EVENT ‡∏´‡∏£‡∏∑‡∏≠ Error ‡∏≠‡∏∑‡πà‡∏ô) ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á GET ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
          console.warn('POST failed, retrying with GET...', text);
          const resGet = await fetch(WEB_APP_URL + '?' + formData.toString());
          text = await resGet.text();
          if (text.trim().startsWith('{')) {
            json = JSON.parse(text);
          } else {
            throw new Error(text || 'Unknown Server Response');
          }
        }

        closeLoading();

        if (!json.success) {
          // ‡πÅ‡∏™‡∏î‡∏á Error ‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å Server ‡πÄ‡∏ä‡πà‡∏ô "‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡∏£‡∏±‡∏®‡∏°‡∏µ" ‡∏´‡∏£‡∏∑‡∏≠ "‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡πà‡∏≤‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå"
          showError(json.message || '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
          return;
        }

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ö‡∏ô UI ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        const stopInfo = json.stop || null;
        if (stopInfo) {
          lastStops = (lastStops || []).map((s) => {
            if (s.rowIndex !== stopInfo.rowIndex) return s;
            const merged = { ...s, ...stopInfo };
            if (!merged.destLat) merged.destLat = s.destLat;
            if (!merged.destLng) merged.destLng = s.destLng;
            return merged;
          });
          renderTimeline(lastStops);
          showInlineFlex(type, stopInfo);
        }

        await showSuccess('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', json.message || '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');

        if (currentReference) {
          document.getElementById('keyword').value = currentReference;
          search(true);
        }
      } catch (err) {
        console.error('UpdateStatus Error:', err);
        closeLoading();

        // ‡∏ñ‡πâ‡∏≤ Network Error ‡πÅ‡∏•‡∏∞ Offline ‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡πá‡∏ö‡∏•‡∏á Queue
        if (!navigator.onLine || err.message.includes('Failed to fetch') || err.message.includes('NetworkError')) {
          isOnline = false;
          showOfflineBar(true);

          const queueData = {
            action: 'updatestop',
            data: Object.fromEntries(formData.entries()),
            description: type === 'checkin' ? '‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà ' + seq : '‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà ' + seq,
          };
          addToOfflineQueue(queueData);

          await Swal.fire({
            icon: 'info',
            title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏Ñ‡∏¥‡∏ß',
            html: '<b>‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á</b><br>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå',
            confirmButtonColor: '#1abc9c',
          });
          return;
        }

        showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message);
      } finally {
        buttonsToReenable.forEach((btn) => {
          btn.disabled = false;
        });
      }
    }

    // ‡∏ü‡∏≠‡∏£‡πå‡∏° "‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ"
    async function openEndTripDialog() {
      if (!currentReference) {
        showInfo('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏•‡∏Ç‡∏á‡∏≤‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô');
        return;
      }

      const { value: formValues } = await Swal.fire({
        title: '‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ',
        html: `
            <div style="text-align:left;">
              <div style="font-size:0.85rem;color:#555;margin-bottom:6px;">
                Reference: <b>${escapeHtml(currentReference)}</b>
              </div>

              <label style="font-size:0.8rem;color:#555;">‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ</label>
              <input id="swalEndOdo" type="number" min="0" step="1"
                class="swal2-input"
                placeholder="‡πÄ‡∏ä‡πà‡∏ô 234567"
                style="width:100%;margin:4px 0 8px;">

              <label style="font-size:0.8rem;color:#555;">‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏∏‡∏î‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ</label>
              <input id="swalEndPoint" type="text"
                class="swal2-input"
                placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ö‡∏≤‡∏á‡∏ô‡∏≤ / ‡∏•‡∏≤‡∏ô‡∏à‡∏≠‡∏î‡∏Ñ‡∏•‡∏±‡∏á‡∏´‡∏•‡∏±‡∏Å"
                style="width:100%;margin:4px 0 6px;">

              <div style="margin-top:6px;font-size:0.78rem;color:#888;">
                * ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå ‡∏à‡∏∏‡∏î‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS (Lat/Long) ‡∏ì ‡πÄ‡∏ß‡∏•‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
              </div>
            </div>
          `,
        focusConfirm: false,
        showCancelButton: true,
        confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ',
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
        confirmButtonColor: '#1abc9c',
        cancelButtonColor: '#95a5a6',
        preConfirm: () => {
          const odoVal = document
            .getElementById('swalEndOdo')
            .value.trim();
          const pointVal = document
            .getElementById('swalEndPoint')
            .value.trim();

          if (!odoVal) {
            Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ');
            return false;
          }
          const odoNum = parseFloat(odoVal);
          if (isNaN(odoNum) || odoNum < 0) {
            Swal.showValidationMessage(
              '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (0 ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ)'
            );
            return false;
          }
          if (!pointVal) {
            Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏∏‡∏î‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ');
            return false;
          }

          return {
            endOdo: odoVal,
            endPointName: pointVal,
          };
        },
      });

      if (!formValues) {
        return;
      }

      await saveEndTripSummary(formValues);
    }

    // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ‡πÑ‡∏õ backend (‡∏£‡∏ß‡∏°‡∏û‡∏¥‡∏Å‡∏±‡∏î Lat/Long) + ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    async function saveEndTripSummary(values) {
      try {
        showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ...');

        let pos;
        try {
          pos = await getCurrentPositionAsync();
        } catch (err) {
          console.error('Geolocation error in endTrip:', err);
          closeLoading();
          showError(
            '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏à‡∏≤‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î GPS ‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á'
          );
          return;
        }

        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;

        showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ...');

        const formData = new URLSearchParams();
        formData.append('action', 'endtrip'); // ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö backend
        formData.append('reference', currentReference);
        formData.append('userId', currentUserId);
        formData.append('endOdo', values.endOdo || '');
        formData.append('endPointName', values.endPointName || '');
        formData.append('lat', String(lat));
        formData.append('lng', String(lng));

        const res = await fetch(WEB_APP_URL, {
          method: 'POST',
          body: formData,
        });

        if (!res.ok) {
          const rawErr = await res.text().catch(() => '');
          console.error('HTTP error endtrip:', res.status, rawErr);
          closeLoading();
          showError(
            '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ‡πÑ‡∏î‡πâ (HTTP ' +
            res.status +
            ') ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô'
          );
          return;
        }

        const raw = await res.text();
        let json;
        try {
          json = JSON.parse(raw);
        } catch (e) {
          console.error('Response from endtrip is not valid JSON:', raw);
          closeLoading();
          showError(
            '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ (‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á): ' +
            (raw || 'NO_RESPONSE')
          );
          return;
        }

        closeLoading();

        if (!json.success) {
          showError(json.message || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
          return;
        }

        // ‚úÖ mark ‡∏ß‡πà‡∏≤‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ‡πÅ‡∏•‡πâ‡∏ß
        tripEnded = true;

        await showSuccess(
          '‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
          '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß\n‡∏Å‡∏£‡∏ì‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏à‡πâ‡∏á‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 1 ‡∏ß‡∏±‡∏ô'
        );

        // ‚úÖ ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        const closeJobContainer = document.getElementById('closeJobContainer');
        const btnCloseJob = document.getElementById('btnCloseJob');
        const btnEndTrip = document.getElementById('btnEndTrip');
        if (closeJobContainer) closeJobContainer.classList.add('hidden');
        if (btnCloseJob) {
          btnCloseJob.style.display = 'none';
          btnCloseJob.disabled = true;
        }
        if (btnEndTrip) {
          btnEndTrip.style.display = 'none';
          btnEndTrip.disabled = true;
        }

        // refresh ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏µ‡∏Å‡∏£‡∏≠‡∏ö (‡∏à‡∏∞‡πÑ‡∏î‡πâ d.tripEnded = true ‡∏î‡πâ‡∏ß‡∏¢‡∏ñ‡πâ‡∏≤ backend ‡∏™‡πà‡∏á‡∏°‡∏≤)
        if (currentReference) {
          document.getElementById('keyword').value = currentReference;
          await search(true);
        }
      } catch (err) {
        console.error('saveEndTripSummary fatal error:', err);
        closeLoading();
        showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ');
      }
    }

    async function closeJob() {
      if (!currentReference) {
        showInfo('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏•‡∏Ç‡∏á‡∏≤‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô');
        return;
      }

      const { value: formValues } = await Swal.fire({
        icon: 'question',
        title: '‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô - ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°',
        html: `
          <div style="text-align:left;margin:8px 0;">
            <label style="font-size:0.8rem;color:#555;margin-bottom:4px;display:block;"><b>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏ñ‡∏´‡∏•‡∏±‡∏á‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô</b></label>
            <label style="display:flex;align-items:center;margin-bottom:8px;cursor:pointer;padding:10px;border-radius:8px;background:#f7faf9;">
              <input type="radio" name="vehicleStatus" value="ready" checked style="margin-right:10px;width:16px;height:16px;cursor:pointer;">
              <span style="flex:1;">
                <div style="font-weight:600;color:#1abc9c;font-size:0.85rem;">‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô</div>
                <div style="font-size:0.75rem;color:#666;">‡∏£‡∏ñ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ</div>
              </span>
            </label>
            <label style="display:flex;align-items:center;margin-bottom:12px;cursor:pointer;padding:10px;border-radius:8px;background:#fff3cd;">
              <input type="radio" name="vehicleStatus" value="maintenance" style="margin-right:10px;width:16px;height:16px;cursor:pointer;">
              <span style="flex:1;">
                <div style="font-weight:600;color:#f39c12;font-size:0.85rem;">üîß ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á</div>
                <div style="font-size:0.75rem;color:#666;">‡∏£‡∏ñ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏ã‡πà‡∏≠‡∏° ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ</div>
              </span>
            </label>

            <label style="font-size:0.8rem;color:#555;"><b>‡∏Ñ‡πà‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏Ç‡∏≤</b></label>
            <div style="margin:4px 0 10px;font-size:0.85rem;">
              <label style="display:block;margin-bottom:4px;">
                <input type="radio" name="hillFee" value="no" checked> ‡πÑ‡∏°‡πà‡∏°‡∏µ
              </label>
              <label style="display:block;">
                <input type="radio" name="hillFee" value="yes"> ‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏Ç‡∏≤
              </label>
            </div>

            <label style="font-size:0.8rem;color:#555;"><b>‡∏Ñ‡πà‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ ‡∏Å‡∏ó‡∏°</b></label>
            <div style="margin:4px 0 10px;font-size:0.85rem;">
              <label style="display:block;margin-bottom:4px;">
                <input type="radio" name="bkkFee" value="no" checked> ‡πÑ‡∏°‡πà‡∏°‡∏µ
              </label>
              <label style="display:block;">
                <input type="radio" name="bkkFee" value="yes"> ‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ ‡∏Å‡∏ó‡∏°
              </label>
            </div>

            <label style="font-size:0.8rem;color:#555;"><b>‡∏ô‡∏≥‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ã‡πà‡∏≠‡∏°</b></label>
            <div style="margin:4px 0 10px;font-size:0.85rem;">
              <label style="display:block;margin-bottom:4px;">
                <input type="radio" name="repairFee" value="no" checked> ‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏ã‡πà‡∏≠‡∏°
              </label>
              <label style="display:block;">
                <input type="radio" name="repairFee" value="yes"> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ã‡πà‡∏≠‡∏°
              </label>
            </div>
          </div>
        `,
        focusConfirm: false,
        showCancelButton: true,
        confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô',
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
        confirmButtonColor: '#1abc9c',
        preConfirm: () => {
          const vehicleStatusRadio = document.querySelector('input[name="vehicleStatus"]:checked');
          const hillFeeRadio = document.querySelector('input[name="hillFee"]:checked');
          const bkkFeeRadio = document.querySelector('input[name="bkkFee"]:checked');
          const repairFeeRadio = document.querySelector('input[name="repairFee"]:checked');

          return {
            vehicleStatus: vehicleStatusRadio ? vehicleStatusRadio.value : 'ready',
            hillFee: hillFeeRadio ? hillFeeRadio.value : 'no',
            bkkFee: bkkFeeRadio ? bkkFeeRadio.value : 'no',
            repairFee: repairFeeRadio ? repairFeeRadio.value : 'no',
          };
        },
      });

      if (!formValues) return;

      const { vehicleStatus, hillFee, bkkFee, repairFee } = formValues;

      try {
        showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô...');

        const formData = new URLSearchParams();
        formData.append('action', 'closejob');
        formData.append('reference', currentReference);
        formData.append('userId', currentUserId);
        formData.append('vehicleStatus', vehicleStatus);
        formData.append('vehicleDesc', currentVehicleDesc);
        formData.append('hillFee', hillFee);
        formData.append('bkkFee', bkkFee);
        formData.append('repairFee', repairFee);

        const res = await fetch(WEB_APP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
          body: formData,
        });
        const json = await res.json();

        closeLoading();

        if (!json.success) {
          showError(json.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ');
          return;
        }

        jobClosed = true;

        if (json.stop) {
          showInlineFlex('closejob', json.stop);
        }

        const statusMessage =
          vehicleStatus === 'maintenance'
            ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÅ‡∏•‡πâ‡∏ß'
            : '‡∏£‡∏ñ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ';

        await showSuccess('‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', statusMessage);

        // Reload data ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ d.jobClosed = true ‡πÅ‡∏•‡πâ‡∏ß renderTimeline ‡∏à‡∏∞‡πÇ‡∏ä‡∏ß‡πå‡∏õ‡∏∏‡πà‡∏° "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ"
        if (currentReference) {
          document.getElementById('keyword').value = currentReference;
          await search(true);
        }
      } catch (err) {
        console.error(err);
        closeLoading();
        showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô');
      }
    }

    function navigateToStop(rowIndex) {
      const stop = (lastStops || []).find((s) => s.rowIndex === rowIndex);
      if (!stop) return;

      const lat =
        stop.destLat ||
        stop.destinationLat ||
        stop.dest_lat ||
        stop.lat ||
        '';
      const lng =
        stop.destLng ||
        stop.destinationLng ||
        stop.dest_lng ||
        stop.lng ||
        '';

      if (!lat || !lng) {
        Swal.fire({
          icon: 'warning',
          title: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á',
          text: '‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö',
          confirmButtonColor: '#1abc9c',
        });
        return;
      }

      const url =
        'https://www.google.com/maps?q=' +
        encodeURIComponent(lat) +
        ',' +
        encodeURIComponent(lng);
      window.open(url, '_blank');
    }

    // ==================== Dark Mode ====================
    const THEME_KEY = 'driverapp_theme';

    function loadSavedTheme() {
      const savedTheme = localStorage.getItem(THEME_KEY);
      if (savedTheme === 'dark') {
        document.documentElement.setAttribute('data-theme', 'dark');
        updateThemeIcon(true);
      } else {
        document.documentElement.removeAttribute('data-theme');
        updateThemeIcon(false);
      }
    }

    function toggleTheme() {
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      if (isDark) {
        document.documentElement.removeAttribute('data-theme');
        localStorage.setItem(THEME_KEY, 'light');
        updateThemeIcon(false);
      } else {
        document.documentElement.setAttribute('data-theme', 'dark');
        localStorage.setItem(THEME_KEY, 'dark');
        updateThemeIcon(true);
      }
    }

    function updateThemeIcon(isDark) {
      const btn = document.getElementById('themeToggle');
      if (btn) {
        btn.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
        btn.title = isDark ? '‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô' : '‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô';
      }
    }

    // ==================== Offline Mode ====================
    const OFFLINE_QUEUE_KEY = 'driverapp_offline_queue';
    let isOnline = navigator.onLine;
    let isSyncing = false;

    function getOfflineQueue() {
      try {
        const data = localStorage.getItem(OFFLINE_QUEUE_KEY);
        return data ? JSON.parse(data) : [];
      } catch (e) {
        console.error('Error reading offline queue:', e);
        return [];
      }
    }

    function saveOfflineQueue(queue) {
      try {
        localStorage.setItem(OFFLINE_QUEUE_KEY, JSON.stringify(queue));
        updateQueueBadge();
      } catch (e) {
        console.error('Error saving offline queue:', e);
      }
    }

    function addToOfflineQueue(item) {
      const queue = getOfflineQueue();
      queue.push({
        ...item,
        id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
        timestamp: new Date().toISOString(),
      });
      saveOfflineQueue(queue);
      console.log('üì• Added to offline queue:', item.action);
    }

    function removeFromOfflineQueue(id) {
      const queue = getOfflineQueue();
      const newQueue = queue.filter(item => item.id !== id);
      saveOfflineQueue(newQueue);
    }

    function updateQueueBadge() {
      const queue = getOfflineQueue();
      const badge = document.getElementById('queueBadge');
      if (badge) {
        if (queue.length > 0) {
          badge.textContent = queue.length + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏™‡πà‡∏á';
          badge.style.display = 'inline';
        } else {
          badge.style.display = 'none';
        }
      }
    }

    function showOfflineBar(show) {
      const bar = document.getElementById('offlineBar');
      if (bar) {
        if (show) {
          bar.classList.add('show');
          updateQueueBadge();
        } else {
          bar.classList.remove('show');
        }
      }
    }

    function showSyncingBar(show, text) {
      const bar = document.getElementById('syncingBar');
      const textEl = document.getElementById('syncingText');
      if (bar) {
        if (show) {
          bar.classList.add('show');
          if (textEl && text) textEl.textContent = text;
        } else {
          bar.classList.remove('show');
        }
      }
    }

    async function syncOfflineQueue() {
      if (isSyncing || !isOnline) return;

      const queue = getOfflineQueue();
      if (queue.length === 0) return;

      isSyncing = true;
      showSyncingBar(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ... (0/' + queue.length + ')');

      let successCount = 0;
      let failCount = 0;

      for (let i = 0; i < queue.length; i++) {
        const item = queue[i];
        showSyncingBar(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•... (' + (i + 1) + '/' + queue.length + ')');

        try {
          const formData = new URLSearchParams();
          Object.keys(item.data).forEach(key => {
            formData.append(key, item.data[key]);
          });

          const res = await fetch(WEB_APP_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
            body: formData,
          });
          const json = await res.json();

          if (json.success) {
            removeFromOfflineQueue(item.id);
            successCount++;
            console.log('‚úÖ Synced:', item.action);
          } else {
            failCount++;
            console.error('‚ùå Sync failed:', item.action, json.message);
          }
        } catch (err) {
          failCount++;
          console.error('‚ùå Sync error:', item.action, err);
          // ‡∏´‡∏¢‡∏∏‡∏î sync ‡∏ñ‡πâ‡∏≤ network error (‡∏ô‡πà‡∏≤‡∏à‡∏∞ offline ‡∏≠‡∏µ‡∏Å‡πÅ‡∏•‡πâ‡∏ß)
          if (!navigator.onLine) {
            break;
          }
        }
      }

      isSyncing = false;
      showSyncingBar(false);

      if (successCount > 0) {
        Swal.fire({
          icon: 'success',
          title: '‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
          text: '‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß ' + successCount + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£' + (failCount > 0 ? ' (‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ' + failCount + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)' : ''),
          confirmButtonColor: '#1abc9c',
          timer: 3000,
          timerProgressBar: true,
        });

        // Refresh data if we have a current reference
        if (currentReference) {
          search(true);
        }
      }

      updateQueueBadge();
    }

    function handleOnline() {
      console.log('üü¢ Online');
      isOnline = true;
      showOfflineBar(false);

      // Auto-sync ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤ online
      setTimeout(() => {
        syncOfflineQueue();
      }, 1000);
    }

    function handleOffline() {
      console.log('üî¥ Offline');
      isOnline = false;
      showOfflineBar(true);
    }

    function initOfflineMode() {
      isOnline = navigator.onLine;

      window.addEventListener('online', handleOnline);
      window.addEventListener('offline', handleOffline);

      // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ï‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
      if (!isOnline) {
        showOfflineBar(true);
      }

      // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó badge
      updateQueueBadge();

      // ‡∏ñ‡πâ‡∏≤ online ‡πÅ‡∏•‡∏∞‡∏°‡∏µ queue ‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ sync
      if (isOnline) {
        setTimeout(() => {
          syncOfflineQueue();
        }, 2000);
      }

      console.log('üì∂ Offline mode initialized. Online:', isOnline);
    }

    // ==================== Quick Actions ====================
    let quickActionsHidden = false;

    function getNextPendingStop() {
      if (!lastStops || lastStops.length === 0) return null;

      // ‡∏´‡∏≤ stop ‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à (‡πÑ‡∏°‡πà‡∏°‡∏µ checkinTime ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ checkoutTime)
      for (const stop of lastStops) {
        // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà checkin
        if (!stop.checkinTime) {
          return { stop, action: 'checkin' };
        }
        // ‡∏ñ‡πâ‡∏≤ checkin ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà checkout
        if (stop.checkinTime && !stop.checkoutTime) {
          return { stop, action: 'checkout' };
        }
      }
      return null;
    }

    function updateQuickActions() {
      const container = document.getElementById('quickActions');
      const stopLabel = document.getElementById('quickActionsStop');
      const buttonsDiv = document.getElementById('quickActionsButtons');

      if (!container || !stopLabel || !buttonsDiv) return;

      // ‡∏ñ‡πâ‡∏≤ user ‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏á‡∏≤‡∏ô
      if (quickActionsHidden || !currentReference || !lastStops || lastStops.length === 0) {
        container.classList.remove('show');
        return;
      }

      const next = getNextPendingStop();

      if (!next) {
        // ‡∏ó‡∏∏‡∏Å‡∏à‡∏∏‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß
        container.classList.remove('show');
        return;
      }

      const { stop, action } = next;
      const seq = stop.seq || stop.sequence || '?';
      const destination = stop.destination || stop.destName || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö';

      stopLabel.textContent = '‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà ' + seq + ': ' + destination;

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°
      if (action === 'checkin') {
        buttonsDiv.innerHTML = `
          <button class="btn-checkin" onclick="quickCheckin(${stop.rowIndex}, ${seq})">
            üìç ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô
          </button>
        `;
      } else {
        buttonsDiv.innerHTML = `
          <button class="btn-checkout" onclick="quickCheckout(${stop.rowIndex}, ${seq})">
            ‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå
          </button>
        `;
      }

      container.classList.add('show');
    }

    function quickCheckin(rowIndex, seq) {
      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å startCheckin ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
      startCheckin(rowIndex, seq);
    }

    function quickCheckout(rowIndex, seq) {
      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å startCheckout ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
      startCheckout(rowIndex, seq);
    }

    function hideQuickActions() {
      const container = document.getElementById('quickActions');
      if (container) {
        container.classList.remove('show');
        quickActionsHidden = true;
      }
    }

    function showQuickActions() {
      quickActionsHidden = false;
      updateQuickActions();
    }

    // ==================== Notification System ====================
    const NOTIF_SETTINGS_KEY = 'driverapp_notification_settings';
    let previousStops = null; // ‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö

    const defaultNotifSettings = {
      statusChange: true,      // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
      newJob: true,            // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
      lineMessage: true,       // ‡∏™‡πà‡∏á LINE Message (‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö Backend)
      sound: true,             // ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
    };

    function getNotifSettings() {
      try {
        const data = localStorage.getItem(NOTIF_SETTINGS_KEY);
        return data ? { ...defaultNotifSettings, ...JSON.parse(data) } : defaultNotifSettings;
      } catch (e) {
        return defaultNotifSettings;
      }
    }

    function saveNotifSettings(settings) {
      try {
        localStorage.setItem(NOTIF_SETTINGS_KEY, JSON.stringify(settings));
      } catch (e) {
        console.error('Error saving notification settings:', e);
      }
    }

    function openNotificationSettings() {
      const settings = getNotifSettings();

      Swal.fire({
        title: 'üîî ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô',
        html: `
          <div class="notif-settings">
            <div class="notif-option">
              <div class="notif-option-label">
                <span class="notif-option-icon">üìä</span>
                <div>
                  <div class="notif-option-text">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</div>
                  <div class="notif-option-desc">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó</div>
                </div>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="notifStatusChange" ${settings.statusChange ? 'checked' : ''}>
                <span class="toggle-slider"></span>
              </label>
            </div>

            <div class="notif-option">
              <div class="notif-option-label">
                <span class="notif-option-icon">üÜï</span>
                <div>
                  <div class="notif-option-text">‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</div>
                  <div class="notif-option-desc">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô</div>
                </div>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="notifNewJob" ${settings.newJob ? 'checked' : ''}>
                <span class="toggle-slider"></span>
              </label>
            </div>

            <div class="notif-option">
              <div class="notif-option-label">
                <span class="notif-option-icon">üí¨</span>
                <div>
                  <div class="notif-option-text">LINE Message</div>
                  <div class="notif-option-desc">‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á LINE Chat</div>
                </div>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="notifLineMessage" ${settings.lineMessage ? 'checked' : ''}>
                <span class="toggle-slider"></span>
              </label>
            </div>

            <div class="notif-option">
              <div class="notif-option-label">
                <span class="notif-option-icon">üîä</span>
                <div>
                  <div class="notif-option-text">‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</div>
                  <div class="notif-option-desc">‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</div>
                </div>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="notifSound" ${settings.sound ? 'checked' : ''}>
                <span class="toggle-slider"></span>
              </label>
            </div>
          </div>
        `,
        showCancelButton: true,
        confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
        confirmButtonColor: '#1abc9c',
        preConfirm: () => {
          return {
            statusChange: document.getElementById('notifStatusChange').checked,
            newJob: document.getElementById('notifNewJob').checked,
            lineMessage: document.getElementById('notifLineMessage').checked,
            sound: document.getElementById('notifSound').checked,
          };
        },
      }).then((result) => {
        if (result.isConfirmed) {
          saveNotifSettings(result.value);
          showToast('success', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß', '‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
        }
      });
    }

    // Toast Notification
    let toastId = 0;

    function showToast(type, title, message, duration = 5000) {
      const settings = getNotifSettings();
      const container = document.getElementById('toastContainer');
      if (!container) return;

      const id = ++toastId;
      const iconMap = {
        success: '‚úÖ',
        warning: '‚ö†Ô∏è',
        error: '‚ùå',
        info: '‚ÑπÔ∏è',
        newjob: 'üÜï',
        status: 'üìä',
      };

      const toast = document.createElement('div');
      toast.className = 'toast' + (type === 'warning' ? ' toast-warning' : '') + (type === 'error' ? ' toast-error' : '');
      toast.id = 'toast-' + id;
      toast.innerHTML = `
        <span class="toast-icon">${iconMap[type] || 'üîî'}</span>
        <div class="toast-content">
          <div class="toast-title">${escapeHtml(title)}</div>
          <div class="toast-message">${escapeHtml(message)}</div>
        </div>
        <button class="toast-close" onclick="closeToast(${id})">‚úï</button>
      `;

      container.appendChild(toast);

      // ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î)
      if (settings.sound && (type === 'newjob' || type === 'status')) {
        playNotificationSound();
      }

      // Auto-dismiss
      if (duration > 0) {
        setTimeout(() => closeToast(id), duration);
      }

      return id;
    }

    function closeToast(id) {
      const toast = document.getElementById('toast-' + id);
      if (toast) {
        toast.classList.add('toast-out');
        setTimeout(() => toast.remove(), 300);
      }
    }

    function playNotificationSound() {
      try {
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á beep ‡∏á‡πà‡∏≤‡∏¢‡πÜ ‡∏î‡πâ‡∏ß‡∏¢ Web Audio API
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        gainNode.gain.value = 0.3;

        oscillator.start();
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
        oscillator.stop(audioContext.currentTime + 0.3);
      } catch (e) {
        console.log('Cannot play notification sound');
      }
    }

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô
    function checkForChanges(newStops) {
      const settings = getNotifSettings();

      if (!previousStops || previousStops.length === 0) {
        previousStops = newStops ? [...newStops] : [];
        return;
      }

      if (!newStops || newStops.length === 0) return;

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
      if (settings.newJob && newStops.length > previousStops.length) {
        const newCount = newStops.length - previousStops.length;
        showToast('newjob', '‡∏°‡∏µ‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á‡πÉ‡∏´‡∏°‡πà!', '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô ' + newCount + ' ‡∏à‡∏∏‡∏î');

        // ‡∏™‡πà‡∏á LINE Message ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ß‡πâ
        if (settings.lineMessage) {
          sendLineNotification('‡∏°‡∏µ‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á‡πÉ‡∏´‡∏°‡πà ' + newCount + ' ‡∏à‡∏∏‡∏î');
        }
      }

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
      if (settings.statusChange) {
        for (const newStop of newStops) {
          const oldStop = previousStops.find(s => s.rowIndex === newStop.rowIndex);
          if (oldStop) {
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£ checkin/checkout ‡πÉ‡∏´‡∏°‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            if (!oldStop.checkInTime && newStop.checkInTime) {
              showToast('status', 'Check-in ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà ' + newStop.seq + ': ' + (newStop.destination || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö'));
            }
            if (!oldStop.checkOutTime && newStop.checkOutTime) {
              showToast('status', 'Check-out ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà ' + newStop.seq + ': ' + (newStop.destination || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö'));
            }
          }
        }
      }

      // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó previousStops
      previousStops = newStops ? [...newStops] : [];
    }

    // ‡∏™‡πà‡∏á LINE Message (‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö liff.sendMessages)
    async function sendLineNotification(message) {
      try {
        if (!liff.isInClient()) {
          console.log('Not in LINE app, skipping LINE notification');
          return;
        }

        await liff.sendMessages([
          {
            type: 'text',
            text: 'üîî ' + message,
          },
        ]);
        console.log('LINE notification sent:', message);
      } catch (err) {
        console.error('Failed to send LINE notification:', err);
      }
    }

    // ==================== Trip Dashboard ====================
    let tripStartTime = null;

    function updateTripDashboard(stops) {
      const dashboard = document.getElementById('tripDashboard');
      const refEl = document.getElementById('tripRef');
      const completedEl = document.getElementById('tripCompleted');
      const durationEl = document.getElementById('tripDuration');
      const progressPercentEl = document.getElementById('tripProgressPercent');
      const progressFillEl = document.getElementById('tripProgressFill');
      const stopsMiniEl = document.getElementById('tripStopsMini');
      const extraInfoEl = document.getElementById('tripExtraInfo');

      if (!dashboard) return;

      // ‡∏ã‡πà‡∏≠‡∏ô‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ stops
      if (!stops || stops.length === 0 || !currentReference) {
        dashboard.classList.remove('show');
        return;
      }

      dashboard.classList.add('show');

      // Reference
      if (refEl) {
        refEl.textContent = currentReference;
      }

      // ‡∏ô‡∏±‡∏ö‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à (checkout ‡πÅ‡∏•‡πâ‡∏ß)
      let completedCount = 0;
      let inProgressCount = 0;
      let firstCheckinTime = null;
      let lastCheckoutTime = null;

      stops.forEach(stop => {
        if (stop.checkOutTime) {
          completedCount++;
          // ‡∏´‡∏≤‡πÄ‡∏ß‡∏•‡∏≤ checkout ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
          const coTime = parseThaiDateTime(stop.checkOutTime);
          if (coTime && (!lastCheckoutTime || coTime > lastCheckoutTime)) {
            lastCheckoutTime = coTime;
          }
        } else if (stop.checkInTime) {
          inProgressCount++;
        }

        // ‡∏´‡∏≤‡πÄ‡∏ß‡∏•‡∏≤ checkin ‡πÅ‡∏£‡∏Å
        if (stop.checkInTime) {
          const ciTime = parseThaiDateTime(stop.checkInTime);
          if (ciTime && (!firstCheckinTime || ciTime < firstCheckinTime)) {
            firstCheckinTime = ciTime;
          }
        }
      });

      const totalStops = stops.length;

      // ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à
      if (completedEl) {
        completedEl.textContent = completedCount + '/' + totalStops;
      }

      // ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
      if (durationEl) {
        if (firstCheckinTime) {
          tripStartTime = firstCheckinTime;
          const endTime = lastCheckoutTime || new Date();
          const durationMs = endTime - firstCheckinTime;
          durationEl.textContent = formatDuration(durationMs);
        } else {
          durationEl.textContent = '-';
        }
      }

      // Progress
      const progressPercent = totalStops > 0 ? Math.round((completedCount / totalStops) * 100) : 0;
      if (progressPercentEl) {
        progressPercentEl.textContent = progressPercent + '%';
      }
      if (progressFillEl) {
        progressFillEl.style.width = progressPercent + '%';
      }

      // Mini stop dots
      if (stopsMiniEl) {
        let dotsHtml = '';
        stops.forEach(stop => {
          const seq = stop.seq || '?';
          let dotClass = 'trip-stop-dot';

          if (stop.checkOutTime) {
            dotClass += ' completed';
          } else if (stop.checkInTime) {
            dotClass += ' in-progress';
          } else {
            dotClass += ' pending';
          }

          dotsHtml += '<div class="' + dotClass + '" title="‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà ' + seq + '">' + seq + '</div>';
        });
        stopsMiniEl.innerHTML = dotsHtml;
      }

      // Extra info (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß)
      if (extraInfoEl) {
        if (jobClosed) {
          let extraHtml = '';
          // ‡∏≠‡∏≤‡∏à‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏Ç‡∏≤ ‡∏Ñ‡πà‡∏≤ ‡∏Å‡∏ó‡∏° ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÉ‡∏ô data
          extraHtml += '<div class="trip-extra-item">‚úÖ ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß</div>';
          if (tripEnded) {
            extraHtml += '<div class="trip-extra-item">üèÅ ‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ‡πÅ‡∏•‡πâ‡∏ß</div>';
          }
          extraInfoEl.innerHTML = extraHtml;
          extraInfoEl.style.display = 'flex';
        } else {
          extraInfoEl.style.display = 'none';
        }
      }
    }

    function parseThaiDateTime(str) {
      if (!str) return null;
      try {
        // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: "14/01/2026 10:30:45" ‡∏´‡∏£‡∏∑‡∏≠ "2026-01-14T10:30:45"
        if (str.includes('T')) {
          return new Date(str);
        }

        // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö DD/MM/YYYY HH:mm:ss
        const parts = str.split(' ');
        if (parts.length >= 2) {
          const dateParts = parts[0].split('/');
          if (dateParts.length === 3) {
            const day = parseInt(dateParts[0], 10);
            const month = parseInt(dateParts[1], 10) - 1;
            const year = parseInt(dateParts[2], 10);
            const timeParts = parts[1].split(':');
            const hour = parseInt(timeParts[0] || 0, 10);
            const minute = parseInt(timeParts[1] || 0, 10);
            const second = parseInt(timeParts[2] || 0, 10);
            return new Date(year, month, day, hour, minute, second);
          }
        }
        return null;
      } catch (e) {
        return null;
      }
    }

    function formatDuration(ms) {
      if (!ms || ms < 0) return '-';

      const totalMinutes = Math.floor(ms / 60000);
      const hours = Math.floor(totalMinutes / 60);
      const minutes = totalMinutes % 60;

      if (hours > 0) {
        return hours + ' ‡∏ä‡∏°. ' + minutes + ' ‡∏ô.';
      }
      return minutes + ' ‡∏ô‡∏≤‡∏ó‡∏µ';
    }

    document.addEventListener('DOMContentLoaded', function () {
      loadSavedTheme();
      initLiff();
      initPullToRefresh();
      initGpsMonitor();
      initOfflineMode();

      document
        .getElementById('btnSearch')
        .addEventListener('click', search);

      document
        .getElementById('keyword')
        .addEventListener('keyup', function (e) {
          if (e.key === 'Enter') {
            search();
          }
        });

      document
        .getElementById('btnCloseJob')
        .addEventListener('click', closeJob);

      document
        .getElementById('btnEndTrip')
        .addEventListener('click', openEndTripDialog);

      // Pause/Resume auto-refresh ‡πÄ‡∏°‡∏∑‡πà‡∏≠ user ‡∏≠‡∏≠‡∏Å/‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
      document.addEventListener('visibilitychange', function () {
        if (document.hidden) {
          // User ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ - ‡∏´‡∏¢‡∏∏‡∏î auto-refresh ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
          if (autoRefreshTimer && currentReference) {
            stopAutoRefresh();
            console.log('üîï Page hidden - auto-refresh paused');
          }
        } else {
          // User ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ - refresh ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏° auto-refresh ‡πÉ‡∏´‡∏°‡πà
          if (currentReference) {
            console.log('üëÅÔ∏è Page visible - refreshing and resuming auto-refresh');
            search(true); // silent refresh
            startAutoRefresh();
          }
        }
      });
    });

    window.updateStopStatus = updateStopStatus;
    window.search = search;
    window.closeJob = closeJob;
    window.startCheckin = startCheckin;
    window.startCheckout = startCheckout;
    window.doAlcoholCheck = doAlcoholCheck;
    window.getCurrentPositionAsync = getCurrentPositionAsync;
    window.navigateToStop = navigateToStop;
    window.openEndTripDialog = openEndTripDialog;
    window.saveEndTripSummary = saveEndTripSummary;
    window.startAutoRefresh = startAutoRefresh;
    window.stopAutoRefresh = stopAutoRefresh;
    window.checkGpsStatus = checkGpsStatus;
    window.toggleTheme = toggleTheme;
    window.syncOfflineQueue = syncOfflineQueue;
    window.getOfflineQueue = getOfflineQueue;
    window.quickCheckin = quickCheckin;
    window.quickCheckout = quickCheckout;
    window.hideQuickActions = hideQuickActions;
    window.showQuickActions = showQuickActions;
    window.openNotificationSettings = openNotificationSettings;
    window.showToast = showToast;
    window.closeToast = closeToast;
    window.sendLineNotification = sendLineNotification;
    window.updateTripDashboard = updateTripDashboard;
  </script>
</body>

</html>