<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <meta charset="UTF-8" />
    <title>Driver Tracking</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
      :root {
        --primary: #1abc9c;
        --primary-dark: #16a085;
        --bg: #f4f8f7;
        --text-main: #222;
        --text-sub: #666;
        --card-bg: #ffffff;
        --border-radius: 14px;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI',
          sans-serif;
        background: var(--bg);
        color: var(--text-main);
      }

      .app-shell {
        min-height: 100vh;
        display: flex;
        justify-content: center;
        padding: 12px;
      }

      .container {
        width: 100%;
        max-width: 520px;
      }

      .card {
        background: var(--card-bg);
        border-radius: var(--border-radius);
        padding: 16px 18px 20px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.06);
      }

      .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
      }

      .title {
        font-size: 1.2rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .badge {
        font-size: 0.75rem;
        padding: 4px 10px;
        border-radius: 999px;
        background: rgba(26, 188, 156, 0.1);
        color: var(--primary-dark);
      }

      .status-text {
        font-size: 0.9rem;
        color: var(--text-sub);
        margin-bottom: 10px;
      }

      .field-group {
        margin-bottom: 10px;
      }

      label {
        display: block;
        font-size: 0.8rem;
        color: var(--text-sub);
        margin-bottom: 4px;
      }

      input[type='text'] {
        width: 100%;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid #dce2e0;
        font-size: 0.95rem;
        outline: none;
        transition: border 0.2s, box-shadow 0.2s, background 0.2s;
        background: #f7faf9;
      }

      input[type='text']:focus {
        border-color: var(--primary);
        background: #ffffff;
        box-shadow: 0 0 0 2px rgba(26, 188, 156, 0.18);
      }

      button {
        width: 100%;
        padding: 11px 12px;
        border-radius: 999px;
        border: none;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        background: linear-gradient(135deg, var(--primary), var(--primary-dark));
        color: #ffffff;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: transform 0.12s ease-out, box-shadow 0.12s ease-out,
          opacity 0.15s;
      }

      button:hover {
        transform: translateY(-1px);
        box-shadow: 0 8px 18px rgba(22, 160, 133, 0.28);
      }

      button:active {
        transform: translateY(0);
        box-shadow: none;
        opacity: 0.9;
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
      }

      .btn-small {
        width: auto;
        padding: 6px 11px;
        font-size: 0.82rem;
        border-radius: 999px;
        margin: 4px 6px 0 0;
      }

      .btn-outline {
        background: #ffffff;
        color: var(--primary-dark);
        border: 1px solid rgba(26, 188, 156, 0.35);
        box-shadow: none;
      }

      .btn-outline:hover {
        background: rgba(26, 188, 156, 0.06);
      }

      .summary-card {
        margin-top: 12px;
        padding: 10px 12px;
        border-radius: 10px;
        background: #f7faf9;
        border: 1px solid #e3ebe8;
        font-size: 0.88rem;
      }

      .summary-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 4px;
      }

      .summary-label {
        color: var(--text-sub);
      }

      .summary-value {
        font-weight: 600;
      }

      .timeline-container {
        margin-top: 14px;
      }

      .timeline-title {
        font-weight: 600;
        font-size: 0.95rem;
        margin-bottom: 6px;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .timeline {
        position: relative;
        margin: 0;
        padding: 4px 0 0 20px;
        list-style: none;
      }

      .timeline::before {
        content: '';
        position: absolute;
        left: 9px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: linear-gradient(
          to bottom,
          rgba(26, 188, 156, 0.6),
          rgba(26, 188, 156, 0.1)
        );
      }

      .timeline-item {
        position: relative;
        margin-bottom: 14px;
      }

      .timeline-marker {
        position: absolute;
        left: -1px;
        top: 6px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #ffffff;
        border: 2px solid var(--primary);
        box-shadow: 0 0 0 2px rgba(26, 188, 156, 0.15);
      }

      .timeline-content {
        margin-left: 14px;
        background: #ffffff;
        border-radius: 12px;
        padding: 8px 10px;
        border: 1px solid #e4ece9;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.04);
      }

      .timeline-header-row {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        margin-bottom: 4px;
      }

      .timeline-stop-label {
        font-size: 0.85rem;
        font-weight: 700;
        color: var(--primary-dark);
      }

      .timeline-status {
        font-size: 0.75rem;
        padding: 2px 8px;
        border-radius: 999px;
        background: rgba(22, 160, 133, 0.06);
        color: var(--primary-dark);
      }

      .timeline-sub {
        font-size: 0.85rem;
        color: var(--text-sub);
        margin-bottom: 2px;
      }

      .pill {
        display: inline-block;
        margin-top: 4px;
        padding: 3px 7px;
        font-size: 0.75rem;
        border-radius: 999px;
        background: rgba(26, 188, 156, 0.08);
        color: var(--primary-dark);
      }

      .materials-text {
        font-size: 0.8rem;
        color: #444;
        margin-top: 4px;
      }

      .footer-note {
        margin-top: 8px;
        font-size: 0.78rem;
        color: var(--text-sub);
        text-align: center;
      }

      .hidden {
        display: none;
      }

      @media (max-width: 480px) {
        .card {
          padding: 14px 14px 18px;
        }
        .title {
          font-size: 1.05rem;
        }
        button {
          font-size: 0.9rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="app-shell">
      <div class="container">
        <div class="card">
          <div class="header">
            <div class="title">
              üöö Driver Tracking
              <span class="badge">Online</span>
            </div>
          </div>

          <div id="status" class="status-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å LINE...</div>

          <div class="field-group">
            <label for="keyword">‡πÄ‡∏•‡∏Ç‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏á‡∏≤‡∏ô (Reference No.)</label>
            <input
              id="keyword"
              type="text"
              placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç Reference ‡πÄ‡∏ä‡πà‡∏ô 2511S15403"
            />
          </div>

          <button id="btnSearch">
            <span>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ / ‡∏î‡∏∂‡∏á‡∏á‡∏≤‡∏ô</span>
          </button>

          <!-- summary -->
          <div id="summary" class="summary-card hidden"></div>

          <!-- timeline -->
          <div id="timelineContainer" class="timeline-container hidden">
            <div class="timeline-title">
              ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
              <span style="font-size:0.8rem;color:var(--text-sub);">
                (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á)
              </span>
            </div>
            <ul id="timeline" class="timeline"></ul>
          </div>

          <div class="footer-note">
            ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Check-in / Check-out ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡πà‡∏á Flex Message ‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ä‡∏ó‡πÉ‡∏´‡πâ‡∏î‡πâ‡∏ß‡∏¢
          </div>
        </div>
      </div>
    </div>

    <script>
      // TODO: ‡πÅ‡∏Å‡πâ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Ç‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á
      const LIFF_ID = '2007705394-NGJXjBkn';
      const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwSoRXLK1AlFluo7Yk28pDs5myqpjxlR6yJ_E3-RB4rw5NGVMmAm5g9jItQrBvfw3Fu/exec'; 
      let currentUserId = '';
      let currentReference = '';
      let lastStops = []; // ‡πÄ‡∏Å‡πá‡∏ö stops ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡∏™‡πà‡∏á Flex

      /* ---------- SweetAlert Helpers ---------- */

      function showLoading(message) {
        Swal.fire({
          title: message || '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...',
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          },
        });
      }

      function closeLoading() {
        Swal.close();
      }

      function showError(message) {
        Swal.fire({
          icon: 'error',
          title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
          text: message || '‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
          confirmButtonColor: '#1abc9c',
        });
      }

      function showSuccess(title, text) {
        Swal.fire({
          icon: 'success',
          title: title || '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
          text: text || '',
          confirmButtonColor: '#1abc9c',
        });
      }

      function showInfo(title, text) {
        Swal.fire({
          icon: 'info',
          title: title || '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô',
          text: text || '',
          confirmButtonColor: '#1abc9c',
        });
      }

      /* ---------- LIFF Init ---------- */

      async function initLiff() {
        try {
          await liff.init({ liffId: LIFF_ID });

          if (!liff.isLoggedIn()) {
            liff.login();
            return;
          }

          const profile = await liff.getProfile();
          currentUserId = profile.userId;
          const statusEl = document.getElementById('status');
          statusEl.textContent = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏∏‡∏ì ${profile.displayName} üëã`;

        } catch (err) {
          console.error(err);
          document.getElementById('status').innerText =
            '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î LIFF';
          showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å LIFF ‡πÑ‡∏î‡πâ');
        }
      }

      /* ---------- Search Flow ---------- */

      async function search() {
        const keywordInput = document.getElementById('keyword');
        const keyword = keywordInput.value.trim();
        const btn = document.getElementById('btnSearch');

        if (!keyword) {
          showInfo('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç Reference', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡πÄ‡∏•‡∏Ç‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤');
          return;
        }

        btn.disabled = true;
        showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö...');

        try {
          const url =
            WEB_APP_URL +
            '?action=search&keyword=' +
            encodeURIComponent(keyword) +
            '&userId=' +
            encodeURIComponent(currentUserId);

          const res = await fetch(url);
          const json = await res.json();

          closeLoading();

          if (!json.success) {
            clearResult();
            showError(json.message || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô');
            return;
          }

          const d = json.data;
          const stops = d.stops || [];
          const shipmentNos = d.shipmentNos || [];

          lastStops = stops;
          currentReference = d.referenceNo || keyword;

          renderSummary(d);
          renderTimeline(stops);

          if (stops.length === 0) {
            showInfo(
              '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á',
              'Reference ‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö jobdata ‡∏Ñ‡∏£‡∏±‡∏ö'
            );
          }
        } catch (err) {
          console.error(err);
          closeLoading();
          showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå');
        } finally {
          btn.disabled = false;
        }
      }

      function clearResult() {
        document.getElementById('summary').classList.add('hidden');
        document.getElementById('timelineContainer').classList.add('hidden');
        document.getElementById('summary').innerHTML = '';
        document.getElementById('timeline').innerHTML = '';
        lastStops = [];
      }

      function renderSummary(d) {
        const summaryEl = document.getElementById('summary');
        const stops = d.stops || [];
        const shipmentNos = d.shipmentNos || [];

        let shipmentSummary = '-';
        if (shipmentNos.length === 1) {
          shipmentSummary = shipmentNos[0];
        } else if (shipmentNos.length > 1) {
          shipmentSummary = shipmentNos.join(', ');
        }

        const totalQtyAll = stops.reduce((acc, s) => {
          if (typeof s.totalQty === 'number') return acc + s.totalQty;
          return acc;
        }, 0);

        summaryEl.innerHTML = `
          <div class="summary-row">
            <span class="summary-label">Reference</span>
            <span class="summary-value">${d.referenceNo || '-'}</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Shipment</span>
            <span class="summary-value">${shipmentSummary}</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á</span>
            <span class="summary-value">${d.totalStops || stops.length} ‡∏à‡∏∏‡∏î</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏£‡∏ß‡∏°‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</span>
            <span class="summary-value">${totalQtyAll || 0}</span>
          </div>
        `;

        summaryEl.classList.remove('hidden');
      }

      function renderTimeline(stops) {
        const container = document.getElementById('timelineContainer');
        const ul = document.getElementById('timeline');
        ul.innerHTML = '';

        if (!stops || stops.length === 0) {
          container.classList.add('hidden');
          return;
        }

        stops.forEach((stop) => {
          const hasCheckIn = !!stop.checkInTime;
          const hasCheckOut = !!stop.checkOutTime;

          let statusLabel = stop.status || '-';

          // ‡∏õ‡∏∏‡πà‡∏° Check-in / Check-out
          let btnHtml = '';

          if (!hasCheckIn) {
            btnHtml += `
              <button class="btn-small btn-outline"
                onclick="updateStopStatus(${stop.rowIndex}, 'IN_PROGRESS', 'checkin', ${stop.seq})">
                Check-in
              </button>
            `;
          }

          if (hasCheckIn && !hasCheckOut) {
            btnHtml += `
              <button class="btn-small"
                onclick="updateStopStatus(${stop.rowIndex}, 'DONE', 'checkout', ${stop.seq})">
                Check-out
              </button>
            `;
          }

          // materials summary (text)
          let materialsText = '';
          if (stop.materials && stop.materials.length > 0) {
            const parts = stop.materials.map((m) => {
              const name = m.materialDesc || m.material || '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
              const qty = m.totalQty || 0;
              return `${name} ${qty}`;
            });
            materialsText = parts.join(' ‚Ä¢ ');
          }

          const li = document.createElement('li');
          li.className = 'timeline-item';
          li.innerHTML = `
            <span class="timeline-marker"></span>
            <div class="timeline-content">
              <div class="timeline-header-row">
                <div class="timeline-stop-label">
                  Stop ${stop.seq} ‚Ä¢ ${stop.destination1 || '-'}
                </div>
                <div class="timeline-status">${statusLabel}</div>
              </div>
              <div class="timeline-sub">
                ${stop.destination2 || ''}
              </div>
              <div class="timeline-sub">
                <b>Shipment:</b> ${stop.shipmentNo || '-'}
              </div>
              <div class="timeline-sub">
                <b>Check-in:</b> ${stop.checkInTime || '-'}
              </div>
              <div class="timeline-sub">
                <b>Check-out:</b> ${stop.checkOutTime || '-'}
              </div>
              ${
                materialsText
                  ? `<div class="materials-text"><b>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</b> ${materialsText}</div>`
                  : ''
              }
              <div style="margin-top:6px;">
                ${btnHtml}
              </div>
            </div>
          `;
          ul.appendChild(li);
        });

        container.classList.remove('hidden');
      }

      /* ---------- Geolocation & Update Stop ---------- */

      function getCurrentPositionAsync() {
        return new Promise((resolve, reject) => {
          if (!navigator.geolocation) {
            reject(new Error('‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á'));
            return;
          }
          navigator.geolocation.getCurrentPosition(
            (pos) => resolve(pos),
            (err) => reject(err),
            { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
          );
        });
      }

      async function updateStopStatus(rowIndex, newStatus, type, seq) {
        try {
          showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏à‡∏≤‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå...');

          let pos;
          try {
            pos = await getCurrentPositionAsync();
          } catch (err) {
            console.error(err);
            closeLoading();
            showError(
              '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏à‡∏≤‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î GPS ‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á'
            );
            return;
          }

          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;

          showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á...');

          const url =
            WEB_APP_URL +
            '?action=updatestop' +
            '&rowIndex=' +
            encodeURIComponent(rowIndex) +
            '&status=' +
            encodeURIComponent(newStatus) +
            '&type=' +
            encodeURIComponent(type) +
            '&userId=' +
            encodeURIComponent(currentUserId) +
            '&lat=' +
            encodeURIComponent(lat) +
            '&lng=' +
            encodeURIComponent(lng);

          const res = await fetch(url);
          const json = await res.json();

          closeLoading();

          if (!json.success) {
            showError(json.message || '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            return;
          }

          // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
          showSuccess('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', json.message || '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');

          // ‡∏™‡πà‡∏á Flex Message ‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ä‡∏ó
          const stopInfo = json.stop || null;
          if (stopInfo) {
            sendFlexCheckInOut(type, stopInfo);
          }

          // refresh timeline ‡∏î‡πâ‡∏ß‡∏¢ reference ‡πÄ‡∏î‡∏¥‡∏°
          if (currentReference) {
            document.getElementById('keyword').value = currentReference;
            await search();
          }
        } catch (err) {
          console.error(err);
          closeLoading();
          showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞');
        }
      }

      /* ---------- Flex Message ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Check-in / Check-out ---------- */

      function sendFlexCheckInOut(type, stop) {
        try {
          if (!liff.isInClient()) {
            // ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ú‡πà‡∏≤‡∏ô browser ‡∏õ‡∏Å‡∏ï‡∏¥ (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÉ‡∏ô LINE) ‚Üí ‡∏™‡πà‡∏á Flex ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
            return;
          }

          const isCheckIn = type === 'checkin';
          const title = isCheckIn ? 'Check-in ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : 'Check-out ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
          const colorBar = isCheckIn ? '#1abc9c' : '#16a085';

          const timeText = isCheckIn
            ? stop.checkInTime || ''
            : stop.checkOutTime || '';

          const bubble = {
            type: 'bubble',
            size: 'mega',
            body: {
              type: 'box',
              layout: 'vertical',
              paddingAll: '16px',
              contents: [
                {
                  type: 'box',
                  layout: 'baseline',
                  contents: [
                    {
                      type: 'filler',
                    },
                    {
                      type: 'box',
                      layout: 'vertical',
                      contents: [],
                      width: '8px',
                      backgroundColor: colorBar,
                      cornerRadius: '999px',
                      height: '40px',
                    },
                  ],
                },
                {
                  type: 'text',
                  text: title,
                  weight: 'bold',
                  size: 'lg',
                  color: '#16a085',
                  margin: 'md',
                },
                {
                  type: 'text',
                  text: `Reference: ${stop.referenceNo || '-'}`,
                  size: 'sm',
                  color: '#555555',
                  wrap: true,
                  margin: 'sm',
                },
                {
                  type: 'text',
                  text: `Shipment: ${stop.shipmentNo || '-'}`,
                  size: 'sm',
                  color: '#555555',
                  wrap: true,
                  margin: 'xs',
                },
                {
                  type: 'separator',
                  margin: 'md',
                },
                {
                  type: 'box',
                  layout: 'vertical',
                  margin: 'md',
                  spacing: 'sm',
                  contents: [
                    {
                      type: 'text',
                      text: stop.destination2 || stop.destination1 || '‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á',
                      size: 'md',
                      weight: 'bold',
                      wrap: true,
                    },
                    {
                      type: 'text',
                      text: timeText ? `‡πÄ‡∏ß‡∏•‡∏≤: ${timeText}` : '',
                      size: 'sm',
                      color: '#555555',
                      wrap: true,
                    },
                    {
                      type: 'text',
                      text: `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${stop.status || '-'}`,
                      size: 'sm',
                      color: '#555555',
                      wrap: true,
                      margin: 'xs',
                    },
                  ],
                },
              ],
            },
            styles: {
              body: {
                backgroundColor: '#ffffff',
              },
            },
          };

          liff.sendMessages([
            {
              type: 'flex',
              altText: title,
              contents: bubble,
            },
          ]).catch((err) => {
            console.error('sendMessages error', err);
          });
        } catch (err) {
          console.error('sendFlexCheckInOut error', err);
        }
      }

      /* ---------- Event Binding ---------- */

      document.addEventListener('DOMContentLoaded', () => {
        initLiff();

        document
          .getElementById('btnSearch')
          .addEventListener('click', search);

        document
          .getElementById('keyword')
          .addEventListener('keyup', (e) => {
            if (e.key === 'Enter') {
              search();
            }
          });
      });

      // export ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å onclick ‡πÑ‡∏î‡πâ
      window.updateStopStatus = updateStopStatus;
      window.search = search;
    </script>
  </body>
</html>
