<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <meta charset="UTF-8" />
    <title>Driver Tracking</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
      :root {
        --primary: #1abc9c;
        --primary-dark: #16a085;
        --bg: #f4f8f7;
        --text-main: #222;
        --text-sub: #666;
        --card-bg: #ffffff;
        --border-radius: 14px;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI',
          sans-serif;
        background: var(--bg);
        color: var(--text-main);
      }

      .app {
        max-width: 600px;
        margin: 0 auto;
        padding: 16px;
      }

      .card {
        background: var(--card-bg);
        border-radius: var(--border-radius);
        padding: 14px 14px 16px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
        margin-bottom: 12px;
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 6px;
      }

      .title {
        font-size: 1.1rem;
        font-weight: 600;
      }

      .subtitle {
        font-size: 0.8rem;
        color: var(--text-sub);
      }

      label {
        font-size: 0.8rem;
        color: var(--text-sub);
        display: block;
        margin-bottom: 4px;
      }

      input[type='text'] {
        width: 100%;
        border-radius: 999px;
        border: 1px solid #ddd;
        padding: 8px 12px;
        font-size: 0.9rem;
        outline: none;
      }

      input[type='text']:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 1px rgba(26, 188, 156, 0.25);
      }

      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 999px;
        border: none;
        padding: 8px 14px;
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        transition: transform 0.1s ease, box-shadow 0.1s ease,
          background 0.1s ease;
      }

      .btn:active {
        transform: translateY(1px);
        box-shadow: none;
      }

      .btn-primary {
        background: var(--primary);
        color: #fff;
        box-shadow: 0 3px 8px rgba(26, 188, 156, 0.35);
      }

      .btn-primary:disabled {
        background: #b2dfd7;
        box-shadow: none;
        cursor: default;
      }

      .btn-secondary {
        background: #fff;
        color: var(--primary-dark);
        border: 1px solid var(--primary);
      }

      .btn-small {
        font-size: 0.78rem;
        padding: 4px 9px;
        border-radius: 999px;
        border: none;
        cursor: pointer;
        background: #fff;
        border: 1px solid #ccc;
      }

      .btn-small.btn-outline {
        background: #fff;
        color: var(--primary-dark);
        border-color: var(--primary);
      }

      .btn-small.btn-warning {
        background: #f39c12;
        color: #fff;
        border-color: #f39c12;
      }

      .btn-small:disabled {
        opacity: 0.5;
        cursor: default;
      }

      .section-header {
        font-size: 0.9rem;
        font-weight: 600;
        margin-bottom: 6px;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 0.7rem;
        background: #ecf0f1;
        color: #555;
        margin-right: 4px;
        margin-bottom: 4px;
      }

      .pill-success {
        background: #d1f2eb;
        color: #148f77;
      }

      .pill-danger {
        background: #fdecea;
        color: #c0392b;
      }

      .timeline {
        margin-top: 6px;
      }

      .stop-card {
        border-radius: 10px;
        border: 1px solid #eee;
        padding: 8px 8px 10px;
        margin-bottom: 8px;
        background: #fafafa;
      }

      .stop-header {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        margin-bottom: 4px;
      }

      .stop-title {
        font-size: 0.9rem;
        font-weight: 600;
      }

      .stop-badge {
        font-size: 0.7rem;
        padding: 2px 7px;
        border-radius: 999px;
        background: #e8f6f3;
        color: #148f77;
      }

      .stop-body {
        font-size: 0.78rem;
        color: #555;
      }

      .stop-footer {
        margin-top: 6px;
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        align-items: center;
      }

      .hidden {
        display: none !important;
      }

      .badge-status {
        font-size: 0.75rem;
        padding: 2px 8px;
        border-radius: 999px;
      }

      .badge-status-new {
        background: #fdf2e9;
        color: #d35400;
      }

      .badge-status-done {
        background: #d1f2eb;
        color: #148f77;
      }

      .badge-status-review {
        background: #ebf5fb;
        color: #2471a3;
      }

      .text-muted {
        color: #888;
      }

      .alcohol-list {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
      }

      .alcohol-driver {
        font-size: 0.78rem;
        padding: 3px 8px;
        border-radius: 999px;
        border: 1px solid #ddd;
      }

      .alcohol-driver.done {
        background: #d1f2eb;
        border-color: #16a085;
        color: #148f77;
      }

      .footer-note {
        font-size: 0.75rem;
        color: #999;
        text-align: center;
        margin-top: 6px;
      }

      @media (max-width: 400px) {
        .btn {
          width: 100%;
          justify-content: center;
        }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <!-- ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏á‡∏≤‡∏ô + ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô -->
      <div class="card">
        <div class="card-header">
          <div>
            <div class="title">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏á‡∏≤‡∏ô</div>
            <div class="subtitle">‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç Reference ‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</div>
          </div>
          <div
            id="userStatusTag"
            class="pill"
            style="display:none;"
          ></div>
        </div>

        <div style="margin-bottom:8px;">
          <label for="keyword">‡πÄ‡∏•‡∏Ç Reference</label>
          <input
            type="text"
            id="keyword"
            placeholder="‡πÄ‡∏ä‡πà‡∏ô 1234567890"
          />
        </div>

        <div style="display:flex;flex-direction:column;gap:6px;margin-top:4px;">
          <button
            id="btnSearch"
            class="btn btn-primary"
          >
            ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ / ‡∏î‡∏∂‡∏á‡∏á‡∏≤‡∏ô
          </button>
          <button
            id="btnAccept"
            class="btn btn-secondary"
            disabled
          >
            ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô
          </button>
        </div>

        <div class="footer-note">
          ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏Å‡∏î "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô"
        </div>
      </div>

      <!-- ‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏≤‡∏ô -->
      <div
        id="summaryCard"
        class="card hidden"
      >
        <div class="card-header">
          <div>
            <div class="title">‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏≤‡∏ô</div>
            <div
              id="summarySubtitle"
              class="subtitle"
            ></div>
          </div>
          <div id="summaryStatus"></div>
        </div>

        <div id="summaryBody"></div>
      </div>

      <!-- ‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå -->
      <div
        id="alcoholCard"
        class="card hidden"
      >
        <div class="card-header">
          <div>
            <div class="title">‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡∏±‡∏î‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå</div>
            <div class="subtitle">
              ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏Ç‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ‡∏ï‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠
            </div>
          </div>
        </div>

        <div id="alcoholBody"></div>

        <div style="margin-top:8px;">
          <button
            id="btnAlcohol"
            class="btn btn-secondary"
          >
            ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå
          </button>
        </div>
      </div>

      <!-- Timeline Stops -->
      <div
        id="timelineCard"
        class="card hidden"
      >
        <div class="card-header">
          <div>
            <div class="title">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏á‡∏≤‡∏ô</div>
            <div class="subtitle">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á</div>
          </div>
        </div>

        <div
          id="timelineBody"
          class="timeline"
        ></div>

        <div
          id="closeJobContainer"
          class="hidden"
          style="margin-top:10px;border-top:1px dashed #eee;padding-top:8px;"
        >
          <button
            id="btnCloseJob"
            class="btn btn-primary"
          >
            ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô / ‡∏£‡∏ñ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
          </button>
        </div>
      </div>
    </div>

    <script>
      // üëá ‡πÉ‡∏™‡πà LIFF ID ‡∏Ç‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
      const LIFF_ID = '2007705394-NGJXjBkn';

      // ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á Web App (Apps Script) ‡∏à‡∏≤‡∏Å‡∏ù‡∏±‡πà‡∏á server
      const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxn8IxIhL9zdO1QMEyAZ8TThppvApILg7oyGdrPFeKU7L83ClgxxmTKz0bhj0u5ZJM/exec';

      let currentUserId = '';
      let currentUserStatus = '';
      let currentReference = '';
      let lastStops = [];
      let currentDrivers = [];
      let currentCheckedDrivers = [];
      let alcoholAllDone = false;
      let jobClosed = false;
      let jobAccepted = false;

      // ---------- SweetAlert Helper ----------
      function showLoading(text) {
        Swal.fire({
          title: text || '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...',
          didOpen: () => {
            Swal.showLoading();
          },
          allowOutsideClick: false,
          allowEscapeKey: false,
          showConfirmButton: false,
        });
      }

      function closeLoading() {
        Swal.close();
      }

      function showError(title, text) {
        Swal.fire({
          icon: 'error',
          title: title || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
          text: text || '',
          confirmButtonColor: '#e74c3c',
        });
      }

      function showSuccess(title, text) {
        Swal.fire({
          icon: 'success',
          title: title || '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
          text: text || '',
          confirmButtonColor: '#1abc9c',
        });
      }

      function showInfo(title, text) {
        Swal.fire({
          icon: 'info',
          title: title || '',
          text: text || '',
          confirmButtonColor: '#3498db',
        });
      }

      // ---------- Geo Helper ----------
      function getCurrentPositionAsync() {
        return new Promise((resolve, reject) => {
          if (!navigator.geolocation) {
            reject(new Error('‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á'));
            return;
          }

          navigator.geolocation.getCurrentPosition(
            (pos) => resolve(pos),
            (err) => reject(err),
            {
              enableHighAccuracy: true,
              timeout: 15000,
              maximumAge: 0,
            }
          );
        });
      }

      // ---------- Signature Pad ----------
      function initSwalSignaturePad(canvasId, clearBtnId) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;

        const ctx = canvas.getContext('2d');
        ctx.strokeStyle = '#333';
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';

        let drawing = false;
        let lastX = 0;
        let lastY = 0;

        function getPos(e) {
          const rect = canvas.getBoundingClientRect();
          if (e.touches && e.touches.length > 0) {
            return {
              x: e.touches[0].clientX - rect.left,
              y: e.touches[0].clientY - rect.top,
            };
          } else {
            return {
              x: e.clientX - rect.left,
              y: e.clientY - rect.top,
            };
          }
        }

        function start(e) {
          e.preventDefault();
          drawing = true;
          const pos = getPos(e);
          lastX = pos.x;
          lastY = pos.y;
        }

        function move(e) {
          if (!drawing) return;
          e.preventDefault();
          const pos = getPos(e);
          ctx.beginPath();
          ctx.moveTo(lastX, lastY);
          ctx.lineTo(pos.x, pos.y);
          ctx.stroke();
          lastX = pos.x;
          lastY = pos.y;
        }

        function end(e) {
          drawing = false;
        }

        canvas.addEventListener('mousedown', start);
        canvas.addEventListener('mousemove', move);
        canvas.addEventListener('mouseup', end);
        canvas.addEventListener('mouseleave', end);

        canvas.addEventListener('touchstart', start, { passive: false });
        canvas.addEventListener('touchmove', move, { passive: false });
        canvas.addEventListener('touchend', end, { passive: false });

        const clearBtn = document.getElementById(clearBtnId);
        if (clearBtn) {
          clearBtn.addEventListener('click', () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
          });
        }
      }

      // ---------- UI Helpers ----------
      function clearResult() {
        currentReference = '';
        lastStops = [];
        currentDrivers = [];
        currentCheckedDrivers = [];
        alcoholAllDone = false;
        jobClosed = false;
        jobAccepted = false;

        document.getElementById('summaryCard').classList.add('hidden');
        document.getElementById('alcoholCard').classList.add('hidden');
        document.getElementById('timelineCard').classList.add('hidden');
        document.getElementById('timelineBody').innerHTML = '';
        document.getElementById('closeJobContainer').classList.add('hidden');

        updateAcceptButtonState();
      }

      function updateAcceptButtonState() {
        const btnAccept = document.getElementById('btnAccept');
        if (!btnAccept) return;

        if (!currentReference) {
          btnAccept.disabled = true;
          btnAccept.textContent = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô';
          return;
        }

        if (jobClosed) {
          btnAccept.disabled = true;
          btnAccept.textContent = '‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß';
          return;
        }

        if (jobAccepted) {
          btnAccept.disabled = true;
          btnAccept.textContent = '‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß';
        } else {
          btnAccept.disabled = false;
          btnAccept.textContent = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô';
        }
      }

      function renderSummary(data) {
        const card = document.getElementById('summaryCard');
        const subtitle = document.getElementById('summarySubtitle');
        const body = document.getElementById('summaryBody');
        const statusDiv = document.getElementById('summaryStatus');

        if (!data) {
          card.classList.add('hidden');
          return;
        }

        card.classList.remove('hidden');

        const ref = data.referenceNo || '';
        const shipmentNo = data.shipmentNo || '';
        const totalStops = data.totalStops || 0;

        subtitle.textContent =
          'Reference: ' +
          ref +
          (shipmentNo ? ' ‚Ä¢ Shipment: ' + shipmentNo : '');

        const alcoholInfo =
          currentDrivers.length > 0
            ? `‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå: ${
                alcoholAllDone ? '‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß' : '‡∏¢‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö'
              } (${currentCheckedDrivers.length}/${currentDrivers.length})`
            : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏Ç‡∏±‡∏ö‡πÉ‡∏ô shipment';

        body.innerHTML = `
          <div style="font-size:0.86rem;line-height:1.5;">
            ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏∏‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <b>${totalStops}</b><br/>
            ${alcoholInfo}
          </div>
        `;

        let statusHtml = '';
        if (jobClosed) {
          statusHtml =
            '<span class="badge-status badge-status-done">‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>';
        } else if (jobAccepted) {
          statusHtml =
            '<span class="badge-status badge-status-review">‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>';
        } else {
          statusHtml =
            '<span class="badge-status badge-status-new">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô</span>';
        }
        statusDiv.innerHTML = statusHtml;
      }

      function renderAlcoholSection() {
        const card = document.getElementById('alcoholCard');
        const body = document.getElementById('alcoholBody');
        const btn = document.getElementById('btnAlcohol');

        if (!currentReference || currentDrivers.length === 0) {
          card.classList.add('hidden');
          return;
        }

        card.classList.remove('hidden');

        const items = currentDrivers
          .map((name) => {
            const done = currentCheckedDrivers.includes(name);
            return `<span class="alcohol-driver ${
              done ? 'done' : ''
            }">${name}${done ? ' ‚úì' : ''}</span>`;
          })
          .join('');

        body.innerHTML = `
          <div class="alcohol-list">
            ${items}
          </div>
          <div class="footer-note" style="margin-top:6px;">
            ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ö‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏´‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•
          </div>
        `;

        btn.disabled = !jobAccepted || jobClosed;
      }

      function renderTimeline(stops) {
        const card = document.getElementById('timelineCard');
        const body = document.getElementById('timelineBody');
        const closeJobContainer = document.getElementById('closeJobContainer');

        if (!stops || stops.length === 0) {
          card.classList.add('hidden');
          body.innerHTML = '';
          closeJobContainer.classList.add('hidden');
          return;
        }

        card.classList.remove('hidden');

        let html = '';
        let allCheckout = true;

        stops.forEach((stop) => {
          const isOrigin = !!stop.isOriginStop;
          const status = stop.status || 'NEW';
          const hasCheckIn = !!stop.checkInTime;
          const hasCheckOut = !!stop.checkOutTime;
          const hasFuel = !!stop.fuelingTime;
          const hasUnloadDone = !!stop.unloadDoneTime;
          const hasReviewed = !!stop.reviewedTime;

          if (!hasCheckOut) {
            allCheckout = false;
          }

          let statusLabel = '';
          if (status === 'JOB_DONE') {
            statusLabel =
              '<span class="badge-status badge-status-done">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</span>';
          } else if (status === 'REVIEWED') {
            statusLabel =
              '<span class="badge-status badge-status-review">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>';
          } else if (status === 'NEW') {
            statusLabel =
              '<span class="badge-status badge-status-new">‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô</span>';
          } else {
            statusLabel = `<span class="badge-status badge-status-review">${status}</span>`;
          }

          let subtitle = '';
          if (isOrigin) {
            subtitle = '‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á (Origin)';
          } else {
            subtitle = '‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á';
          }

          const distanceText =
            stop.distanceKm !== '' && stop.distanceKm != null
              ? `‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á: ${stop.distanceKm} ‡∏Å‡∏°.`
              : '';

          let btnHtml = '';

          if (!jobAccepted || jobClosed) {
            btnHtml =
              '<div style="font-size:0.78rem;color:#c0392b;">' +
              (jobClosed
                ? '‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß'
                : '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô') +
              '</div>';
          } else {
            if (isOrigin) {
              if (!hasCheckIn) {
                btnHtml +=
                  '<button class="btn-small btn-outline" ' +
                  'onclick="startCheckin(' +
                  stop.rowIndex +
                  ', ' +
                  stop.seq +
                  ')">Check-in</button>';
              } else if (!hasCheckOut) {
                btnHtml +=
                  '<button class="btn-small" ' +
                  'onclick="updateStopStatus(' +
                  stop.rowIndex +
                  ", 'CHECKOUT', 'checkout', " +
                  stop.seq +
                  ')">Check-out</button>';
              }
            } else {
              if (!hasCheckIn) {
                btnHtml +=
                  '<button class="btn-small btn-outline" ' +
                  'onclick="startCheckin(' +
                  stop.rowIndex +
                  ', ' +
                  stop.seq +
                  ')">Check-in</button>';
              } else if (!hasFuel) {
                btnHtml +=
                  '<button class="btn-small btn-warning" ' +
                  'onclick="updateStopStatus(' +
                  stop.rowIndex +
                  ", 'FUELING', 'fuel', " +
                  stop.seq +
                  ')">‡∏•‡∏á‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô</button>';
              } else if (!hasUnloadDone) {
                btnHtml +=
                  '<button class="btn-small btn-outline" ' +
                  'onclick="updateStopStatus(' +
                  stop.rowIndex +
                  ", 'UNLOAD_DONE', 'unload', " +
                  stop.seq +
                  ')">‡∏•‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à</button>';
              } else if (!hasReviewed) {
                btnHtml +=
                  '<button class="btn-small btn-outline" ' +
                  'onclick="startReview(' +
                  stop.rowIndex +
                  ', ' +
                  stop.seq +
                  ')">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</button>';
              } else if (!hasCheckOut) {
                btnHtml +=
                  '<button class="btn-small" ' +
                  'onclick="updateStopStatus(' +
                  stop.rowIndex +
                  ", 'CHECKOUT', 'checkout', " +
                  stop.seq +
                  ')">Check-out</button>';
              }
            }
          }

          const materialsText =
            stop.materials && stop.materials.length
              ? stop.materials
                  .map(
                    (m) =>
                      `${m.materialDesc || m.material || ''} (${m.totalQty})`
                  )
                  .join(', ')
              : '';

          html += `
            <div class="stop-card">
              <div class="stop-header">
                <div>
                  <div class="stop-title">
                    #${stop.seq}. ${
            stop.destination2 || stop.destination1 || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á'
          }
                  </div>
                  <div class="text-muted" style="font-size:0.75rem;">
                    ${subtitle}
                  </div>
                </div>
                <div>${statusLabel}</div>
              </div>
              <div class="stop-body">
                ${
                  distanceText
                    ? `<div style="margin-bottom:2px;">${distanceText}</div>`
                    : ''
                }
                ${
                  materialsText
                    ? `<div style="font-size:0.75rem;color:#777;">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ${materialsText}</div>`
                    : ''
                }
                <div style="margin-top:4px;font-size:0.72rem;color:#777;">
                  Check-in: ${stop.checkInTime || '-'}<br/>
                  ‡∏•‡∏á‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô: ${stop.fuelingTime || '-'}<br/>
                  ‡∏•‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à: ${stop.unloadDoneTime || '-'}<br/>
                  ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô: ${stop.reviewedTime || '-'}<br/>
                  Check-out: ${stop.checkOutTime || '-'}
                </div>
              </div>
              <div class="stop-footer">
                ${btnHtml}
              </div>
            </div>
          `;
        });

        body.innerHTML = html;

        if (stops.length > 0 && allCheckout && jobAccepted && !jobClosed) {
          closeJobContainer.classList.remove('hidden');
          document.getElementById('btnCloseJob').disabled = false;
        } else {
          closeJobContainer.classList.add('hidden');
        }
      }

      // ---------- ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏á‡∏≤‡∏ô ----------
      async function search() {
        const keywordInput = document.getElementById('keyword');
        const keyword = (keywordInput.value || '').trim();
        if (!keyword) {
          showInfo('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç Reference');
          return;
        }

        const btn = document.getElementById('btnSearch');
        btn.disabled = true;
        showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏á‡∏≤‡∏ô...');

        try {
          const url =
            WEB_APP_URL +
            '?action=search' +
            '&keyword=' +
            encodeURIComponent(keyword) +
            '&userId=' +
            encodeURIComponent(currentUserId || '');

          const res = await fetch(url);
          const json = await res.json();

          closeLoading();

          if (!json.success) {
            clearResult();
            showError('‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', json.message || '');
            return;
          }

          const d = json.data;
          const stops = d.stops || [];

          lastStops = stops;
          currentReference = d.referenceNo || keyword;

          currentDrivers =
            (d.alcohol && Array.isArray(d.alcohol.drivers) && d.alcohol.drivers) ||
            [];
          currentCheckedDrivers =
            (d.alcohol &&
              Array.isArray(d.alcohol.checkedDrivers) &&
              d.alcohol.checkedDrivers) ||
            [];
          currentCheckedDrivers = [...new Set(currentCheckedDrivers)];
          alcoholAllDone =
            currentDrivers.length > 0 &&
            currentDrivers.every((n) => currentCheckedDrivers.includes(n));

          jobClosed = !!d.jobClosed;
          jobAccepted = !!d.isAccepted;

          renderSummary(d);
          renderAlcoholSection();
          renderTimeline(stops);
          updateAcceptButtonState();
        } catch (err) {
          console.error(err);
          closeLoading();
          clearResult();
          showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ');
        } finally {
          btn.disabled = false;
          updateAcceptButtonState();
        }
      }

      // ---------- ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô ----------
      async function acceptJob() {
        if (!currentReference) {
          showInfo('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏•‡∏Ç‡∏á‡∏≤‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô');
          return;
        }

        if (!currentUserId) {
          showError('‡πÑ‡∏°‡πà‡∏û‡∏ö userId ‡∏à‡∏≤‡∏Å LIFF');
          return;
        }

        const btn = document.getElementById('btnAccept');
        btn.disabled = true;
        showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô...');

        try {
          const url =
            WEB_APP_URL +
            '?action=acceptjob' +
            '&reference=' +
            encodeURIComponent(currentReference) +
            '&userId=' +
            encodeURIComponent(currentUserId);

          const res = await fetch(url);
          const json = await res.json();

          closeLoading();

          if (!json.success) {
            showError(json.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ');
            updateAcceptButtonState();
            return;
          }

          const d = json.data || {};
          const stops = d.stops || [];

          lastStops = stops;
          currentReference = d.referenceNo || currentReference;

          currentDrivers =
            (d.alcohol && Array.isArray(d.alcohol.drivers) && d.alcohol.drivers) ||
            [];
          currentCheckedDrivers =
            (d.alcohol &&
              Array.isArray(d.alcohol.checkedDrivers) &&
              d.alcohol.checkedDrivers) ||
            [];
          currentCheckedDrivers = [...new Set(currentCheckedDrivers)];
          alcoholAllDone =
            currentDrivers.length > 0 &&
            currentDrivers.every((n) => currentCheckedDrivers.includes(n));

          jobClosed = !!d.jobClosed;
          jobAccepted = !!d.isAccepted;

          renderSummary(d);
          renderAlcoholSection();
          renderTimeline(stops);
          updateAcceptButtonState();

          showSuccess('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß');
        } catch (err) {
          console.error(err);
          closeLoading();
          showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô');
          updateAcceptButtonState();
        }
      }

      // ---------- Check-in ----------
      async function startCheckin(rowIndex, seq) {
        if (!rowIndex) return;

        const { value: odo } = await Swal.fire({
          title: `Check-in ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà ${seq}`,
          input: 'text',
          inputLabel: '‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏£‡∏ñ',
          inputPlaceholder: '‡πÄ‡∏ä‡πà‡∏ô 123456',
          showCancelButton: true,
          confirmButtonText: '‡πÄ‡∏£‡∏¥‡πà‡∏° Check-in',
          cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
          inputValidator: (value) => {
            if (!value) {
              return '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô Check-in';
            }
            if (!/^\d+(\.\d+)?$/.test(value)) {
              return '‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç';
            }
            return null;
          },
        });

        if (!odo) return;

        try {
          showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏à‡∏≤‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå...');

          let pos;
          try {
            pos = await getCurrentPositionAsync();
          } catch (err) {
            console.error(err);
            closeLoading();
            showError(
              '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏à‡∏≤‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î GPS ‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á'
            );
            return;
          }

          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;

          showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞...');

          const url =
            WEB_APP_URL +
            '?action=updatestop' +
            '&rowIndex=' +
            encodeURIComponent(rowIndex) +
            '&status=' +
            encodeURIComponent('CHECKIN') +
            '&type=' +
            encodeURIComponent('checkin') +
            '&userId=' +
            encodeURIComponent(currentUserId || '') +
            '&lat=' +
            encodeURIComponent(lat) +
            '&lng=' +
            encodeURIComponent(lng) +
            '&odo=' +
            encodeURIComponent(odo);

          const res = await fetch(url);
          const json = await res.json();
          closeLoading();

          if (!json.success) {
            showError('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', json.message || '');
            return;
          }

          if (json.stop) {
            showInlineFlex('checkin', json.stop);
          }

          if (currentReference) {
            document.getElementById('keyword').value = currentReference;
            await search();
          }
        } catch (err) {
          console.error(err);
          closeLoading();
          showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï');
        }
      }

      // ---------- ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏ö‡∏ö‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (Fuel / Unload / Review / Checkout) ----------
      async function updateStopStatus(rowIndex, newStatus, actionType, seq) {
        if (!rowIndex || !newStatus || !actionType) return;

        const confirm = await Swal.fire({
          title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï',
          text: `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà ${seq} ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ "${newStatus}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`,
          icon: 'question',
          showCancelButton: true,
          confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô',
          cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
          confirmButtonColor: '#1abc9c',
        });

        if (!confirm.isConfirmed) return;

        try {
          showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏à‡∏≤‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå...');

          let pos;
          try {
            pos = await getCurrentPositionAsync();
          } catch (err) {
            console.error(err);
            closeLoading();
            showError(
              '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏à‡∏≤‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î GPS ‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á'
            );
            return;
          }

          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;

          showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞...');

          const url =
            WEB_APP_URL +
            '?action=updatestop' +
            '&rowIndex=' +
            encodeURIComponent(rowIndex) +
            '&status=' +
            encodeURIComponent(newStatus) +
            '&type=' +
            encodeURIComponent(actionType) +
            '&userId=' +
            encodeURIComponent(currentUserId || '') +
            '&lat=' +
            encodeURIComponent(lat) +
            '&lng=' +
            encodeURIComponent(lng);

          const res = await fetch(url);
          const json = await res.json();
          closeLoading();

          if (!json.success) {
            showError('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', json.message || '');
            return;
          }

          if (json.stop) {
            showInlineFlex(actionType, json.stop);
          }

          if (currentReference) {
            document.getElementById('keyword').value = currentReference;
            await search();
          }
        } catch (err) {
          console.error(err);
          closeLoading();
          showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï');
        }
      }

      // ---------- ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô + ‡πÄ‡∏ã‡πá‡∏ô ----------
      async function startReview(rowIndex, seq) {
        if (!currentReference) {
          showInfo('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏•‡∏Ç‡∏á‡∏≤‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô');
          return;
        }

        const stop = (lastStops || []).find((s) => s.rowIndex === rowIndex);
        const destName =
          (stop && (stop.destination2 || stop.destination1)) || '‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á';

        const { value: formValues } = await Swal.fire({
          title: '‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏∂‡∏á‡∏û‡∏≠‡πÉ‡∏à',
          html: `
            <div style="text-align:left;">
              <div style="font-size:0.85rem;color:#555;margin-bottom:6px;">
                ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á: <b>${destName}</b>
              </div>

              <label style="font-size:0.8rem;color:#555;">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô</label>
              <input id="swalReceiverName" type="text"
                class="swal2-input"
                placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ä‡∏≤‡∏¢"
                style="width:100%;margin:4px 0 8px;">

              <label style="font-size:0.8rem;color:#555;">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô / ‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</label>
              <input id="swalReceiverPosition" type="text"
                class="swal2-input"
                placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ, ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£"
                style="width:100%;margin:4px 0 10px;">

              <label style="font-size:0.8rem;color:#555;">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏∂‡∏á‡∏û‡∏≠‡πÉ‡∏à</label>
              <div id="reviewScoreGroup"
                  style="display:flex;gap:6px;margin:6px 0 10px;flex-wrap:wrap;">
                <button type="button" class="rating-chip" data-value="‡∏ô‡πâ‡∏≠‡∏¢"
                  style="flex:1;min-width:0;padding:6px 4px;border-radius:999px;border:1px solid #ccc;background:#fff;font-size:0.8rem;">
                  ‡∏ô‡πâ‡∏≠‡∏¢
                </button>
                <button type="button" class="rating-chip" data-value="‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á"
                  style="flex:1;min-width:0;padding:6px 4px;border-radius:999px;border:1px solid #ccc;background:#fff;font-size:0.8rem;">
                  ‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á
                </button>
                <button type="button" class="rating-chip" data-value="‡∏°‡∏≤‡∏Å"
                  style="flex:1;min-width:0;padding:6px 4px;border-radius:999px;border:1px solid #ccc;background:#fff;font-size:0.8rem;">
                  ‡∏°‡∏≤‡∏Å
                </button>
              </div>
              <input type="hidden" id="reviewScoreHidden" value="">

              <label style="font-size:0.8rem;color:#555;">‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
              <div style="border:1px solid #ccc;border-radius:8px;padding:6px;margin-top:4px;">
                <canvas id="signCanvas" width="280" height="160" style="width:100%;height:auto;background:#fafafa;border-radius:6px;"></canvas>
                <button type="button" id="btnClearSign"
                  style="margin-top:4px;padding:4px 10px;border-radius:999px;border:1px solid #ccc;font-size:0.75rem;background:#fff;">
                  ‡∏•‡πâ‡∏≤‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô
                </button>
              </div>
            </div>
          `,
          didOpen: () => {
            initSwalSignaturePad('signCanvas', 'btnClearSign');

            const chips = document.querySelectorAll('.rating-chip');
            const hidden = document.getElementById('reviewScoreHidden');
            chips.forEach((chip) => {
              chip.addEventListener('click', () => {
                chips.forEach((c) => {
                  c.style.background = '#fff';
                  c.style.color = '#333';
                  c.style.borderColor = '#ccc';
                });
                chip.style.background = '#16a085';
                chip.style.color = '#fff';
                chip.style.borderColor = '#16a085';
                hidden.value = chip.getAttribute('data-value') || '';
              });
            });
          },
          focusConfirm: false,
          showCancelButton: true,
          confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô',
          cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
          confirmButtonColor: '#1abc9c',
          preConfirm: () => {
            const receiverName = document
              .getElementById('swalReceiverName')
              .value.trim();
            const receiverPosition = document
              .getElementById('swalReceiverPosition')
              .value.trim();
            const score = document
              .getElementById('reviewScoreHidden')
              .value.trim();

            if (!receiverName) {
              Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô');
              return false;
            }
            if (!receiverPosition) {
              Swal.showValidationMessage(
                '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô/‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô'
              );
              return false;
            }
            if (!score) {
              Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏∂‡∏á‡∏û‡∏≠‡πÉ‡∏à');
              return false;
            }

            const canvas = document.getElementById('signCanvas');
            let dataUrl = '';
            if (canvas) {
              dataUrl = canvas.toDataURL('image/png');
            }

            return {
              score,
              receiverName,
              receiverPosition,
              signatureDataUrl: dataUrl,
            };
          },
        });

        if (!formValues) {
          return;
        }

        const { score, receiverName, receiverPosition, signatureDataUrl } =
          formValues;

        try {
          showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏à‡∏≤‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå...');

          let pos;
          try {
            pos = await getCurrentPositionAsync();
          } catch (err) {
            console.error(err);
            closeLoading();
            showError(
              '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏à‡∏≤‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î GPS ‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á'
            );
            return;
          }

          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;

          showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô...');

          const payload = {
            action: 'uploadReview',
            reference: currentReference,
            rowIndex: rowIndex,
            userId: currentUserId,
            score: score,
            receiverName: receiverName,
            receiverPosition: receiverPosition,
            lat: lat,
            lng: lng,
            signatureBase64: signatureDataUrl,
          };

          const res = await fetch(WEB_APP_URL, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload),
          });
          const json = await res.json();

          closeLoading();

          if (!json.success) {
            showError(json.message || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            return;
          }

          showSuccess('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');

          if (json.stop) {
            showInlineFlex('review', json.stop);
          }

          if (currentReference) {
            document.getElementById('keyword').value = currentReference;
            await search();
          }
        } catch (err) {
          console.error(err);
          closeLoading();
          showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô');
        }
      }

      // ---------- ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå ----------
      async function startAlcohol() {
        if (!currentReference || currentDrivers.length === 0) {
          showInfo('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏Ç‡∏±‡∏ö', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå');
          return;
        }

        const { value: formValues } = await Swal.fire({
          title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå',
          html: `
            <div style="text-align:left;">
              <label style="font-size:0.8rem;color:#555;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö</label>
              <select id="swalDriver" class="swal2-select" style="width:100%;margin-bottom:8px;">
                ${currentDrivers
                  .map((d) => `<option value="${d}">${d}</option>`)
                  .join('')}
              </select>

              <label style="font-size:0.8rem;color:#555;">‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå (mg%)</label>
              <input id="swalAlcoholValue" type="text"
                class="swal2-input"
                placeholder="‡πÄ‡∏ä‡πà‡∏ô 0.00"
                style="width:100%;margin:4px 0 4px;">
              <div style="font-size:0.72rem;color:#888;">
                * ‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ
              </div>
            </div>
          `,
          focusConfirm: false,
          showCancelButton: true,
          confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
          cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
          confirmButtonColor: '#1abc9c',
          preConfirm: () => {
            const driverName = document
              .getElementById('swalDriver')
              .value.trim();
            const alcoholValue = document
              .getElementById('swalAlcoholValue')
              .value.trim();

            if (!driverName) {
              Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö');
              return false;
            }
            if (!alcoholValue || isNaN(parseFloat(alcoholValue))) {
              Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç');
              return false;
            }

            return {
              driverName,
              alcoholValue,
            };
          },
        });

        if (!formValues) return;

        try {
          showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏à‡∏≤‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå...');

          let pos;
          try {
            pos = await getCurrentPositionAsync();
          } catch (err) {
            console.error(err);
            closeLoading();
            showError(
              '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏à‡∏≤‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î GPS ‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á'
            );
            return;
          }

          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;

          showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå...');

          const payload = {
            action: 'uploadAlcohol',
            reference: currentReference,
            driverName: formValues.driverName,
            alcoholValue: formValues.alcoholValue,
            userId: currentUserId,
            lat: lat,
            lng: lng,
            imageBase64: '', // ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ
          };

          const res = await fetch(WEB_APP_URL, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload),
          });
          const json = await res.json();

          closeLoading();

          if (!json.success) {
            showError(json.message || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            return;
          }

          if (json.checkedDrivers) {
            currentCheckedDrivers = json.checkedDrivers;
            alcoholAllDone =
              currentDrivers.length > 0 &&
              currentDrivers.every((n) => currentCheckedDrivers.includes(n));
          }

          renderSummary({
            referenceNo: currentReference,
            shipmentNo:
              (lastStops[0] && lastStops[0].shipmentNo) || '',
            totalStops: lastStops.length,
          });
          renderAlcoholSection();

          showSuccess('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
        } catch (err) {
          console.error(err);
          closeLoading();
          showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå');
        }
      }

      // ---------- ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô ----------
      async function closeJob() {
        if (!currentReference) {
          showInfo('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏•‡∏Ç‡∏á‡∏≤‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô');
          return;
        }

        const confirm = await Swal.fire({
          title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô',
          text: '‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏£‡∏ñ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonText: '‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô',
          cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
          confirmButtonColor: '#e67e22',
        });

        if (!confirm.isConfirmed) return;

        const btn = document.getElementById('btnCloseJob');
        btn.disabled = true;
        showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô...');

        try {
          const url =
            WEB_APP_URL +
            '?action=closejob' +
            '&reference=' +
            encodeURIComponent(currentReference) +
            '&userId=' +
            encodeURIComponent(currentUserId || '');

          const res = await fetch(url);
          const json = await res.json();
          closeLoading();

          if (!json.success) {
            showError('‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', json.message || '');
            btn.disabled = false;
            return;
          }

          jobClosed = true;
          jobAccepted = true;
          if (json.stop) {
            showInlineFlex('closejob', json.stop);
          }

          if (currentReference) {
            document.getElementById('keyword').value = currentReference;
            await search();
          }

          showSuccess('‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏£‡∏ñ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß');
        } catch (err) {
          console.error(err);
          closeLoading();
          showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô');
          btn.disabled = false;
        }
      }

      // ---------- ‡πÅ‡∏™‡∏î‡∏á inline flex (‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ popup ‡πÅ‡∏ó‡∏ô) ----------
      function showInlineFlex(actionType, stop) {
        // ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡πà‡∏≠‡∏¢‡∏≠‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏Å LINE Flex ‡∏à‡∏≤‡∏Å LIFF ‡πÑ‡∏î‡πâ‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á
        console.log('Inline flex:', actionType, stop);
      }

      // ---------- LIFF Init ----------
      async function initLiff() {
        try {
          await liff.init({ liffId: LIFF_ID });

          if (!liff.isLoggedIn()) {
            liff.login();
            return;
          }

          const profile = await liff.getProfile();
          currentUserId = profile.userId || '';

          // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ user (‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏µ‡∏Å‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤)
          const tag = document.getElementById('userStatusTag');
          tag.style.display = 'inline-flex';
          tag.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå...';

          // ‡∏¢‡∏¥‡∏á search ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà keyword ‡πÄ‡∏û‡∏∑‡πà‡∏≠ update status ‡∏Å‡πá‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
          // ‡πÅ‡∏ï‡πà‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å

          document
            .getElementById('btnSearch')
            .addEventListener('click', search);
          document
            .getElementById('btnAccept')
            .addEventListener('click', acceptJob);
          document
            .getElementById('btnCloseJob')
            .addEventListener('click', closeJob);
          document
            .getElementById('btnAlcohol')
            .addEventListener('click', startAlcohol);
        } catch (err) {
          console.error(err);
          showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô LIFF ‡πÑ‡∏î‡πâ', String(err));
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        initLiff();
      });
    </script>
  </body>
</html>
