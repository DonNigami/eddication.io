<!DOCTYPE html>
<html lang="th">

<head>
  <base target="_top" />
  <meta charset="UTF-8" />
  <title>Driver Tracking</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- App Config -->
  <script src="config.js"></script>
  <!-- Core Modules (load in order) -->
  <script src="logger.js"></script>
  <script src="constants.js"></script>
  <script src="validators.js"></script>
  <script src="api.js"></script>

  <style>
    :root {
      --primary: #1abc9c;
      --primary-dark: #16a085;
      --bg: #f4f8f7;
      --text-main: #222;
      --text-sub: #666;
      --card-bg: #ffffff;
      --border-radius: 14px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI',
        sans-serif;
      background: var(--bg);
      color: var(--text-main);
    }

    .app-shell {
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 12px;
    }

    .container {
      width: 100%;
      max-width: 520px;
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 16px 18px 20px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.06);
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .title {
      font-size: 1.2rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .badge {
      font-size: 0.75rem;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(26, 188, 156, 0.1);
      color: var(--primary-dark);
    }

    .status-text {
      font-size: 0.9rem;
      color: var(--text-sub);
      margin-bottom: 10px;
    }

    .field-group {
      margin-bottom: 10px;
    }

    label {
      display: block;
      font-size: 0.8rem;
      color: var(--text-sub);
      margin-bottom: 4px;
    }

    input[type='text'] {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #dce2e0;
      font-size: 0.95rem;
      outline: none;
      transition: border 0.2s, box-shadow 0.2s, background 0.2s;
      background: #f7faf9;
    }

    input[type='text']:focus {
      border-color: var(--primary);
      background: #ffffff;
      box-shadow: 0 0 0 2px rgba(26, 188, 156, 0.18);
    }

    button {
      width: 100%;
      padding: 11px 12px;
      border-radius: 999px;
      border: none;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: #ffffff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: transform 0.12s ease-out, box-shadow 0.12s ease-out,
        opacity 0.15s;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 18px rgba(22, 160, 133, 0.28);
    }

    button:active {
      transform: translateY(0);
      box-shadow: none;
      opacity: 0.9;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    .btn-small {
      width: auto;
      padding: 10px 16px;
      font-size: 0.95rem;
      border-radius: 999px;
      margin: 4px 6px 0 0;
    }

    .btn-outline {
      background: #ffffff;
      color: var(--primary-dark);
      border: 1px solid rgba(26, 188, 156, 0.35);
      box-shadow: none;
    }

    .btn-outline:hover {
      background: rgba(26, 188, 156, 0.06);
    }

    .btn-warning {
      background: #f39c12;
      background: linear-gradient(135deg, #f39c12, #d35400);
    }

    .btn-secondary {
      background: #95a5a6;
      background: linear-gradient(135deg, #95a5a6, #7f8c8d);
    }

    .summary-card {
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 10px;
      background: #f7faf9;
      border: 1px solid #e3ebe8;
      font-size: 0.88rem;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    .summary-label {
      color: var(--text-sub);
    }

    .summary-value {
      font-weight: 600;
    }

    .timeline-container {
      margin-top: 14px;
    }

    .timeline-title {
      font-weight: 600;
      font-size: 0.95rem;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .timeline {
      position: relative;
      margin: 0;
      padding: 4px 0 0 20px;
      list-style: none;
    }

    .timeline::before {
      content: '';
      position: absolute;
      left: 9px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: linear-gradient(to bottom,
          rgba(26, 188, 156, 0.6),
          rgba(26, 188, 156, 0.1));
    }

    .timeline-item {
      position: relative;
      margin-bottom: 14px;
    }

    .timeline-marker {
      position: absolute;
      left: -1px;
      top: 6px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #ffffff;
      border: 2px solid var(--primary);
      box-shadow: 0 0 0 2px rgba(26, 188, 156, 0.15);
    }

    .timeline-content {
      margin-left: 14px;
      background: #ffffff;
      border-radius: 12px;
      padding: 8px 10px;
      border: 1px solid #e4ece9;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.04);
    }

    .timeline-header-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 4px;
    }

    .timeline-stop-label {
      font-size: 0.9rem;
      font-weight: 800;
      color: var(--primary-dark);
    }

    .timeline-status {
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(22, 160, 133, 0.06);
      color: var(--primary-dark);
    }

    .timeline-sub {
      font-size: 0.82rem;
      color: var(--text-sub);
      margin-bottom: 2px;
    }

    .materials-text {
      font-size: 0.8rem;
      color: #444;
      margin-top: 4px;
    }

    .action-row {
      margin-top: 6px;
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      align-items: stretch;
    }

    .action-row button {
      flex: 1;
    }

    .btn-nav {
      flex: 0 0 25%;
      background: #0d6efd;
      color: #fff;
      border-radius: 8px;
      padding: 8px 6px;
      text-align: center;
      font-size: 0.8rem;
      border: none;
      width: auto;
    }

    .btn-nav:hover {
      opacity: 0.9;
    }

    .btn-pod {
      background: linear-gradient(135deg, #3498db, #2980b9);
    }

    .btn-sos {
      position: fixed;
      bottom: 80px;
      right: 16px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, #e74c3c, #c0392b);
      color: #fff;
      font-size: 1.5rem;
      font-weight: 700;
      border: 3px solid #fff;
      box-shadow: 0 4px 12px rgba(231, 76, 60, 0.4);
      z-index: 9997;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      animation: sosGlow 2s ease-in-out infinite;
    }

    @keyframes sosGlow {

      0%,
      100% {
        box-shadow: 0 4px 12px rgba(231, 76, 60, 0.4);
      }

      50% {
        box-shadow: 0 4px 20px rgba(231, 76, 60, 0.8);
      }
    }

    .footer-note {
      margin-top: 8px;
      font-size: 0.78rem;
      color: var(--text-sub);
      text-align: center;
    }

    .history-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .history-item {
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #dce2e0;
      background: #ffffff;
      font-size: 0.9rem;
      cursor: pointer;
      transition: border 0.15s, color 0.15s, background 0.15s;
    }

    .history-item:hover {
      border-color: var(--primary);
      color: var(--primary-dark);
      background: #f0fbf7;
    }

    /* Force-hide legacy QR elements if any cached markup remains */
    #btnScan,
    #qrOverlay,
    #btnQrSwitch,
    #btnQrClose {
      display: none !important;
    }

    .hidden {
      display: none;
    }

    .inline-flex {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%) translateY(-20px);
      width: calc(100% - 24px);
      max-width: 520px;
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.18);
      border-left: 4px solid var(--primary);
      padding: 10px 12px 11px;
      z-index: 9999;
      opacity: 0;
      pointer-events: none;
    }

    .inline-flex-bar {
      width: 42px;
      height: 4px;
      border-radius: 99px;
      background: rgba(26, 188, 156, 0.2);
      margin: 0 auto 6px;
    }

    .inline-flex-title {
      font-size: 0.95rem;
      font-weight: 700;
      color: var(--primary-dark);
      margin-bottom: 2px;
      text-align: left;
    }

    .inline-flex-text {
      font-size: 0.8rem;
      color: var(--text-sub);
      margin-bottom: 2px;
    }

    .inline-flex-sub {
      font-size: 0.76rem;
      color: #555;
    }

    .inline-flex.show {
      animation: dropIn 0.35s ease-out forwards;
    }

    .inline-flex.hide {
      animation: fadeOutUp 0.25s ease-in forwards;
    }

    @keyframes dropIn {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(-20px);
      }

      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }

    @keyframes fadeOutUp {
      from {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }

      to {
        opacity: 0;
        transform: translateX(-50%) translateY(-15px);
      }
    }

    @media (max-width: 480px) {
      .card {
        padding: 14px 14px 18px;
      }

      .title {
        font-size: 1.05rem;
      }

      button {
        font-size: 0.9rem;
      }
    }

    /* Status tray */
    .status-tray {
      position: fixed;
      bottom: 12px;
      left: 50%;
      transform: translateX(-50%);
      width: calc(100% - 24px);
      max-width: 520px;
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid #e6eeeb;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
      padding: 8px 10px;
      display: flex;
      gap: 6px;
      align-items: center;
      justify-content: space-between;
      z-index: 9998;
    }

    .status-pill {
      font-size: 0.75rem;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #dfe7e4;
      background: #f7faf9;
      color: #444;
      white-space: nowrap;
    }

    .status-ok {
      border-color: rgba(26, 188, 156, 0.35);
      background: rgba(26, 188, 156, 0.08);
      color: #16a085;
    }

    .status-bad {
      border-color: rgba(231, 76, 60, 0.35);
      background: rgba(231, 76, 60, 0.08);
      color: #c0392b;
    }

    .status-unknown {
      opacity: 0.7;
    }

    /* Timeline filter */
    .btn-active {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: #fff;
      border: none;
    }
  </style>
</head>

<body>
  <!-- Inline Flex Notification -->
  <div id="inlineFlex" class="inline-flex hidden">
    <div class="inline-flex-bar"></div>
    <div class="inline-flex-title" id="inlineFlexTitle"></div>
    <div class="inline-flex-text" id="inlineFlexMain"></div>
    <div class="inline-flex-sub" id="inlineFlexSub"></div>
  </div>

  <!-- Compact Status Tray -->
  <div id="statusTray" class="status-tray hidden" aria-live="polite">
    <span id="stLiff" class="status-pill status-unknown">LIFF</span>
    <span id="stLogin" class="status-pill status-unknown">Login</span>
    <span id="stBackend" class="status-pill status-unknown">Backend</span>
    <span id="stGps" class="status-pill status-unknown">GPS</span>
    <button id="stSyncBtn" type="button" class="btn-small btn-outline" style="margin-left:auto;">Sync</button>
  </div>

  <!-- Emergency SOS Button -->
  <button id="btnSOS" class="btn-sos" type="button" title="‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô SOS">üö®</button>

  <div class="app-shell">
    <div class="container">
      <!-- Main App -->
      <div id="mainApp" class="card">
        <div class="header">
          <div class="title">
            üöö Driver Tracking
            <span class="badge">Online</span>
          </div>
        </div>

        <div id="status" class="status-text"></div>

        <!-- Diagnostics Panel -->
        <div id="diagCard" class="summary-card" style="margin-bottom:10px;">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
            <div style="font-weight:600;">Diagnostics</div>
            <div style="display:flex;gap:6px;">
              <button id="btnRunDiag" type="button" class="btn-small btn-outline">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö</button>
              <button id="btnToggleDiag" type="button" class="btn-small btn-outline">‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô</button>
            </div>
          </div>
          <div id="diagBody" class="hidden" style="margin-top:6px;font-size:0.85rem;">
            <div id="diagLiff">LIFF: -</div>
            <div id="diagLogin">Login: -</div>
            <div id="diagUser">UserId: -</div>
            <div id="diagBackend">Backend URL: -</div>
            <div id="diagPing">Ping: -</div>
            <div id="diagGps">GPS: -</div>
          </div>
        </div>

        <div class="field-group">
          <label for="keyword">‡πÄ‡∏•‡∏Ç‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏á‡∏≤‡∏ô (Reference No.)</label>
          <div style="display:flex;gap:6px;align-items:center;">
            <input id="keyword" type="text" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç Reference ‡πÄ‡∏ä‡πà‡∏ô 2511S15403" style="flex:1;" />
          </div>
        </div>

        <button id="btnSearch" type="button">
          <span>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ / ‡∏î‡∏∂‡∏á‡∏á‡∏≤‡∏ô</span>
        </button>

        <div id="historyContainer" class="summary-card hidden" style="margin-top:10px;">
          <div style="font-weight:600;margin-bottom:6px;">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</div>
          <div id="historyList" class="history-list"></div>
        </div>

        <div id="summary" class="summary-card hidden"></div>

        <div id="alcoholContainer" class="summary-card hidden" style="margin-top:10px;"></div>

        <button id="btnDailySummary" class="btn-small btn-outline hidden" type="button"
          style="margin-top:10px;background:linear-gradient(135deg,#9b59b6,#8e44ad);color:#fff;border:none;"
          onclick="generateDailySummary()">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</button>

        <div id="timelineContainer" class="timeline-container hidden">
          <div class="timeline-title">
            ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
            <span style="font-size:0.8rem;color:var(--text-sub);">
              (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á)
            </span>
          </div>
          <!-- Next Step Assistant -->
          <div id="nextStepAssistant" class="summary-card hidden"
            style="margin:6px 0 8px;padding:10px;border-left:4px solid #1abc9c;">
            <!-- will be rendered dynamically -->
          </div>
          <!-- Timeline quick filters -->
          <div id="timelineFilter" style="margin:6px 0 6px;display:flex;gap:6px;flex-wrap:wrap;align-items:center;">
            <button id="btnFilterAll" type="button" class="btn-small btn-outline">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            <button id="btnFilterPending" type="button" class="btn-small btn-outline">‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥</button>
            <span id="filterCounts" style="font-size:0.8rem;color:var(--text-sub);margin-left:auto;">-</span>
          </div>
          <ul id="timeline" class="timeline"></ul>

          <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô + ‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ -->
          <div id="closeJobContainer" class="hidden" style="margin-top:8px;">
            <button id="btnCloseJob" type="button" class="btn-secondary" style="width:100%;margin-bottom:6px;">
              ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô (‡∏£‡∏ñ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô)
            </button>
            <button id="btnEndTrip" type="button" class="btn-secondary" style="width:100%;display:none;">
              ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ (‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå + ‡∏à‡∏∏‡∏î‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ)
            </button>
          </div>
        </div>

        <div class="footer-note">
          ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Check-in / Check-out ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ö‡∏ô‡∏à‡∏≠
          ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á Flex ‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ä‡∏ó LINE
        </div>
      </div><!-- end mainApp -->
    </div>
  </div>

  <script>
    // ============================================================================
    // Driver Tracking App - Main Module
    // Uses modular architecture: Logger ‚Üí Constants ‚Üí Validators ‚Üí API ‚Üí App
    // ============================================================================

    const MESSAGES = window.CONSTANTS.MESSAGES;
    const ACTIONS = window.CONSTANTS.ACTIONS;
    const STORAGE_KEYS = window.CONSTANTS.STORAGE_KEYS;
    const LIFF_ID = window.CONSTANTS.API.LIFF_ID;
    const LAST_SEARCH_MAP_KEY = 'driver_last_search_map_v1';
    const LAST_SEARCH_HISTORY_KEY = 'driver_last_search_history_map_v1';
    const LIFF_LOGIN_FLAG_KEY = 'liff_login_attempted_v1';
    const ACTION_QUEUE_KEY = 'driver_action_queue_v1';

    let currentUserId = '';
    let currentReference = '';
    let lastStops = [];
    let inlineFlexTimer = null;
    let isUpdatingStop = false;
    let searchAbortController = null;
    let searchRequestId = 0;

    /**
     * Escape HTML entities to prevent XSS
     * @param {*} val
     * @returns {string}
     */
    function safe(val) {
      const s = String(val == null ? '' : val);
      return s
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    /**
     * Debounce utility for input handlers
     * @param {Function} fn
     * @param {number} delay
     * @returns {Function}
     */
    function debounce(fn, delay) {
      let timeoutId;
      return function () {
        const args = Array.prototype.slice.call(arguments);
        const self = this;
        clearTimeout(timeoutId);
        timeoutId = setTimeout(function () {
          fn.apply(self, args);
        }, delay);
      };
    }

    function getLastSearch(userId) {
      if (!userId) return '';
      try {
        const raw = localStorage.getItem(LAST_SEARCH_MAP_KEY);
        if (!raw) return '';
        const map = JSON.parse(raw);
        if (map && typeof map === 'object') {
          return map[userId] || '';
        }
      } catch (e) {
        console.warn('last search map parse error', e);
      }
      return '';
    }

    function setLastSearch(userId, value) {
      if (!userId) return;
      try {
        const raw = localStorage.getItem(LAST_SEARCH_MAP_KEY);
        const map = raw ? JSON.parse(raw) : {};
        map[userId] = value;
        localStorage.setItem(LAST_SEARCH_MAP_KEY, JSON.stringify(map));
      } catch (e) {
        console.warn('last search map write error', e);
      }
    }

    function getSearchHistory(userId) {
      if (!userId) return [];
      try {
        const raw = localStorage.getItem(LAST_SEARCH_HISTORY_KEY);
        if (!raw) return [];
        const map = JSON.parse(raw);
        const list = map && typeof map === 'object' ? map[userId] : [];
        return Array.isArray(list) ? list : [];
      } catch (e) {
        console.warn('history parse error', e);
        return [];
      }
    }

    function setSearchHistory(userId, keyword) {
      if (!userId) return;
      const kw = (keyword || '').trim();
      if (!kw) return;
      try {
        const raw = localStorage.getItem(LAST_SEARCH_HISTORY_KEY);
        const map = raw ? JSON.parse(raw) : {};
        let list = Array.isArray(map[userId]) ? map[userId] : [];
        list = list.filter(function (k) { return k !== kw; });
        list.unshift(kw);
        if (list.length > 2) list = list.slice(0, 2);
        map[userId] = list;
        localStorage.setItem(LAST_SEARCH_HISTORY_KEY, JSON.stringify(map));
      } catch (e) {
        console.warn('history write error', e);
      }
    }

    function migrateLegacyLastSearch(userId) {
      if (!userId) return;
      try {
        const legacy = localStorage.getItem(STORAGE_KEYS.LAST_SEARCH);
        if (legacy) {
          setLastSearch(userId, legacy);
          setSearchHistory(userId, legacy);
          localStorage.removeItem(STORAGE_KEYS.LAST_SEARCH);
        }
      } catch (e) {
        console.warn('legacy last search migration failed', e);
      }
    }

    function renderSearchHistory() {
      const container = document.getElementById('historyContainer');
      const listEl = document.getElementById('historyList');
      if (!container || !listEl) return;

      const items = getSearchHistory(currentUserId);
      listEl.innerHTML = '';

      if (!currentUserId || !items.length) {
        container.classList.add('hidden');
        return;
      }

      items.forEach(function (kw) {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'history-item';
        btn.textContent = kw;
        btn.addEventListener('click', function () {
          const kwEl = document.getElementById('keyword');
          if (kwEl) {
            kwEl.value = kw;
            search();
          }
        });
        listEl.appendChild(btn);
      });

      container.classList.remove('hidden');
    }

    let currentDrivers = [];
    let currentCheckedDrivers = [];
    let alcoholAllDone = false;
    let jobClosed = false;
    let tripEnded = false;

    // ============================================================================
    // UI Alert Functions
    // ============================================================================

    /**
     * Show loading modal
     * @param {string} message
     */
    function showLoading(message) {
      Swal.fire({
        title: message || '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...',
        allowOutsideClick: false,
        didOpen: function () {
          Swal.showLoading();
        },
      });
    }

    function closeLoading() {
      Swal.close();
    }

    /**
     * Show error notification
     * @param {string} message
     */
    function showError(message) {
      Swal.fire({
        icon: 'error',
        title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
        text: message || '‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
        confirmButtonColor: '#1abc9c',
      });
    }

    function showSuccess(title, text) {
      return Swal.fire({
        icon: 'success',
        title: title || '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
        text: text || '',
        confirmButtonColor: '#1abc9c',
      });
    }

    /**
     * Show info notification
     * @param {string} title
     * @param {string} text
     */
    function showInfo(title, text) {
      Swal.fire({
        icon: 'info',
        title: title || '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô',
        text: text || '',
        confirmButtonColor: '#1abc9c',
      });
    }

    // SweetAlert2 toast helpers (non-blocking notifications)
    function showToast(type, title) {
      const opts = {
        toast: true,
        position: 'top-end',
        showConfirmButton: false,
        timer: 2000,
        timerProgressBar: true,
      };
      Swal.fire(Object.assign({}, opts, { icon: type || 'info', title: title || '' }));
    }
    function showToastSuccess(msg) { showToast('success', msg); }
    function showToastInfo(msg) { showToast('info', msg); }
    function showToastError(msg) { showToast('error', msg); }

    /**
     * Emergency SOS function
     */
    async function triggerSOS() {
      const { value: emergencyType } = await Swal.fire({
        title: 'üö® ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô',
        html: `
          <div style="text-align:left;margin-bottom:10px;">
            <label style="display:block;font-size:0.9rem;font-weight:600;margin-bottom:6px;">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå</label>
            <select id="sosType" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:0.9rem;">
              <option value="‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏">üöó ‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏</option>
              <option value="‡∏£‡∏ñ‡πÄ‡∏™‡∏µ‡∏¢">üîß ‡∏£‡∏ñ‡πÄ‡∏™‡∏µ‡∏¢/‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡∏ô‡∏ï‡πå</option>
              <option value="‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û">üè• ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</option>
              <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‚ö†Ô∏è ‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
            </select>
          </div>
          <div style="text-align:left;">
            <label style="display:block;font-size:0.85rem;margin-bottom:4px;">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
            <textarea id="sosDetail" rows="3" placeholder="‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå..." 
              style="width:100%;padding:8px;border:1px solid #ddd;border-radius:8px;font-size:0.85rem;resize:vertical;"></textarea>
          </div>
          <div style="margin-top:12px;padding:10px;background:#fff3cd;border-radius:8px;border:1px solid #ffc107;">
            <div style="font-size:0.85rem;color:#856404;margin-bottom:6px;">üìû ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;">
              <a href="tel:191" style="flex:1;min-width:80px;padding:8px;background:#fff;border:1px solid #ddd;border-radius:6px;text-align:center;text-decoration:none;color:#333;font-size:0.85rem;">üö® 191</a>
              <a href="tel:1669" style="flex:1;min-width:80px;padding:8px;background:#fff;border:1px solid #ddd;border-radius:6px;text-align:center;text-decoration:none;color:#333;font-size:0.85rem;">üöë 1669</a>
            </div>
          </div>
        `,
        focusConfirm: false,
        showCancelButton: true,
        confirmButtonText: '‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô',
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
        confirmButtonColor: '#e74c3c',
        preConfirm: function () {
          const type = document.getElementById('sosType').value;
          const detail = document.getElementById('sosDetail').value.trim();
          return { type: type, detail: detail };
        },
      });

      if (!emergencyType) return;

      try {
        showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì SOS...');

        let pos;
        try {
          pos = await getCurrentPositionAsync();
        } catch (err) {
          console.warn('GPS error:', err);
          pos = null;
        }

        const lat = pos ? pos.coords.latitude : null;
        const lng = pos ? pos.coords.longitude : null;
        const acc = pos ? (pos.coords.accuracy != null ? pos.coords.accuracy : undefined) : undefined;

        const payload = {
          action: 'EMERGENCY_SOS',
          reference: currentReference || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô',
          userId: currentUserId,
          emergencyType: emergencyType.type,
          detail: emergencyType.detail,
          lat: lat,
          lng: lng,
          accuracy: acc,
          timestamp: new Date().toISOString()
        };

        let result;
        try {
          result = await window.API.sendSOS(payload);
        } catch (networkErr) {
          enqueueAction(payload);
          closeLoading();
          showToastInfo('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå (SOS)');
          // ‡πÅ‡∏°‡πâ offline ‡∏Å‡πá‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏à
          await Swal.fire({
            icon: 'warning',
            title: '‡∏™‡πà‡∏á SOS ‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå',
            text: '‡∏à‡∏∞‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÇ‡∏ó‡∏£‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô 191 ‡∏´‡∏£‡∏∑‡∏≠ 1669 ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ',
            confirmButtonColor: '#e74c3c',
          });
          return;
        }

        closeLoading();

        if (!result.success) {
          showError(result.message || '‡∏™‡πà‡∏á SOS ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
          return;
        }

        await Swal.fire({
          icon: 'success',
          title: '‚úÖ ‡∏™‡πà‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì SOS ‡πÅ‡∏•‡πâ‡∏ß',
          html: `
            <div style="text-align:left;">
              <p style="margin-bottom:8px;">‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡∏à‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡πÇ‡∏î‡∏¢‡πÄ‡∏£‡πá‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</p>
              <p style="margin-bottom:8px;font-weight:600;">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:</p>
              <p style="font-size:0.85rem;color:#666;">${lat && lng ? 'Lat: ' + lat.toFixed(6) + ', Lng: ' + lng.toFixed(6) : '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á'}</p>
            </div>
          `,
          confirmButtonColor: '#1abc9c',
        });

        showToastSuccess('‡∏™‡πà‡∏á SOS ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        window.Logger.info('‚úÖ SOS sent', { type: emergencyType.type });
      } catch (err) {
        window.Logger.error('‚ùå SOS error', err);
        closeLoading();
        showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á SOS');
      }
    }

    // Resolve awareness image URL (supports Google Drive share links)
    function resolveAwarenessImageUrl(url) {
      try {
        var raw = String(url || '').trim();
        if (!raw) return '';
        // Convert Google Drive share/view links to direct content
        if (raw.indexOf('drive.google.com') !== -1) {
          var m1 = raw.match(/\/file\/d\/([^/]+)/);
          if (m1 && m1[1]) {
            return 'https://drive.google.com/uc?id=' + m1[1];
          }
          var m2 = raw.match(/[?&]id=([^&]+)/);
          if (m2 && m2[1]) {
            return 'https://drive.google.com/uc?id=' + m2[1];
          }
        }
        return raw;
      } catch (_) {
        return String(url || '');
      }
    }

    // ==========================
    // Offline queue helpers
    // ==========================
    function isOnline() {
      return navigator.onLine === true;
    }

    function loadQueue() {
      try {
        const raw = localStorage.getItem(ACTION_QUEUE_KEY);
        return raw ? JSON.parse(raw) : [];
      } catch (_) { return []; }
    }
    function saveQueue(q) {
      try { localStorage.setItem(ACTION_QUEUE_KEY, JSON.stringify(q || [])); } catch (_) { }
    }
    function enqueueAction(action) {
      const q = loadQueue();
      q.push(Object.assign({ ts: Date.now() }, action));
      saveQueue(q);
      try { showToastInfo('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå‡πÅ‡∏•‡πâ‡∏ß (' + (action && action.type ? action.type : 'action') + ')'); } catch (_) { }
    }

    /**
     * Quick Templates - ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏£‡∏π‡∏õ‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
     */
    async function sendQuickTemplate(stopRowIndex) {
      if (!liff || !liff.isLoggedIn()) {
        showInfo('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ Login', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ Login ‡∏ú‡πà‡∏≤‡∏ô LINE ‡∏Å‡πà‡∏≠‡∏ô');
        return;
      }

      const stop = stopRowIndex ? (lastStops || []).find(function (s) { return s.rowIndex === stopRowIndex; }) : null;
      const destName = stop ? (stop.destination2 || stop.destination1 || '‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á') : '‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢';

      const { value: template } = await Swal.fire({
        title: 'üí¨ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏£‡∏π‡∏õ',
        html: `
          <div style="text-align:left;margin-bottom:10px;">
            <label style="display:block;font-size:0.9rem;font-weight:600;margin-bottom:6px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Template</label>
            <select id="msgTemplate" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:0.9rem;">
              <option value="going">üöö ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÑ‡∏õ‡∏™‡πà‡∏á</option>
              <option value="arrived">‚úÖ ‡∏ñ‡∏∂‡∏á‡πÅ‡∏•‡πâ‡∏ß</option>
              <option value="delay">‚è∞ ‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤</option>
              <option value="complete">üéâ ‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</option>
              <option value="custom">‚úèÔ∏è ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á</option>
            </select>
          </div>
          <div id="customMsgBox" style="display:none;text-align:left;margin-bottom:10px;">
            <label style="display:block;font-size:0.85rem;margin-bottom:4px;">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</label>
            <textarea id="customMsg" rows="3" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á..." 
              style="width:100%;padding:8px;border:1px solid #ddd;border-radius:8px;font-size:0.85rem;resize:vertical;"></textarea>
          </div>
          <div style="text-align:left;">
            <label style="display:block;font-size:0.85rem;margin-bottom:4px;">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</label>
            <div id="msgPreview" style="padding:10px;background:#f7faf9;border:1px solid #dce2e0;border-radius:8px;font-size:0.85rem;color:#333;min-height:50px;"></div>
          </div>
        `,
        didOpen: function () {
          const selectEl = document.getElementById('msgTemplate');
          const customBox = document.getElementById('customMsgBox');
          const previewEl = document.getElementById('msgPreview');
          const customMsg = document.getElementById('customMsg');

          function updatePreview() {
            const val = selectEl.value;
            let msg = '';
            if (val === 'going') msg = 'üöö ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏™‡πà‡∏á‡∏ó‡∏µ‡πà ' + destName + ' ‡∏Ñ‡∏£‡∏±‡∏ö';
            else if (val === 'arrived') msg = '‚úÖ ‡∏ñ‡∏∂‡∏á ' + destName + ' ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£';
            else if (val === 'delay') msg = '‚è∞ ‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á ' + destName + ' ‡∏≠‡∏≤‡∏à‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏£‡∏≤‡∏à‡∏£';
            else if (val === 'complete') msg = 'üéâ ‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà ' + destName + ' ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏±‡∏ö';
            else if (val === 'custom') {
              customBox.style.display = 'block';
              msg = customMsg.value || '(‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°)';
            } else {
              msg = '-';
            }

            if (val !== 'custom') customBox.style.display = 'none';
            previewEl.textContent = msg;
          }

          selectEl.addEventListener('change', updatePreview);
          customMsg.addEventListener('input', updatePreview);
          updatePreview();
        },
        focusConfirm: false,
        showCancelButton: true,
        confirmButtonText: '‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°',
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
        confirmButtonColor: '#1abc9c',
        preConfirm: function () {
          const tpl = document.getElementById('msgTemplate').value;
          const custom = document.getElementById('customMsg').value.trim();
          return { template: tpl, customMsg: custom };
        },
      });

      if (!template) return;

      try {
        let finalMsg = '';
        if (template.template === 'going') finalMsg = 'üöö ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏™‡πà‡∏á‡∏ó‡∏µ‡πà ' + destName + ' ‡∏Ñ‡∏£‡∏±‡∏ö';
        else if (template.template === 'arrived') finalMsg = '‚úÖ ‡∏ñ‡∏∂‡∏á ' + destName + ' ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£';
        else if (template.template === 'delay') finalMsg = '‚è∞ ‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á ' + destName + ' ‡∏≠‡∏≤‡∏à‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏£‡∏≤‡∏à‡∏£';
        else if (template.template === 'complete') finalMsg = 'üéâ ‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà ' + destName + ' ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏±‡∏ö';
        else if (template.template === 'custom') finalMsg = template.customMsg;

        if (!finalMsg) {
          showInfo('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á');
          return;
        }

        await liff.sendMessages([{ type: 'text', text: finalMsg }]);
        showToastSuccess('‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        window.Logger.info('‚úÖ Quick template sent', { template: template.template });
      } catch (err) {
        window.Logger.error('‚ùå Quick template error', err);
        showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
      }
    }

    async function processActionQueue() {
      const q = loadQueue();
      if (!q.length) { showToastInfo('‡∏Ñ‡∏¥‡∏ß‡∏ß‡πà‡∏≤‡∏á'); return; }
      const remain = [];
      let successCount = 0;
      for (const item of q) {
        try {
          if (item.type === 'UPDATE_STOP') {
            const r = await window.API.updateStop(item.payload);
            if (!r || !r.success) throw new Error('update stop failed');
          } else if (item.type === 'UPLOAD_ALCOHOL') {
            const r = await window.API.uploadAlcohol(item.payload);
            if (!r || !r.success) throw new Error('alcohol failed');
          } else if (item.type === 'UPLOAD_REVIEW') {
            const r = await window.API.uploadReview(item.payload);
            if (!r || !r.success) throw new Error('review failed');
          } else if (item.type === 'END_TRIP') {
            const r = await window.API.endTrip(item.payload);
            if (!r || !r.success) throw new Error('endTrip failed');
          } else if (item.type === 'CLOSE_JOB') {
            const r = await window.API.closeJob(item.payload);
            if (!r || !r.success) throw new Error('closeJob failed');
          } else if (item.type === 'FILL_MISSING') {
            const r = await window.API.fillMissingSteps(item.payload);
            if (!r || !r.success) throw new Error('fillMissing failed');
          } else {
            // unknown type keep it
            remain.push(item);
            continue;
          }
          successCount++;
        } catch (e) {
          remain.push(item);
        }
      }
      saveQueue(remain);
      if (successCount > 0) {
        try { showToastSuccess('‡∏ã‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ' + successCount + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'); } catch (_) { }
        // refresh if current reference is set
        if (currentReference) {
          try { document.getElementById('keyword').value = currentReference; await search(); } catch (_) { }
        }
      } else {
        showToastInfo('‡∏¢‡∏±‡∏á‡∏ã‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (' + remain.length + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏á‡∏Ñ‡πâ‡∏≤‡∏á)');
      }
    }

    // Cache last search result per-user+reference
    function cacheSearchResult(userId, reference, data) {
      try { localStorage.setItem('driver_cache_' + userId + '_' + reference, JSON.stringify(data)); } catch (_) { }
    }
    function loadCachedSearchResult(userId, reference) {
      try {
        const raw = localStorage.getItem('driver_cache_' + userId + '_' + reference);
        return raw ? JSON.parse(raw) : null;
      } catch (_) { return null; }
    }

    /**
     * Show awareness acknowledgment popup (display image only, no upload)
     */
    async function showAwarenessPopup() {
      const awarenessImageUrlRaw = (window.CONSTANTS && window.CONSTANTS.API && window.CONSTANTS.API.AWARENESS_IMAGE_URL) || '';
      const awarenessImageUrl = resolveAwarenessImageUrl(awarenessImageUrlRaw);
      try { console.log('Awareness image URL:', awarenessImageUrl); } catch (_) { }

      const { isConfirmed } = await Swal.fire({
        title: '‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‚ö†Ô∏è ‡πÇ‡∏õ‡∏£‡∏î‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏î‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö',
        html: `
          <div style="text-align:left;font-size:0.95rem;">
            <p><strong>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô:</strong></p>
            <ul style="margin:10px 0;padding-left:20px;line-height:1.6;">
              <li>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏†‡∏≤‡∏û‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≠‡∏á‡∏£‡∏ñ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô</li>
              <li>‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏à‡∏£‡∏≤‡∏à‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏Ñ‡∏£‡πà‡∏á‡∏Ñ‡∏£‡∏±‡∏î</li>
              <li>‡∏£‡∏∞‡∏°‡∏±‡∏î‡∏£‡∏∞‡∏ß‡∏±‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏Ç‡∏±‡∏ö‡∏Ç‡∏µ‡πà‡∏ö‡∏ô‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏ô‡∏ô</li>
              <li>‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏ï‡∏•‡∏≠‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏ô‡∏™‡πà‡∏á</li>
            </ul>
            ${awarenessImageUrl ? `<div style="margin-top:12px;text-align:center;">
              <img src="${awarenessImageUrl}" alt="Awareness" style="max-width:100%;max-height:260px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.08);" onerror="this.style.display='none'" />
              <div style="margin-top:6px;font-size:0.8rem;color:#666;">‡∏´‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á <a href="${awarenessImageUrl}" target="_blank" rel="noopener">‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡∏¥‡πâ‡∏á‡∏Ñ‡πå‡∏£‡∏π‡∏õ</a></div>
            </div>` : ''}
          </div>
        `,
        focusConfirm: false,
        showCancelButton: false,
        allowOutsideClick: false,
        confirmButtonText: '‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö',
        confirmButtonColor: '#1abc9c'
      });

      if (!isConfirmed) {
        return;
      }

      await saveAwarenessAcknowledgment();
    }

    /**
     * Save awareness acknowledgment to Google Sheet
     * @param {File} imageFile - Image file selected by user
     */
    async function saveAwarenessAcknowledgment() {
      try {
        showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö...');

        // Get current position
        let pos;
        try {
          pos = await getCurrentPositionAsync();
        } catch (err) {
          window.Logger.warn('GPS error in awareness', err);
        }

        const lat = pos ? pos.coords.latitude : null;
        const lng = pos ? pos.coords.longitude : null;
        const acc = pos ? (pos.coords.accuracy != null ? pos.coords.accuracy : undefined) : undefined;

        const awarenessImageUrl = window.CONSTANTS && window.CONSTANTS.API ? window.CONSTANTS.API.AWARENESS_IMAGE_URL : '';

        // Call API to save awareness (no upload required)
        const result = await window.API.saveAwareness({
          reference: currentReference,
          userId: currentUserId,
          imageBase64: undefined,
          imageUrl: awarenessImageUrl,
          lat: lat,
          lng: lng,
          accuracy: acc,
          timestamp: new Date().toISOString()
        });

        closeLoading();

        if (!result.success) {
          showError(result.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ');
          return;
        }

        // Mark as acknowledged in localStorage
        const awarenessKey = 'awareness_ack_' + currentUserId + '_' + currentReference;
        localStorage.setItem(awarenessKey, 'true');

        await showSuccess('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
        window.Logger.info('‚úÖ Awareness acknowledged', { reference: currentReference });
      } catch (err) {
        window.Logger.error('‚ùå Awareness save error', err);
        closeLoading();
        showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
      }
    }

    function showInlineFlex(type, stop) {
      const container = document.getElementById('inlineFlex');
      const titleEl = document.getElementById('inlineFlexTitle');
      const mainEl = document.getElementById('inlineFlexMain');
      const subEl = document.getElementById('inlineFlexSub');

      const labelMap = {
        checkin: 'Check-in ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
        fuel: '‡∏•‡∏á‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
        unload: '‡∏•‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
        review: '‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
        checkout: 'Check-out ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
        closejob: '‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
        endtrip: '‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á
      };

      const title = labelMap[type] || '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';

      let timeText = '';
      if (type === 'checkin') timeText = stop.checkInTime || '';
      else if (type === 'fuel') timeText = stop.fuelingTime || '';
      else if (type === 'unload') timeText = stop.unloadDoneTime || '';
      else if (type === 'review') timeText = stop.reviewedTime || '';
      else if (type === 'checkout') timeText = stop.checkOutTime || '';

      const odoText =
        type === 'checkin' && stop.checkInOdo
          ? ' ‚Ä¢ ‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå: ' + stop.checkInOdo
          : '';

      titleEl.textContent = title;
      mainEl.textContent = 'Reference: ' + (stop.referenceNo || '-') + ' | Shipment: ' + (stop.shipmentNo || '-');
      const acc = stop.gpsAccuracy != null ? ' ‚Ä¢ ¬±' + Math.round(stop.gpsAccuracy) + 'm' : '';
      subEl.textContent = (stop.destination2 || stop.destination1 || '‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á') + (timeText ? ' ‚Ä¢ ‡πÄ‡∏ß‡∏•‡∏≤: ' + timeText : '') + odoText + acc;

      container.classList.remove('hide', 'hidden');
      void container.offsetWidth;
      container.classList.add('show');

      if (inlineFlexTimer) {
        clearTimeout(inlineFlexTimer);
      }
      inlineFlexTimer = setTimeout(function () {
        container.classList.remove('show');
        container.classList.add('hide');
        setTimeout(function () {
          container.classList.add('hidden');
        }, 250);
      }, 4000);
    }

    function sendFlexCheckInOut(type, stop) {
      console.log('üîî sendFlexCheckInOut called:', { type, stop });

      try {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ LIFF ‡∏ñ‡∏π‡∏Å initialize ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (!liff || !liff.isLoggedIn()) {
          console.warn('‚ö†Ô∏è LIFF ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ login ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
          return;
        }

        if (type !== 'checkin' && type !== 'checkout') {
          console.warn('‚ö†Ô∏è Type ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà checkin ‡∏´‡∏£‡∏∑‡∏≠ checkout:', type);
          return;
        }

        console.log('‚úÖ ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏™‡πà‡∏á Flex Message:', type);

        const labelMap = {
          checkin: 'Check-in ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
          checkout: 'Check-out ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
        };

        const title = labelMap[type] || '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
        const colorBar = type === 'checkout' ? '#16a085' : '#1abc9c';

        let timeText = '';
        if (type === 'checkin') timeText = stop.checkInTime || '';
        else if (type === 'checkout') timeText = stop.checkOutTime || '';

        const bubble = {
          type: 'bubble',
          size: 'mega',
          body: {
            type: 'box',
            layout: 'vertical',
            paddingAll: '16px',
            contents: [
              {
                type: 'box',
                layout: 'baseline',
                contents: [
                  { type: 'filler' },
                  {
                    type: 'box',
                    layout: 'vertical',
                    contents: [],
                    width: '8px',
                    backgroundColor: colorBar,
                    cornerRadius: '999px',
                    height: '40px',
                  },
                ],
              },
              {
                type: 'text',
                text: title,
                weight: 'bold',
                size: 'lg',
                color: '#16a085',
                margin: 'md',
              },
              {
                type: 'text',
                text: 'Reference: ' + (stop.referenceNo || '-'),
                size: 'sm',
                color: '#555555',
                wrap: true,
                margin: 'sm',
              },
              {
                type: 'text',
                text: 'Shipment: ' + (stop.shipmentNo || '-'),
                size: 'sm',
                color: '#555555',
                wrap: true,
                margin: 'xs',
              },
              {
                type: 'separator',
                margin: 'md',
              },
              {
                type: 'box',
                layout: 'vertical',
                margin: 'md',
                spacing: 'sm',
                contents: [
                  {
                    type: 'text',
                    text:
                      stop.destination2 ||
                      stop.destination1 ||
                      '‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á',
                    size: 'md',
                    weight: 'bold',
                    wrap: true,
                  },
                  {
                    type: 'text',
                    text: timeText ? '‡πÄ‡∏ß‡∏•‡∏≤: ' + timeText : '',
                    size: 'sm',
                    color: '#555555',
                    wrap: true,
                  },
                  {
                    type: 'text',
                    text: '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ' + (stop.status || '-'),
                    size: 'sm',
                    color: '#555555',
                    wrap: true,
                    margin: 'xs',
                  },
                ],
              },
            ],
          },
          styles: {
            body: {
              backgroundColor: '#ffffff',
            },
          },
        };

        console.log('üì§ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á Flex Message...', bubble);

        liff
          .sendMessages([
            {
              type: 'flex',
              altText: title,
              contents: bubble,
            },
          ])
          .then(function () {
            console.log('‚úÖ ‡∏™‡πà‡∏á Flex Message ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
            try { showToastSuccess('‡∏™‡πà‡∏á Flex ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); } catch (_) { }
          })
          .catch(async function (err) {
            console.warn('‚ö†Ô∏è sendMessages ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡∏•‡∏≠‡∏á shareTargetPicker ‡∏ï‡πà‡∏≠', err);
            try {
              if (liff.shareTargetPicker) {
                await liff.shareTargetPicker([
                  {
                    type: 'flex',
                    altText: title,
                    contents: bubble,
                  },
                ]);
                console.log('‚úÖ ‡∏™‡πà‡∏á‡∏î‡πâ‡∏ß‡∏¢ shareTargetPicker ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                try { showToastSuccess('‡πÅ‡∏ä‡∏£‡πå Flex ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); } catch (_) { }
              }
            } catch (e2) {
              console.error('‚ùå ‡∏™‡πà‡∏á Flex ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', e2);
              try { showToastError('‡∏™‡πà‡∏á Flex ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); } catch (_) { }
            }
          });
      } catch (err) {
        console.error('‚ùå sendFlexCheckInOut fatal error:', err);
        console.error('Error details:', err.message, err.stack);
      }
    }

    async function initLiff() {
      try {
        // Guard: ensure LIFF SDK and configuration are available
        console.log('üîß Initializing LIFF...');
        console.log('LIFF SDK loaded:', typeof liff !== 'undefined');
        console.log('LIFF_ID:', LIFF_ID);
        console.log('WEB_APP_URL:', (window.CONSTANTS && window.CONSTANTS.API && window.CONSTANTS.API.WEB_APP_URL) || 'not set');

        if (typeof liff === 'undefined') {
          showError('LIFF SDK ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏≠‡∏û LINE');
          return;
        }
        if (!LIFF_ID) {
          showError('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ LIFF_ID ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö');
          return;
        }
        if (!window.CONSTANTS || !window.CONSTANTS.API || !window.CONSTANTS.API.WEB_APP_URL) {
          showError('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ WEB_APP_URL ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö backend');
          return;
        }

        console.log('üöÄ Starting LIFF init with ID:', LIFF_ID);
        await liff.init({ liffId: LIFF_ID });
        console.log('‚úÖ LIFF init completed');

        if (liff.ready) {
          await liff.ready;
          console.log('‚úÖ LIFF ready');
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô LINE app ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (liff.isInClient && !liff.isInClient()) {
          console.warn('‚ö†Ô∏è Not in LINE app - LIFF features may not work properly');
          const statusEl = document.getElementById('status');
          if (statusEl) {
            statusEl.innerHTML = '‚ö†Ô∏è <b>‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô:</b> ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏≠‡∏û LINE ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡πÑ‡∏°‡πà‡πÉ‡∏ç‡πà browser)';
          }
        }

        const isLoggedIn = liff.isLoggedIn();
        const isInClient = liff.isInClient ? liff.isInClient() : false;
        console.log('Login status:', isLoggedIn, 'isInClient:', isInClient);

        if (!isLoggedIn) {
          if (sessionStorage.getItem(LIFF_LOGIN_FLAG_KEY)) {
            console.warn('Login already attempted this session; skipping repeat login');
            return;
          }
          console.log('üîê User not logged in, redirecting to LINE login...');
          sessionStorage.setItem(LIFF_LOGIN_FLAG_KEY, '1');
          if (isInClient) {
            // In LINE app, use default LIFF login (no redirectUri override to avoid 400)
            liff.login();
          } else {
            // Outside LINE: prefer current https URL (direct link) if available, else fall back to LIFF URL
            var redirectUri = (function () {
              var href = window.location && window.location.href ? window.location.href.split('#')[0] : '';
              var isHttps = href.indexOf('https://') === 0;
              if (isHttps) return href;
              return 'https://liff.line.me/' + LIFF_ID;
            })();
            console.log('‚Ü™Ô∏è Redirecting via', redirectUri);
            try {
              liff.login({ redirectUri: redirectUri });
            } catch (loginErr) {
              sessionStorage.removeItem(LIFF_LOGIN_FLAG_KEY);
              showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö LINE ‡πÑ‡∏î‡πâ (' + (loginErr && loginErr.message ? loginErr.message : 'unknown') + ')');
            }
          }
          return;
        }

        console.log('üë§ Getting profile...');
        const profile = await liff.getProfile();
        console.log('Profile:', profile);
        currentUserId = profile.userId;

        // Clear login flag after successful login/profile fetch
        try { sessionStorage.removeItem(LIFF_LOGIN_FLAG_KEY); } catch (_) { }

        const statusEl = document.getElementById('status');
        statusEl.textContent = '‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏∏‡∏ì ' + profile.displayName + ' üëã';
        migrateLegacyLastSearch(currentUserId);

        renderSearchHistory();

        // Enable search button after LIFF is ready and user is logged in
        const btnSearchEl = document.getElementById('btnSearch');
        if (btnSearchEl) btnSearchEl.disabled = false;

        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡πà‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á user ‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        const lastKeyword = getLastSearch(currentUserId);
        if (lastKeyword) {
          const kwEl = document.getElementById('keyword');
          kwEl.value = lastKeyword;
          try {
            await search();
          } catch (e) {
            console.warn('auto search on init failed', e);
          }
        }

        // ‡πÅ‡∏™‡∏î‡∏á popup ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
        showInfo('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç', MESSAGES.INFO_IMPORTANT);

        window.Logger.info('‚úÖ LIFF initialized', { userId: currentUserId });
        // Update diagnostics snapshot after init
        try {
          updateDiagnosticsSnapshot({ liffReady: true, loggedIn: true, userId: currentUserId });
          // kick a quick diagnostics run to populate tray
          runDiagnostics();
        } catch (_) { }
      } catch (err) {
        window.Logger.error('‚ùå LIFF init failed', err);
        const statusEl = document.getElementById('status');
        const msg = err && err.message ? err.message : '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏';
        if (statusEl) {
          statusEl.innerText = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î LIFF: ' + msg;
        }
        showError(MESSAGES.ERROR_LIFF_INIT + '\n‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ' + msg);
      }
    }

    /**
     * Search for a job by reference
     */
    async function search() {
      const reqId = ++searchRequestId;
      const keywordInput = document.getElementById('keyword');
      const keyword = keywordInput.value.trim();
      const btn = document.getElementById('btnSearch');

      if (!keyword) {
        showInfo('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç Reference', MESSAGES.INFO_SEARCH_EMPTY);
        return;
      }

      // Guard: ensure LINE login and profile loaded
      if (!currentUserId) {
        showInfo('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å LINE');
        return;
      }

      // Persist latest keyword per-user immediately (so it survives even if API fails)
      setLastSearch(currentUserId, keyword);
      setSearchHistory(currentUserId, keyword);
      renderSearchHistory();

      btn.disabled = true;

      // Offline fallback: serve from cache
      if (!isOnline()) {
        const cached = loadCachedSearchResult(currentUserId, keyword);
        if (cached) {
          const d = cached;
          lastStops = d.stops || [];
          currentReference = d.referenceNo || keyword;
          currentDrivers = (d.alcohol && Array.isArray(d.alcohol.drivers) && d.alcohol.drivers) || [];
          currentCheckedDrivers = (d.alcohol && Array.isArray(d.alcohol.checkedDrivers) && d.alcohol.checkedDrivers) || [];
          const uniqueSet = new Set(currentCheckedDrivers);
          currentCheckedDrivers = Array.from ? Array.from(uniqueSet) : Array.prototype.slice.call(uniqueSet);
          alcoholAllDone = currentDrivers.length > 0 && currentDrivers.every(function (n) { return currentCheckedDrivers.includes(n); });
          jobClosed = !!d.jobClosed; tripEnded = !!d.tripEnded;
          renderSummary(d); renderAlcoholSection(); renderTimeline(lastStops);
          showToastInfo('‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå: ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÅ‡∏Ñ‡∏ä');
          btn.disabled = false;
          return;
        }
      }

      showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö...');

      try {
        const result = await window.API.search(keyword, currentUserId);

        closeLoading();

        // Ignore outdated responses
        if (reqId !== searchRequestId) {
          window.Logger.warn('Search response ignored (outdated)', { reqId, latest: searchRequestId });
          return;
        }

        if (!result.success) {
          clearResult();
          showError(result.message);
          return;
        }

        const d = result.data;
        const stops = d.stops || [];

        lastStops = stops;
        currentReference = d.referenceNo || keyword;

        currentDrivers =
          (d.alcohol && Array.isArray(d.alcohol.drivers) && d.alcohol.drivers) ||
          [];
        currentCheckedDrivers =
          (d.alcohol &&
            Array.isArray(d.alcohol.checkedDrivers) &&
            d.alcohol.checkedDrivers) ||
          [];
        const uniqueSet = new Set(currentCheckedDrivers);
        currentCheckedDrivers = Array.from ? Array.from(uniqueSet) : Array.prototype.slice.call(uniqueSet);
        alcoholAllDone =
          currentDrivers.length > 0 &&
          currentDrivers.every(function (n) { return currentCheckedDrivers.includes(n); });

        jobClosed = !!d.jobClosed;
        tripEnded = !!d.tripEnded;

        renderSummary(d);
        renderAlcoholSection();
        renderTimeline(stops);

        // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏° Daily Summary
        const btnDailySummary = document.getElementById('btnDailySummary');
        if (btnDailySummary) btnDailySummary.classList.remove('hidden');

        // cache successful result for offline usage
        try { cacheSearchResult(currentUserId, currentReference, d); } catch (_) { }

        // Show awareness acknowledgment popup if not yet acknowledged for this reference
        const awarenessKey = 'awareness_ack_' + currentUserId + '_' + currentReference;
        if (!localStorage.getItem(awarenessKey)) {
          setTimeout(function () {
            showAwarenessPopup();
          }, 500);
        }

        window.Logger.info('‚úÖ Search completed', { stops: stops.length, drivers: currentDrivers.length });
        try { showToastSuccess('‡∏î‡∏∂‡∏á‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (' + (stops.length || 0) + ' ‡∏à‡∏∏‡∏î)'); } catch (_) { }
      } catch (err) {
        window.Logger.error('‚ùå Search error', err);
        closeLoading();
        showError(MESSAGES.ERROR_NETWORK);
      } finally {
        btn.disabled = false;
      }
    }

    // stray block removed: duplicated logic after search()

    /**
     * Smart Alerts System
     */
    let alertState = {
      lastWorkStartTime: null,
      lastAlertTime: 0,
      nearbyAlertShown: {}
    };

    function checkSmartAlerts() {
      if (!lastStops || lastStops.length === 0) return;

      const now = Date.now();
      const stops = lastStops || [];

      // 1. ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô "‡πÉ‡∏Å‡∏•‡πâ‡∏ñ‡∏∂‡∏á‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á" (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ GPS)
      stops.forEach(function (stop) {
        if (stop.checkInTime || !stop.destLat || !stop.destLng) return;
        if (alertState.nearbyAlertShown[stop.rowIndex]) return;

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á (‡∏à‡∏≥‡∏•‡∏≠‡∏á - ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ GPS ‡∏à‡∏£‡∏¥‡∏á)
        // ‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏ñ‡πâ‡∏≤ distance < 5 km ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÉ‡∏Å‡∏•‡πâ
        if (stop.distance && stop.distance < 5) {
          alertState.nearbyAlertShown[stop.rowIndex] = true;
          showToastInfo('üöö ‡πÉ‡∏Å‡∏•‡πâ‡∏ñ‡∏∂‡∏á ' + (stop.destination2 || stop.destination1 || '‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á') + ' ‡πÅ‡∏•‡πâ‡∏ß!');
        }
      });

      // 2. ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô "‡πÄ‡∏ß‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô" (‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ‡πÄ‡∏Å‡∏¥‡∏ô 4 ‡∏ä‡∏°.)
      if (alertState.lastWorkStartTime) {
        const workDurationMs = now - alertState.lastWorkStartTime;
        const workHours = workDurationMs / 3600000;
        if (workHours >= 4 && (now - alertState.lastAlertTime) > 3600000) {
          alertState.lastAlertTime = now;
          showToastInfo('‚è∞ ‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏°‡∏≤ 4 ‡∏ä‡∏°.‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô 15-30 ‡∏ô‡∏≤‡∏ó‡∏µ');
        }
      }

      // 3. ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô "‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤" (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ ETA)
      // (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ETA ‡∏à‡∏≤‡∏Å backend ‡∏à‡∏£‡∏¥‡∏á - ‡∏Ç‡πâ‡∏≤‡∏°‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ)

      // 4. ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®/‡∏Å‡∏≤‡∏£‡∏à‡∏£‡∏≤‡∏à‡∏£ (‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ API ‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å - ‡∏Ç‡πâ‡∏≤‡∏°‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ)
    }

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠ check-in ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
    function startWorkTimer() {
      if (!alertState.lastWorkStartTime) {
        alertState.lastWorkStartTime = Date.now();
      }
    }

    function clearResult() {
      document.getElementById('summary').classList.add('hidden');
      document.getElementById('timelineContainer').classList.add('hidden');
      document.getElementById('summary').innerHTML = '';
      document.getElementById('timeline').innerHTML = '';
      document.getElementById('closeJobContainer').classList.add('hidden');
      document.getElementById('alcoholContainer').classList.add('hidden');
      document.getElementById('alcoholContainer').innerHTML = '';
      const btnDailySummary = document.getElementById('btnDailySummary');
      if (btnDailySummary) btnDailySummary.classList.add('hidden');
      lastStops = [];
      currentDrivers = [];
      currentCheckedDrivers = [];
      alcoholAllDone = false;
      jobClosed = false;
      tripEnded = false;
      alertState.nearbyAlertShown = {};
    }

    function renderSummary(d) {
      const summaryEl = document.getElementById('summary');
      const stops = d.stops || [];
      const shipmentNos = d.shipmentNos || [];

      let shipmentSummary = '-';
      if (shipmentNos.length === 1) {
        shipmentSummary = shipmentNos[0];
      } else if (shipmentNos.length > 1) {
        shipmentSummary = shipmentNos.join(', ');
      }

      const totalQtyAll = stops.reduce(function (acc, s) {
        if (typeof s.totalQty === 'number') return acc + s.totalQty;
        return acc;
      }, 0);

      summaryEl.innerHTML = `
          <div class="summary-row">
            <span class="summary-label">Reference</span>
            <span class="summary-value">${safe(d.referenceNo || '-')}</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏ñ</span>
            <span class="summary-value">${safe(d.vehicleDesc || '-')}</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Shipment</span>
            <span class="summary-value">${safe(shipmentSummary)}</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á</span>
            <span class="summary-value">${safe(d.totalStops || stops.length)} ‡∏à‡∏∏‡∏î</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏£‡∏ß‡∏°‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</span>
            <span class="summary-value">${safe(totalQtyAll || 0)}</span>
          </div>
        `;

      summaryEl.classList.remove('hidden');
    }

    function renderAlcoholSection() {
      const container = document.getElementById('alcoholContainer');
      if (!container) return;

      if (!currentDrivers || currentDrivers.length === 0) {
        container.classList.add('hidden');
        container.innerHTML = '';
        return;
      }

      let html = `
          <div style="font-weight:600;margin-bottom:4px;">‡πÄ‡∏õ‡πà‡∏≤‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô</div>
          <div style="font-size:0.8rem;color:var(--text-sub);margin-bottom:6px;">
            ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç) ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÉ‡∏´‡πâ
          </div>
        `;

      currentDrivers.forEach(function (name) {
        const checked = currentCheckedDrivers.includes(name);
        if (checked) {
          html += `
              <div style="margin-bottom:4px;display:flex;justify-content:space-between;align-items:center;">
                <span>${safe(name)}</span>
                <button class="btn-small btn-secondary" disabled>‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>
              </div>
            `;
        } else {
          const safeName = name.replace(/'/g, "\\'");
          html += `
              <div style="margin-bottom:4px;display:flex;justify-content:space-between;align-items:center;">
                <span>${safe(name)}</span>
                <button class="btn-small btn-outline" type="button" onclick="doAlcoholCheck('${safeName}')">
                  ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå
                </button>
              </div>
            `;
        }
      });

      alcoholAllDone =
        currentDrivers.length > 0 &&
        currentDrivers.every(function (n) { return currentCheckedDrivers.includes(n); });

      if (alcoholAllDone) {
        html += `
            <div style="margin-top:4px;font-size:0.78rem;color:var(--primary-dark);">
              ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ
            </div>
          `;
      } else {
        html += `
            <div style="margin-top:4px;font-size:0.78rem;color:#c0392b;">
              ‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô
            </div>
          `;
      }

      container.innerHTML = html;
      container.classList.remove('hidden');
    }

    // Compress image and return Base64 (re-encode strips EXIF)
    function fileToBase64(file) {
      return compressImageFile(file, { maxW: 1280, maxH: 1280, targetKB: 700, mime: 'image/jpeg' });
    }

    function loadImageFromFile(file) {
      return new Promise(function (resolve, reject) {
        const reader = new FileReader();
        reader.onload = function () {
          const img = new Image();
          img.onload = function () { resolve(img); };
          img.onerror = reject;
          img.src = reader.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    async function compressImageFile(file, opts) {
      const options = opts || {};
      const maxW = options.maxW !== undefined ? options.maxW : 1280;
      const maxH = options.maxH !== undefined ? options.maxH : 1280;
      const targetKB = options.targetKB !== undefined ? options.targetKB : 700;
      const mime = options.mime !== undefined ? options.mime : 'image/jpeg';
      const img = await loadImageFromFile(file);
      const origW = img.width || 1;
      const origH = img.height || 1;
      const ratio = Math.min(1, maxW / origW, maxH / origH);
      const canvas = document.createElement('canvas');
      canvas.width = Math.max(1, Math.floor(origW * ratio));
      canvas.height = Math.max(1, Math.floor(origH * ratio));
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

      let quality = 0.85;
      let dataUrl = canvas.toDataURL(mime, quality);
      let base64 = dataUrl.split(',')[1] || '';
      let sizeKB = Math.ceil((base64.length * 3) / 4 / 1024);

      while (sizeKB > targetKB && quality > 0.55) {
        quality -= 0.1;
        dataUrl = canvas.toDataURL(mime, quality);
        base64 = dataUrl.split(',')[1] || '';
        sizeKB = Math.ceil((base64.length * 3) / 4 / 1024);
      }
      return base64;
    }

    /**
     * Performs alcohol check for a driver
     * @param {string} driverName - The driver's name
     */
    async function doAlcoholCheck(driverName) {
      if (!currentReference) {
        showInfo(CONSTANTS.MESSAGES.INFO_NOT_FOUND, CONSTANTS.MESSAGES.INFO_SEARCH_FIRST);
        return;
      }

      const { value: formValues } = await Swal.fire({
        title: CONSTANTS.MESSAGES.ALCOHOL_TITLE,
        html: `
            <div style="text-align:left;">
              <label style="font-size:0.8rem;color:#555;">${CONSTANTS.MESSAGES.LABEL_DRIVER_NAME}</label>
              <div style="font-size:0.9rem;font-weight:600;margin-bottom:6px;">${safe(driverName)}</div>

              <label style="font-size:0.8rem;color:#555;">${CONSTANTS.MESSAGES.LABEL_ALCOHOL_VALUE}</label>
              <input id="swalAlcoholValue" type="number" min="0" step="0.01"
                class="swal2-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô 0.00"
                style="width:100%;margin:4px 0 10px;">

              <label style="font-size:0.8rem;color:#555;">${CONSTANTS.MESSAGES.LABEL_EVIDENCE_PHOTO}</label>
              <input id="swalAlcoholImage" type="file" accept="image/*" capture="environment"
                style="margin-top:4px;font-size:0.8rem;">
            </div>
          `,
        focusConfirm: false,
        showCancelButton: true,
        confirmButtonText: CONSTANTS.MESSAGES.BUTTON_SAVE,
        cancelButtonText: CONSTANTS.MESSAGES.BUTTON_CANCEL,
        confirmButtonColor: '#1abc9c',
        preConfirm: function () {
          const val = document.getElementById('swalAlcoholValue').value.trim();
          const file = document.getElementById('swalAlcoholImage').files[0];

          // Validate alcohol value
          const alcoholValidation = window.Validators.validateAlcohol(val);
          if (!alcoholValidation.valid) {
            Swal.showValidationMessage(alcoholValidation.error);
            return false;
          }

          // Validate image file
          if (!file) {
            Swal.showValidationMessage(CONSTANTS.MESSAGES.ERROR_IMAGE_REQUIRED);
            return false;
          }

          const imageValidation = window.Validators.validateImage(file);
          if (!imageValidation.valid) {
            Swal.showValidationMessage(imageValidation.error);
            return false;
          }

          return { alcoholValue: String(alcoholValidation.value.toFixed(2)), file: file };
        },
      });

      if (!formValues) {
        return;
      }

      const alcoholValue = formValues.alcoholValue;
      const file = formValues.file;

      try {
        showLoading(CONSTANTS.MESSAGES.LOADING_GET_COORDINATES);

        let pos;
        try {
          pos = await getCurrentPositionAsync();
        } catch (err) {
          window.Logger.warn('GPS error', err);
          closeLoading();
          showError(CONSTANTS.MESSAGES.ERROR_GPS);
          return;
        }

        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        const acc = pos.coords.accuracy != null ? pos.coords.accuracy : undefined;

        const base64 = await fileToBase64(file);

        // Log image size for debugging
        window.Logger.debug('üì∏ Image compressed', {
          sizeKB: Math.round(base64.length / 1024),
          driver: driverName
        });

        showLoading(CONSTANTS.MESSAGES.LOADING_UPLOAD_ALCOHOL);

        const payload = {
          reference: currentReference,
          driverName: driverName,
          userId: currentUserId,
          alcoholValue: parseFloat(alcoholValue),
          lat: lat,
          lng: lng,
          imageBase64: base64,
          accuracy: acc
        };

        let result;
        try {
          result = await window.API.uploadAlcohol(payload);
        } catch (networkErr) {
          window.Logger.error('Network error during alcohol upload', networkErr);
          // queue offline
          enqueueAction({ type: 'UPLOAD_ALCOHOL', payload });
          closeLoading();
          showToastInfo('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå (‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå)');
          return;
        }

        closeLoading();

        if (!result.success) {
          window.Logger.error('‚ùå Alcohol upload rejected', result);
          showError(result.message || CONSTANTS.MESSAGES.ERROR_ALCOHOL_SAVE);
          return;
        }

        // Update checked drivers list from API response
        if (result.data && result.data.checkedDrivers && Array.isArray(result.data.checkedDrivers)) {
          const uniqueSet1 = new Set(result.data.checkedDrivers);
          currentCheckedDrivers = Array.from ? Array.from(uniqueSet1) : Array.prototype.slice.call(uniqueSet1);
        } else {
          const uniqueSet2 = new Set(currentCheckedDrivers.concat([driverName]));
          currentCheckedDrivers = Array.from ? Array.from(uniqueSet2) : Array.prototype.slice.call(uniqueSet2);
        }

        renderAlcoholSection();
        showSuccess(CONSTANTS.MESSAGES.SUCCESS_TITLE, CONSTANTS.MESSAGES.SUCCESS_ALCOHOL_SAVED);
        window.Logger.info('‚úÖ Alcohol check completed', { driverName, alcoholValue });
      } catch (err) {
        window.Logger.error('‚ùå Alcohol check error', err);
        closeLoading();
        showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (err.message || CONSTANTS.MESSAGES.ERROR_ALCOHOL_SAVE));
      }
    }

    function initSwalSignaturePad(canvasId, clearBtnId) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;

      const ctx = canvas.getContext('2d');
      let drawing = false;

      const getPos = function (e) {
        const rect = canvas.getBoundingClientRect();
        if (e.touches && e.touches.length > 0) {
          return {
            x: e.touches[0].clientX - rect.left,
            y: e.touches[0].clientY - rect.top,
          };
        }
        return {
          x: e.clientX - rect.left,
          y: e.clientY - rect.top,
        };
      };

      const startDraw = function (e) {
        e.preventDefault();
        drawing = true;
        const pos = getPos(e);
        ctx.beginPath();
        ctx.moveTo(pos.x, pos.y);
      };

      const draw = function (e) {
        if (!drawing) return;
        e.preventDefault();
        const pos = getPos(e);
        ctx.lineTo(pos.x, pos.y);
        ctx.strokeStyle = '#111';
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.stroke();
      };

      const endDraw = function (e) {
        if (!drawing) return;
        e.preventDefault();
        drawing = false;
      };

      canvas.addEventListener('mousedown', startDraw);
      canvas.addEventListener('mousemove', draw);
      window.addEventListener('mouseup', endDraw);

      canvas.addEventListener('touchstart', startDraw, { passive: false });
      canvas.addEventListener('touchmove', draw, { passive: false });
      canvas.addEventListener('touchend', endDraw, { passive: false });

      const clearBtn = document.getElementById(clearBtnId);
      if (clearBtn) {
        clearBtn.addEventListener('click', function () {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
        });
      }
    }

    /**
     * Upload POD (Proof of Delivery) photos
     * @param {number} rowIndex - Stop row index
     * @param {number} seq - Stop sequence number
     */
    async function uploadPOD(rowIndex, seq) {
      if (!currentReference) {
        showInfo('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏á‡∏≤‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô');
        return;
      }

      const stop = (lastStops || []).find(function (s) { return s.rowIndex === rowIndex; });
      const destName = (stop && (stop.destination2 || stop.destination1)) || '‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á';

      const { value: formValues } = await Swal.fire({
        title: 'üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ POD',
        html: `
          <div style="text-align:left;margin-bottom:12px;">
            <label style="display:block;font-size:0.9rem;font-weight:600;margin-bottom:6px;">‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á: ${safe(destName)}</label>
          </div>
          <div style="text-align:left;margin-bottom:10px;">
            <label style="display:block;font-size:0.85rem;margin-bottom:4px;">‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á (‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ö‡∏ô‡∏£‡∏ñ)</label>
            <input type="file" id="podBefore" accept="image/*" capture="environment" 
              style="width:100%;padding:8px;border:1px solid #ddd;border-radius:8px;font-size:0.85rem;" />
          </div>
          <div style="text-align:left;margin-bottom:10px;">
            <label style="display:block;font-size:0.85rem;margin-bottom:4px;">‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏á‡∏™‡πà‡∏á (‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô/‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á)</label>
            <input type="file" id="podAfter" accept="image/*" capture="environment" 
              style="width:100%;padding:8px;border:1px solid #ddd;border-radius:8px;font-size:0.85rem;" />
          </div>
          <div style="text-align:left;margin-bottom:10px;">
            <label style="display:block;font-size:0.85rem;margin-bottom:4px;">‡∏™‡∏†‡∏≤‡∏û‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
            <select id="podCondition" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:8px;font-size:0.85rem;">
              <option value="‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå">‚úÖ ‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå</option>
              <option value="‡∏ä‡∏≥‡∏£‡∏∏‡∏î‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢">‚ö†Ô∏è ‡∏ä‡∏≥‡∏£‡∏∏‡∏î‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢</option>
              <option value="‡∏ä‡∏≥‡∏£‡∏∏‡∏î‡∏°‡∏≤‡∏Å">‚ùå ‡∏ä‡∏≥‡∏£‡∏∏‡∏î‡∏°‡∏≤‡∏Å</option>
            </select>
          </div>
          <div style="text-align:left;">
            <label style="display:block;font-size:0.85rem;margin-bottom:4px;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
            <textarea id="podNote" rows="2" placeholder="‡πÄ‡∏ä‡πà‡∏ô: ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà..." 
              style="width:100%;padding:8px;border:1px solid #ddd;border-radius:8px;font-size:0.85rem;resize:vertical;"></textarea>
          </div>
        `,
        focusConfirm: false,
        showCancelButton: true,
        confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å POD',
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
        confirmButtonColor: '#3498db',
        preConfirm: function () {
          const beforeInput = document.getElementById('podBefore');
          const afterInput = document.getElementById('podAfter');
          const condition = document.getElementById('podCondition').value;
          const note = document.getElementById('podNote').value.trim();

          if (!beforeInput.files || !beforeInput.files[0]) {
            Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á');
            return false;
          }
          if (!afterInput.files || !afterInput.files[0]) {
            Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏á‡∏™‡πà‡∏á');
            return false;
          }

          return {
            beforeFile: beforeInput.files[0],
            afterFile: afterInput.files[0],
            condition: condition,
            note: note
          };
        },
      });

      if (!formValues) return;

      try {
        showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ POD...');

        let pos;
        try {
          pos = await getCurrentPositionAsync();
        } catch (err) {
          console.warn('GPS error:', err);
          pos = null;
        }

        const lat = pos ? pos.coords.latitude : null;
        const lng = pos ? pos.coords.longitude : null;
        const acc = pos ? (pos.coords.accuracy != null ? pos.coords.accuracy : undefined) : undefined;

        const beforeBase64 = await fileToBase64(formValues.beforeFile);
        const afterBase64 = await fileToBase64(formValues.afterFile);

        const payload = {
          action: 'UPLOAD_POD',
          reference: currentReference,
          userId: currentUserId,
          rowIndex: rowIndex,
          seq: seq,
          beforeImage: beforeBase64,
          afterImage: afterBase64,
          condition: formValues.condition,
          note: formValues.note,
          lat: lat,
          lng: lng,
          accuracy: acc,
          timestamp: new Date().toISOString()
        };

        let result;
        try {
          result = await window.API.uploadPOD(payload);
        } catch (networkErr) {
          enqueueAction(payload);
          closeLoading();
          showToastInfo('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå (POD)');
          return;
        }

        closeLoading();

        if (!result.success) {
          showError(result.message || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å POD ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
          return;
        }

        await showSuccess('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ POD ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
        showToastSuccess('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å POD ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        window.Logger.info('‚úÖ POD uploaded', { rowIndex, seq });

        if (currentReference) {
          const kwEl = document.getElementById('keyword');
          kwEl.value = currentReference;
          search();
        }
      } catch (err) {
        window.Logger.error('‚ùå POD upload error', err);
        closeLoading();
        showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å POD');
      }
    }

    /**
     * Starts a customer review/satisfaction survey
     * @param {number} rowIndex - Stop row index
     * @param {number} seq - Stop sequence number
     */
    async function startReview(rowIndex, seq) {
      if (!currentReference) {
        showInfo(CONSTANTS.MESSAGES.INFO_NOT_FOUND, CONSTANTS.MESSAGES.INFO_SEARCH_FIRST);
        return;
      }

      const stop = (lastStops || []).find(function (s) { return s.rowIndex === rowIndex; });
      const destName =
        (stop && (stop.destination2 || stop.destination1)) || '‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á';

      const { value: formValues } = await Swal.fire({
        title: CONSTANTS.MESSAGES.REVIEW_TITLE,
        html: `
            <div style="text-align:left;">
              <div style="font-size:0.85rem;color:#555;margin-bottom:6px;">
                ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á: <b>${safe(destName)}</b>
              </div>

              <label style="font-size:0.8rem;color:#555;">${CONSTANTS.MESSAGES.LABEL_REVIEW_SCORE}</label>
              <div style="margin:4px 0 10px;font-size:0.85rem;">
                <label style="margin-right:10px;">
                  <input type="radio" name="reviewScore" value="‡∏ô‡πâ‡∏≠‡∏¢"> ‡∏ô‡πâ‡∏≠‡∏¢
                </label>
                <label style="margin-right:10px;">
                  <input type="radio" name="reviewScore" value="‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á"> ‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á
                </label>
                <label>
                  <input type="radio" name="reviewScore" value="‡∏°‡∏≤‡∏Å"> ‡∏°‡∏≤‡∏Å
                </label>
              </div>

              <label style="font-size:0.8rem;color:#555;">‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
              <div style="border:1px solid #ccc;border-radius:8px;padding:6px;margin-top:4px;">
                <canvas id="signCanvas" width="280" height="160" style="width:100%;height:auto;background:#fafafa;border-radius:6px;"></canvas>
                <button type="button" id="btnClearSign"
                  style="margin-top:4px;padding:4px 10px;border-radius:999px;border:1px solid #ccc;font-size:0.75rem;background:#fff;">
                  ‡∏•‡πâ‡∏≤‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô
                </button>
              </div>
            </div>
          `,
        didOpen: function () {
          initSwalSignaturePad('signCanvas', 'btnClearSign');
        },
        focusConfirm: false,
        showCancelButton: true,
        confirmButtonText: CONSTANTS.MESSAGES.BUTTON_SAVE,
        cancelButtonText: CONSTANTS.MESSAGES.BUTTON_CANCEL,
        confirmButtonColor: '#1abc9c',
        preConfirm: function () {
          const radio = document.querySelector(
            'input[name="reviewScore"]:checked'
          );
          if (!radio) {
            Swal.showValidationMessage(CONSTANTS.MESSAGES.VALIDATE_REFERENCE_REQUIRED);
            return false;
          }

          const canvas = document.getElementById('signCanvas');
          let dataUrl = '';
          if (canvas) {
            dataUrl = canvas.toDataURL('image/png');
          }

          return {
            score: radio.value,
            signatureDataUrl: dataUrl,
          };
        },
      });

      if (!formValues) {
        return;
      }

      const score = formValues.score;
      const signatureDataUrl = formValues.signatureDataUrl;

      try {
        showLoading(CONSTANTS.MESSAGES.LOADING_GET_COORDINATES);

        let pos;
        try {
          pos = await getCurrentPositionAsync();
        } catch (err) {
          window.Logger.warn('GPS error', err);
          closeLoading();
          showError(CONSTANTS.MESSAGES.ERROR_GPS);
          return;
        }

        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        const acc = pos.coords.accuracy != null ? pos.coords.accuracy : undefined;

        showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô...');

        let signatureBase64 = '';
        if (signatureDataUrl && typeof signatureDataUrl === 'string') {
          const parts = signatureDataUrl.split(',');
          signatureBase64 = parts[1] || '';
        }

        const payload = {
          reference: currentReference,
          rowIndex: rowIndex,
          userId: currentUserId,
          score: score,
          lat: lat,
          lng: lng,
          signatureBase64: signatureBase64,
          accuracy: acc
        };

        let result;
        try {
          result = await window.API.uploadReview(payload);
        } catch (networkErr) {
          enqueueAction({ type: 'UPLOAD_REVIEW', payload });
          closeLoading();
          showToastInfo('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå (‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô)');
          return;
        }

        closeLoading();

        if (!result.success) {
          showError(result.message);
          return;
        }

        await showSuccess(CONSTANTS.MESSAGES.SUCCESS_TITLE, CONSTANTS.MESSAGES.SUCCESS_REVIEW);

        if (result.data && result.data.stop) {
          showInlineFlex('review', result.data.stop);
        }

        if (currentReference) {
          document.getElementById('keyword').value = currentReference;
          await search();
        }

        window.Logger.info('‚úÖ Review uploaded', { rowIndex, score });
      } catch (err) {
        window.Logger.error('‚ùå Review upload error', err);
        closeLoading();
        try {
          enqueueAction({
            type: 'UPLOAD_REVIEW', payload: {
              reference: currentReference,
              rowIndex: rowIndex,
              userId: currentUserId,
              score: score,
              signatureBase64: signatureBase64
            }
          });
          showToastInfo('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå (‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô)');
        } catch (_) { }
        showError(CONSTANTS.MESSAGES.ERROR_ALCOHOL_SAVE);
      }
    }

    function renderTimeline(stops) {
      const container = document.getElementById('timelineContainer');
      const ul = document.getElementById('timeline');
      const nextStepEl = document.getElementById('nextStepAssistant');
      const countsEl = document.getElementById('filterCounts');
      const btnAll = document.getElementById('btnFilterAll');
      const btnPending = document.getElementById('btnFilterPending');
      const closeJobContainer = document.getElementById('closeJobContainer');
      const btnCloseJob = document.getElementById('btnCloseJob');
      const btnEndTrip = document.getElementById('btnEndTrip');

      ul.innerHTML = '';

      // reset ‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
      closeJobContainer.classList.add('hidden');
      if (btnCloseJob) {
        btnCloseJob.style.display = 'none';
        btnCloseJob.disabled = true;
      }
      if (btnEndTrip) {
        btnEndTrip.style.display = 'none';
        btnEndTrip.disabled = true;
      }

      if (!stops || stops.length === 0) {
        container.classList.add('hidden');
        if (nextStepEl) { nextStepEl.classList.add('hidden'); nextStepEl.innerHTML = ''; }
        return;
      }

      // compute pending per stop
      function isStopPending(stop) {
        const hasCheckIn = !!stop.checkInTime;
        const hasFuel = !!stop.fuelingTime;
        const hasUnloadDone = !!stop.unloadDoneTime;
        const hasReviewed = !!stop.reviewedTime;
        const hasCheckOut = !!stop.checkOutTime;
        const isOrigin = !!stop.isOriginStop;
        if (!hasCheckIn) return true;
        if (isOrigin) return !hasCheckOut;
        return (!hasFuel || !hasUnloadDone || !hasReviewed || !hasCheckOut);
      }

      // counts and active list
      const totalAll = stops.length;
      const totalPending = stops.filter(isStopPending).length;
      const list = (window.timelineFilter === 'pending') ? stops.filter(isStopPending) : stops;

      if (countsEl) {
        countsEl.textContent = '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ' + totalAll + ' | ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥ ' + totalPending;
      }
      if (btnAll && btnPending) {
        btnAll.classList.toggle('btn-active', window.timelineFilter !== 'pending');
        btnPending.classList.toggle('btn-active', window.timelineFilter === 'pending');
      }

      let allCheckout = true;

      // use full list to compute footer buttons, but render filtered list
      stops.forEach(function (stop) {
        const hasCheckIn = !!stop.checkInTime;
        const hasFuel = !!stop.fuelingTime;
        const hasUnloadDone = !!stop.unloadDoneTime;
        const hasReviewed = !!stop.reviewedTime;
        const hasCheckOut = !!stop.checkOutTime;
        const isOrigin = !!stop.isOriginStop;

        if (!hasCheckOut) {
          allCheckout = false;
        }
      });

      // Render items
      if (list.length === 0) {
        const li = document.createElement('div');
        li.style.cssText = 'padding:8px 12px;border:1px solid #e4ece9;border-radius:10px;background:#fff;color:#666;font-size:0.9rem;';
        li.textContent = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥';
        ul.appendChild(li);
      }

      list.forEach(function (stop) {
        const hasCheckIn = !!stop.checkInTime;
        const hasFuel = !!stop.fuelingTime;
        const hasUnloadDone = !!stop.unloadDoneTime;
        const hasReviewed = !!stop.reviewedTime;
        const hasCheckOut = !!stop.checkOutTime;
        const isOrigin = !!stop.isOriginStop;

        const statusLabel = stop.status || '-';

        let btnHtml = '';

        if (isOrigin) {
          if (!hasCheckIn) {
            btnHtml +=
              '<button class="btn-small btn-outline" type="button" ' +
              'onclick="startCheckin(' +
              stop.rowIndex +
              ', ' +
              stop.seq +
              ')">Check-in</button>';
          } else if (!hasCheckOut) {
            btnHtml +=
              '<button class="btn-small" type="button" ' +
              'onclick="updateStopStatus(' +
              stop.rowIndex +
              ", 'CHECKOUT', 'checkout', " +
              stop.seq +
              ')">Check-out</button>';
          }
        } else {
          if (!hasCheckIn) {
            btnHtml +=
              '<button class="btn-small btn-outline" type="button" ' +
              'onclick="startCheckin(' +
              stop.rowIndex +
              ', ' +
              stop.seq +
              ')">Check-in</button>';
          } else if (!hasFuel) {
            btnHtml +=
              '<button class="btn-small btn-warning" type="button" ' +
              'onclick="updateStopStatus(' +
              stop.rowIndex +
              ", 'FUELING', 'fuel', " +
              stop.seq +
              ')">‡∏•‡∏á‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô</button>';
          } else if (!hasUnloadDone) {
            btnHtml +=
              '<button class="btn-small btn-outline" type="button" ' +
              'onclick="updateStopStatus(' +
              stop.rowIndex +
              ", 'UNLOAD_DONE', 'unload', " +
              stop.seq +
              ')">‡∏•‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à</button>';
          } else if (!hasReviewed) {
            btnHtml +=
              '<button class="btn-small btn-outline" type="button" ' +
              'onclick="startReview(' +
              stop.rowIndex +
              ', ' +
              stop.seq +
              ')">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</button>';
          } else if (!hasCheckOut) {
            btnHtml +=
              '<button class="btn-small" type="button" ' +
              'onclick="updateStopStatus(' +
              stop.rowIndex +
              ", 'CHECKOUT', 'checkout', " +
              stop.seq +
              ')">Check-out</button>';
          }
        }

        let materialsBlock = '';
        if (stop.materials && stop.materials.length > 0) {
          const parts = stop.materials.map(function (m) {
            const name = m.materialDesc || m.material || '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
            const qty = m.totalQty || 0;
            return '- ' + safe(name) + ' ' + safe(qty);
          });
          materialsBlock =
            '<div class="materials-text"><b>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</b><br>' +
            parts.join('<br>') +
            '</div>';
        }

        const distanceText =
          stop.distanceKm !== undefined &&
            stop.distanceKm !== null &&
            stop.distanceKm !== ''
            ? stop.distanceKm
            : '-';

        const odoText =
          stop.checkInOdo !== undefined &&
            stop.checkInOdo !== null &&
            stop.checkInOdo !== ''
            ? stop.checkInOdo
            : '-';

        let navBtnHtml = '';
        if (
          stop.destLat !== undefined &&
          stop.destLat !== '' &&
          stop.destLng !== undefined &&
          stop.destLng !== ''
        ) {
          navBtnHtml =
            '<button class="btn-nav" type="button" aria-label="‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á" onclick="navigateToStop(' +
            stop.rowIndex +
            ')">‡∏ô‡∏≥‡∏ó‡∏≤‡∏á</button>';
        }

        const li = document.createElement('li');
        li.className = 'timeline-item';
        li.innerHTML =
          '<span class="timeline-marker"></span>' +
          '<div class="timeline-content">' +
          '<div class="timeline-header-row">' +
          '<div class="timeline-stop-label">' +
          'Stop ' +
          stop.seq +
          ' ‚Ä¢ ' +
          safe(stop.destination2 || '-') +
          '</div>' +
          '<div class="timeline-status">' +
          safe(statusLabel) +
          '</div>' +
          '</div>' +
          '<div class="timeline-sub">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ: ' +
          safe(stop.destination1 || '-') +
          '</div>' +
          '<div class="timeline-sub"><b>Shipment:</b> ' +
          safe(stop.shipmentNo || '-') +
          '</div>' +
          '<div class="timeline-sub"><b>Distance (‡∏£‡∏∞‡∏ö‡∏ö):</b> ' +
          safe(distanceText) +
          '</div>' +
          '<div class="timeline-sub"><b>Check-in:</b> ' +
          safe(stop.checkInTime || '-') +
          '</div>' +
          '<div class="timeline-sub"><b>‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå Check-in:</b> ' +
          safe(odoText) +
          '</div>' +
          '<div class="timeline-sub"><b>‡∏•‡∏á‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô:</b> ' +
          safe(stop.fuelingTime || '-') +
          '</div>' +
          '<div class="timeline-sub"><b>‡∏•‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à:</b> ' +
          safe(stop.unloadDoneTime || '-') +
          '</div>' +
          '<div class="timeline-sub"><b>‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô:</b> ' +
          safe(stop.reviewedTime || '-') +
          '</div>' +
          '<div class="timeline-sub"><b>Check-out:</b> ' +
          safe(stop.checkOutTime || '-') +
          '</div>' +
          materialsBlock +
          '<div class="action-row">' +
          btnHtml +
          navBtnHtml +
          '</div>' +
          '</div>';
        ul.appendChild(li);
      });

      // ‚úÖ Logic ‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô / ‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ
      if (stops.length > 0) {
        if (tripEnded) {
          // ‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
          closeJobContainer.classList.add('hidden');
          if (btnCloseJob) {
            btnCloseJob.style.display = 'none';
            btnCloseJob.disabled = true;
          }
          if (btnEndTrip) {
            btnEndTrip.style.display = 'none';
            btnEndTrip.disabled = true;
          }
        } else if (jobClosed) {
          // ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏õ‡∏∏‡πà‡∏° "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ"
          closeJobContainer.classList.remove('hidden');
          if (btnCloseJob) {
            btnCloseJob.style.display = 'none';
            btnCloseJob.disabled = true;
          }
          if (btnEndTrip) {
            btnEndTrip.style.display = 'block';
            btnEndTrip.disabled = false;
          }
        } else if (allCheckout) {
          // Checkout ‡∏Ñ‡∏£‡∏ö ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô ‚Üí ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏° "‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô"
          closeJobContainer.classList.remove('hidden');
          if (btnCloseJob) {
            btnCloseJob.style.display = 'block';
            btnCloseJob.disabled = false;
          }
          if (btnEndTrip) {
            btnEndTrip.style.display = 'none';
            btnEndTrip.disabled = true;
          }
        } else {
          closeJobContainer.classList.add('hidden');
        }
      } else {
        closeJobContainer.classList.add('hidden');
      }

      // Render Next Step Assistant card
      try { renderNextStepAssistant(stops); } catch (_) { }
      container.classList.remove('hidden');
    }

    // Next Step Assistant
    function computeNextStep(stops) {
      if (!stops || !stops.length) return null;
      // find first stop with pending step
      for (var i = 0; i < stops.length; i++) {
        var s = stops[i];
        var isOrigin = !!s.isOriginStop;
        var hasCheckIn = !!s.checkInTime;
        var hasFuel = !!s.fuelingTime;
        var hasUnloadDone = !!s.unloadDoneTime;
        var hasReviewed = !!s.reviewedTime;
        var hasCheckOut = !!s.checkOutTime;
        if (!hasCheckIn) return { rowIndex: s.rowIndex, seq: s.seq, type: 'checkin', label: 'Check-in', destination: s.destination2 || s.destination1 || ('‡∏à‡∏∏‡∏î ' + s.seq), isOrigin: isOrigin };
        if (!isOrigin && !hasFuel) return { rowIndex: s.rowIndex, seq: s.seq, type: 'fuel', label: '‡∏•‡∏á‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô', destination: s.destination2 || s.destination1 || ('‡∏à‡∏∏‡∏î ' + s.seq), isOrigin: isOrigin };
        if (!isOrigin && !hasUnloadDone) return { rowIndex: s.rowIndex, seq: s.seq, type: 'unload', label: '‡∏•‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à', destination: s.destination2 || s.destination1 || ('‡∏à‡∏∏‡∏î ' + s.seq), isOrigin: isOrigin };
        if (!isOrigin && !hasReviewed) return { rowIndex: s.rowIndex, seq: s.seq, type: 'review', label: '‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô', destination: s.destination2 || s.destination1 || ('‡∏à‡∏∏‡∏î ' + s.seq), isOrigin: isOrigin };
        if (!hasCheckOut) return { rowIndex: s.rowIndex, seq: s.seq, type: 'checkout', label: 'Check-out', destination: s.destination2 || s.destination1 || ('‡∏à‡∏∏‡∏î ' + s.seq), isOrigin: isOrigin };
      }
      // no pending per-stop; suggest close job / end trip
      var allCheckout = stops.every(function (s) { return !!s.checkOutTime; });
      if (allCheckout && !jobClosed) return { type: 'close_job', label: '‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô (‡∏£‡∏ñ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô)' };
      if (jobClosed && !tripEnded) return { type: 'end_trip', label: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ' };
      return null;
    }

    function renderNextStepAssistant(stops) {
      var card = document.getElementById('nextStepAssistant');
      if (!card) return;
      var next = computeNextStep(stops);
      if (!next) { card.classList.add('hidden'); card.innerHTML = ''; return; }

      var html = '';
      if (next.type === 'close_job') {
        html = '<div style="display:flex;gap:8px;align-items:center;justify-content:space-between;">' +
          '<div><div style="font-weight:700;color:#16a085;">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</div><div>‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</div></div>' +
          '<button type="button" class="btn-small" onclick="closeJob()">‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô</button>' +
          '</div>';
      } else if (next.type === 'end_trip') {
        html = '<div style="display:flex;gap:8px;align-items:center;justify-content:space-between;">' +
          '<div><div style="font-weight:700;color:#16a085;">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</div><div>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡πÅ‡∏•‡∏∞‡∏à‡∏∏‡∏î‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ</div></div>' +
          '<button type="button" class="btn-small" onclick="openEndTripDialog()">‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ</button>' +
          '</div>';
      } else {
        var actionBtn = '';
        if (next.type === 'checkin') {
          actionBtn = '<button type="button" class="btn-small" onclick="startCheckin(' + next.rowIndex + ',' + next.seq + ')">‡∏ó‡∏≥‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</button>';
        } else if (next.type === 'fuel') {
          actionBtn = '<button type="button" class="btn-small" onclick="updateStopStatus(' + next.rowIndex + ',\'FUELING\',\'fuel\',' + next.seq + ')">‡∏ó‡∏≥‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</button>';
        } else if (next.type === 'unload') {
          actionBtn = '<button type="button" class="btn-small" onclick="updateStopStatus(' + next.rowIndex + ',\'UNLOAD_DONE\',\'unload\',' + next.seq + ')">‡∏ó‡∏≥‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</button>';
        } else if (next.type === 'review') {
          actionBtn = '<button type="button" class="btn-small" onclick="startReview(' + next.rowIndex + ',' + next.seq + ')">‡∏ó‡∏≥‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</button>';
        } else if (next.type === 'checkout') {
          actionBtn = '<button type="button" class="btn-small" onclick="updateStopStatus(' + next.rowIndex + ',\'CHECKOUT\',\'checkout\',' + next.seq + ')">‡∏ó‡∏≥‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</button>';
        }

        html = '<div style="display:flex;gap:8px;align-items:center;justify-content:space-between;">' +
          '<div>' +
          '<div style="font-weight:700;color:#16a085;">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</div>' +
          '<div>Stop ' + safe(next.seq) + ' ‚Ä¢ ' + safe(next.destination || '-') + ' ‚Üí ' + safe(next.label) + '</div>' +
          '</div>' + actionBtn + '</div>';
      }

      card.innerHTML = html;
      card.classList.remove('hidden');
    }

    function getCurrentPositionAsync() {
      return new Promise(function (resolve, reject) {
        if (!navigator.geolocation) {
          reject(new Error('‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á'));
          return;
        }
        navigator.geolocation.getCurrentPosition(
          function (pos) {
            resolve(pos);
          },
          function (err) {
            reject(err);
          },
          { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 }
        );
      });
    }

    async function startCheckin(rowIndex, seq) {
      if (currentDrivers.length > 0 && currentCheckedDrivers.length === 0) {
        showInfo(
          '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô',
          '‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ñ‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ Check-in ‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á‡πÅ‡∏£‡∏Å'
        );
        return;
      }

      const { value: formValues } = await Swal.fire({
        icon: 'question',
        title: '‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡∏£‡∏ñ',
        html: `
            <div style="text-align:left;">
              <label style="font-size:0.8rem;color:#555;">‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡∏£‡∏ñ ‡∏ì ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà Check-in</label>
              <input id="swalOdoInput" type="number" inputmode="numeric"
                class="swal2-input"
                placeholder="‡πÄ‡∏ä‡πà‡∏ô 123456"
                style="width:100%;margin:6px 0 4px;">
            </div>
          `,
        focusConfirm: false,
        showCancelButton: true,
        confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô Check-in',
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
        confirmButtonColor: '#1abc9c',
        preConfirm: function () {
          const val = document.getElementById('swalOdoInput').value.trim();
          if (!val) {
            Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡∏£‡∏ñ');
            return false;
          }
          const num = Number(val);
          if (!Number.isFinite(num) || num < 0 || num > 3000000) {
            Swal.showValidationMessage('‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 0 - 3,000,000');
            return false;
          }
          return { odo: String(Math.floor(num)) };
        },
      });

      if (!formValues) {
        return;
      }

      const odo = formValues.odo;
      await updateStopStatus(rowIndex, 'CHECKIN', 'checkin', seq, odo);
      startWorkTimer();
    }

    /**
     * Updates stop status (check-in, check-out, fueling, unload, etc.)
     * @param {number} rowIndex - Stop row index
     * @param {string} newStatus - New status value
     * @param {string} type - Action type (checkin, checkout, fuel, unload)
     * @param {number} seq - Stop sequence
     * @param {string|number} odo - Odometer value for check-in
     */
    async function updateStopStatus(rowIndex, newStatus, type, seq, odo) {
      if (isUpdatingStop) return;
      try {
        isUpdatingStop = true;
        showLoading(CONSTANTS.MESSAGES.LOADING_GET_COORDINATES);

        let pos;
        try {
          pos = await getCurrentPositionAsync();
        } catch (err) {
          window.Logger.warn('GPS error', err);
          closeLoading();
          showError(CONSTANTS.MESSAGES.ERROR_GPS);
          return;
        }

        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        const acc = pos.coords.accuracy != null ? pos.coords.accuracy : undefined;

        showLoading(CONSTANTS.MESSAGES.LOADING_UPDATE);

        const payload = {
          rowIndex: rowIndex,
          status: newStatus,
          type: type,
          userId: currentUserId,
          lat: lat,
          lng: lng,
          odo: type === 'checkin' ? odo : undefined,
          accuracy: acc
        };

        let result;
        try {
          result = await window.API.updateStop(payload);
        } catch (networkErr) {
          enqueueAction({ type: 'UPDATE_STOP', payload });
          closeLoading();
          showToastInfo('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå (‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏∏‡∏î)');
          return;
        }

        closeLoading();

        if (!result.success) {
          showError(result.message);
          return;
        }

        await showSuccess(
          '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
          result.message || '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'
        );

        const stopInfo = result.data && result.data.stop ? result.data.stop : null;
        if (stopInfo) {
          if (acc != null) stopInfo.gpsAccuracy = acc;
          showInlineFlex(type, stopInfo);
          sendFlexCheckInOut(type, stopInfo);
        }

        if (currentReference) {
          document.getElementById('keyword').value = currentReference;
          await search();
        }

        window.Logger.info('‚úÖ Stop status updated', { rowIndex, newStatus, type });
      } catch (err) {
        window.Logger.error('‚ùå Update stop error', err);
        closeLoading();
        try {
          enqueueAction({
            type: 'UPDATE_STOP', payload: {
              rowIndex: rowIndex,
              status: newStatus,
              type: type,
              userId: currentUserId
            }
          });
          showToastInfo('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå (‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏∏‡∏î)');
        } catch (_) { }
        showError(CONSTANTS.MESSAGES.ERROR_UPDATE_FAILED);
      } finally {
        isUpdatingStop = false;
      }
    }

    // ‡∏ü‡∏≠‡∏£‡πå‡∏° "‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ"
    async function openEndTripDialog() {
      if (!currentReference) {
        showInfo('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏•‡∏Ç‡∏á‡∏≤‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô');
        return;
      }

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏≥
      const missingSteps = checkMissingSteps();

      if (missingSteps.length > 0) {
        // ‡πÅ‡∏™‡∏î‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î
        const result = await showMissingStepsForm(missingSteps);
        if (!result) {
          return; // ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
        }

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô
        const saveResult = await saveMissingStepsData(result.missingData);
        if (!saveResult) {
          showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
          return;
        }

        // Refresh ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        await search();
      }

      const formValuesResult = await Swal.fire({
        title: '‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ',
        html: `
            <div style="text-align:left;">
              <div style="font-size:0.85rem;color:#555;margin-bottom:6px;">
                Reference: <b>${currentReference}</b>
              </div>

              <label style="font-size:0.8rem;color:#555;">‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ</label>
              <input id="swalEndOdo" type="number" min="0" step="1"
                class="swal2-input"
                placeholder="‡πÄ‡∏ä‡πà‡∏ô 234567"
                style="width:100%;margin:4px 0 8px;">

              <label style="font-size:0.8rem;color:#555;">‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏∏‡∏î‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ</label>
              <input id="swalEndPoint" type="text"
                class="swal2-input"
                placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ö‡∏≤‡∏á‡∏ô‡∏≤ / ‡∏•‡∏≤‡∏ô‡∏à‡∏≠‡∏î‡∏Ñ‡∏•‡∏±‡∏á‡∏´‡∏•‡∏±‡∏Å"
                style="width:100%;margin:4px 0 6px;">

              <div style="margin-top:6px;font-size:0.78rem;color:#888;">
                * ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå ‡∏à‡∏∏‡∏î‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS (Lat/Long) ‡∏ì ‡πÄ‡∏ß‡∏•‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
              </div>
            </div>
          `,
        focusConfirm: false,
        showCancelButton: true,
        confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ',
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
        confirmButtonColor: '#1abc9c',
        cancelButtonColor: '#95a5a6',
        preConfirm: function () {
          const odoVal = document
            .getElementById('swalEndOdo')
            .value.trim();
          const pointVal = document
            .getElementById('swalEndPoint')
            .value.trim();

          if (!odoVal) {
            Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ');
            return false;
          }
          const odoNum = parseFloat(odoVal);
          if (isNaN(odoNum) || odoNum < 0) {
            Swal.showValidationMessage(
              '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (0 ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ)'
            );
            return false;
          }
          if (!pointVal) {
            Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏∏‡∏î‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ');
            return false;
          }

          return {
            endOdo: odoVal,
            endPointName: pointVal,
          };
        },
      });

      const formValues = formValuesResult.value;
      if (!formValues) {
        return;
      }

      await saveEndTripSummary(formValues);
    }

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏≥
    function checkMissingSteps() {
      const missing = [];

      if (!lastStops || lastStops.length === 0) {
        return missing;
      }

      lastStops.forEach(function (stop) {
        const isOrigin = !!stop.isOriginStop;
        const stopInfo = {
          rowIndex: stop.rowIndex,
          seq: stop.seq,
          destination: stop.destination2 || stop.destination1 || '‡∏à‡∏∏‡∏î ' + stop.seq,
          isOrigin: isOrigin,
          missing: []
        };

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Check-in
        if (!stop.checkInTime) {
          stopInfo.missing.push({
            type: 'checkin',
            label: 'Check-in',
            needOdo: true,
            needTime: true
          });
        }

        // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Origin
        if (!isOrigin) {
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏•‡∏á‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô
          if (stop.checkInTime && !stop.fuelingTime) {
            stopInfo.missing.push({
              type: 'fuel',
              label: '‡∏•‡∏á‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô',
              needOdo: false,
              needTime: true
            });
          }

          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏•‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à
          if (stop.fuelingTime && !stop.unloadDoneTime) {
            stopInfo.missing.push({
              type: 'unload',
              label: '‡∏•‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à',
              needOdo: false,
              needTime: true
            });
          }

          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô
          if (stop.unloadDoneTime && !stop.reviewedTime) {
            stopInfo.missing.push({
              type: 'review',
              label: '‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô',
              needOdo: false,
              needTime: true
            });
          }
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Check-out
        if (stop.checkInTime && !stop.checkOutTime) {
          stopInfo.missing.push({
            type: 'checkout',
            label: 'Check-out',
            needOdo: false,
            needTime: true
          });
        }

        if (stopInfo.missing.length > 0) {
          missing.push(stopInfo);
        }
      });

      return missing;
    }

    // ‡πÅ‡∏™‡∏î‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î
    async function showMissingStepsForm(missingSteps) {
      let formHtml = `
        <div style="text-align:left;max-height:400px;overflow-y:auto;">
          <div style="background:#fff3cd;border:1px solid #ffc107;border-radius:8px;padding:8px;margin-bottom:10px;">
            <div style="font-size:0.85rem;color:#856404;">
              ‚ö†Ô∏è <b>‡∏û‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏≥ ${missingSteps.length} ‡∏à‡∏∏‡∏î</b><br>
              ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô
            </div>
          </div>
      `;

      missingSteps.forEach(function (stop, stopIdx) {
        formHtml += `
          <div style="background:#f8f9fa;border:1px solid #dee2e6;border-radius:8px;padding:10px;margin-bottom:10px;">
            <div style="font-weight:600;font-size:0.9rem;margin-bottom:8px;color:#16a085;">
              Stop ${stop.seq}: ${stop.destination}
            </div>
        `;

        stop.missing.forEach(function (step, stepIdx) {
          const fieldPrefix = 'stop' + stopIdx + '_step' + stepIdx;

          formHtml += '<div style="margin-bottom:8px;padding:8px;background:#fff;border-radius:6px;">' +
            '<div style="font-size:0.85rem;font-weight:600;margin-bottom:4px;">' +
            step.label +
            '</div>';

          if (step.needOdo) {
            formHtml += '<label style="font-size:0.75rem;color:#666;">\u0e40\u0e25\u0e02\u0e44\u0e21\u0e25\u0e4c</label>' +
              '<input id="' + fieldPrefix + '_odo" type="number" ' +
              'class="swal2-input" ' +
              'data-stopidx="' + stopIdx + '" ' +
              'data-stepidx="' + stepIdx + '"' +
              'data-field="odo"' +
              'placeholder="\u0e01\u0e23\u0e2d\u0e01\u0e40\u0e25\u0e02\u0e44\u0e21\u0e25\u0e4c"' +
              'style="width:100%;margin:2px 0 6px;padding:6px 10px;font-size:0.85rem;">';
          }

          if (step.needTime) {
            formHtml += '<label style="font-size:0.75rem;color:#666;">\u0e27\u0e31\u0e19\u0e17\u0e35\u0e48\u0e41\u0e25\u0e30\u0e40\u0e27\u0e25\u0e32</label>' +
              '<input id="' + fieldPrefix + '_datetime" type="datetime-local" ' +
              'class="swal2-input"' +
              'data-stopidx="' + stopIdx + '"' +
              'data-stepidx="' + stepIdx + '"' +
              'data-field="datetime"' +
              'style="width:100%;margin:2px 0 4px;padding:6px 10px;font-size:0.85rem;">';
          }

          formHtml += '</div>';
        });

        formHtml += '</div>';
      });

      formHtml += '</div>';

      const confirmedResult = await Swal.fire({
        title: '‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡∏´‡∏≤‡∏¢‡πÑ‡∏õ',
        html: formHtml,
        width: '90%',
        focusConfirm: false,
        showCancelButton: true,
        confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
        confirmButtonColor: '#1abc9c',
        cancelButtonColor: '#95a5a6',
        preConfirm: function () {
          const missingData = [];

          missingSteps.forEach(function (stop, stopIdx) {
            stop.missing.forEach(function (step, stepIdx) {
              const fieldPrefix = 'stop' + stopIdx + '_step' + stepIdx;
              const data = {
                rowIndex: stop.rowIndex,
                seq: stop.seq,
                destination: stop.destination,
                type: step.type,
                label: step.label
              };

              if (step.needOdo) {
                const odoEl = document.getElementById(fieldPrefix + '_odo');
                const odoVal = odoEl ? odoEl.value.trim() : '';
                if (!odoVal) {
                  Swal.showValidationMessage('\u0e01\u0e23\u0e38\u0e13\u0e32\u0e01\u0e23\u0e2d\u0e01\u0e40\u0e25\u0e02\u0e44\u0e21\u0e25\u0e4c\u0e2a\u0e33\u0e2b\u0e23\u0e31\u0e1a ' + stop.destination + ' - ' + step.label);
                  return false;
                }
                data.odo = odoVal;
              }

              if (step.needTime) {
                const dtEl = document.getElementById(fieldPrefix + '_datetime');
                const dtVal = dtEl ? dtEl.value.trim() : '';
                if (!dtVal) {
                  Swal.showValidationMessage('\u0e01\u0e23\u0e38\u0e13\u0e32\u0e01\u0e23\u0e2d\u0e01\u0e27\u0e31\u0e19\u0e17\u0e35\u0e48\u0e41\u0e25\u0e30\u0e40\u0e27\u0e25\u0e32\u0e2a\u0e33\u0e2b\u0e23\u0e31\u0e1a ' + stop.destination + ' - ' + step.label);
                  return false;
                }
                data.datetime = dtVal;
              }

              missingData.push(data);
            });
          });

          return { missingData };
        }
      });

      const confirmed = confirmedResult.value;
      if (!confirmed) {
        return null;
      }

      return confirmed;
    }

    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡πÑ‡∏õ
    /**
     * Saves missing step data before end-trip
     * @param {Object} missingData - Missing data to submit
     * @returns {Promise<boolean>} Success flag
     */
    async function saveMissingStepsData(missingData) {
      try {
        showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡∏´‡∏≤‡∏¢‡πÑ‡∏õ...');

        // Get current position
        let pos;
        try {
          pos = await getCurrentPositionAsync();
        } catch (err) {
          window.Logger.warn('Geolocation error', err);
          closeLoading();
          showError(CONSTANTS.MESSAGES.ERROR_GPS);
          return false;
        }

        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        const acc = pos.coords.accuracy != null ? pos.coords.accuracy : undefined;

        // If offline, enqueue and exit as success
        if (!isOnline()) {
          enqueueAction({
            type: 'FILL_MISSING',
            payload: {
              reference: currentReference,
              userId: currentUserId,
              lat: lat,
              lng: lng,
              missingData: missingData,
              accuracy: acc
            }
          });
          closeLoading();
          showToastInfo('‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡πÑ‡∏õ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏•‡πâ‡∏ß');
          window.Logger.info('üì• Queued missing steps data (offline)');
          return true;
        }

        // Submit missing data via centralized API (online path)
        const result = await window.API.fillMissingSteps({
          reference: currentReference,
          userId: currentUserId,
          lat: lat,
          lng: lng,
          missingData: missingData,
          accuracy: acc
        });

        closeLoading();

        if (!result.success) {
          // Enqueue for later sync on API failure
          enqueueAction({
            type: 'FILL_MISSING',
            payload: {
              reference: currentReference,
              userId: currentUserId,
              lat: lat,
              lng: lng,
              missingData: missingData,
              accuracy: acc
            }
          });
          showToastInfo('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏¥‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ã‡∏¥‡∏á‡∏Å‡πå‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á');
          window.Logger.warn('‚ö†Ô∏è fillMissing failed; queued for retry', result);
          return true;
        }

        await showSuccess(CONSTANTS.MESSAGES.SUCCESS_TITLE, '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
        window.Logger.info('‚úÖ Missing steps data saved', { fields: Object.keys(missingData) });
        return true;
      } catch (err) {
        window.Logger.error('‚ùå Missing steps save error', err);
        // Enqueue on unexpected error
        try {
          // Best-effort to include last known coords if present above
          const payload = {
            reference: currentReference,
            userId: currentUserId,
            missingData: missingData
          };
          // Attempt to reuse last position from closure if available
          if (typeof pos !== 'undefined' && pos && pos.coords) {
            payload.lat = pos.coords.latitude;
            payload.lng = pos.coords.longitude;
            if (pos.coords.accuracy != null) payload.accuracy = pos.coords.accuracy;
          }
          enqueueAction({ type: 'FILL_MISSING', payload });
          showToastInfo('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏¥‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ã‡∏¥‡∏á‡∏Å‡πå‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á');
        } catch (_) { }
        closeLoading();
        return true;
      }
    }

    // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ‡πÑ‡∏õ backend (‡∏£‡∏ß‡∏°‡∏û‡∏¥‡∏Å‡∏±‡∏î Lat/Long) + ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    /**
     * Saves end-of-trip summary data
     * @param {Object} values - Form values {endOdo, endPointName}
     */
    async function saveEndTripSummary(values) {
      try {
        showLoading(CONSTANTS.MESSAGES.LOADING_GET_COORDINATES);

        let pos;
        try {
          pos = await getCurrentPositionAsync();
        } catch (err) {
          window.Logger.warn('Geolocation error in endTrip', err);
          closeLoading();

          // Fallback: Ask user to enter coordinates manually or proceed without GPS
          const fallbackResult = await Swal.fire({
            title: CONSTANTS.MESSAGES.ERROR_GPS,
            html: '<div style="text-align:left;font-size:0.85rem;color:#555;">‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏£‡∏≠‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÄ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏¥‡∏Å‡∏±‡∏î</div>' +
              '<input id="swalLat" class="swal2-input" placeholder="‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î (‡πÄ‡∏ä‡πà‡∏ô 13.7563)" type="number" step="0.0001">' +
              '<input id="swalLng" class="swal2-input" placeholder="‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î (‡πÄ‡∏ä‡πà‡∏ô 100.5018)" type="number" step="0.0001">',
            showCancelButton: true,
            confirmButtonText: CONSTANTS.MESSAGES.BUTTON_OK,
            cancelButtonText: CONSTANTS.MESSAGES.BUTTON_CANCEL,
            confirmButtonColor: '#1abc9c',
            preConfirm: function () {
              const latStr = (document.getElementById('swalLat') || {}).value || '';
              const lngStr = (document.getElementById('swalLng') || {}).value || '';
              const latNum = latStr ? Number(latStr) : null;
              const lngNum = lngStr ? Number(lngStr) : null;

              // Validate coordinates if provided
              if ((latStr && !Number.isFinite(latNum)) || (lngStr && !Number.isFinite(lngNum))) {
                Swal.showValidationMessage('‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                return false;
              }
              const coordsValidation = window.Validators.validateCoordinates(latNum, lngNum);
              if (!coordsValidation.valid) {
                Swal.showValidationMessage(coordsValidation.error);
                return false;
              }
              return { lat: latNum, lng: lngNum };
            }
          });

          const fallback = fallbackResult.value;
          if (!fallback) return;

          showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ...');

          const result = await window.API.endTrip({
            reference: currentReference,
            userId: currentUserId,
            endOdo: values.endOdo || 0,
            endPointName: values.endPointName || '',
            lat: fallback.lat || 0,
            lng: fallback.lng || 0
          });

          closeLoading();

          if (!result.success) {
            showError(result.message);
            return;
          }

          tripEnded = true;
          await showSuccess(CONSTANTS.MESSAGES.SUCCESS_TITLE, '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß\n‡∏Å‡∏£‡∏ì‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏à‡πâ‡∏á‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 1 ‡∏ß‡∏±‡∏ô');

          // Hide end-trip buttons
          const closeJobContainer = document.getElementById('closeJobContainer');
          const btnCloseJob = document.getElementById('btnCloseJob');
          const btnEndTrip = document.getElementById('btnEndTrip');
          if (closeJobContainer) closeJobContainer.classList.add('hidden');
          if (btnCloseJob) { btnCloseJob.style.display = 'none'; btnCloseJob.disabled = true; }
          if (btnEndTrip) { btnEndTrip.style.display = 'none'; btnEndTrip.disabled = true; }

          if (currentReference) {
            document.getElementById('keyword').value = currentReference;
            await search();
          }
          window.Logger.info('‚úÖ End trip (fallback GPS) completed', { endOdo: values.endOdo });
          return;
        }

        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        const acc = pos.coords.accuracy != null ? pos.coords.accuracy : undefined;

        showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ...');

        const payload = {
          reference: currentReference,
          userId: currentUserId,
          endOdo: values.endOdo || 0,
          endPointName: values.endPointName || '',
          lat: lat,
          lng: lng,
          accuracy: acc
        };

        let result;
        try {
          result = await window.API.endTrip(payload);
        } catch (networkErr) {
          enqueueAction({ type: 'END_TRIP', payload });
          closeLoading();
          showToastInfo('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå (‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ)');
          return;
        }

        closeLoading();

        if (!result.success) {
          showError(result.message);
          return;
        }

        // Mark trip as ended
        tripEnded = true;

        await showSuccess(
          CONSTANTS.MESSAGES.SUCCESS_TITLE,
          '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß\n‡∏Å‡∏£‡∏ì‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏à‡πâ‡∏á‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 1 ‡∏ß‡∏±‡∏ô'
        );

        // Hide end-trip buttons
        const closeJobContainer = document.getElementById('closeJobContainer');
        const btnCloseJob = document.getElementById('btnCloseJob');
        const btnEndTrip = document.getElementById('btnEndTrip');
        if (closeJobContainer) closeJobContainer.classList.add('hidden');
        if (btnCloseJob) {
          btnCloseJob.style.display = 'none';
          btnCloseJob.disabled = true;
        }
        if (btnEndTrip) {
          btnEndTrip.style.display = 'none';
          btnEndTrip.disabled = true;
        }

        // Refresh data
        if (currentReference) {
          document.getElementById('keyword').value = currentReference;
          await search();
        }
        window.Logger.info('‚úÖ End trip completed', { endOdo: values.endOdo });
      } catch (err) {
        window.Logger.error('‚ùå End trip error', err);
        closeLoading();
        try {
          enqueueAction({
            type: 'END_TRIP', payload: {
              reference: currentReference,
              userId: currentUserId,
              endOdo: values.endOdo || 0,
              endPointName: values.endPointName || ''
            }
          });
          showToastInfo('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå (‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ)');
        } catch (_) { }
        showError(CONSTANTS.MESSAGES.ERROR_ALCOHOL_SAVE);
      }
    }

    /**
     * Closes the job (marks vehicle as ready)
     */
    async function closeJob() {
      if (!currentReference) {
        showInfo(CONSTANTS.MESSAGES.INFO_NOT_FOUND, '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô');
        return;
      }

      const confirmResult = await Swal.fire({
        icon: 'question',
        title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô?',
        text: '‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡πà‡∏≤‡∏£‡∏ñ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô',
        showCancelButton: true,
        confirmButtonText: CONSTANTS.MESSAGES.BUTTON_SAVE,
        cancelButtonText: CONSTANTS.MESSAGES.BUTTON_CANCEL,
        confirmButtonColor: '#1abc9c',
      });

      if (!confirmResult.isConfirmed) return;

      try {
        showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô...');

        const payload = {
          reference: currentReference,
          userId: currentUserId
        };
        let result;
        try {
          result = await window.API.closeJob(payload);
        } catch (networkErr) {
          enqueueAction({ type: 'CLOSE_JOB', payload });
          closeLoading();
          showToastInfo('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå (‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô)');
          return;
        }

        closeLoading();

        if (!result.success) {
          showError(result.message);
          return;
        }

        jobClosed = true;

        if (result.data && result.data.stop) {
          showInlineFlex('closejob', result.data.stop);
        }

        await showSuccess(CONSTANTS.MESSAGES.SUCCESS_CLOSEJOB, CONSTANTS.MESSAGES.INFO_IMPORTANT);

        // Reload data so d.jobClosed=true is reflected in UI
        if (currentReference) {
          document.getElementById('keyword').value = currentReference;
          await search();
        }

        window.Logger.info('‚úÖ Job closed successfully');
      } catch (err) {
        window.Logger.error('‚ùå Close job error', err);
        closeLoading();
        try { enqueueAction({ type: 'CLOSE_JOB', payload: { reference: currentReference, userId: currentUserId } }); showToastInfo('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå (‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô)'); } catch (_) { }
        showError(CONSTANTS.MESSAGES.ERROR_ALCOHOL_SAVE);
      }
    }

    /**
     * Generate and send Daily Summary Report
     */
    async function generateDailySummary() {
      if (!currentReference || !lastStops || lastStops.length === 0) {
        showInfo('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô');
        return;
      }

      try {
        showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô...');

        const stops = lastStops || [];
        const totalStops = stops.length;
        const completedStops = stops.filter(function (s) { return !!s.checkOutTime; }).length;
        const pendingStops = totalStops - completedStops;

        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
        let totalDistance = 0;
        stops.forEach(function (s) {
          if (s.distance && typeof s.distance === 'number') totalDistance += s.distance;
        });

        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ check-in ‡πÅ‡∏£‡∏Å‡πÅ‡∏•‡∏∞ check-out ‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢)
        const firstCheckin = stops.find(function (s) { return !!s.checkInTime; });
        const lastCheckout = stops.filter(function (s) { return !!s.checkOutTime; }).pop();
        let workDuration = '-';
        if (firstCheckin && lastCheckout && firstCheckin.checkInTime && lastCheckout.checkOutTime) {
          try {
            const start = new Date('2000-01-01 ' + firstCheckin.checkInTime);
            const end = new Date('2000-01-01 ' + lastCheckout.checkOutTime);
            const diffMs = end - start;
            const diffHrs = Math.floor(diffMs / 3600000);
            const diffMins = Math.floor((diffMs % 3600000) / 60000);
            workDuration = diffHrs + ' ‡∏ä‡∏°. ' + diffMins + ' ‡∏ô‡∏≤‡∏ó‡∏µ';
          } catch (_) { }
        }

        closeLoading();

        const summaryHtml = `
          <div style="text-align:left;">
            <div style="margin-bottom:12px;padding:12px;background:#f7faf9;border-radius:8px;border:1px solid #dce2e0;">
              <div style="font-weight:600;margin-bottom:8px;font-size:1rem;color:#16a085;">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</div>
              <div style="font-size:0.9rem;margin-bottom:4px;">üì¶ Reference: <strong>${safe(currentReference)}</strong></div>
              <div style="font-size:0.9rem;margin-bottom:4px;">üìç ‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <strong>${totalStops}</strong> ‡∏à‡∏∏‡∏î</div>
              <div style="font-size:0.9rem;margin-bottom:4px;">‚úÖ ‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: <strong>${completedStops}</strong> ‡∏à‡∏∏‡∏î</div>
              <div style="font-size:0.9rem;margin-bottom:4px;">‚è≥ ‡∏Ñ‡∏á‡∏Ñ‡πâ‡∏≤‡∏á: <strong>${pendingStops}</strong> ‡∏à‡∏∏‡∏î</div>
              <div style="font-size:0.9rem;margin-bottom:4px;">üõ£Ô∏è ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏£‡∏ß‡∏°: <strong>${totalDistance > 0 ? totalDistance.toFixed(1) + ' km' : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</strong></div>
              <div style="font-size:0.9rem;">‚è±Ô∏è ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô: <strong>${workDuration}</strong></div>
            </div>
            <div style="font-size:0.85rem;color:#666;margin-top:8px;">‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏ú‡πà‡∏≤‡∏ô LINE ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</div>
          </div>
        `;

        const { value: confirm } = await Swal.fire({
          title: 'üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô',
          html: summaryHtml,
          showCancelButton: true,
          confirmButtonText: '‡∏™‡πà‡∏á‡∏ú‡πà‡∏≤‡∏ô LINE',
          cancelButtonText: '‡∏õ‡∏¥‡∏î',
          confirmButtonColor: '#1abc9c',
        });

        if (confirm && liff && liff.isLoggedIn()) {
          const msg =
            'üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô\n' +
            'üì¶ Reference: ' + currentReference + '\n' +
            'üìç ‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ' + totalStops + ' ‡∏à‡∏∏‡∏î\n' +
            '‚úÖ ‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + completedStops + ' ‡∏à‡∏∏‡∏î\n' +
            '‚è≥ ‡∏Ñ‡∏á‡∏Ñ‡πâ‡∏≤‡∏á: ' + pendingStops + ' ‡∏à‡∏∏‡∏î\n' +
            'üõ£Ô∏è ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏£‡∏ß‡∏°: ' + (totalDistance > 0 ? totalDistance.toFixed(1) + ' km' : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏') + '\n' +
            '‚è±Ô∏è ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô: ' + workDuration;

          await liff.sendMessages([{ type: 'text', text: msg }]);
          showToastSuccess('‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡πà‡∏≤‡∏ô LINE ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
          window.Logger.info('‚úÖ Daily summary sent via LINE');
        }
      } catch (err) {
        window.Logger.error('‚ùå Daily summary error', err);
        closeLoading();
        showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ');
      }
    }

    function navigateToStop(rowIndex) {
      const stop = (lastStops || []).find(function (s) { return s.rowIndex === rowIndex; });
      if (!stop) return;

      const lat =
        stop.destLat ||
        stop.destinationLat ||
        stop.dest_lat ||
        stop.lat ||
        '';
      const lng =
        stop.destLng ||
        stop.destinationLng ||
        stop.dest_lng ||
        stop.lng ||
        '';

      if (!lat || !lng) {
        Swal.fire({
          icon: 'warning',
          title: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á',
          text: '‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö',
          confirmButtonColor: '#1abc9c',
        });
        return;
      }

      const url =
        'https://www.google.com/maps?q=' +
        encodeURIComponent(lat) +
        ',' +
        encodeURIComponent(lng);
      window.open(url, '_blank');
    }

    document.addEventListener('DOMContentLoaded', function () {
      // Disable search until LIFF initializes
      const btnSearchEl = document.getElementById('btnSearch');
      if (btnSearchEl) btnSearchEl.disabled = true;

      // Auto-init LIFF ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö login ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
      initLiff();

      document
        .getElementById('btnSearch')
        .addEventListener('click', search);

      // Debounced auto-search on input (only when logged in)
      const debounced = (function () {
        let tId;
        const fn = function () {
          const kw = document.getElementById('keyword').value.trim();
          if (!currentUserId) return;
          if (kw && kw.length >= 5) {
            search();
          }
        };
        const wrapper = function () {
          clearTimeout(tId);
          tId = setTimeout(fn, 450);
        };
        wrapper.cancel = function () { clearTimeout(tId); };
        return wrapper;
      })();

      const kwEl = document.getElementById('keyword');
      kwEl.addEventListener('input', debounced);
      kwEl.addEventListener('keyup', function (e) {
        if (e.key === 'Enter') {
          debounced.cancel();
          search();
        }
      });

      document
        .getElementById('btnCloseJob')
        .addEventListener('click', closeJob);

      document
        .getElementById('btnEndTrip')
        .addEventListener('click', openEndTripDialog);

      // Timeline filter events
      window.timelineFilter = 'all';
      const btnAll = document.getElementById('btnFilterAll');
      const btnPending = document.getElementById('btnFilterPending');
      if (btnAll) {
        btnAll.addEventListener('click', function () {
          window.timelineFilter = 'all';
          renderTimeline(lastStops || []);
        });
      }
      if (btnPending) {
        btnPending.addEventListener('click', function () {
          window.timelineFilter = 'pending';
          renderTimeline(lastStops || []);
        });
      }

      // Diagnostics wiring
      const btnRunDiag = document.getElementById('btnRunDiag');
      const btnToggleDiag = document.getElementById('btnToggleDiag');
      const diagBody = document.getElementById('diagBody');
      if (btnToggleDiag && diagBody) {
        btnToggleDiag.addEventListener('click', function () {
          diagBody.classList.toggle('hidden');
        });
      }
      if (btnRunDiag) {
        btnRunDiag.addEventListener('click', runDiagnostics);
      }

      // Wire Sync control
      const stSyncBtn = document.getElementById('stSyncBtn');
      if (stSyncBtn) stSyncBtn.addEventListener('click', processActionQueue);

      // Wire SOS button
      const btnSOS = document.getElementById('btnSOS');
      if (btnSOS) btnSOS.addEventListener('click', triggerSOS);

      // Auto-sync when network returns
      window.addEventListener('online', async function () {
        try { showToastInfo('‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡∏¥‡∏á‡∏Å‡πå...'); } catch (_) { }
        try { await processActionQueue(); } catch (_) { }
        try {
          const liffReady = typeof liff !== 'undefined';
          const loggedIn = liffReady && liff.isLoggedIn ? liff.isLoggedIn() : false;
          updateStatusTray({ liffReady, loggedIn, backendOk: null, gpsOk: null });
        } catch (_) { }
      });

      window.addEventListener('offline', function () {
        try { showToastInfo('‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå: ‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏¥‡∏ß'); } catch (_) { }
        try {
          const liffReady = typeof liff !== 'undefined';
          const loggedIn = liffReady && liff.isLoggedIn ? liff.isLoggedIn() : false;
          updateStatusTray({ liffReady, loggedIn, backendOk: null, gpsOk: null });
        } catch (_) { }
      });
    });

    // Diagnostics helpers
    function updateDiagnosticsSnapshot({ liffReady, loggedIn, userId }) {
      const li = document.getElementById('diagLiff');
      const lo = document.getElementById('diagLogin');
      const ui = document.getElementById('diagUser');
      const bu = document.getElementById('diagBackend');
      if (li) li.textContent = 'LIFF: ' + (liffReady ? 'Ready' : 'Not ready');
      if (lo) lo.textContent = 'Login: ' + (loggedIn ? 'Yes' : 'No');
      if (ui) ui.textContent = 'UserId: ' + (userId || '-');
      if (bu) bu.textContent = 'Backend URL: hidden';

      // Update compact tray (backend/gps unknown here)
      try { updateStatusTray({ liffReady: !!liffReady, loggedIn: !!loggedIn, backendOk: null, gpsOk: null }); } catch (_) { }
    }

    // Compact tray updater
    function updateStatusTray({ liffReady, loggedIn, backendOk, gpsOk }) {
      const tray = document.getElementById('statusTray');
      const elLiff = document.getElementById('stLiff');
      const elLogin = document.getElementById('stLogin');
      const elBackend = document.getElementById('stBackend');
      const elGps = document.getElementById('stGps');
      if (!tray || !elLiff || !elLogin || !elBackend || !elGps) return;

      function setPill(el, ok) {
        el.classList.remove('status-ok', 'status-bad', 'status-unknown');
        if (ok === null || ok === undefined) el.classList.add('status-unknown');
        else if (ok) el.classList.add('status-ok');
        else el.classList.add('status-bad');
      }

      setPill(elLiff, !!liffReady);
      setPill(elLogin, !!loggedIn);
      setPill(elBackend, backendOk == null ? null : !!backendOk);
      setPill(elGps, gpsOk == null ? null : !!gpsOk);

      tray.classList.remove('hidden');
    }

    async function runDiagnostics() {
      const diagBody = document.getElementById('diagBody');
      if (diagBody) diagBody.classList.remove('hidden');

      const hasLiff = typeof liff !== 'undefined';
      const loggedIn = hasLiff && liff.isLoggedIn ? liff.isLoggedIn() : false;
      updateDiagnosticsSnapshot({ liffReady: hasLiff, loggedIn, userId: currentUserId || '' });

      const pingEl = document.getElementById('diagPing');
      const gpsEl = document.getElementById('diagGps');

      // Backend ping
      let backendOk = null;
      try {
        const base = window.CONSTANTS && window.CONSTANTS.API && window.CONSTANTS.API.WEB_APP_URL;
        if (!base) {
          if (pingEl) pingEl.textContent = 'Ping: no WEB_APP_URL';
        } else {
          const url = base.includes('?') ? base + '&action=health' : base + '?action=health';
          const ac = new AbortController();
          const t0 = performance.now();
          const timer = setTimeout(function () { ac.abort(); }, 7000);
          try {
            const res = await fetch(url, { method: 'GET', signal: ac.signal, cache: 'no-store' });
            const t1 = performance.now();
            const ms = Math.round(t1 - t0);
            if (pingEl) pingEl.textContent = 'Ping: ' + res.status + ' in ' + ms + ' ms';
            backendOk = res.ok === true;
          } finally {
            clearTimeout(timer);
          }
        }
      } catch (e) {
        if (pingEl) pingEl.textContent = 'Ping: error(' + (e && e.message ? e.message : 'unknown') + ')';
        backendOk = false;
      }

      // GPS check
      let gpsOk = null;
      try {
        const pos = await getCurrentPositionAsync();
        const acc = pos && pos.coords ? Math.round(pos.coords.accuracy || 0) : null;
        if (gpsEl) gpsEl.textContent = 'GPS: OK' + (acc ? ' (¬±' + acc + 'm)' : '') + ' ';
        gpsOk = true;
      } catch (e) {
        if (gpsEl) gpsEl.textContent = 'GPS: error(' + (e && e.message ? e.message : 'unknown') + ')';
        gpsOk = false;
      }

      try { updateStatusTray({ liffReady: typeof liff !== 'undefined', loggedIn: (liff && liff.isLoggedIn && liff.isLoggedIn()) || false, backendOk, gpsOk }); } catch (_) { }
      try { showToastInfo('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß'); } catch (_) { }
    }

    window.updateStopStatus = updateStopStatus;
    window.search = search;
    window.closeJob = closeJob;
    window.startCheckin = startCheckin;
    window.doAlcoholCheck = doAlcoholCheck;
    window.getCurrentPositionAsync = getCurrentPositionAsync;
    window.startReview = startReview;
    window.navigateToStop = navigateToStop;
    window.openEndTripDialog = openEndTripDialog;
    window.saveEndTripSummary = saveEndTripSummary;
    window.checkMissingSteps = checkMissingSteps;
    window.showMissingStepsForm = showMissingStepsForm;
    window.saveMissingStepsData = saveMissingStepsData;
    window.showAwarenessPopup = showAwarenessPopup;
    window.saveAwarenessAcknowledgment = saveAwarenessAcknowledgment;
    window.uploadPOD = uploadPOD;
    window.triggerSOS = triggerSOS;
    window.sendQuickTemplate = sendQuickTemplate;
    window.generateDailySummary = generateDailySummary;
    window.checkSmartAlerts = checkSmartAlerts;
  </script>
</body>

</html>