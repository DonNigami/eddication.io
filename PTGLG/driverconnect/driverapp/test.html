<!DOCTYPE html>
<html lang="th">

<head>
  <base target="_top" />
  <meta charset="UTF-8" />
  <title>Driver Tracking</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- App Config -->
  <script src="config.js"></script>
  <!-- Core Modules (load in order) -->
  <script src="logger.js"></script>
  <script src="constants.js"></script>
  <script src="validators.js"></script>
  <script src="api.js"></script>

  <style>
    :root {
      --primary: #1abc9c;
      --primary-dark: #16a085;
      --bg: #f4f8f7;
      --text-main: #222;
      --text-sub: #666;
      --card-bg: #ffffff;
      --border-radius: 14px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI',
        sans-serif;
      background: var(--bg);
      color: var(--text-main);
    }

    .app-shell {
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 12px;
    }

    .container {
      width: 100%;
      max-width: 520px;
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 16px 18px 20px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.06);
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .title {
      font-size: 1.2rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .badge {
      font-size: 0.75rem;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(26, 188, 156, 0.1);
      color: var(--primary-dark);
    }

    .status-text {
      font-size: 0.9rem;
      color: var(--text-sub);
      margin-bottom: 10px;
    }

    .field-group {
      margin-bottom: 10px;
    }

    label {
      display: block;
      font-size: 0.8rem;
      color: var(--text-sub);
      margin-bottom: 4px;
    }

    input[type='text'] {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #dce2e0;
      font-size: 0.95rem;
      outline: none;
      transition: border 0.2s, box-shadow 0.2s, background 0.2s;
      background: #f7faf9;
    }

    input[type='text']:focus {
      border-color: var(--primary);
      background: #ffffff;
      box-shadow: 0 0 0 2px rgba(26, 188, 156, 0.18);
    }

    button {
      width: 100%;
      padding: 11px 12px;
      border-radius: 999px;
      border: none;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: #ffffff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: transform 0.12s ease-out, box-shadow 0.12s ease-out,
        opacity 0.15s;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 18px rgba(22, 160, 133, 0.28);
    }

    button:active {
      transform: translateY(0);
      box-shadow: none;
      opacity: 0.9;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    .btn-small {
      width: auto;
      padding: 10px 16px;
      font-size: 0.95rem;
      border-radius: 999px;
      margin: 4px 6px 0 0;
    }

    .btn-outline {
      background: #ffffff;
      color: var(--primary-dark);
      border: 1px solid rgba(26, 188, 156, 0.35);
      box-shadow: none;
    }

    .btn-outline:hover {
      background: rgba(26, 188, 156, 0.06);
    }

    .btn-warning {
      background: #f39c12;
      background: linear-gradient(135deg, #f39c12, #d35400);
    }

    .btn-secondary {
      background: #95a5a6;
      background: linear-gradient(135deg, #95a5a6, #7f8c8d);
    }

    .summary-card {
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 10px;
      background: #f7faf9;
      border: 1px solid #e3ebe8;
      font-size: 0.88rem;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    .summary-label {
      color: var(--text-sub);
    }

    .summary-value {
      font-weight: 600;
    }

    .timeline-container {
      margin-top: 14px;
    }

    .timeline-title {
      font-weight: 600;
      font-size: 0.95rem;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .timeline {
      position: relative;
      margin: 0;
      padding: 4px 0 0 20px;
      list-style: none;
    }

    .timeline::before {
      content: '';
      position: absolute;
      left: 9px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: linear-gradient(to bottom,
          rgba(26, 188, 156, 0.6),
          rgba(26, 188, 156, 0.1));
    }

    .timeline-item {
      position: relative;
      margin-bottom: 14px;
    }

    .timeline-marker {
      position: absolute;
      left: -1px;
      top: 6px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #ffffff;
      border: 2px solid var(--primary);
      box-shadow: 0 0 0 2px rgba(26, 188, 156, 0.15);
    }

    .timeline-content {
      margin-left: 14px;
      background: #ffffff;
      border-radius: 12px;
      padding: 8px 10px;
      border: 1px solid #e4ece9;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.04);
    }

    .timeline-header-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 4px;
    }

    .timeline-stop-label {
      font-size: 0.9rem;
      font-weight: 800;
      color: var(--primary-dark);
    }

    .timeline-status {
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(22, 160, 133, 0.06);
      color: var(--primary-dark);
    }

    .timeline-sub {
      font-size: 0.82rem;
      color: var(--text-sub);
      margin-bottom: 2px;
    }

    .materials-text {
      font-size: 0.8rem;
      color: #444;
      margin-top: 4px;
    }

    .action-row {
      margin-top: 6px;
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      align-items: stretch;
    }

    .action-row button {
      flex: 1;
    }

    .btn-nav {
      flex: 0 0 25%;
      background: #0d6efd;
      color: #fff;
      border-radius: 8px;
      padding: 8px 6px;
      text-align: center;
      font-size: 0.8rem;
      border: none;
      width: auto;
    }

    .btn-nav:hover {
      opacity: 0.9;
    }

    .footer-note {
      margin-top: 8px;
      font-size: 0.78rem;
      color: var(--text-sub);
      text-align: center;
    }

    .history-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .history-item {
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #dce2e0;
      background: #ffffff;
      font-size: 0.9rem;
      cursor: pointer;
      transition: border 0.15s, color 0.15s, background 0.15s;
    }

    .history-item:hover {
      border-color: var(--primary);
      color: var(--primary-dark);
      background: #f0fbf7;
    }

    .hidden {
      display: none;
    }

    .inline-flex {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%) translateY(-20px);
      width: calc(100% - 24px);
      max-width: 520px;
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.18);
      border-left: 4px solid var(--primary);
      padding: 10px 12px 11px;
      z-index: 9999;
      opacity: 0;
      pointer-events: none;
    }

    .inline-flex-bar {
      width: 42px;
      height: 4px;
      border-radius: 99px;
      background: rgba(26, 188, 156, 0.2);
      margin: 0 auto 6px;
    }

    .inline-flex-title {
      font-size: 0.95rem;
      font-weight: 700;
      color: var(--primary-dark);
      margin-bottom: 2px;
      text-align: left;
    }

    .inline-flex-text {
      font-size: 0.8rem;
      color: var(--text-sub);
      margin-bottom: 2px;
    }

    .inline-flex-sub {
      font-size: 0.76rem;
      color: #555;
    }

    .inline-flex.show {
      animation: dropIn 0.35s ease-out forwards;
    }

    .inline-flex.hide {
      animation: fadeOutUp 0.25s ease-in forwards;
    }

    @keyframes dropIn {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(-20px);
      }

      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }

    @keyframes fadeOutUp {
      from {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }

      to {
        opacity: 0;
        transform: translateX(-50%) translateY(-15px);
      }
    }

    @media (max-width: 480px) {
      .card {
        padding: 14px 14px 18px;
      }

      .title {
        font-size: 1.05rem;
      }

      button {
        font-size: 0.9rem;
      }
    }
  </style>
</head>

<body>
  <!-- Inline Flex Notification -->
  <div id="inlineFlex" class="inline-flex hidden">
    <div class="inline-flex-bar"></div>
    <div class="inline-flex-title" id="inlineFlexTitle"></div>
    <div class="inline-flex-text" id="inlineFlexMain"></div>
    <div class="inline-flex-sub" id="inlineFlexSub"></div>
  </div>

  <div class="app-shell">
    <div class="container">
      <div class="card">
        <div class="header">
          <div class="title">
            üöö Driver Tracking
            <span class="badge">Online</span>
          </div>
        </div>

        <div id="status" class="status-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å LINE...</div>

        <!-- Diagnostics Panel -->
        <div id="diagCard" class="summary-card" style="margin-bottom:10px;">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
            <div style="font-weight:600;">Diagnostics</div>
            <div style="display:flex;gap:6px;">
              <button id="btnRunDiag" type="button" class="btn-small btn-outline">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö</button>
              <button id="btnToggleDiag" type="button" class="btn-small btn-outline">‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô</button>
            </div>
          </div>
          <div id="diagBody" class="hidden" style="margin-top:6px;font-size:0.85rem;">
            <div id="diagLiff">LIFF: -</div>
            <div id="diagLogin">Login: -</div>
            <div id="diagUser">UserId: -</div>
            <div id="diagBackend">Backend URL: -</div>
            <div id="diagPing">Ping: -</div>
            <div id="diagGps">GPS: -</div>
          </div>
        </div>

        <div class="field-group">
          <label for="keyword">‡πÄ‡∏•‡∏Ç‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏á‡∏≤‡∏ô (Reference No.)</label>
          <input id="keyword" type="text" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç Reference ‡πÄ‡∏ä‡πà‡∏ô 2511S15403" />
        </div>

        <button id="btnSearch" type="button">
          <span>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ / ‡∏î‡∏∂‡∏á‡∏á‡∏≤‡∏ô</span>
        </button>

        <div id="historyContainer" class="summary-card hidden" style="margin-top:10px;">
          <div style="font-weight:600;margin-bottom:6px;">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</div>
          <div id="historyList" class="history-list"></div>
        </div>

        <div id="summary" class="summary-card hidden"></div>

        <div id="alcoholContainer" class="summary-card hidden" style="margin-top:10px;"></div>

        <div id="timelineContainer" class="timeline-container hidden">
          <div class="timeline-title">
            ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
            <span style="font-size:0.8rem;color:var(--text-sub);">
              (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á)
            </span>
          </div>
          <ul id="timeline" class="timeline"></ul>

          <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô + ‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ -->
          <div id="closeJobContainer" class="hidden" style="margin-top:8px;">
            <button id="btnCloseJob" type="button" class="btn-secondary" style="width:100%;margin-bottom:6px;">
              ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô (‡∏£‡∏ñ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô)
            </button>
            <button id="btnEndTrip" type="button" class="btn-secondary" style="width:100%;display:none;">
              ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ (‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå + ‡∏à‡∏∏‡∏î‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ)
            </button>
          </div>
        </div>

        <div class="footer-note">
          ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Check-in / Check-out ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ö‡∏ô‡∏à‡∏≠
          ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á Flex ‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ä‡∏ó LINE
        </div>
      </div>
    </div>
  </div>

  <script>
    // ============================================================================
    // Driver Tracking App - Main Module
    // Uses modular architecture: Logger ‚Üí Constants ‚Üí Validators ‚Üí API ‚Üí App
    // ============================================================================

    const { MESSAGES, ACTIONS, STORAGE_KEYS } = window.CONSTANTS;
    const LIFF_ID = window.CONSTANTS.API.LIFF_ID;
    const LAST_SEARCH_MAP_KEY = 'driver_last_search_map_v1';
    const LAST_SEARCH_HISTORY_KEY = 'driver_last_search_history_map_v1';

    let currentUserId = '';
    let currentReference = '';
    let lastStops = [];
    let inlineFlexTimer = null;
    let isUpdatingStop = false;
    let searchAbortController = null;
    let searchRequestId = 0;

    /**
     * Escape HTML entities to prevent XSS
     * @param {*} val
     * @returns {string}
     */
    function safe(val) {
      const s = String(val == null ? '' : val);
      return s
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    /**
     * Debounce utility for input handlers
     * @param {Function} fn
     * @param {number} delay
     * @returns {Function}
     */
    function debounce(fn, delay) {
      let timeoutId;
      return function (...args) {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => fn.apply(this, args), delay);
      };
    }

    function getLastSearch(userId) {
      if (!userId) return '';
      try {
        const raw = localStorage.getItem(LAST_SEARCH_MAP_KEY);
        if (!raw) return '';
        const map = JSON.parse(raw);
        if (map && typeof map === 'object') {
          return map[userId] || '';
        }
      } catch (e) {
        console.warn('last search map parse error', e);
      }
      return '';
    }

    function setLastSearch(userId, value) {
      if (!userId) return;
      try {
        const raw = localStorage.getItem(LAST_SEARCH_MAP_KEY);
        const map = raw ? JSON.parse(raw) : {};
        map[userId] = value;
        localStorage.setItem(LAST_SEARCH_MAP_KEY, JSON.stringify(map));
      } catch (e) {
        console.warn('last search map write error', e);
      }
    }

    function getSearchHistory(userId) {
      if (!userId) return [];
      try {
        const raw = localStorage.getItem(LAST_SEARCH_HISTORY_KEY);
        if (!raw) return [];
        const map = JSON.parse(raw);
        const list = map && typeof map === 'object' ? map[userId] : [];
        return Array.isArray(list) ? list : [];
      } catch (e) {
        console.warn('history parse error', e);
        return [];
      }
    }

    function setSearchHistory(userId, keyword) {
      if (!userId) return;
      const kw = (keyword || '').trim();
      if (!kw) return;
      try {
        const raw = localStorage.getItem(LAST_SEARCH_HISTORY_KEY);
        const map = raw ? JSON.parse(raw) : {};
        let list = Array.isArray(map[userId]) ? map[userId] : [];
        list = list.filter((k) => k !== kw);
        list.unshift(kw);
        if (list.length > 8) list = list.slice(0, 8);
        map[userId] = list;
        localStorage.setItem(LAST_SEARCH_HISTORY_KEY, JSON.stringify(map));
      } catch (e) {
        console.warn('history write error', e);
      }
    }

    function migrateLegacyLastSearch(userId) {
      if (!userId) return;
      try {
        const legacy = localStorage.getItem(STORAGE_KEYS.LAST_SEARCH);
        if (legacy) {
          setLastSearch(userId, legacy);
          setSearchHistory(userId, legacy);
          localStorage.removeItem(STORAGE_KEYS.LAST_SEARCH);
        }
      } catch (e) {
        console.warn('legacy last search migration failed', e);
      }
    }

    function renderSearchHistory() {
      const container = document.getElementById('historyContainer');
      const listEl = document.getElementById('historyList');
      if (!container || !listEl) return;

      const items = getSearchHistory(currentUserId);
      listEl.innerHTML = '';

      if (!currentUserId || !items.length) {
        container.classList.add('hidden');
        return;
      }

      items.forEach((kw) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'history-item';
        btn.textContent = kw;
        btn.addEventListener('click', () => {
          const kwEl = document.getElementById('keyword');
          if (kwEl) {
            kwEl.value = kw;
            search();
          }
        });
        listEl.appendChild(btn);
      });

      container.classList.remove('hidden');
    }

    let currentDrivers = [];
    let currentCheckedDrivers = [];
    let alcoholAllDone = false;
    let jobClosed = false;
    let tripEnded = false;

    // ============================================================================
    // UI Alert Functions
    // ============================================================================

    /**
     * Show loading modal
     * @param {string} message
     */
    function showLoading(message) {
      Swal.fire({
        title: message || '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...',
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        },
      });
    }

    function closeLoading() {
      Swal.close();
    }

    /**
     * Show error notification
     * @param {string} message
     */
    function showError(message) {
      Swal.fire({
        icon: 'error',
        title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
        text: message || '‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
        confirmButtonColor: '#1abc9c',
      });
    }

    function showSuccess(title, text) {
      return Swal.fire({
        icon: 'success',
        title: title || '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
        text: text || '',
        confirmButtonColor: '#1abc9c',
      });
    }

    /**
     * Show info notification
     * @param {string} title
     * @param {string} text
     */
    function showInfo(title, text) {
      Swal.fire({
        icon: 'info',
        title: title || '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô',
        text: text || '',
        confirmButtonColor: '#1abc9c',
      });
    }

    function showInlineFlex(type, stop) {
      const container = document.getElementById('inlineFlex');
      const titleEl = document.getElementById('inlineFlexTitle');
      const mainEl = document.getElementById('inlineFlexMain');
      const subEl = document.getElementById('inlineFlexSub');

      const labelMap = {
        checkin: 'Check-in ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
        fuel: '‡∏•‡∏á‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
        unload: '‡∏•‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
        review: '‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
        checkout: 'Check-out ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
        closejob: '‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
        endtrip: '‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á
      };

      const title = labelMap[type] || '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';

      let timeText = '';
      if (type === 'checkin') timeText = stop.checkInTime || '';
      else if (type === 'fuel') timeText = stop.fuelingTime || '';
      else if (type === 'unload') timeText = stop.unloadDoneTime || '';
      else if (type === 'review') timeText = stop.reviewedTime || '';
      else if (type === 'checkout') timeText = stop.checkOutTime || '';

      const odoText =
        type === 'checkin' && stop.checkInOdo
          ? ` ‚Ä¢ ‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå: ${stop.checkInOdo}`
          : '';

      titleEl.textContent = title;
      mainEl.textContent = `Reference: ${stop.referenceNo || '-'} | Shipment: ${stop.shipmentNo || '-'
        }`;
      const acc = stop.gpsAccuracy != null ? ` ‚Ä¢ ¬±${Math.round(stop.gpsAccuracy)}m` : '';
      subEl.textContent = `${stop.destination2 || stop.destination1 || '‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á'
        }${timeText ? ' ‚Ä¢ ‡πÄ‡∏ß‡∏•‡∏≤: ' + timeText : ''}${odoText}${acc}`;

      container.classList.remove('hide', 'hidden');
      void container.offsetWidth;
      container.classList.add('show');

      if (inlineFlexTimer) {
        clearTimeout(inlineFlexTimer);
      }
      inlineFlexTimer = setTimeout(() => {
        container.classList.remove('show');
        container.classList.add('hide');
        setTimeout(() => {
          container.classList.add('hidden');
        }, 250);
      }, 4000);
    }

    function sendFlexCheckInOut(type, stop) {
      console.log('üîî sendFlexCheckInOut called:', { type, stop });

      try {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ LIFF ‡∏ñ‡∏π‡∏Å initialize ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (!liff || !liff.isLoggedIn()) {
          console.warn('‚ö†Ô∏è LIFF ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ login ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
          return;
        }

        if (type !== 'checkin' && type !== 'checkout') {
          console.warn('‚ö†Ô∏è Type ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà checkin ‡∏´‡∏£‡∏∑‡∏≠ checkout:', type);
          return;
        }

        console.log('‚úÖ ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏™‡πà‡∏á Flex Message:', type);

        const labelMap = {
          checkin: 'Check-in ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
          checkout: 'Check-out ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
        };

        const title = labelMap[type] || '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
        const colorBar = type === 'checkout' ? '#16a085' : '#1abc9c';

        let timeText = '';
        if (type === 'checkin') timeText = stop.checkInTime || '';
        else if (type === 'checkout') timeText = stop.checkOutTime || '';

        const bubble = {
          type: 'bubble',
          size: 'mega',
          body: {
            type: 'box',
            layout: 'vertical',
            paddingAll: '16px',
            contents: [
              {
                type: 'box',
                layout: 'baseline',
                contents: [
                  { type: 'filler' },
                  {
                    type: 'box',
                    layout: 'vertical',
                    contents: [],
                    width: '8px',
                    backgroundColor: colorBar,
                    cornerRadius: '999px',
                    height: '40px',
                  },
                ],
              },
              {
                type: 'text',
                text: title,
                weight: 'bold',
                size: 'lg',
                color: '#16a085',
                margin: 'md',
              },
              {
                type: 'text',
                text: 'Reference: ' + (stop.referenceNo || '-'),
                size: 'sm',
                color: '#555555',
                wrap: true,
                margin: 'sm',
              },
              {
                type: 'text',
                text: 'Shipment: ' + (stop.shipmentNo || '-'),
                size: 'sm',
                color: '#555555',
                wrap: true,
                margin: 'xs',
              },
              {
                type: 'separator',
                margin: 'md',
              },
              {
                type: 'box',
                layout: 'vertical',
                margin: 'md',
                spacing: 'sm',
                contents: [
                  {
                    type: 'text',
                    text:
                      stop.destination2 ||
                      stop.destination1 ||
                      '‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á',
                    size: 'md',
                    weight: 'bold',
                    wrap: true,
                  },
                  {
                    type: 'text',
                    text: timeText ? '‡πÄ‡∏ß‡∏•‡∏≤: ' + timeText : '',
                    size: 'sm',
                    color: '#555555',
                    wrap: true,
                  },
                  {
                    type: 'text',
                    text: '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ' + (stop.status || '-'),
                    size: 'sm',
                    color: '#555555',
                    wrap: true,
                    margin: 'xs',
                  },
                ],
              },
            ],
          },
          styles: {
            body: {
              backgroundColor: '#ffffff',
            },
          },
        };

        console.log('üì§ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á Flex Message...', bubble);

        liff
          .sendMessages([
            {
              type: 'flex',
              altText: title,
              contents: bubble,
            },
          ])
          .then(function () {
            console.log('‚úÖ ‡∏™‡πà‡∏á Flex Message ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
          })
          .catch(async function (err) {
            console.warn('‚ö†Ô∏è sendMessages ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡∏•‡∏≠‡∏á shareTargetPicker ‡∏ï‡πà‡∏≠', err);
            try {
              if (liff.shareTargetPicker) {
                await liff.shareTargetPicker([
                  {
                    type: 'flex',
                    altText: title,
                    contents: bubble,
                  },
                ]);
                console.log('‚úÖ ‡∏™‡πà‡∏á‡∏î‡πâ‡∏ß‡∏¢ shareTargetPicker ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
              }
            } catch (e2) {
              console.error('‚ùå ‡∏™‡πà‡∏á Flex ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', e2);
            }
          });
      } catch (err) {
        console.error('‚ùå sendFlexCheckInOut fatal error:', err);
        console.error('Error details:', err.message, err.stack);
      }
    }

    async function initLiff() {
      try {
        // Guard: ensure LIFF SDK and configuration are available
        if (typeof liff === 'undefined') {
          showError('LIFF SDK ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏≠‡∏û LINE');
          return;
        }
        if (!LIFF_ID) {
          showError('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ LIFF_ID ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö');
          return;
        }
        if (!window.CONSTANTS || !window.CONSTANTS.API || !window.CONSTANTS.API.WEB_APP_URL) {
          showError('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ WEB_APP_URL ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö backend');
          return;
        }
        await liff.init({ liffId: LIFF_ID });
        if (liff.ready) { await liff.ready; }

        if (!liff.isLoggedIn()) {
          if (typeof liff.isInClient === 'function' && !liff.isInClient()) {
            showInfo('‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô LINE', MESSAGES.INFO_OPEN_IN_LINE);
          }
          liff.login();
          return;
        }

        const profile = await liff.getProfile();
        currentUserId = profile.userId;
        const statusEl = document.getElementById('status');
        statusEl.textContent = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏∏‡∏ì ${profile.displayName} üëã`;

        // Move legacy single-value storage into per-user map (one-time)
        migrateLegacyLastSearch(currentUserId);

        renderSearchHistory();

        // Enable search button after LIFF is ready and user is logged in
        const btnSearchEl = document.getElementById('btnSearch');
        if (btnSearchEl) btnSearchEl.disabled = false;

        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡πà‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á user ‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        const lastKeyword = getLastSearch(currentUserId);
        if (lastKeyword) {
          const kwEl = document.getElementById('keyword');
          kwEl.value = lastKeyword;
          try {
            await search();
          } catch (e) {
            console.warn('auto search on init failed', e);
          }
        }

        // ‡πÅ‡∏™‡∏î‡∏á popup ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
        showInfo('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç', MESSAGES.INFO_IMPORTANT);

        window.Logger.info('‚úÖ LIFF initialized', { userId: currentUserId });
        // Update diagnostics snapshot after init
        try { updateDiagnosticsSnapshot({ liffReady: true, loggedIn: true, userId: currentUserId }); } catch (_) { }
      } catch (err) {
        window.Logger.error('‚ùå LIFF init failed', err);
        const statusEl = document.getElementById('status');
        const msg = err && err.message ? err.message : '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏';
        if (statusEl) {
          statusEl.innerText = `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î LIFF: ${msg}`;
        }
        showError(`${MESSAGES.ERROR_LIFF_INIT}\n‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ${msg}`);
      }
    }

    /**
     * Search for a job by reference
     */
    async function search() {
      const reqId = ++searchRequestId;
      const keywordInput = document.getElementById('keyword');
      const keyword = keywordInput.value.trim();
      const btn = document.getElementById('btnSearch');

      if (!keyword) {
        showInfo('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç Reference', MESSAGES.INFO_SEARCH_EMPTY);
        return;
      }

      // Guard: ensure LINE login and profile loaded
      if (!currentUserId) {
        showInfo('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å LINE');
        return;
      }

      // Persist latest keyword per-user immediately (so it survives even if API fails)
      setLastSearch(currentUserId, keyword);
      setSearchHistory(currentUserId, keyword);
      renderSearchHistory();

      btn.disabled = true;
      showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö...');

      try {
        const result = await window.API.search(keyword, currentUserId);

        closeLoading();

        // Ignore outdated responses
        if (reqId !== searchRequestId) {
          window.Logger.warn('Search response ignored (outdated)', { reqId, latest: searchRequestId });
          return;
        }

        if (!result.success) {
          clearResult();
          showError(result.message);
          return;
        }

        const d = result.data;
        const stops = d.stops || [];

        lastStops = stops;
        currentReference = d.referenceNo || keyword;

        currentDrivers =
          (d.alcohol && Array.isArray(d.alcohol.drivers) && d.alcohol.drivers) ||
          [];
        currentCheckedDrivers =
          (d.alcohol &&
            Array.isArray(d.alcohol.checkedDrivers) &&
            d.alcohol.checkedDrivers) ||
          [];
        currentCheckedDrivers = [...new Set(currentCheckedDrivers)];
        alcoholAllDone =
          currentDrivers.length > 0 &&
          currentDrivers.every((n) => currentCheckedDrivers.includes(n));

        jobClosed = !!d.jobClosed;
        tripEnded = !!d.tripEnded;

        renderSummary(d);
        renderAlcoholSection();
        renderTimeline(stops);

        window.Logger.info('‚úÖ Search completed', { stops: stops.length, drivers: currentDrivers.length });
      } catch (err) {
        window.Logger.error('‚ùå Search error', err);
        closeLoading();
        showError(MESSAGES.ERROR_NETWORK);
      } finally {
        btn.disabled = false;
      }
    }

    // stray block removed: duplicated logic after search()

    function clearResult() {
      document.getElementById('summary').classList.add('hidden');
      document.getElementById('timelineContainer').classList.add('hidden');
      document.getElementById('summary').innerHTML = '';
      document.getElementById('timeline').innerHTML = '';
      document.getElementById('closeJobContainer').classList.add('hidden');
      document.getElementById('alcoholContainer').classList.add('hidden');
      document.getElementById('alcoholContainer').innerHTML = '';
      lastStops = [];
      currentDrivers = [];
      currentCheckedDrivers = [];
      alcoholAllDone = false;
      jobClosed = false;
      tripEnded = false; // ‚úÖ reset state ‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ
    }

    function renderSummary(d) {
      const summaryEl = document.getElementById('summary');
      const stops = d.stops || [];
      const shipmentNos = d.shipmentNos || [];

      let shipmentSummary = '-';
      if (shipmentNos.length === 1) {
        shipmentSummary = shipmentNos[0];
      } else if (shipmentNos.length > 1) {
        shipmentSummary = shipmentNos.join(', ');
      }

      const totalQtyAll = stops.reduce(function (acc, s) {
        if (typeof s.totalQty === 'number') return acc + s.totalQty;
        return acc;
      }, 0);

      summaryEl.innerHTML = `
          <div class="summary-row">
            <span class="summary-label">Reference</span>
            <span class="summary-value">${safe(d.referenceNo || '-')}</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏ñ</span>
            <span class="summary-value">${safe(d.vehicleDesc || '-')}</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Shipment</span>
            <span class="summary-value">${safe(shipmentSummary)}</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á</span>
            <span class="summary-value">${safe(d.totalStops || stops.length)} ‡∏à‡∏∏‡∏î</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏£‡∏ß‡∏°‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</span>
            <span class="summary-value">${safe(totalQtyAll || 0)}</span>
          </div>
        `;

      summaryEl.classList.remove('hidden');
    }

    function renderAlcoholSection() {
      const container = document.getElementById('alcoholContainer');
      if (!container) return;

      if (!currentDrivers || currentDrivers.length === 0) {
        container.classList.add('hidden');
        container.innerHTML = '';
        return;
      }

      let html = `
          <div style="font-weight:600;margin-bottom:4px;">‡πÄ‡∏õ‡πà‡∏≤‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô</div>
          <div style="font-size:0.8rem;color:var(--text-sub);margin-bottom:6px;">
            ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç) ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÉ‡∏´‡πâ
          </div>
        `;

      currentDrivers.forEach((name) => {
        const checked = currentCheckedDrivers.includes(name);
        if (checked) {
          html += `
              <div style="margin-bottom:4px;display:flex;justify-content:space-between;align-items:center;">
                <span>${safe(name)}</span>
                <button class="btn-small btn-secondary" disabled>‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>
              </div>
            `;
        } else {
          const safeName = name.replace(/'/g, "\\'");
          html += `
              <div style="margin-bottom:4px;display:flex;justify-content:space-between;align-items:center;">
                <span>${safe(name)}</span>
                <button class="btn-small btn-outline" type="button" onclick="doAlcoholCheck('${safeName}')">
                  ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå
                </button>
              </div>
            `;
        }
      });

      alcoholAllDone =
        currentDrivers.length > 0 &&
        currentDrivers.every((n) => currentCheckedDrivers.includes(n));

      if (alcoholAllDone) {
        html += `
            <div style="margin-top:4px;font-size:0.78rem;color:var(--primary-dark);">
              ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ
            </div>
          `;
      } else {
        html += `
            <div style="margin-top:4px;font-size:0.78rem;color:#c0392b;">
              ‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô
            </div>
          `;
      }

      container.innerHTML = html;
      container.classList.remove('hidden');
    }

    // Compress image and return Base64 (re-encode strips EXIF)
    function fileToBase64(file) {
      return compressImageFile(file, { maxW: 1280, maxH: 1280, targetKB: 700, mime: 'image/jpeg' });
    }

    function loadImageFromFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const img = new Image();
          img.onload = () => resolve(img);
          img.onerror = reject;
          img.src = reader.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    async function compressImageFile(file, opts) {
      const { maxW = 1280, maxH = 1280, targetKB = 700, mime = 'image/jpeg' } = opts || {};
      const img = await loadImageFromFile(file);
      const origW = img.width || 1;
      const origH = img.height || 1;
      const ratio = Math.min(1, maxW / origW, maxH / origH);
      const canvas = document.createElement('canvas');
      canvas.width = Math.max(1, Math.floor(origW * ratio));
      canvas.height = Math.max(1, Math.floor(origH * ratio));
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

      let quality = 0.85;
      let dataUrl = canvas.toDataURL(mime, quality);
      let base64 = dataUrl.split(',')[1] || '';
      let sizeKB = Math.ceil((base64.length * 3) / 4 / 1024);

      while (sizeKB > targetKB && quality > 0.55) {
        quality -= 0.1;
        dataUrl = canvas.toDataURL(mime, quality);
        base64 = dataUrl.split(',')[1] || '';
        sizeKB = Math.ceil((base64.length * 3) / 4 / 1024);
      }
      return base64;
    }

    /**
     * Performs alcohol check for a driver
     * @param {string} driverName - The driver's name
     */
    async function doAlcoholCheck(driverName) {
      if (!currentReference) {
        showInfo(CONSTANTS.MESSAGES.INFO_NOT_FOUND, CONSTANTS.MESSAGES.INFO_SEARCH_FIRST);
        return;
      }

      const { value: formValues } = await Swal.fire({
        title: CONSTANTS.MESSAGES.ALCOHOL_TITLE,
        html: `
            <div style="text-align:left;">
              <label style="font-size:0.8rem;color:#555;">${CONSTANTS.MESSAGES.LABEL_DRIVER_NAME}</label>
              <div style="font-size:0.9rem;font-weight:600;margin-bottom:6px;">${safe(driverName)}</div>

              <label style="font-size:0.8rem;color:#555;">${CONSTANTS.MESSAGES.LABEL_ALCOHOL_VALUE}</label>
              <input id="swalAlcoholValue" type="number" min="0" step="0.01"
                class="swal2-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô 0.00"
                style="width:100%;margin:4px 0 10px;">

              <label style="font-size:0.8rem;color:#555;">${CONSTANTS.MESSAGES.LABEL_EVIDENCE_PHOTO}</label>
              <input id="swalAlcoholImage" type="file" accept="image/*" capture="environment"
                style="margin-top:4px;font-size:0.8rem;">
            </div>
          `,
        focusConfirm: false,
        showCancelButton: true,
        confirmButtonText: CONSTANTS.MESSAGES.BUTTON_SAVE,
        cancelButtonText: CONSTANTS.MESSAGES.BUTTON_CANCEL,
        confirmButtonColor: '#1abc9c',
        preConfirm: () => {
          const val = document.getElementById('swalAlcoholValue').value.trim();
          const file = document.getElementById('swalAlcoholImage').files[0];

          // Validate alcohol value
          const alcoholValidation = window.Validators.validateAlcohol(val);
          if (!alcoholValidation.valid) {
            Swal.showValidationMessage(alcoholValidation.error);
            return false;
          }

          // Validate image file
          if (!file) {
            Swal.showValidationMessage(CONSTANTS.MESSAGES.ERROR_IMAGE_REQUIRED);
            return false;
          }

          const imageValidation = window.Validators.validateImage(file);
          if (!imageValidation.valid) {
            Swal.showValidationMessage(imageValidation.error);
            return false;
          }

          return { alcoholValue: String(alcoholValidation.value.toFixed(2)), file: file };
        },
      });

      if (!formValues) {
        return;
      }

      const { alcoholValue, file } = formValues;

      try {
        showLoading(CONSTANTS.MESSAGES.LOADING_GET_COORDINATES);

        let pos;
        try {
          pos = await getCurrentPositionAsync();
        } catch (err) {
          window.Logger.warn('GPS error', err);
          closeLoading();
          showError(CONSTANTS.MESSAGES.ERROR_GPS);
          return;
        }

        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        const acc = pos.coords.accuracy != null ? pos.coords.accuracy : undefined;

        const base64 = await fileToBase64(file);

        showLoading(CONSTANTS.MESSAGES.LOADING_UPLOAD_ALCOHOL);

        const result = await window.API.uploadAlcohol({
          reference: currentReference,
          driverName: driverName,
          userId: currentUserId,
          alcoholValue: parseFloat(alcoholValue),
          lat: lat,
          lng: lng,
          imageBase64: base64,
          accuracy: acc
        });

        closeLoading();

        if (!result.success) {
          showError(result.message);
          return;
        }

        // Update checked drivers list from API response
        if (result.data && result.data.checkedDrivers && Array.isArray(result.data.checkedDrivers)) {
          currentCheckedDrivers = [...new Set(result.data.checkedDrivers)];
        } else {
          currentCheckedDrivers = [...new Set(currentCheckedDrivers.concat([driverName]))];
        }

        renderAlcoholSection();
        showSuccess(CONSTANTS.MESSAGES.SUCCESS_TITLE, CONSTANTS.MESSAGES.SUCCESS_ALCOHOL_SAVED);
        window.Logger.info('‚úÖ Alcohol check completed', { driverName, alcoholValue });
      } catch (err) {
        window.Logger.error('‚ùå Alcohol check error', err);
        closeLoading();
        showError(CONSTANTS.MESSAGES.ERROR_ALCOHOL_SAVE);
      }
    }

    function initSwalSignaturePad(canvasId, clearBtnId) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;

      const ctx = canvas.getContext('2d');
      let drawing = false;

      const getPos = (e) => {
        const rect = canvas.getBoundingClientRect();
        if (e.touches && e.touches.length > 0) {
          return {
            x: e.touches[0].clientX - rect.left,
            y: e.touches[0].clientY - rect.top,
          };
        }
        return {
          x: e.clientX - rect.left,
          y: e.clientY - rect.top,
        };
      };

      const startDraw = (e) => {
        e.preventDefault();
        drawing = true;
        const pos = getPos(e);
        ctx.beginPath();
        ctx.moveTo(pos.x, pos.y);
      };

      const draw = (e) => {
        if (!drawing) return;
        e.preventDefault();
        const pos = getPos(e);
        ctx.lineTo(pos.x, pos.y);
        ctx.strokeStyle = '#111';
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.stroke();
      };

      const endDraw = (e) => {
        if (!drawing) return;
        e.preventDefault();
        drawing = false;
      };

      canvas.addEventListener('mousedown', startDraw);
      canvas.addEventListener('mousemove', draw);
      window.addEventListener('mouseup', endDraw);

      canvas.addEventListener('touchstart', startDraw, { passive: false });
      canvas.addEventListener('touchmove', draw, { passive: false });
      canvas.addEventListener('touchend', endDraw, { passive: false });

      const clearBtn = document.getElementById(clearBtnId);
      if (clearBtn) {
        clearBtn.addEventListener('click', () => {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
        });
      }
    }

    /**
     * Starts a customer review/satisfaction survey
     * @param {number} rowIndex - Stop row index
     * @param {number} seq - Stop sequence number
     */
    async function startReview(rowIndex, seq) {
      if (!currentReference) {
        showInfo(CONSTANTS.MESSAGES.INFO_NOT_FOUND, CONSTANTS.MESSAGES.INFO_SEARCH_FIRST);
        return;
      }

      const stop = (lastStops || []).find((s) => s.rowIndex === rowIndex);
      const destName =
        (stop && (stop.destination2 || stop.destination1)) || '‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á';

      const { value: formValues } = await Swal.fire({
        title: CONSTANTS.MESSAGES.REVIEW_TITLE,
        html: `
            <div style="text-align:left;">
              <div style="font-size:0.85rem;color:#555;margin-bottom:6px;">
                ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á: <b>${safe(destName)}</b>
              </div>

              <label style="font-size:0.8rem;color:#555;">${CONSTANTS.MESSAGES.LABEL_REVIEW_SCORE}</label>
              <div style="margin:4px 0 10px;font-size:0.85rem;">
                <label style="margin-right:10px;">
                  <input type="radio" name="reviewScore" value="‡∏ô‡πâ‡∏≠‡∏¢"> ‡∏ô‡πâ‡∏≠‡∏¢
                </label>
                <label style="margin-right:10px;">
                  <input type="radio" name="reviewScore" value="‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á"> ‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á
                </label>
                <label>
                  <input type="radio" name="reviewScore" value="‡∏°‡∏≤‡∏Å"> ‡∏°‡∏≤‡∏Å
                </label>
              </div>

              <label style="font-size:0.8rem;color:#555;">‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
              <div style="border:1px solid #ccc;border-radius:8px;padding:6px;margin-top:4px;">
                <canvas id="signCanvas" width="280" height="160" style="width:100%;height:auto;background:#fafafa;border-radius:6px;"></canvas>
                <button type="button" id="btnClearSign"
                  style="margin-top:4px;padding:4px 10px;border-radius:999px;border:1px solid #ccc;font-size:0.75rem;background:#fff;">
                  ‡∏•‡πâ‡∏≤‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô
                </button>
              </div>
            </div>
          `,
        didOpen: () => {
          initSwalSignaturePad('signCanvas', 'btnClearSign');
        },
        focusConfirm: false,
        showCancelButton: true,
        confirmButtonText: CONSTANTS.MESSAGES.BUTTON_SAVE,
        cancelButtonText: CONSTANTS.MESSAGES.BUTTON_CANCEL,
        confirmButtonColor: '#1abc9c',
        preConfirm: () => {
          const radio = document.querySelector(
            'input[name="reviewScore"]:checked'
          );
          if (!radio) {
            Swal.showValidationMessage(CONSTANTS.MESSAGES.VALIDATE_REFERENCE_REQUIRED);
            return false;
          }

          const canvas = document.getElementById('signCanvas');
          let dataUrl = '';
          if (canvas) {
            dataUrl = canvas.toDataURL('image/png');
          }

          return {
            score: radio.value,
            signatureDataUrl: dataUrl,
          };
        },
      });

      if (!formValues) {
        return;
      }

      const { score, signatureDataUrl } = formValues;

      try {
        showLoading(CONSTANTS.MESSAGES.LOADING_GET_COORDINATES);

        let pos;
        try {
          pos = await getCurrentPositionAsync();
        } catch (err) {
          window.Logger.warn('GPS error', err);
          closeLoading();
          showError(CONSTANTS.MESSAGES.ERROR_GPS);
          return;
        }

        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;

        showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô...');

        let signatureBase64 = '';
        if (signatureDataUrl && typeof signatureDataUrl === 'string') {
          const parts = signatureDataUrl.split(',');
          signatureBase64 = parts[1] || '';
        }

        const result = await window.API.uploadReview({
          reference: currentReference,
          rowIndex: rowIndex,
          userId: currentUserId,
          score: score,
          lat: lat,
          lng: lng,
          signatureBase64: signatureBase64,
          accuracy: acc
        });

        closeLoading();

        if (!result.success) {
          showError(result.message);
          return;
        }

        await showSuccess(CONSTANTS.MESSAGES.SUCCESS_TITLE, CONSTANTS.MESSAGES.SUCCESS_REVIEW);

        if (result.data && result.data.stop) {
          showInlineFlex('review', result.data.stop);
        }

        if (currentReference) {
          document.getElementById('keyword').value = currentReference;
          await search();
        }

        window.Logger.info('‚úÖ Review uploaded', { rowIndex, score });
      } catch (err) {
        window.Logger.error('‚ùå Review upload error', err);
        closeLoading();
        showError(CONSTANTS.MESSAGES.ERROR_ALCOHOL_SAVE);
      }
    }

    function renderTimeline(stops) {
      const container = document.getElementById('timelineContainer');
      const ul = document.getElementById('timeline');
      const closeJobContainer = document.getElementById('closeJobContainer');
      const btnCloseJob = document.getElementById('btnCloseJob');
      const btnEndTrip = document.getElementById('btnEndTrip');

      ul.innerHTML = '';

      // reset ‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
      closeJobContainer.classList.add('hidden');
      if (btnCloseJob) {
        btnCloseJob.style.display = 'none';
        btnCloseJob.disabled = true;
      }
      if (btnEndTrip) {
        btnEndTrip.style.display = 'none';
        btnEndTrip.disabled = true;
      }

      if (!stops || stops.length === 0) {
        container.classList.add('hidden');
        return;
      }

      let allCheckout = true;

      stops.forEach(function (stop) {
        const hasCheckIn = !!stop.checkInTime;
        const hasFuel = !!stop.fuelingTime;
        const hasUnloadDone = !!stop.unloadDoneTime;
        const hasReviewed = !!stop.reviewedTime;
        const hasCheckOut = !!stop.checkOutTime;
        const isOrigin = !!stop.isOriginStop;

        if (!hasCheckOut) {
          allCheckout = false;
        }

        const statusLabel = stop.status || '-';

        let btnHtml = '';

        if (isOrigin) {
          if (!hasCheckIn) {
            btnHtml +=
              '<button class="btn-small btn-outline" type="button" ' +
              'onclick="startCheckin(' +
              stop.rowIndex +
              ', ' +
              stop.seq +
              ')">Check-in</button>';
          } else if (!hasCheckOut) {
            btnHtml +=
              '<button class="btn-small" type="button" ' +
              'onclick="updateStopStatus(' +
              stop.rowIndex +
              ", 'CHECKOUT', 'checkout', " +
              stop.seq +
              ')">Check-out</button>';
          }
        } else {
          if (!hasCheckIn) {
            btnHtml +=
              '<button class="btn-small btn-outline" type="button" ' +
              'onclick="startCheckin(' +
              stop.rowIndex +
              ', ' +
              stop.seq +
              ')">Check-in</button>';
          } else if (!hasFuel) {
            btnHtml +=
              '<button class="btn-small btn-warning" type="button" ' +
              'onclick="updateStopStatus(' +
              stop.rowIndex +
              ", 'FUELING', 'fuel', " +
              stop.seq +
              ')">‡∏•‡∏á‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô</button>';
          } else if (!hasUnloadDone) {
            btnHtml +=
              '<button class="btn-small btn-outline" type="button" ' +
              'onclick="updateStopStatus(' +
              stop.rowIndex +
              ", 'UNLOAD_DONE', 'unload', " +
              stop.seq +
              ')">‡∏•‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à</button>';
          } else if (!hasReviewed) {
            btnHtml +=
              '<button class="btn-small btn-outline" type="button" ' +
              'onclick="startReview(' +
              stop.rowIndex +
              ', ' +
              stop.seq +
              ')">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</button>';
          } else if (!hasCheckOut) {
            btnHtml +=
              '<button class="btn-small" type="button" ' +
              'onclick="updateStopStatus(' +
              stop.rowIndex +
              ", 'CHECKOUT', 'checkout', " +
              stop.seq +
              ')">Check-out</button>';
          }
        }

        let materialsBlock = '';
        if (stop.materials && stop.materials.length > 0) {
          const parts = stop.materials.map(function (m) {
            const name = m.materialDesc || m.material || '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
            const qty = m.totalQty || 0;
            return '- ' + safe(name) + ' ' + safe(qty);
          });
          materialsBlock =
            '<div class="materials-text"><b>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</b><br>' +
            parts.join('<br>') +
            '</div>';
        }

        const distanceText =
          stop.distanceKm !== undefined &&
            stop.distanceKm !== null &&
            stop.distanceKm !== ''
            ? stop.distanceKm
            : '-';

        const odoText =
          stop.checkInOdo !== undefined &&
            stop.checkInOdo !== null &&
            stop.checkInOdo !== ''
            ? stop.checkInOdo
            : '-';

        let navBtnHtml = '';
        if (
          stop.destLat !== undefined &&
          stop.destLat !== '' &&
          stop.destLng !== undefined &&
          stop.destLng !== ''
        ) {
          navBtnHtml =
            '<button class="btn-nav" type="button" aria-label="‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á" onclick="navigateToStop(' +
            stop.rowIndex +
            ')">‡∏ô‡∏≥‡∏ó‡∏≤‡∏á</button>';
        }

        const li = document.createElement('li');
        li.className = 'timeline-item';
        li.innerHTML =
          '<span class="timeline-marker"></span>' +
          '<div class="timeline-content">' +
          '<div class="timeline-header-row">' +
          '<div class="timeline-stop-label">' +
          'Stop ' +
          stop.seq +
          ' ‚Ä¢ ' +
          safe(stop.destination2 || '-') +
          '</div>' +
          '<div class="timeline-status">' +
          safe(statusLabel) +
          '</div>' +
          '</div>' +
          '<div class="timeline-sub">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ: ' +
          safe(stop.destination1 || '-') +
          '</div>' +
          '<div class="timeline-sub"><b>Shipment:</b> ' +
          safe(stop.shipmentNo || '-') +
          '</div>' +
          '<div class="timeline-sub"><b>Distance (‡∏£‡∏∞‡∏ö‡∏ö):</b> ' +
          safe(distanceText) +
          '</div>' +
          '<div class="timeline-sub"><b>Check-in:</b> ' +
          safe(stop.checkInTime || '-') +
          '</div>' +
          '<div class="timeline-sub"><b>‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå Check-in:</b> ' +
          safe(odoText) +
          '</div>' +
          '<div class="timeline-sub"><b>‡∏•‡∏á‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô:</b> ' +
          safe(stop.fuelingTime || '-') +
          '</div>' +
          '<div class="timeline-sub"><b>‡∏•‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à:</b> ' +
          safe(stop.unloadDoneTime || '-') +
          '</div>' +
          '<div class="timeline-sub"><b>‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô:</b> ' +
          safe(stop.reviewedTime || '-') +
          '</div>' +
          '<div class="timeline-sub"><b>Check-out:</b> ' +
          safe(stop.checkOutTime || '-') +
          '</div>' +
          materialsBlock +
          '<div class="action-row">' +
          btnHtml +
          navBtnHtml +
          '</div>' +
          '</div>';
        ul.appendChild(li);
      });

      // ‚úÖ Logic ‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô / ‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ
      if (stops.length > 0) {
        if (tripEnded) {
          // ‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
          closeJobContainer.classList.add('hidden');
          if (btnCloseJob) {
            btnCloseJob.style.display = 'none';
            btnCloseJob.disabled = true;
          }
          if (btnEndTrip) {
            btnEndTrip.style.display = 'none';
            btnEndTrip.disabled = true;
          }
        } else if (jobClosed) {
          // ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏õ‡∏∏‡πà‡∏° "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ"
          closeJobContainer.classList.remove('hidden');
          if (btnCloseJob) {
            btnCloseJob.style.display = 'none';
            btnCloseJob.disabled = true;
          }
          if (btnEndTrip) {
            btnEndTrip.style.display = 'block';
            btnEndTrip.disabled = false;
          }
        } else if (allCheckout) {
          // Checkout ‡∏Ñ‡∏£‡∏ö ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô ‚Üí ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏° "‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô"
          closeJobContainer.classList.remove('hidden');
          if (btnCloseJob) {
            btnCloseJob.style.display = 'block';
            btnCloseJob.disabled = false;
          }
          if (btnEndTrip) {
            btnEndTrip.style.display = 'none';
            btnEndTrip.disabled = true;
          }
        } else {
          closeJobContainer.classList.add('hidden');
        }
      } else {
        closeJobContainer.classList.add('hidden');
      }

      container.classList.remove('hidden');
    }

    function getCurrentPositionAsync() {
      return new Promise(function (resolve, reject) {
        if (!navigator.geolocation) {
          reject(new Error('‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á'));
          return;
        }
        navigator.geolocation.getCurrentPosition(
          function (pos) {
            resolve(pos);
          },
          function (err) {
            reject(err);
          },
          { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 }
        );
      });
    }

    async function startCheckin(rowIndex, seq) {
      if (currentDrivers.length > 0 && currentCheckedDrivers.length === 0) {
        showInfo(
          '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô',
          '‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ñ‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ Check-in ‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á‡πÅ‡∏£‡∏Å'
        );
        return;
      }

      const { value: formValues } = await Swal.fire({
        icon: 'question',
        title: '‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡∏£‡∏ñ',
        html: `
            <div style="text-align:left;">
              <label style="font-size:0.8rem;color:#555;">‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡∏£‡∏ñ ‡∏ì ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà Check-in</label>
              <input id="swalOdoInput" type="number" inputmode="numeric"
                class="swal2-input"
                placeholder="‡πÄ‡∏ä‡πà‡∏ô 123456"
                style="width:100%;margin:6px 0 4px;">
            </div>
          `,
        focusConfirm: false,
        showCancelButton: true,
        confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô Check-in',
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
        confirmButtonColor: '#1abc9c',
        preConfirm: () => {
          const val = document.getElementById('swalOdoInput').value.trim();
          if (!val) {
            Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡∏£‡∏ñ');
            return false;
          }
          const num = Number(val);
          if (!Number.isFinite(num) || num < 0 || num > 3000000) {
            Swal.showValidationMessage('‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 0 - 3,000,000');
            return false;
          }
          return { odo: String(Math.floor(num)) };
        },
      });

      if (!formValues) {
        return;
      }

      const { odo } = formValues;
      await updateStopStatus(rowIndex, 'CHECKIN', 'checkin', seq, odo);
    }

    /**
     * Updates stop status (check-in, check-out, fueling, unload, etc.)
     * @param {number} rowIndex - Stop row index
     * @param {string} newStatus - New status value
     * @param {string} type - Action type (checkin, checkout, fuel, unload)
     * @param {number} seq - Stop sequence
     * @param {string|number} odo - Odometer value for check-in
     */
    async function updateStopStatus(rowIndex, newStatus, type, seq, odo) {
      if (isUpdatingStop) return;
      try {
        isUpdatingStop = true;
        showLoading(CONSTANTS.MESSAGES.LOADING_GET_COORDINATES);

        let pos;
        try {
          pos = await getCurrentPositionAsync();
        } catch (err) {
          window.Logger.warn('GPS error', err);
          closeLoading();
          showError(CONSTANTS.MESSAGES.ERROR_GPS);
          return;
        }

        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;

        showLoading(CONSTANTS.MESSAGES.LOADING_UPDATE);

        const result = await window.API.updateStop({
          rowIndex: rowIndex,
          status: newStatus,
          type: type,
          userId: currentUserId,
          lat: lat,
          lng: lng,
          odo: type === 'checkin' ? odo : undefined,
          accuracy: acc
        });

        closeLoading();

        if (!result.success) {
          showError(result.message);
          return;
        }

        await showSuccess(
          '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
          result.message || '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'
        );

        const stopInfo = result.data && result.data.stop ? result.data.stop : null;
        if (stopInfo) {
          if (acc != null) stopInfo.gpsAccuracy = acc;
          showInlineFlex(type, stopInfo);
          sendFlexCheckInOut(type, stopInfo);
        }

        if (currentReference) {
          document.getElementById('keyword').value = currentReference;
          await search();
        }

        window.Logger.info('‚úÖ Stop status updated', { rowIndex, newStatus, type });
      } catch (err) {
        window.Logger.error('‚ùå Update stop error', err);
        closeLoading();
        showError(CONSTANTS.MESSAGES.ERROR_UPDATE_FAILED);
      } finally {
        isUpdatingStop = false;
      }
    }

    // ‡∏ü‡∏≠‡∏£‡πå‡∏° "‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ"
    async function openEndTripDialog() {
      if (!currentReference) {
        showInfo('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏•‡∏Ç‡∏á‡∏≤‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô');
        return;
      }

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏≥
      const missingSteps = checkMissingSteps();

      if (missingSteps.length > 0) {
        // ‡πÅ‡∏™‡∏î‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î
        const result = await showMissingStepsForm(missingSteps);
        if (!result) {
          return; // ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
        }

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô
        const saveResult = await saveMissingStepsData(result.missingData);
        if (!saveResult) {
          showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
          return;
        }

        // Refresh ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        await search();
      }

      const { value: formValues } = await Swal.fire({
        title: '‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ',
        html: `
            <div style="text-align:left;">
              <div style="font-size:0.85rem;color:#555;margin-bottom:6px;">
                Reference: <b>${currentReference}</b>
              </div>

              <label style="font-size:0.8rem;color:#555;">‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ</label>
              <input id="swalEndOdo" type="number" min="0" step="1"
                class="swal2-input"
                placeholder="‡πÄ‡∏ä‡πà‡∏ô 234567"
                style="width:100%;margin:4px 0 8px;">

              <label style="font-size:0.8rem;color:#555;">‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏∏‡∏î‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ</label>
              <input id="swalEndPoint" type="text"
                class="swal2-input"
                placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ö‡∏≤‡∏á‡∏ô‡∏≤ / ‡∏•‡∏≤‡∏ô‡∏à‡∏≠‡∏î‡∏Ñ‡∏•‡∏±‡∏á‡∏´‡∏•‡∏±‡∏Å"
                style="width:100%;margin:4px 0 6px;">

              <div style="margin-top:6px;font-size:0.78rem;color:#888;">
                * ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå ‡∏à‡∏∏‡∏î‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS (Lat/Long) ‡∏ì ‡πÄ‡∏ß‡∏•‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
              </div>
            </div>
          `,
        focusConfirm: false,
        showCancelButton: true,
        confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ',
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
        confirmButtonColor: '#1abc9c',
        cancelButtonColor: '#95a5a6',
        preConfirm: () => {
          const odoVal = document
            .getElementById('swalEndOdo')
            .value.trim();
          const pointVal = document
            .getElementById('swalEndPoint')
            .value.trim();

          if (!odoVal) {
            Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ');
            return false;
          }
          const odoNum = parseFloat(odoVal);
          if (isNaN(odoNum) || odoNum < 0) {
            Swal.showValidationMessage(
              '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (0 ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ)'
            );
            return false;
          }
          if (!pointVal) {
            Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏∏‡∏î‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ');
            return false;
          }

          return {
            endOdo: odoVal,
            endPointName: pointVal,
          };
        },
      });

      if (!formValues) {
        return;
      }

      await saveEndTripSummary(formValues);
    }

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏≥
    function checkMissingSteps() {
      const missing = [];

      if (!lastStops || lastStops.length === 0) {
        return missing;
      }

      lastStops.forEach((stop) => {
        const isOrigin = !!stop.isOriginStop;
        const stopInfo = {
          rowIndex: stop.rowIndex,
          seq: stop.seq,
          destination: stop.destination2 || stop.destination1 || '‡∏à‡∏∏‡∏î ' + stop.seq,
          isOrigin: isOrigin,
          missing: []
        };

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Check-in
        if (!stop.checkInTime) {
          stopInfo.missing.push({
            type: 'checkin',
            label: 'Check-in',
            needOdo: true,
            needTime: true
          });
        }

        // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Origin
        if (!isOrigin) {
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏•‡∏á‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô
          if (stop.checkInTime && !stop.fuelingTime) {
            stopInfo.missing.push({
              type: 'fuel',
              label: '‡∏•‡∏á‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô',
              needOdo: false,
              needTime: true
            });
          }

          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏•‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à
          if (stop.fuelingTime && !stop.unloadDoneTime) {
            stopInfo.missing.push({
              type: 'unload',
              label: '‡∏•‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à',
              needOdo: false,
              needTime: true
            });
          }

          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô
          if (stop.unloadDoneTime && !stop.reviewedTime) {
            stopInfo.missing.push({
              type: 'review',
              label: '‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô',
              needOdo: false,
              needTime: true
            });
          }
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Check-out
        if (stop.checkInTime && !stop.checkOutTime) {
          stopInfo.missing.push({
            type: 'checkout',
            label: 'Check-out',
            needOdo: false,
            needTime: true
          });
        }

        if (stopInfo.missing.length > 0) {
          missing.push(stopInfo);
        }
      });

      return missing;
    }

    // ‡πÅ‡∏™‡∏î‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î
    async function showMissingStepsForm(missingSteps) {
      let formHtml = `
        <div style="text-align:left;max-height:400px;overflow-y:auto;">
          <div style="background:#fff3cd;border:1px solid #ffc107;border-radius:8px;padding:8px;margin-bottom:10px;">
            <div style="font-size:0.85rem;color:#856404;">
              ‚ö†Ô∏è <b>‡∏û‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏≥ ${missingSteps.length} ‡∏à‡∏∏‡∏î</b><br>
              ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô
            </div>
          </div>
      `;

      missingSteps.forEach((stop, stopIdx) => {
        formHtml += `
          <div style="background:#f8f9fa;border:1px solid #dee2e6;border-radius:8px;padding:10px;margin-bottom:10px;">
            <div style="font-weight:600;font-size:0.9rem;margin-bottom:8px;color:#16a085;">
              Stop ${stop.seq}: ${stop.destination}
            </div>
        `;

        stop.missing.forEach((step, stepIdx) => {
          const fieldPrefix = `stop${stopIdx}_step${stepIdx}`;

          formHtml += `
            <div style="margin-bottom:8px;padding:8px;background:#fff;border-radius:6px;">
              <div style="font-size:0.85rem;font-weight:600;margin-bottom:4px;">
                ${step.label}
              </div>
          `;

          if (step.needOdo) {
            formHtml += `
              <label style="font-size:0.75rem;color:#666;">‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå</label>
              <input id="${fieldPrefix}_odo" type="number" 
                class="swal2-input" 
                data-stopidx="${stopIdx}" 
                data-stepidx="${stepIdx}"
                data-field="odo"
                placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå"
                style="width:100%;margin:2px 0 6px;padding:6px 10px;font-size:0.85rem;">
            `;
          }

          if (step.needTime) {
            formHtml += `
              <label style="font-size:0.75rem;color:#666;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</label>
              <input id="${fieldPrefix}_datetime" type="datetime-local" 
                class="swal2-input"
                data-stopidx="${stopIdx}"
                data-stepidx="${stepIdx}"
                data-field="datetime"
                style="width:100%;margin:2px 0 4px;padding:6px 10px;font-size:0.85rem;">
            `;
          }

          formHtml += `</div>`;
        });

        formHtml += `</div>`;
      });

      formHtml += `</div>`;

      const { value: confirmed } = await Swal.fire({
        title: '‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡∏´‡∏≤‡∏¢‡πÑ‡∏õ',
        html: formHtml,
        width: '90%',
        focusConfirm: false,
        showCancelButton: true,
        confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
        confirmButtonColor: '#1abc9c',
        cancelButtonColor: '#95a5a6',
        preConfirm: () => {
          const missingData = [];

          missingSteps.forEach((stop, stopIdx) => {
            stop.missing.forEach((step, stepIdx) => {
              const fieldPrefix = `stop${stopIdx}_step${stepIdx}`;
              const data = {
                rowIndex: stop.rowIndex,
                seq: stop.seq,
                destination: stop.destination,
                type: step.type,
                label: step.label
              };

              if (step.needOdo) {
                const odoEl = document.getElementById(`${fieldPrefix}_odo`);
                const odoVal = odoEl ? odoEl.value.trim() : '';
                if (!odoVal) {
                  Swal.showValidationMessage(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${stop.destination} - ${step.label}`);
                  return false;
                }
                data.odo = odoVal;
              }

              if (step.needTime) {
                const dtEl = document.getElementById(`${fieldPrefix}_datetime`);
                const dtVal = dtEl ? dtEl.value.trim() : '';
                if (!dtVal) {
                  Swal.showValidationMessage(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${stop.destination} - ${step.label}`);
                  return false;
                }
                data.datetime = dtVal;
              }

              missingData.push(data);
            });
          });

          return { missingData };
        }
      });

      if (!confirmed) {
        return null;
      }

      return confirmed;
    }

    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡πÑ‡∏õ
    /**
     * Saves missing step data before end-trip
     * @param {Object} missingData - Missing data to submit
     * @returns {Promise<boolean>} Success flag
     */
    async function saveMissingStepsData(missingData) {
      try {
        showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡∏´‡∏≤‡∏¢‡πÑ‡∏õ...');

        // Get current position
        let pos;
        try {
          pos = await getCurrentPositionAsync();
        } catch (err) {
          window.Logger.warn('Geolocation error', err);
          closeLoading();
          showError(CONSTANTS.MESSAGES.ERROR_GPS);
          return false;
        }

        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;

        // Submit missing data via centralized API
        const result = await window.API.fillMissingSteps({
          reference: currentReference,
          userId: currentUserId,
          lat: lat,
          lng: lng,
          missingData: missingData,
          accuracy: acc
        });

        closeLoading();

        if (!result.success) {
          showError(result.message);
          return false;
        }

        await showSuccess(CONSTANTS.MESSAGES.SUCCESS_TITLE, '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
        window.Logger.info('‚úÖ Missing steps data saved', { fields: Object.keys(missingData) });
        return true;
      } catch (err) {
        window.Logger.error('‚ùå Missing steps save error', err);
        closeLoading();
        return false;
      }
    }

    // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ‡πÑ‡∏õ backend (‡∏£‡∏ß‡∏°‡∏û‡∏¥‡∏Å‡∏±‡∏î Lat/Long) + ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    /**
     * Saves end-of-trip summary data
     * @param {Object} values - Form values {endOdo, endPointName}
     */
    async function saveEndTripSummary(values) {
      try {
        showLoading(CONSTANTS.MESSAGES.LOADING_GET_COORDINATES);

        let pos;
        try {
          pos = await getCurrentPositionAsync();
        } catch (err) {
          window.Logger.warn('Geolocation error in endTrip', err);
          closeLoading();

          // Fallback: Ask user to enter coordinates manually or proceed without GPS
          const { value: fallback } = await Swal.fire({
            title: CONSTANTS.MESSAGES.ERROR_GPS,
            html: '<div style="text-align:left;font-size:0.85rem;color:#555;">‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏£‡∏≠‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÄ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏¥‡∏Å‡∏±‡∏î</div>' +
              '<input id="swalLat" class="swal2-input" placeholder="‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î (‡πÄ‡∏ä‡πà‡∏ô 13.7563)" type="number" step="0.0001">' +
              '<input id="swalLng" class="swal2-input" placeholder="‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î (‡πÄ‡∏ä‡πà‡∏ô 100.5018)" type="number" step="0.0001">',
            showCancelButton: true,
            confirmButtonText: CONSTANTS.MESSAGES.BUTTON_OK,
            cancelButtonText: CONSTANTS.MESSAGES.BUTTON_CANCEL,
            confirmButtonColor: '#1abc9c',
            preConfirm: () => {
              const latStr = (document.getElementById('swalLat') || {}).value || '';
              const lngStr = (document.getElementById('swalLng') || {}).value || '';
              const latNum = latStr ? Number(latStr) : null;
              const lngNum = lngStr ? Number(lngStr) : null;

              // Validate coordinates if provided
              if ((latStr && !Number.isFinite(latNum)) || (lngStr && !Number.isFinite(lngNum))) {
                Swal.showValidationMessage('‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                return false;
              }
              const coordsValidation = window.Validators.validateCoordinates(latNum, lngNum);
              if (!coordsValidation.valid) {
                Swal.showValidationMessage(coordsValidation.error);
                return false;
              }
              return { lat: latNum, lng: lngNum };
            }
          });

          if (!fallback) return;

          showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ...');

          const result = await window.API.endTrip({
            reference: currentReference,
            userId: currentUserId,
            endOdo: values.endOdo || 0,
            endPointName: values.endPointName || '',
            lat: fallback.lat || 0,
            lng: fallback.lng || 0
          });

          closeLoading();

          if (!result.success) {
            showError(result.message);
            return;
          }

          tripEnded = true;
          await showSuccess(CONSTANTS.MESSAGES.SUCCESS_TITLE, '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß\n‡∏Å‡∏£‡∏ì‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏à‡πâ‡∏á‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 1 ‡∏ß‡∏±‡∏ô');

          // Hide end-trip buttons
          const closeJobContainer = document.getElementById('closeJobContainer');
          const btnCloseJob = document.getElementById('btnCloseJob');
          const btnEndTrip = document.getElementById('btnEndTrip');
          if (closeJobContainer) closeJobContainer.classList.add('hidden');
          if (btnCloseJob) { btnCloseJob.style.display = 'none'; btnCloseJob.disabled = true; }
          if (btnEndTrip) { btnEndTrip.style.display = 'none'; btnEndTrip.disabled = true; }

          if (currentReference) {
            document.getElementById('keyword').value = currentReference;
            await search();
          }
          window.Logger.info('‚úÖ End trip (fallback GPS) completed', { endOdo: values.endOdo });
          return;
        }

        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;

        showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ...');

        const result = await window.API.endTrip({
          reference: currentReference,
          userId: currentUserId,
          endOdo: values.endOdo || 0,
          endPointName: values.endPointName || '',
          lat: lat,
          lng: lng,
          accuracy: acc
        });

        closeLoading();

        if (!result.success) {
          showError(result.message);
          return;
        }

        // Mark trip as ended
        tripEnded = true;

        await showSuccess(
          CONSTANTS.MESSAGES.SUCCESS_TITLE,
          '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß\n‡∏Å‡∏£‡∏ì‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏à‡πâ‡∏á‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 1 ‡∏ß‡∏±‡∏ô'
        );

        // Hide end-trip buttons
        const closeJobContainer = document.getElementById('closeJobContainer');
        const btnCloseJob = document.getElementById('btnCloseJob');
        const btnEndTrip = document.getElementById('btnEndTrip');
        if (closeJobContainer) closeJobContainer.classList.add('hidden');
        if (btnCloseJob) {
          btnCloseJob.style.display = 'none';
          btnCloseJob.disabled = true;
        }
        if (btnEndTrip) {
          btnEndTrip.style.display = 'none';
          btnEndTrip.disabled = true;
        }

        // Refresh data
        if (currentReference) {
          document.getElementById('keyword').value = currentReference;
          await search();
        }
        window.Logger.info('‚úÖ End trip completed', { endOdo: values.endOdo });
      } catch (err) {
        window.Logger.error('‚ùå End trip error', err);
        closeLoading();
        showError(CONSTANTS.MESSAGES.ERROR_ALCOHOL_SAVE);
      }
    }

    /**
     * Closes the job (marks vehicle as ready)
     */
    async function closeJob() {
      if (!currentReference) {
        showInfo(CONSTANTS.MESSAGES.INFO_NOT_FOUND, '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô');
        return;
      }

      const confirmResult = await Swal.fire({
        icon: 'question',
        title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô?',
        text: '‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡πà‡∏≤‡∏£‡∏ñ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô',
        showCancelButton: true,
        confirmButtonText: CONSTANTS.MESSAGES.BUTTON_SAVE,
        cancelButtonText: CONSTANTS.MESSAGES.BUTTON_CANCEL,
        confirmButtonColor: '#1abc9c',
      });

      if (!confirmResult.isConfirmed) return;

      try {
        showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô...');

        const result = await window.API.closeJob({
          reference: currentReference,
          userId: currentUserId
        });

        closeLoading();

        if (!result.success) {
          showError(result.message);
          return;
        }

        jobClosed = true;

        if (result.data && result.data.stop) {
          showInlineFlex('closejob', result.data.stop);
        }

        await showSuccess(CONSTANTS.MESSAGES.SUCCESS_CLOSEJOB, CONSTANTS.MESSAGES.INFO_IMPORTANT);

        // Reload data so d.jobClosed=true is reflected in UI
        if (currentReference) {
          document.getElementById('keyword').value = currentReference;
          await search();
        }

        window.Logger.info('‚úÖ Job closed successfully');
      } catch (err) {
        window.Logger.error('‚ùå Close job error', err);
        closeLoading();
        showError(CONSTANTS.MESSAGES.ERROR_ALCOHOL_SAVE);
      }
    }

    function navigateToStop(rowIndex) {
      const stop = (lastStops || []).find((s) => s.rowIndex === rowIndex);
      if (!stop) return;

      const lat =
        stop.destLat ||
        stop.destinationLat ||
        stop.dest_lat ||
        stop.lat ||
        '';
      const lng =
        stop.destLng ||
        stop.destinationLng ||
        stop.dest_lng ||
        stop.lng ||
        '';

      if (!lat || !lng) {
        Swal.fire({
          icon: 'warning',
          title: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á',
          text: '‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö',
          confirmButtonColor: '#1abc9c',
        });
        return;
      }

      const url =
        'https://www.google.com/maps?q=' +
        encodeURIComponent(lat) +
        ',' +
        encodeURIComponent(lng);
      window.open(url, '_blank');
    }

    document.addEventListener('DOMContentLoaded', function () {
      // Disable search until LIFF initializes
      const btnSearchEl = document.getElementById('btnSearch');
      if (btnSearchEl) btnSearchEl.disabled = true;

      initLiff();

      document
        .getElementById('btnSearch')
        .addEventListener('click', search);

      // Debounced auto-search on input (only when logged in)
      const debounced = (function () {
        let tId;
        const fn = () => {
          const kw = document.getElementById('keyword').value.trim();
          if (!currentUserId) return;
          if (kw && kw.length >= 5) {
            search();
          }
        };
        const wrapper = () => {
          clearTimeout(tId);
          tId = setTimeout(fn, 450);
        };
        wrapper.cancel = () => clearTimeout(tId);
        return wrapper;
      })();

      const kwEl = document.getElementById('keyword');
      kwEl.addEventListener('input', debounced);
      kwEl.addEventListener('keyup', function (e) {
        if (e.key === 'Enter') {
          debounced.cancel();
          search();
        }
      });

      document
        .getElementById('btnCloseJob')
        .addEventListener('click', closeJob);

      document
        .getElementById('btnEndTrip')
        .addEventListener('click', openEndTripDialog);

      // Diagnostics wiring
      const btnRunDiag = document.getElementById('btnRunDiag');
      const btnToggleDiag = document.getElementById('btnToggleDiag');
      const diagBody = document.getElementById('diagBody');
      if (btnToggleDiag && diagBody) {
        btnToggleDiag.addEventListener('click', () => {
          diagBody.classList.toggle('hidden');
        });
      }
      if (btnRunDiag) {
        btnRunDiag.addEventListener('click', runDiagnostics);
      }
    });

    // Diagnostics helpers
    function updateDiagnosticsSnapshot({ liffReady, loggedIn, userId }) {
      const li = document.getElementById('diagLiff');
      const lo = document.getElementById('diagLogin');
      const ui = document.getElementById('diagUser');
      const bu = document.getElementById('diagBackend');
      if (li) li.textContent = `LIFF: ${liffReady ? 'Ready' : 'Not ready'}`;
      if (lo) lo.textContent = `Login: ${loggedIn ? 'Yes' : 'No'}`;
      if (ui) ui.textContent = `UserId: ${userId || '-'}`;
      if (bu) bu.textContent = 'Backend URL: hidden';
        }`;
    }

    async function runDiagnostics() {
      const diagBody = document.getElementById('diagBody');
      if (diagBody) diagBody.classList.remove('hidden');

      const hasLiff = typeof liff !== 'undefined';
      const loggedIn = hasLiff && liff.isLoggedIn ? liff.isLoggedIn() : false;
      updateDiagnosticsSnapshot({ liffReady: hasLiff, loggedIn, userId: currentUserId || '' });

      const pingEl = document.getElementById('diagPing');
      const gpsEl = document.getElementById('diagGps');

      // Backend ping
      try {
        const base = window.CONSTANTS && window.CONSTANTS.API && window.CONSTANTS.API.WEB_APP_URL;
        if (!base) {
          if (pingEl) pingEl.textContent = 'Ping: no WEB_APP_URL';
        } else {
          const url = base.includes('?') ? `${base}&action=health` : `${base}?action=health`;
          const ac = new AbortController();
          const t0 = performance.now();
          const timer = setTimeout(() => ac.abort(), 7000);
          try {
            const res = await fetch(url, { method: 'GET', signal: ac.signal, cache: 'no-store' });
            const t1 = performance.now();
            const ms = Math.round(t1 - t0);
            if (pingEl) pingEl.textContent = `Ping: ${res.status} in ${ms}ms`;
          } finally {
            clearTimeout(timer);
          }
        }
      } catch (e) {
        if (pingEl) pingEl.textContent = `Ping: error (${e && e.message ? e.message : 'unknown'})`;
      }

      // GPS check
      try {
        const pos = await getCurrentPositionAsync();
        const acc = pos && pos.coords ? Math.round(pos.coords.accuracy || 0) : null;
        if (gpsEl) gpsEl.textContent = `GPS: OK${acc ? ` (¬±${acc}m)` : ''}`;
      } catch (e) {
        if (gpsEl) gpsEl.textContent = `GPS: error (${e && e.message ? e.message : 'unknown'})`;
      }
    }

    window.updateStopStatus = updateStopStatus;
    window.search = search;
    window.closeJob = closeJob;
    window.startCheckin = startCheckin;
    window.doAlcoholCheck = doAlcoholCheck;
    window.getCurrentPositionAsync = getCurrentPositionAsync;
    window.startReview = startReview;
    window.navigateToStop = navigateToStop;
    window.openEndTripDialog = openEndTripDialog;
    window.saveEndTripSummary = saveEndTripSummary;
    window.checkMissingSteps = checkMissingSteps;
    window.showMissingStepsForm = showMissingStepsForm;
    window.saveMissingStepsData = saveMissingStepsData;
  </script>
</body>

</html>