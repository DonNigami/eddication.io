<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Test Supabase Connection</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { 
      font-family: system-ui; 
      padding: 20px; 
      max-width: 600px; 
      margin: 0 auto;
    }
    button { 
      padding: 12px 24px; 
      font-size: 16px; 
      margin: 10px 0;
      cursor: pointer;
      width: 100%;
    }
    #output { 
      margin-top: 20px; 
      padding: 15px; 
      background: #f5f5f5; 
      border-radius: 8px;
      white-space: pre-wrap;
      font-family: monospace;
      font-size: 12px;
    }
    .success { color: green; }
    .error { color: red; }
  </style>
</head>
<body>
  <h1>ðŸ§ª Test Supabase Connection</h1>
  
  <button onclick="testConnection()">1. Test Connection</button>
  <button onclick="testRLS()">2. Check RLS Status</button>
  <button onclick="testSearch()">3. Search Job (2601S16472)</button>
  <button onclick="disableRLS()">4. Disable RLS (Fix)</button>
  
  <div id="output">Waiting for test...</div>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    const SUPABASE_URL = 'https://myplpshpcordggbbtblg.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im15cGxwc2hwY29yZGdnYmJ0YmxnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0MDI2ODgsImV4cCI6MjA4Mzk3ODY4OH0.UC42xLgqSdqgaogHmyRpES_NMy5t1j7YhdEZVwWUsJ8';

    const output = document.getElementById('output');

    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString('th-TH');
      const className = type === 'error' ? 'error' : type === 'success' ? 'success' : '';
      output.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
      console.log(message);
    }

    function clearOutput() {
      output.innerHTML = '';
    }

    // Initialize Supabase
    let sbClient;
    try {
      sbClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      log('âœ… Supabase client initialized', 'success');
    } catch (err) {
      log('âŒ Failed to initialize Supabase: ' + err.message, 'error');
    }

    async function testConnection() {
      clearOutput();
      log('Testing Supabase connection...');
      
      try {
        const { data, error } = await sbClient
          .from('driver_jobs')
          .select('count')
          .limit(1);

        if (error) {
          log('âŒ Connection failed: ' + error.message, 'error');
          log('Error details: ' + JSON.stringify(error, null, 2), 'error');
          
          if (error.code === 'PGRST301') {
            log('\nâš ï¸ RLS is blocking access!', 'error');
            log('Solution: Click button "4. Disable RLS"', 'error');
          }
        } else {
          log('âœ… Connection successful!', 'success');
          log('Response: ' + JSON.stringify(data, null, 2), 'success');
        }
      } catch (err) {
        log('âŒ Exception: ' + err.message, 'error');
      }
    }

    async function testRLS() {
      clearOutput();
      log('Checking RLS status...');
      
      try {
        // Try to access without RLS
        const { data, error } = await sbClient
          .from('driver_jobs')
          .select('*')
          .limit(1);

        if (error) {
          if (error.code === 'PGRST301' || error.message.includes('policy')) {
            log('ðŸ”’ RLS is ENABLED (blocking access)', 'error');
            log('You need to disable RLS or add proper policies', 'error');
          } else {
            log('âŒ Error: ' + error.message, 'error');
          }
        } else {
          log('âœ… RLS is DISABLED or policies allow access', 'success');
          log('Found ' + (data?.length || 0) + ' jobs', 'success');
        }
      } catch (err) {
        log('âŒ Exception: ' + err.message, 'error');
      }
    }

    async function testSearch() {
      clearOutput();
      log('Searching for job: 2601S16472...');
      
      try {
        const { data: job, error } = await sbClient
          .from('driver_jobs')
          .select('*')
          .eq('reference', '2601S16472')
          .single();

        if (error) {
          log('âŒ Search failed: ' + error.message, 'error');
          log('Error code: ' + error.code, 'error');
          
          if (error.code === 'PGRST116') {
            log('\nâš ï¸ Job not found in database', 'error');
            log('Make sure the data exists in driver_jobs table', 'error');
          } else if (error.code === 'PGRST301') {
            log('\nâš ï¸ RLS is blocking access!', 'error');
            log('Click button "4. Disable RLS"', 'error');
          }
        } else {
          log('âœ… Job found!', 'success');
          log(JSON.stringify(job, null, 2), 'success');
        }
      } catch (err) {
        log('âŒ Exception: ' + err.message, 'error');
      }
    }

    async function disableRLS() {
      clearOutput();
      log('âš ï¸ Manual action required!');
      log('');
      log('Go to: https://supabase.com/dashboard/project/myplpshpcordggbbtblg/sql/new');
      log('');
      log('Paste this SQL:');
      log('----------------------------------------');
      log('ALTER TABLE driver_jobs DISABLE ROW LEVEL SECURITY;');
      log('ALTER TABLE driver_stops DISABLE ROW LEVEL SECURITY;');
      log('ALTER TABLE driver_alcohol_checks DISABLE ROW LEVEL SECURITY;');
      log('ALTER TABLE driver_logs DISABLE ROW LEVEL SECURITY;');
      log('');
      log('SELECT \'RLS disabled\' as status;');
      log('----------------------------------------');
      log('');
      log('Then click "Run" (Ctrl+Enter)');
      log('');
      log('After that, come back here and click "3. Search Job"');
      
      // Auto-open SQL editor
      window.open('https://supabase.com/dashboard/project/myplpshpcordggbbtblg/sql/new', '_blank');
    }

    // Auto-run test on load
    window.addEventListener('load', () => {
      setTimeout(testConnection, 500);
    });
  </script>
</body>
</html>
