<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>Admin Console - Driver Tracking</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --danger: #dc2626;
      --bg: #f4f4f5;
      --card-bg: #ffffff;
      --border: #e5e7eb;
      --text-main: #111827;
      --text-sub: #6b7280;
      --radius-lg: 12px;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--text-main);
    }

    .app {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      padding: 16px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
      border: 1px solid var(--border);
    }

    header {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 16px;
    }

    header h1 {
      font-size: 1.3rem;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    header h1 span.badge {
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: #e0f2fe;
      color: #0369a1;
    }

    header .sub {
      font-size: 0.85rem;
      color: var(--text-sub);
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: #eef2ff;
      color: #3730a3;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.8rem;
    }

    .pill.bad {
      background: #fee2e2;
      color: #b91c1c;
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 4px;
      overflow-x: auto;
    }

    .tab-btn {
      border: none;
      background: transparent;
      padding: 8px 12px;
      border-radius: 999px;
      font-size: 0.9rem;
      cursor: pointer;
      color: var(--text-sub);
      white-space: nowrap;
    }

    .tab-btn.active {
      background: #dbeafe;
      color: var(--primary-dark);
      font-weight: 600;
    }

    .tab-content {
      margin-top: 16px;
    }

    .tab-panel {
      display: none;
    }

    .tab-panel.active {
      display: block;
    }

    .filters {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 8px;
      margin-bottom: 10px;
      align-items: flex-end;
    }

    label {
      font-size: 0.8rem;
      color: var(--text-sub);
      display: block;
      margin-bottom: 2px;
    }

    input[type="text"],
    input[type="number"],
    select {
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 0.85rem;
    }

    button {
      font-size: 0.85rem;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      padding: 7px 14px;
    }

    .btn-main {
      background: var(--primary);
      color: white;
    }

    .btn-main:hover {
      background: var(--primary-dark);
    }

    .btn-ghost {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-sub);
    }

    .btn-danger {
      background: var(--danger);
      color: #fee2e2;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 0.8rem;
    }

    thead {
      background: #f9fafb;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    th, td {
      border-bottom: 1px solid var(--border);
      padding: 6px 8px;
      vertical-align: middle;
      text-align: left;
    }

    th {
      font-size: 0.78rem;
      color: var(--text-sub);
      font-weight: 600;
      white-space: nowrap;
    }

    tbody tr:hover {
      background: #f9fafb;
    }

    .status-pill {
      display: inline-flex;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
      background: #e5e7eb;
      color: #374151;
    }

    .status-pill.done { background: #dcfce7; color: #166534; }
    .status-pill.new { background: #e0f2fe; color: #075985; }
    .status-pill.reviewed { background: #fef3c7; color: #92400e; }
    .status-pill.alert { background: #fee2e2; color: #b91c1c; }

    .tag {
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 999px;
      background: #eef2ff;
      color: #3730a3;
    }

    .small-input { width: 80px; }

    .actions {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }

    .center { text-align: center; }

    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.12);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .loading-overlay.active { display: flex; }

    .loading-box {
      background: #ffffff;
      padding: 12px 16px;
      border-radius: 999px;
      box-shadow: 0 10px 40px rgba(15, 23, 42, 0.18);
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.9rem;
    }

    .spinner {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 2px solid #e5e7eb;
      border-top-color: var(--primary);
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .msg { font-size: 0.8rem; margin-top: 6px; }
    .msg.error { color: #b91c1c; }
    .msg.success { color: #15803d; }

    .scroll-wrapper {
      max-height: 55vh;
      overflow: auto;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: white;
    }

    /* ‚úÖ AddStop info box */
    .info-box {
      border: 1px solid var(--border);
      background: #f9fafb;
      padding: 10px 12px;
      border-radius: 12px;
      margin: 8px 0 10px;
      display: grid;
      gap: 6px;
    }
    .info-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      font-size: 0.85rem;
    }
    .info-key { color: var(--text-sub); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    @media (max-width: 768px) {
      .app { padding: 10px; }
      header h1 { font-size: 1.1rem; }
      .scroll-wrapper { max-height: 60vh; }
    }
  </style>
</head>
<body>
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-box">
    <div class="spinner"></div>
    <span id="loadingText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
  </div>
</div>

<div class="app">
  <div class="card">
    <header>
      <h1>
        Admin Console
        <span class="badge">Driver Tracking</span>
      </h1>
      <div class="sub">
          <span id="adminInfo">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô</span>
          <span id="adminRoleBadge" class="pill bad" style="display:none;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Admin</span>
          <span id="envBadge" class="pill">WebApp</span>
        </div>
        <div id="globalMessage" class="msg"></div>

        <!-- ‚úÖ LOGIN PANEL -->
        <div id="loginPanel" class="filters" style="background: #f9fafb; padding: 10px; border-radius: 8px; margin: 8px 0;">
          <div>
            <label>User ID *</label>
            <input type="text" id="userIdInput" placeholder="‡πÄ‡∏ä‡πà‡∏ô U1234... ‡∏´‡∏£‡∏∑‡∏≠ C1234..." />
          </div>
          <div>
            <label>&nbsp;</label>
            <button class="btn-main" id="btnCheckAdmin">‚úîÔ∏è ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Admin</button>
            <button class="btn-ghost" id="btnLogout" style="display:none;">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
          </div>
        </div>

    <div class="tab-content">

      <!-- JOBDATA PANEL -->
      <div class="tab-panel active" id="tab-jobdata">
        <div class="filters">
          <div>
            <label>Reference</label>
            <input type="text" id="jobRef" placeholder="‡πÄ‡∏ä‡πà‡∏ô 12345" />
          </div>
          <div>
            <label>Status</label>
            <select id="jobStatus">
              <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
              <option value="NEW">NEW</option>
              <option value="CHECKIN">CHECKIN</option>
              <option value="CHECKOUT">CHECKOUT</option>
              <option value="REVIEWED">REVIEWED</option>
              <option value="JOB_DONE">JOB_DONE</option>
              <option value="END_TRIP">END_TRIP</option>
            </select>
          </div>
          <div>
            <label>&nbsp;</label>
            <button class="btn-main" id="btnLoadJob">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Jobdata</button>
          </div>
        </div>
        <div id="jobMessage" class="msg"></div>
        <div class="scroll-wrapper">
          <table>
            <thead>
            <tr>
              <th>#</th>
              <th>Ref</th>
              <th>Shipment</th>
              <th>‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</th>
              <th>Status</th>
              <th>Check-in</th>
              <th>Check-out</th>
              <th>ODO</th>
              <th>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÇ‡∏î‡∏¢</th>
              <th>‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</th>
              <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
            </tr>
            </thead>
            <tbody id="jobTableBody">
            <tr><td colspan="11" class="center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- ‚úÖ ADDSTOP PANEL -->
      <div class="tab-panel" id="tab-addstop">
        <div class="filters">
          <div>
            <label>Reference (‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤)</label>
            <input type="text" id="addRef" placeholder="‡πÄ‡∏ä‡πà‡∏ô 12345" />
          </div>
          <div>
            <label>&nbsp;</label>
            <button class="btn-main" id="btnFindRef">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Reference</button>
          </div>
          <div>
            <label>&nbsp;</label>
            <button class="btn-ghost" id="btnPrefillFromJob">‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏õ‡πÉ‡∏™‡πà‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
          </div>
        </div>

        <div id="addMessage" class="msg"></div>

        <div class="info-box" id="refInfoBox" style="display:none;">
          <div class="info-row">
            <span class="info-key">Ref:</span>
            <span class="mono" id="refInfoRef">-</span>
            <span class="info-key">Shipment:</span>
            <span class="mono" id="refInfoShipment">-</span>
          </div>
          <div class="info-row">
            <span class="info-key">Vehicle Desc:</span>
            <span class="mono" id="refInfoVehicle">-</span>
            <span class="tag" id="refInfoSrc">source: -</span>
          </div>
          <div class="info-row">
            <span class="info-key">‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏°:</span>
            <span id="refInfoDest">-</span>
          </div>
        </div>

        <div class="filters" style="margin-top: 8px;">
          <div>
            <label>‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏∏‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏° (shipToName) *</label>
            <input type="text" id="addShipToName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏à‡∏∏‡∏î‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏° - ‡∏ö‡∏≤‡∏á‡∏ô‡∏≤" />
          </div>
          <div>
            <label>‡∏£‡∏´‡∏±‡∏™‡∏à‡∏∏‡∏î (shipToCode)</label>
            <input type="text" id="addShipToCode" placeholder="‡πÄ‡∏ä‡πà‡∏ô PTG001" />
          </div>
          <div>
            <label>Lat</label>
            <input type="number" id="addLat" placeholder="13.7000" step="0.000001" />
          </div>
          <div>
            <label>Lng</label>
            <input type="number" id="addLng" placeholder="100.6000" step="0.000001" />
          </div>
          <div>
            <label>Radius (m)</label>
            <input type="number" id="addRadius" placeholder="50" step="1" />
          </div>
          <div>
            <label>&nbsp;</label>
            <button class="btn-main" id="btnAddStop">‚ûï ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Add Stop</button>
          </div>
        </div>

        <div class="scroll-wrapper" style="margin-top: 10px;">
          <table>
            <thead>
            <tr>
              <th>#</th>
              <th>Ref</th>
              <th>Shipment</th>
              <th>‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</th>
              <th>Code</th>
              <th>Status</th>
              <th>SourceRow</th>
              <th>‡∏û‡∏¥‡∏Å‡∏±‡∏î</th>
              <th>UpdatedBy</th>
              <th>UpdatedAt</th>
            </tr>
            </thead>
            <tbody id="addstopPreviewBody">
              <tr><td colspan="10" class="center">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ reference ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- ALCOHOL PANEL -->
      <div class="tab-panel" id="tab-alcohol">
        <div class="filters">
          <div>
            <label>Reference</label>
            <input type="text" id="alcRef" placeholder="‡πÄ‡∏ä‡πà‡∏ô 12345" />
          </div>
          <div>
            <label>‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö</label>
            <input type="text" id="alcDriver" placeholder="‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏ä‡∏∑‡πà‡∏≠" />
          </div>
          <div>
            <label>&nbsp;</label>
            <button class="btn-main" id="btnLoadAlcohol">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Alcohol</button>
          </div>
        </div>
        <div id="alcMessage" class="msg"></div>
        <div class="scroll-wrapper">
          <table>
            <thead>
            <tr>
              <th>#</th>
              <th>Ref</th>
              <th>‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö</th>
              <th>Alcohol</th>
              <th>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ</th>
              <th>User</th>
              <th>‡∏û‡∏¥‡∏Å‡∏±‡∏î</th>
              <th>‡∏£‡∏π‡∏õ</th>
              <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
            </tr>
            </thead>
            <tbody id="alcTableBody">
            <tr><td colspan="9" class="center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- USERPROFILE PANEL -->
      <div class="tab-panel" id="tab-userprofile">
        <div class="filters">
          <div>
            <label>Status</label>
            <select id="userStatus">
              <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
              <option value="PENDING">PENDING</option>
              <option value="APPROVED">APPROVED</option>
              <option value="REJECTED">REJECTED</option>
            </select>
          </div>
          <div>
            <label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ userId)</label>
            <input type="text" id="userKeyword" placeholder="‡∏ä‡∏∑‡πà‡∏≠ / userId" />
          </div>
          <div>
            <label>&nbsp;</label>
            <button class="btn-main" id="btnLoadUsers">‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
          </div>
        </div>
        <div id="userMessage" class="msg"></div>
        <div class="scroll-wrapper">
          <table>
            <thead>
            <tr>
              <th>‡∏£‡∏π‡∏õ</th>
              <th>‡∏ä‡∏∑‡πà‡∏≠</th>
              <th>userId</th>
              <th>Status</th>
              <th>Type</th>
              <th>‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠</th>
              <th>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
              <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
            </tr>
            </thead>
            <tbody id="userTableBody">
            <tr><td colspan="8" class="center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>
            </tbody>
          </table>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
  // ‚úÖ URL Web App ‡∏Ç‡∏≠‡∏á Google Apps Script (‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢ /exec)
  const GAS_BASE_URL = 'https://script.google.com/macros/s/AKfycbxn8IxIhL9zdO1QMEyAZ8TThppvApILg7oyGdrPFeKU7L83ClgxxmTKz0bhj0u5ZJM/exec';

  let ADMIN_USER_ID = null;
  let ADMIN_NAME = '';
  let IS_ADMIN = false;

  // ‚úÖ cache ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ reference ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡πÉ‡∏ä‡πâ prefill)
  let LAST_REF_LOOKUP = null;

  // ‚úÖ ‡∏î‡∏∂‡∏á userId ‡∏à‡∏≤‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡πÅ‡∏´‡∏•‡πà‡∏á
  function getUserIdFromUrl() {
    // 1. ‡∏•‡∏≠‡∏á‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å URL query parameter
    const params = new URLSearchParams(window.location.search);
    const urlUserId = params.get('userId');
    if (urlUserId) return urlUserId;

    // 2. ‡∏•‡∏≠‡∏á‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å URL hash
    const hashMatch = window.location.hash.match(/userId=([^&]+)/);
    if (hashMatch) return hashMatch[1];

    // 3. ‡∏•‡∏≠‡∏á‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å localStorage
    const storedUserId = localStorage.getItem('admin_user_id');
    if (storedUserId) return storedUserId;

    return null;
  }

  function saveUserIdToStorage(userId) {
    localStorage.setItem('admin_user_id', userId);
  }

  function clearUserIdFromStorage() {
    localStorage.removeItem('admin_user_id');
    localStorage.removeItem('admin_is_admin');
  }

  function getBaseUrl() {
    return GAS_BASE_URL;
  }

  function setLoading(show, text) {
    const overlay = document.getElementById('loadingOverlay');
    const label = document.getElementById('loadingText');
    if (text) label.textContent = text;
    overlay.classList.toggle('active', !!show);
  }

  // Reusable fetch with status/JSON guard
  async function fetchJson(url, options = {}) {
    const res = await fetch(url, options);
    if (!res.ok) {
      const errText = await res.text().catch(() => '');
      throw new Error(`HTTP ${res.status}: ${errText || res.statusText}`);
    }
    try {
      return await res.json();
    } catch (e) {
      throw new Error('Invalid JSON response');
    }
  }

  // Small DOM helpers to avoid innerHTML injection
  function appendTextCell(tr, text, className) {
    const td = document.createElement('td');
    if (className) td.className = className;
    td.textContent = text ?? '';
    tr.appendChild(td);
    return td;
  }

  function appendSpan(parent, text, className) {
    const span = document.createElement('span');
    if (className) span.className = className;
    span.textContent = text ?? '';
    parent.appendChild(span);
    return span;
  }

  function setGlobalMessage(msg, type = '') {
    const el = document.getElementById('globalMessage');
    el.textContent = msg || '';
    el.className = 'msg' + (type ? ' ' + type : '');
  }

  function setPanelMessage(id, msg, type = '') {
    const el = document.getElementById(id);
    el.textContent = msg || '';
    el.className = 'msg' + (type ? ' ' + type : '');
  }

  function setAdminInfo(text) {
    const el = document.getElementById('adminInfo');
    el.textContent = text;
  }

  function showAdminBadge(isAdmin) {
    const badge = document.getElementById('adminRoleBadge');
    if (isAdmin) {
      badge.textContent = 'Admin ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
      badge.classList.remove('bad');
      badge.classList.add('pill');
      badge.style.display = 'inline-flex';
      badge.style.background = '#dcfce7';
      badge.style.color = '#166534';
    } else {
      badge.textContent = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Admin';
      badge.classList.add('bad');
      badge.style.display = 'inline-flex';
    }
  }

  // -------- Tabs ---------
  function initTabs() {
    const buttons = document.querySelectorAll('.tab-btn');
    buttons.forEach(btn => {
      btn.addEventListener('click', () => {
        const tab = btn.getAttribute('data-tab');
        buttons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.tab-panel').forEach(p => {
          p.classList.toggle('active', p.id === 'tab-' + tab);
        });
      });
    });
  }

  // -------- Manual Admin / Auth ---------
  async function initAdmin() {
    // ‡∏•‡∏≠‡∏á‡∏î‡∏∂‡∏á userId ‡∏à‡∏≤‡∏Å URL ‡∏´‡∏£‡∏∑‡∏≠ localStorage
    const storedUserId = getUserIdFromUrl();
    
    if (storedUserId) {
      document.getElementById('userIdInput').value = storedUserId;
      document.getElementById('loginPanel').style.display = 'none';
      document.getElementById('btnLogout').style.display = 'inline-block';
      await checkAdminPermission(storedUserId);
    } else {
      setAdminInfo('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà User ID ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö');
      document.getElementById('loginPanel').style.display = 'grid';
    }
  }

  async function handleManualLogin() {
    const userId = document.getElementById('userIdInput').value.trim();
    
    if (!userId) {
      setGlobalMessage('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà User ID', 'error');
      return;
    }

    if (!/^[UC][a-zA-Z0-9]{5,}/.test(userId)) {
      setGlobalMessage('‚ùå User ID ‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ U ‡∏´‡∏£‡∏∑‡∏≠ C ‡∏ï‡∏≤‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ‡πÄ‡∏ä‡πà‡∏ô Uaea04ce9a718e...', 'error');
      return;
    }

    saveUserIdToStorage(userId);
    ADMIN_USER_ID = userId;
    document.getElementById('loginPanel').style.display = 'none';
    document.getElementById('btnLogout').style.display = 'inline-block';
    await checkAdminPermission(userId);
  }

  function handleLogout() {
    clearUserIdFromStorage();
    ADMIN_USER_ID = null;
    IS_ADMIN = false;
    document.getElementById('userIdInput').value = '';
    setAdminInfo('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß');
    setGlobalMessage('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß', 'success');
    showAdminBadge(false);
    document.getElementById('loginPanel').style.display = 'grid';
    document.getElementById('btnLogout').style.display = 'none';
  }

  // -------- LIFF / Auth ---------
  async function initLiff() {
    if (!LIFF_ID || LIFF_ID === 'YOUR_LIFF_ID_HERE') {
      setAdminInfo('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ LIFF_ID ‡πÉ‡∏ô admin.html ‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
      setGlobalMessage('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ LIFF ID', 'error');
      return;
    }

    try {
      setLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE ...');
      await liff.init({ liffId: LIFF_ID });

      if (!liff.isLoggedIn()) {
        liff.login();
        return;
      }

      let userId = null;
      let displayName = '';

      try {
        const decoded = liff.getDecodedIDToken();
        if (decoded && decoded.sub) {
          userId = decoded.sub;
        }
      } catch (e) {
        console.log('getDecodedIDToken error', e);
      }

      const profile = await liff.getProfile();
      if (!userId && profile && profile.userId) {
        userId = profile.userId;
      }
      displayName = profile.displayName || '';

      ADMIN_USER_ID = userId;
      ADMIN_NAME = displayName;

      setAdminInfo(`‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö: ${displayName} (${userId})`);
      console.log('‚úÖ userId from LIFF:', userId);

      await checkAdminPermission(userId);
    } catch (err) {
      console.error(err);
      setAdminInfo('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE/LIFF ‡πÑ‡∏î‡πâ');
      setGlobalMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LIFF', 'error');
    } finally {
      setLoading(false);
    }
  }

  async function checkAdminPermission(userId) {
    if (!userId) {
      setGlobalMessage('‡πÑ‡∏°‡πà‡∏û‡∏ö userId ‡∏à‡∏≤‡∏Å LINE ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ Login ‡πÉ‡∏´‡∏°‡πà', 'error');
      showAdminBadge(false);
      return;
    }
    setLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Admin ...');
    try {
      const base = getBaseUrl();
      const url = `${base}?action=checkadmin&userId=${encodeURIComponent(userId)}`;
      console.log('üîç Checking admin permission at:', url);
      const json = await fetchJson(url);
      console.log('üì® Response from GAS:', json);

      if (!json.success || !json.isAdmin) {
        IS_ADMIN = false;
        showAdminBadge(false);
        setGlobalMessage('‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Admin ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•', 'error');
        localStorage.removeItem('admin_is_admin');
      } else {
        IS_ADMIN = true;
        localStorage.setItem('admin_is_admin', 'true');
        showAdminBadge(true);
        setAdminInfo(`‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö: ${userId} (Admin)`);
        setGlobalMessage('‚úÖ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤ Admin', 'success');
      }
    } catch (e) {
      console.error('‚ùå Error checking admin:', e);
      setGlobalMessage('‚ùå ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
      showAdminBadge(false);
    } finally {
      setLoading(false);
    }
  }

  // =========================
  // Jobdata
  // =========================
  async function loadJobdata() {
    if (!ADMIN_USER_ID) {
      setPanelMessage('jobMessage', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô LINE ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å LIFF', 'error');
      await initLiff();
      return;
    }
    setPanelMessage('jobMessage', '');
    setLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î Jobdata ...');

    try {
      const ref = document.getElementById('jobRef').value.trim();
      const status = document.getElementById('jobStatus').value.trim();
      const base = getBaseUrl();
      const qs = new URLSearchParams({
        action: 'adminjobdata',
        adminUserId: ADMIN_USER_ID,
        reference: ref,
        status: status,
        limit: '200'
      });
      const json = await fetchJson(`${base}?${qs.toString()}`);

      if (!json.success) {
        setPanelMessage('jobMessage', json.message || '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
        renderJobdata([]);
        return;
      }

      renderJobdata(json.rows || []);
      setPanelMessage('jobMessage', `‡∏û‡∏ö ${json.rows.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'success');
    } catch (e) {
      console.error(e);
      setPanelMessage('jobMessage', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î Jobdata', 'error');
      renderJobdata([]);
    } finally {
      setLoading(false);
    }
  }

  function renderJobdata(rows) {
    const tbody = document.getElementById('jobTableBody');
    tbody.replaceChildren();
    if (!rows || rows.length === 0) {
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 11;
      td.className = 'center';
      td.textContent = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }

    rows.forEach((r, idx) => {
      const tr = document.createElement('tr');

      const statusClass = (s => {
        s = (s || '').toUpperCase();
        if (s === 'JOB_DONE') return 'status-pill done';
        if (s === 'NEW') return 'status-pill new';
        if (s === 'REVIEWED') return 'status-pill reviewed';
        if (s === 'CHECKIN') return 'status-pill alert';
        if (s === 'END_TRIP') return 'status-pill';
        return 'status-pill';
      })(r.status);

      appendTextCell(tr, idx + 1);
      appendTextCell(tr, r.referenceNo || '');
      appendTextCell(tr, r.shipmentNo || '');

      const destTd = document.createElement('td');
      const destMain = document.createElement('div');
      destMain.textContent = r.destination2 || '';
      const destTag = document.createElement('div');
      destTag.className = 'tag';
      destTag.textContent = r.destination1 || '-';
      destTd.append(destMain, destTag);
      tr.appendChild(destTd);

      const statusTd = document.createElement('td');
      const select = document.createElement('select');
      select.dataset.row = r.rowIndex;
      select.className = 'job-status-select';
      ['NEW','CHECKIN','CHECKOUT','REVIEWED','JOB_DONE','END_TRIP'].forEach(s => {
        const opt = document.createElement('option');
        opt.value = s;
        opt.textContent = s;
        if (s === r.status) opt.selected = true;
        select.appendChild(opt);
      });
      statusTd.appendChild(select);
      const pillWrap = document.createElement('div');
      pillWrap.style.marginTop = '2px';
      appendSpan(pillWrap, r.status || '', statusClass);
      statusTd.appendChild(pillWrap);
      tr.appendChild(statusTd);

      appendTextCell(tr, r.checkInTime || '-');
      appendTextCell(tr, r.checkOutTime || '-');
      appendTextCell(tr, r.checkInOdo || '-');
      appendTextCell(tr, r.updatedBy || '-');
      appendTextCell(tr, r.updatedAt || '-');

      const actionsTd = document.createElement('td');
      actionsTd.className = 'actions';
      const btn = document.createElement('button');
      btn.className = 'btn-main';
      btn.dataset.row = r.rowIndex;
      btn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
      btn.addEventListener('click', () => onSaveJobStatus(btn));
      actionsTd.appendChild(btn);
      tr.appendChild(actionsTd);

      tbody.appendChild(tr);
    });
  }

  async function onSaveJobStatus(btn) {
    if (!ADMIN_USER_ID) {
      setPanelMessage('jobMessage', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô LINE', 'error');
      await initLiff();
      return;
    }
    const rowIndex = btn.getAttribute('data-row');
    const select = document.querySelector(`select.job-status-select[data-row="${rowIndex}"]`);
    if (!select) return;
    const newStatus = select.value;

    if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ row ${rowIndex} ‡πÄ‡∏õ‡πá‡∏ô ${newStatus} ?`)) return;

    setLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Job ...');
    try {
      const base = getBaseUrl();
      const form = new URLSearchParams();
      form.append('action', 'adminUpdateJob');
      form.append('adminUserId', ADMIN_USER_ID);
      form.append('rowIndex', rowIndex);
      form.append('status', newStatus);

      const json = await fetchJson(base, { method: 'POST', body: form });

      if (!json.success) {
        setPanelMessage('jobMessage', json.message || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
      } else {
        setPanelMessage('jobMessage', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        await loadJobdata();
      }
    } catch (e) {
      console.error(e);
      setPanelMessage('jobMessage', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', 'error');
    } finally {
      setLoading(false);
    }
  }

  // =========================
  // ‚úÖ Add Stop
  // =========================

  function showRefInfoBox(show) {
    const box = document.getElementById('refInfoBox');
    box.style.display = show ? 'grid' : 'none';
  }

  function renderAddstopPreview(rows) {
    const tbody = document.getElementById('addstopPreviewBody');
    tbody.replaceChildren();

    if (!rows || rows.length === 0) {
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 10;
      td.className = 'center';
      td.textContent = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }

    rows.forEach((r, idx) => {
      const tr = document.createElement('tr');
      appendTextCell(tr, idx + 1);
      appendTextCell(tr, r.referenceNo || '');
      appendTextCell(tr, r.shipmentNo || '');
      appendTextCell(tr, r.destination2 || '');
      const codeTd = document.createElement('td');
      appendSpan(codeTd, r.destination1 || '-', 'tag');
      tr.appendChild(codeTd);
      const statusTd = document.createElement('td');
      appendSpan(statusTd, r.status || '', 'status-pill');
      tr.appendChild(statusTd);
      appendTextCell(tr, r.sourceRow || '-', 'mono');
      appendTextCell(tr, `${r.destLat || '-'}, ${r.destLng || '-'} (${r.radiusM || '-'})`, 'mono');
      appendTextCell(tr, r.updatedBy || '-', 'mono');
      appendTextCell(tr, r.updatedAt || '-', 'mono');
      tbody.appendChild(tr);
    });
  }

  async function findReferenceForAddStop() {
    if (!ADMIN_USER_ID) {
      setPanelMessage('addMessage', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô LINE', 'error');
      await initLiff();
      return;
    }

    const ref = document.getElementById('addRef').value.trim();
    if (!ref) {
      setPanelMessage('addMessage', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡πÄ‡∏•‡∏Ç Reference', 'error');
      return;
    }

    setPanelMessage('addMessage', '');
    setLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Reference ...');

    try {
      const base = getBaseUrl();

      // 1) ‡πÉ‡∏ä‡πâ adminjobdata ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ô driver approval)
      const qs = new URLSearchParams({
        action: 'adminjobdata',
        adminUserId: ADMIN_USER_ID,
        reference: ref,
        status: '',
        limit: '200'
      });
      const json = await fetchJson(`${base}?${qs.toString()}`);

      if (!json.success) {
        setPanelMessage('addMessage', json.message || '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
        showRefInfoBox(false);
        renderAddstopPreview([]);
        LAST_REF_LOOKUP = null;
        return;
      }

      const rows = json.rows || [];
      renderAddstopPreview(rows);

      if (rows.length === 0) {
        setPanelMessage('addMessage', '‡πÑ‡∏°‡πà‡∏û‡∏ö jobdata ‡∏Ç‡∏≠‡∏á reference ‡∏ô‡∏µ‡πâ (‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô/‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô)', 'error');
        showRefInfoBox(false);
        LAST_REF_LOOKUP = null;
        return;
      }

      // ‡πÄ‡∏Å‡πá‡∏ö cache
      LAST_REF_LOOKUP = { ref, rows };

      // info box
      const first = rows[0];
      document.getElementById('refInfoRef').textContent = ref;
      document.getElementById('refInfoShipment').textContent = first.shipmentNo || '-';
      document.getElementById('refInfoDest').textContent =
        (rows.filter(x => !x.isOriginStop).map(x => x.destination2).filter(Boolean).slice(0, 5).join(' / ')) || '-';
      document.getElementById('refInfoVehicle').textContent = '-';
      document.getElementById('refInfoSrc').textContent = 'source: jobdata';
      showRefInfoBox(true);

      // 2) (‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å) ‡∏•‡∏≠‡∏á‡∏î‡∏∂‡∏á vehicleDescription ‡∏à‡∏≤‡∏Å action=search
      // ‡∏ñ‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö require APPROVED ‡πÅ‡∏•‡πâ‡∏ß admin ‡πÑ‡∏°‡πà approved ‡∏à‡∏∞ fail ‚Üí ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏£
      try {
        const qs2 = new URLSearchParams({
          action: 'search',
          keyword: ref,
          userId: ADMIN_USER_ID
        });
        const json2 = await fetchJson(`${base}?${qs2.toString()}`);
        const v = json2 && json2.success && json2.data ? (json2.data.vehicleDescription || '') : '';
        if (v) {
          document.getElementById('refInfoVehicle').textContent = v;
          document.getElementById('refInfoSrc').textContent = 'source: zoile (vehicle desc)';
        }
      } catch (e2) {
        // ignore
      }

      setPanelMessage('addMessage', `‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Ref: ${ref}`, 'success');

    } catch (e) {
      console.error(e);
      setPanelMessage('addMessage', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ reference', 'error');
      showRefInfoBox(false);
      renderAddstopPreview([]);
      LAST_REF_LOOKUP = null;
    } finally {
      setLoading(false);
    }
  }

  function prefillAddStopForm() {
    if (!LAST_REF_LOOKUP || !LAST_REF_LOOKUP.rows || LAST_REF_LOOKUP.rows.length === 0) {
      setPanelMessage('addMessage', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• reference ‡πÉ‡∏´‡πâ‡∏Å‡∏î‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Å‡πà‡∏≠‡∏ô', 'error');
      return;
    }
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
    document.getElementById('addShipToName').focus();
    if (!document.getElementById('addRadius').value.trim()) {
      document.getElementById('addRadius').value = '50';
    }
    setPanelMessage('addMessage', '‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ (‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏∏‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∑‡πà‡∏ô ‡πÜ)', 'success');
  }

  async function submitAdminAddStop() {
    if (!ADMIN_USER_ID) {
      setPanelMessage('addMessage', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô LINE', 'error');
      await initLiff();
      return;
    }

    const reference = document.getElementById('addRef').value.trim();
    const shipToName = document.getElementById('addShipToName').value.trim();
    const shipToCode = document.getElementById('addShipToCode').value.trim();
    const lat = document.getElementById('addLat').value.trim();
    const lng = document.getElementById('addLng').value.trim();
    const radiusM = document.getElementById('addRadius').value.trim();

    if (!reference) {
      setPanelMessage('addMessage', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡πÄ‡∏•‡∏Ç Reference', 'error');
      return;
    }
    if (!shipToName) {
      setPanelMessage('addMessage', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏∏‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏° (shipToName) *', 'error');
      return;
    }

    if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡πâ Ref ${reference}\n‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏∏‡∏î: ${shipToName}`)) return;

    setLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Add Stop ...');
    setPanelMessage('addMessage', '');

    try {
      const base = getBaseUrl();

      // ‚úÖ ‡πÉ‡∏ä‡πâ form POST ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏ö CORS preflight
      const form = new URLSearchParams();
      form.append('action', 'adminAddStop');
      form.append('adminUserId', ADMIN_USER_ID);
      form.append('reference', reference);
      form.append('shipToName', shipToName);
      if (shipToCode) form.append('shipToCode', shipToCode);
      if (lat) form.append('lat', lat);
      if (lng) form.append('lng', lng);
      if (radiusM) form.append('radiusM', radiusM);

      const json = await fetchJson(base, {
        method: 'POST',
        body: form
      });
      if (!json.success) {
        setPanelMessage('addMessage', json.message || '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
        return;
      }

      setPanelMessage('addMessage', '‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');

      // refresh preview list
      await findReferenceForAddStop();

      // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ö‡∏≤‡∏á‡∏ü‡∏¥‡∏•‡∏î‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏á‡πà‡∏≤‡∏¢
      document.getElementById('addShipToName').value = '';
      document.getElementById('addShipToCode').value = '';
      document.getElementById('addLat').value = '';
      document.getElementById('addLng').value = '';
      // radius ‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ

    } catch (e) {
      console.error(e);
      setPanelMessage('addMessage', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Add Stop', 'error');
    } finally {
      setLoading(false);
    }
  }

  // =========================
  // Alcohol
  // =========================
  async function loadAlcohol() {
    if (!ADMIN_USER_ID) {
      setPanelMessage('alcMessage', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô LINE', 'error');
      await initLiff();
      return;
    }
    setPanelMessage('alcMessage', '');
    setLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î Alcohol ...');

    try {
      const ref = document.getElementById('alcRef').value.trim();
      const driver = document.getElementById('alcDriver').value.trim();
      const base = getBaseUrl();
      const qs = new URLSearchParams({
        action: 'adminalcohol',
        adminUserId: ADMIN_USER_ID,
        reference: ref,
        driver: driver,
        limit: '200'
      });
      const json = await fetchJson(`${base}?${qs.toString()}`);

      if (!json.success) {
        setPanelMessage('alcMessage', json.message || '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
        renderAlcohol([]);
        return;
      }

      renderAlcohol(json.rows || []);
      setPanelMessage('alcMessage', `‡∏û‡∏ö ${json.rows.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'success');
    } catch (e) {
      console.error(e);
      setPanelMessage('alcMessage', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î Alcohol', 'error');
      renderAlcohol([]);
    } finally {
      setLoading(false);
    }
  }

  function renderAlcohol(rows) {
    const tbody = document.getElementById('alcTableBody');
    tbody.replaceChildren();
    if (!rows || rows.length === 0) {
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 9;
      td.className = 'center';
      td.textContent = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }

    rows.forEach((r, idx) => {
      const tr = document.createElement('tr');
      const val = r.alcoholValue != null ? r.alcoholValue : '';
      appendTextCell(tr, idx + 1);
      appendTextCell(tr, r.reference || '');
      appendTextCell(tr, r.driverName || '');

      const alcTd = document.createElement('td');
      const input = document.createElement('input');
      input.type = 'number';
      input.step = '0.01';
      input.className = 'small-input alc-value-input';
      input.dataset.row = r.rowIndex;
      input.value = val;
      alcTd.appendChild(input);
      tr.appendChild(alcTd);

      appendTextCell(tr, r.checkedAt || '-');
      appendTextCell(tr, r.userId || '-');
      appendTextCell(tr, `${r.lat || '-'}, ${r.lng || '-'}`);

      const imgTd = document.createElement('td');
      if (r.imageUrl) {
        const a = document.createElement('a');
        a.href = r.imageUrl;
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
        a.textContent = '‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏π‡∏õ';
        imgTd.appendChild(a);
      } else {
        imgTd.textContent = '-';
      }
      tr.appendChild(imgTd);

      const actionsTd = document.createElement('td');
      actionsTd.className = 'actions';
      const btn = document.createElement('button');
      btn.className = 'btn-main';
      btn.dataset.row = r.rowIndex;
      btn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
      btn.addEventListener('click', () => onSaveAlcohol(btn));
      actionsTd.appendChild(btn);
      tr.appendChild(actionsTd);

      tbody.appendChild(tr);
    });
  }

  async function onSaveAlcohol(btn) {
    if (!ADMIN_USER_ID) {
      setPanelMessage('alcMessage', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô LINE', 'error');
      await initLiff();
      return;
    }
    const rowIndex = btn.getAttribute('data-row');
    const input = document.querySelector(`input.alc-value-input[data-row="${rowIndex}"]`);
    if (!input) return;
    const value = input.value.trim();
    if (value === '' || isNaN(parseFloat(value))) {
      alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
      return;
    }

    if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå row ${rowIndex} ‡πÄ‡∏õ‡πá‡∏ô ${value} ?`)) return;

    setLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤ Alcohol ...');
    try {
      const base = getBaseUrl();
      const form = new URLSearchParams();
      form.append('action', 'adminUpdateAlcohol');
      form.append('adminUserId', ADMIN_USER_ID);
      form.append('rowIndex', rowIndex);
      form.append('alcoholValue', value);

      const json = await fetchJson(base, { method: 'POST', body: form });

      if (!json.success) {
        setPanelMessage('alcMessage', json.message || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
      } else {
        setPanelMessage('alcMessage', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        await loadAlcohol();
      }
    } catch (e) {
      console.error(e);
      setPanelMessage('alcMessage', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', 'error');
    } finally {
      setLoading(false);
    }
  }

  // =========================
  // Userprofile
  // =========================
  async function loadUsers() {
    if (!ADMIN_USER_ID) {
      setPanelMessage('userMessage', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô LINE', 'error');
      await initLiff();
      return;
    }
    setPanelMessage('userMessage', '');
    setLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î User ...');

    try {
      const status = document.getElementById('userStatus').value.trim();
      const keyword = document.getElementById('userKeyword').value.trim();
      const base = getBaseUrl();
      const qs = new URLSearchParams({
        action: 'adminuserprofile',
        adminUserId: ADMIN_USER_ID,
        status: status,
        keyword: keyword
      });
      const json = await fetchJson(`${base}?${qs.toString()}`);

      if (!json.success) {
        setPanelMessage('userMessage', json.message || '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
        renderUsers([]);
        return;
      }

      renderUsers(json.rows || []);
      setPanelMessage('userMessage', `‡∏û‡∏ö ${json.rows.length} user`, 'success');
    } catch (e) {
      console.error(e);
      setPanelMessage('userMessage', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î User', 'error');
      renderUsers([]);
    } finally {
      setLoading(false);
    }
  }

  function renderUsers(rows) {
    const tbody = document.getElementById('userTableBody');
    tbody.replaceChildren();
    if (!rows || rows.length === 0) {
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 8;
      td.className = 'center';
      td.textContent = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }

    rows.forEach(r => {
      const tr = document.createElement('tr');
      const statusClass = (() => {
        const s = (r.status || '').toUpperCase();
        if (s === 'APPROVED') return 'status-pill done';
        if (s === 'PENDING') return 'status-pill new';
        if (s === 'REJECTED') return 'status-pill alert';
        return 'status-pill';
      })();

      const avatarTd = document.createElement('td');
      if (r.pictureUrl) {
        const img = document.createElement('img');
        img.src = r.pictureUrl;
        img.alt = '';
        img.style.width = '32px';
        img.style.height = '32px';
        img.style.borderRadius = '999px';
        img.style.objectFit = 'cover';
        avatarTd.appendChild(img);
      } else {
        const fallback = document.createElement('div');
        fallback.style.width = '32px';
        fallback.style.height = '32px';
        fallback.style.borderRadius = '999px';
        fallback.style.background = '#e5e7eb';
        fallback.style.display = 'flex';
        fallback.style.alignItems = 'center';
        fallback.style.justifyContent = 'center';
        fallback.style.fontSize = '0.7rem';
        fallback.textContent = '?';
        avatarTd.appendChild(fallback);
      }
      tr.appendChild(avatarTd);

      appendTextCell(tr, r.displayName || '-');
      const userTd = appendTextCell(tr, r.userId || '-');
      userTd.style.maxWidth = '220px';
      userTd.style.wordBreak = 'break-all';

      const statusTd = document.createElement('td');
      const select = document.createElement('select');
      select.className = 'user-status-select';
      select.dataset.user = r.userId;
      ['PENDING','APPROVED','REJECTED'].forEach(s => {
        const opt = document.createElement('option');
        opt.value = s;
        opt.textContent = s;
        if (s === r.status) opt.selected = true;
        select.appendChild(opt);
      });
      statusTd.appendChild(select);
      const statusWrap = document.createElement('div');
      statusWrap.style.marginTop = '2px';
      appendSpan(statusWrap, r.status || '', statusClass);
      statusTd.appendChild(statusWrap);
      tr.appendChild(statusTd);

      const typeTd = document.createElement('td');
      appendSpan(typeTd, r.userType || '-', 'tag');
      tr.appendChild(typeTd);

      appendTextCell(tr, r.createdAt || '-');
      appendTextCell(tr, r.updatedAt || '-');

      const actionsTd = document.createElement('td');
      actionsTd.className = 'actions';
      const btn = document.createElement('button');
      btn.className = 'btn-main';
      btn.dataset.user = r.userId;
      btn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
      btn.addEventListener('click', () => onSaveUserStatus(btn));
      actionsTd.appendChild(btn);
      tr.appendChild(actionsTd);

      tbody.appendChild(tr);
    });
  }

  async function onSaveUserStatus(btn) {
    if (!ADMIN_USER_ID) {
      setPanelMessage('userMessage', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô LINE', 'error');
      await initLiff();
      return;
    }
    const userId = btn.getAttribute('data-user');
    const select = document.querySelector(`select.user-status-select[data-user="${userId}"]`);
    if (!select) return;
    const newStatus = select.value;

    if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ\n${userId}\n‡πÄ‡∏õ‡πá‡∏ô ${newStatus} ?`)) return;

    setLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ User ...');
    try {
      const base = getBaseUrl();
      const form = new URLSearchParams();
      form.append('action', 'updateUserStatus');
      form.append('adminUserId', ADMIN_USER_ID);
      form.append('userId', userId);
      form.append('status', newStatus);

      const json = await fetchJson(base, { method: 'POST', body: form });

      if (!json.success) {
        setPanelMessage('userMessage', json.message || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
      } else {
        setPanelMessage('userMessage', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        await loadUsers();
      }
    } catch (e) {
      console.error(e);
      setPanelMessage('userMessage', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', 'error');
    } finally {
      setLoading(false);
    }
  }

  // -------- Init ---------
  document.addEventListener('DOMContentLoaded', () => {
    initTabs();

    document.getElementById('btnLoadJob').addEventListener('click', loadJobdata);
    document.getElementById('btnLoadAlcohol').addEventListener('click', loadAlcohol);
    document.getElementById('btnLoadUsers').addEventListener('click', loadUsers);

    // ‚úÖ Login
    document.getElementById('btnCheckAdmin').addEventListener('click', handleManualLogin);
    document.getElementById('btnLogout').addEventListener('click', handleLogout);

    // Enter to login
    document.getElementById('userIdInput').addEventListener('keydown', (ev) => {
      if (ev.key === 'Enter') handleManualLogin();
    });

    // ‚úÖ AddStop
    document.getElementById('btnFindRef').addEventListener('click', findReferenceForAddStop);
    document.getElementById('btnPrefillFromJob').addEventListener('click', prefillAddStopForm);
    document.getElementById('btnAddStop').addEventListener('click', submitAdminAddStop);

    // enter to search
    document.getElementById('addRef').addEventListener('keydown', (ev) => {
      if (ev.key === 'Enter') findReferenceForAddStop();
    });

    initAdmin();
  });
</script>
</body>
</html>
