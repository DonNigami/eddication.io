<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>Admin Console - Driver Tracking</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --danger: #dc2626;
      --bg: #f4f4f5;
      --card-bg: #ffffff;
      --border: #e5e7eb;
      --text-main: #111827;
      --text-sub: #6b7280;
      --radius-lg: 12px;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--text-main);
    }

    .app {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      padding: 16px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
      border: 1px solid var(--border);
    }

    header {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 16px;
    }

    header h1 {
      font-size: 1.3rem;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    header h1 span.badge {
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: #e0f2fe;
      color: #0369a1;
    }

    header .sub {
      font-size: 0.85rem;
      color: var(--text-sub);
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: #eef2ff;
      color: #3730a3;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.8rem;
    }

    .pill.bad {
      background: #fee2e2;
      color: #b91c1c;
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 4px;
      overflow-x: auto;
    }

    .tab-btn {
      border: none;
      background: transparent;
      padding: 8px 12px;
      border-radius: 999px;
      font-size: 0.9rem;
      cursor: pointer;
      color: var(--text-sub);
      white-space: nowrap;
    }

    .tab-btn.active {
      background: #dbeafe;
      color: var(--primary-dark);
      font-weight: 600;
    }

    .tab-content {
      margin-top: 16px;
    }

    .tab-panel {
      display: none;
    }

    .tab-panel.active {
      display: block;
    }

    .filters {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 8px;
      margin-bottom: 10px;
      align-items: flex-end;
    }

    label {
      font-size: 0.8rem;
      color: var(--text-sub);
      display: block;
      margin-bottom: 2px;
    }

    input[type="text"],
    input[type="number"],
    select {
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 0.85rem;
    }

    button {
      font-size: 0.85rem;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      padding: 7px 14px;
    }

    .btn-main {
      background: var(--primary);
      color: white;
    }

    .btn-main:hover {
      background: var(--primary-dark);
    }

    .btn-ghost {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-sub);
    }

    .btn-danger {
      background: var(--danger);
      color: #fee2e2;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 0.8rem;
    }

    thead {
      background: #f9fafb;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    th, td {
      border-bottom: 1px solid var(--border);
      padding: 6px 8px;
      vertical-align: middle;
      text-align: left;
    }

    th {
      font-size: 0.78rem;
      color: var(--text-sub);
      font-weight: 600;
      white-space: nowrap;
    }

    tbody tr:hover {
      background: #f9fafb;
    }

    .status-pill {
      display: inline-flex;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
      background: #e5e7eb;
      color: #374151;
    }

    .status-pill.done {
      background: #dcfce7;
      color: #166534;
    }

    .status-pill.new {
      background: #e0f2fe;
      color: #075985;
    }

    .status-pill.reviewed {
      background: #fef3c7;
      color: #92400e;
    }

    .status-pill.alert {
      background: #fee2e2;
      color: #b91c1c;
    }

    .tag {
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 999px;
      background: #eef2ff;
      color: #3730a3;
    }

    .small-input {
      width: 80px;
    }

    .actions {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }

    .center {
      text-align: center;
    }

    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.12);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .loading-overlay.active {
      display: flex;
    }

    .loading-box {
      background: #ffffff;
      padding: 12px 16px;
      border-radius: 999px;
      box-shadow: 0 10px 40px rgba(15, 23, 42, 0.18);
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.9rem;
    }

    .spinner {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 2px solid #e5e7eb;
      border-top-color: var(--primary);
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .msg {
      font-size: 0.8rem;
      margin-top: 6px;
    }

    .msg.error {
      color: #b91c1c;
    }

    .msg.success {
      color: #15803d;
    }

    .scroll-wrapper {
      max-height: 55vh;
      overflow: auto;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: white;
    }

    @media (max-width: 768px) {
      .app {
        padding: 10px;
      }
      header h1 {
        font-size: 1.1rem;
      }
      .scroll-wrapper {
        max-height: 60vh;
      }
    }
  </style>
</head>
<body>
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-box">
    <div class="spinner"></div>
    <span id="loadingText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
  </div>
</div>

<div class="app">
  <div class="card">
    <header>
      <h1>
        Admin Console
        <span class="badge">Driver Tracking</span>
      </h1>
      <div class="sub">
        <span id="adminInfo">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE ...</span>
        <span id="adminRoleBadge" class="pill bad" style="display:none;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Admin</span>
        <span id="envBadge" class="pill">WebApp</span>
      </div>
      <div id="globalMessage" class="msg"></div>

      <div class="tabs">
        <button class="tab-btn active" data-tab="jobdata">üßæ Jobdata</button>
        <button class="tab-btn" data-tab="alcohol">üç∫ Alcohol Check</button>
        <button class="tab-btn" data-tab="userprofile">üë§ User Profile</button>
      </div>
    </header>

    <div class="tab-content">
      <!-- JOBDATA PANEL -->
      <div class="tab-panel active" id="tab-jobdata">
        <div class="filters">
          <div>
            <label>Reference</label>
            <input type="text" id="jobRef" placeholder="‡πÄ‡∏ä‡πà‡∏ô 12345" />
          </div>
          <div>
            <label>Status</label>
            <select id="jobStatus">
              <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
              <option value="NEW">NEW</option>
              <option value="CHECKIN">CHECKIN</option>
              <option value="CHECKOUT">CHECKOUT</option>
              <option value="REVIEWED">REVIEWED</option>
              <option value="JOB_DONE">JOB_DONE</option>
            </select>
          </div>
          <div>
            <label>&nbsp;</label>
            <button class="btn-main" id="btnLoadJob">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Jobdata</button>
          </div>
        </div>
        <div id="jobMessage" class="msg"></div>
        <div class="scroll-wrapper">
          <table>
            <thead>
            <tr>
              <th>#</th>
              <th>Ref</th>
              <th>Shipment</th>
              <th>‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</th>
              <th>Status</th>
              <th>Check-in</th>
              <th>Check-out</th>
              <th>ODO</th>
              <th>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÇ‡∏î‡∏¢</th>
              <th>‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</th>
              <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
            </tr>
            </thead>
            <tbody id="jobTableBody">
            <tr><td colspan="11" class="center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- ALCOHOL PANEL -->
      <div class="tab-panel" id="tab-alcohol">
        <div class="filters">
          <div>
            <label>Reference</label>
            <input type="text" id="alcRef" placeholder="‡πÄ‡∏ä‡πà‡∏ô 12345" />
          </div>
          <div>
            <label>‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö</label>
            <input type="text" id="alcDriver" placeholder="‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏ä‡∏∑‡πà‡∏≠" />
          </div>
          <div>
            <label>&nbsp;</label>
            <button class="btn-main" id="btnLoadAlcohol">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Alcohol</button>
          </div>
        </div>
        <div id="alcMessage" class="msg"></div>
        <div class="scroll-wrapper">
          <table>
            <thead>
            <tr>
              <th>#</th>
              <th>Ref</th>
              <th>‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö</th>
              <th>Alcohol</th>
              <th>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ</th>
              <th>User</th>
              <th>‡∏û‡∏¥‡∏Å‡∏±‡∏î</th>
              <th>‡∏£‡∏π‡∏õ</th>
              <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
            </tr>
            </thead>
            <tbody id="alcTableBody">
            <tr><td colspan="9" class="center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- USERPROFILE PANEL -->
      <div class="tab-panel" id="tab-userprofile">
        <div class="filters">
          <div>
            <label>Status</label>
            <select id="userStatus">
              <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
              <option value="PENDING">PENDING</option>
              <option value="APPROVED">APPROVED</option>
              <option value="REJECTED">REJECTED</option>
            </select>
          </div>
          <div>
            <label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ userId)</label>
            <input type="text" id="userKeyword" placeholder="‡∏ä‡∏∑‡πà‡∏≠ / userId" />
          </div>
          <div>
            <label>&nbsp;</label>
            <button class="btn-main" id="btnLoadUsers">‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
          </div>
        </div>
        <div id="userMessage" class="msg"></div>
        <div class="scroll-wrapper">
          <table>
            <thead>
            <tr>
              <th>‡∏£‡∏π‡∏õ</th>
              <th>‡∏ä‡∏∑‡πà‡∏≠</th>
              <th>userId</th>
              <th>Status</th>
              <th>Type</th>
              <th>‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠</th>
              <th>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
              <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
            </tr>
            </thead>
            <tbody id="userTableBody">
            <tr><td colspan="8" class="center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // üîß ‡πÉ‡∏™‡πà LIFF ID ‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡πá‡∏Å‡∏ï‡πå‡∏ô‡∏µ‡πâ
  const LIFF_ID = '2007705394-Lq3mMYKA';

  let ADMIN_USER_ID = null;
  let ADMIN_NAME = '';

  function getBaseUrl() {
    const url = new URL(window.location.href);
    return url.origin + url.pathname;
  }

  function setLoading(show, text) {
    const overlay = document.getElementById('loadingOverlay');
    const label = document.getElementById('loadingText');
    if (text) label.textContent = text;
    overlay.classList.toggle('active', !!show);
  }

  function setGlobalMessage(msg, type = '') {
    const el = document.getElementById('globalMessage');
    el.textContent = msg || '';
    el.className = 'msg' + (type ? ' ' + type : '');
  }

  function setPanelMessage(id, msg, type = '') {
    const el = document.getElementById(id);
    el.textContent = msg || '';
    el.className = 'msg' + (type ? ' ' + type : '');
  }

  function setAdminInfo(text) {
    const el = document.getElementById('adminInfo');
    el.textContent = text;
  }

  function showAdminBadge(isAdmin) {
    const badge = document.getElementById('adminRoleBadge');
    if (isAdmin) {
      badge.textContent = 'Admin ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
      badge.classList.remove('bad');
      badge.classList.add('pill');
      badge.style.display = 'inline-flex';
      badge.style.background = '#dcfce7';
      badge.style.color = '#166534';
    } else {
      badge.textContent = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Admin';
      badge.classList.add('bad');
      badge.style.display = 'inline-flex';
    }
  }

  // -------- Tabs ---------
  function initTabs() {
    const buttons = document.querySelectorAll('.tab-btn');
    buttons.forEach(btn => {
      btn.addEventListener('click', () => {
        const tab = btn.getAttribute('data-tab');
        buttons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.tab-panel').forEach(p => {
          p.classList.toggle('active', p.id === 'tab-' + tab);
        });
      });
    });
  }

  // -------- LIFF / Auth ---------
  async function initLiff() {
    if (!LIFF_ID || LIFF_ID === '2007705394-Lq3mMYKA') {
      setAdminInfo('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ LIFF_ID ‡πÉ‡∏ô admin.html ‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
      setGlobalMessage('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ LIFF ID', 'error');
      return;
    }

    try {
      setLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE ...');
      await liff.init({ liffId: LIFF_ID });

      if (!liff.isLoggedIn()) {
        liff.login();
        return;
      }

      let userId = null;
      let displayName = '';

      try {
        const decoded = liff.getDecodedIDToken();
        if (decoded && decoded.sub) {
          userId = decoded.sub;
        }
      } catch (e) {
        console.log('getDecodedIDToken error', e);
      }

      const profile = await liff.getProfile();
      if (!userId && profile && profile.userId) {
        userId = profile.userId;
      }
      displayName = profile.displayName || '';

      ADMIN_USER_ID = userId;
      ADMIN_NAME = displayName;

      setAdminInfo(`‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö: ${displayName} (${userId})`);

      await checkAdminPermission(userId);
    } catch (err) {
      console.error(err);
      setAdminInfo('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE/LIFF ‡πÑ‡∏î‡πâ');
      setGlobalMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LIFF', 'error');
    } finally {
      setLoading(false);
    }
  }

  async function checkAdminPermission(userId) {
    if (!userId) {
      setGlobalMessage('‡πÑ‡∏°‡πà‡∏û‡∏ö userId ‡∏à‡∏≤‡∏Å LINE', 'error');
      showAdminBadge(false);
      return;
    }
    setLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Admin ...');
    try {
      const base = getBaseUrl();
      const url = `${base}?action=checkadmin&userId=${encodeURIComponent(userId)}`;
      const res = await fetch(url);
      const json = await res.json();

      if (!json.success || !json.isAdmin) {
        showAdminBadge(false);
        setGlobalMessage('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Admin ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•', 'error');
      } else {
        showAdminBadge(true);
        setGlobalMessage('‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤ Admin', 'success');
      }
    } catch (e) {
      console.error(e);
      setGlobalMessage('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
      showAdminBadge(false);
    } finally {
      setLoading(false);
    }
  }

  // -------- Jobdata ---------
  async function loadJobdata() {
    if (!ADMIN_USER_ID) {
      setPanelMessage('jobMessage', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô LINE', 'error');
      return;
    }
    setPanelMessage('jobMessage', '');
    setLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î Jobdata ...');

    try {
      const ref = document.getElementById('jobRef').value.trim();
      const status = document.getElementById('jobStatus').value.trim();
      const base = getBaseUrl();
      const qs = new URLSearchParams({
        action: 'adminjobdata',
        adminUserId: ADMIN_USER_ID,
        reference: ref,
        status: status,
        limit: '200'
      });
      const res = await fetch(`${base}?${qs.toString()}`);
      const json = await res.json();

      if (!json.success) {
        setPanelMessage('jobMessage', json.message || '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
        renderJobdata([]);
        return;
      }

      renderJobdata(json.rows || []);
      setPanelMessage('jobMessage', `‡∏û‡∏ö ${json.rows.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'success');
    } catch (e) {
      console.error(e);
      setPanelMessage('jobMessage', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î Jobdata', 'error');
      renderJobdata([]);
    } finally {
      setLoading(false);
    }
  }

  function renderJobdata(rows) {
    const tbody = document.getElementById('jobTableBody');
    tbody.innerHTML = '';
    if (!rows || rows.length === 0) {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="11" class="center">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td>`;
      tbody.appendChild(tr);
      return;
    }

    rows.forEach((r, idx) => {
      const tr = document.createElement('tr');

      const statusClass = (s => {
        s = (s || '').toUpperCase();
        if (s === 'JOB_DONE') return 'status-pill done';
        if (s === 'NEW') return 'status-pill new';
        if (s === 'REVIEWED') return 'status-pill reviewed';
        if (s === 'CHECKIN') return 'status-pill alert';
        return 'status-pill';
      })(r.status);

      tr.innerHTML = `
        <td>${idx + 1}</td>
        <td>${r.referenceNo || ''}</td>
        <td>${r.shipmentNo || ''}</td>
        <td>
          <div>${r.destination2 || ''}</div>
          <div class="tag">${r.destination1 || '-'}</div>
        </td>
        <td>
          <select data-row="${r.rowIndex}" class="job-status-select">
            ${['NEW','CHECKIN','CHECKOUT','REVIEWED','JOB_DONE'].map(s => `
              <option value="${s}" ${s === r.status ? 'selected' : ''}>${s}</option>
            `).join('')}
          </select>
          <div style="margin-top:2px;"><span class="${statusClass}">${r.status}</span></div>
        </td>
        <td>${r.checkInTime || '-'}</td>
        <td>${r.checkOutTime || '-'}</td>
        <td>${r.checkInOdo || '-'}</td>
        <td>${r.updatedBy || '-'}</td>
        <td>${r.updatedAt || '-'}</td>
        <td class="actions">
          <button class="btn-main" data-row="${r.rowIndex}" onclick="onSaveJobStatus(this)">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  async function onSaveJobStatus(btn) {
    if (!ADMIN_USER_ID) {
      setPanelMessage('jobMessage', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô LINE', 'error');
      return;
    }
    const rowIndex = btn.getAttribute('data-row');
    const select = document.querySelector(`select.job-status-select[data-row="${rowIndex}"]`);
    if (!select) return;
    const newStatus = select.value;

    if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ row ${rowIndex} ‡πÄ‡∏õ‡πá‡∏ô ${newStatus} ?`)) return;

    setLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Job ...');
    try {
      const base = getBaseUrl();
      const payload = {
        action: 'adminUpdateJob',
        adminUserId: ADMIN_USER_ID,
        rowIndex: rowIndex,
        status: newStatus
      };
      const res = await fetch(base, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const json = await res.json();
      if (!json.success) {
        setPanelMessage('jobMessage', json.message || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
      } else {
        setPanelMessage('jobMessage', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        await loadJobdata();
      }
    } catch (e) {
      console.error(e);
      setPanelMessage('jobMessage', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', 'error');
    } finally {
      setLoading(false);
    }
  }

  // -------- Alcohol ---------
  async function loadAlcohol() {
    if (!ADMIN_USER_ID) {
      setPanelMessage('alcMessage', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô LINE', 'error');
      return;
    }
    setPanelMessage('alcMessage', '');
    setLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î Alcohol ...');

    try {
      const ref = document.getElementById('alcRef').value.trim();
      const driver = document.getElementById('alcDriver').value.trim();
      const base = getBaseUrl();
      const qs = new URLSearchParams({
        action: 'adminalcohol',
        adminUserId: ADMIN_USER_ID,
        reference: ref,
        driver: driver,
        limit: '200'
      });
      const res = await fetch(`${base}?${qs.toString()}`);
      const json = await res.json();

      if (!json.success) {
        setPanelMessage('alcMessage', json.message || '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
        renderAlcohol([]);
        return;
      }

      renderAlcohol(json.rows || []);
      setPanelMessage('alcMessage', `‡∏û‡∏ö ${json.rows.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'success');
    } catch (e) {
      console.error(e);
      setPanelMessage('alcMessage', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î Alcohol', 'error');
      renderAlcohol([]);
    } finally {
      setLoading(false);
    }
  }

  function renderAlcohol(rows) {
    const tbody = document.getElementById('alcTableBody');
    tbody.innerHTML = '';
    if (!rows || rows.length === 0) {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="9" class="center">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td>`;
      tbody.appendChild(tr);
      return;
    }

    rows.forEach((r, idx) => {
      const tr = document.createElement('tr');
      const val = r.alcoholValue != null ? r.alcoholValue : '';
      tr.innerHTML = `
        <td>${idx + 1}</td>
        <td>${r.reference || ''}</td>
        <td>${r.driverName || ''}</td>
        <td>
          <input type="number" step="0.01" class="small-input alc-value-input"
                 data-row="${r.rowIndex}" value="${val}" />
        </td>
        <td>${r.checkedAt || '-'}</td>
        <td>${r.userId || '-'}</td>
        <td>${r.lat || '-'}, ${r.lng || '-'}</td>
        <td>
          ${r.imageUrl ? `<a href="${r.imageUrl}" target="_blank">‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏π‡∏õ</a>` : '-'}
        </td>
        <td class="actions">
          <button class="btn-main" data-row="${r.rowIndex}" onclick="onSaveAlcohol(this)">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  async function onSaveAlcohol(btn) {
    if (!ADMIN_USER_ID) {
      setPanelMessage('alcMessage', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô LINE', 'error');
      return;
    }
    const rowIndex = btn.getAttribute('data-row');
    const input = document.querySelector(`input.alc-value-input[data-row="${rowIndex}"]`);
    if (!input) return;
    const value = input.value.trim();
    if (value === '' || isNaN(parseFloat(value))) {
      alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
      return;
    }

    if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå row ${rowIndex} ‡πÄ‡∏õ‡πá‡∏ô ${value} ?`)) return;

    setLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤ Alcohol ...');
    try {
      const base = getBaseUrl();
      const payload = {
        action: 'adminUpdateAlcohol',
        adminUserId: ADMIN_USER_ID,
        rowIndex: rowIndex,
        alcoholValue: value
      };
      const res = await fetch(base, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const json = await res.json();
      if (!json.success) {
        setPanelMessage('alcMessage', json.message || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
      } else {
        setPanelMessage('alcMessage', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        await loadAlcohol();
      }
    } catch (e) {
      console.error(e);
      setPanelMessage('alcMessage', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', 'error');
    } finally {
      setLoading(false);
    }
  }

  // -------- Userprofile ---------
  async function loadUsers() {
    if (!ADMIN_USER_ID) {
      setPanelMessage('userMessage', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô LINE', 'error');
      return;
    }
    setPanelMessage('userMessage', '');
    setLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î User ...');

    try {
      const status = document.getElementById('userStatus').value.trim();
      const keyword = document.getElementById('userKeyword').value.trim();
      const base = getBaseUrl();
      const qs = new URLSearchParams({
        action: 'adminuserprofile',
        adminUserId: ADMIN_USER_ID,
        status: status,
        keyword: keyword
      });
      const res = await fetch(`${base}?${qs.toString()}`);
      const json = await res.json();

      if (!json.success) {
        setPanelMessage('userMessage', json.message || '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
        renderUsers([]);
        return;
      }

      renderUsers(json.rows || []);
      setPanelMessage('userMessage', `‡∏û‡∏ö ${json.rows.length} user`, 'success');
    } catch (e) {
      console.error(e);
      setPanelMessage('userMessage', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î User', 'error');
      renderUsers([]);
    } finally {
      setLoading(false);
    }
  }

  function renderUsers(rows) {
    const tbody = document.getElementById('userTableBody');
    tbody.innerHTML = '';
    if (!rows || rows.length === 0) {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="8" class="center">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td>`;
      tbody.appendChild(tr);
      return;
    }

    rows.forEach(r => {
      const tr = document.createElement('tr');
      const statusClass = (() => {
        const s = (r.status || '').toUpperCase();
        if (s === 'APPROVED') return 'status-pill done';
        if (s === 'PENDING') return 'status-pill new';
        if (s === 'REJECTED') return 'status-pill alert';
        return 'status-pill';
      })();

      tr.innerHTML = `
        <td>
          ${r.pictureUrl
            ? `<img src="${r.pictureUrl}" alt="" style="width:32px;height:32px;border-radius:999px;object-fit:cover;" />`
            : `<div style="width:32px;height:32px;border-radius:999px;background:#e5e7eb;display:flex;align-items:center;justify-content:center;font-size:0.7rem;">?</div>`
          }
        </td>
        <td>${r.displayName || '-'}</td>
        <td style="max-width:220px;word-break:break-all;">${r.userId || '-'}</td>
        <td>
          <select class="user-status-select" data-user="${r.userId}">
            ${['PENDING','APPROVED','REJECTED'].map(s => `
              <option value="${s}" ${s === r.status ? 'selected' : ''}>${s}</option>
            `).join('')}
          </select>
          <div style="margin-top:2px;"><span class="${statusClass}">${r.status}</span></div>
        </td>
        <td><span class="tag">${r.userType || '-'}</span></td>
        <td>${r.createdAt || '-'}</td>
        <td>${r.updatedAt || '-'}</td>
        <td class="actions">
          <button class="btn-main" data-user="${r.userId}" onclick="onSaveUserStatus(this)">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  async function onSaveUserStatus(btn) {
    if (!ADMIN_USER_ID) {
      setPanelMessage('userMessage', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô LINE', 'error');
      return;
    }
    const userId = btn.getAttribute('data-user');
    const select = document.querySelector(`select.user-status-select[data-user="${userId}"]`);
    if (!select) return;
    const newStatus = select.value;

    if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ\n${userId}\n‡πÄ‡∏õ‡πá‡∏ô ${newStatus} ?`)) return;

    setLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ User ...');
    try {
      const base = getBaseUrl();
      const payload = {
        action: 'updateUserStatus',
        adminUserId: ADMIN_USER_ID,
        userId: userId,
        status: newStatus
      };
      const res = await fetch(base, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const json = await res.json();
      if (!json.success) {
        setPanelMessage('userMessage', json.message || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
      } else {
        setPanelMessage('userMessage', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        await loadUsers();
      }
    } catch (e) {
      console.error(e);
      setPanelMessage('userMessage', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', 'error');
    } finally {
      setLoading(false);
    }
  }

  // -------- Init ---------
  document.addEventListener('DOMContentLoaded', () => {
    initTabs();

    document.getElementById('btnLoadJob').addEventListener('click', loadJobdata);
    document.getElementById('btnLoadAlcohol').addEventListener('click', loadAlcohol);
    document.getElementById('btnLoadUsers').addEventListener('click', loadUsers);

    initLiff();
  });
</script>
</body>
</html>
