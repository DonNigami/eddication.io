<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>Admin Console - Driver Tracking</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- SweetAlert2 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö popup ‡∏™‡∏ß‡∏¢ ‡πÜ (‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á http/https) -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --bg: #f3f4f6;
      --card-bg: #ffffff;
      --text-main: #111827;
      --text-muted: #6b7280;
      --border: #e5e7eb;
      --danger: #dc2626;
      --success: #16a34a;
      --warning: #f97316;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text-main);
    }

    .layout {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
    }

    header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      gap: 8px;
    }

    header h1 {
      margin: 0;
      font-size: 1.4rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    header h1 span.logo {
      display: inline-flex;
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background: var(--primary);
      color: white;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1rem;
    }

    header .subtitle {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .tabs {
      display: flex;
      gap: 8px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 16px;
      overflow-x: auto;
      padding-bottom: 4px;
    }

    .tab-button {
      border: none;
      background: transparent;
      padding: 8px 14px;
      border-radius: 999px;
      font-size: 0.9rem;
      cursor: pointer;
      color: var(--text-muted);
      white-space: nowrap;
    }

    .tab-button.active {
      background: var(--primary);
      color: #ffffff;
      box-shadow: 0 2px 6px rgba(37, 99, 235, 0.35);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(15, 23, 42, 0.06);
      margin-bottom: 18px;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 12px;
    }

    .card-header h2 {
      margin: 0;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .pill {
      font-size: 0.7rem;
      border-radius: 999px;
      padding: 2px 8px;
      background: #eff6ff;
      color: #1d4ed8;
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }

    .filters label {
      font-size: 0.8rem;
      color: var(--text-muted);
      display: block;
      margin-bottom: 4px;
    }

    .filters .field {
      min-width: 150px;
      flex: 1;
    }

    .filters input,
    .filters select {
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 0.85rem;
      outline: none;
    }

    .filters input:focus,
    .filters select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.25);
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 8px 14px;
      font-size: 0.85rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .btn-primary {
      background: var(--primary);
      color: #ffffff;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
    }

    .btn-outline {
      background: transparent;
      color: var(--text-main);
      border: 1px solid var(--border);
    }

    .btn-danger {
      background: var(--danger);
      color: #ffffff;
    }

    .btn-success {
      background: var(--success);
      color: #ffffff;
    }

    .btn-warning {
      background: var(--warning);
      color: #ffffff;
    }

    .btn-sm {
      padding: 4px 8px;
      font-size: 0.75rem;
      border-radius: 999px;
    }

    .table-wrapper {
      width: 100%;
      overflow-x: auto;
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
      background: #ffffff;
    }

    table thead {
      background: #f9fafb;
    }

    table th,
    table td {
      padding: 8px 10px;
      border-bottom: 1px solid var(--border);
      text-align: left;
      vertical-align: middle;
    }

    table th {
      font-weight: 600;
      color: var(--text-muted);
      white-space: nowrap;
    }

    table tbody tr:nth-child(even) {
      background: #f9fafb;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
    }

    .badge-status-new {
      background: #ecfeff;
      color: #0369a1;
    }

    .badge-status-checkin {
      background: #eef2ff;
      color: #4f46e5;
    }

    .badge-status-checkout {
      background: #ecfdf3;
      color: #15803d;
    }

    .badge-status-reviewed {
      background: #fefce8;
      color: #854d0e;
    }

    .badge-status-jobdone {
      background: #f1f5f9;
      color: #0f172a;
    }

    .text-muted {
      color: var(--text-muted);
      font-size: 0.78rem;
    }

    .status-pill {
      border-radius: 999px;
      padding: 3px 10px;
      font-size: 0.72rem;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .status-pending {
      background: #fef9c3;
      color: #854d0e;
    }

    .status-approved {
      background: #dcfce7;
      color: #166534;
    }

    .status-rejected {
      background: #fee2e2;
      color: #b91c1c;
    }

    .toolbar-right {
      display: flex;
      gap: 6px;
      align-items: center;
      flex-wrap: wrap;
    }

    .loading-indicator {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .loading-indicator span.dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--primary);
      animation: pulse 1s infinite ease-in-out;
    }

    @keyframes pulse {
      0% {
        transform: scale(1);
        opacity: 0.4;
      }
      50% {
        transform: scale(1.4);
        opacity: 1;
      }
      100% {
        transform: scale(1);
        opacity: 0.4;
      }
    }

    @media (max-width: 768px) {
      header {
        align-items: flex-start;
      }

      .filters {
        flex-direction: column;
      }

      .toolbar-right {
        justify-content: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="layout">
    <header>
      <div>
        <h1>
          <span class="logo">AD</span>
          Admin Console - Driver Tracking
        </h1>
        <div class="subtitle">
          ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• jobdata, alcoholcheck ‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏≠‡∏õ‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö
        </div>
      </div>
      <div class="text-muted">
        Web App URL: <code><?= ScriptApp.getService().getUrl() ?></code>
      </div>
    </header>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-button active" data-tab="jobdata">
        üöö Jobdata
      </button>
      <button class="tab-button" data-tab="alcohol">
        üç∫ Alcohol Check
      </button>
      <button class="tab-button" data-tab="userprofile">
        üë§ Approve User
      </button>
    </div>

    <!-- TAB: JOBDATA -->
    <section id="tab-jobdata" class="tab-content active">
      <div class="card">
        <div class="card-header">
          <h2>
            üöö Jobdata
            <span class="pill">‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô & ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</span>
          </h2>
          <div class="toolbar-right">
            <span id="jobdataLoading" class="loading-indicator" style="display:none;">
              <span class="dot"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...
            </span>
            <button class="btn btn-outline btn-sm" type="button" onclick="resetJobdataFilter()">
              ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á
            </button>
            <button class="btn btn-primary btn-sm" type="button" onclick="loadJobdata()">
              ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            </button>
          </div>
        </div>

        <div class="filters">
          <div class="field">
            <label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Reference</label>
            <input type="text" id="jobRef" placeholder="‡πÄ‡∏ä‡πà‡∏ô 2400XXXXX" />
          </div>
          <div class="field">
            <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô</label>
            <select id="jobStatus">
              <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
              <option value="NEW">NEW</option>
              <option value="CHECKIN">CHECKIN</option>
              <option value="CHECKOUT">CHECKOUT</option>
              <option value="REVIEWED">REVIEWED</option>
              <option value="JOB_DONE">JOB_DONE</option>
            </select>
          </div>
          <div class="field">
            <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ñ‡∏ß (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</label>
            <select id="jobLimit">
              <option value="50">50</option>
              <option value="100" selected>100</option>
              <option value="200">200</option>
            </select>
          </div>
        </div>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Reference</th>
                <th>Shipment</th>
                <th>‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</th>
                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                <th>Check-in</th>
                <th>Check-out</th>
                <th>‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå</th>
                <th>Updated by</th>
                <th>Updated at</th>
              </tr>
            </thead>
            <tbody id="jobdataTableBody">
              <tr>
                <td colspan="10" class="text-muted">
                  ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- TAB: ALCOHOL -->
    <section id="tab-alcohol" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h2>
            üç∫ Alcohol Check
            <span class="pill">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå</span>
          </h2>
          <div class="toolbar-right">
            <span id="alcoholLoading" class="loading-indicator" style="display:none;">
              <span class="dot"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...
            </span>
            <button class="btn btn-outline btn-sm" type="button" onclick="resetAlcoholFilter()">
              ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á
            </button>
            <button class="btn btn-primary btn-sm" type="button" onclick="loadAlcohol()">
              ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            </button>
          </div>
        </div>

        <div class="filters">
          <div class="field">
            <label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Reference</label>
            <input type="text" id="alcRef" placeholder="‡πÄ‡∏ä‡πà‡∏ô 2400XXXXX" />
          </div>
          <div class="field">
            <label>‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö</label>
            <input type="text" id="alcDriver" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏ä‡∏∑‡πà‡∏≠" />
          </div>
          <div class="field">
            <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ñ‡∏ß (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</label>
            <select id="alcLimit">
              <option value="50">50</option>
              <option value="100" selected>100</option>
              <option value="200">200</option>
            </select>
          </div>
        </div>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Reference</th>
                <th>‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö</th>
                <th>‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå</th>
                <th>‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡∏£‡∏ß‡∏à</th>
                <th>UserID</th>
                <th>‡∏û‡∏¥‡∏Å‡∏±‡∏î</th>
                <th>‡∏£‡∏π‡∏õ</th>
              </tr>
            </thead>
            <tbody id="alcoholTableBody">
              <tr>
                <td colspan="8" class="text-muted">
                  ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- TAB: USERPROFILE -->
    <section id="tab-userprofile" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h2>
            üë§ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (userprofile)
            <span class="pill">APPROVED / PENDING</span>
          </h2>
          <div class="toolbar-right">
            <span id="userLoading" class="loading-indicator" style="display:none;">
              <span class="dot"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...
            </span>
            <button class="btn btn-outline btn-sm" type="button" onclick="resetUserFilter()">
              ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á
            </button>
            <button class="btn btn-primary btn-sm" type="button" onclick="loadUserProfiles()">
              ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            </button>
          </div>
        </div>

        <div class="filters">
          <div class="field">
            <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
            <select id="userStatusFilter">
              <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
              <option value="PENDING" selected>PENDING</option>
              <option value="APPROVED">APPROVED</option>
              <option value="REJECTED">REJECTED</option>
            </select>
          </div>
          <div class="field">
            <label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠ / UserID</label>
            <input type="text" id="userKeyword" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠ userId" />
          </div>
        </div>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>UserID</th>
                <th>‡∏ä‡∏∑‡πà‡∏≠</th>
                <th>‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</th>
                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                <th>‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠</th>
                <th>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
                <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
              </tr>
            </thead>
            <tbody id="userTableBody">
              <tr>
                <td colspan="8" class="text-muted">
                  ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (PENDING) ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å ‡∏Å‡∏î "‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

  <script>
    // base URL ‡∏Ç‡∏≠‡∏á Web App (‡∏ù‡∏±‡∏á‡∏à‡∏≤‡∏Å Apps Script)
    const BASE_URL = 'https://script.google.com/macros/s/AKfycbxn8IxIhL9zdO1QMEyAZ8TThppvApILg7oyGdrPFeKU7L83ClgxxmTKz0bhj0u5ZJM/exec';

    // ---------- Helper UI ----------
    function showToast(title, text = "", icon = "success") {
      Swal.fire({
        title,
        text,
        icon,
        timer: 2000,
        showConfirmButton: false,
        toast: true,
        position: "top-end"
      });
    }

    function handleError(err, fallbackMsg = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î") {
      console.error(err);
      showToast("Error", fallbackMsg, "error");
    }

    // ---------- Tab switching ----------
    document.querySelectorAll(".tab-button").forEach((btn) => {
      btn.addEventListener("click", () => {
        document
          .querySelectorAll(".tab-button")
          .forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");

        const tabId = btn.dataset.tab;
        document
          .querySelectorAll(".tab-content")
          .forEach((c) => c.classList.remove("active"));
        document
          .getElementById(`tab-${tabId}`)
          .classList.add("active");
      });
    });

    // ---------- JOBDATA ----------
    async function loadJobdata() {
      const ref = document.getElementById("jobRef").value.trim();
      const status = document.getElementById("jobStatus").value.trim();
      const limit = document.getElementById("jobLimit").value || "100";

      const loadingEl = document.getElementById("jobdataLoading");
      const tbody = document.getElementById("jobdataTableBody");
      tbody.innerHTML = `
        <tr><td colspan="10" class="text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>
      `;
      loadingEl.style.display = "inline-flex";

      try {
        const params = new URLSearchParams({
          action: "adminJobdata",
          reference: ref,
          status,
          limit
        });

        const res = await fetch(`${BASE_URL}?${params.toString()}`);
        const json = await res.json();

        if (!json.success) {
          tbody.innerHTML = `
            <tr><td colspan="10" class="text-muted">${json.message || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ"}</td></tr>
          `;
          showToast("‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", json.message || "‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• jobdata ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "warning");
          return;
        }

        const rows = json.rows || [];
        if (!rows.length) {
          tbody.innerHTML = `
            <tr><td colspan="10" class="text-muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</td></tr>
          `;
          return;
        }

        tbody.innerHTML = "";
        rows.forEach((r, idx) => {
          const tr = document.createElement("tr");

          const statusClass = (() => {
            const s = (r.status || "").toUpperCase();
            if (s === "NEW") return "badge-status-new";
            if (s === "CHECKIN") return "badge-status-checkin";
            if (s === "CHECKOUT") return "badge-status-checkout";
            if (s === "REVIEWED") return "badge-status-reviewed";
            if (s === "JOB_DONE") return "badge-status-jobdone";
            return "";
          })();

          tr.innerHTML = `
            <td>${idx + 1}</td>
            <td>${r.referenceNo || ""}</td>
            <td>${r.shipmentNo || ""}</td>
            <td>
              <div>${r.destination2 || ""}</div>
              <div class="text-muted">${r.destination1 || ""}</div>
            </td>
            <td>
              <span class="badge ${statusClass}">
                ${r.status || "-"}
              </span>
            </td>
            <td>${r.checkInTime || ""}</td>
            <td>${r.checkOutTime || ""}</td>
            <td>${r.checkInOdo || ""}</td>
            <td>${r.updatedBy || ""}</td>
            <td>${r.updatedAt || ""}</td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        tbody.innerHTML = `
          <tr><td colspan="10" class="text-muted">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>
        `;
        handleError(err, "‡πÇ‡∏´‡∏•‡∏î jobdata ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      } finally {
        loadingEl.style.display = "none";
      }
    }

    function resetJobdataFilter() {
      document.getElementById("jobRef").value = "";
      document.getElementById("jobStatus").value = "";
      document.getElementById("jobLimit").value = "100";
    }

    // ---------- ALCOHOL ----------
    async function loadAlcohol() {
      const ref = document.getElementById("alcRef").value.trim();
      const driver = document.getElementById("alcDriver").value.trim();
      const limit = document.getElementById("alcLimit").value || "100";

      const loadingEl = document.getElementById("alcoholLoading");
      const tbody = document.getElementById("alcoholTableBody");
      tbody.innerHTML = `
        <tr><td colspan="8" class="text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>
      `;
      loadingEl.style.display = "inline-flex";

      try {
        const params = new URLSearchParams({
          action: "adminAlcohol",
          reference: ref,
          driver,
          limit
        });

        const res = await fetch(`${BASE_URL}?${params.toString()}`);
        const json = await res.json();

        if (!json.success) {
          tbody.innerHTML = `
            <tr><td colspan="8" class="text-muted">${json.message || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ"}</td></tr>
          `;
          showToast("‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", json.message || "‡πÇ‡∏´‡∏•‡∏î alcoholcheck ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "warning");
          return;
        }

        const rows = json.rows || [];
        if (!rows.length) {
          tbody.innerHTML = `
            <tr><td colspan="8" class="text-muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</td></tr>
          `;
          return;
        }

        tbody.innerHTML = "";
        rows.forEach((r, idx) => {
          const tr = document.createElement("tr");
          const alcVal = r.alcoholValue != null ? r.alcoholValue : "";
          const alcClass =
            alcVal !== "" && parseFloat(alcVal) > 0
              ? "color:" + (parseFloat(alcVal) > 50 ? "red" : "orange")
              : "color:#111827";

          tr.innerHTML = `
            <td>${idx + 1}</td>
            <td>${r.reference || ""}</td>
            <td>${r.driverName || ""}</td>
            <td style="${alcClass}">${alcVal}</td>
            <td>${r.checkedAt || ""}</td>
            <td>${r.userId || ""}</td>
            <td>
              <div class="text-muted">
                ${r.lat || "-"}, ${r.lng || "-"}
              </div>
            </td>
            <td>
              ${
                r.imageUrl
                  ? `<a href="${r.imageUrl}" target="_blank" class="btn btn-outline btn-sm">‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏π‡∏õ</a>`
                  : `<span class="text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ</span>`
              }
            </td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        tbody.innerHTML = `
          <tr><td colspan="8" class="text-muted">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>
        `;
        handleError(err, "‡πÇ‡∏´‡∏•‡∏î alcoholcheck ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      } finally {
        loadingEl.style.display = "none";
      }
    }

    function resetAlcoholFilter() {
      document.getElementById("alcRef").value = "";
      document.getElementById("alcDriver").value = "";
      document.getElementById("alcLimit").value = "100";
    }

    // ---------- USERPROFILE ----------
    async function loadUserProfiles() {
      const status = document.getElementById("userStatusFilter").value.trim();
      const keyword = document.getElementById("userKeyword").value.trim();

      const loadingEl = document.getElementById("userLoading");
      const tbody = document.getElementById("userTableBody");
      tbody.innerHTML = `
        <tr><td colspan="8" class="text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>
      `;
      loadingEl.style.display = "inline-flex";

      try {
        const params = new URLSearchParams({
          action: "adminUserprofile",
          status,
          keyword
        });

        const res = await fetch(`${BASE_URL}?${params.toString()}`);
        const json = await res.json();

        if (!json.success) {
          tbody.innerHTML = `
            <tr><td colspan="8" class="text-muted">${json.message || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ"}</td></tr>
          `;
          showToast("‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", json.message || "‡πÇ‡∏´‡∏•‡∏î userprofile ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "warning");
          return;
        }

        const rows = json.rows || [];
        if (!rows.length) {
          tbody.innerHTML = `
            <tr><td colspan="8" class="text-muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</td></tr>
          `;
          return;
        }

        tbody.innerHTML = "";
        rows.forEach((r, idx) => {
          const tr = document.createElement("tr");
          const statusUpper = (r.status || "").toUpperCase();

          let statusClass = "status-pending";
          if (statusUpper === "APPROVED") statusClass = "status-approved";
          else if (statusUpper === "REJECTED") statusClass = "status-rejected";

          tr.innerHTML = `
            <td>${idx + 1}</td>
            <td style="max-width:220px; word-break:break-all;">${r.userId || ""}</td>
            <td>${r.displayName || ""}</td>
            <td>
              ${
                r.pictureUrl
                  ? `<a href="${r.pictureUrl}" target="_blank" class="btn btn-outline btn-sm">‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏π‡∏õ</a>`
                  : `<span class="text-muted">-</span>`
              }
            </td>
            <td>
              <span class="status-pill ${statusClass}">
                ${statusUpper || "-"}
              </span>
            </td>
            <td>${r.createdAt || ""}</td>
            <td>${r.updatedAt || ""}</td>
            <td>
              <div style="display:flex; gap:4px; flex-wrap:wrap;">
                <button class="btn btn-success btn-sm" type="button"
                  onclick="changeUserStatus('${encodeURIComponent(
                    r.userId || ""
                  )}', 'APPROVED')">
                  ‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                </button>
                <button class="btn btn-warning btn-sm" type="button"
                  onclick="changeUserStatus('${encodeURIComponent(
                    r.userId || ""
                  )}', 'PENDING')">
                  ‚è≥ Pending
                </button>
                <button class="btn btn-danger btn-sm" type="button"
                  onclick="changeUserStatus('${encodeURIComponent(
                    r.userId || ""
                  )}', 'REJECTED')">
                  ‚ùå Reject
                </button>
              </div>
            </td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        tbody.innerHTML = `
          <tr><td colspan="8" class="text-muted">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>
        `;
        handleError(err, "‡πÇ‡∏´‡∏•‡∏î userprofile ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      } finally {
        loadingEl.style.display = "none";
      }
    }

    function resetUserFilter() {
      document.getElementById("userStatusFilter").value = "PENDING";
      document.getElementById("userKeyword").value = "";
    }

    async function changeUserStatus(encodedUserId, newStatus) {
      const userId = decodeURIComponent(encodedUserId || "");
      if (!userId) return;

      const confirmText =
        newStatus === "APPROVED"
          ? "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏≠‡∏õ‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?"
          : newStatus === "REJECTED"
          ? "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£ Reject ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?"
          : "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô PENDING ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?";

      const result = await Swal.fire({
        title: "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞",
        text: confirmText,
        icon: "question",
        showCancelButton: true,
        confirmButtonText: "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô",
        cancelButtonText: "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å"
      });

      if (!result.isConfirmed) return;

      try {
        const formData = new URLSearchParams();
        formData.append("action", "updateUserStatus");
        formData.append("userId", userId);
        formData.append("status", newStatus);

        const res = await fetch(BASE_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8"
          },
          body: formData.toString()
        });

        const json = await res.json();
        if (!json.success) {
          handleError(
            json.message || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏î‡πâ",
            "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"
          );
          return;
        }

        showToast("‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
        // reload list
        loadUserProfiles();
      } catch (err) {
        handleError(err, "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      }
    }

    // ‡πÇ‡∏´‡∏•‡∏î default: ‡πÅ‡∏ó‡πá‡∏ö userprofile (pending) ‡πÉ‡∏´‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡πá‡πÑ‡∏î‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ß‡πà‡∏≤‡∏á
    // ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏Å‡∏î‡πÄ‡∏≠‡∏á ‡∏à‡∏∞‡πÑ‡∏°‡πà auto ‡∏¢‡∏¥‡∏á query
  </script>
</body>
</html>
