<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>Admin Console - Driver Tracking</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg: #0f172a;
      --bg-soft: #111827;
      --card: #020617;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.15);
      --danger: #f97373;
      --success: #4ade80;
      --border: #1f2937;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --chip-bg: #111827;
      --tab-bg: #020617;
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background: radial-gradient(circle at top left,#1e293b 0,#020617 55%,#000 100%);
      color: var(--text-main);
    }
    .app {
      max-width: 1180px;
      margin: 0 auto;
      padding: 16px;
    }
    .card {
      background: linear-gradient(135deg,rgba(15,23,42,0.98),rgba(15,23,42,0.98));
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,0.15);
      box-shadow: 0 18px 40px rgba(15,23,42,0.9);
      padding: 18px 20px 20px;
    }
    .header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-bottom:14px;
    }
    .title-left {
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    h1 {
      font-size: 22px;
      margin: 0;
      letter-spacing: .02em;
    }
    .badge {
      font-size: 11px;
      padding: 4px 9px;
      border-radius:999px;
      background: rgba(15,23,42,0.9);
      border:1px solid rgba(148,163,184,.6);
      color: var(--text-muted);
    }
    .login-info {
      font-size: 12px;
      color: var(--text-muted);
    }
    .login-info strong {
      color: var(--text-main);
    }
    .status-row {
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:10px;
      margin-bottom:14px;
      font-size:13px;
    }
    .pill-ok {
      border-radius:999px;
      padding:4px 10px;
      background: rgba(34,197,94,0.12);
      color: var(--success);
      border:1px solid rgba(34,197,94,0.5);
      font-size: 11px;
    }
    .pill-bad {
      border-radius:999px;
      padding:4px 10px;
      background: rgba(248,113,113,0.1);
      color: var(--danger);
      border:1px solid rgba(248,113,113,0.4);
      font-size: 11px;
    }
    .chip-small {
      border-radius:999px;
      padding:2px 8px;
      font-size:11px;
      background:rgba(15,23,42,0.9);
      border:1px solid rgba(148,163,184,0.45);
      color:var(--text-muted);
    }
    .input-row {
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:4px;
    }
    input[type="text"],
    select {
      background: #020617;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.4);
      color: var(--text-main);
      padding: 6px 12px;
      font-size: 13px;
      min-width: 0;
    }
    input[type="text"]:focus,
    select:focus {
      outline:none;
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(56,189,248,0.4);
    }
    .btn {
      border-radius: 999px;
      border: 0;
      padding: 6px 14px;
      font-size: 13px;
      cursor: pointer;
      white-space: nowrap;
      display:inline-flex;
      align-items:center;
      gap:6px;
      background: linear-gradient(135deg,#38bdf8,#0ea5e9);
      color: #0b1120;
      font-weight: 600;
      box-shadow: 0 8px 20px rgba(56,189,248,0.45);
    }
    .btn:disabled {
      opacity:.6;
      cursor: default;
      box-shadow:none;
    }
    .btn-ghost {
      background: transparent;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.5);
      color: var(--text-muted);
      padding:5px 12px;
      font-size:12px;
    }
    .tabs {
      display:flex;
      gap:6px;
      margin-top:6px;
      margin-bottom:10px;
      border-bottom:1px solid rgba(31,41,55,0.8);
      padding-bottom:4px;
    }
    .tab {
      border-radius:999px;
      padding:5px 10px;
      font-size:12px;
      cursor:pointer;
      background:transparent;
      color:var(--text-muted);
      border:1px solid transparent;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .tab.active {
      background:rgba(15,23,42,0.9);
      border-color:rgba(148,163,184,0.7);
      color:var(--accent);
    }
    .tab span.icon {
      font-size:14px;
    }
    .section {
      margin-top:6px;
    }
    .hidden {
      display:none;
    }
    .filters {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      margin-bottom:10px;
      font-size:12px;
    }
    .table-wrap {
      border-radius:14px;
      border:1px solid rgba(31,41,55,0.9);
      overflow:auto;
      background:rgba(15,23,42,0.9);
    }
    table {
      width:100%;
      border-collapse:collapse;
      font-size:12px;
      min-width:880px;
    }
    thead {
      background:linear-gradient(90deg,rgba(15,23,42,1),rgba(15,23,42,0.95));
    }
    th,td {
      padding:6px 8px;
      border-bottom:1px solid rgba(31,41,55,0.9);
      text-align:left;
      white-space:nowrap;
    }
    th {
      font-weight:500;
      color:var(--text-muted);
    }
    tr:nth-child(even) td {
      background:rgba(15,23,42,0.85);
    }
    .status-chip {
      display:inline-flex;
      align-items:center;
      padding:2px 8px;
      border-radius:999px;
      font-size:11px;
      border:1px solid rgba(148,163,184,0.5);
      background:rgba(15,23,42,0.95);
    }
    .status-chip.NEW { color:#e5e7eb; }
    .status-chip.CHECKIN { color:#eab308; border-color:#eab30866; }
    .status-chip.CHECKOUT { color:#22c55e; border-color:#22c55e66; }
    .status-chip.REVIEWED { color:#38bdf8; border-color:#38bdf866; }
    .status-chip.JOB_DONE { color:#a855f7; border-color:#a855f766; }
    .small-muted {
      font-size:11px;
      color:var(--text-muted);
    }
    .error-bar {
      margin-top:4px;
      font-size:12px;
      color:var(--danger);
    }
    .ok-bar {
      margin-top:4px;
      font-size:12px;
      color:var(--success);
    }
    .tag {
      font-size:11px;
      padding:2px 6px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.5);
      color:var(--text-muted);
    }
    .btn-small {
      padding:4px 10px;
      font-size:11px;
      border-radius:999px;
      border:0;
      cursor:pointer;
      background:rgba(56,189,248,0.12);
      color:var(--accent);
    }
    .btn-small:disabled {
      opacity:.6;
      cursor:default;
    }
    .avatar {
      width:26px;
      height:26px;
      border-radius:999px;
      object-fit:cover;
      border:1px solid rgba(148,163,184,0.6);
    }
    @media (max-width:768px){
      .card { padding:14px 12px 16px; border-radius:16px; }
      h1 { font-size:19px; }
      .table-wrap { border-radius:12px; }
      table { font-size:11px; min-width:760px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <!-- Header -->
      <div class="header">
        <div class="title-left">
          <h1>Admin Console</h1>
          <span class="badge">Driver Tracking</span>
        </div>
        <div class="login-info">
          <span id="loginText">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö: -</span><br/>
          <span class="small-muted">WebApp</span>
        </div>
      </div>

      <!-- Admin status / userId input -->
      <div class="status-row">
        <span id="adminStatusBadge" class="pill-bad">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Admin</span>
        <span class="chip-small">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ó userprofile</span>
      </div>
      <div class="input-row">
        <span class="small-muted">LINE userId:</span>
        <input id="userIdInput" type="text" placeholder="‡πÉ‡∏™‡πà userId ‡∏Ç‡∏≠‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô" style="min-width:260px;" />
        <button id="btnCheckAdmin" class="btn">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Admin</button>
        <button id="btnReload" class="btn-ghost">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</button>
      </div>
      <div id="adminStatusMsg" class="small-muted" style="margin-top:4px;"></div>

      <!-- Tabs -->
      <div class="tabs">
        <button class="tab active" data-tab="jobdata">
          <span class="icon">üìÑ</span> Jobdata
        </button>
        <button class="tab" data-tab="alcohol">
          <span class="icon">üç∫</span> Alcohol Check
        </button>
        <button class="tab" data-tab="userprofile">
          <span class="icon">üë§</span> User Profile
        </button>
      </div>

      <!-- Section: Jobdata -->
      <div id="tab-jobdata" class="section">
        <div class="filters">
          <span class="small-muted">Reference:</span>
          <input id="refFilter" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô 29559" />
          <span class="small-muted">Status:</span>
          <select id="statusFilter">
            <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
            <option value="NEW">NEW</option>
            <option value="CHECKIN">CHECKIN</option>
            <option value="CHECKOUT">CHECKOUT</option>
            <option value="REVIEWED">REVIEWED</option>
            <option value="JOB_DONE">JOB_DONE</option>
          </select>
          <button id="btnLoadJobdata" class="btn">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Jobdata</button>
          <span id="jobdataSummary" class="small-muted"></span>
        </div>
        <div id="jobdataError" class="error-bar"></div>
        <div class="table-wrap" style="margin-top:4px;">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Ref</th>
                <th>Shipment</th>
                <th>‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</th>
                <th>Status</th>
                <th>Check-in</th>
                <th>Check-out</th>
                <th>ODO-in</th>
                <th>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏î‡∏¢</th>
                <th>‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</th>
                <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
              </tr>
            </thead>
            <tbody id="jobdataBody">
              <tr><td colspan="11" class="small-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Section: Alcohol -->
      <div id="tab-alcohol" class="section hidden">
        <div class="filters">
          <span class="small-muted">Reference:</span>
          <input id="alcRefFilter" type="text" />
          <span class="small-muted">‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö:</span>
          <input id="alcDriverFilter" type="text" />
          <button id="btnLoadAlcohol" class="btn">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Alcohol Check</button>
          <span id="alcSummary" class="small-muted"></span>
        </div>
        <div id="alcError" class="error-bar"></div>
        <div class="table-wrap" style="margin-top:4px;">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Ref</th>
                <th>Driver</th>
                <th>Alcohol</th>
                <th>‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡∏£‡∏ß‡∏à</th>
                <th>userId</th>
                <th>‡∏û‡∏¥‡∏Å‡∏±‡∏î</th>
                <th>‡∏£‡∏π‡∏õ</th>
                <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
              </tr>
            </thead>
            <tbody id="alcBody">
              <tr><td colspan="9" class="small-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Section: User Profile -->
      <div id="tab-userprofile" class="section hidden">
        <div class="filters">
          <span class="small-muted">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</span>
          <select id="userStatusFilter">
            <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
            <option value="PENDING">PENDING</option>
            <option value="APPROVED">APPROVED</option>
            <option value="BLOCKED">BLOCKED</option>
          </select>
          <span class="small-muted">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤:</span>
          <input id="userKeyword" type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏à‡∏≤‡∏Å userId / ‡∏ä‡∏∑‡πà‡∏≠" />
          <button id="btnLoadUsers" class="btn">‡πÇ‡∏´‡∏•‡∏î User Profile</button>
          <span id="userSummary" class="small-muted"></span>
        </div>
        <div id="userError" class="error-bar"></div>
        <div class="table-wrap" style="margin-top:4px;">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>User</th>
                <th>‡∏ä‡∏∑‡πà‡∏≠</th>
                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                <th>Role</th>
                <th>‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠</th>
                <th>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
                <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
              </tr>
            </thead>
            <tbody id="userBody">
              <tr><td colspan="8" class="small-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ‡πÉ‡∏ä‡πâ path ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ WebApp ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‚Üí ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ CORS
    const BASE_URL = window.location.origin + window.location.pathname;

    let adminUserId = '';
    let adminOk = false;

    function getJSON(url) {
      return fetch(url, { method: 'GET' }).then(r => r.json());
    }
    function postJSON(body) {
      return fetch(BASE_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      }).then(r => r.json());
    }

    function setAdminBadge(isAdmin, msg) {
      adminOk = !!isAdmin;
      const badge = document.getElementById('adminStatusBadge');
      const msgEl = document.getElementById('adminStatusMsg');
      if (isAdmin) {
        badge.className = 'pill-ok';
        badge.textContent = 'Admin ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
        msgEl.textContent = msg || '‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Jobdata, Alcohol ‡πÅ‡∏•‡∏∞ User Profile ‡πÑ‡∏î‡πâ';
      } else {
        badge.className = 'pill-bad';
        badge.textContent = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Admin';
        msgEl.textContent = msg || '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö userId ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡∏ä‡∏µ‡∏ó userprofile';
      }
    }

    async function checkAdmin() {
      adminUserId = document.getElementById('userIdInput').value.trim();
      if (!adminUserId) {
        setAdminBadge(false, '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà userId ‡∏Å‡πà‡∏≠‡∏ô');
        return;
      }
      document.getElementById('btnCheckAdmin').disabled = true;
      setAdminBadge(false, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå ...');
      try {
        const res = await getJSON(
          BASE_URL + '?action=checkadmin&userId=' + encodeURIComponent(adminUserId)
        );
        if (!res.success) {
          setAdminBadge(false, res.message || '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
          return;
        }
        setAdminBadge(res.isAdmin, res.isAdmin ? '' : 'user ‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô ADMIN ‡πÉ‡∏ô‡∏ä‡∏µ‡∏ó userprofile');
      } catch (e) {
        console.error(e);
        setAdminBadge(false, '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå');
      } finally {
        document.getElementById('btnCheckAdmin').disabled = false;
      }
    }

    // --- Tab handling ---
    function initTabs() {
      const tabs = document.querySelectorAll('.tab');
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          tabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          const tName = tab.getAttribute('data-tab');
          ['jobdata','alcohol','userprofile'].forEach(x => {
            const el = document.getElementById('tab-' + x);
            if (x === tName) el.classList.remove('hidden');
            else el.classList.add('hidden');
          });
        });
      });
    }

    // --- Jobdata ---
    async function loadJobdata() {
      if (!adminOk) {
        document.getElementById('jobdataError').textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Admin ‡∏Å‡πà‡∏≠‡∏ô';
        return;
      }
      document.getElementById('jobdataError').textContent = '';
      const ref = document.getElementById('refFilter').value.trim();
      const status = document.getElementById('statusFilter').value.trim();
      const url = BASE_URL
        + '?action=adminjobdata'
        + '&adminUserId=' + encodeURIComponent(adminUserId)
        + '&reference=' + encodeURIComponent(ref)
        + '&status=' + encodeURIComponent(status)
        + '&limit=200';
      try {
        const res = await getJSON(url);
        if (!res.success) {
          document.getElementById('jobdataError').textContent = res.message || '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
          return;
        }
        const rows = res.rows || [];
        document.getElementById('jobdataSummary').textContent = rows.length
          ? `‡∏û‡∏ö ${rows.length} ‡πÅ‡∏ñ‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î`
          : '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
        const body = document.getElementById('jobdataBody');
        body.innerHTML = '';
        if (!rows.length) {
          body.innerHTML = '<tr><td colspan="11" class="small-muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
          return;
        }
        rows.forEach((r, idx) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${idx + 1}</td>
            <td>${r.referenceNo || ''}</td>
            <td>${r.shipmentNo || ''}</td>
            <td>
              <div>${r.destination2 || ''}</div>
              <div class="small-muted">${r.destination1 || ''}</div>
            </td>
            <td>
              <span class="status-chip ${r.status || ''}">${r.status || '-'}</span>
            </td>
            <td>
              <div>${r.checkInTime || '-'}</div>
            </td>
            <td>
              <div>${r.checkOutTime || '-'}</div>
            </td>
            <td>${r.checkInOdo || ''}</td>
            <td>
              <div>${r.updatedBy || '-'}</div>
            </td>
            <td>
              <div>${r.updatedAt || '-'}</div>
            </td>
            <td>
              <select class="statusSelect">
                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</option>
                <option value="NEW"${r.status==='NEW'?' selected':''}>NEW</option>
                <option value="CHECKIN"${r.status==='CHECKIN'?' selected':''}>CHECKIN</option>
                <option value="CHECKOUT"${r.status==='CHECKOUT'?' selected':''}>CHECKOUT</option>
                <option value="REVIEWED"${r.status==='REVIEWED'?' selected':''}>REVIEWED</option>
                <option value="JOB_DONE"${r.status==='JOB_DONE'?' selected':''}>JOB_DONE</option>
              </select>
              <button class="btn-small" data-row="${r.rowIndex}">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </td>
          `;
          body.appendChild(tr);
        });

        // bind save buttons
        document.querySelectorAll('#jobdataBody .btn-small').forEach(btn => {
          btn.addEventListener('click', onSaveJobStatus);
        });
      } catch (e) {
        console.error(e);
        document.getElementById('jobdataError').textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
      }
    }

    async function onSaveJobStatus(ev) {
      const btn = ev.currentTarget;
      if (!adminOk) return;
      const tr = btn.closest('tr');
      const select = tr.querySelector('.statusSelect');
      const newStatus = select.value;
      if (!newStatus) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡∏°‡πà‡∏Å‡πà‡∏≠‡∏ô');
        return;
      }
      btn.disabled = true;
      btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
      try {
        const rowIndex = btn.getAttribute('data-row');
        const res = await postJSON({
          action: 'adminUpdateJob',
          adminUserId,
          rowIndex,
          status: newStatus
        });
        if (!res.success) {
          alert(res.message || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
          return;
        }
        const r = res.row;
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡πÅ‡∏ñ‡∏ß‡∏ô‡∏µ‡πâ
        tr.querySelector('.status-chip').textContent = r.status;
        tr.querySelector('.status-chip').className = 'status-chip ' + r.status;
        tr.children[8].innerHTML = `<div>${r.updatedBy || '-'}</div>`;
        tr.children[9].innerHTML = `<div>${r.updatedAt || '-'}</div>`;
      } catch (e) {
        console.error(e);
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
      } finally {
        btn.disabled = false;
        btn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
      }
    }

    // --- Alcohol ---
    async function loadAlcohol() {
      if (!adminOk) {
        document.getElementById('alcError').textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Admin ‡∏Å‡πà‡∏≠‡∏ô';
        return;
      }
      document.getElementById('alcError').textContent = '';
      const ref = document.getElementById('alcRefFilter').value.trim();
      const driver = document.getElementById('alcDriverFilter').value.trim();
      const url = BASE_URL
        + '?action=adminalcohol'
        + '&adminUserId=' + encodeURIComponent(adminUserId)
        + '&reference=' + encodeURIComponent(ref)
        + '&driver=' + encodeURIComponent(driver)
        + '&limit=200';
      try {
        const res = await getJSON(url);
        if (!res.success) {
          document.getElementById('alcError').textContent = res.message || '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
          return;
        }
        const rows = res.rows || [];
        document.getElementById('alcSummary').textContent = rows.length
          ? `‡∏û‡∏ö ${rows.length} ‡πÅ‡∏ñ‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î`
          : '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
        const body = document.getElementById('alcBody');
        body.innerHTML = '';
        if (!rows.length) {
          body.innerHTML = '<tr><td colspan="9" class="small-muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
          return;
        }
        rows.forEach((r, idx) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${idx + 1}</td>
            <td>${r.reference || ''}</td>
            <td>${r.driverName || ''}</td>
            <td>
              <input type="number" step="0.01" min="0" style="width:70px"
                     value="${r.alcoholValue != null ? r.alcoholValue : ''}" />
            </td>
            <td>${r.checkedAt || '-'}</td>
            <td>${r.userId || ''}</td>
            <td>
              <div class="small-muted">${r.lat || ''}, ${r.lng || ''}</div>
            </td>
            <td>
              ${r.imageUrl ? `<a href="${r.imageUrl}" target="_blank" class="tag">‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏π‡∏õ</a>` : '-'}
            </td>
            <td>
              <button class="btn-small" data-row="${r.rowIndex}">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </td>
          `;
          body.appendChild(tr);
        });
        document.querySelectorAll('#alcBody .btn-small').forEach(btn => {
          btn.addEventListener('click', onSaveAlcohol);
        });
      } catch (e) {
        console.error(e);
        document.getElementById('alcError').textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
      }
    }

    async function onSaveAlcohol(ev) {
      const btn = ev.currentTarget;
      const tr = btn.closest('tr');
      const input = tr.querySelector('input[type="number"]');
      const val = input.value.trim();
      if (!val) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå');
        return;
      }
      btn.disabled = true;
      btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
      try {
        const rowIndex = btn.getAttribute('data-row');
        const res = await postJSON({
          action: 'adminUpdateAlcohol',
          adminUserId,
          rowIndex,
          alcoholValue: val
        });
        if (!res.success) {
          alert(res.message || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
          return;
        }
        alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      } catch (e) {
        console.error(e);
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
      } finally {
        btn.disabled = false;
        btn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
      }
    }

    // --- User Profile ---
    async function loadUsers() {
      if (!adminOk) {
        document.getElementById('userError').textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Admin ‡∏Å‡πà‡∏≠‡∏ô';
        return;
      }
      document.getElementById('userError').textContent = '';
      const status = document.getElementById('userStatusFilter').value.trim();
      const keyword = document.getElementById('userKeyword').value.trim();
      const url = BASE_URL
        + '?action=adminuserprofile'
        + '&adminUserId=' + encodeURIComponent(adminUserId)
        + '&status=' + encodeURIComponent(status)
        + '&keyword=' + encodeURIComponent(keyword);
      try {
        const res = await getJSON(url);
        if (!res.success) {
          document.getElementById('userError').textContent = res.message || '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
          return;
        }
        const rows = res.rows || [];
        document.getElementById('userSummary').textContent = rows.length
          ? `‡∏û‡∏ö ${rows.length} ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ`
          : '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
        const body = document.getElementById('userBody');
        body.innerHTML = '';
        if (!rows.length) {
          body.innerHTML = '<tr><td colspan="8" class="small-muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
          return;
        }
        rows.forEach((r, idx) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${idx + 1}</td>
            <td>
              <div style="display:flex;align-items:center;gap:6px;">
                ${r.pictureUrl ? `<img src="${r.pictureUrl}" class="avatar" />` : ''}
                <div class="small-muted" style="max-width:220px;word-break:break-all;">${r.userId}</div>
              </div>
            </td>
            <td>${r.displayName || '-'}</td>
            <td>
              <select class="userStatusSelect">
                <option value="PENDING"${r.status==='PENDING'?' selected':''}>PENDING</option>
                <option value="APPROVED"${r.status==='APPROVED'?' selected':''}>APPROVED</option>
                <option value="BLOCKED"${r.status==='BLOCKED'?' selected':''}>BLOCKED</option>
              </select>
            </td>
            <td>${r.userType || '-'}</td>
            <td>${r.createdAt || '-'}</td>
            <td>${r.updatedAt || '-'}</td>
            <td>
              <button class="btn-small" data-user="${r.userId}">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </td>
          `;
          body.appendChild(tr);
        });
        document.querySelectorAll('#userBody .btn-small').forEach(btn => {
          btn.addEventListener('click', onSaveUserStatus);
        });
      } catch (e) {
        console.error(e);
        document.getElementById('userError').textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
      }
    }

    async function onSaveUserStatus(ev) {
      const btn = ev.currentTarget;
      const tr = btn.closest('tr');
      const select = tr.querySelector('.userStatusSelect');
      const newStatus = select.value;
      const targetUserId = btn.getAttribute('data-user');
      btn.disabled = true;
      btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
      try {
        const res = await postJSON({
          action: 'updateUserStatus',
          adminUserId,
          userId: targetUserId,
          status: newStatus
        });
        if (!res.success) {
          alert(res.message || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
          return;
        }
        alert('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      } catch (e) {
        console.error(e);
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
      } finally {
        btn.disabled = false;
        btn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
      }
    }

    // --- Initial setup ---
    function initFromQuery() {
      const params = new URLSearchParams(window.location.search);
      const uid = params.get('userId') || '';
      const name = params.get('name') || params.get('displayName') || '';
      if (uid) {
        adminUserId = uid;
        document.getElementById('userIdInput').value = uid;
        const txt = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö: ' + (name || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠') + ' (' + uid + ')';
        document.getElementById('loginText').textContent = txt;
      } else {
        document.getElementById('loginText').textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö: - (‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á userId ‡∏°‡∏≤‡∏î‡πâ‡∏ß‡∏¢)';
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      initFromQuery();
      initTabs();

      document.getElementById('btnCheckAdmin').addEventListener('click', checkAdmin);
      document.getElementById('btnReload').addEventListener('click', () => {
        if (!adminOk) return;
        const active = document.querySelector('.tab.active')?.getAttribute('data-tab') || 'jobdata';
        if (active === 'jobdata') loadJobdata();
        else if (active === 'alcohol') loadAlcohol();
        else loadUsers();
      });

      document.getElementById('btnLoadJobdata').addEventListener('click', loadJobdata);
      document.getElementById('btnLoadAlcohol').addEventListener('click', loadAlcohol);
      document.getElementById('btnLoadUsers').addEventListener('click', loadUsers);
    });
  </script>
</body>
</html>
