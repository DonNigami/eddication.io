<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <title>Admin Console - Driver Tracking</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <!-- App Scripts -->
  <script src="config.js?v=20251228-12"></script>
  <script src="logger.js?v=20251228-12"></script>
  <script src="constants.js?v=20251228-12"></script>
  <script src="validators.js?v=20251228-12"></script>
  <script src="api.js?v=20251228-12"></script>
  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --danger: #dc2626;
      --bg: #f4f4f5;
      --card-bg: #ffffff;
      --border: #e5e7eb;
      --text-main: #111827;
      --text-sub: #6b7280;
      --radius-lg: 12px;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--text-main);
    }

    .app {
      max-inline-size: 1200px;
      margin: 0 auto;
      padding: 16px;
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      padding: 16px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
      border: 1px solid var(--border);
    }

    header {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-block-end: 16px;
      position: relative;
    }

    header h1 {
      font-size: 1.3rem;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
    }

    header h1 span.badge {
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: #e0f2fe;
      color: #0369a1;
    }

    /* Notification Bell */
    .notification-bell {
      position: absolute;
      top: 0;
      right: 0;
      cursor: pointer;
      font-size: 1.5rem;
      padding: 8px;
      border-radius: 8px;
      transition: all 0.2s;
      background: transparent;
      border: none;
      position: relative;
    }

    .notification-bell:hover {
      background: rgba(37, 99, 235, 0.1);
    }

    .notification-bell .badge-count {
      position: absolute;
      top: 4px;
      right: 4px;
      background: #ef4444;
      color: white;
      font-size: 0.65rem;
      font-weight: bold;
      padding: 2px 6px;
      border-radius: 10px;
      min-width: 18px;
      text-align: center;
      line-height: 1;
      animation: pulse-badge 2s ease-in-out infinite;
    }

    @keyframes pulse-badge {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    /* Notification Dropdown */
    .notification-dropdown {
      position: absolute;
      top: 45px;
      right: 0;
      width: 350px;
      max-width: 90vw;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.15);
      border: 1px solid var(--border);
      z-index: 1000;
      display: none;
      max-height: 400px;
      overflow: hidden;
      flex-direction: column;
    }

    .notification-dropdown.show {
      display: flex;
    }

    .notification-dropdown-header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .notification-dropdown-header h3 {
      margin: 0;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .notification-dropdown-header button {
      background: transparent;
      border: none;
      color: var(--primary);
      cursor: pointer;
      font-size: 0.85rem;
      padding: 4px 8px;
      border-radius: 4px;
    }

    .notification-dropdown-header button:hover {
      background: rgba(37, 99, 235, 0.1);
    }

    .notification-list {
      overflow-y: auto;
      flex: 1;
    }

    .notification-item {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      gap: 12px;
    }

    .notification-item:hover {
      background: rgba(37, 99, 235, 0.05);
    }

    .notification-item.unread {
      background: rgba(37, 99, 235, 0.05);
      position: relative;
    }

    .notification-item.unread::before {
      content: '';
      position: absolute;
      left: 8px;
      top: 50%;
      transform: translateY(-50%);
      width: 8px;
      height: 8px;
      background: #ef4444;
      border-radius: 50%;
    }

    .notification-icon {
      font-size: 1.5rem;
      flex-shrink: 0;
    }

    .notification-content {
      flex: 1;
    }

    .notification-content .title {
      font-weight: 600;
      margin-bottom: 4px;
      font-size: 0.9rem;
    }

    .notification-content .message {
      font-size: 0.85rem;
      color: var(--text-sub);
      margin-bottom: 4px;
    }

    .notification-content .time {
      font-size: 0.75rem;
      color: var(--text-sub);
    }

    .notification-empty {
      padding: 40px 16px;
      text-align: center;
      color: var(--text-sub);
    }

    .notification-empty-icon {
      font-size: 3rem;
      margin-bottom: 8px;
      opacity: 0.5;
    }

    header .sub {
      font-size: 0.85rem;
      color: var(--text-sub);
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: #eef2ff;
      color: #3730a3;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.8rem;
    }

    .pill.bad {
      background: #fee2e2;
      color: #b91c1c;
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin-block-start: 12px;
      border-block-end: 1px solid var(--border);
      padding-block-end: 4px;
      overflow-x: auto;
    }

    .tab-btn {
      border: none;
      background: transparent;
      padding: 8px 12px;
      border-radius: 999px;
      font-size: 0.9rem;
      cursor: pointer;
      color: var(--text-sub);
      white-space: nowrap;
    }

    .tab-btn.active {
      background: #dbeafe;
      color: #ffprimary-dark;
      color: var(--primary-dark);
      font-weight: 600;
    }

    .tab-content {
      margin-block-start: 16px;
    }

    .tab-panel {
      display: none;
    }

    .tab-panel.active {
      display: block;
    }

    .filters {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 8px;
      margin-block-end: 10px;
      align-items: flex-end;
    }

    label {
      font-size: 0.8rem;
      color: var(--text-sub);
      display: block;
      margin-block-end: 2px;
    }

    input[type="text"],
    input[type="number"],
    select {
      inline-size: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 0.85rem;
    }

    button {
      font-size: 0.85rem;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      padding: 7px 14px;
    }

    .btn-main {
      background: var(--primary);
      color: white;
    }

    .btn-main:hover {
      background: var(--primary-dark);
    }

    .btn-ghost {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-sub);
    }

    .btn-danger {
      background: var(--danger);
      color: #fee2e2;
    }

    table {
      inline-size: 100%;
      border-collapse: collapse;
      margin-block-start: 8px;
      font-size: 0.8rem;
    }

    thead {
      background: #f9fafb;
      position: sticky;
      inset-block-start: 0;
      z-index: 1;
    }

    th,
    td {
      border-block-end: 1px solid var(--border);
      padding: 6px 8px;
      vertical-align: middle;
      text-align: start;
    }

    th {
      font-size: 0.78rem;
      color: var(--text-sub);
      font-weight: 600;
      white-space: nowrap;
    }

    tbody tr:hover {
      background: #f9fafb;
    }

    .status-pill {
      display: inline-flex;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
      background: #e5e7eb;
      color: #374151;
    }

    .status-pill.done {
      background: #dcfce7;
      color: #166534;
    }

    .status-pill.new {
      background: #e0f2fe;
      color: #075985;
    }

    .status-pill.reviewed {
      background: #fef3c7;
      color: #92400e;
    }

    .status-pill.alert {
      background: #fee2e2;
      color: #b91c1c;
    }

    .tag {
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 999px;
      background: #eef2ff;
      color: #3730a3;
    }

    .small-input {
      inline-size: 80px;
    }

    .actions {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }

    .center {
      text-align: center;
    }

    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.12);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .loading-overlay.active {
      display: flex;
    }

    .loading-box {
      background: #ffffff;
      padding: 12px 16px;
      border-radius: 999px;
      box-shadow: 0 10px 40px rgba(15, 23, 42, 0.18);
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.9rem;
    }

    .spinner {
      inline-size: 18px;
      block-size: 18px;
      border-radius: 999px;
      border: 2px solid #e5e7eb;
      border-block-start-color: var(--primary);
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .msg {
      font-size: 0.8rem;
      margin-block-start: 6px;
    }

    .msg.error {
      color: #b91c1c;
    }

    .msg.success {
      color: #15803d;
    }

    .scroll-wrapper {
      max-block-size: 55vh;
      overflow: auto;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: white;
    }

    @media (max-inline-size: 768px) {
      .app {
        padding: 10px;
      }

      header h1 {
        font-size: 1.1rem;
      }

      .scroll-wrapper {
        max-block-size: 60vh;
      }
    }
  </style>
</head>

<body>
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-box">
      <div class="spinner"></div>
      <span id="loadingText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
    </div>
  </div>

  <div class="app">
    <div class="card">
      <header>
        <button class="notification-bell" id="notificationBell">
          üîî
          <span class="badge-count" id="notificationCount" style="display: none;">0</span>
        </button>
        
        <div class="notification-dropdown" id="notificationDropdown">
          <div class="notification-dropdown-header">
            <h3>üîî ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h3>
            <button id="markAllRead">‡∏≠‡πà‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
          </div>
          <div class="notification-list" id="notificationList">
            <div class="notification-empty">
              <div class="notification-empty-icon">üîï</div>
              <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</p>
            </div>
          </div>
        </div>
        
        <h1>
          Admin Console
          <span class="badge">Driver Tracking</span>
        </h1>
        <div class="sub">
          <span id="adminInfo">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE ...</span>
          <span id="adminRoleBadge" class="pill bad" style="display:none;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Admin</span>
          <span id="envBadge" class="pill">WebApp</span>
        </div>
        <div id="globalMessage" class="msg"></div>

        <div class="tabs">
          <button class="tab-btn active" data-tab="jobdata">üßæ Jobdata</button>
          <button class="tab-btn" data-tab="alcohol">üç∫ Alcohol Check</button>
          <button class="tab-btn" data-tab="userprofile">üë§ User Profile</button>
        </div>
      </header>

      <div class="tab-content">
        <!-- JOBDATA PANEL -->
        <div class="tab-panel active" id="tab-jobdata">
          <div class="filters">
            <div>
              <label>Reference</label>
              <input type="text" id="jobRef" placeholder="‡πÄ‡∏ä‡πà‡∏ô 12345" />
            </div>
            <div>
              <label>Status</label>
              <select id="jobStatus">
                <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                <option value="NEW">NEW</option>
                <option value="CHECKIN">CHECKIN</option>
                <option value="CHECKOUT">CHECKOUT</option>
                <option value="REVIEWED">REVIEWED</option>
                <option value="JOB_DONE">JOB_DONE</option>
              </select>
            </div>
            <div>
              <label>&nbsp;</label>
              <button class="btn-main" id="btnLoadJob">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Jobdata</button>
            </div>
          </div>
          <div id="jobMessage" class="msg"></div>
          <div class="scroll-wrapper">
            <table>
              <thead>
                <tr>
                  <th>#</th>
                  <th>Ref</th>
                  <th>Shipment</th>
                  <th>‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</th>
                  <th>Status</th>
                  <th>Check-in</th>
                  <th>Check-out</th>
                  <th>ODO</th>
                  <th>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÇ‡∏î‡∏¢</th>
                  <th>‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</th>
                  <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                </tr>
              </thead>
              <tbody id="jobTableBody">
                <tr>
                  <td colspan="11" class="center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- ALCOHOL PANEL -->
        <div class="tab-panel" id="tab-alcohol">
          <div class="filters">
            <div>
              <label>Reference</label>
              <input type="text" id="alcRef" placeholder="‡πÄ‡∏ä‡πà‡∏ô 12345" />
            </div>
            <div>
              <label>‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö</label>
              <input type="text" id="alcDriver" placeholder="‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏ä‡∏∑‡πà‡∏≠" />
            </div>
            <div>
              <label>&nbsp;</label>
              <button class="btn-main" id="btnLoadAlcohol">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Alcohol</button>
            </div>
          </div>
          <div id="alcMessage" class="msg"></div>
          <div class="scroll-wrapper">
            <table>
              <thead>
                <tr>
                  <th>#</th>
                  <th>Ref</th>
                  <th>‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö</th>
                  <th>Alcohol</th>
                  <th>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ</th>
                  <th>User</th>
                  <th>‡∏û‡∏¥‡∏Å‡∏±‡∏î</th>
                  <th>‡∏£‡∏π‡∏õ</th>
                  <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                </tr>
              </thead>
              <tbody id="alcTableBody">
                <tr>
                  <td colspan="9" class="center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- USERPROFILE PANEL -->
        <div class="tab-panel" id="tab-userprofile">
          <div class="filters">
            <div>
              <label>Status</label>
              <select id="userStatus">
                <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                <option value="PENDING">PENDING</option>
                <option value="APPROVED">APPROVED</option>
                <option value="REJECTED">REJECTED</option>
              </select>
            </div>
            <div>
              <label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ userId)</label>
              <input type="text" id="userKeyword" placeholder="‡∏ä‡∏∑‡πà‡∏≠ / userId" />
            </div>
            <div>
              <label>&nbsp;</label>
              <button class="btn-main" id="btnLoadUsers">‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
            </div>
          </div>
          <div id="userMessage" class="msg"></div>
          <div class="scroll-wrapper">
            <table>
              <thead>
                <tr>
                  <th>‡∏£‡∏π‡∏õ</th>
                  <th>‡∏ä‡∏∑‡πà‡∏≠</th>
                  <th>userId</th>
                  <th>Status</th>
                  <th>Type</th>
                  <th>‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠</th>
                  <th>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
                  <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                </tr>
              </thead>
              <tbody id="userTableBody">
                <tr>
                  <td colspan="8" class="center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ‚úÖ LIFF ID ‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡πá‡∏Å‡∏ï‡πå
    const LIFF_ID = '2007705394-Lq3mMYKA';

    // ‚úÖ Backend Base URL (CONFIG picks Railway/AppScript/Localhost)
    const BACKEND_BASE_URL = (window.CONFIG && window.CONFIG.WEB_APP_URL) || 'http://localhost:3000';

    let ADMIN_USER_ID = null;
    let ADMIN_NAME = '';

    function getBaseUrl() {
      return BACKEND_BASE_URL;
    }

    function setLoading(show, text) {
      const overlay = document.getElementById('loadingOverlay');
      const label = document.getElementById('loadingText');
      if (text) label.textContent = text;
      overlay.classList.toggle('active', !!show);
    }

    function setGlobalMessage(msg, type = '') {
      const el = document.getElementById('globalMessage');
      el.textContent = msg || '';
      el.className = 'msg' + (type ? ' ' + type : '');
    }

    function setPanelMessage(id, msg, type = '') {
      const el = document.getElementById(id);
      el.textContent = msg || '';
      el.className = 'msg' + (type ? ' ' + type : '');
    }

    function setAdminInfo(text) {
      const el = document.getElementById('adminInfo');
      el.textContent = text;
    }

    function showAdminBadge(isAdmin) {
      const badge = document.getElementById('adminRoleBadge');
      if (isAdmin) {
        badge.textContent = 'Admin ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
        badge.classList.remove('bad');
        badge.classList.add('pill');
        badge.style.display = 'inline-flex';
        badge.style.background = '#dcfce7';
        badge.style.color = '#166534';
      } else {
        badge.textContent = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Admin';
        badge.classList.add('bad');
        badge.style.display = 'inline-flex';
      }
    }

    // -------- Tabs ---------
    function initTabs() {
      const buttons = document.querySelectorAll('.tab-btn');
      buttons.forEach(btn => {
        btn.addEventListener('click', () => {
          const tab = btn.getAttribute('data-tab');
          buttons.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          document.querySelectorAll('.tab-panel').forEach(p => {
            p.classList.toggle('active', p.id === 'tab-' + tab);
          });
        });
      });
    }

    // -------- LIFF / Auth ---------
    async function initLiff() {
      if (!LIFF_ID || LIFF_ID === 'YOUR_LIFF_ID_HERE') {
        setAdminInfo('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ LIFF_ID ‡πÉ‡∏ô admin.html ‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
        setGlobalMessage('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ LIFF ID', 'error');
        return;
      }

      try {
        setLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE ...');
        await liff.init({ liffId: LIFF_ID });

        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        let userId = null;
        let displayName = '';

        try {
          const decoded = liff.getDecodedIDToken();
          if (decoded && decoded.sub) {
            userId = decoded.sub;
          }
        } catch (e) {
          console.log('getDecodedIDToken error', e);
        }

        const profile = await liff.getProfile();
        if (!userId && profile && profile.userId) {
          userId = profile.userId;
        }
        displayName = profile.displayName || '';

        ADMIN_USER_ID = userId;
        ADMIN_NAME = displayName;

        setAdminInfo(`‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö: ${displayName} (${userId})`);

        await checkAdminPermission(userId);
      } catch (err) {
        console.error(err);
        setAdminInfo('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE/LIFF ‡πÑ‡∏î‡πâ');
        setGlobalMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LIFF', 'error');
      } finally {
        setLoading(false);
      }
    }

    async function checkAdminPermission(userId) {
      if (!userId) {
        setGlobalMessage('‡πÑ‡∏°‡πà‡∏û‡∏ö userId ‡∏à‡∏≤‡∏Å LINE ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ Login ‡πÉ‡∏´‡∏°‡πà', 'error');
        showAdminBadge(false);
        return;
      }
      setLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Admin ...');
      try {
        const json = await window.API.adminCheck(userId);

        if (!json.success || !json.isAdmin) {
          showAdminBadge(false);
          setGlobalMessage('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Admin ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•', 'error');
        } else {
          showAdminBadge(true);
          setGlobalMessage('‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤ Admin', 'success');
        }
      } catch (e) {
        console.error(e);
        setGlobalMessage('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
        showAdminBadge(false);
      } finally {
        setLoading(false);
      }
    }

    // -------- Jobdata ---------
    async function loadJobdata() {
      if (!ADMIN_USER_ID) {
        setPanelMessage('jobMessage', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô LINE ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å LIFF', 'error');
        await initLiff();
        return;
      }
      setPanelMessage('jobMessage', '');
      setLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î Jobdata ...');

      try {
        const ref = document.getElementById('jobRef').value.trim();
        const status = document.getElementById('jobStatus').value.trim();
        const json = await window.API.adminJobdata(ADMIN_USER_ID, ref, status, 200);

        if (!json.success) {
          setPanelMessage('jobMessage', json.message || '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
          renderJobdata([]);
          return;
        }

        renderJobdata(json.rows || []);
        setPanelMessage('jobMessage', `‡∏û‡∏ö ${json.rows.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'success');
      } catch (e) {
        console.error(e);
        setPanelMessage('jobMessage', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î Jobdata', 'error');
        renderJobdata([]);
      } finally {
        setLoading(false);
      }
    }

    function renderJobdata(rows) {
      const tbody = document.getElementById('jobTableBody');
      tbody.innerHTML = '';
      if (!rows || rows.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="11" class="center">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td>`;
        tbody.appendChild(tr);
        return;
      }

      rows.forEach((r, idx) => {
        const tr = document.createElement('tr');

        const statusClass = (s => {
          s = (s || '').toUpperCase();
          if (s === 'JOB_DONE') return 'status-pill done';
          if (s === 'NEW') return 'status-pill new';
          if (s === 'REVIEWED') return 'status-pill reviewed';
          if (s === 'CHECKIN') return 'status-pill alert';
          return 'status-pill';
        })(r.status);

        tr.innerHTML = `
        <td>${idx + 1}</td>
        <td>${r.referenceNo || ''}</td>
        <td>${r.shipmentNo || ''}</td>
        <td>
          <div>${r.destination2 || ''}</div>
          <div class="tag">${r.destination1 || '-'}</div>
        </td>
        <td>
          <select data-row="${r.rowIndex}" class="job-status-select">
            ${['NEW', 'CHECKIN', 'CHECKOUT', 'REVIEWED', 'JOB_DONE'].map(s => `
              <option value="${s}" ${s === r.status ? 'selected' : ''}>${s}</option>
            `).join('')}
          </select>
          <div style="margin-block-start:2px;"><span class="${statusClass}">${r.status}</span></div>
        </td>
        <td>${r.checkInTime || '-'}</td>
        <td>${r.checkOutTime || '-'}</td>
        <td>${r.checkInOdo || '-'}</td>
        <td>${r.updatedBy || '-'}</td>
        <td>${r.updatedAt || '-'}</td>
        <td class="actions">
          <button class="btn-main" data-row="${r.rowIndex}" onclick="onSaveJobStatus(this)">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </td>
      `;
        tbody.appendChild(tr);
      });
    }

    // üîß ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏°‡∏≤‡πÉ‡∏ä‡πâ form POST (URLSearchParams) ‡πÅ‡∏ó‡∏ô JSON ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏ö CORS preflight
    async function onSaveJobStatus(btn) {
      if (!ADMIN_USER_ID) {
        setPanelMessage('jobMessage', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô LINE', 'error');
        await initLiff();
        return;
      }
      const rowIndex = btn.getAttribute('data-row');
      const select = document.querySelector(`select.job-status-select[data-row="${rowIndex}"]`);
      if (!select) return;
      const newStatus = select.value;

      if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ row ${rowIndex} ‡πÄ‡∏õ‡πá‡∏ô ${newStatus} ?`)) return;

      setLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Job ...');
      try {
        const json = await window.API.adminUpdateJob(ADMIN_USER_ID, rowIndex, newStatus);
        if (!json.success) {
          setPanelMessage('jobMessage', json.message || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
        } else {
          setPanelMessage('jobMessage', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
          await loadJobdata();
        }
      } catch (e) {
        console.error(e);
        setPanelMessage('jobMessage', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', 'error');
      } finally {
        setLoading(false);
      }
    }

    // -------- Alcohol ---------
    async function loadAlcohol() {
      if (!ADMIN_USER_ID) {
        setPanelMessage('alcMessage', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô LINE', 'error');
        await initLiff();
        return;
      }
      setPanelMessage('alcMessage', '');
      setLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î Alcohol ...');

      try {
        const ref = document.getElementById('alcRef').value.trim();
        const driver = document.getElementById('alcDriver').value.trim();
        const json = await window.API.adminAlcohol(ADMIN_USER_ID, ref, driver, 200);

        if (!json.success) {
          setPanelMessage('alcMessage', json.message || '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
          renderAlcohol([]);
          return;
        }

        renderAlcohol(json.rows || []);
        setPanelMessage('alcMessage', `‡∏û‡∏ö ${json.rows.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'success');
      } catch (e) {
        console.error(e);
        setPanelMessage('alcMessage', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î Alcohol', 'error');
        renderAlcohol([]);
      } finally {
        setLoading(false);
      }
    }

    function renderAlcohol(rows) {
      const tbody = document.getElementById('alcTableBody');
      tbody.innerHTML = '';
      if (!rows || rows.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="9" class="center">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td>`;
        tbody.appendChild(tr);
        return;
      }

      rows.forEach((r, idx) => {
        const tr = document.createElement('tr');
        const val = r.alcoholValue != null ? r.alcoholValue : '';
        tr.innerHTML = `
        <td>${idx + 1}</td>
        <td>${r.reference || ''}</td>
        <td>${r.driverName || ''}</td>
        <td>
          <input type="number" step="0.01" class="small-input alc-value-input"
                 data-row="${r.rowIndex}" value="${val}" />
        </td>
        <td>${r.checkedAt || '-'}</td>
        <td>${r.userId || '-'}</td>
        <td>${r.lat || '-'}, ${r.lng || '-'}</td>
        <td>
          ${r.imageUrl ? `<a href="${r.imageUrl}" target="_blank">‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏π‡∏õ</a>` : '-'}
        </td>
        <td class="actions">
          <button class="btn-main" data-row="${r.rowIndex}" onclick="onSaveAlcohol(this)">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </td>
      `;
        tbody.appendChild(tr);
      });
    }

    // üîß ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô form POST ‡πÄ‡∏ä‡πà‡∏ô‡∏Å‡∏±‡∏ô
    async function onSaveAlcohol(btn) {
      if (!ADMIN_USER_ID) {
        setPanelMessage('alcMessage', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô LINE', 'error');
        await initLiff();
        return;
      }
      const rowIndex = btn.getAttribute('data-row');
      const input = document.querySelector(`input.alc-value-input[data-row="${rowIndex}"]`);
      if (!input) return;
      const value = input.value.trim();
      if (value === '' || isNaN(parseFloat(value))) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
        return;
      }

      if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå row ${rowIndex} ‡πÄ‡∏õ‡πá‡∏ô ${value} ?`)) return;

      setLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤ Alcohol ...');
      try {
        const json = await window.API.adminUpdateAlcohol(ADMIN_USER_ID, rowIndex, value);
        if (!json.success) {
          setPanelMessage('alcMessage', json.message || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
        } else {
          setPanelMessage('alcMessage', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
          await loadAlcohol();
        }
      } catch (e) {
        console.error(e);
        setPanelMessage('alcMessage', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', 'error');
      } finally {
        setLoading(false);
      }
    }

    // -------- Userprofile ---------
    async function loadUsers() {
      if (!ADMIN_USER_ID) {
        setPanelMessage('userMessage', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô LINE', 'error');
        await initLiff();
        return;
      }
      setPanelMessage('userMessage', '');
      setLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î User ...');

      try {
        const status = document.getElementById('userStatus').value.trim();
        const keyword = document.getElementById('userKeyword').value.trim();
        const json = await window.API.adminUserprofile(ADMIN_USER_ID, status, keyword);

        if (!json.success) {
          setPanelMessage('userMessage', json.message || '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
          renderUsers([]);
          return;
        }

        renderUsers(json.rows || []);
        setPanelMessage('userMessage', `‡∏û‡∏ö ${json.rows.length} user`, 'success');
      } catch (e) {
        console.error(e);
        setPanelMessage('userMessage', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î User', 'error');
        renderUsers([]);
      } finally {
        setLoading(false);
      }
    }

    function renderUsers(rows) {
      const tbody = document.getElementById('userTableBody');
      tbody.innerHTML = '';
      if (!rows || rows.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="8" class="center">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td>`;
        tbody.appendChild(tr);
        return;
      }

      rows.forEach(r => {
        const tr = document.createElement('tr');
        const statusClass = (() => {
          const s = (r.status || '').toUpperCase();
          if (s === 'APPROVED') return 'status-pill done';
          if (s === 'PENDING') return 'status-pill new';
          if (s === 'REJECTED') return 'status-pill alert';
          return 'status-pill';
        })();

        tr.innerHTML = `
        <td>
          ${r.pictureUrl
            ? `<img src="${r.pictureUrl}" alt="" style="inline-size:32px;block-size:32px;border-radius:999px;object-fit:cover;" />`
            : `<div style="inline-size:32px;block-size:32px;border-radius:999px;background:#e5e7eb;display:flex;align-items:center;justify-content:center;font-size:0.7rem;">?</div>`
          }
        </td>
        <td>${r.displayName || '-'}</td>
        <td style="max-inline-size:220px;word-break:break-all;">${r.userId || '-'}</td>
        <td>
          <select class="user-status-select" data-user="${r.userId}">
            ${['PENDING', 'APPROVED', 'REJECTED'].map(s => `
              <option value="${s}" ${s === r.status ? 'selected' : ''}>${s}</option>
            `).join('')}
          </select>
          <div style="margin-block-start:2px;"><span class="${statusClass}">${r.status}</span></div>
        </td>
        <td><span class="tag">${r.userType || '-'}</span></td>
        <td>${r.createdAt || '-'}</td>
        <td>${r.updatedAt || '-'}</td>
        <td class="actions">
          <button class="btn-main" data-user="${r.userId}" onclick="onSaveUserStatus(this)">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </td>
      `;
        tbody.appendChild(tr);
      });
    }

    // üîß ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô form POST ‡πÄ‡∏ä‡πà‡∏ô‡∏Å‡∏±‡∏ô
    async function onSaveUserStatus(btn) {
      if (!ADMIN_USER_ID) {
        setPanelMessage('userMessage', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô LINE', 'error');
        await initLiff();
        return;
      }
      const userId = btn.getAttribute('data-user');
      const select = document.querySelector(`select.user-status-select[data-user="${userId}"]`);
      if (!select) return;
      const newStatus = select.value;

      if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ\n${userId}\n‡πÄ‡∏õ‡πá‡∏ô ${newStatus} ?`)) return;

      setLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ User ...');
      try {
        const json = await window.API.adminUpdateUserStatus(ADMIN_USER_ID, userId, newStatus);
        if (!json.success) {
          setPanelMessage('userMessage', json.message || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
        } else {
          setPanelMessage('userMessage', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
          await loadUsers();
        }
      } catch (e) {
        console.error(e);
        setPanelMessage('userMessage', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', 'error');
      } finally {
        setLoading(false);
      }
    }

    // -------- Notification System ---------
    let notifications = [];
    let notificationBell, notificationCount, notificationDropdown, notificationList, markAllReadBtn;

    function initNotifications() {
      notificationBell = document.getElementById('notificationBell');
      notificationCount = document.getElementById('notificationCount');
      notificationDropdown = document.getElementById('notificationDropdown');
      notificationList = document.getElementById('notificationList');
      markAllReadBtn = document.getElementById('markAllRead');

      // Load from localStorage
      const saved = localStorage.getItem('adminNotifications');
      if (saved) {
        try {
          notifications = JSON.parse(saved);
          updateNotificationUI();
        } catch (e) {
          console.error('Failed to parse notifications', e);
          notifications = [];
        }
      }

      // Event listeners
      notificationBell.addEventListener('click', toggleNotificationDropdown);
      markAllReadBtn.addEventListener('click', markAllAsRead);

      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (!notificationBell.contains(e.target) && !notificationDropdown.contains(e.target)) {
          notificationDropdown.classList.remove('show');
        }
      });

      // Subscribe to Supabase realtime for jobdata changes
      subscribeToJobActivity();
    }

    function toggleNotificationDropdown(e) {
      e.stopPropagation();
      notificationDropdown.classList.toggle('show');
    }

    function addNotification(type, title, message, data = {}) {
      const notification = {
        id: Date.now(),
        type, // 'checkin', 'checkout', 'trip-end', 'holiday-work'
        title,
        message,
        data,
        timestamp: new Date().toISOString(),
        read: false
      };

      notifications.unshift(notification);
      
      // Keep only last 50 notifications
      if (notifications.length > 50) {
        notifications = notifications.slice(0, 50);
      }

      saveNotifications();
      updateNotificationUI();
      
      // Play sound (optional)
      playNotificationSound();
    }

    function markAsRead(notificationId) {
      const notification = notifications.find(n => n.id === notificationId);
      if (notification) {
        notification.read = true;
        saveNotifications();
        updateNotificationUI();
      }
    }

    function markAllAsRead() {
      notifications.forEach(n => n.read = true);
      saveNotifications();
      updateNotificationUI();
    }

    function saveNotifications() {
      localStorage.setItem('adminNotifications', JSON.stringify(notifications));
    }

    function updateNotificationUI() {
      const unreadCount = notifications.filter(n => !n.read).length;
      
      // Update badge
      if (unreadCount > 0) {
        notificationCount.textContent = unreadCount > 99 ? '99+' : unreadCount;
        notificationCount.style.display = 'block';
      } else {
        notificationCount.style.display = 'none';
      }

      // Render list
      renderNotificationList();
    }

    function renderNotificationList() {
      if (notifications.length === 0) {
        notificationList.innerHTML = `
          <div class="notification-empty">
            <div class="notification-empty-icon">üîï</div>
            <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</p>
          </div>
        `;
        return;
      }

      notificationList.innerHTML = notifications.map(n => {
        const icon = getNotificationIcon(n.type);
        const timeAgo = getTimeAgo(new Date(n.timestamp));
        
        return `
          <div class="notification-item ${n.read ? '' : 'unread'}" onclick="handleNotificationClick(${n.id})">
            <div class="notification-icon">${icon}</div>
            <div class="notification-content">
              <div class="title">${n.title}</div>
              <div class="message">${n.message}</div>
              <div class="time">${timeAgo}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    function handleNotificationClick(notificationId) {
      markAsRead(notificationId);
      const notification = notifications.find(n => n.id === notificationId);
      
      if (notification && notification.data.reference) {
        // Could navigate to specific job or do something
        console.log('Navigate to:', notification.data.reference);
      }
    }

    function getNotificationIcon(type) {
      const icons = {
        'checkin': 'üìç',
        'checkout': '‚úÖ',
        'trip-end': 'üéâ',
        'holiday-work': 'üéä',
        'alcohol-check': 'üç∫',
        'alert': '‚ö†Ô∏è'
      };
      return icons[type] || 'üîî';
    }

    function getTimeAgo(date) {
      const seconds = Math.floor((new Date() - date) / 1000);
      
      if (seconds < 60) return '‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà';
      if (seconds < 3600) return `${Math.floor(seconds / 60)} ‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
      if (seconds < 86400) return `${Math.floor(seconds / 3600)} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
      return `${Math.floor(seconds / 86400)} ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
    }

    function playNotificationSound() {
      // Simple notification sound using Web Audio API
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.2);
      } catch (e) {
        console.log('Could not play sound', e);
      }
    }

    function subscribeToJobActivity() {
      // This is a simple polling method
      // For real Supabase realtime, you'd use supabase.channel()
      
      // Check for new activities every 30 seconds
      setInterval(async () => {
        try {
          // This is placeholder - in production you'd track last checked timestamp
          // and only fetch new activities since then
          
          // Example: Check for recent checkins in last 5 minutes
          const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000).toISOString();
          
          // You would implement actual API calls here
          // For now, this is just a demo structure
          
        } catch (e) {
          console.error('Failed to fetch activities', e);
        }
      }, 30000); // Check every 30 seconds
    }

    // Example: Add notification manually for testing
    function testNotification() {
      addNotification(
        'checkin',
        'Check-in ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
        '2601M01944 - ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ABC ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢',
        { reference: '2601M01944', location: '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ABC' }
      );
    }

    // -------- Init ---------
    document.addEventListener('DOMContentLoaded', () => {
      initTabs();
      initNotifications(); // Initialize notification system

      document.getElementById('btnLoadJob').addEventListener('click', loadJobdata);
      document.getElementById('btnLoadAlcohol').addEventListener('click', loadAlcohol);
      document.getElementById('btnLoadUsers').addEventListener('click', loadUsers);

      initLiff();
      
      // For testing: add sample notifications after 2 seconds
      setTimeout(() => {
        addNotification('checkin', 'Check-in', '‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏ó‡∏µ‡πà ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ABC', { reference: '2601M01944' });
        addNotification('checkout', 'Check-out', '‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå‡∏à‡∏≤‡∏Å ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó XYZ', { reference: '2601M01943' });
        addNotification('holiday-work', '‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î', '‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÉ‡∏´‡∏°‡πà ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', { reference: '2601M01945' });
      }, 2000);
    });
  </script>
</body>

</html>