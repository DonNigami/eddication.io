<!DOCTYPE html>
<html lang="th">

<head>
  <base target="_top" />
  <meta charset="UTF-8" />
  <title>Driver Tracking (Supabase)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üöö</text></svg>" />

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Edge Functions API Client -->
  <script src="js/edge-functions-api.js"></script>

  <style>
    :root {
      --primary: #1abc9c;
      --primary-dark: #16a085;
      --bg: #f4f8f7;
      --text-main: #222;
      --text-sub: #666;
      --card-bg: #ffffff;
      --border-radius: 14px;
      --input-bg: #f7faf9;
      --input-border: #dce2e0;
      --shadow-color: rgba(0, 0, 0, 0.06);
      --timeline-border: #e4ece9;
      --timeline-bg: #f7faf9;
    }

    /* Dark Mode */
    [data-theme="dark"] {
      --bg: #1a1a2e;
      --text-main: #eaeaea;
      --text-sub: #a0a0a0;
      --card-bg: #16213e;
      --input-bg: #1a1a2e;
      --input-border: #2a2a4a;
      --shadow-color: rgba(0, 0, 0, 0.3);
      --timeline-border: #2a2a4a;
      --timeline-bg: #1a1a2e;
    }

    [data-theme="dark"] .badge { background: rgba(26, 188, 156, 0.2); }
    [data-theme="dark"] .summary-card { background: var(--timeline-bg); border-color: var(--timeline-border); }
    [data-theme="dark"] .timeline-content { background: var(--card-bg); border-color: var(--timeline-border); }
    [data-theme="dark"] .gps-status.checking { background: rgba(52, 152, 219, 0.15); }
    [data-theme="dark"] .gps-status.good { background: rgba(26, 188, 156, 0.15); }
    [data-theme="dark"] .gps-status.weak { background: rgba(243, 156, 18, 0.15); }
    [data-theme="dark"] .gps-status.error { background: rgba(231, 76, 60, 0.15); }
    [data-theme="dark"] .last-updated { background: rgba(26, 188, 156, 0.12); }
    [data-theme="dark"] .ptr-indicator { background: var(--card-bg); }
    [data-theme="dark"] .inline-flex { background: var(--card-bg); }

    * { box-sizing: border-box; }
    body { margin: 0; padding: 0; font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--bg); color: var(--text-main); }
    .app-shell { min-height: 100vh; display: flex; justify-content: center; padding: 12px; }
    .container { width: 100%; max-width: 520px; }
    .card { background: var(--card-bg); border-radius: var(--border-radius); padding: 16px 18px 20px; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.06); }
    .header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
    .title { font-size: 1.2rem; font-weight: 700; display: flex; align-items: center; gap: 8px; }
    .badge { font-size: 0.75rem; padding: 4px 10px; border-radius: 999px; background: rgba(26, 188, 156, 0.1); color: var(--primary-dark); }
    .badge.supabase { background: rgba(62, 207, 142, 0.15); color: #3ecf8e; }
    .status-text { font-size: 0.9rem; color: var(--text-sub); margin-bottom: 10px; }
    .field-group { margin-bottom: 10px; }
    label { display: block; font-size: 0.8rem; color: var(--text-sub); margin-bottom: 4px; }
    input[type='text'], input[type='number'] { width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--input-border); font-size: 0.95rem; outline: none; transition: border 0.2s, box-shadow 0.2s, background 0.2s; background: var(--input-bg); color: var(--text-main); }
    input[type='text']:focus, input[type='number']:focus { border-color: var(--primary); background: var(--card-bg); box-shadow: 0 0 0 2px rgba(26, 188, 156, 0.18); }

    .theme-toggle, .notification-btn { background: none; border: none; width: 36px; height: 36px; padding: 0; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; transition: background 0.2s, transform 0.2s; }
    .theme-toggle:hover, .notification-btn:hover { background: rgba(26, 188, 156, 0.1); transform: scale(1.1); }

    .offline-bar { display: none; background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; padding: 8px 16px; text-align: center; font-size: 0.85rem; font-weight: 600; position: sticky; top: 0; z-index: 1000; }
    .offline-bar.show { display: flex; align-items: center; justify-content: center; gap: 8px; }
    .queue-badge { background: rgba(255, 255, 255, 0.25); padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; margin-left: 4px; }

    button { width: 100%; padding: 11px 12px; border-radius: 999px; border: none; font-size: 0.95rem; font-weight: 600; cursor: pointer; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: #ffffff; display: inline-flex; align-items: center; justify-content: center; gap: 8px; transition: transform 0.12s ease-out, box-shadow 0.12s ease-out, opacity 0.15s; }
    button:hover { transform: translateY(-1px); box-shadow: 0 8px 18px rgba(22, 160, 133, 0.28); }
    button:active { transform: translateY(0); box-shadow: none; opacity: 0.9; }
    button:disabled { opacity: 0.6; cursor: not-allowed; box-shadow: none; transform: none; }

    .btn-small { width: auto; padding: 10px 16px; font-size: 0.95rem; border-radius: 999px; margin: 4px 6px 0 0; }
    .btn-outline { background: #ffffff; color: var(--primary-dark); border: 1px solid rgba(26, 188, 156, 0.35); box-shadow: none; }
    .btn-outline:hover { background: rgba(26, 188, 156, 0.06); }
    .btn-secondary { background: #95a5a6; background: linear-gradient(135deg, #95a5a6, #7f8c8d); }

    .summary-card { margin-top: 12px; padding: 10px 12px; border-radius: 10px; background: #f7faf9; border: 1px solid #e3ebe8; font-size: 0.88rem; }
    .summary-row { display: flex; justify-content: space-between; margin-bottom: 4px; }
    .summary-label { color: var(--text-sub); }
    .summary-value { font-weight: 600; }

    .timeline-container { margin-top: 14px; }
    .timeline-title { font-weight: 600; font-size: 0.95rem; margin-bottom: 6px; display: flex; align-items: center; gap: 6px; }
    .timeline { position: relative; margin: 0; padding: 4px 0 0 20px; list-style: none; }
    .timeline::before { content: ''; position: absolute; left: 9px; top: 0; bottom: 0; width: 2px; background: linear-gradient(to bottom, rgba(26, 188, 156, 0.6), rgba(26, 188, 156, 0.1)); }
    .timeline-item { position: relative; margin-bottom: 14px; }
    .timeline-marker { position: absolute; left: -1px; top: 6px; width: 12px; height: 12px; border-radius: 50%; background: #ffffff; border: 2px solid var(--primary); box-shadow: 0 0 0 2px rgba(26, 188, 156, 0.15); }
    .timeline-content { margin-left: 14px; background: #ffffff; border-radius: 12px; padding: 8px 10px; border: 1px solid #e4ece9; box-shadow: 0 3px 8px rgba(0, 0, 0, 0.04); }
    .timeline-header-row { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 4px; }
    .timeline-stop-label { font-size: 0.9rem; font-weight: 800; color: var(--primary-dark); }
    .timeline-status { font-size: 0.75rem; padding: 2px 8px; border-radius: 999px; background: rgba(22, 160, 133, 0.06); color: var(--primary-dark); }
    .timeline-sub { font-size: 0.82rem; color: var(--text-sub); margin-bottom: 2px; }
    .action-row { margin-top: 6px; display: flex; gap: 6px; flex-wrap: wrap; align-items: stretch; }
    .action-row button { flex: 1; }
    .btn-nav { flex: 0 0 25%; background: #0d6efd; color: #fff; border-radius: 8px; padding: 8px 6px; text-align: center; font-size: 0.8rem; border: none; width: auto; }

    .footer-note { margin-top: 8px; font-size: 0.78rem; color: var(--text-sub); text-align: center; }
    .last-updated { margin-top: 10px; padding: 8px 12px; background: rgba(26, 188, 156, 0.08); border-radius: 8px; font-size: 0.8rem; color: var(--text-sub); display: flex; justify-content: space-between; align-items: center; }
    .auto-refresh-badge { font-size: 0.7rem; padding: 2px 8px; border-radius: 999px; background: var(--primary); color: #fff; }
    .auto-refresh-badge.paused { background: #95a5a6; }

    .gps-status { display: flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 8px; font-size: 0.75rem; font-weight: 500; margin-bottom: 10px; transition: all 0.3s ease; }
    .gps-status.checking { background: rgba(52, 152, 219, 0.1); color: #3498db; }
    .gps-status.good { background: rgba(26, 188, 156, 0.1); color: var(--primary-dark); }
    .gps-status.weak { background: rgba(243, 156, 18, 0.1); color: #d68910; }
    .gps-status.error { background: rgba(231, 76, 60, 0.1); color: #c0392b; }
    .gps-icon { font-size: 1rem; }
    .gps-accuracy { margin-left: auto; font-size: 0.7rem; opacity: 0.8; }
    .gps-bars { display: flex; align-items: flex-end; gap: 2px; height: 14px; }
    .gps-bar { width: 4px; background: currentColor; border-radius: 1px; opacity: 0.3; transition: opacity 0.2s ease; }
    .gps-bar.active { opacity: 1; }
    .gps-bar:nth-child(1) { height: 4px; }
    .gps-bar:nth-child(2) { height: 7px; }
    .gps-bar:nth-child(3) { height: 10px; }
    .gps-bar:nth-child(4) { height: 14px; }

    .hidden { display: none; }

    .inline-flex { position: fixed; top: 10px; left: 50%; transform: translateX(-50%) translateY(-20px); width: calc(100% - 24px); max-width: 520px; background: #ffffff; border-radius: 16px; box-shadow: 0 10px 24px rgba(0, 0, 0, 0.18); border-left: 4px solid var(--primary); padding: 10px 12px 11px; z-index: 9999; opacity: 0; pointer-events: none; }
    .inline-flex-bar { width: 42px; height: 4px; border-radius: 99px; background: rgba(26, 188, 156, 0.2); margin: 0 auto 6px; }
    .inline-flex-title { font-size: 0.95rem; font-weight: 700; color: var(--primary-dark); margin-bottom: 2px; text-align: left; }
    .inline-flex-text { font-size: 0.8rem; color: var(--text-sub); margin-bottom: 2px; }
    .inline-flex-sub { font-size: 0.76rem; color: #555; }
    .inline-flex.show { animation: dropIn 0.35s ease-out forwards; }
    .inline-flex.hide { animation: fadeOutUp 0.25s ease-in forwards; }

    @keyframes dropIn { from { opacity: 0; transform: translateX(-50%) translateY(-20px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
    @keyframes fadeOutUp { from { opacity: 1; transform: translateX(-50%) translateY(0); } to { opacity: 0; transform: translateX(-50%) translateY(-15px); } }

    /* Realtime indicator */
    .realtime-dot { width: 8px; height: 8px; background: #3ecf8e; border-radius: 50%; animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

    /* Loading Skeleton */
    .skeleton { background: linear-gradient(90deg, var(--input-bg) 25%, var(--timeline-border) 50%, var(--input-bg) 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 8px; }
    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    .skeleton-summary { padding: 12px; }
    .skeleton-row { display: flex; justify-content: space-between; margin-bottom: 10px; }
    .skeleton-label { width: 80px; height: 14px; }
    .skeleton-value { width: 120px; height: 14px; }
    .skeleton-timeline-item { display: flex; gap: 14px; margin-bottom: 14px; padding-left: 20px; }
    .skeleton-marker { width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0; }
    .skeleton-content { flex: 1; }
    .skeleton-title { width: 60%; height: 16px; margin-bottom: 8px; }
    .skeleton-sub { width: 80%; height: 12px; margin-bottom: 8px; }
    .skeleton-buttons { display: flex; gap: 8px; }
    .skeleton-btn { width: 80px; height: 32px; border-radius: 999px; }

    /* Input validation styles */
    .input-error { border-color: #e74c3c !important; background: rgba(231, 76, 60, 0.05) !important; }
    .input-error:focus { box-shadow: 0 0 0 2px rgba(231, 76, 60, 0.18) !important; }
    .error-message { color: #e74c3c; font-size: 0.75rem; margin-top: 4px; display: none; }
    .error-message.show { display: block; }
  </style>
</head>

<body>
  <!-- Offline Mode Bar -->
  <div id="offlineBar" class="offline-bar">
    <span>üìµ</span>
    <span>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï</span>
    <span id="queueBadge" class="queue-badge" style="display:none;">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏™‡πà‡∏á</span>
  </div>

  <!-- Inline Flex Notification -->
  <div id="inlineFlex" class="inline-flex hidden">
    <div class="inline-flex-bar"></div>
    <div class="inline-flex-title" id="inlineFlexTitle"></div>
    <div class="inline-flex-text" id="inlineFlexMain"></div>
    <div class="inline-flex-sub" id="inlineFlexSub"></div>
  </div>

  <div class="app-shell" id="appShell">
    <div class="container">
      <div class="card">
        <div class="header">
          <div class="title">
            üöö Driver Tracking
            <span class="badge supabase">Supabase</span>
            <span class="realtime-dot" title="Realtime Connected"></span>
          </div>
          <div style="display:flex;gap:4px;">
            <button id="themeToggle" class="theme-toggle" title="‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô">üåô</button>
          </div>
        </div>

        <div id="status" class="status-text">üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å LINE...</div>

        <!-- GPS Status Indicator -->
        <div id="gpsStatus" class="gps-status checking" style="cursor:pointer;" title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö GPS ‡πÉ‡∏´‡∏°‡πà">
          <span class="gps-icon">üìç</span>
          <span id="gpsText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö GPS...</span>
          <div class="gps-bars">
            <div class="gps-bar"></div>
            <div class="gps-bar"></div>
            <div class="gps-bar"></div>
            <div class="gps-bar"></div>
          </div>
          <span id="gpsAccuracy" class="gps-accuracy"></span>
        </div>

        <div class="field-group">
          <label for="keyword">‡πÄ‡∏•‡∏Ç‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏á‡∏≤‡∏ô (Reference No.)</label>
          <input id="keyword" type="text" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç Reference ‡πÄ‡∏ä‡πà‡∏ô 2511S15403" maxlength="50" />
          <div id="keywordError" class="error-message"></div>
        </div>

        <button id="btnSearch">
          <span>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ / ‡∏î‡∏∂‡∏á‡∏á‡∏≤‡∏ô</span>
        </button>

        <div id="summary" class="summary-card hidden"></div>
        <div id="summarySkeleton" class="summary-card skeleton-summary hidden">
          <div class="skeleton-row"><div class="skeleton skeleton-label"></div><div class="skeleton skeleton-value"></div></div>
          <div class="skeleton-row"><div class="skeleton skeleton-label"></div><div class="skeleton skeleton-value"></div></div>
          <div class="skeleton-row"><div class="skeleton skeleton-label"></div><div class="skeleton skeleton-value"></div></div>
          <div class="skeleton-row" style="margin-bottom:0;"><div class="skeleton skeleton-label"></div><div class="skeleton skeleton-value"></div></div>
        </div>
        <div id="alcoholContainer" class="summary-card hidden" style="margin-top:10px;"></div>

        <div id="timelineSkeleton" class="timeline-container hidden">
          <div class="timeline-title">‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
          <div style="padding-left:20px;">
            <div class="skeleton-timeline-item"><div class="skeleton skeleton-marker"></div><div class="skeleton-content"><div class="skeleton skeleton-title"></div><div class="skeleton skeleton-sub"></div><div class="skeleton-buttons"><div class="skeleton skeleton-btn"></div><div class="skeleton skeleton-btn"></div></div></div></div>
            <div class="skeleton-timeline-item"><div class="skeleton skeleton-marker"></div><div class="skeleton-content"><div class="skeleton skeleton-title"></div><div class="skeleton skeleton-sub"></div><div class="skeleton-buttons"><div class="skeleton skeleton-btn"></div><div class="skeleton skeleton-btn"></div></div></div></div>
            <div class="skeleton-timeline-item"><div class="skeleton skeleton-marker"></div><div class="skeleton-content"><div class="skeleton skeleton-title"></div><div class="skeleton skeleton-sub"></div><div class="skeleton-buttons"><div class="skeleton skeleton-btn"></div><div class="skeleton skeleton-btn"></div></div></div></div>
          </div>
        </div>

        <div id="timelineContainer" class="timeline-container hidden">
          <div class="timeline-title">
            ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
            <span style="font-size:0.8rem;color:var(--text-sub);">(‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á)</span>
          </div>
          <ul id="timeline" class="timeline"></ul>

          <div id="closeJobContainer" class="hidden" style="margin-top:8px;">
            <button id="btnCloseJob" class="btn-secondary" style="width:100%;margin-bottom:6px;">‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô (‡∏£‡∏ñ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô)</button>
            <button id="btnEndTrip" class="btn-secondary" style="width:100%;display:none;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ (‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå + ‡∏à‡∏∏‡∏î‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ)</button>
          </div>
        </div>

        <div id="lastUpdatedContainer" class="last-updated hidden">
          <div style="display:flex;align-items:center;gap:6px;">
            <span>üîÑ</span>
            <span id="lastUpdatedText">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: -</span>
          </div>
          <span id="autoRefreshBadge" class="auto-refresh-badge">Realtime</span>
        </div>

        <div class="footer-note">
          ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Check-in / Check-out ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ö‡∏ô‡∏à‡∏≠<br>
          <small style="color:#3ecf8e;">Powered by Supabase - Realtime Updates</small>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // SUPABASE CONFIGURATION
    // ============================================
    const SUPABASE_URL = 'https://myplpshpcordggbbtblg.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im15cGxwc2hwY29yZGdnYmJ0YmxnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0MDI2ODgsImV4cCI6MjA4Mzk3ODY4OH0.UC42xLgqSdqgaogHmyRpES_NMy5t1j7YhdEZVwWUsJ8';

    // Initialize Supabase client (force new initialization with unique name)
    window.supabaseDB = window.supabaseDB || window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const supabase = window.supabaseDB;
    console.log('‚úÖ Supabase client ready');

    // LIFF Configuration
    const LIFF_ID = '2007705394-Fgx9wdHu';

    // ============================================
    // GLOBAL STATE
    // ============================================
    let currentUserId = '';
    let currentReference = '';
    let currentVehicleDesc = '';
    let lastStops = [];
    let inlineFlexTimer = null;
    let currentDrivers = [];
    let currentCheckedDrivers = [];
    let alcoholAllDone = false;
    let jobClosed = false;
    let tripEnded = false;
    let realtimeSubscription = null;
    let isOnline = navigator.onLine;
    let offlineQueue = [];
    let isSyncing = false;

    // ============================================
    // OFFLINE QUEUE SYSTEM
    // ============================================
    const OFFLINE_QUEUE_KEY = 'driverapp_offline_queue';

    const OfflineQueue = {
      // ‡πÇ‡∏´‡∏•‡∏î queue ‡∏à‡∏≤‡∏Å localStorage
      load() {
        try {
          const stored = localStorage.getItem(OFFLINE_QUEUE_KEY);
          offlineQueue = stored ? JSON.parse(stored) : [];
          this.updateUI();
          console.log('üì¶ Loaded offline queue:', offlineQueue.length, 'items');
        } catch (err) {
          console.error('Failed to load offline queue:', err);
          offlineQueue = [];
        }
      },

      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å queue ‡∏•‡∏á localStorage
      save() {
        try {
          localStorage.setItem(OFFLINE_QUEUE_KEY, JSON.stringify(offlineQueue));
          this.updateUI();
        } catch (err) {
          console.error('Failed to save offline queue:', err);
        }
      },

      // ‡πÄ‡∏û‡∏¥‡πà‡∏° action ‡πÄ‡∏Ç‡πâ‡∏≤ queue
      add(action) {
        const queueItem = {
          id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
          type: action.type,
          data: action.data,
          timestamp: new Date().toISOString(),
          retries: 0
        };
        offlineQueue.push(queueItem);
        this.save();
        console.log('üì• Added to offline queue:', queueItem.type);
        return queueItem;
      },

      // ‡∏•‡∏ö item ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å queue
      remove(id) {
        offlineQueue = offlineQueue.filter(item => item.id !== id);
        this.save();
      },

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï retry count
      incrementRetry(id) {
        const item = offlineQueue.find(i => i.id === id);
        if (item) {
          item.retries++;
          this.save();
        }
      },

      // ‡∏î‡∏∂‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô items ‡πÉ‡∏ô queue
      getCount() {
        return offlineQueue.length;
      },

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô queue
      updateUI() {
        const badge = document.getElementById('queueBadge');
        const count = this.getCount();
        if (badge) {
          if (count > 0) {
            badge.textContent = count + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏™‡πà‡∏á';
            badge.style.display = 'inline';
          } else {
            badge.style.display = 'none';
          }
        }
      },

      // Sync queue ‡πÄ‡∏°‡∏∑‡πà‡∏≠ online
      async sync() {
        if (isSyncing || !isOnline || offlineQueue.length === 0) return;

        isSyncing = true;
        console.log('üîÑ Starting offline queue sync...');

        const itemsToSync = [...offlineQueue];
        let successCount = 0;
        let failCount = 0;

        for (const item of itemsToSync) {
          if (!isOnline) break; // ‡∏´‡∏¢‡∏∏‡∏î‡∏ñ‡πâ‡∏≤ offline ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á

          try {
            const result = await this.processItem(item);
            if (result.success) {
              this.remove(item.id);
              successCount++;
              console.log('‚úÖ Synced:', item.type);
            } else {
              this.incrementRetry(item.id);
              failCount++;
              console.warn('‚ö†Ô∏è Failed to sync:', item.type, result.message);

              // ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏ñ‡πâ‡∏≤ retry ‡πÄ‡∏Å‡∏¥‡∏ô 5 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á
              if (item.retries >= 5) {
                this.remove(item.id);
                console.error('‚ùå Removed after 5 retries:', item.type);
              }
            }
          } catch (err) {
            this.incrementRetry(item.id);
            failCount++;
            console.error('‚ùå Sync error:', err);
          }
        }

        isSyncing = false;

        if (successCount > 0 || failCount > 0) {
          this.showSyncResult(successCount, failCount);
        }

        // Refresh data ‡∏ñ‡πâ‡∏≤ sync ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
        if (successCount > 0 && currentReference) {
          search(true);
        }
      },

      // Process ‡πÅ‡∏ï‡πà‡∏•‡∏∞ item ‡πÉ‡∏ô queue
      async processItem(item) {
        switch (item.type) {
          case 'updateStop':
            return await SupabaseAPI.updateStop(item.data);
          case 'uploadAlcohol':
            return await SupabaseAPI.uploadAlcohol(item.data);
          case 'closeJob':
            return await SupabaseAPI.closeJob(item.data);
          case 'endTrip':
            return await SupabaseAPI.endTrip(item.data);
          default:
            return { success: false, message: 'Unknown action type' };
        }
      },

      // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£ sync
      showSyncResult(success, fail) {
        if (success > 0 && fail === 0) {
          showInlineFlexCustom('sync', `‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${success} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡∏ì‡∏∞‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
        } else if (success > 0 && fail > 0) {
          showInlineFlexCustom('sync', `‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${success} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, `‡∏¢‡∏±‡∏á‡∏°‡∏µ ${fail} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏™‡πà‡∏á`);
        } else if (fail > 0) {
          showInlineFlexCustom('error', '‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', `${fail} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏™‡πà‡∏á‡πÉ‡∏´‡∏°‡πà`);
        }
      },

      // ‡∏•‡πâ‡∏≤‡∏á queue ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö debug)
      clear() {
        offlineQueue = [];
        this.save();
        console.log('üóëÔ∏è Offline queue cleared');
      }
    };

    // Helper: Queue action ‡∏´‡∏£‡∏∑‡∏≠ execute ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ñ‡πâ‡∏≤ online
    async function executeOrQueue(actionType, data, executeFn) {
      if (isOnline) {
        try {
          return await executeFn();
        } catch (err) {
          // ‡∏ñ‡πâ‡∏≤ fail ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô network error ‡πÉ‡∏´‡πâ queue ‡πÑ‡∏ß‡πâ
          if (err.message.includes('network') || err.message.includes('fetch') || !navigator.onLine) {
            isOnline = false;
            document.getElementById('offlineBar').classList.add('show');
            const queueItem = OfflineQueue.add({ type: actionType, data: data });
            return {
              success: true,
              queued: true,
              message: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡∏à‡∏∞‡∏™‡πà‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì',
              queueId: queueItem.id
            };
          }
          throw err;
        }
      } else {
        // Offline: queue ‡πÑ‡∏ß‡πâ
        const queueItem = OfflineQueue.add({ type: actionType, data: data });
        return {
          success: true,
          queued: true,
          message: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡∏à‡∏∞‡∏™‡πà‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì',
          queueId: queueItem.id
        };
      }
    }

    // ============================================
    // SUPABASE API FUNCTIONS (Using Edge Functions)
    // ============================================
    const SupabaseAPI = {
      // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å reference - ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ú‡πà‡∏≤‡∏ô Edge Function
      async search(reference, userId) {
        console.log('üîç API: Searching for', reference);
        return await EdgeFunctionsAPI.searchJob(reference, userId);
      },

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ stop - ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ú‡πà‡∏≤‡∏ô Edge Function
      async updateStop(params) {
        console.log('üîÑ API: Updating stop', params.rowIndex, params.type);
        return await EdgeFunctionsAPI.updateStop(params);
      },

      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå - ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ú‡πà‡∏≤‡∏ô Edge Function
      async uploadAlcohol(params) {
        console.log('üç∫ API: Uploading alcohol check for', params.driverName);
        return await EdgeFunctionsAPI.uploadAlcohol(params);
      },

      // ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô - ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ú‡πà‡∏≤‡∏ô Edge Function
      async closeJob(params) {
        console.log('üìã API: Closing job', params.reference);
        return await EdgeFunctionsAPI.closeJob(params);
      },

      // ‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ - ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ú‡πà‡∏≤‡∏ô Edge Function
      async endTrip(params) {
        console.log('üèÅ API: Ending trip', params.reference);
        return await EdgeFunctionsAPI.endTrip(params);
      },

      // Subscribe to realtime updates
      subscribeToJob(reference, onUpdate) {
        console.log('üì° Supabase: Subscribing to realtime updates for', reference);

        // Unsubscribe from previous subscription
        if (realtimeSubscription) {
          realtimeSubscription.unsubscribe();
        }

        realtimeSubscription = supabase
          .channel('jobdata-changes')
          .on(
            'postgres_changes',
            {
              event: '*',
              schema: 'public',
              table: 'jobdata',
              filter: `reference=eq.${reference}`
            },
            (payload) => {
              console.log('üì° Realtime update received:', payload);
              onUpdate(payload);
            }
          )
          .subscribe();

        return realtimeSubscription;
      }
    };

    // Helper: Base64 decode for storage upload
    function decode(base64) {
      const binaryString = atob(base64);
      const bytes = new Uint8Array(binaryString.length);
      for (let i = 0; i < binaryString.length; i++) {
        bytes[i] = binaryString.charCodeAt(i);
      }
      return bytes;
    }

    function getSuccessMessage(type) {
      const messages = {
        checkin: 'Check-in ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
        checkout: 'Check-out ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
        fuel: '‡∏•‡∏á‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
        unload: '‡∏•‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'
      };
      return messages[type] || '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
    }

    // ============================================
    // INPUT VALIDATION
    // ============================================
    const ValidationRules = {
      reference: {
        pattern: /^[a-zA-Z0-9\-_]+$/,
        minLength: 3,
        maxLength: 50,
        messages: {
          required: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç Reference',
          pattern: '‡πÄ‡∏•‡∏Ç Reference ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ‡∏´‡∏£‡∏∑‡∏≠ - _ ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô',
          minLength: '‡πÄ‡∏•‡∏Ç Reference ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 3 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£',
          maxLength: '‡πÄ‡∏•‡∏Ç Reference ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 50 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£'
        }
      },
      odo: {
        pattern: /^\d+$/,
        min: 0,
        max: 9999999,
        messages: {
          pattern: '‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô',
          range: '‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 0-9,999,999'
        }
      },
      alcohol: {
        pattern: /^\d+(\.\d{1,3})?$/,
        min: 0,
        max: 5,
        messages: {
          pattern: '‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç',
          range: '‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 0-5'
        }
      }
    };

    function sanitizeInput(str) {
      if (str === null || str === undefined) return '';
      return String(str).trim().replace(/[<>"'`]/g, '').replace(/javascript:/gi, '').replace(/on\w+=/gi, '');
    }

    function validateInput(value, ruleName) {
      const rule = ValidationRules[ruleName];
      if (!rule) return { valid: true };

      const sanitized = sanitizeInput(value);

      if (!sanitized && rule.messages.required) {
        return { valid: false, message: rule.messages.required };
      }

      if (!sanitized) return { valid: true, value: sanitized };

      if (rule.minLength && sanitized.length < rule.minLength) {
        return { valid: false, message: rule.messages.minLength };
      }

      if (rule.maxLength && sanitized.length > rule.maxLength) {
        return { valid: false, message: rule.messages.maxLength };
      }

      if (rule.pattern && !rule.pattern.test(sanitized)) {
        return { valid: false, message: rule.messages.pattern };
      }

      if (rule.min !== undefined || rule.max !== undefined) {
        const num = parseFloat(sanitized);
        if (isNaN(num) || num < rule.min || num > rule.max) {
          return { valid: false, message: rule.messages.range };
        }
      }

      return { valid: true, value: sanitized };
    }

    function showInputError(inputId, errorId, message) {
      const input = document.getElementById(inputId);
      const errorEl = document.getElementById(errorId);
      if (input) input.classList.add('input-error');
      if (errorEl) {
        errorEl.textContent = message;
        errorEl.classList.add('show');
      }
    }

    function clearInputError(inputId, errorId) {
      const input = document.getElementById(inputId);
      const errorEl = document.getElementById(errorId);
      if (input) input.classList.remove('input-error');
      if (errorEl) {
        errorEl.textContent = '';
        errorEl.classList.remove('show');
      }
    }

    // ============================================
    // RETRY LOGIC
    // ============================================
    async function withRetry(fn, options = {}) {
      const { maxRetries = 3, delay = 1000, backoff = 2, onRetry = null } = options;
      let lastError;

      for (let attempt = 1; attempt <= maxRetries; attempt++) {
        try {
          return await fn();
        } catch (err) {
          lastError = err;
          console.warn(`Attempt ${attempt}/${maxRetries} failed:`, err.message);

          if (attempt < maxRetries) {
            const waitTime = delay * Math.pow(backoff, attempt - 1);
            if (onRetry) onRetry(attempt, waitTime, err);
            await new Promise(resolve => setTimeout(resolve, waitTime));
          }
        }
      }

      throw lastError;
    }

    // ============================================
    // SKELETON LOADING
    // ============================================
    function showSkeleton() {
      document.getElementById('summarySkeleton').classList.remove('hidden');
      document.getElementById('timelineSkeleton').classList.remove('hidden');
      document.getElementById('summary').classList.add('hidden');
      document.getElementById('timelineContainer').classList.add('hidden');
    }

    function hideSkeleton() {
      document.getElementById('summarySkeleton').classList.add('hidden');
      document.getElementById('timelineSkeleton').classList.add('hidden');
    }

    // ============================================
    // UI HELPER FUNCTIONS
    // ============================================
    function escapeHtml(str) {
      if (str === null || str === undefined) return '';
      return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
    }

    function showLoading(msg) {
      Swal.fire({ title: msg || '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
    }

    function closeLoading() {
      Swal.close();
    }

    function showError(msg) {
      Swal.fire({ icon: 'error', title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text: msg, confirmButtonColor: '#1abc9c' });
    }

    function showSuccess(title, text) {
      return Swal.fire({ icon: 'success', title: title, text: text, confirmButtonColor: '#1abc9c' });
    }

    function showInfo(title, text) {
      Swal.fire({ icon: 'info', title: title, text: text, confirmButtonColor: '#1abc9c' });
    }

    function showInlineFlex(type, stopInfo) {
      const el = document.getElementById('inlineFlex');
      const titleEl = document.getElementById('inlineFlexTitle');
      const mainEl = document.getElementById('inlineFlexMain');
      const subEl = document.getElementById('inlineFlexSub');

      if (inlineFlexTimer) clearTimeout(inlineFlexTimer);

      const titles = {
        checkin: '‚úÖ Check-in ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
        checkout: '‚úÖ Check-out ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
        fuel: '‚õΩ ‡∏•‡∏á‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
        unload: 'üì¶ ‡∏•‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
        closejob: 'üèÅ ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'
      };

      titleEl.textContent = titles[type] || '‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
      mainEl.textContent = stopInfo.shipToName || currentReference;
      subEl.textContent = new Date().toLocaleTimeString('th-TH');

      el.classList.remove('hidden', 'hide');
      el.classList.add('show');

      inlineFlexTimer = setTimeout(() => {
        el.classList.remove('show');
        el.classList.add('hide');
        setTimeout(() => el.classList.add('hidden'), 300);
      }, 4000);
    }

    function showInlineFlexCustom(type, title, subtitle) {
      const el = document.getElementById('inlineFlex');
      const titleEl = document.getElementById('inlineFlexTitle');
      const mainEl = document.getElementById('inlineFlexMain');
      const subEl = document.getElementById('inlineFlexSub');

      if (inlineFlexTimer) clearTimeout(inlineFlexTimer);

      const icons = {
        sync: 'üîÑ',
        queued: 'üì•',
        error: '‚ö†Ô∏è',
        success: '‚úÖ',
        offline: 'üìµ'
      };

      titleEl.textContent = (icons[type] || 'üìå') + ' ' + title;
      mainEl.textContent = subtitle || '';
      subEl.textContent = new Date().toLocaleTimeString('th-TH');

      el.classList.remove('hidden', 'hide');
      el.classList.add('show');

      inlineFlexTimer = setTimeout(() => {
        el.classList.remove('show');
        el.classList.add('hide');
        setTimeout(() => el.classList.add('hidden'), 300);
      }, 4000);
    }

    // ============================================
    // GPS FUNCTIONS
    // ============================================
    function getCurrentPositionAsync() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
          reject(new Error('Geolocation not supported'));
          return;
        }
        navigator.geolocation.getCurrentPosition(resolve, reject, {
          enableHighAccuracy: true,
          timeout: 15000,
          maximumAge: 0
        });
      });
    }

    function checkGpsStatus() {
      const statusEl = document.getElementById('gpsStatus');
      const textEl = document.getElementById('gpsText');
      const accuracyEl = document.getElementById('gpsAccuracy');
      const bars = statusEl.querySelectorAll('.gps-bar');

      statusEl.className = 'gps-status checking';
      textEl.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö GPS...';
      accuracyEl.textContent = '';
      bars.forEach(b => b.classList.remove('active'));

      getCurrentPositionAsync()
        .then(pos => {
          const accuracy = pos.coords.accuracy;
          let status, text, activeBars;

          if (accuracy <= 20) {
            status = 'good'; text = 'GPS ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥)'; activeBars = 4;
          } else if (accuracy <= 50) {
            status = 'good'; text = 'GPS ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô'; activeBars = 3;
          } else if (accuracy <= 100) {
            status = 'weak'; text = '‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì GPS ‡∏≠‡πà‡∏≠‡∏ô'; activeBars = 2;
          } else {
            status = 'weak'; text = '‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì GPS ‡∏≠‡πà‡∏≠‡∏ô‡∏°‡∏≤‡∏Å'; activeBars = 1;
          }

          statusEl.className = 'gps-status ' + status;
          textEl.textContent = text;
          accuracyEl.textContent = '¬±' + Math.round(accuracy) + 'm';
          bars.forEach((b, i) => { if (i < activeBars) b.classList.add('active'); });
        })
        .catch(err => {
          statusEl.className = 'gps-status error';
          textEl.textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á GPS';
          accuracyEl.textContent = '';
        });
    }

    // ============================================
    // MAIN FUNCTIONS
    // ============================================
    async function search(isSilent = false) {
      const keywordRaw = document.getElementById('keyword').value;
      const btn = document.getElementById('btnSearch');

      // Clear previous errors
      clearInputError('keyword', 'keywordError');

      // Validate input
      const validation = validateInput(keywordRaw, 'reference');
      if (!validation.valid) {
        showInputError('keyword', 'keywordError', validation.message);
        return;
      }

      const keyword = validation.value || sanitizeInput(keywordRaw);

      if (!keyword) {
        showInputError('keyword', 'keywordError', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç Reference');
        return;
      }

      btn.disabled = true;

      // Show skeleton for non-silent searches
      if (!isSilent) {
        showSkeleton();
      }

      try {
        // Use retry logic for API call
        const result = await withRetry(
          () => SupabaseAPI.search(keyword, currentUserId),
          {
            maxRetries: 3,
            delay: 1000,
            backoff: 1.5,
            onRetry: (attempt, waitTime) => {
              console.log(`üîÑ Retry ${attempt}, waiting ${waitTime}ms...`);
            }
          }
        );

        if (!isSilent) hideSkeleton();

        if (!result.success) {
          clearResult();
          showError(result.message);
          return;
        }

        const d = result.data;
        lastStops = d.stops || [];
        currentReference = d.referenceNo || keyword;
        localStorage.setItem('last_reference', currentReference);
        currentVehicleDesc = d.vehicleDesc || '';
        currentDrivers = d.alcohol?.drivers || [];
        currentCheckedDrivers = [...new Set(d.alcohol?.checkedDrivers || [])];
        alcoholAllDone = currentDrivers.length > 0 && currentDrivers.every(n => currentCheckedDrivers.includes(n));
        jobClosed = !!d.jobClosed;
        tripEnded = !!d.tripEnded;

        renderSummary(d);
        renderAlcoholSection();
        renderTimeline(lastStops);
        recordLastUpdated();

        // Subscribe to realtime updates
        SupabaseAPI.subscribeToJob(currentReference, (payload) => {
          console.log('üì° Realtime update, refreshing...');
          search(true);
        });

      } catch (err) {
        console.error(err);
        if (!isSilent) hideSkeleton();
        showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Supabase (‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)');
      } finally {
        btn.disabled = false;
      }
    }

    function clearResult() {
      document.getElementById('summary').classList.add('hidden');
      document.getElementById('timelineContainer').classList.add('hidden');
      document.getElementById('summary').innerHTML = '';
      document.getElementById('timeline').innerHTML = '';
      document.getElementById('closeJobContainer').classList.add('hidden');
      document.getElementById('alcoholContainer').classList.add('hidden');
      hideSkeleton();
      lastStops = [];
      currentDrivers = [];
      currentCheckedDrivers = [];
      alcoholAllDone = false;
      jobClosed = false;
      tripEnded = false;
      hideLastUpdatedContainer();

      if (realtimeSubscription) {
        realtimeSubscription.unsubscribe();
        realtimeSubscription = null;
      }
    }

    function renderSummary(d) {
      const summaryEl = document.getElementById('summary');
      const stops = d.stops || [];
      const totalQtyAll = stops.reduce((acc, s) => acc + (s.totalQty || 0), 0);

      summaryEl.innerHTML = `
        <div class="summary-row"><span class="summary-label">Reference</span><span class="summary-value">${escapeHtml(d.referenceNo)}</span></div>
        <div class="summary-row"><span class="summary-label">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏ñ</span><span class="summary-value">${escapeHtml(d.vehicleDesc) || '-'}</span></div>
        <div class="summary-row"><span class="summary-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á</span><span class="summary-value">${stops.length} ‡∏à‡∏∏‡∏î</span></div>
        <div class="summary-row"><span class="summary-label">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏£‡∏ß‡∏°</span><span class="summary-value">${totalQtyAll || 0}</span></div>
      `;
      summaryEl.classList.remove('hidden');
    }

    function renderAlcoholSection() {
      const container = document.getElementById('alcoholContainer');
      if (!currentDrivers || currentDrivers.length === 0) {
        container.classList.add('hidden');
        return;
      }

      let html = `<div style="font-weight:600;margin-bottom:4px;">‡πÄ‡∏õ‡πà‡∏≤‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô</div>`;

      currentDrivers.forEach(name => {
        const checked = currentCheckedDrivers.includes(name);
        const displayName = escapeHtml(name);
        const jsName = escapeHtml(name.replace(/\\/g, '\\\\').replace(/'/g, "\\'"));

        html += `<div style="margin-bottom:4px;display:flex;justify-content:space-between;align-items:center;">
          <span>${displayName}</span>
          ${checked
            ? '<button class="btn-small btn-secondary" disabled>‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>'
            : `<button class="btn-small btn-outline" onclick="doAlcoholCheck('${jsName}')">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå</button>`
          }
        </div>`;
      });

      container.innerHTML = html;
      container.classList.remove('hidden');
    }

    function renderTimeline(stops) {
      const container = document.getElementById('timelineContainer');
      const ul = document.getElementById('timeline');
      const closeJobContainer = document.getElementById('closeJobContainer');
      const btnCloseJob = document.getElementById('btnCloseJob');
      const btnEndTrip = document.getElementById('btnEndTrip');

      ul.innerHTML = '';
      closeJobContainer.classList.add('hidden');
      if (btnCloseJob) { btnCloseJob.style.display = 'none'; btnCloseJob.disabled = true; }
      if (btnEndTrip) { btnEndTrip.style.display = 'none'; btnEndTrip.disabled = true; }

      if (!stops || stops.length === 0) {
        container.classList.add('hidden');
        return;
      }

      let allCheckout = true;

      stops.forEach(stop => {
        const hasCheckIn = !!stop.checkInTime;
        const hasCheckOut = !!stop.checkOutTime;
        const isOrigin = !!stop.isOriginStop;

        if (!hasCheckOut) allCheckout = false;

        let btnHtml = '';
        if (isOrigin) {
          if (!hasCheckIn) {
            btnHtml += `<button class="btn-small btn-outline" onclick="startCheckin(${stop.rowIndex}, ${stop.seq})">Check-in</button>`;
          } else if (!hasCheckOut) {
            btnHtml += `<button class="btn-small" onclick="startCheckout(${stop.rowIndex}, ${stop.seq})">Check-out</button>`;
          }
        } else {
          if (!hasCheckIn) {
            btnHtml += `<button class="btn-small btn-outline" onclick="startCheckin(${stop.rowIndex}, ${stop.seq})">Check-in</button>`;
          } else if (!hasCheckOut) {
            if (!stop.fuelingTime) btnHtml += `<button class="btn-small btn-outline" onclick="doFuel(${stop.rowIndex}, ${stop.seq})">‡∏•‡∏á‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô</button>`;
            if (!stop.unloadDoneTime) btnHtml += `<button class="btn-small btn-outline" onclick="doUnload(${stop.rowIndex}, ${stop.seq})">‡∏•‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à</button>`;
            btnHtml += `<button class="btn-small" onclick="startCheckout(${stop.rowIndex}, ${stop.seq})">Check-out</button>`;
          }
        }

        if (stop.destLat && stop.destLng) {
          btnHtml += `<button class="btn-nav" onclick="navigateToStop(${stop.rowIndex})">üß≠</button>`;
        }

        const li = document.createElement('li');
        li.className = 'timeline-item';
        li.innerHTML = `
          <div class="timeline-marker"></div>
          <div class="timeline-content">
            <div class="timeline-header-row">
              <span class="timeline-stop-label">‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà ${stop.seq}</span>
              <span class="timeline-status">${escapeHtml(stop.status) || '-'}</span>
            </div>
            <div class="timeline-sub">${escapeHtml(stop.shipToName) || '-'}</div>
            ${stop.materials ? `<div class="materials-text">${escapeHtml(stop.materials)}</div>` : ''}
            <div class="action-row">${btnHtml}</div>
          </div>
        `;
        ul.appendChild(li);
      });

      container.classList.remove('hidden');

      // Show close/end buttons
      if (allCheckout && !jobClosed && !tripEnded) {
        closeJobContainer.classList.remove('hidden');
        if (btnCloseJob) { btnCloseJob.style.display = 'block'; btnCloseJob.disabled = false; }
      } else if (jobClosed && !tripEnded) {
        closeJobContainer.classList.remove('hidden');
        if (btnEndTrip) { btnEndTrip.style.display = 'block'; btnEndTrip.disabled = false; }
      }
    }

    // ============================================
    // ACTION FUNCTIONS
    // ============================================
    async function startCheckin(rowIndex, seq) {
      const stop = lastStops.find(s => s.rowIndex === rowIndex);
      const isOrigin = stop && stop.isOriginStop;

      if (isOrigin) {
        await updateStopStatus(rowIndex, 'CHECKIN', 'checkin', seq);
      } else {
        const { value: formValues } = await Swal.fire({
          icon: 'question',
          title: 'Check-in ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
          html: `
            <div style="text-align:left;">
              <label style="font-size:0.8rem;color:#555;">‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡∏£‡∏ñ</label>
              <input id="swalOdo" type="number" class="swal2-input" placeholder="‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå">
              <label style="font-size:0.8rem;color:#555;">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô</label>
              <input id="swalReceiverName" type="text" class="swal2-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö">
            </div>
          `,
          showCancelButton: true,
          confirmButtonText: 'Check-in',
          cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
          confirmButtonColor: '#1abc9c',
          preConfirm: () => ({
            odo: document.getElementById('swalOdo').value,
            receiverName: document.getElementById('swalReceiverName').value
          })
        });

        if (!formValues) return;

        // Validate odo if provided
        if (formValues.odo) {
          const odoValidation = validateInput(formValues.odo, 'odo');
          if (!odoValidation.valid) {
            showError(odoValidation.message);
            return;
          }
        }

        await updateStopStatus(rowIndex, 'CHECKIN', 'checkin', seq, formValues.odo, formValues.receiverName);
      }
    }

    async function startCheckout(rowIndex, seq) {
      const stop = lastStops.find(s => s.rowIndex === rowIndex);
      const isOrigin = stop && stop.isOriginStop;

      if (isOrigin) {
        await updateStopStatus(rowIndex, 'CHECKOUT', 'checkout', seq);
      } else {
        const { value: formValues } = await Swal.fire({
          icon: 'question',
          title: 'Check-out ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
          html: `
            <div style="text-align:left;">
              <label><input type="checkbox" id="swalPumping"> ‡∏°‡∏µ‡∏õ‡∏±‡πà‡∏ô‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô</label><br>
              <label><input type="checkbox" id="swalTransfer"> ‡∏°‡∏µ‡πÇ‡∏¢‡∏Å‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô</label>
            </div>
          `,
          showCancelButton: true,
          confirmButtonText: 'Check-out',
          cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
          confirmButtonColor: '#1abc9c',
          preConfirm: () => ({
            hasPumping: document.getElementById('swalPumping').checked ? 'yes' : 'no',
            hasTransfer: document.getElementById('swalTransfer').checked ? 'yes' : 'no'
          })
        });

        if (!formValues) return;
        await updateStopStatus(rowIndex, 'CHECKOUT', 'checkout', seq, null, null, null, formValues.hasPumping, formValues.hasTransfer);
      }
    }

    async function doFuel(rowIndex, seq) {
      await updateStopStatus(rowIndex, 'FUELING', 'fuel', seq);
    }

    async function doUnload(rowIndex, seq) {
      await updateStopStatus(rowIndex, 'UNLOAD_DONE', 'unload', seq);
    }

    async function updateStopStatus(rowIndex, newStatus, type, seq, odo, receiverName, receiverType, hasPumping, hasTransfer) {
      if (!currentUserId) {
        showError('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ');
        return;
      }

      try {
        showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS...');
        const pos = await getCurrentPositionAsync();
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;

        const stopData = {
          rowIndex, status: newStatus, type, userId: currentUserId,
          lat, lng, odo: odo ? sanitizeInput(odo) : null,
          receiverName: receiverName ? sanitizeInput(receiverName) : null,
          receiverType, hasPumping, hasTransfer
        };

        showLoading(isOnline ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞...' : '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');

        const result = await executeOrQueue(
          'updateStop',
          stopData,
          () => withRetry(
            () => SupabaseAPI.updateStop(stopData),
            { maxRetries: 3, delay: 1000, backoff: 1.5 }
          )
        );

        closeLoading();

        if (!result.success) {
          showError(result.message);
          return;
        }

        // Handle queued response
        if (result.queued) {
          const stop = lastStops.find(s => s.rowIndex === rowIndex);
          showInlineFlexCustom('queued', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß', `${stop?.shipToName || '‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà ' + seq} - ‡∏à‡∏∞‡∏™‡πà‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå`);
          await showSuccess('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß', '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì');
          return;
        }

        if (result.stop) {
          showInlineFlex(type, result.stop);
        }

        await showSuccess('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', result.message);
        if (currentReference) search(true);

      } catch (err) {
        closeLoading();
        showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message);
      }
    }

    async function doAlcoholCheck(driverName) {
      const { value: formValues } = await Swal.fire({
        title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå',
        html: `
          <div style="text-align:left;">
            <label>‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö</label>
            <input id="swalDriver" type="text" class="swal2-input" value="${escapeHtml(driverName)}" readonly>
            <label>‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå</label>
            <input id="swalAlcohol" type="number" step="0.001" class="swal2-input" placeholder="0.000">
            <label>‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô</label>
            <input id="swalImage" type="file" accept="image/*" capture="environment" class="swal2-input">
          </div>
        `,
        showCancelButton: true,
        confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
        confirmButtonColor: '#1abc9c',
        preConfirm: () => {
          const val = document.getElementById('swalAlcohol').value;
          const file = document.getElementById('swalImage').files[0];
          if (!val) { Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå'); return false; }
          if (!file) { Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô'); return false; }
          return { alcoholValue: val, file };
        }
      });

      if (!formValues) return;

      try {
        showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î...');
        const pos = await getCurrentPositionAsync();

        showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...');
        const base64 = await fileToBase64(formValues.file);

        // Validate alcohol value
        const alcoholValidation = validateInput(formValues.alcoholValue, 'alcohol');
        if (!alcoholValidation.valid) {
          closeLoading();
          showError(alcoholValidation.message);
          return;
        }

        const alcoholData = {
          reference: currentReference,
          driverName: sanitizeInput(driverName),
          userId: currentUserId,
          alcoholValue: alcoholValidation.value,
          imageBase64: base64,
          lat: pos.coords.latitude,
          lng: pos.coords.longitude
        };

        const result = await executeOrQueue(
          'uploadAlcohol',
          alcoholData,
          () => withRetry(
            () => SupabaseAPI.uploadAlcohol(alcoholData),
            { maxRetries: 3, delay: 1000, backoff: 1.5 }
          )
        );

        closeLoading();

        if (!result.success) {
          showError(result.message);
          return;
        }

        // Handle queued response
        if (result.queued) {
          showInlineFlexCustom('queued', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß', `${driverName} - ‡∏à‡∏∞‡∏™‡πà‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå`);
          await showSuccess('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß', '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì');
          return;
        }

        currentCheckedDrivers = result.checkedDrivers || [];
        renderAlcoholSection();
        showSuccess('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');

      } catch (err) {
        closeLoading();
        showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message);
      }
    }

    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    async function closeJob() {
      if (!currentReference) {
        showInfo('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏•‡∏Ç‡∏á‡∏≤‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô');
        return;
      }

      const { value: formValues } = await Swal.fire({
        icon: 'question',
        title: '‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô',
        html: `
          <div style="text-align:left;">
            <label><input type="radio" name="vehicleStatus" value="ready" checked> ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô</label><br>
            <label><input type="radio" name="vehicleStatus" value="maintenance"> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á</label><br><br>
            <label><input type="checkbox" id="hillFee"> ‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏Ç‡∏≤</label><br>
            <label><input type="checkbox" id="bkkFee"> ‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ ‡∏Å‡∏ó‡∏°</label><br>
            <label><input type="checkbox" id="repairFee"> ‡∏ô‡∏≥‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ã‡πà‡∏≠‡∏°</label>
          </div>
        `,
        showCancelButton: true,
        confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô',
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
        confirmButtonColor: '#1abc9c',
        preConfirm: () => ({
          vehicleStatus: document.querySelector('input[name="vehicleStatus"]:checked').value,
          hillFee: document.getElementById('hillFee').checked ? 'yes' : 'no',
          bkkFee: document.getElementById('bkkFee').checked ? 'yes' : 'no',
          repairFee: document.getElementById('repairFee').checked ? 'yes' : 'no'
        })
      });

      if (!formValues) return;

      try {
        showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô...');

        const closeJobData = {
          reference: currentReference,
          userId: currentUserId,
          vehicleStatus: formValues.vehicleStatus,
          vehicleDesc: currentVehicleDesc,
          hillFee: formValues.hillFee,
          bkkFee: formValues.bkkFee,
          repairFee: formValues.repairFee
        };

        const result = await executeOrQueue(
          'closeJob',
          closeJobData,
          () => withRetry(
            () => SupabaseAPI.closeJob(closeJobData),
            { maxRetries: 3, delay: 1000, backoff: 1.5 }
          )
        );

        closeLoading();

        if (!result.success) {
          showError(result.message);
          return;
        }

        // Handle queued response
        if (result.queued) {
          showInlineFlexCustom('queued', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß', `‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô ${currentReference} - ‡∏à‡∏∞‡∏™‡πà‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå`);
          await showSuccess('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß', '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì');
          return;
        }

        jobClosed = true;
        await showSuccess('‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
        if (currentReference) search(true);

      } catch (err) {
        closeLoading();
        showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message);
      }
    }

    async function openEndTripDialog() {
      if (!currentReference) {
        showInfo('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏•‡∏Ç‡∏á‡∏≤‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô');
        return;
      }

      const { value: formValues } = await Swal.fire({
        title: '‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ',
        html: `
          <div style="text-align:left;">
            <label>‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ</label>
            <input id="swalEndOdo" type="number" class="swal2-input" placeholder="‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå">
            <label>‡∏à‡∏∏‡∏î‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ</label>
            <input id="swalEndPoint" type="text" class="swal2-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà">
          </div>
        `,
        showCancelButton: true,
        confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ',
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
        confirmButtonColor: '#1abc9c',
        preConfirm: () => ({
          endOdo: document.getElementById('swalEndOdo').value,
          endPointName: document.getElementById('swalEndPoint').value
        })
      });

      if (!formValues) return;

      try {
        showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î...');
        const pos = await getCurrentPositionAsync();

        // Validate odo if provided
        if (formValues.endOdo) {
          const odoValidation = validateInput(formValues.endOdo, 'odo');
          if (!odoValidation.valid) {
            showError(odoValidation.message);
            return;
          }
        }

        showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ...');

        const endTripData = {
          reference: currentReference,
          userId: currentUserId,
          endOdo: formValues.endOdo ? sanitizeInput(formValues.endOdo) : null,
          endPointName: sanitizeInput(formValues.endPointName),
          lat: pos.coords.latitude,
          lng: pos.coords.longitude
        };

        const result = await executeOrQueue(
          'endTrip',
          endTripData,
          () => withRetry(
            () => SupabaseAPI.endTrip(endTripData),
            { maxRetries: 3, delay: 1000, backoff: 1.5 }
          )
        );

        closeLoading();

        if (!result.success) {
          showError(result.message);
          return;
        }

        // Handle queued response
        if (result.queued) {
          showInlineFlexCustom('queued', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß', `‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ ${currentReference} - ‡∏à‡∏∞‡∏™‡πà‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå`);
          await showSuccess('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß', '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì');
          const closeJobContainer = document.getElementById('closeJobContainer');
          if (closeJobContainer) closeJobContainer.classList.add('hidden');
          return;
        }

        tripEnded = true;
        await showSuccess('‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');

        const closeJobContainer = document.getElementById('closeJobContainer');
        if (closeJobContainer) closeJobContainer.classList.add('hidden');

      } catch (err) {
        closeLoading();
        showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message);
      }
    }

    function navigateToStop(rowIndex) {
      const stop = lastStops.find(s => s.rowIndex === rowIndex);
      if (!stop || !stop.destLat || !stop.destLng) {
        showInfo('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î', '‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö');
        return;
      }
      window.open(`https://www.google.com/maps?q=${stop.destLat},${stop.destLng}`, '_blank');
    }

    // ============================================
    // UI UTILITIES
    // ============================================
    function recordLastUpdated() {
      const textEl = document.getElementById('lastUpdatedText');
      const container = document.getElementById('lastUpdatedContainer');
      if (textEl) textEl.textContent = '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ' + new Date().toLocaleTimeString('th-TH');
      if (container) container.classList.remove('hidden');
    }

    function hideLastUpdatedContainer() {
      const container = document.getElementById('lastUpdatedContainer');
      if (container) container.classList.add('hidden');
    }

    // Theme Toggle
    const THEME_KEY = 'driverapp_theme';
    function loadSavedTheme() {
      if (localStorage.getItem(THEME_KEY) === 'dark') {
        document.documentElement.setAttribute('data-theme', 'dark');
        document.getElementById('themeToggle').textContent = '‚òÄÔ∏è';
      }
    }

    function toggleTheme() {
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      if (isDark) {
        document.documentElement.removeAttribute('data-theme');
        localStorage.setItem(THEME_KEY, 'light');
        document.getElementById('themeToggle').textContent = 'üåô';
      } else {
        document.documentElement.setAttribute('data-theme', 'dark');
        localStorage.setItem(THEME_KEY, 'dark');
        document.getElementById('themeToggle').textContent = '‚òÄÔ∏è';
      }
    }

    // ============================================
    // INITIALIZATION
    // ============================================
    async function initApp() {
      loadSavedTheme();
      checkGpsStatus();

      // Load offline queue
      OfflineQueue.load();

      // Check network status
      window.addEventListener('online', () => {
        isOnline = true;
        document.getElementById('offlineBar').classList.remove('show');
        showInlineFlexCustom('success', '‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡πÅ‡∏•‡πâ‡∏ß', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà...');

        // Sync offline queue when back online
        setTimeout(() => {
          OfflineQueue.sync();
        }, 1000);
      });

      window.addEventListener('offline', () => {
        isOnline = false;
        document.getElementById('offlineBar').classList.add('show');
        showInlineFlexCustom('offline', '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï', '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå');
      });

      // Initialize LIFF
      console.log('üîÑ Initializing LIFF with ID:', LIFF_ID);
      
      try {
        // Check if liff is available
        if (typeof liff === 'undefined') {
          throw new Error('LIFF SDK not loaded');
        }

        await liff.init({ liffId: LIFF_ID });
        console.log('‚úÖ LIFF initialized');
        console.log('üì± Is in LINE client:', liff.isInClient());
        console.log('üîê Is logged in:', liff.isLoggedIn());

        if (liff.isLoggedIn()) {
          const profile = await liff.getProfile();
          currentUserId = profile.userId;
          document.getElementById('status').textContent = '‚úÖ ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ ' + profile.displayName;
          console.log('üë§ User Profile:', profile);
        } else {
          // Not logged in - try to login
          if (liff.isInClient()) {
            // In LINE app but not logged in
            currentUserId = 'test_user_' + Date.now();
            document.getElementById('status').textContent = '‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö LINE';
            console.log('‚ö†Ô∏è In LINE client but not logged in');
          } else {
            // Not in LINE app
            currentUserId = 'test_user_' + Date.now();
            document.getElementById('status').textContent = 'üß™ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö (‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô LINE)';
            console.log('üß™ Not in LINE client - using test mode');
          }
        }
      } catch (err) {
        console.error('‚ùå LIFF init error:', err);
        console.error('Error details:', {
          name: err.name,
          message: err.message,
          code: err.code
        });
        
        currentUserId = 'fallback_user_' + Date.now();
        
        // Show specific error message
        if (err.message.includes('LIFF SDK not loaded')) {
          document.getElementById('status').textContent = '‚ùå LIFF SDK ‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î';
        } else if (err.code === 'LIFF_ID_NOT_FOUND') {
          document.getElementById('status').textContent = '‚ùå LIFF ID ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
        } else if (err.code === 'UNAUTHORIZED') {
          document.getElementById('status').textContent = '‚ùå ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï';
        } else {
          document.getElementById('status').textContent = '‚ö†Ô∏è ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö (LIFF Error: ' + err.message + ')';
        }
      }

      // Load last reference
      const lastRef = localStorage.getItem('last_reference');
      if (lastRef) {
        document.getElementById('keyword').value = lastRef;
      }

      // Bind events
      document.getElementById('btnSearch').addEventListener('click', () => search());
      document.getElementById('keyword').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') search();
      });
      document.getElementById('btnCloseJob').addEventListener('click', closeJob);
      document.getElementById('btnEndTrip').addEventListener('click', openEndTripDialog);
      
      // Bind theme toggle
      document.getElementById('themeToggle').addEventListener('click', toggleTheme);
      
      // Bind GPS status check
      document.getElementById('gpsStatus').addEventListener('click', checkGpsStatus);

      // Sync queue if online and has pending items
      if (isOnline && OfflineQueue.getCount() > 0) {
        setTimeout(() => OfflineQueue.sync(), 2000);
      }
    }

    // Start the app
    initApp();
  </script>
</body>
</html>
