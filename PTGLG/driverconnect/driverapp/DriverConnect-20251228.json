{"files":[{"id":"4b350a77-aa8d-411f-9120-59e9c3179829","name":"appsscript","type":"json","source":"{\n  \"timeZone\": \"Asia/Bangkok\",\n  \"dependencies\": {},\n  \"exceptionLogging\": \"STACKDRIVER\",\n  \"runtimeVersion\": \"V8\",\n  \"webapp\": {\n    \"executeAs\": \"USER_DEPLOYING\",\n    \"access\": \"ANYONE_ANONYMOUS\"\n  }\n}"},{"id":"ed14aed1-0079-4868-b479-4b5bc41174ea","name":"config","type":"server_js","source":"/********************************\n * CONFIG: LINE / Main Sheet / zoile30Connect\n ********************************/\n\n// ‚ö†Ô∏è ‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö LINE Channel ‡∏Ç‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á\nconst CHANNEL_ACCESS_TOKEN \u003d \u0027pIIWCDW03mWrY683D6/JtnNdbnAfXiWl0H4w7lrk0QvPxyHltJ74cI6jNKA/5daA23tLBGCPKWI+IMKhikzs36WVSsXCAxB8Iwe4gCJOIjkb9fxIV5tis1xkKEBAYW2xjA2uP2ov7QuXUTEI+xVQAQdB04t89/1O/w1cDnyilFU\u003d\u0027;\nconst RICH_MENU_ID_MENU1   \u003d \u0027richmenu-555df05125d319eccec615b05f85dd65\u0027;\n\n// ‡πÑ‡∏ü‡∏•‡πå‡∏´‡∏•‡∏±‡∏Å (‡∏°‡∏µ register / userprofile / jobdata / Station / Origin / alcoholcheck)\nconst SHEET_ID             \u003d \u00271UK6pdRrCGEjXmdtGe2FeSFflSimz0JhhGxAei_OKyLU\u0027;\n\n// ‡πÑ‡∏ü‡∏•‡πå zoile30Connect (‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á shipment/reference/destination)\nconst ZOILE_SHEET_ID       \u003d \u00271iwPr3RSBUT4frRfyFJxW5C2qP-TPseEBW_80CDitbuE\u0027;\n\n// ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏π‡∏õ‡πÄ‡∏õ‡πà‡∏≤‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå (‡∏à‡∏≤‡∏Å Google Drive)\nconst ALC_PARENT_FOLDER_ID \u003d \u00271CMZBzQJ9to6TQKlx-Tp001Eq0sIbdy0P\u0027;\n\n/********************************\n * Sheet Names (Main)\n ********************************/\nconst SHEET_REGISTER       \u003d \u0027register\u0027;\nconst SHEET_USER_PROFILE   \u003d \u0027userprofile\u0027;\nconst SHEET_JOBDATA        \u003d \u0027jobdata\u0027;\nconst SHEET_STATION        \u003d \u0027Station\u0027;\nconst SHEET_ORIGIN         \u003d \u0027Origin\u0027;\nconst SHEET_ALCOHOL        \u003d \u0027alcoholcheck\u0027;  // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡πà‡∏≤‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå\nconst SHEET_REVIEW         \u003d \u0027reviewdata\u0027;    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô + ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô\nconst SHEET_ADMIN_LOG      \u003d \u0027adminlog\u0027;      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° admin\n\n// ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏ä‡∏µ‡∏ó Admin (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö isAdminUser / checkadmin)\nconst SHEET_ADMIN          \u003d \u0027userprofile\u0027;         // ‡∏ñ‡πâ‡∏≤‡∏ä‡∏µ‡∏ó‡∏Ñ‡∏∏‡∏ì‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà \"admin\" ‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ\n\n/********************************\n * userprofile column index (1-based)\n ********************************/\nconst COL_USER_ID      \u003d 1;  // A\nconst COL_DISPLAY_NAME \u003d 2;  // B\nconst COL_PICTURE_URL  \u003d 3;  // C\nconst COL_STATUS       \u003d 4;  // D\nconst COL_CREATED_AT   \u003d 5;  // E\nconst COL_UPDATED_AT   \u003d 6;  // F\n// G,H,I \u003d ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô\nconst COL_USERTYPE     \u003d 10; // J: usertype (ADMIN / DRIVER / ‡∏Ø‡∏•‡∏Ø)\n\n/********************************\n * zoile30Connect sheet names\n ********************************/\nconst ZOILE_SHEET_DATA  \u003d \u0027data\u0027;\nconst ZOILE_SHEET_INPUT \u003d \u0027InputZoile30\u0027;\n\n/********************************\n * zoile30Connect!data column index (1-based)\n * ‚ö†Ô∏è ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏Ñ‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏ä‡∏µ‡∏ó data ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏à‡∏£‡∏¥‡∏á\n ********************************/\n// A: Shipment No.\n// E: Driver Name\n// F: Distance\n// M: Reference\n// N: Ship to\n// O: Ship to Name\n// P: Material\n// Q: Material Desc\n// R: Delivery Qty\nconst Z_COL_SHIPMENT        \u003d 1;   // A\nconst Z_COL_DRIVER_NAME     \u003d 5;   // E\nconst Z_COL_DISTANCE        \u003d 6;   // F\nconst Z_COL_REFERENCE       \u003d 13;  // M\nconst Z_COL_SHIP_TO_CODE    \u003d 14;  // N\nconst Z_COL_SHIP_TO_NAME    \u003d 15;  // O\nconst Z_COL_MATERIAL        \u003d 16;  // P\nconst Z_COL_MATERIAL_DESC   \u003d 17;  // Q\nconst Z_COL_DELIVERY_QTY    \u003d 18;  // R\nconst Z_COL_ROUTE           \u003d 0;   // ‡πÑ‡∏°‡πà‡∏°‡∏µ/‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ\n\n// ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°: Vehicle Description (‡πÉ‡∏ô data)\n// ‡∏ñ‡πâ‡∏≤‡∏£‡∏π‡πâ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏à‡∏£‡∏¥‡∏á‡πÅ‡∏•‡πâ‡∏ß ‚Äú‡πÉ‡∏™‡πà‡πÄ‡∏•‡∏Ç‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‚Äù ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‡πÄ‡∏ä‡πà‡∏ô 6,7,8 ‡∏Ø‡∏•‡∏Ø\n// ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏ï‡∏±‡πâ‡∏á 0 ‡∏Å‡∏±‡∏ô‡∏û‡∏±‡∏á (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏î‡∏≤‡πÄ‡∏•‡∏Ç ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ Z_COL_DRIVER_NAME\u003d5 ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)\nconst Z_COL_VEHICLE_DESC    \u003d 0;   // Vehicle Description (data)\n\n/********************************\n * zoile30Connect!InputZoile30 column index (1-based)\n * ‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏´‡∏±‡∏ß‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏™‡πà‡∏á‡∏°‡∏≤\n ********************************/\n// 1 Select\n// 2 Shipment No.\n// 3 Sts\n// 4 Sts Text\n// 5 Vehicle\n// 6 Vehicle Description  ‚úÖ (‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ/‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢)\n// ...\n// 12 Driver name\n// 15 Distance\n// 31 Reference\n// 34 Ship to\n// 35 Ship to Name\n// 41 Material\n// 42 Material Desc\n// 43 Delivery Qty\n// 14 Route\nconst ZI_COL_SHIPMENT       \u003d 2;   // Shipment No.\nconst ZI_COL_VEHICLE_DESC   \u003d 6;   // ‚úÖ Vehicle Description  (‡πÅ‡∏Å‡πâ error: ZI_COL_VEHICLE_DESC is not defined)\nconst ZI_COL_DRIVER_NAME    \u003d 12;  // Driver name\nconst ZI_COL_DISTANCE       \u003d 15;  // Distance\nconst ZI_COL_REFERENCE      \u003d 31;  // Reference\nconst ZI_COL_SHIP_TO_CODE   \u003d 34;  // Ship to\nconst ZI_COL_SHIP_TO_NAME   \u003d 35;  // Ship to Name\nconst ZI_COL_MATERIAL       \u003d 41;  // Material\nconst ZI_COL_MATERIAL_DESC  \u003d 42;  // Material Desc\nconst ZI_COL_DELIVERY_QTY   \u003d 43;  // Delivery Qty\nconst ZI_COL_ROUTE          \u003d 14;  // Route\n\n/********************************\n * jobdata column index (‡πÑ‡∏ü‡∏•‡πå‡∏´‡∏•‡∏±‡∏Å) (1-based)\n ********************************/\nconst J_COL_REFERENCE        \u003d 1;  // A: referenceNo\nconst J_COL_SHIPMENT         \u003d 2;  // B: shipmentNo\nconst J_COL_SHIPTO_CODE      \u003d 3;  // C: shipToCode\nconst J_COL_SHIPTO_NAME      \u003d 4;  // D: shipToName\nconst J_COL_STATUS           \u003d 5;  // E: status ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á stop\nconst J_COL_CHECKIN          \u003d 6;  // F: checkInTime\nconst J_COL_CHECKOUT         \u003d 7;  // G: checkOutTime\nconst J_COL_UPDATED_BY       \u003d 8;  // H: updatedBy (userId)\nconst J_COL_SOURCE_ROW       \u003d 9;  // I: sourceRow (zoile data row index)\nconst J_COL_CREATED_AT       \u003d 10; // J: createdAt\nconst J_COL_UPDATED_AT       \u003d 11; // K: updatedAt\nconst J_COL_DEST_LAT         \u003d 12; // L\nconst J_COL_DEST_LNG         \u003d 13; // M\nconst J_COL_RADIUS_M         \u003d 14; // N\nconst J_COL_CHECKIN_LAT      \u003d 15; // O\nconst J_COL_CHECKIN_LNG      \u003d 16; // P\nconst J_COL_CHECKOUT_LAT     \u003d 17; // Q\nconst J_COL_CHECKOUT_LNG     \u003d 18; // R\n\n// ‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡πÄ‡∏ï‡πá‡∏õ\nconst J_COL_FUELING_TIME     \u003d 19; // S: fuelingTime\nconst J_COL_UNLOAD_DONE_TIME \u003d 20; // T: unloadDoneTime\nconst J_COL_REVIEWED_TIME    \u003d 21; // U: reviewedTime\nconst J_COL_JOB_CLOSED_AT    \u003d 22; // V: jobClosedAt\n\n// Distance ‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå\nconst J_COL_DISTANCE_KM      \u003d 23; // W: Distance ‡∏à‡∏≤‡∏Å zoile\nconst J_COL_CHECKIN_ODO      \u003d 24; // X: ‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡∏ï‡∏≠‡∏ô Check-in\n\n// üîπ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ (Y‚ÄìAC)\nconst J_COL_TRIP_END_ODO     \u003d 25; // Y: tripEndOdo\nconst J_COL_TRIP_END_LAT     \u003d 26; // Z: tripEndLat\nconst J_COL_TRIP_END_LNG     \u003d 27; // AA: tripEndLng\nconst J_COL_TRIP_END_PLACE   \u003d 28; // AB: tripEndPlace\nconst J_COL_TRIP_ENDED_AT    \u003d 29; // AC: tripEndedAt\n\n// ‚úÖ NEW: ‡πÄ‡∏Å‡πá‡∏ö Vehicle Description (‡∏°‡∏≤‡∏à‡∏≤‡∏Å InputZoile30 ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)\n// ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏° ‚Äú‡∏ó‡πâ‡∏≤‡∏¢‡∏™‡∏∏‡∏î‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô\nconst J_COL_VEHICLE_DESC     \u003d 30; // AD: vehicleDescription\n\n// last col ‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏ñ‡∏∂‡∏á AD\nconst J_COL_LAST             \u003d J_COL_VEHICLE_DESC;\n\n\n/********************************\n * Station column index (1-based)\n * Station: A\u003dstationKey, B\u003dstationKey2, C\u003dname, D\u003dlat, E\u003dlng, F\u003dradiusMeters\n ********************************/\nconst ST_COL_KEY1      \u003d 1;  // A\nconst ST_COL_KEY2      \u003d 2;  // B\nconst ST_COL_NAME      \u003d 3;  // C\nconst ST_COL_LAT       \u003d 4;  // D\nconst ST_COL_LNG       \u003d 5;  // E\nconst ST_COL_RADIUS_M  \u003d 6;  // F\n\n/********************************\n * Origin column index (1-based)\n * A: originKey\n * B: name\n * C: lat\n * D: lng\n * E: radiusMeters\n * F: routeCode\n ********************************/\nconst OR_COL_CODE        \u003d 1;\nconst OR_COL_NAME        \u003d 2;\nconst OR_COL_LAT         \u003d 3;\nconst OR_COL_LNG         \u003d 4;\nconst OR_COL_RADIUS_M    \u003d 5;\nconst OR_COL_ROUTE_CODE  \u003d 6;  // ‚úÖ routeCode\n"},{"id":"b9af99ab-98de-46e2-8298-045c99e96aed","name":"utils","type":"server_js","source":"/********************************\n * Helper: format date ‚Üí string\n ********************************/\nfunction formatDateForClient(date) {\n  if (!date) return \u0027\u0027;\n  if (!(date instanceof Date)) return String(date);\n  return Utilities.formatDate(date, Session.getScriptTimeZone(), \u0027yyyy-MM-dd HH:mm\u0027);\n}\n\n/********************************\n * Helper: JSON Response\n ********************************/\nfunction jsonResponse(obj) {\n  return ContentService\n    .createTextOutput(JSON.stringify(obj))\n    .setMimeType(ContentService.MimeType.JSON);\n}\n\n/********************************\n * Helper: Haversine distance (meters)\n ********************************/\nfunction haversineDistanceMeters(lat1, lng1, lat2, lng2) {\n  const R \u003d 6371000;\n  const toRad \u003d d \u003d\u003e (d * Math.PI) / 180;\n\n  const dLat \u003d toRad(lat2 - lat1);\n  const dLng \u003d toRad(lng2 - lng1);\n  const a \u003d\n    Math.sin(dLat / 2) * Math.sin(dLat / 2) +\n    Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *\n    Math.sin(dLng / 2) * Math.sin(dLng / 2);\n  const c \u003d 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\n\n  return R * c;\n}\n\n/********************************\n * Helper: ‡∏î‡∏∂‡∏á config ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏à‡∏≤‡∏Å Station/Origin\n ********************************/\nfunction getLocationConfigByCode(code) {\n  if (!code) return null;\n  const target \u003d String(code).trim();\n\n  const ss \u003d SpreadsheetApp.openById(SHEET_ID);\n\n  // Station\n  const stationSheet \u003d ss.getSheetByName(SHEET_STATION);\n  if (stationSheet) {\n    const lastRow \u003d stationSheet.getLastRow();\n    if (lastRow \u003e 1) {\n      const values \u003d stationSheet.getRange(2, 1, lastRow - 1, ST_COL_RADIUS_M).getValues();\n      for (let i \u003d 0; i \u003c values.length; i++) {\n        const rowKey1 \u003d String(values[i][ST_COL_KEY1 - 1] || \u0027\u0027).trim();\n        const rowKey2 \u003d String(values[i][ST_COL_KEY2 - 1] || \u0027\u0027).trim();\n        if (rowKey1 \u003d\u003d\u003d target || rowKey2 \u003d\u003d\u003d target) {\n          const lat     \u003d parseFloat(values[i][ST_COL_LAT - 1]);\n          const lng     \u003d parseFloat(values[i][ST_COL_LNG - 1]);\n          const radiusM \u003d parseFloat(values[i][ST_COL_RADIUS_M - 1]);\n          if (!isNaN(lat) \u0026\u0026 !isNaN(lng) \u0026\u0026 !isNaN(radiusM)) {\n            return { lat, lng, radiusM };\n          }\n        }\n      }\n    }\n  }\n\n  // Origin\n  const originSheet \u003d ss.getSheetByName(SHEET_ORIGIN);\n  if (originSheet) {\n    const lastRow \u003d originSheet.getLastRow();\n    if (lastRow \u003e 1) {\n      const values \u003d originSheet.getRange(2, 1, lastRow - 1, OR_COL_RADIUS_M).getValues();\n      for (let i \u003d 0; i \u003c values.length; i++) {\n        const rowCode \u003d String(values[i][OR_COL_CODE - 1] || \u0027\u0027).trim();\n        if (rowCode \u003d\u003d\u003d target) {\n          const lat     \u003d parseFloat(values[i][OR_COL_LAT - 1]);\n          const lng     \u003d parseFloat(values[i][OR_COL_LNG - 1]);\n          const radiusM \u003d parseFloat(values[i][OR_COL_RADIUS_M - 1]);\n          if (!isNaN(lat) \u0026\u0026 !isNaN(lng) \u0026\u0026 !isNaN(radiusM)) {\n            return { lat, lng, radiusM };\n          }\n        }\n      }\n    }\n  }\n\n  return null;\n}\n\n/********************************\n * ‡∏´‡∏≤ config ‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏à‡∏≤‡∏Å Route (3 ‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å)\n * ‡πÉ‡∏ä‡πâ‡∏ä‡∏µ‡∏ó Origin:\n * A originKey | B name | C lat | D lng | E radiusMeters | F routeCode\n ********************************/\nfunction getOriginConfigByRoute(routeStr) {\n  const route \u003d String(routeStr || \u0027\u0027).trim();\n  if (!route) return null;\n\n  // ‡πÉ‡∏ä‡πâ‡πÅ‡∏Ñ‡πà 3 ‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å‡∏ï‡∏≤‡∏° requirement\n  const prefix \u003d route.substring(0, 3);\n\n  const ss    \u003d SpreadsheetApp.openById(SHEET_ID);\n  const sheet \u003d ss.getSheetByName(SHEET_ORIGIN);\n  if (!sheet) return null;\n\n  const lastRow \u003d sheet.getLastRow();\n  if (lastRow \u003c 2) return null;\n\n  const data \u003d sheet.getRange(2, 1, lastRow - 1, OR_COL_ROUTE_CODE).getValues();\n  for (let i \u003d 0; i \u003c data.length; i++) {\n    const row          \u003d data[i];\n    const originKey    \u003d String(row[OR_COL_CODE - 1]       || \u0027\u0027).trim();\n    const originName   \u003d String(row[OR_COL_NAME - 1]       || \u0027\u0027).trim();\n    const lat          \u003d row[OR_COL_LAT - 1];\n    const lng          \u003d row[OR_COL_LNG - 1];\n    const radiusMeters \u003d parseFloat(row[OR_COL_RADIUS_M - 1]);\n    const routeCode    \u003d String(row[OR_COL_ROUTE_CODE - 1] || \u0027\u0027).trim();\n\n    if (!routeCode) continue;\n\n    const routeCodePrefix \u003d routeCode.substring(0, 3);\n    if (prefix \u003d\u003d\u003d routeCodePrefix) {\n      return {\n        code:     originKey || routeCodePrefix,\n        name:     originName || originKey || routeCodePrefix,\n        lat:      lat,\n        lng:      lng,\n        radiusM: (!isNaN(radiusMeters) \u0026\u0026 radiusMeters \u003e 0) ? radiusMeters : 200\n      };\n    }\n  }\n\n  return null;\n}\n"},{"id":"ef20fcd0-7101-4abb-8273-d3937d3ddbcb","name":"lineApi","type":"server_js","source":"/********************************\n * LINE API Helper\n ********************************/\nfunction getLineUserProfile(userId) {\n  const url \u003d \u0027https://api.line.me/v2/bot/profile/\u0027 + userId;\n  const res \u003d UrlFetchApp.fetch(url, {\n    method: \u0027get\u0027,\n    headers: {\n      \u0027Authorization\u0027: \u0027Bearer \u0027 + CHANNEL_ACCESS_TOKEN\n    },\n    muteHttpExceptions: true\n  });\n  return JSON.parse(res.getContentText() || \u0027{}\u0027);\n}\n\nfunction sendLineReply(token, replyToken, messageText) {\n  const url \u003d \u0027https://api.line.me/v2/bot/message/reply\u0027;\n  const payload \u003d {\n    replyToken: replyToken,\n    messages: [{ type: \u0027text\u0027, text: messageText }]\n  };\n  UrlFetchApp.fetch(url, {\n    method: \u0027post\u0027,\n    headers: {\n      \u0027Content-Type\u0027: \u0027application/json; charset\u003dUTF-8\u0027,\n      \u0027Authorization\u0027: \u0027Bearer \u0027 + token\n    },\n    payload: JSON.stringify(payload),\n    muteHttpExceptions: true\n  });\n}\n\n/********************************\n * Rich Menu helper\n ********************************/\nfunction linkRichMenuToUser(userId, richMenuId) {\n  const url \u003d \u0027https://api.line.me/v2/bot/user/\u0027 + userId + \u0027/richmenu/\u0027 + richMenuId;\n  const options \u003d {\n    method: \u0027post\u0027,\n    headers: {\n      \u0027Authorization\u0027: \u0027Bearer \u0027 + CHANNEL_ACCESS_TOKEN\n    },\n    muteHttpExceptions: true\n  };\n\n  let res, code, body;\n  try {\n    res  \u003d UrlFetchApp.fetch(url, options);\n    code \u003d res.getResponseCode();\n    body \u003d res.getContentText();\n  } catch (err) {\n    Logger.log(\u0027linkRichMenuToUser ERROR: \u0027 + err);\n    return { code: 0, body: String(err) };\n  }\n\n  Logger.log(\u0027linkRichMenuToUser: code\u003d\u0027 + code + \u0027, body\u003d\u0027 + body);\n  return { code: code, body: body };\n}\n"},{"id":"315da68f-af27-4ba9-978a-6d05e688fb24","name":"userProfile","type":"server_js","source":"/********************************\n * Helper: userprofile status helper (‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å header)\n ********************************/\nfunction getUserStatus(userId) {\n  if (!userId) return null;\n\n  try {\n    const ss    \u003d SpreadsheetApp.openById(SHEET_ID);\n    const sheet \u003d ss.getSheetByName(SHEET_USER_PROFILE);\n    if (!sheet) {\n      Logger.log(\u0027getUserStatus: sheet not found\u0027);\n      return null;\n    }\n\n    const values \u003d sheet.getDataRange().getValues();\n    if (!values || values.length \u003c 2) {\n      Logger.log(\u0027getUserStatus: no data rows\u0027);\n      return null;\n    }\n\n    const header \u003d values[0].map(h \u003d\u003e String(h || \u0027\u0027).toLowerCase().trim());\n\n    let idxUserId \u003d header.findIndex(h \u003d\u003e\n      h \u003d\u003d\u003d \u0027userid\u0027 || h \u003d\u003d\u003d \u0027user_id\u0027 || h \u003d\u003d\u003d \u0027user id\u0027\n    );\n    let idxStatus \u003d header.findIndex(h \u003d\u003e h \u003d\u003d\u003d \u0027status\u0027);\n\n    if (idxUserId \u003d\u003d\u003d -1) idxUserId \u003d COL_USER_ID - 1;\n    if (idxStatus \u003d\u003d\u003d -1) idxStatus \u003d COL_STATUS   - 1;\n\n    Logger.log(\u0027getUserStatus: idxUserId\u003d\u0027 + idxUserId + \u0027, idxStatus\u003d\u0027 + idxStatus);\n\n    const targetId \u003d String(userId).trim();\n\n    for (let i \u003d 1; i \u003c values.length; i++) {\n      const row \u003d values[i];\n      const rowUserId \u003d String(row[idxUserId] || \u0027\u0027).trim();\n      if (rowUserId \u003d\u003d\u003d targetId) {\n        const status \u003d row[idxStatus];\n        Logger.log(\u0027getUserStatus: found userId\u003d\u0027 + targetId + \u0027, status\u003d\u0027 + status);\n        return status || null;\n      }\n    }\n\n    Logger.log(\u0027getUserStatus: userId not found \u003d \u0027 + targetId);\n    return null;\n  } catch (err) {\n    Logger.log(\u0027getUserStatus ERROR: \u0027 + err);\n    return null;\n  }\n}\n\n/********************************\n * Helper: ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤ userId ‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô Admin ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà\n ********************************/\nfunction isAdminUser(userId) {\n  if (!userId) return false;\n\n  try {\n    const ss    \u003d SpreadsheetApp.openById(SHEET_ID);\n    const sheet \u003d ss.getSheetByName(SHEET_USER_PROFILE);\n    if (!sheet) {\n      Logger.log(\u0027isAdminUser: sheet not found\u0027);\n      return false;\n    }\n\n    const values \u003d sheet.getDataRange().getValues();\n    if (!values || values.length \u003c 2) {\n      Logger.log(\u0027isAdminUser: no data rows\u0027);\n      return false;\n    }\n\n    const header \u003d values[0].map(h \u003d\u003e String(h || \u0027\u0027).toLowerCase().trim());\n\n    let idxUserId   \u003d header.findIndex(h \u003d\u003e\n      h \u003d\u003d\u003d \u0027userid\u0027 || h \u003d\u003d\u003d \u0027user_id\u0027 || h \u003d\u003d\u003d \u0027user id\u0027\n    );\n    let idxStatus   \u003d header.findIndex(h \u003d\u003e h \u003d\u003d\u003d \u0027status\u0027);\n    let idxUserType \u003d header.findIndex(h \u003d\u003e\n      h \u003d\u003d\u003d \u0027usertype\u0027 || h \u003d\u003d\u003d \u0027user_type\u0027 || h \u003d\u003d\u003d \u0027role\u0027\n    );\n\n    if (idxUserId   \u003d\u003d\u003d -1) idxUserId   \u003d COL_USER_ID   - 1;\n    if (idxStatus   \u003d\u003d\u003d -1) idxStatus   \u003d COL_STATUS    - 1;\n    if (idxUserType \u003d\u003d\u003d -1) idxUserType \u003d COL_USERTYPE  - 1;\n\n    Logger.log(\n      \u0027isAdminUser: idxUserId\u003d\u0027 + idxUserId +\n      \u0027, idxStatus\u003d\u0027 + idxStatus +\n      \u0027, idxUserType\u003d\u0027 + idxUserType\n    );\n\n    const targetId \u003d String(userId).trim();\n\n    for (let i \u003d 1; i \u003c values.length; i++) {\n      const row      \u003d values[i];\n      const rowUserId\u003d String(row[idxUserId]   || \u0027\u0027).trim();\n      const rawStatus\u003d String(row[idxStatus]   || \u0027\u0027).trim();\n      const rawType  \u003d String(row[idxUserType] || \u0027\u0027).trim();\n\n      if (rowUserId !\u003d\u003d targetId) continue;\n\n      const status   \u003d rawStatus.toUpperCase();\n      const userType \u003d rawType.toLowerCase();\n\n      Logger.log(\n        \u0027isAdminUser: found row for \u0027 + targetId +\n        \u0027 -\u003e status\u003d\u0027 + status + \u0027, userType\u003d\u0027 + userType\n      );\n\n      if (status \u003d\u003d\u003d \u0027APPROVED\u0027 \u0026\u0026 userType \u003d\u003d\u003d \u0027admin\u0027) {\n        return true;\n      }\n      return false;\n    }\n\n    Logger.log(\u0027isAdminUser: userId not found \u003d \u0027 + targetId);\n    return false;\n  } catch (err) {\n    Logger.log(\u0027isAdminUser ERROR: \u0027 + err);\n    return false;\n  }\n}\n\n/********************************\n * follow ‚Üí ‡πÄ‡∏Å‡πá‡∏ö userprofile\n ********************************/\nfunction handleFollowEvent(event) {\n  const userId \u003d event.source.userId;\n\n  const profile \u003d getLineUserProfile(userId);\n  const displayName \u003d profile.displayName || \u0027\u0027;\n  const pictureUrl  \u003d profile.pictureUrl  || \u0027\u0027;\n\n  const ss    \u003d SpreadsheetApp.openById(SHEET_ID);\n  const sheet \u003d ss.getSheetByName(SHEET_USER_PROFILE);\n\n  const lastRow \u003d sheet.getLastRow();\n  const data \u003d lastRow \u003e 1\n    ? sheet.getRange(2, 1, lastRow - 1, COL_UPDATED_AT).getValues()\n    : [];\n\n  const now \u003d new Date();\n  const idx \u003d data.findIndex(r \u003d\u003e r[COL_USER_ID - 1] \u003d\u003d\u003d userId);\n\n  if (idx \u003d\u003d\u003d -1) {\n    sheet.appendRow([\n      userId,\n      displayName,\n      pictureUrl,\n      \u0027PENDING\u0027,\n      now,\n      now\n    ]);\n  } else {\n    const row \u003d idx + 2;\n    sheet.getRange(row, COL_DISPLAY_NAME).setValue(displayName);\n    sheet.getRange(row, COL_PICTURE_URL).setValue(pictureUrl);\n    sheet.getRange(row, COL_UPDATED_AT).setValue(now);\n  }\n\n  const msg \u003d\n    \u0027‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÅ‡∏≠‡∏î‡πÑ‡∏•‡∏ô‡πå‡∏Ñ‡∏£‡∏±‡∏ö üôè\\n\u0027 +\n    \u0027‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏≠‡∏õ‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö.\u0027;\n  sendLineReply(CHANNEL_ACCESS_TOKEN, event.replyToken, msg);\n}\n\n/********************************\n * message event\n ********************************/\nfunction handleMessageEvent(event) {\n  const text  \u003d (event.message.text || \u0027\u0027).trim();\n  const userId \u003d event.source.userId;\n\n  if (text \u003d\u003d\u003d \u0027status\u0027) {\n    const status \u003d getUserStatus(userId);\n    const reply \u003d \u0027‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: \u0027 + (status || \u0027‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• / ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô\u0027);\n    sendLineReply(CHANNEL_ACCESS_TOKEN, event.replyToken, reply);\n  } else {\n    const reply \u003d \u0027‡∏´‡∏≤‡∏Å‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ ‡πÉ‡∏´‡πâ‡∏Å‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏≠‡∏õ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö\u0027;\n    sendLineReply(CHANNEL_ACCESS_TOKEN, event.replyToken, reply);\n  }\n}\n\n/********************************\n * onEdit: ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡∏ú‡∏π‡∏Å Rich Menu\n ********************************/\nfunction onEdit(e) {\n  try {\n    if (!e || !e.range) {\n      Logger.log(\u0027onEdit called without event object.\u0027);\n      return;\n    }\n\n    const editedSheet \u003d e.range.getSheet();\n    const editedSheetName \u003d editedSheet.getName();\n    const ssId \u003d e.source \u0026\u0026 e.source.getId ? e.source.getId() : \u0027unknown\u0027;\n\n    Logger.log(\n      \u0027onEdit fired on spreadsheetId\u003d\u0027 + ssId + \u0027, sheet\u003d\u0027 + editedSheetName +\n      \u0027, row\u003d\u0027 + e.range.getRow() + \u0027, col\u003d\u0027 + e.range.getColumn()\n    );\n\n    if (ssId !\u003d\u003d SHEET_ID) {\n      Logger.log(\u0027onEdit: edited spreadsheet is not main SHEET_ID, skip.\u0027);\n      return;\n    }\n    if (editedSheetName !\u003d\u003d SHEET_USER_PROFILE) {\n      Logger.log(\u0027onEdit: edited sheet is not userprofile, skip.\u0027);\n      return;\n    }\n\n    const row \u003d e.range.getRow();\n    const col \u003d e.range.getColumn();\n\n    if (row \u003d\u003d\u003d 1) {\n      Logger.log(\u0027onEdit: header row, skip.\u0027);\n      return;\n    }\n\n    if (col \u003d\u003d\u003d COL_STATUS) {\n      const rawStatus \u003d e.range.getValue();\n      const newStatus \u003d String(rawStatus).trim().toUpperCase();\n      const userId    \u003d editedSheet.getRange(row, COL_USER_ID).getValue();\n      const now       \u003d new Date();\n\n      Logger.log(\n        \u0027onEdit status change at row\u003d\u0027 + row +\n        \u0027, rawStatus\u003d\"\u0027 + rawStatus + \u0027\", normalized\u003d\"\u0027 + newStatus + \u0027\", userId\u003d\u0027 + userId\n      );\n\n      editedSheet.getRange(row, COL_UPDATED_AT).setValue(now);\n\n      if (newStatus \u003d\u003d\u003d \u0027APPROVED\u0027 \u0026\u0026 userId) {\n        Logger.log(\u0027onEdit: calling linkRichMenuToUser for userId\u003d\u0027 + userId);\n        const result \u003d linkRichMenuToUser(userId, RICH_MENU_ID_MENU1);\n        Logger.log(\u0027onEdit: linkRichMenuToUser result\u003d\u0027 + JSON.stringify(result));\n      } else {\n        Logger.log(\u0027onEdit: status is not APPROVED or userId empty, skip linking.\u0027);\n      }\n    } else {\n      Logger.log(\u0027onEdit: edited column is not COL_STATUS, skip.\u0027);\n    }\n  } catch (error) {\n    Logger.log(\u0027üî• onEdit error: \u0027 + error);\n  }\n}\n"},{"id":"9df24d93-4f15-45ce-9bff-67e0e5f48038","name":"driverJob","type":"server_js","source":"/********************************\n * Helper: ‡∏≠‡πà‡∏≤‡∏ô Origin ‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ó Origin ‡∏î‡πâ‡∏ß‡∏¢ route 3 ‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å\n * Origin sheet: A\u003doriginKey, B\u003dname, C\u003dlat, D\u003dlng, E\u003dradiusMeters, F\u003drouteCode\n ********************************/\nfunction getOriginConfigByRoute(routeRaw) {\n  const route \u003d String(routeRaw || \"\").trim();\n  if (!route || route.length \u003c 3) return null;\n\n  const prefix3 \u003d route.substring(0, 3);  // ‡πÄ‡∏ä‡πà‡∏ô \u0027Z06\u0027\n\n  const ss    \u003d SpreadsheetApp.openById(SHEET_ID);\n  const sheet \u003d ss.getSheetByName(SHEET_ORIGIN);\n  if (!sheet) return null;\n\n  const lastRow \u003d sheet.getLastRow();\n  if (lastRow \u003c 2) return null;\n\n  const values \u003d sheet.getRange(2, 1, lastRow - 1, 6).getValues(); // A-F\n\n  for (let i \u003d 0; i \u003c values.length; i++) {\n    const row          \u003d values[i];\n    const originKey    \u003d String(row[0] || \"\").trim();\n    const originName   \u003d String(row[1] || \"\").trim();\n    const lat          \u003d parseFloat(row[2]);\n    const lng          \u003d parseFloat(row[3]);\n    const radiusMeters \u003d parseFloat(row[4]);\n    const routeCode    \u003d String(row[5] || \"\").trim(); // ‡πÄ‡∏ä‡πà‡∏ô Z06, Z01, ...\n\n    if (!routeCode) continue;\n\n    const routePrefix \u003d routeCode.substring(0, 3); // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠ routeCode ‡∏¢‡∏≤‡∏ß\n\n    if (routePrefix \u003d\u003d\u003d prefix3) {\n      return {\n        code:    originKey,\n        name:    originName,\n        lat:     isNaN(lat)          ? \"\"   : lat,\n        lng:     isNaN(lng)          ? \"\"   : lng,\n        radiusM: isNaN(radiusMeters) ? 200 : radiusMeters\n      };\n    }\n  }\n  return null;\n}\n\n/********************************\n * Helper: default origin (‡πÉ‡∏ä‡πâ‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏ä‡∏µ‡∏ó Origin ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)\n ********************************/\nfunction getDefaultOriginConfig() {\n  const ss    \u003d SpreadsheetApp.openById(SHEET_ID);\n  const sheet \u003d ss.getSheetByName(SHEET_ORIGIN);\n  if (sheet \u0026\u0026 sheet.getLastRow() \u003e\u003d 2) {\n    const row          \u003d sheet.getRange(2, 1, 1, 5).getValues()[0]; // A-E\n    const originKey    \u003d String(row[0] || \"\").trim();\n    const originName   \u003d String(row[1] || \"\").trim();\n    const lat          \u003d parseFloat(row[2]);\n    const lng          \u003d parseFloat(row[3]);\n    const radiusMeters \u003d parseFloat(row[4]);\n\n    return {\n      code:    originKey || \"TOP_SR\",\n      name:    originName || \"‡πÑ‡∏ó‡∏¢‡∏≠‡∏≠‡∏¢‡∏•‡πå ‡∏®‡∏£‡∏µ‡∏£‡∏≤‡∏ä‡∏≤\",\n      lat:     isNaN(lat)          ? \"\"   : lat,\n      lng:     isNaN(lng)          ? \"\"   : lng,\n      radiusM: isNaN(radiusMeters) ? 200 : radiusMeters\n    };\n  }\n\n  // fallback ‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ origin sheet ‡πÄ‡∏•‡∏¢\n  return {\n    code:    \"TOP_SR\",\n    name:    \"‡πÑ‡∏ó‡∏¢‡∏≠‡∏≠‡∏¢‡∏•‡πå ‡∏®‡∏£‡∏µ‡∏£‡∏≤‡∏ä‡∏≤\",\n    lat:     \"13.1100258\",\n    lng:     \"100.9144418\",\n    radiusM: 200\n  };\n}\n\n/********************************\n * ‚úÖ Helper: ensure jobdata has enough columns (‡∏ñ‡∏∂‡∏á J_COL_LAST)\n ********************************/\nfunction ensureJobdataHasCols_(jobSheet) {\n  const needLast \u003d J_COL_LAST;\n  const curLast \u003d jobSheet.getLastColumn();\n  if (curLast \u003c needLast) {\n    jobSheet.insertColumnsAfter(curLast, needLast - curLast);\n  }\n}\n\n/********************************\n * handleSearchShipment\n ********************************/\nfunction handleSearchShipment(e) {\n  try {\n    const keyword \u003d (e.parameter.keyword || \u0027\u0027).trim();\n    const userId  \u003d e.parameter.userId || \u0027\u0027;\n\n    if (!keyword) {\n      return jsonResponse({ success: false, message: \u0027‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡πÄ‡∏•‡∏Ç Reference\u0027 });\n    }\n\n    // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏Å‡πà‡∏≠‡∏ô\n    if (userId) {\n      const status \u003d getUserStatus(userId);\n      if (status !\u003d\u003d \u0027APPROVED\u0027) {\n        return jsonResponse({\n          success: false,\n          message: \u0027‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö\u0027\n        });\n      }\n    }\n\n    const zoSS \u003d SpreadsheetApp.openById(ZOILE_SHEET_ID);\n\n    function loadSheetValues(sheetName) {\n      const sheet \u003d zoSS.getSheetByName(sheetName);\n      if (!sheet) return null;\n      const lastRow \u003d sheet.getLastRow();\n      const lastCol \u003d sheet.getLastColumn();\n      if (lastRow \u003c 2) return null;\n      const values \u003d sheet.getRange(2, 1, lastRow - 1, lastCol).getValues();\n      return { sheet, values, lastRow, lastCol };\n    }\n\n    // map col index ‡∏ï‡∏≤‡∏° type\n    function getZoileCols(sourceType) {\n      if (sourceType \u003d\u003d\u003d \u0027input\u0027) {\n        return {\n          SHIPMENT:      ZI_COL_SHIPMENT,\n          DRIVER_NAME:   ZI_COL_DRIVER_NAME,\n          DISTANCE:      ZI_COL_DISTANCE,\n          REFERENCE:     ZI_COL_REFERENCE,\n          SHIP_TO_CODE:  ZI_COL_SHIP_TO_CODE,\n          SHIP_TO_NAME:  ZI_COL_SHIP_TO_NAME,\n          MATERIAL:      ZI_COL_MATERIAL,\n          MATERIAL_DESC: ZI_COL_MATERIAL_DESC,\n          DELIVERY_QTY:  ZI_COL_DELIVERY_QTY,\n          ROUTE:         ZI_COL_ROUTE,\n\n          // ‚úÖ NEW\n          VEHICLE_DESC:  ZI_COL_VEHICLE_DESC\n        };\n      }\n\n      return {\n        SHIPMENT:      Z_COL_SHIPMENT,\n        DRIVER_NAME:   Z_COL_DRIVER_NAME,\n        DISTANCE:      Z_COL_DISTANCE,\n        REFERENCE:     Z_COL_REFERENCE,\n        SHIP_TO_CODE:  Z_COL_SHIP_TO_CODE,\n        SHIP_TO_NAME:  Z_COL_SHIP_TO_NAME,\n        MATERIAL:      Z_COL_MATERIAL,\n        MATERIAL_DESC: Z_COL_MATERIAL_DESC,\n        DELIVERY_QTY:  Z_COL_DELIVERY_QTY,\n        ROUTE:         Z_COL_ROUTE,\n\n        // ‚úÖ NEW\n        VEHICLE_DESC:  Z_COL_VEHICLE_DESC\n      };\n    }\n\n    function findRowsByReference(values, refColIndex, refKeyword) {\n      const matches \u003d [];\n      let firstIdx  \u003d -1;\n      const target  \u003d String(refKeyword).trim();\n      for (let i \u003d 0; i \u003c values.length; i++) {\n        const referenceNo \u003d String(values[i][refColIndex - 1] || \u0027\u0027).trim();\n        if (referenceNo \u003d\u003d\u003d target) {\n          if (firstIdx \u003d\u003d\u003d -1) firstIdx \u003d i;\n          matches.push({ index: i, row: values[i] });\n        }\n      }\n      return { firstIdx, matches };\n    }\n\n    // ‚úÖ NEW: vehicle_desc ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏Ñ‡πà InputZoile30\n    function getVehicleDescFromInputByReference(ref) {\n      try {\n        const info \u003d loadSheetValues(ZOILE_SHEET_INPUT);\n        if (!info || !info.values || info.values.length \u003d\u003d\u003d 0) return \u0027\u0027;\n\n        // ‡πÉ‡∏ä‡πâ col ‡∏ï‡∏≤‡∏° input ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô\n        const res \u003d findRowsByReference(info.values, ZI_COL_REFERENCE, ref);\n        if (res.firstIdx \u003d\u003d\u003d -1 || !res.matches || res.matches.length \u003d\u003d\u003d 0) return \u0027\u0027;\n\n        const row \u003d res.matches[0].row;\n        return String(row[ZI_COL_VEHICLE_DESC - 1] || \u0027\u0027).trim();\n      } catch (err) {\n        Logger.log(\u0027[getVehicleDescFromInputByReference] error: \u0027 + err);\n        return \u0027\u0027;\n      }\n    }\n\n    // ---------- 1. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: InputZoile30 ‚ûú data ----------\n    let sourceType   \u003d \u0027input\u0027;\n    let dataInfo     \u003d loadSheetValues(ZOILE_SHEET_INPUT);\n    let cols         \u003d getZoileCols(sourceType);\n    let zoValues     \u003d dataInfo ? dataInfo.values : [];\n    let searchResult \u003d dataInfo\n      ? findRowsByReference(zoValues, cols.REFERENCE, keyword)\n      : { firstIdx: -1, matches: [] };\n\n    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡πÉ‡∏ô input ‚Üí ‡∏•‡∏≠‡∏á‡∏ä‡∏µ‡∏ó data\n    if (searchResult.firstIdx \u003d\u003d\u003d -1) {\n      const dataInfo2 \u003d loadSheetValues(ZOILE_SHEET_DATA);\n      if (dataInfo2) {\n        const dataCols   \u003d getZoileCols(\u0027data\u0027);\n        const searchData \u003d findRowsByReference(\n          dataInfo2.values,\n          dataCols.REFERENCE,\n          keyword\n        );\n        if (searchData.firstIdx !\u003d\u003d -1) {\n          sourceType   \u003d \u0027data\u0027;\n          dataInfo     \u003d dataInfo2;\n          zoValues     \u003d dataInfo2.values;\n          cols         \u003d dataCols;\n          searchResult \u003d searchData;\n        }\n      }\n    }\n\n    if (searchResult.firstIdx \u003d\u003d\u003d -1) {\n      return jsonResponse({\n        success: false,\n        message: \u0027‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏•‡∏Ç Reference ‡∏ô‡∏µ‡πâ‡πÉ‡∏ô zoile30Connect (‡∏ó‡∏±‡πâ‡∏á‡∏ä‡∏µ‡∏ó InputZoile30 ‡πÅ‡∏•‡∏∞ data)\u0027\n      });\n    }\n\n    const targetReference \u003d keyword;\n    const zoRowsForRef    \u003d searchResult.matches;\n\n    if (zoRowsForRef.length \u003d\u003d\u003d 0) {\n      return jsonResponse({\n        success: false,\n        message: \u0027‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Reference ‡∏ô‡∏µ‡πâ‡πÉ‡∏ô zoile30Connect\u0027\n      });\n    }\n\n    // ‚úÖ FIX: vehicle_desc ‡∏°‡∏µ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ InputZoile30 ‚Üí ‡∏ñ‡πâ‡∏≤ source ‡πÄ‡∏õ‡πá‡∏ô data ‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ô‡∏µ‡πâ ‡πÉ‡∏´‡πâ‡πÑ‡∏õ lookup ‡∏à‡∏≤‡∏Å input ‡πÄ‡∏™‡∏°‡∏≠\n    let vehicleDescription \u003d \u0027\u0027;\n    if (cols.VEHICLE_DESC \u0026\u0026 cols.VEHICLE_DESC \u003e 0) {\n      vehicleDescription \u003d String(zoRowsForRef[0].row[cols.VEHICLE_DESC - 1] || \u0027\u0027).trim();\n    }\n    if (!vehicleDescription) {\n      vehicleDescription \u003d getVehicleDescFromInputByReference(targetReference);\n    }\n\n\n    // ---------- 2. ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö ----------\n    let driverRaw \u003d \u0027\u0027;\n    for (let i \u003d 0; i \u003c zoRowsForRef.length; i++) {\n      const r \u003d zoRowsForRef[i].row;\n      const d \u003d String(r[cols.DRIVER_NAME - 1] || \u0027\u0027).trim();\n      if (d) {\n        driverRaw \u003d d;\n        break;\n      }\n    }\n    let drivers \u003d [];\n    if (driverRaw) {\n      drivers \u003d driverRaw\n        .split(\u0027/\u0027)\n        .map(s \u003d\u003e s.trim())\n        .filter(s \u003d\u003e s);\n    }\n\n    // ---------- 3. Aggregate ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á/‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ----------\n    const stationAgg \u003d {};\n    zoRowsForRef.forEach(obj \u003d\u003e {\n      const row \u003d obj.row;\n\n      const shipToCode   \u003d String(row[cols.SHIP_TO_CODE   - 1] || \u0027\u0027).trim();\n      const shipToName   \u003d String(row[cols.SHIP_TO_NAME   - 1] || \u0027\u0027).trim();\n      const material     \u003d String(row[cols.MATERIAL       - 1] || \u0027\u0027).trim();\n      const materialDesc \u003d String(row[cols.MATERIAL_DESC  - 1] || \u0027\u0027).trim();\n      const qtyRaw       \u003d row[cols.DELIVERY_QTY - 1];\n      const qty          \u003d parseFloat(qtyRaw || 0) || 0;\n\n      const distanceRaw \u003d row[cols.DISTANCE - 1];\n      const distanceKm  \u003d distanceRaw !\u003d\u003d \u0027\u0027 \u0026\u0026 distanceRaw !\u003d null\n        ? parseFloat(distanceRaw)\n        : \u0027\u0027;\n\n      const stationKey \u003d shipToCode || (\u0027NAME:\u0027 + shipToName);\n\n      if (!stationAgg[stationKey]) {\n        stationAgg[stationKey] \u003d {\n          shipToCode: shipToCode,\n          shipToName: shipToName,\n          totalQty:   0,\n          linesCount: 0,\n          materials:  {},\n          distanceKm: distanceKm\n        };\n      }\n\n      const agg \u003d stationAgg[stationKey];\n      agg.totalQty   +\u003d qty;\n      agg.linesCount +\u003d 1;\n\n      if ((agg.distanceKm \u003d\u003d\u003d \u0027\u0027 || agg.distanceKm \u003d\u003d null) \u0026\u0026 distanceKm !\u003d\u003d \u0027\u0027) {\n        agg.distanceKm \u003d distanceKm;\n      }\n\n      const matKey \u003d material || materialDesc || \u0027UNKNOWN\u0027;\n      if (!agg.materials[matKey]) {\n        agg.materials[matKey] \u003d {\n          material:     material,\n          materialDesc: materialDesc,\n          totalQty:     0\n        };\n      }\n      agg.materials[matKey].totalQty +\u003d qty;\n    });\n\n    // ---------- 4. jobdata ----------\n    const mainSS   \u003d SpreadsheetApp.openById(SHEET_ID);\n    const jobSheet \u003d mainSS.getSheetByName(SHEET_JOBDATA);\n    if (!jobSheet) {\n      return jsonResponse({ success: false, message: \u0027‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ó jobdata ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏´‡∏•‡∏±‡∏Å\u0027 });\n    }\n\n    const jobLastRow \u003d jobSheet.getLastRow();\n    let jobValues \u003d [];\n    if (jobLastRow \u003e 1) {\n      jobValues \u003d jobSheet.getRange(2, 1, jobLastRow - 1, J_COL_LAST).getValues();\n    }\n\n    let jobRowsForRef \u003d [];\n    if (jobValues.length \u003e 0) {\n      jobValues.forEach((row, idx) \u003d\u003e {\n        const ref \u003d String(row[J_COL_REFERENCE - 1] || \u0027\u0027).trim();\n        if (ref \u003d\u003d\u003d targetReference) {\n          jobRowsForRef.push({\n            rowIndex: idx + 2,\n            row:      row\n          });\n        }\n      });\n    }\n\n    // \u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\n    // 2.4 PATCH: ‡πÄ‡∏ï‡∏¥‡∏° vehicle_desc ‡πÉ‡∏´‡πâ jobdata ‡πÄ‡∏î‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡∏ß‡πà‡∏≤‡∏á)\n    // (vehicle_desc ‡∏°‡∏µ‡πÅ‡∏Ñ‡πà InputZoile30 ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)\n    // \u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\n    if (typeof J_COL_VEHICLE_DESC !\u003d\u003d \u0027undefined\u0027 \u0026\u0026 J_COL_VEHICLE_DESC \u003e 0) {\n\n      // ‡∏ñ‡πâ‡∏≤ vehicleDescription ‡∏¢‡∏±‡∏á‡∏ß‡πà‡∏≤‡∏á ‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å InputZoile30 ‡∏î‡πâ‡∏ß‡∏¢ reference\n      if (!vehicleDescription) {\n        // ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô getVehicleDescFromInputByReference(ref) ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô handleSearchShipment ‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏∞\n        vehicleDescription \u003d getVehicleDescFromInputByReference(targetReference);\n      }\n\n      // ‡∏°‡∏µ jobdata ‡πÄ‡∏î‡∏¥‡∏° + ‡∏°‡∏µ vehicle_desc ‚Üí ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á\n      if (vehicleDescription \u0026\u0026 jobRowsForRef \u0026\u0026 jobRowsForRef.length \u003e 0) {\n        jobRowsForRef.forEach(info \u003d\u003e {\n          const rowIdx \u003d info.rowIndex; // ‡πÄ‡∏•‡∏Ç‡πÅ‡∏ñ‡∏ß‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô sheet (1-based)\n          const row \u003d jobSheet.getRange(rowIdx, 1, 1, J_COL_LAST).getValues()[0];\n\n          const oldVal \u003d String(row[J_COL_VEHICLE_DESC - 1] || \u0027\u0027).trim();\n\n          // ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡∏ß‡πà‡∏≤‡∏á\n          if (!oldVal) {\n            row[J_COL_VEHICLE_DESC - 1] \u003d vehicleDescription;\n            jobSheet.getRange(rowIdx, 1, 1, J_COL_LAST).setValues([row]);\n          }\n        });\n      }\n    }\n\n    // ‚úÖ 4.1 ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡πá‡∏™‡∏£‡πâ‡∏≤‡∏á jobdata ‡∏à‡∏≤‡∏Å zoile (origin + ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á)\n    if (jobRowsForRef.length \u003d\u003d\u003d 0) {\n      const now        \u003d new Date();\n      const stationMap \u003d {};\n\n      // map ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡πÉ‡∏´‡πâ‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥\n      zoRowsForRef.forEach(obj \u003d\u003e {\n        const row        \u003d obj.row;\n        const zoRowIndex \u003d obj.index + 2;\n\n        const shipToCode \u003d String(row[cols.SHIP_TO_CODE - 1] || \u0027\u0027).trim();\n        const shipToName \u003d String(row[cols.SHIP_TO_NAME - 1] || \u0027\u0027).trim();\n\n        const distanceRaw \u003d row[cols.DISTANCE - 1];\n        const distanceKm  \u003d distanceRaw !\u003d\u003d \u0027\u0027 \u0026\u0026 distanceRaw !\u003d null\n          ? parseFloat(distanceRaw)\n          : \u0027\u0027;\n\n        if (!shipToCode) {\n          const fallbackKey \u003d \u0027NO_CODE_\u0027 + zoRowIndex;\n          if (!stationMap[fallbackKey]) {\n            stationMap[fallbackKey] \u003d {\n              row,\n              zoRowIndex,\n              shipToCode: \u0027\u0027,\n              shipToName,\n              isFallback: true,\n              distanceKm: distanceKm\n            };\n          }\n          return;\n        }\n\n        if (!stationMap[shipToCode]) {\n          stationMap[shipToCode] \u003d {\n            row,\n            zoRowIndex,\n            shipToCode,\n            shipToName,\n            isFallback: false,\n            distanceKm: distanceKm\n          };\n        }\n      });\n\n      if (zoRowsForRef.length \u003e 0) {\n        const firstRow       \u003d zoRowsForRef[0].row;\n        const shipmentNoOri  \u003d String(firstRow[cols.SHIPMENT  - 1] || \u0027\u0027).trim();\n        const referenceNoOri \u003d String(firstRow[cols.REFERENCE - 1] || \u0027\u0027).trim();\n\n        // ‚úÖ ‡∏î‡∏∂‡∏á Route ‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ó‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á (input ‡∏´‡∏£‡∏∑‡∏≠ data)\n        let routeValue \u003d \u0027\u0027;\n        if (cols.ROUTE \u0026\u0026 cols.ROUTE \u003e 0) {\n          routeValue \u003d String(firstRow[cols.ROUTE - 1] || \u0027\u0027).trim();\n        }\n\n        // \u003d\u003d\u003d\u003d\u003d ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Origin ‡∏à‡∏≤‡∏Å route (3 ‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å) \u003d\u003d\u003d\u003d\u003d\n        let originConfig \u003d null;\n        if (routeValue \u0026\u0026 routeValue.length \u003e\u003d 3) {\n          originConfig \u003d getOriginConfigByRoute(routeValue);\n        }\n        if (!originConfig) {\n          originConfig \u003d getDefaultOriginConfig();\n        }\n\n        const originCode \u003d originConfig.code;\n        const originName \u003d originConfig.name;\n        const oriLat     \u003d originConfig.lat;\n        const oriLng     \u003d originConfig.lng;\n        const oriRadius  \u003d originConfig.radiusM;\n\n        Logger.log(\n          \u0027[handleSearchShipment] Origin for ref %s ‚Üí source\u003d%s, route\u003d%s, origin\u003d%s (%s), lat\u003d%s, lng\u003d%s, radius\u003d%s\u0027,\n          referenceNoOri, sourceType, routeValue, originCode, originName, oriLat, oriLng, oriRadius\n        );\n\n        // 4.1.1 ‡πÅ‡∏ñ‡∏ß‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á (FIX: ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡∏∂‡∏á J_COL_LAST ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ vehicleDescription ‡πÑ‡∏õ‡∏•‡∏á AD ‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô)\n          ensureJobdataHasCols_(jobSheet);\n\n          const originRow \u003d new Array(J_COL_LAST).fill(\u0027\u0027);\n\n          // core\n          originRow[J_COL_REFERENCE - 1]   \u003d referenceNoOri;\n          originRow[J_COL_SHIPMENT - 1]    \u003d shipmentNoOri;\n          originRow[J_COL_SHIPTO_CODE - 1] \u003d originCode;\n          originRow[J_COL_SHIPTO_NAME - 1] \u003d originName;\n          originRow[J_COL_STATUS - 1]      \u003d \u0027NEW\u0027;\n\n          // times\n          originRow[J_COL_CREATED_AT - 1]  \u003d now;\n          originRow[J_COL_UPDATED_AT - 1]  \u003d now;\n\n          // location (origin)\n          originRow[J_COL_DEST_LAT - 1]    \u003d oriLat;\n          originRow[J_COL_DEST_LNG - 1]    \u003d oriLng;\n          originRow[J_COL_RADIUS_M - 1]    \u003d oriRadius;\n\n          // sourceRow ‡∏Ç‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á \u003d ‡∏ß‡πà‡∏≤‡∏á (‡∏ï‡∏≤‡∏° logic ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)\n          originRow[J_COL_SOURCE_ROW - 1]  \u003d \u0027\u0027;\n\n          // ‚úÖ vehicleDescription -\u003e AD\n          originRow[J_COL_VEHICLE_DESC - 1] \u003d vehicleDescription || \u0027\u0027;\n\n          // write (fixed width)\n          jobSheet.getRange(jobSheet.getLastRow() + 1, 1, 1, J_COL_LAST).setValues([originRow]);\n\n      }\n\n      // 4.1.2 ‡πÅ‡∏ñ‡∏ß‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á\n      Object.keys(stationMap).forEach(key \u003d\u003e {\n        const entry      \u003d stationMap[key];\n        const row        \u003d entry.row;\n        const zoRowIndex \u003d entry.zoRowIndex;\n\n        const shipmentNo  \u003d String(row[cols.SHIPMENT  - 1] || \u0027\u0027).trim();\n        const referenceNo \u003d String(row[cols.REFERENCE - 1] || \u0027\u0027).trim();\n        const shipToCode  \u003d entry.isFallback\n          ? \u0027\u0027\n          : String(row[cols.SHIP_TO_CODE - 1] || \u0027\u0027).trim();\n        const shipToName  \u003d String(row[cols.SHIP_TO_NAME - 1] || \u0027\u0027).trim();\n        const distanceKm  \u003d entry.distanceKm;\n\n        const loc     \u003d shipToCode ? getLocationConfigByCode(shipToCode) : null;\n        const destLat \u003d loc ? loc.lat : \u0027\u0027;\n        const destLng \u003d loc ? loc.lng : \u0027\u0027;\n        const radiusM \u003d (loc \u0026\u0026 !isNaN(loc.radiusM)) ? loc.radiusM : 50;\n\n        // 4.1.2 ‡πÅ‡∏ñ‡∏ß‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á (FIX: ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡∏∂‡∏á J_COL_LAST ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ vehicleDescription ‡πÑ‡∏õ‡∏•‡∏á AD ‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô)\n          ensureJobdataHasCols_(jobSheet);\n\n          const destRow \u003d new Array(J_COL_LAST).fill(\u0027\u0027);\n\n          // core\n          destRow[J_COL_REFERENCE - 1]   \u003d referenceNo;\n          destRow[J_COL_SHIPMENT - 1]    \u003d shipmentNo;\n          destRow[J_COL_SHIPTO_CODE - 1] \u003d shipToCode;\n          destRow[J_COL_SHIPTO_NAME - 1] \u003d shipToName;\n          destRow[J_COL_STATUS - 1]      \u003d \u0027NEW\u0027;\n\n          // sourceRow (‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡∏°‡∏µ sourceRow)\n          destRow[J_COL_SOURCE_ROW - 1]  \u003d zoRowIndex;\n\n          // times\n          destRow[J_COL_CREATED_AT - 1]  \u003d now;\n          destRow[J_COL_UPDATED_AT - 1]  \u003d now;\n\n          // location (destination)\n          destRow[J_COL_DEST_LAT - 1]    \u003d destLat;\n          destRow[J_COL_DEST_LNG - 1]    \u003d destLng;\n          destRow[J_COL_RADIUS_M - 1]    \u003d radiusM;\n\n          // distance (‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà W \u003d J_COL_DISTANCE_KM)\n          destRow[J_COL_DISTANCE_KM - 1] \u003d distanceKm;\n\n          // ‚úÖ vehicleDescription -\u003e AD\n          destRow[J_COL_VEHICLE_DESC - 1] \u003d vehicleDescription || \u0027\u0027;\n\n          // write (fixed width)\n          jobSheet.getRange(jobSheet.getLastRow() + 1, 1, 1, J_COL_LAST).setValues([destRow]);\n\n      });\n\n      // reload jobRowsForRef ‡∏´‡∏•‡∏±‡∏á appendRow\n      const newJobLastRow \u003d jobSheet.getLastRow();\n      const newJobValues  \u003d jobSheet.getRange(2, 1, newJobLastRow - 1, J_COL_LAST).getValues();\n\n      jobRowsForRef \u003d [];\n      newJobValues.forEach((row, idx) \u003d\u003e {\n        const ref \u003d String(row[J_COL_REFERENCE - 1] || \u0027\u0027).trim();\n        if (ref \u003d\u003d\u003d targetReference) {\n          jobRowsForRef.push({\n            rowIndex: idx + 2,\n            row:      row\n          });\n        }\n      });\n    }\n\n    if (jobRowsForRef.length \u003d\u003d\u003d 0) {\n      return jsonResponse({\n        success: false,\n        message: \u0027‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô jobdata ‡∏´‡∏•‡∏±‡∏á copy ‡∏à‡∏≤‡∏Å zoile30Connect\u0027\n      });\n    }\n\n    // ---------- 5. jobClosed / tripEnded flag ----------\n    const jobClosed \u003d jobRowsForRef.every(obj \u003d\u003e {\n      const row      \u003d obj.row;\n      const status   \u003d String(row[J_COL_STATUS - 1] || \u0027\u0027).trim().toUpperCase();\n      const closedAt \u003d row[J_COL_JOB_CLOSED_AT - 1];\n      return status \u003d\u003d\u003d \u0027JOB_DONE\u0027 || !!closedAt;\n    });\n\n    const tripEnded \u003d jobRowsForRef.every(obj \u003d\u003e {\n      const row         \u003d obj.row;\n      const tripEndedAt \u003d row[J_COL_TRIP_ENDED_AT - 1];\n      return !!tripEndedAt;\n    });\n\n    // ---------- 6. ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå‡πÅ‡∏•‡πâ‡∏ß ----------\n    let checkedDrivers \u003d [];\n    if (drivers.length \u003e 0) {\n      const ss      \u003d SpreadsheetApp.openById(SHEET_ID);\n      let alcoSheet \u003d ss.getSheetByName(SHEET_ALCOHOL);\n      if (alcoSheet) {\n        const last \u003d alcoSheet.getLastRow();\n        if (last \u003e 1) {\n          const data \u003d alcoSheet.getRange(2, 1, last - 1, 3).getValues();\n          checkedDrivers \u003d data\n            .filter(r \u003d\u003e String(r[0] || \u0027\u0027).trim() \u003d\u003d\u003d targetReference)\n            .map(r \u003d\u003e String(r[1] || \u0027\u0027).trim())\n            .filter(n \u003d\u003e n);\n        }\n      }\n      checkedDrivers \u003d Array.from(new Set(checkedDrivers));\n    }\n\n    // ---------- 7. ‡∏™‡∏£‡πâ‡∏≤‡∏á stops ----------\n    const stops       \u003d [];\n    const shipmentSet \u003d {};\n    const stationSeen \u003d {};\n\n    jobRowsForRef.forEach(obj \u003d\u003e {\n      const row      \u003d obj.row;\n      const rowIndex \u003d obj.rowIndex;\n\n      const referenceNo \u003d String(row[J_COL_REFERENCE   - 1] || \u0027\u0027).trim();\n      const shipmentNo  \u003d String(row[J_COL_SHIPMENT    - 1] || \u0027\u0027).trim();\n      const shipToCode  \u003d String(row[J_COL_SHIPTO_CODE - 1] || \u0027\u0027).trim();\n      const shipToName  \u003d String(row[J_COL_SHIPTO_NAME - 1] || \u0027\u0027).trim();\n      const status      \u003d String(row[J_COL_STATUS      - 1] || \u0027\u0027).trim();\n      const checkIn     \u003d row[J_COL_CHECKIN           - 1];\n      const checkOut    \u003d row[J_COL_CHECKOUT          - 1];\n      const fueling     \u003d row[J_COL_FUELING_TIME      - 1];\n      const unloadDone  \u003d row[J_COL_UNLOAD_DONE_TIME  - 1];\n      const reviewed    \u003d row[J_COL_REVIEWED_TIME     - 1];\n      const distanceKm  \u003d row[J_COL_DISTANCE_KM       - 1];\n      const checkInOdo  \u003d row[J_COL_CHECKIN_ODO       - 1];\n\n      const destLat     \u003d row[J_COL_DEST_LAT          - 1];\n      const destLng     \u003d row[J_COL_DEST_LNG          - 1];\n\n      const sourceRow    \u003d row[J_COL_SOURCE_ROW       - 1];\n      const isOriginStop \u003d !sourceRow;\n\n      if (shipmentNo) shipmentSet[shipmentNo] \u003d true;\n\n      const stationKey \u003d shipToCode || (\u0027NAME:\u0027 + shipToName);\n\n      if (stationSeen[stationKey] \u0026\u0026 !isOriginStop) return;\n      stationSeen[stationKey] \u003d true;\n\n      const agg \u003d stationAgg[stationKey] || null;\n      const materialsArray \u003d agg\n        ? Object.keys(agg.materials).map(k \u003d\u003e agg.materials[k])\n        : [];\n\n      stops.push({\n        seq:            0,\n        shipmentNo:     shipmentNo,\n        referenceNo:    referenceNo,\n        destination1:   shipToCode,\n        destination2:   shipToName,\n        status:         status,\n        checkInTime:    formatDateForClient(checkIn),\n        checkOutTime:   formatDateForClient(checkOut),\n        fuelingTime:    formatDateForClient(fueling),\n        unloadDoneTime: formatDateForClient(unloadDone),\n        reviewedTime:   formatDateForClient(reviewed),\n        distanceKm:     distanceKm,\n        checkInOdo:     checkInOdo,\n        rowIndex:       rowIndex,\n        totalQty:       agg ? agg.totalQty : null,\n        linesCount:     agg ? agg.linesCount : 0,\n        materials:      materialsArray,\n        isOriginStop:   isOriginStop,\n        destLat:        destLat,\n        destLng:        destLng\n      });\n    });\n\n    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Seq\n    stops.forEach((s, i) \u003d\u003e { s.seq \u003d i + 1; });\n\n    const shipmentList \u003d Object.keys(shipmentSet);\n\n    return jsonResponse({\n      success: true,\n      data: {\n        referenceNo: targetReference,\n        shipmentNos: shipmentList,\n        shipmentNo:  shipmentList.length \u003d\u003d\u003d 1 ? shipmentList[0] : \u0027\u0027,\n        vehicleDescription: vehicleDescription, // ‚úÖ FIX: ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÉ‡∏´‡πâ frontend\n        totalStops:  stops.length,\n        stops:       stops,\n        alcohol: {\n          drivers:        drivers,\n          checkedDrivers: checkedDrivers\n        },\n        jobClosed: jobClosed,\n        tripEnded: tripEnded   // frontend ‡πÉ‡∏ä‡πâ‡∏ã‡πà‡∏≠‡∏ô/‡πÇ‡∏ä‡∏ß‡πå‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ\n      }\n    });\n  } catch (err) {\n    Logger.log(\u0027handleSearchShipment error: \u0027 + err);\n    return jsonResponse({ success: false, message: \u0027SERVER_ERROR: \u0027 + err });\n  }\n}\n\n/********************************\n * Helper: ‡πÄ‡∏õ‡πà‡∏≤‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ñ‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á (‡∏ï‡∏≤‡∏° reference)\n ********************************/\nfunction hasAtLeastOneAlcoholChecked(reference) {\n  const ref \u003d String(reference || \u0027\u0027).trim();\n  if (!ref) return false;\n\n  const ss \u003d SpreadsheetApp.openById(SHEET_ID);\n  const sheet \u003d ss.getSheetByName(SHEET_ALCOHOL);\n  if (!sheet) return false;\n\n  const last \u003d sheet.getLastRow();\n  if (last \u003c 2) return false;\n\n  // A\u003dreference, B\u003ddriverName\n  const rows \u003d sheet.getRange(2, 1, last - 1, 2).getValues();\n  return rows.some(r \u003d\u003e String(r[0] || \u0027\u0027).trim() \u003d\u003d\u003d ref);\n}\n\n/********************************\n * handleUpdateStop\n ********************************/\nfunction handleUpdateStop(e) {\n  try {\n    const rowIndex       \u003d parseInt(e.parameter.rowIndex, 10);\n    const newStatus      \u003d (e.parameter.status || \u0027\u0027).trim();\n    const actionTypeRaw  \u003d (e.parameter.type   || \u0027\u0027).trim();\n    const actionType     \u003d actionTypeRaw.toLowerCase(); // ‚úÖ ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö \u0027fuel\u0027 / \u0027FUEL\u0027 / \u0027Fuel\u0027\n    const userId         \u003d e.parameter.userId  || \u0027\u0027;\n\n    const lat            \u003d parseFloat(e.parameter.lat);\n    const lng            \u003d parseFloat(e.parameter.lng);\n    const odoRaw         \u003d e.parameter.odo || \u0027\u0027;\n\n    if (!rowIndex || !newStatus || !actionType) {\n      return jsonResponse({\n        success: false,\n        message: \u0027‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö (rowIndex/status/type)\u0027\n      });\n    }\n\n    if (actionType \u003d\u003d\u003d \u0027checkin\u0027 \u0026\u0026 !odoRaw) {\n      return jsonResponse({\n        success: false,\n        message: \u0027‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡∏£‡∏ñ‡∏Å‡πà‡∏≠‡∏ô Check-in\u0027\n      });\n    }\n\n    if (isNaN(lat) || isNaN(lng)) {\n      return jsonResponse({\n        success: false,\n        message: \u0027‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏à‡∏≤‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏î‡πâ\u0027\n      });\n    }\n\n    if (userId) {\n      const status \u003d getUserStatus(userId);\n      if (status !\u003d\u003d \u0027APPROVED\u0027) {\n        return jsonResponse({\n          success: false,\n          message: \u0027‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö\u0027\n        });\n      }\n    } else {\n      return jsonResponse({\n        success: false,\n        message: \u0027‡πÑ‡∏°‡πà‡∏û‡∏ö userId\u0027\n      });\n    }\n\n    const mainSS   \u003d SpreadsheetApp.openById(SHEET_ID);\n    const jobSheet \u003d mainSS.getSheetByName(SHEET_JOBDATA);\n    if (!jobSheet) {\n      return jsonResponse({ success: false, message: \u0027‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ó jobdata ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏´‡∏•‡∏±‡∏Å\u0027 });\n    }\n\n    const lastRow \u003d jobSheet.getLastRow();\n    if (rowIndex \u003c 2 || rowIndex \u003e lastRow) {\n      return jsonResponse({\n        success: false,\n        message: \u0027rowIndex ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á\u0027\n      });\n    }\n\n    const now       \u003d new Date();\n    const rowValues \u003d jobSheet.getRange(rowIndex, 1, 1, J_COL_LAST).getValues()[0];\n    const referenceInRow \u003d String(rowValues[J_COL_REFERENCE - 1] || \u0027\u0027).trim();\n    const sourceRow      \u003d rowValues[J_COL_SOURCE_ROW - 1];\n    const isOriginStop   \u003d !sourceRow;\n\n    // ‚úÖ NEW: ‡∏≠‡∏ô‡∏∏‡πÇ‡∏•‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏î‡πâ ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πà‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ñ‡∏ô\n    if (actionType \u003d\u003d\u003d \u0027checkin\u0027 \u0026\u0026 isOriginStop) {\n      if (!hasAtLeastOneAlcoholChecked(referenceInRow)) {\n        return jsonResponse({\n          success: false,\n          message: \u0027‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡πà‡∏≤‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ñ‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á\u0027\n        });\n      }\n    }\n\n    const destLat   \u003d parseFloat(rowValues[J_COL_DEST_LAT - 1]);\n    const destLng   \u003d parseFloat(rowValues[J_COL_DEST_LNG - 1]);\n    const radiusM   \u003d parseFloat(rowValues[J_COL_RADIUS_M - 1]);\n\n    let finalRadius \u003d (!isNaN(radiusM) \u0026\u0026 radiusM \u003e 0) ? radiusM : 50;\n\n    // ‚úÖ ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á ‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡πá‡∏Ñ‡∏£‡∏∞‡∏¢‡∏∞‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï\n    if (!isNaN(destLat) \u0026\u0026 !isNaN(destLng)) {\n      const distance \u003d haversineDistanceMeters(destLat, destLng, lat, lng);\n\n      if (distance \u003e finalRadius) {\n        return jsonResponse({\n          success: false,\n          message:\n            \u0027‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î (‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢ \u0027 +\n            Math.round(distance) +\n            \u0027 ‡πÄ‡∏°‡∏ï‡∏£ / ‡∏£‡∏±‡∏®‡∏°‡∏µ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï \u0027 +\n            Math.round(finalRadius) +\n            \u0027 ‡πÄ‡∏°‡∏ï‡∏£)\u0027\n        });\n      }\n    } else {\n      finalRadius \u003d 50;\n    }\n\n    // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏´‡∏•‡∏±‡∏Å + updatedBy / updatedAt\n    jobSheet.getRange(rowIndex, J_COL_STATUS).setValue(newStatus);\n    jobSheet.getRange(rowIndex, J_COL_UPDATED_BY).setValue(userId);\n    jobSheet.getRange(rowIndex, J_COL_UPDATED_AT).setValue(now);\n\n    // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï field ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó action\n    if (actionType \u003d\u003d\u003d \u0027checkin\u0027) {\n      jobSheet.getRange(rowIndex, J_COL_CHECKIN).setValue(now);\n      jobSheet.getRange(rowIndex, J_COL_CHECKIN_LAT).setValue(lat);\n      jobSheet.getRange(rowIndex, J_COL_CHECKIN_LNG).setValue(lng);\n      jobSheet.getRange(rowIndex, J_COL_CHECKIN_ODO).setValue(odoRaw);\n    } else if (actionType \u003d\u003d\u003d \u0027checkout\u0027) {\n      jobSheet.getRange(rowIndex, J_COL_CHECKOUT).setValue(now);\n      jobSheet.getRange(rowIndex, J_COL_CHECKOUT_LAT).setValue(lat);\n      jobSheet.getRange(rowIndex, J_COL_CHECKOUT_LNG).setValue(lng);\n    } else if (actionType \u003d\u003d\u003d \u0027fuel\u0027 || actionType \u003d\u003d\u003d \u0027fueling\u0027) {\n      jobSheet.getRange(rowIndex, J_COL_FUELING_TIME).setValue(now);\n    } else if (actionType \u003d\u003d\u003d \u0027unload\u0027 || actionType \u003d\u003d\u003d \u0027unload_done\u0027) {\n      jobSheet.getRange(rowIndex, J_COL_UNLOAD_DONE_TIME).setValue(now);\n    } else if (actionType \u003d\u003d\u003d \u0027review\u0027) {\n      jobSheet.getRange(rowIndex, J_COL_REVIEWED_TIME).setValue(now);\n    }\n\n    // ‚úÖ FIX: ‡∏Å‡∏±‡∏ô‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡πà‡∏≤\n    SpreadsheetApp.flush();\n\n    const updatedRow \u003d jobSheet.getRange(rowIndex, 1, 1, J_COL_LAST).getValues()[0];\n\n    const responseStop \u003d {\n      rowIndex:        rowIndex,\n      referenceNo:     String(updatedRow[J_COL_REFERENCE - 1]   || \u0027\u0027).trim(),\n      shipmentNo:      String(updatedRow[J_COL_SHIPMENT - 1]    || \u0027\u0027).trim(),\n      destination1:    String(updatedRow[J_COL_SHIPTO_CODE - 1] || \u0027\u0027).trim(),\n      destination2:    String(updatedRow[J_COL_SHIPTO_NAME - 1] || \u0027\u0027).trim(),\n      status:          String(updatedRow[J_COL_STATUS - 1]      || \u0027\u0027).trim(),\n      checkInTime:     formatDateForClient(updatedRow[J_COL_CHECKIN - 1]),\n      checkOutTime:    formatDateForClient(updatedRow[J_COL_CHECKOUT - 1]),\n      fuelingTime:     formatDateForClient(updatedRow[J_COL_FUELING_TIME - 1]),\n      unloadDoneTime:  formatDateForClient(updatedRow[J_COL_UNLOAD_DONE_TIME - 1]),\n      reviewedTime:    formatDateForClient(updatedRow[J_COL_REVIEWED_TIME - 1]),\n      distanceKm:      updatedRow[J_COL_DISTANCE_KM - 1],\n      checkInOdo:      updatedRow[J_COL_CHECKIN_ODO - 1],\n      updatedBy:       String(updatedRow[J_COL_UPDATED_BY - 1]  || \u0027\u0027).trim()\n    };\n\n    return jsonResponse({\n      success: true,\n      message: \u0027‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à\u0027,\n      stop: responseStop\n    });\n  } catch (err) {\n    Logger.log(\u0027handleUpdateStop error: \u0027 + err);\n    return jsonResponse({ success: false, message: \u0027SERVER_ERROR: \u0027 + err });\n  }\n}\n\n/********************************\n * handleAlcoholUpload\n ********************************/\nfunction handleAlcoholUpload(body) {\n  try {\n    const reference   \u003d (body.reference || \"\").trim();\n    const driverName  \u003d (body.driverName || \"\").trim();\n    const userId      \u003d body.userId || \"\";\n    const alcoholRaw  \u003d body.alcoholValue;\n    let   imageBase64 \u003d body.imageBase64 || \"\";\n    const lat         \u003d body.lat;\n    const lng         \u003d body.lng;\n\n    if (!reference || !driverName) {\n      return { success: false, message: \"‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö (reference/driverName)\" };\n    }\n\n    if (!userId) {\n      return { success: false, message: \"‡πÑ‡∏°‡πà‡∏û‡∏ö userId\" };\n    }\n\n    const status \u003d getUserStatus(userId);\n    if (status !\u003d\u003d \"APPROVED\") {\n      return { success: false, message: \"‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö\" };\n    }\n\n    const alcoholValue \u003d parseFloat(alcoholRaw);\n    if (isNaN(alcoholValue)) {\n      return { success: false, message: \"‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç\" };\n    }\n\n    Logger.log(\"handleAlcoholUpload: imageBase64 length \u003d \" + (imageBase64 ? imageBase64.length : 0));\n\n    if (imageBase64 \u0026\u0026 imageBase64.indexOf(\",\") !\u003d\u003d -1) {\n      imageBase64 \u003d imageBase64.split(\",\").pop();\n    }\n\n    const now      \u003d new Date();\n    const timezone \u003d Session.getScriptTimeZone();\n    const tsStr    \u003d Utilities.formatDate(now, timezone, \"yyyyMMdd_HHmmss\");\n\n    const ss \u003d SpreadsheetApp.openById(SHEET_ID);\n    let sheet \u003d ss.getSheetByName(SHEET_ALCOHOL);\n    if (!sheet) {\n      sheet \u003d ss.insertSheet(SHEET_ALCOHOL);\n      sheet.getRange(1, 1, 1, 8).setValues([[\n        \"reference\",\n        \"driverName\",\n        \"alcoholValue\",\n        \"checkedAt\",\n        \"userId\",\n        \"lat\",\n        \"lng\",\n        \"imageUrl\"\n      ]]);\n    }\n\n    let imageUrl \u003d \"\";\n\n    if (imageBase64) {\n      try {\n        const bytes \u003d Utilities.base64Decode(imageBase64);\n\n        let parentFolder;\n        try {\n          parentFolder \u003d DriveApp.getFolderById(ALC_PARENT_FOLDER_ID);\n        } catch (e) {\n          Logger.log(\"getFolderById error, fallback to root: \" + e);\n          parentFolder \u003d DriveApp.getRootFolder();\n        }\n\n        let userFolder;\n        try {\n          const subFolders \u003d parentFolder.getFoldersByName(userId);\n          if (subFolders.hasNext()) {\n            userFolder \u003d subFolders.next();\n          } else {\n            userFolder \u003d parentFolder.createFolder(userId);\n          }\n        } catch (e) {\n          Logger.log(\"create/find userFolder error, fallback to parentFolder: \" + e);\n          userFolder \u003d parentFolder;\n        }\n\n        const safeDriver \u003d driverName.replace(/[^a-zA-Z0-9‡∏Å-‡πô _-]/g, \"\");\n        const fileName \u003d\n          \"alc_\" +\n          reference +\n          \"_\" +\n          safeDriver +\n          \"_\" +\n          tsStr +\n          \"_\" +\n          (lat || \"noLat\") +\n          \"_\" +\n          (lng || \"noLng\") +\n          \".jpg\";\n\n        const blob \u003d Utilities.newBlob(bytes, \"image/jpeg\", fileName);\n        const file \u003d userFolder.createFile(blob);\n        imageUrl   \u003d file.getUrl();\n        Logger.log(\"handleAlcoholUpload: file created at \" + imageUrl);\n      } catch (e) {\n        Logger.log(\"handleAlcoholUpload: image upload error \u003d \" + e);\n      }\n    } else {\n      Logger.log(\"handleAlcoholUpload: no imageBase64 received\");\n    }\n\n    sheet.appendRow([\n      reference,\n      driverName,\n      alcoholValue,\n      now,\n      userId,\n      lat,\n      lng,\n      imageUrl\n    ]);\n\n    const lastRow \u003d sheet.getLastRow();\n    let checkedDrivers \u003d [];\n    if (lastRow \u003e 1) {\n      const data \u003d sheet.getRange(2, 1, lastRow - 1, 2).getValues();\n      checkedDrivers \u003d data\n        .filter(r \u003d\u003e String(r[0] || \"\").trim() \u003d\u003d\u003d reference)\n        .map(r \u003d\u003e String(r[1] || \"\").trim())\n        .filter(n \u003d\u003e n);\n      checkedDrivers \u003d Array.from(new Set(checkedDrivers));\n    }\n\n    return {\n      success: true,\n      message: \"‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à\",\n      checkedDrivers: checkedDrivers\n    };\n  } catch (err) {\n    Logger.log(\"handleAlcoholUpload error: \" + err);\n    return { success: false, message: \"SERVER_ERROR: \" + err };\n  }\n}\n\n/********************************\n * handleReviewUpload\n ********************************/\nfunction handleReviewUpload(body) {\n  try {\n    const referenceRaw \u003d body.reference || \u0027\u0027;\n    const reference    \u003d referenceRaw.trim();\n    const rowIndex     \u003d parseInt(body.rowIndex, 10);\n    const userId       \u003d body.userId || \u0027\u0027;\n    const score        \u003d (body.score || \u0027\u0027).trim();\n    const lat          \u003d body.lat;\n    const lng          \u003d body.lng;\n    let   sigBase64    \u003d body.signatureBase64 || \u0027\u0027;\n\n    if (!reference || !rowIndex) {\n      return { success: false, message: \u0027‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö (reference/rowIndex)\u0027 };\n    }\n\n    if (!userId) {\n      return { success: false, message: \u0027‡πÑ‡∏°‡πà‡∏û‡∏ö userId\u0027 };\n    }\n\n    const status \u003d getUserStatus(userId);\n    if (status !\u003d\u003d \u0027APPROVED\u0027) {\n      return { success: false, message: \u0027‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö\u0027 };\n    }\n\n    if (!score) {\n      return { success: false, message: \u0027‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏∂‡∏á‡∏û‡∏≠‡πÉ‡∏à\u0027 };\n    }\n\n    const latNum \u003d parseFloat(lat);\n    const lngNum \u003d parseFloat(lng);\n    if (isNaN(latNum) || isNaN(lngNum)) {\n      return { success: false, message: \u0027‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏à‡∏≤‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏î‡πâ\u0027 };\n    }\n\n    const mainSS   \u003d SpreadsheetApp.openById(SHEET_ID);\n    const jobSheet \u003d mainSS.getSheetByName(SHEET_JOBDATA);\n    if (!jobSheet) {\n      return { success: false, message: \u0027‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ó jobdata ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏´‡∏•‡∏±‡∏Å\u0027 };\n    }\n\n    const lastRow \u003d jobSheet.getLastRow();\n    if (rowIndex \u003c 2 || rowIndex \u003e lastRow) {\n      return { success: false, message: \u0027rowIndex ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á\u0027 };\n    }\n\n    const rowValues \u003d jobSheet.getRange(rowIndex, 1, 1, J_COL_LAST).getValues()[0];\n\n    const refInRow \u003d String(rowValues[J_COL_REFERENCE - 1] || \u0027\u0027).trim();\n    if (refInRow !\u003d\u003d reference) {\n      return { success: false, message: \u0027‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡πÄ‡∏•‡∏Ç‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö\u0027 };\n    }\n\n    const destLat   \u003d parseFloat(rowValues[J_COL_DEST_LAT - 1]);\n    const destLng   \u003d parseFloat(rowValues[J_COL_DEST_LNG - 1]);\n    const radiusM   \u003d parseFloat(rowValues[J_COL_RADIUS_M - 1]);\n    let   finalRad  \u003d (!isNaN(radiusM) \u0026\u0026 radiusM \u003e 0) ? radiusM : 50;\n\n    if (!isNaN(destLat) \u0026\u0026 !isNaN(destLng)) {\n      const distance \u003d haversineDistanceMeters(destLat, destLng, latNum, lngNum);\n      if (distance \u003e finalRad) {\n        return {\n          success: false,\n          message:\n            \u0027‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î (‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢ \u0027 +\n            Math.round(distance) +\n            \u0027 ‡πÄ‡∏°‡∏ï‡∏£ / ‡∏£‡∏±‡∏®‡∏°‡∏µ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï \u0027 +\n            Math.round(finalRad) +\n            \u0027 ‡πÄ‡∏°‡∏ï‡∏£)\u0027\n        };\n      }\n    }\n\n    const now      \u003d new Date();\n    const timezone \u003d Session.getScriptTimeZone();\n    const tsStr    \u003d Utilities.formatDate(now, timezone, \u0027yyyyMMdd_HHmmss\u0027);\n\n    let reviewSheet \u003d mainSS.getSheetByName(SHEET_REVIEW);\n    if (!reviewSheet) {\n      reviewSheet \u003d mainSS.insertSheet(SHEET_REVIEW);\n      reviewSheet.getRange(1, 1, 1, 11).setValues([[\n        \u0027reference\u0027,\n        \u0027rowIndex\u0027,\n        \u0027shipmentNo\u0027,\n        \u0027destinationCode\u0027,\n        \u0027destinationName\u0027,\n        \u0027score\u0027,\n        \u0027reviewedAt\u0027,\n        \u0027userId\u0027,\n        \u0027lat\u0027,\n        \u0027lng\u0027,\n        \u0027signatureUrl\u0027\n      ]]);\n    }\n\n    const shipmentNo \u003d String(rowValues[J_COL_SHIPMENT    - 1] || \u0027\u0027).trim();\n    const destCode   \u003d String(rowValues[J_COL_SHIPTO_CODE - 1] || \u0027\u0027).trim();\n    const destName   \u003d String(rowValues[J_COL_SHIPTO_NAME - 1] || \u0027\u0027).trim();\n\n    let signatureUrl \u003d \u0027\u0027;\n\n    if (sigBase64) {\n      try {\n        if (sigBase64.indexOf(\u0027,\u0027) !\u003d\u003d -1) {\n          sigBase64 \u003d sigBase64.split(\u0027,\u0027).pop();\n        }\n\n        const bytes \u003d Utilities.base64Decode(sigBase64);\n\n        let parentFolder;\n        try {\n          parentFolder \u003d DriveApp.getFolderById(ALC_PARENT_FOLDER_ID);\n        } catch (e) {\n          Logger.log(\u0027handleReviewUpload getFolderById error ‚Üí root: \u0027 + e);\n          parentFolder \u003d DriveApp.getRootFolder();\n        }\n\n        let userFolder;\n        try {\n          const sub \u003d parentFolder.getFoldersByName(userId);\n          if (sub.hasNext()) {\n            userFolder \u003d sub.next();\n          } else {\n            userFolder \u003d parentFolder.createFolder(userId);\n          }\n        } catch (e) {\n          Logger.log(\u0027handleReviewUpload get/create userFolder error: \u0027 + e);\n          userFolder \u003d parentFolder;\n        }\n\n        const safeDest \u003d destName.replace(/[^a-zA-Z0-9‡∏Å-‡πô _-]/g, \u0027\u0027);\n        const fileName \u003d\n          \u0027review_\u0027 +\n          reference +\n          \u0027_\u0027 +\n          safeDest +\n          \u0027_\u0027 +\n          tsStr +\n          \u0027_\u0027 +\n          (lat || \u0027noLat\u0027) +\n          \u0027_\u0027 +\n          (lng || \u0027noLng\u0027) +\n          \u0027.png\u0027;\n\n        const blob \u003d Utilities.newBlob(bytes, \u0027image/png\u0027, fileName);\n        const file \u003d userFolder.createFile(blob);\n        signatureUrl \u003d file.getUrl();\n      } catch (e) {\n        Logger.log(\u0027handleReviewUpload signature upload error: \u0027 + e);\n      }\n    }\n\n    reviewSheet.appendRow([\n      reference,\n      rowIndex,\n      shipmentNo,\n      destCode,\n      destName,\n      score,\n      now,\n      userId,\n      latNum,\n      lngNum,\n      signatureUrl\n    ]);\n\n    // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏ô jobdata ‡πÄ‡∏õ‡πá‡∏ô REVIEWED\n    jobSheet.getRange(rowIndex, J_COL_STATUS).setValue(\u0027REVIEWED\u0027);\n    jobSheet.getRange(rowIndex, J_COL_REVIEWED_TIME).setValue(now);\n    jobSheet.getRange(rowIndex, J_COL_UPDATED_BY).setValue(userId);\n    jobSheet.getRange(rowIndex, J_COL_UPDATED_AT).setValue(now);\n\n    SpreadsheetApp.flush();\n\n    const updatedRow \u003d jobSheet.getRange(rowIndex, 1, 1, J_COL_LAST).getValues()[0];\n\n    const responseStop \u003d {\n      rowIndex:        rowIndex,\n      referenceNo:     String(updatedRow[J_COL_REFERENCE - 1]   || \u0027\u0027).trim(),\n      shipmentNo:      String(updatedRow[J_COL_SHIPMENT - 1]    || \u0027\u0027).trim(),\n      destination1:    String(updatedRow[J_COL_SHIPTO_CODE - 1] || \u0027\u0027).trim(),\n      destination2:    String(updatedRow[J_COL_SHIPTO_NAME - 1] || \u0027\u0027).trim(),\n      status:          String(updatedRow[J_COL_STATUS - 1]      || \u0027\u0027).trim(),\n      checkInTime:     formatDateForClient(updatedRow[J_COL_CHECKIN - 1]),\n      checkOutTime:    formatDateForClient(updatedRow[J_COL_CHECKOUT - 1]),\n      fuelingTime:     formatDateForClient(updatedRow[J_COL_FUELING_TIME - 1]),\n      unloadDoneTime:  formatDateForClient(updatedRow[J_COL_UNLOAD_DONE_TIME - 1]),\n      reviewedTime:    formatDateForClient(updatedRow[J_COL_REVIEWED_TIME - 1]),\n      distanceKm:      updatedRow[J_COL_DISTANCE_KM - 1],\n      checkInOdo:      updatedRow[J_COL_CHECKIN_ODO - 1],\n      updatedBy:       String(updatedRow[J_COL_UPDATED_BY - 1]  || \u0027\u0027).trim()\n    };\n\n    return {\n      success: true,\n      message: \u0027‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à\u0027,\n      stop: responseStop\n    };\n  } catch (err) {\n    Logger.log(\u0027handleReviewUpload error: \u0027 + err);\n    return { success: false, message: \u0027SERVER_ERROR: \u0027 + err };\n  }\n}\n\n/********************************\n * handleCloseJob\n ********************************/\nfunction handleCloseJob(e) {\n  try {\n    const reference \u003d (e.parameter.reference || \u0027\u0027).trim();\n    const userId    \u003d e.parameter.userId || \u0027\u0027;\n\n    if (!reference) {\n      return jsonResponse({ success: false, message: \u0027‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏•‡∏Ç Reference ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô\u0027 });\n    }\n\n    if (!userId) {\n      return jsonResponse({ success: false, message: \u0027‡πÑ‡∏°‡πà‡∏û‡∏ö userId\u0027 });\n    }\n\n    const userStatus \u003d getUserStatus(userId);\n    if (userStatus !\u003d\u003d \u0027APPROVED\u0027) {\n      return jsonResponse({\n        success: false,\n        message: \u0027‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö\u0027\n      });\n    }\n\n    const mainSS   \u003d SpreadsheetApp.openById(SHEET_ID);\n    const jobSheet \u003d mainSS.getSheetByName(SHEET_JOBDATA);\n    if (!jobSheet) {\n      return jsonResponse({ success: false, message: \u0027‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ó jobdata ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏´‡∏•‡∏±‡∏Å\u0027 });\n    }\n\n    const lastRow \u003d jobSheet.getLastRow();\n    if (lastRow \u003c 2) {\n      return jsonResponse({ success: false, message: \u0027‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• jobdata\u0027 });\n    }\n\n    const values \u003d jobSheet.getRange(2, 1, lastRow - 1, J_COL_LAST).getValues();\n    const now \u003d new Date();\n\n    const refRows \u003d [];\n    values.forEach((row, idx) \u003d\u003e {\n      const ref \u003d String(row[J_COL_REFERENCE - 1] || \u0027\u0027).trim();\n      if (ref \u003d\u003d\u003d reference) {\n        refRows.push({ rowIndex: idx + 2, row: row });\n      }\n    });\n\n    if (refRows.length \u003d\u003d\u003d 0) {\n      return jsonResponse({\n        success: false,\n        message: \u0027‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô Reference ‡∏ô‡∏µ‡πâ‡πÉ‡∏ô jobdata\u0027\n      });\n    }\n\n    const alreadyClosed \u003d refRows.every(r \u003d\u003e {\n      const status  \u003d String(r.row[J_COL_STATUS - 1] || \u0027\u0027).trim();\n      const closedAt \u003d r.row[J_COL_JOB_CLOSED_AT - 1];\n      return status \u003d\u003d\u003d \u0027JOB_DONE\u0027 || !!closedAt;\n    });\n    if (alreadyClosed) {\n      return jsonResponse({\n        success: false,\n        message: \u0027‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß\u0027\n      });\n    }\n\n    const notCheckout \u003d refRows.filter(r \u003d\u003e !r.row[J_COL_CHECKOUT - 1]);\n    if (notCheckout.length \u003e 0) {\n      return jsonResponse({\n        success: false,\n        message: \u0027‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ Check-out ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏à‡∏∏‡∏î ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ\u0027\n      });\n    }\n\n    const batchValues \u003d [];\n    refRows.forEach(info \u003d\u003e {\n      const rowArr \u003d jobSheet.getRange(info.rowIndex, 1, 1, J_COL_LAST).getValues()[0];\n      rowArr[J_COL_STATUS - 1]        \u003d \u0027JOB_DONE\u0027;\n      rowArr[J_COL_UPDATED_BY - 1]    \u003d userId;\n      rowArr[J_COL_UPDATED_AT - 1]    \u003d now;\n      rowArr[J_COL_JOB_CLOSED_AT - 1] \u003d now;\n      batchValues.push({ rowIndex: info.rowIndex, row: rowArr });\n    });\n\n    batchValues.forEach(b \u003d\u003e {\n      jobSheet.getRange(b.rowIndex, 1, 1, J_COL_LAST).setValues([b.row]);\n    });\n\n    SpreadsheetApp.flush();\n\n    const firstRow \u003d batchValues[0].row;\n\n    const stop \u003d {\n      rowIndex:        batchValues[0].rowIndex,\n      referenceNo:     String(firstRow[J_COL_REFERENCE - 1]   || \u0027\u0027).trim(),\n      shipmentNo:      String(firstRow[J_COL_SHIPMENT - 1]    || \u0027\u0027).trim(),\n      destination1:    String(firstRow[J_COL_SHIPTO_CODE - 1] || \u0027\u0027).trim(),\n      destination2:    String(firstRow[J_COL_SHIPTO_NAME - 1] || \u0027\u0027).trim(),\n      status:          String(firstRow[J_COL_STATUS - 1]      || \u0027\u0027).trim(),\n      checkInTime:     formatDateForClient(firstRow[J_COL_CHECKIN - 1]),\n      checkOutTime:    formatDateForClient(firstRow[J_COL_CHECKOUT - 1]),\n      fuelingTime:     formatDateForClient(firstRow[J_COL_FUELING_TIME - 1]),\n      unloadDoneTime:  formatDateForClient(firstRow[J_COL_UNLOAD_DONE_TIME - 1]),\n      reviewedTime:    formatDateForClient(firstRow[J_COL_REVIEWED_TIME - 1]),\n      jobClosedAt:     formatDateForClient(firstRow[J_COL_JOB_CLOSED_AT - 1]),\n      distanceKm:      firstRow[J_COL_DISTANCE_KM - 1],\n      checkInOdo:      firstRow[J_COL_CHECKIN_ODO - 1],\n      updatedBy:       String(firstRow[J_COL_UPDATED_BY - 1]  || \u0027\u0027).trim()\n    };\n\n    return jsonResponse({\n      success: true,\n      message: \u0027‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏£‡∏ñ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß\u0027,\n      stop: stop\n    });\n  } catch (err) {\n    Logger.log(\u0027handleCloseJob error: \u0027 + err);\n    return jsonResponse({ success: false, message: \u0027SERVER_ERROR: \u0027 + err });\n  }\n}\n\n/********************************\n * handleEndTripSummary\n * ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ‡∏•‡∏á jobdata (Y‚ÄìAC)\n ********************************/\nfunction handleEndTripSummary(body) {\n  try {\n    const reference    \u003d (body.reference    || \u0027\u0027).toString().trim();\n    const userId       \u003d (body.userId       || \u0027\u0027).toString().trim();\n    const endOdo       \u003d (body.endOdo       || \u0027\u0027).toString().trim();\n    const endPointName \u003d (body.endPointName || \u0027\u0027).toString().trim();\n    const latStr       \u003d (body.lat          || \u0027\u0027).toString().trim();\n    const lngStr       \u003d (body.lng          || \u0027\u0027).toString().trim();\n\n    Logger.log(\u0027[EndTrip] ref\u003d%s user\u003d%s odo\u003d%s point\u003d%s lat\u003d%s lng\u003d%s\u0027,\n      reference, userId, endOdo, endPointName, latStr, lngStr);\n\n    if (!reference) return { success: false, message: \u0027‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏•‡∏Ç Reference ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ\u0027 };\n    if (!userId)    return { success: false, message: \u0027‡πÑ‡∏°‡πà‡∏û‡∏ö userId\u0027 };\n\n    // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏Å‡πà‡∏≠‡∏ô\n    const status \u003d getUserStatus(userId);\n    if (status !\u003d\u003d \u0027APPROVED\u0027) {\n      return { success: false, message: \u0027‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö\u0027 };\n    }\n\n    if (!endOdo)       return { success: false, message: \u0027‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ\u0027 };\n    if (!endPointName) return { success: false, message: \u0027‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏∏‡∏î‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ\u0027 };\n\n    const latNum \u003d parseFloat(latStr);\n    const lngNum \u003d parseFloat(lngStr);\n\n    const mainSS   \u003d SpreadsheetApp.openById(SHEET_ID);\n    const jobSheet \u003d mainSS.getSheetByName(SHEET_JOBDATA);\n    if (!jobSheet) return { success: false, message: \u0027‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ó jobdata ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏´‡∏•‡∏±‡∏Å\u0027 };\n\n    const lastRow \u003d jobSheet.getLastRow();\n    if (lastRow \u003c 2) return { success: false, message: \u0027‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• jobdata\u0027 };\n\n    // ‚úÖ ‡∏´‡∏≤ row ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á reference ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô\n    const values  \u003d jobSheet.getRange(2, 1, lastRow - 1, J_COL_LAST).getValues();\n    const refRows \u003d [];\n    values.forEach((row, idx) \u003d\u003e {\n      const ref \u003d String(row[J_COL_REFERENCE - 1] || \u0027\u0027).trim();\n      if (ref \u003d\u003d\u003d reference) {\n        refRows.push({ rowIndex: idx + 2, row: row });\n      }\n    });\n\n    if (refRows.length \u003d\u003d\u003d 0) {\n      return {\n        success: false,\n        message: \u0027‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô Reference ‡∏ô‡∏µ‡πâ‡πÉ‡∏ô jobdata ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ\u0027\n      };\n    }\n\n    const now \u003d new Date();\n\n    // ‚úÖ ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡πÅ‡∏ñ‡∏ß‡∏Ç‡∏≠‡∏á Reference ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô\n    refRows.forEach(info \u003d\u003e {\n      const r \u003d info.rowIndex;\n      const currentStatus \u003d String(info.row[J_COL_STATUS - 1] || \u0027\u0027).trim();\n\n      jobSheet.getRange(r, J_COL_TRIP_END_ODO).setValue(endOdo);\n      jobSheet.getRange(r, J_COL_TRIP_END_LAT).setValue(latNum);\n      jobSheet.getRange(r, J_COL_TRIP_END_LNG).setValue(lngNum);\n      jobSheet.getRange(r, J_COL_TRIP_END_PLACE).setValue(endPointName);\n      jobSheet.getRange(r, J_COL_TRIP_ENDED_AT).setValue(now);\n\n      // ‚úÖ FIX (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç): ‡∏ï‡∏±‡πâ‡∏á END_TRIP ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà \"‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà\" JOB_DONE (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô)\n      if (currentStatus !\u003d\u003d \u0027JOB_DONE\u0027) {\n        jobSheet.getRange(r, J_COL_STATUS).setValue(\u0027END_TRIP\u0027);\n      }\n\n      // updateBy / updateAt\n      jobSheet.getRange(r, J_COL_UPDATED_BY).setValue(userId);\n      jobSheet.getRange(r, J_COL_UPDATED_AT).setValue(now);\n    });\n\n    SpreadsheetApp.flush();\n\n    return { success: true, message: \u0027‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß\u0027 };\n  } catch (err) {\n    Logger.log(\u0027handleEndTripSummary error: \u0027 + err);\n    return { success: false, message: \u0027SERVER_ERROR: \u0027 + err };\n  }\n}\n\n/********************************\n * ‚úÖ isAdminUser\n * ‡πÄ‡∏ä‡πá‡∏Ñ userId ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡∏µ‡∏ó admin (‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå A) ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà\n ********************************/\nfunction isAdminUser(userId) {\n  const uid \u003d String(userId || \u0027\u0027).trim();\n  if (!uid) return false;\n\n  const ss \u003d SpreadsheetApp.openById(SHEET_ID);\n  const sh \u003d ss.getSheetByName(SHEET_ADMIN);\n  if (!sh) return false;\n\n  const last \u003d sh.getLastRow();\n  if (last \u003c 2) return false;\n\n  const ids \u003d sh.getRange(2, 1, last - 1, 1).getValues().map(r \u003d\u003e String(r[0] || \u0027\u0027).trim());\n  return ids.indexOf(uid) !\u003d\u003d -1;\n}\n\n/********************************\n * ‚úÖ handleAdminAddStop\n * ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ä‡∏µ‡∏ó jobdata ‡∏î‡πâ‡∏ß‡∏¢ reference\n *\n * ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ 2 ‡πÅ‡∏ö‡∏ö:\n * 1) GET:  ?action\u003dadminAddStop\u0026adminUserId\u003dUxxx\u0026reference\u003dREFxxx\u0026shipToCode\u003dxxx\u0026shipToName\u003d‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏∏‡∏î\u0026lat\u003d..\u0026lng\u003d..\u0026radiusM\u003d..\n * 2) POST JSON: { action:\"adminAddStop\", adminUserId:\"\", reference:\"\", shipToCode:\"\", shipToName:\"\", lat:\"\", lng:\"\", radiusM:\"\" }\n ********************************/\nfunction handleAdminAddStop(input) {\n  try {\n    // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á e.parameter ‡πÅ‡∏•‡∏∞ body\n    const p \u003d (input \u0026\u0026 input.parameter) ? input.parameter : (input || {});\n\n    const adminUserId \u003d String(p.adminUserId || \u0027\u0027).trim();\n    const reference   \u003d String(p.reference   || \u0027\u0027).trim();\n    const shipToCode  \u003d String(p.shipToCode  || \u0027\u0027).trim();\n    const shipToName  \u003d String(p.shipToName  || \u0027\u0027).trim();\n\n    const latNum      \u003d (p.lat !\u003d\u003d undefined \u0026\u0026 p.lat !\u003d\u003d \u0027\u0027) ? parseFloat(p.lat) : \u0027\u0027;\n    const lngNum      \u003d (p.lng !\u003d\u003d undefined \u0026\u0026 p.lng !\u003d\u003d \u0027\u0027) ? parseFloat(p.lng) : \u0027\u0027;\n    const radiusMNum  \u003d (p.radiusM !\u003d\u003d undefined \u0026\u0026 p.radiusM !\u003d\u003d \u0027\u0027) ? parseFloat(p.radiusM) : \u0027\u0027;\n\n    if (!adminUserId) return { success: false, message: \u0027‡πÑ‡∏°‡πà‡∏û‡∏ö adminUserId\u0027 };\n    if (!reference)   return { success: false, message: \u0027‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡πÄ‡∏•‡∏Ç reference\u0027 };\n    if (!shipToName)  return { success: false, message: \u0027‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏∏‡∏î (shipToName)\u0027 };\n\n    // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå admin\n    if (!isAdminUser(adminUserId)) {\n      return { success: false, message: \u0027‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå admin\u0027 };\n    }\n\n    const ss \u003d SpreadsheetApp.openById(SHEET_ID);\n    const jobSheet \u003d ss.getSheetByName(SHEET_JOBDATA);\n    if (!jobSheet) return { success: false, message: \u0027‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ó jobdata\u0027 };\n\n    const lastRow \u003d jobSheet.getLastRow();\n    if (lastRow \u003c 2) return { success: false, message: \u0027‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• jobdata\u0027 };\n\n    // ‡∏´‡∏≤ reference ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á shipmentNo (‡πÉ‡∏ä‡πâ‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏à‡∏≠)\n    const values \u003d jobSheet.getRange(2, 1, lastRow - 1, J_COL_LAST).getValues();\n    const baseRow \u003d values.find(r \u003d\u003e String(r[J_COL_REFERENCE - 1] || \u0027\u0027).trim() \u003d\u003d\u003d reference);\n\n    if (!baseRow) {\n      return { success: false, message: \u0027‡πÑ‡∏°‡πà‡∏û‡∏ö reference ‡∏ô‡∏µ‡πâ‡πÉ‡∏ô jobdata (‡πÉ‡∏´‡πâ‡∏Ñ‡πâ‡∏ô/‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô)\u0027 };\n    }\n\n    const shipmentNo \u003d String(baseRow[J_COL_SHIPMENT - 1] || \u0027\u0027).trim();\n    const now \u003d new Date();\n\n    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡∏¢‡∏≤‡∏ß‡πÄ‡∏ó‡πà‡∏≤ J_COL_LAST\n    const newRow \u003d new Array(J_COL_LAST).fill(\u0027\u0027);\n\n    newRow[J_COL_REFERENCE - 1]   \u003d reference;\n    newRow[J_COL_SHIPMENT - 1]    \u003d shipmentNo;\n\n    newRow[J_COL_SHIPTO_CODE - 1] \u003d shipToCode;\n    newRow[J_COL_SHIPTO_NAME - 1] \u003d shipToName;\n\n    // ‚úÖ ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ó‡∏≥‡πÉ‡∏´‡πâ \"‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á\" (‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì \u003d sourceRow ‡∏ß‡πà‡∏≤‡∏á)\n    newRow[J_COL_SOURCE_ROW - 1]  \u003d \u0027ADMIN_EXTRA_STOP\u0027;\n\n    newRow[J_COL_STATUS - 1]      \u003d \u0027NEW\u0027;\n\n    // ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏à‡∏∏‡∏î (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) + radius\n    if (latNum !\u003d\u003d \u0027\u0027 \u0026\u0026 !isNaN(latNum)) newRow[J_COL_DEST_LAT - 1] \u003d latNum;\n    if (lngNum !\u003d\u003d \u0027\u0027 \u0026\u0026 !isNaN(lngNum)) newRow[J_COL_DEST_LNG - 1] \u003d lngNum;\n\n    const finalRadius \u003d (radiusMNum !\u003d\u003d \u0027\u0027 \u0026\u0026 !isNaN(radiusMNum)) ? radiusMNum : 50;\n    newRow[J_COL_RADIUS_M - 1]    \u003d finalRadius;\n\n    // updated\n    newRow[J_COL_UPDATED_BY - 1]  \u003d adminUserId;\n    newRow[J_COL_UPDATED_AT - 1]  \u003d now;\n\n    // (optional) ‡πÉ‡∏´‡πâ‡∏°‡∏µ checkin/checkout/time fields ‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà\n\n    jobSheet.appendRow(newRow);\n\n    SpreadsheetApp.flush();\n\n    return {\n      success: true,\n      message: \u0027‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢\u0027,\n      data: {\n        reference,\n        shipmentNo,\n        shipToCode,\n        shipToName,\n        lat: (latNum \u003d\u003d\u003d \u0027\u0027 || isNaN(latNum)) ? \u0027\u0027 : latNum,\n        lng: (lngNum \u003d\u003d\u003d \u0027\u0027 || isNaN(lngNum)) ? \u0027\u0027 : lngNum,\n        radiusM: finalRadius\n      }\n    };\n\n  } catch (err) {\n    Logger.log(\u0027handleAdminAddStop error: \u0027 + err);\n    return { success: false, message: \u0027SERVER_ERROR: \u0027 + err };\n  }\n}\n"},{"id":"d0a6d580-8d13-4692-8670-46b65b4c6349","name":"adminApi","type":"server_js","source":"/********************************\n * Helper: log ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° admin ‡∏•‡∏á‡∏ä‡∏µ‡∏ó adminlog\n ********************************/\nfunction logAdminAction(adminUserId, action, detailObj) {\n  try {\n    const ss \u003d SpreadsheetApp.openById(SHEET_ID);\n    let sheet \u003d ss.getSheetByName(SHEET_ADMIN_LOG);\n    if (!sheet) {\n      sheet \u003d ss.insertSheet(SHEET_ADMIN_LOG);\n      sheet.getRange(1, 1, 1, 4).setValues([[\n        \u0027timestamp\u0027,\n        \u0027adminUserId\u0027,\n        \u0027action\u0027,\n        \u0027detailJson\u0027\n      ]]);\n    }\n    const ts \u003d new Date();\n    const detailJson \u003d detailObj ? JSON.stringify(detailObj) : \u0027\u0027;\n    sheet.appendRow([ts, adminUserId, action, detailJson]);\n  } catch (e) {\n    Logger.log(\u0027logAdminAction error: \u0027 + e);\n  }\n}\n\n/********************************\n * Admin: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏à‡∏≤‡∏Å userprofile\n ********************************/\nfunction handleCheckAdmin(e) {\n  const userId \u003d (e.parameter.userId || \u0027\u0027).trim();\n  if (!userId) {\n    return jsonResponse({ success: false, isAdmin: false, message: \u0027‡πÑ‡∏°‡πà‡∏û‡∏ö userId\u0027 });\n  }\n  const ok \u003d isAdminUser(userId);\n  return jsonResponse({ success: true, isAdmin: ok });\n}\n\n/********************************\n * Admin: ‡∏î‡∏∂‡∏á jobdata\n ********************************/\nfunction handleAdminJobdata(e) {\n  try {\n    const adminUserId \u003d (e.parameter.adminUserId || \u0027\u0027).trim();\n    if (!isAdminUser(adminUserId)) {\n      return jsonResponse({ success: false, message: \u0027‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (admin)\u0027 });\n    }\n\n    const refFilter    \u003d (e.parameter.reference || \u0027\u0027).trim();\n    const statusFilter \u003d (e.parameter.status    || \u0027\u0027).trim().toUpperCase();\n    const limit        \u003d parseInt(e.parameter.limit, 10) || 200;\n\n    const ss    \u003d SpreadsheetApp.openById(SHEET_ID);\n    const sheet \u003d ss.getSheetByName(SHEET_JOBDATA);\n    if (!sheet) {\n      return jsonResponse({ success: false, message: \u0027‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ó jobdata ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏´‡∏•‡∏±‡∏Å\u0027 });\n    }\n\n    const lastRow \u003d sheet.getLastRow();\n    if (lastRow \u003c 2) {\n      return jsonResponse({ success: true, rows: [] });\n    }\n\n    const values \u003d sheet.getRange(2, 1, lastRow - 1, J_COL_LAST).getValues();\n    const rows   \u003d [];\n\n    values.forEach(function (r, idx) {\n      const rowIndex    \u003d idx + 2;\n      const referenceNo \u003d String(r[J_COL_REFERENCE   - 1] || \u0027\u0027).trim();\n      const shipmentNo  \u003d String(r[J_COL_SHIPMENT    - 1] || \u0027\u0027).trim();\n      const destCode    \u003d String(r[J_COL_SHIPTO_CODE - 1] || \u0027\u0027).trim();\n      const destName    \u003d String(r[J_COL_SHIPTO_NAME - 1] || \u0027\u0027).trim();\n      const statusRaw   \u003d String(r[J_COL_STATUS      - 1] || \u0027\u0027).trim();\n      const status      \u003d statusRaw.toUpperCase();\n      const checkIn     \u003d r[J_COL_CHECKIN      - 1];\n      const checkOut    \u003d r[J_COL_CHECKOUT     - 1];\n      const checkInOdo  \u003d r[J_COL_CHECKIN_ODO  - 1];\n      const updatedBy   \u003d String(r[J_COL_UPDATED_BY - 1] || \u0027\u0027).trim();\n      const updatedAt   \u003d r[J_COL_UPDATED_AT   - 1];\n\n      if (refFilter \u0026\u0026 referenceNo.indexOf(refFilter) \u003d\u003d\u003d -1) return;\n      if (statusFilter \u0026\u0026 status !\u003d\u003d statusFilter) return;\n\n      rows.push({\n        rowIndex:     rowIndex,\n        referenceNo:  referenceNo,\n        shipmentNo:   shipmentNo,\n        destination1: destCode,\n        destination2: destName,\n        status:       status,\n        checkInTime:  formatDateForClient(checkIn),\n        checkOutTime: formatDateForClient(checkOut),\n        checkInOdo:   checkInOdo,\n        updatedBy:    updatedBy,\n        updatedAtObj: updatedAt,\n        updatedAt:    formatDateForClient(updatedAt)\n      });\n    });\n\n    rows.sort(function (a, b) {\n      const da \u003d (a.updatedAtObj instanceof Date) ? a.updatedAtObj.getTime() : 0;\n      const db \u003d (b.updatedAtObj instanceof Date) ? b.updatedAtObj.getTime() : 0;\n      return db - da;\n    });\n\n    const limited \u003d rows.slice(0, limit).map(function (r) {\n      delete r.updatedAtObj;\n      return r;\n    });\n\n    logAdminAction(adminUserId, \u0027READ_JOBDATA\u0027, {\n      refFilter,\n      statusFilter,\n      count: limited.length\n    });\n\n    return jsonResponse({ success: true, rows: limited });\n  } catch (err) {\n    Logger.log(\u0027handleAdminJobdata error: \u0027 + err);\n    return jsonResponse({ success: false, message: \u0027SERVER_ERROR: \u0027 + err });\n  }\n}\n\n/********************************\n * Admin: ‡∏î‡∏∂‡∏á alcoholcheck\n ********************************/\nfunction handleAdminAlcohol(e) {\n  try {\n    const adminUserId \u003d (e.parameter.adminUserId || \u0027\u0027).trim();\n    if (!isAdminUser(adminUserId)) {\n      return jsonResponse({ success: false, message: \u0027‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (admin)\u0027 });\n    }\n\n    const refFilter    \u003d (e.parameter.reference || \u0027\u0027).trim();\n    const driverFilter \u003d (e.parameter.driver    || \u0027\u0027).trim().toLowerCase();\n    const limit        \u003d parseInt(e.parameter.limit, 10) || 200;\n\n    const ss    \u003d SpreadsheetApp.openById(SHEET_ID);\n    const sheet \u003d ss.getSheetByName(SHEET_ALCOHOL);\n    if (!sheet) {\n      return jsonResponse({ success: false, message: \u0027‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ó alcoholcheck ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏´‡∏•‡∏±‡∏Å\u0027 });\n    }\n\n    const lastRow \u003d sheet.getLastRow();\n    if (lastRow \u003c 2) {\n      return jsonResponse({ success: true, rows: [] });\n    }\n\n    const data \u003d sheet.getRange(2, 1, lastRow - 1, 8).getValues();\n    const rows \u003d [];\n\n    data.forEach(function (r, idx) {\n      const rowIndex    \u003d idx + 2;\n      const reference   \u003d String(r[0] || \u0027\u0027).trim();\n      const driverName  \u003d String(r[1] || \u0027\u0027).trim();\n      const alcoholVal  \u003d r[2];\n      const checkedAt   \u003d r[3];\n      const userId      \u003d String(r[4] || \u0027\u0027).trim();\n      const lat         \u003d r[5];\n      const lng         \u003d r[6];\n      const imageUrl    \u003d String(r[7] || \u0027\u0027).trim();\n\n      if (refFilter \u0026\u0026 reference.indexOf(refFilter) \u003d\u003d\u003d -1) return;\n      if (driverFilter \u0026\u0026 driverName.toLowerCase().indexOf(driverFilter) \u003d\u003d\u003d -1) return;\n\n      rows.push({\n        rowIndex:     rowIndex,\n        reference:    reference,\n        driverName:   driverName,\n        alcoholValue: alcoholVal,\n        checkedAtObj: checkedAt,\n        checkedAt:    formatDateForClient(checkedAt),\n        userId:       userId,\n        lat:          lat,\n        lng:          lng,\n        imageUrl:     imageUrl\n      });\n    });\n\n    rows.sort(function (a, b) {\n      const da \u003d (a.checkedAtObj instanceof Date) ? a.checkedAtObj.getTime() : 0;\n      const db \u003d (b.checkedAtObj instanceof Date) ? b.checkedAtObj.getTime() : 0;\n      return db - da;\n    });\n\n    const limited \u003d rows.slice(0, limit).map(function (r) {\n      delete r.checkedAtObj;\n      return r;\n    });\n\n    logAdminAction(adminUserId, \u0027READ_ALCOHOL\u0027, {\n      refFilter,\n      driverFilter,\n      count: limited.length\n    });\n\n    return jsonResponse({ success: true, rows: limited });\n  } catch (err) {\n    Logger.log(\u0027handleAdminAlcohol error: \u0027 + err);\n    return jsonResponse({ success: false, message: \u0027SERVER_ERROR: \u0027 + err });\n  }\n}\n\n/********************************\n * Admin: ‡∏î‡∏∂‡∏á userprofile\n ********************************/\nfunction handleAdminUserprofile(e) {\n  try {\n    const adminUserId \u003d (e.parameter.adminUserId || \u0027\u0027).trim();\n    if (!isAdminUser(adminUserId)) {\n      return jsonResponse({ success: false, message: \u0027‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (admin)\u0027 });\n    }\n\n    const statusFilter \u003d (e.parameter.status  || \u0027\u0027).trim().toUpperCase();\n    const keywordRaw   \u003d (e.parameter.keyword || \u0027\u0027).trim();\n    const keyword      \u003d keywordRaw.toLowerCase();\n\n    const ss    \u003d SpreadsheetApp.openById(SHEET_ID);\n    const sheet \u003d ss.getSheetByName(SHEET_USER_PROFILE);\n    if (!sheet) {\n      return jsonResponse({ success: false, message: \u0027‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ó userprofile\u0027 });\n    }\n\n    const lastRow \u003d sheet.getLastRow();\n    if (lastRow \u003c 2) {\n      return jsonResponse({ success: true, rows: [] });\n    }\n\n    const values \u003d sheet.getRange(2, 1, lastRow - 1, COL_USERTYPE).getValues();\n    const rows   \u003d [];\n\n    values.forEach(function (r) {\n      const userId      \u003d String(r[COL_USER_ID      - 1] || \u0027\u0027).trim();\n      const displayName \u003d String(r[COL_DISPLAY_NAME - 1] || \u0027\u0027).trim();\n      const pictureUrl  \u003d String(r[COL_PICTURE_URL  - 1] || \u0027\u0027).trim();\n      const status      \u003d String(r[COL_STATUS       - 1] || \u0027\u0027).trim().toUpperCase();\n      const createdAt   \u003d r[COL_CREATED_AT - 1];\n      const updatedAt   \u003d r[COL_UPDATED_AT - 1];\n      const userType    \u003d String(r[COL_USERTYPE     - 1] || \u0027\u0027).trim().toUpperCase();\n\n      if (statusFilter \u0026\u0026 status !\u003d\u003d statusFilter) return;\n\n      if (keyword) {\n        const combined \u003d (userId + \u0027 \u0027 + displayName).toLowerCase();\n        if (combined.indexOf(keyword) \u003d\u003d\u003d -1) return;\n      }\n\n      rows.push({\n        userId:        userId,\n        displayName:   displayName,\n        pictureUrl:    pictureUrl,\n        status:        status,\n        userType:      userType,\n        createdAtObj:  createdAt,\n        updatedAtObj:  updatedAt,\n        createdAt:     formatDateForClient(createdAt),\n        updatedAt:     formatDateForClient(updatedAt)\n      });\n    });\n\n    rows.sort(function (a, b) {\n      const da \u003d (a.createdAtObj instanceof Date) ? a.createdAtObj.getTime() : 0;\n      const db \u003d (b.createdAtObj instanceof Date) ? b.createdAtObj.getTime() : 0;\n      return db - da;\n    });\n\n    const cleaned \u003d rows.map(function (r) {\n      delete r.createdAtObj;\n      delete r.updatedAtObj;\n      return r;\n    });\n\n    logAdminAction(adminUserId, \u0027READ_USERPROFILE\u0027, {\n      statusFilter,\n      keyword: keywordRaw,\n      count: cleaned.length\n    });\n\n    return jsonResponse({ success: true, rows: cleaned });\n  } catch (err) {\n    Logger.log(\u0027handleAdminUserprofile error: \u0027 + err);\n    return jsonResponse({ success: false, message: \u0027SERVER_ERROR: \u0027 + err });\n  }\n}\n\n/********************************\n * Admin: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï jobdata (status)\n ********************************/\nfunction handleAdminUpdateJob(body) {\n  try {\n    const adminUserId \u003d (body.adminUserId || \u0027\u0027).trim();\n    if (!isAdminUser(adminUserId)) {\n      return { success: false, message: \u0027‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (admin)\u0027 };\n    }\n\n    const rowIndex  \u003d parseInt(body.rowIndex, 10);\n    const newStatus \u003d (body.status || \u0027\u0027).trim();\n\n    if (!rowIndex || !newStatus) {\n      return { success: false, message: \u0027‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö (rowIndex/status)\u0027 };\n    }\n\n    const ss    \u003d SpreadsheetApp.openById(SHEET_ID);\n    const sheet \u003d ss.getSheetByName(SHEET_JOBDATA);\n    if (!sheet) {\n      return { success: false, message: \u0027‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ó jobdata ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏´‡∏•‡∏±‡∏Å\u0027 };\n    }\n\n    const lastRow \u003d sheet.getLastRow();\n    if (rowIndex \u003c 2 || rowIndex \u003e lastRow) {\n      return { success: false, message: \u0027rowIndex ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á\u0027 };\n    }\n\n    const now \u003d new Date();\n\n    sheet.getRange(rowIndex, J_COL_STATUS).setValue(newStatus);\n    sheet.getRange(rowIndex, J_COL_UPDATED_AT).setValue(now);\n    sheet.getRange(rowIndex, J_COL_UPDATED_BY).setValue(adminUserId);\n\n    const row \u003d sheet.getRange(rowIndex, 1, 1, J_COL_LAST).getValues()[0];\n\n    logAdminAction(adminUserId, \u0027UPDATE_JOBDATA\u0027, {\n      rowIndex: rowIndex,\n      newStatus: newStatus\n    });\n\n    return {\n      success: true,\n      row: {\n        rowIndex:    rowIndex,\n        referenceNo: String(row[J_COL_REFERENCE - 1] || \u0027\u0027).trim(),\n        shipmentNo:  String(row[J_COL_SHIPMENT  - 1] || \u0027\u0027).trim(),\n        status:      String(row[J_COL_STATUS    - 1] || \u0027\u0027).trim(),\n        updatedAt:   formatDateForClient(row[J_COL_UPDATED_AT - 1]),\n        updatedBy:   String(row[J_COL_UPDATED_BY - 1] || \u0027\u0027).trim()\n      }\n    };\n  } catch (err) {\n    Logger.log(\u0027handleAdminUpdateJob error: \u0027 + err);\n    return { success: false, message: \u0027SERVER_ERROR: \u0027 + err };\n  }\n}\n\n/********************************\n * Admin: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï alcoholcheck (‡∏Ñ‡πà‡∏≤ alcoholValue)\n ********************************/\nfunction handleAdminUpdateAlcohol(body) {\n  try {\n    const adminUserId \u003d (body.adminUserId || \u0027\u0027).trim();\n    if (!isAdminUser(adminUserId)) {\n      return { success: false, message: \u0027‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (admin)\u0027 };\n    }\n\n    const rowIndex     \u003d parseInt(body.rowIndex, 10);\n    const alcoholRaw   \u003d body.alcoholValue;\n    const alcoholValue \u003d parseFloat(alcoholRaw);\n\n    if (!rowIndex || isNaN(alcoholValue)) {\n      return { success: false, message: \u0027‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á\u0027 };\n    }\n\n    const ss    \u003d SpreadsheetApp.openById(SHEET_ID);\n    const sheet \u003d ss.getSheetByName(SHEET_ALCOHOL);\n    if (!sheet) {\n      return { success: false, message: \u0027‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ó alcoholcheck ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏´‡∏•‡∏±‡∏Å\u0027 };\n    }\n\n    const lastRow \u003d sheet.getLastRow();\n    if (rowIndex \u003c 2 || rowIndex \u003e lastRow) {\n      return { success: false, message: \u0027rowIndex ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á\u0027 };\n    }\n\n    const now \u003d new Date();\n    sheet.getRange(rowIndex, 3).setValue(alcoholValue); // C: alcoholValue\n    sheet.getRange(rowIndex, 4).setValue(now);          // D: checkedAt\n\n    const row \u003d sheet.getRange(rowIndex, 1, 1, 8).getValues()[0];\n\n    logAdminAction(adminUserId, \u0027UPDATE_ALCOHOL\u0027, {\n      rowIndex: rowIndex,\n      alcoholValue: alcoholValue\n    });\n\n    return {\n      success: true,\n      row: {\n        rowIndex:     rowIndex,\n        reference:    String(row[0] || \u0027\u0027).trim(),\n        driverName:   String(row[1] || \u0027\u0027).trim(),\n        alcoholValue: row[2],\n        checkedAt:    formatDateForClient(row[3])\n      }\n    };\n  } catch (err) {\n    Logger.log(\u0027handleAdminUpdateAlcohol error: \u0027 + err);\n    return { success: false, message: \u0027SERVER_ERROR: \u0027 + err };\n  }\n}\n\n/********************************\n * Admin: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ userprofile\n ********************************/\nfunction handleAdminUpdateUserStatus(body) {\n  try {\n    const adminUserId \u003d (body.adminUserId || \u0027\u0027).trim();\n    if (!isAdminUser(adminUserId)) {\n      return { success: false, message: \u0027‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (admin)\u0027 };\n    }\n\n    const userIdRaw \u003d body.userId || \u0027\u0027;\n    const statusRaw \u003d body.status || \u0027\u0027;\n\n    const userId    \u003d String(userIdRaw).trim();\n    const newStatus \u003d String(statusRaw).trim().toUpperCase();\n\n    if (!userId) {\n      return { success: false, message: \u0027‡πÑ‡∏°‡πà‡∏û‡∏ö userId ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï\u0027 };\n    }\n    if (!newStatus) {\n      return { success: false, message: \u0027‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡∏°‡πà\u0027 };\n    }\n\n    const ss    \u003d SpreadsheetApp.openById(SHEET_ID);\n    const sheet \u003d ss.getSheetByName(SHEET_USER_PROFILE);\n    if (!sheet) {\n      return { success: false, message: \u0027‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ó userprofile\u0027 };\n    }\n\n    const lastRow \u003d sheet.getLastRow();\n    if (lastRow \u003c 2) {\n      return { success: false, message: \u0027‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• userprofile\u0027 };\n    }\n\n    const values \u003d sheet.getRange(2, 1, lastRow - 1, COL_UPDATED_AT).getValues();\n    let foundRow \u003d -1;\n\n    for (let i \u003d 0; i \u003c values.length; i++) {\n      const rowUserId \u003d String(values[i][COL_USER_ID - 1] || \u0027\u0027).trim();\n      if (rowUserId \u003d\u003d\u003d userId) {\n        foundRow \u003d i + 2;\n        break;\n      }\n    }\n\n    if (foundRow \u003d\u003d\u003d -1) {\n      return { success: false, message: \u0027‡πÑ‡∏°‡πà‡∏û‡∏ö userId ‡∏ô‡∏µ‡πâ‡πÉ‡∏ô userprofile\u0027 };\n    }\n\n    const now \u003d new Date();\n    sheet.getRange(foundRow, COL_STATUS).setValue(newStatus);\n    sheet.getRange(foundRow, COL_UPDATED_AT).setValue(now);\n\n    if (newStatus \u003d\u003d\u003d \u0027APPROVED\u0027) {\n      const result \u003d linkRichMenuToUser(userId, RICH_MENU_ID_MENU1);\n      Logger.log(\u0027handleAdminUpdateUserStatus: linkRichMenuToUser result\u003d\u0027 + JSON.stringify(result));\n    }\n\n    logAdminAction(adminUserId, \u0027UPDATE_USER_STATUS\u0027, {\n      targetUserId: userId,\n      newStatus: newStatus\n    });\n\n    return { success: true };\n  } catch (err) {\n    Logger.log(\u0027handleAdminUpdateUserStatus error: \u0027 + err);\n    return { success: false, message: \u0027SERVER_ERROR: \u0027 + err };\n  }\n}\n"},{"id":"f678317d-e8b5-43fc-af34-faead402e9e1","name":"router","type":"server_js","source":"/********************************\n * doGet: Web App / LIFF / Admin\n ********************************/\nfunction doGet(e) {\n  try {\n    const params \u003d (e \u0026\u0026 e.parameter) || {};\n    const action \u003d String(params.action || \u0027\u0027).toLowerCase();\n    const page   \u003d String(params.page   || \u0027\u0027).toLowerCase();\n\n    // \u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\n    // Admin APIs (GET)\n    // \u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\n    if (action \u003d\u003d\u003d \u0027checkadmin\u0027) {\n      return handleCheckAdmin(e);\n\n    } else if (action \u003d\u003d\u003d \u0027adminjobdata\u0027) {\n      return handleAdminJobdata(e);\n\n    } else if (action \u003d\u003d\u003d \u0027adminalcohol\u0027) {\n      return handleAdminAlcohol(e);\n\n    } else if (action \u003d\u003d\u003d \u0027adminuserprofile\u0027) {\n      return handleAdminUserprofile(e);\n\n    } else if (action \u003d\u003d\u003d \u0027adminaddstop\u0027) {\n      // ‚úÖ NEW: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á jobdata (GET)\n      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å: ?action\u003dadminAddStop\u0026adminUserId\u003d...\u0026reference\u003d...\u0026shipToCode\u003d...\u0026shipToName\u003d...\u0026lat\u003d...\u0026lng\u003d...\u0026radiusM\u003d...\n      const result \u003d handleAdminAddStop(e);\n      return jsonResponse(result);\n    }\n\n    // \u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\n    // Admin UI\n    // \u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\n    if (page \u003d\u003d\u003d \u0027admin\u0027) {\n      return HtmlService.createTemplateFromFile(\u0027admin\u0027)\n        .evaluate()\n        .setTitle(\u0027Admin Console - Driver Tracking\u0027)\n        .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);\n    }\n\n    // \u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\n    // Driver API (GET)\n    // \u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\n    if (action \u003d\u003d\u003d \u0027search\u0027) {\n      return handleSearchShipment(e);\n\n    } else if (action \u003d\u003d\u003d \u0027updatestop\u0027) {\n      return handleUpdateStop(e);\n\n    } else if (action \u003d\u003d\u003d \u0027closejob\u0027) {\n      return handleCloseJob(e);\n    }\n\n    // \u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\n    // Default driver UI\n    // \u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\n    return HtmlService.createTemplateFromFile(\u0027index\u0027)\n      .evaluate()\n      .setTitle(\u0027Driver Tracking\u0027)\n      .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);\n\n  } catch (err) {\n    Logger.log(\u0027doGet error: \u0027 + err);\n    return jsonResponse({ success: false, message: \u0027SERVER_ERROR: \u0027 + err });\n  }\n}\n\n/********************************\n * LINE Webhook / LIFF Upload / Admin: doPost\n ********************************/\nfunction doPost(e) {\n  try {\n    if (!e || !e.postData) {\n      return ContentService.createTextOutput(\u0027NO_EVENT\u0027);\n    }\n\n    const contentType \u003d String(e.postData.type || \u0027\u0027).toLowerCase();\n    const rawBody     \u003d e.postData.contents || \u0027\u0027;\n    let body          \u003d {};\n\n    // \u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\n    // Parse body\n    // \u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\n    if (contentType.indexOf(\u0027application/json\u0027) !\u003d\u003d -1) {\n      try {\n        body \u003d JSON.parse(rawBody || \u0027{}\u0027);\n      } catch (err) {\n        Logger.log(\u0027doPost JSON parse error (application/json): \u0027 + err);\n        body \u003d {};\n      }\n    } else {\n      const trimmed \u003d String(rawBody || \u0027\u0027).trim();\n      if (trimmed \u0026\u0026 (trimmed.startsWith(\u0027{\u0027) || trimmed.startsWith(\u0027[\u0027))) {\n        try {\n          body \u003d JSON.parse(trimmed);\n        } catch (err) {\n          Logger.log(\u0027doPost JSON parse error (text/plain): \u0027 + err);\n          body \u003d {};\n        }\n      } else {\n        // fallback: ‡πÉ‡∏ä‡πâ e.parameter\n        body \u003d {};\n        const params \u003d e.parameter || {};\n        Object.keys(params).forEach(function (k) {\n          body[k] \u003d params[k];\n        });\n      }\n    }\n\n    // \u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\n    // 1) LINE Webhook (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô)\n    // \u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\n    if (body \u0026\u0026 body.events) {\n      const events \u003d body.events || [];\n      events.forEach(function (event) {\n        const type \u003d event.type;\n        if (type \u003d\u003d\u003d \u0027follow\u0027) {\n          handleFollowEvent(event);\n        } else if (type \u003d\u003d\u003d \u0027message\u0027) {\n          handleMessageEvent(event);\n        }\n      });\n      return ContentService.createTextOutput(\u0027OK\u0027);\n    }\n\n    // normalize action\n    const action \u003d String((body \u0026\u0026 body.action) ? body.action : \u0027\u0027).toLowerCase();\n\n    // \u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\n    // 2) LIFF: ‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå\n    // \u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\n    if (action \u003d\u003d\u003d \u0027uploadalcohol\u0027) {\n      const result \u003d handleAlcoholUpload(body);\n      return jsonResponse(result);\n    }\n\n    // \u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\n    // 3) LIFF: Review + ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô\n    // \u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\n    if (action \u003d\u003d\u003d \u0027uploadreview\u0027) {\n      const result \u003d handleReviewUpload(body);\n      return jsonResponse(result);\n    }\n\n    // \u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\n    // 4) Admin: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï userprofile status\n    // \u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\n    if (action \u003d\u003d\u003d \u0027updateuserstatus\u0027) {\n      const result \u003d handleAdminUpdateUserStatus(body);\n      return jsonResponse(result);\n    }\n\n    // \u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\n    // 5) Admin: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï jobdata\n    // \u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\n    if (action \u003d\u003d\u003d \u0027adminupdatejob\u0027) {\n      const result \u003d handleAdminUpdateJob(body);\n      return jsonResponse(result);\n    }\n\n    // \u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\n    // 6) Admin: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï alcoholcheck\n    // \u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\n    if (action \u003d\u003d\u003d \u0027adminupdatealcohol\u0027) {\n      const result \u003d handleAdminUpdateAlcohol(body);\n      return jsonResponse(result);\n    }\n\n    // \u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\n    // ‚úÖ 6.1) Admin: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏° (POST)\n    // \u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\n    if (action \u003d\u003d\u003d \u0027adminaddstop\u0027) {\n      // body ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô { action:\"adminAddStop\", adminUserId:\"...\", reference:\"...\", shipToCode:\"...\", shipToName:\"...\", lat:\"\", lng:\"\", radiusM:\"\" }\n      const result \u003d handleAdminAddStop(body);\n      return jsonResponse(result);\n    }\n\n    // \u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\n    // 7) LIFF: ‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ (End Trip Summary)\n    // \u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\n    if (action \u003d\u003d\u003d \u0027endtrip\u0027) {\n      const result \u003d handleEndTripSummary(body);\n      return jsonResponse(result);\n    }\n\n    return ContentService.createTextOutput(\u0027NO_EVENT\u0027);\n\n  } catch (err) {\n    Logger.log(\u0027doPost error: \u0027 + err);\n    return ContentService.createTextOutput(\u0027ERROR\u0027);\n  }\n}\n"}]}