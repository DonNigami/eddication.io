<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DriverConnect - Supply Chain Performance Report</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #06b6d4;
            --purple: #8b5cf6;
            --dark: #1e293b;
            --light: #f8fafc;
            --gray: #64748b;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-lg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .header-left h1 {
            font-size: 24px;
            font-weight: 700;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-left h1 i {
            color: var(--primary);
        }

        .header-left p {
            color: var(--gray);
            margin-top: 4px;
        }

        .header-controls {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-family: inherit;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-outline {
            background: white;
            border: 1px solid var(--border);
            color: var(--gray);
        }

        .btn-outline:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .date-filter {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--light);
            padding: 8px 16px;
            border-radius: 8px;
        }

        .date-filter input {
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 6px 12px;
            font-family: inherit;
        }

        /* Loading State */
        .loading-container {
            background: white;
            border-radius: 16px;
            padding: 60px;
            text-align: center;
            box-shadow: var(--shadow-lg);
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--gray);
            font-size: 16px;
        }

        /* Dashboard */
        .dashboard {
            display: none;
        }

        .dashboard.loaded {
            display: block;
        }

        /* KPI Cards */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .kpi-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--shadow);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .kpi-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .kpi-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .kpi-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .kpi-icon.blue { background: #dbeafe; color: #2563eb; }
        .kpi-icon.green { background: #d1fae5; color: #10b981; }
        .kpi-icon.yellow { background: #fef3c7; color: #f59e0b; }
        .kpi-icon.purple { background: #ede9fe; color: #8b5cf6; }
        .kpi-icon.cyan { background: #cffafe; color: #06b6d4; }
        .kpi-icon.red { background: #fee2e2; color: #ef4444; }

        .kpi-trend {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            font-weight: 500;
            padding: 4px 8px;
            border-radius: 20px;
        }

        .kpi-trend.up { background: #d1fae5; color: #10b981; }
        .kpi-trend.down { background: #fee2e2; color: #ef4444; }
        .kpi-trend.neutral { background: #f1f5f9; color: #64748b; }

        .kpi-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 4px;
        }

        .kpi-label {
            color: var(--gray);
            font-size: 14px;
        }

        .kpi-target {
            font-size: 12px;
            color: var(--gray);
            margin-top: 8px;
        }

        /* Charts Section */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }

        .chart-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--shadow);
        }

        .chart-card.full-width {
            grid-column: 1 / -1;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chart-legend {
            display: flex;
            gap: 16px;
            font-size: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--gray);
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        .chart-container {
            position: relative;
            height: 280px;
        }

        /* Tables */
        .table-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--shadow);
            margin-bottom: 24px;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .table-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .data-table th {
            background: var(--light);
            font-weight: 600;
            color: var(--gray);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-table td {
            font-size: 14px;
            color: var(--dark);
        }

        .data-table tr:hover {
            background: var(--light);
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-badge.success { background: #d1fae5; color: #065f46; }
        .status-badge.warning { background: #fef3c7; color: #92400e; }
        .status-badge.danger { background: #fee2e2; color: #991b1b; }
        .status-badge.info { background: #dbeafe; color: #1e40af; }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .progress-fill.green { background: var(--secondary); }
        .progress-fill.yellow { background: var(--warning); }
        .progress-fill.red { background: var(--danger); }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            background: white;
            padding: 8px;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        .tab {
            padding: 10px 20px;
            border: none;
            background: transparent;
            border-radius: 8px;
            font-family: inherit;
            font-weight: 500;
            color: var(--gray);
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab:hover {
            color: var(--primary);
            background: var(--light);
        }

        .tab.active {
            background: var(--primary);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Status Distribution */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 16px;
        }

        .status-item {
            background: var(--light);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }

        .status-item-label {
            font-size: 12px;
            color: var(--gray);
            margin-bottom: 8px;
        }

        .status-item-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--dark);
        }

        .status-item-percent {
            font-size: 12px;
            color: var(--gray);
            margin-top: 4px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }

            .header {
                flex-direction: column;
                align-items: flex-start;
            }

            .header-controls {
                width: 100%;
            }

            .data-table {
                font-size: 12px;
            }

            .data-table th,
            .data-table td {
                padding: 8px;
            }
        }

        /* Last Update */
        .last-update {
            text-align: center;
            color: white;
            font-size: 14px;
            margin-top: 20px;
            opacity: 0.8;
        }

        /* Error State */
        .error-container {
            background: white;
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            box-shadow: var(--shadow-lg);
            display: none;
        }

        .error-container.show {
            display: block;
        }

        .error-icon {
            font-size: 48px;
            color: var(--danger);
            margin-bottom: 16px;
        }

        .error-message {
            color: var(--dark);
            font-size: 18px;
            margin-bottom: 20px;
        }

        .error-details {
            color: var(--gray);
            font-size: 14px;
            max-width: 500px;
            margin: 0 auto;
        }

        /* Station Table Enhancements */
        .station-table-benchmark {
            font-size: 11px;
            color: var(--gray);
        }

        .trend-up {
            color: #10b981;
        }

        .trend-down {
            color: #ef4444;
        }

        /* Heatmap Legend */
        .heatmap-legend {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 12px;
            justify-content: center;
        }

        .heatmap-legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            color: var(--gray);
        }

        .heatmap-legend-color {
            width: 20px;
            height: 12px;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <h1><i class="fas fa-truck-fast"></i> DriverConnect</h1>
                <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏°‡∏£‡∏£‡∏ñ‡∏ô‡∏∞‡∏´‡πà‡∏ß‡∏á‡πÇ‡∏ã‡πà‡∏≠‡∏∏‡∏õ‡∏ó‡∏≤‡∏ô (Supply Chain Performance Report)</p>
            </div>
            <div class="header-controls">
                <div class="date-filter">
                    <i class="fas fa-calendar"></i>
                    <input type="date" id="startDate">
                    <span>‡∏ñ‡∏∂‡∏á</span>
                    <input type="date" id="endDate">
                </div>
                <button class="btn btn-primary" onclick="loadData()">
                    <i class="fas fa-sync-alt"></i> ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                </button>
                <button class="btn btn-outline" onclick="exportReport()">
                    <i class="fas fa-download"></i> ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
                </button>
            </div>
        </div>

        <!-- Loading State -->
        <div class="loading-container" id="loadingContainer">
            <div class="loading-spinner"></div>
            <p class="loading-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets...</p>
        </div>

        <!-- Error State -->
        <div class="error-container" id="errorContainer">
            <div class="error-icon"><i class="fas fa-exclamation-triangle"></i></div>
            <p class="error-message">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</p>
            <p class="error-details" id="errorDetails"></p>
        </div>

        <!-- Dashboard -->
        <div class="dashboard" id="dashboard">
            <!-- KPI Cards -->
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-header">
                        <div class="kpi-icon blue"><i class="fas fa-clipboard-list"></i></div>
                        <span class="kpi-trend neutral" id="totalJobsTrend">-</span>
                    </div>
                    <div class="kpi-value" id="totalJobs">0</div>
                    <div class="kpi-label">‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                    <div class="kpi-target">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: 100% ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-header">
                        <div class="kpi-icon green"><i class="fas fa-check-circle"></i></div>
                        <span class="kpi-trend up" id="completionTrend"><i class="fas fa-arrow-up"></i> -</span>
                    </div>
                    <div class="kpi-value" id="completionRate">0%</div>
                    <div class="kpi-label">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏á‡∏≤‡∏ô</div>
                    <div class="kpi-target">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: 95%+ (World-Class: 98%+)</div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-header">
                        <div class="kpi-icon yellow"><i class="fas fa-clock"></i></div>
                        <span class="kpi-trend down" id="dwellTimeTrend"><i class="fas fa-arrow-down"></i> ‡∏î‡∏µ</span>
                    </div>
                    <div class="kpi-value" id="avgDwellTime">0 ‡∏ô‡∏≤‡∏ó‡∏µ</div>
                    <div class="kpi-label">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏à‡∏∏‡∏î‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</div>
                    <div class="kpi-target">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: < 20 ‡∏ô‡∏≤‡∏ó‡∏µ (World-Class: <15 ‡∏ô‡∏≤‡∏ó‡∏µ)</div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-header">
                        <div class="kpi-icon purple"><i class="fas fa-route"></i></div>
                        <span class="kpi-trend neutral" id="distanceTrend">-</span>
                    </div>
                    <div class="kpi-value" id="totalDistance">0 ‡∏Å‡∏°.</div>
                    <div class="kpi-label">‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏£‡∏ß‡∏°</div>
                    <div class="kpi-target">‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-header">
                        <div class="kpi-icon cyan"><i class="fas fa-map-marker-alt"></i></div>
                        <span class="kpi-trend up" id="gpsTrend"><i class="fas fa-arrow-up"></i> -</span>
                    </div>
                    <div class="kpi-value" id="gpsAccuracy">0%</div>
                    <div class="kpi-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ GPS</div>
                    <div class="kpi-target">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: 95%+ (World-Class: 99%+)</div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-header">
                        <div class="kpi-icon red"><i class="fas fa-users"></i></div>
                        <span class="kpi-trend neutral" id="driverTrend">-</span>
                    </div>
                    <div class="kpi-value" id="activeDrivers">0</div>
                    <div class="kpi-label">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
                    <div class="kpi-target">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô</div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('overview')"><i class="fas fa-chart-line"></i> ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</button>
                <button class="tab" onclick="switchTab('drivers')"><i class="fas fa-user-tie"></i> ‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</button>
                <button class="tab" onclick="switchTab('locations')"><i class="fas fa-map-marked-alt"></i> ‡∏à‡∏∏‡∏î‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</button>
                <button class="tab" onclick="switchTab('time')"><i class="fas fa-hourglass-half"></i> ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏ß‡∏•‡∏≤</button>
                <button class="tab" onclick="switchTab('status')"><i class="fas fa-tasks"></i> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô</button>
            </div>

            <!-- Overview Tab -->
            <div class="tab-content active" id="tab-overview">
                <div class="charts-grid">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title"><i class="fas fa-chart-pie"></i> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="statusChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title"><i class="fas fa-chart-bar"></i> ‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="dailyJobsChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card full-width">
                        <div class="chart-header">
                            <h3 class="chart-title"><i class="fas fa-chart-line"></i> ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Drivers Tab -->
            <div class="tab-content" id="tab-drivers">
                <div class="charts-grid">
                    <div class="chart-card full-width">
                        <div class="chart-header">
                            <h3 class="chart-title"><i class="fas fa-trophy"></i> ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="driverPerformanceChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="table-card">
                    <div class="table-header">
                        <h3 class="table-title">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö</h3>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</th>
                                <th>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö (Driver ID)</th>
                                <th>‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥</th>
                                <th>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏á‡∏≤‡∏ô</th>
                                <th>‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏£‡∏ß‡∏°</th>
                                <th>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</th>
                                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                            </tr>
                        </thead>
                        <tbody id="driverTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Locations Tab -->
            <div class="tab-content" id="tab-locations">
                <div class="charts-grid">
                    <div class="chart-card full-width">
                        <div class="chart-header">
                            <h3 class="chart-title"><i class="fas fa-map-marker-alt"></i> ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡∏à‡∏∏‡∏î‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="locationChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="table-card">
                    <div class="table-header">
                        <h3 class="table-title">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏à‡∏∏‡∏î‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</h3>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>‡∏à‡∏∏‡∏î‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</th>
                                <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</th>
                                <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏≤‡∏ô</th>
                                <th>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</th>
                                <th>‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</th>
                                <th>GPS Accuracy</th>
                            </tr>
                        </thead>
                        <tbody id="locationTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Time Analysis Tab -->
            <div class="tab-content" id="tab-time">
                <!-- Summary Cards -->
                <div class="kpi-grid" style="margin-bottom: 20px;">
                    <div class="kpi-card">
                        <div class="kpi-header">
                            <div class="kpi-icon green"><i class="fas fa-check-circle"></i></div>
                        </div>
                        <div class="kpi-value" id="withinBenchmark">0</div>
                        <div class="kpi-label">‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</div>
                        <div class="kpi-target">&lt; 20 ‡∏ô‡∏≤‡∏ó‡∏µ</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-header">
                            <div class="kpi-icon yellow"><i class="fas fa-exclamation-triangle"></i></div>
                        </div>
                        <div class="kpi-value" id="needsAttention">0</div>
                        <div class="kpi-label">‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</div>
                        <div class="kpi-target">20-40 ‡∏ô‡∏≤‡∏ó‡∏µ</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-header">
                            <div class="kpi-icon red"><i class="fas fa-exclamation-circle"></i></div>
                        </div>
                        <div class="kpi-value" id="criticalStations">0</div>
                        <div class="kpi-label">‡∏ß‡∏¥‡∏Å‡∏§‡∏ï‡∏¥</div>
                        <div class="kpi-target">&gt; 40 ‡∏ô‡∏≤‡∏ó‡∏µ</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-header">
                            <div class="kpi-icon blue"><i class="fas fa-chart-line"></i></div>
                        </div>
                        <div class="kpi-value" id="dwellTrendValue">-</div>
                        <div class="kpi-label">‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏° 7 ‡∏ß‡∏±‡∏ô</div>
                        <div class="kpi-target">‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡πà‡∏≠‡∏ô</div>
                    </div>
                </div>

                <div class="charts-grid">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title"><i class="fas fa-stopwatch"></i> Dwell Time Distribution</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="dwellTimeChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title"><i class="fas fa-clock"></i> Check-in ‡∏ï‡πà‡∏≠‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="hourlyChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="chart-card full-width">
                    <div class="chart-header">
                        <h3 class="chart-title"><i class="fas fa-map-marker-alt"></i> ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏à‡∏∏‡∏î‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ (Dwell Time by Station)</h3>
                    </div>
                    <div class="chart-container" style="height: 400px;">
                        <canvas id="stationDwellTimeChart"></canvas>
                    </div>
                </div>

                <div class="table-card">
                    <div class="table-header">
                        <h3 class="table-title">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡πà‡∏≠‡∏à‡∏∏‡∏î‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</h3>
                        <select id="stationFilter" onchange="filterStationTable()" style="padding: 8px; border-radius: 6px; border: 1px solid var(--border);">
                            <option value="all">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
                            <option value="good">üü¢ ‡∏î‡∏µ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏° (&lt;15 ‡∏ô‡∏≤‡∏ó‡∏µ)</option>
                            <option value="normal">üü° ‡∏õ‡∏Å‡∏ï‡∏¥ (15-30 ‡∏ô‡∏≤‡∏ó‡∏µ)</option>
                            <option value="warning">üü† ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° (30-45 ‡∏ô‡∏≤‡∏ó‡∏µ)</option>
                            <option value="critical">üî¥ ‡∏ß‡∏¥‡∏Å‡∏§‡∏ï‡∏¥ (&gt;45 ‡∏ô‡∏≤‡∏ó‡∏µ)</option>
                        </select>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</th>
                                <th>‡∏à‡∏∏‡∏î‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ (Station)</th>
                                <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</th>
                                <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°</th>
                                <th>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</th>
                                <th>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡πá‡∏ß‡∏™‡∏∏‡∏î</th>
                                <th>‡πÄ‡∏ß‡∏•‡∏≤‡∏ä‡πâ‡∏≤‡∏™‡∏∏‡∏î</th>
                                <th>Std Dev</th>
                                <th>Benchmark</th>
                                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                <th>‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏° 7 ‡∏ß‡∏±‡∏ô</th>
                            </tr>
                        </thead>
                        <tbody id="stationDwellTableBody">
                        </tbody>
                    </table>
                </div>

                <div class="charts-grid">
                    <div class="chart-card full-width">
                        <div class="chart-header">
                            <h3 class="chart-title"><i class="fas fa-fire"></i> Dwell Time Heatmap (‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á vs ‡∏à‡∏∏‡∏î‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£)</h3>
                        </div>
                        <div class="chart-container" style="height: 350px;">
                            <canvas id="heatmapChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="table-card" style="margin-top: 24px;">
                    <div class="table-header">
                        <h3 class="table-title">üö® ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå (Exception Report)</h3>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Reference No</th>
                                <th>‡∏à‡∏∏‡∏î‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</th>
                                <th>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö</th>
                                <th>Check-in</th>
                                <th>Check-out</th>
                                <th>‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</th>
                                <th>‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå</th>
                                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                            </tr>
                        </thead>
                        <tbody id="exceptionTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Status Tab -->
            <div class="tab-content" id="tab-status">
                <div class="status-grid" id="statusGrid">
                </div>

                <div class="table-card" style="margin-top: 24px;">
                    <div class="table-header">
                        <h3 class="table-title">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ (Pending Jobs)</h3>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Reference No</th>
                                <th>Shipment No</th>
                                <th>‡∏à‡∏∏‡∏î‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</th>
                                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                <th>Check-in Time</th>
                                <th>‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏≠</th>
                            </tr>
                        </thead>
                        <tbody id="pendingTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="last-update" id="lastUpdate">
            ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: -
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            spreadsheetId: '1UK6pdRrCGEjXmdtGe2FeSFflSimz0JhhGxAei_OKyLU',
            sheetId: '916029009',
            // For public access, we'll use the CSV export endpoint
            // Alternative: Use Google Sheets API with API key
            csvUrl: `https://docs.google.com/spreadsheets/d/e/2PACX-1vR9OlfC413WyLYWDruzoaic6QPqKoovyEpV8vee8Y9dfKtSrtEbyWEx5GCpb7xWN6nBpHGYnEcPIS8k/pub?gid=916029009&single=true&output=csv`
        };

        // Global State
        let rawData = [];
        let charts = {};
        let filteredData = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initializeDates();
            loadData();
        });

        // Set default dates (last 7 days)
        function initializeDates() {
            const end = new Date();
            const start = new Date(end);
            start.setDate(start.getDate() - 7);

            document.getElementById('endDate').value = end.toISOString().split('T')[0];
            document.getElementById('startDate').value = start.toISOString().split('T')[0];
        }

        // Load Data from Google Sheets
        async function loadData() {
            showLoading(true);
            hideError();

            try {
                // Method 1: Try CSV export (requires sheet to be published)
                const csvData = await fetchCSV(CONFIG.csvUrl);
                rawData = parseCSV(csvData);

                if (rawData.length === 0) {
                    throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Google Sheet');
                }

                filterAndProcessData();
                renderDashboard();
                showDashboard();
                updateLastUpdate();

            } catch (error) {
                console.error('Error loading data:', error);
                showError(error.message);
            } finally {
                showLoading(false);
            }
        }

        // Fetch CSV
        async function fetchCSV(url) {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP Error: ${response.status}`);
            }
            return await response.text();
        }

        // Parse CSV to JSON
        function parseCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim());
            if (lines.length < 2) return [];

            // Parse header
            const headers = parseCSVLine(lines[0]);

            // Parse data rows
            const result = [];
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length >= headers.length) {
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header.trim()] = values[index] ? values[index].trim() : '';
                    });
                    result.push(row);
                }
            }

            return result;
        }

        // Parse CSV line handling quoted values
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result;
        }

        // Filter and Process Data
        function filterAndProcessData() {
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            endDate.setHours(23, 59, 59);

            filteredData = rawData.filter(row => {
                const createdAt = parseThaiDate(row.createdAt);
                return createdAt && createdAt >= startDate && createdAt <= endDate;
            });
        }

        // Parse Thai Date
        function parseThaiDate(dateStr) {
            if (!dateStr) return null;
            try {
                // Format: "11/12/2025 15:42:05" or "12/12/2025 16:02:43"
                const parts = dateStr.split(' ');
                if (parts.length < 2) return null;

                const [day, month, year] = parts[0].split('/');
                const [time] = parts.slice(1);

                // Handle Thai year (2567 = 2024)
                let yearNum = parseInt(year);
                if (yearNum > 2500) yearNum -= 543;

                return new Date(`${yearNum}-${month}-${day} ${time}`);
            } catch (e) {
                console.error('Date parse error:', dateStr, e);
                return null;
            }
        }

        // Calculate KPIs
        function calculateKPIs() {
            const total = filteredData.length;
            const completed = filteredData.filter(r => r.status === 'END_TRIP' || r.status === 'JOB_DONE').length;
            const completionRate = total > 0 ? ((completed / total) * 100).toFixed(1) : 0;

            // Average dwell time
            const dwellTimes = filteredData
                .filter(r => r.checkIn && r.checkOut)
                .map(r => {
                    const checkIn = parseThaiDate(r.checkIn);
                    const checkOut = parseThaiDate(r.checkOut);
                    return checkIn && checkOut ? (checkOut - checkIn) / 1000 / 60 : null;
                })
                .filter(t => t !== null && t >= 0 && t <= 300); // 0-300 minutes
            const avgDwellTime = dwellTimes.length > 0
                ? (dwellTimes.reduce((a, b) => a + b, 0) / dwellTimes.length).toFixed(1)
                : 0;

            // Total distance
            const totalDistance = filteredData
                .filter(r => r['Distance (km)'])
                .map(r => parseFloat(r['Distance (km)']) || 0)
                .reduce((a, b) => a + b, 0)
                .toFixed(0);

            // GPS Accuracy
            const withGPS = filteredData.filter(r => r.checkInLat && r.checkInLng).length;
            const gpsAccuracy = total > 0 ? ((withGPS / total) * 100).toFixed(1) : 0;

            // Unique drivers
            const uniqueDrivers = [...new Set(filteredData.map(r => r.updatedBy).filter(Boolean))].length;

            return {
                total,
                completed,
                completionRate,
                avgDwellTime,
                totalDistance,
                gpsAccuracy,
                uniqueDrivers
            };
        }

        // Render Dashboard
        function renderDashboard() {
            const kpi = calculateKPIs();

            // Update KPI cards
            document.getElementById('totalJobs').textContent = kpi.total.toLocaleString('th-TH');
            document.getElementById('completionRate').textContent = `${kpi.completionRate}%`;
            document.getElementById('avgDwellTime').textContent = `${kpi.avgDwellTime} ‡∏ô‡∏≤‡∏ó‡∏µ`;
            document.getElementById('totalDistance').textContent = `${parseInt(kpi.totalDistance).toLocaleString('th-TH')} ‡∏Å‡∏°.`;
            document.getElementById('gpsAccuracy').textContent = `${kpi.gpsAccuracy}%`;
            document.getElementById('activeDrivers').textContent = kpi.uniqueDrivers;

            // Update trends
            updateTrend('completionTrend', kpi.completionRate >= 95 ? 'up' : kpi.completionRate >= 80 ? 'neutral' : 'down');
            updateTrend('dwellTimeTrend', kpi.avgDwellTime <= 15 ? 'up' : kpi.avgDwellTime <= 20 ? 'neutral' : 'down', kpi.avgDwellTime <= 20 ? '‡∏î‡∏µ' : '‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á');
            updateTrend('gpsTrend', kpi.gpsAccuracy >= 95 ? 'up' : kpi.gpsAccuracy >= 80 ? 'neutral' : 'down');

            // Calculate station dwell time data
            calculateStationDwellTime();

            // Render overview charts
            renderStatusChart();
            renderDailyJobsChart();
            renderTrendChart();

            // Render driver charts
            renderDriverPerformanceChart();
            renderDriverTable();

            // Render location charts
            renderLocationChart();
            renderLocationTable();

            // Render time analysis charts
            renderStationDwellSummary();
            renderStationDwellTimeChart();
            renderStationDwellTable();
            renderDwellTimeChart();
            renderHourlyChart();
            renderDwellTimeHeatmap();
            renderExceptionReport();

            // Render status charts
            renderStatusGrid();
            renderPendingTable();
        }

        // Update trend badge
        function updateTrend(id, direction, text) {
            const element = document.getElementById(id);
            element.className = `kpi-trend ${direction}`;
            if (text) {
                element.innerHTML = direction === 'up' || direction === 'down' ?
                    `<i class="fas fa-arrow-${direction}"></i> ${text}` : text;
            }
        }

        // Status Chart
        function renderStatusChart() {
            const statusCounts = {};
            filteredData.forEach(r => {
                const status = r.status || 'UNKNOWN';
                statusCounts[status] = (statusCounts[status] || 0) + 1;
            });

            const labels = Object.keys(statusCounts).map(s => getStatusLabel(s));
            const data = Object.values(statusCounts);
            const colors = getStatusColors(Object.keys(statusCounts));

            if (charts.status) charts.status.destroy();
            charts.status = new Chart(document.getElementById('statusChart'), {
                type: 'doughnut',
                data: {
                    labels,
                    datasets: [{
                        data,
                        backgroundColor: colors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { font: { family: 'Sarabun' } }
                        }
                    }
                }
            });
        }

        // Daily Jobs Chart
        function renderDailyJobsChart() {
            const dailyData = {};
            filteredData.forEach(r => {
                const date = parseThaiDate(r.createdAt);
                if (date) {
                    const key = date.toISOString().split('T')[0];
                    dailyData[key] = (dailyData[key] || 0) + 1;
                }
            });

            const sortedDates = Object.keys(dailyData).sort();
            const labels = sortedDates.map(d => {
                const date = new Date(d);
                return `${date.getDate()}/${date.getMonth() + 1}`;
            });
            const data = sortedDates.map(d => dailyData[d]);

            if (charts.dailyJobs) charts.dailyJobs.destroy();
            charts.dailyJobs = new Chart(document.getElementById('dailyJobsChart'), {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏≤‡∏ô',
                        data,
                        backgroundColor: '#2563eb',
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        // Trend Chart
        function renderTrendChart() {
            const dailyStats = {};
            filteredData.forEach(r => {
                const date = parseThaiDate(r.createdAt);
                if (date) {
                    const key = date.toISOString().split('T')[0];
                    if (!dailyStats[key]) {
                        dailyStats[key] = { total: 0, completed: 0, avgTime: [], totalDist: 0 };
                    }
                    dailyStats[key].total++;
                    if (r.status === 'END_TRIP' || r.status === 'JOB_DONE') {
                        dailyStats[key].completed++;
                    }
                    if (r.checkIn && r.checkOut) {
                        const checkIn = parseThaiDate(r.checkIn);
                        const checkOut = parseThaiDate(r.checkOut);
                        if (checkIn && checkOut) {
                            dailyStats[key].avgTime.push((checkOut - checkIn) / 1000 / 60);
                        }
                    }
                    if (r['Distance (km)']) {
                        dailyStats[key].totalDist += parseFloat(r['Distance (km)']) || 0;
                    }
                }
            });

            const sortedDates = Object.keys(dailyStats).sort();
            const labels = sortedDates.map(d => {
                const date = new Date(d);
                return `${date.getDate()}/${date.getMonth() + 1}`;
            });

            const completionRates = sortedDates.map(d => {
                const stats = dailyStats[d];
                return stats.total > 0 ? ((stats.completed / stats.total) * 100).toFixed(1) : 0;
            });

            const avgTimes = sortedDates.map(d => {
                const stats = dailyStats[d];
                if (stats.avgTime.length === 0) return 0;
                return (stats.avgTime.reduce((a, b) => a + b, 0) / stats.avgTime.length).toFixed(1);
            });

            if (charts.trend) charts.trend.destroy();
            charts.trend = new Chart(document.getElementById('trendChart'), {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        {
                            label: '‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô (%)',
                            data: completionRates,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            tension: 0.4,
                            yAxisID: 'y'
                        },
                        {
                            label: '‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (‡∏ô‡∏≤‡∏ó‡∏µ)',
                            data: avgTimes,
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            fill: true,
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            min: 0,
                            max: 100,
                            title: { display: true, text: '‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô (%)' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            min: 0,
                            title: { display: true, text: '‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (‡∏ô‡∏≤‡∏ó‡∏µ)' },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }

        // Driver Performance Chart
        function renderDriverPerformanceChart() {
            const driverStats = {};
            filteredData.forEach(r => {
                if (!r.updatedBy) return;
                if (!driverStats[r.updatedBy]) {
                    driverStats[r.updatedBy] = { total: 0, completed: 0, time: [], distance: 0 };
                }
                driverStats[r.updatedBy].total++;
                if (r.status === 'END_TRIP' || r.status === 'JOB_DONE') {
                    driverStats[r.updatedBy].completed++;
                }
                if (r.checkIn && r.checkOut) {
                    const checkIn = parseThaiDate(r.checkIn);
                    const checkOut = parseThaiDate(r.checkOut);
                    if (checkIn && checkOut) {
                        driverStats[r.updatedBy].time.push((checkOut - checkIn) / 1000 / 60);
                    }
                }
                if (r['Distance (km)']) {
                    driverStats[r.updatedBy].distance += parseFloat(r['Distance (km)']) || 0;
                }
            });

            const sortedDrivers = Object.entries(driverStats)
                .map(([id, stats]) => ({
                    id: id.substring(0, 12) + '...',
                    stats
                }))
                .sort((a, b) => b.stats.completed - a.stats.completed)
                .slice(0, 10);

            const labels = sortedDrivers.map(d => d.id);
            const data = sortedDrivers.map(d => d.stats.completed);

            if (charts.driver) charts.driver.destroy();
            charts.driver = new Chart(document.getElementById('driverPerformanceChart'), {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: '‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô',
                        data,
                        backgroundColor: '#8b5cf6',
                        borderRadius: 8
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        // Driver Table
        function renderDriverTable() {
            const driverStats = {};
            filteredData.forEach(r => {
                if (!r.updatedBy) return;
                if (!driverStats[r.updatedBy]) {
                    driverStats[r.updatedBy] = {
                        total: 0,
                        completed: 0,
                        time: [],
                        distance: 0
                    };
                }
                driverStats[r.updatedBy].total++;
                if (r.status === 'END_TRIP' || r.status === 'JOB_DONE') {
                    driverStats[r.updatedBy].completed++;
                }
                if (r.checkIn && r.checkOut) {
                    const checkIn = parseThaiDate(r.checkIn);
                    const checkOut = parseThaiDate(r.checkOut);
                    if (checkIn && checkOut) {
                        driverStats[r.updatedBy].time.push((checkOut - checkIn) / 1000 / 60);
                    }
                }
                if (r['Distance (km)']) {
                    driverStats[r.updatedBy].distance += parseFloat(r['Distance (km)']) || 0;
                }
            });

            const sortedDrivers = Object.entries(driverStats)
                .map(([id, stats]) => ({
                    id,
                    stats
                }))
                .sort((a, b) => b.stats.completed - a.stats.completed);

            const tbody = document.getElementById('driverTableBody');
            tbody.innerHTML = sortedDrivers.map((d, i) => {
                const avgTime = d.stats.time.length > 0
                    ? (d.stats.time.reduce((a, b) => a + b, 0) / d.stats.time.length).toFixed(1)
                    : '-';
                const successRate = ((d.stats.completed / d.stats.total) * 100).toFixed(1);
                const statusClass = successRate >= 95 ? 'success' : successRate >= 80 ? 'warning' : 'danger';

                return `
                    <tr>
                        <td>${i + 1}</td>
                        <td><code>${d.id.substring(0, 20)}...</code></td>
                        <td>${d.stats.completed}</td>
                        <td>${avgTime} ‡∏ô‡∏≤‡∏ó‡∏µ</td>
                        <td>${d.stats.distance.toFixed(0)} ‡∏Å‡∏°.</td>
                        <td>
                            <div class="progress-bar">
                                <div class="progress-fill ${statusClass}" style="width: ${successRate}%"></div>
                            </div>
                            <small>${successRate}%</small>
                        </td>
                        <td><span class="status-badge ${statusClass}">${statusClass === 'success' ? '‡∏î‡∏µ‡∏°‡∏≤‡∏Å' : statusClass === 'warning' ? '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á' : '‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á'}</span></td>
                    </tr>
                `;
            }).join('');
        }

        // Location Chart
        function renderLocationChart() {
            const locationCounts = {};
            filteredData.forEach(r => {
                const loc = r.shipToCode || r.shipToName || 'UNKNOWN';
                locationCounts[loc] = (locationCounts[loc] || 0) + 1;
            });

            const sorted = Object.entries(locationCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 15);

            const labels = sorted.map(s => s[0]);
            const data = sorted.map(s => s[1]);

            if (charts.location) charts.location.destroy();
            charts.location = new Chart(document.getElementById('locationChart'), {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏≤‡∏ô',
                        data,
                        backgroundColor: '#06b6d4',
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        // Location Table
        function renderLocationTable() {
            const locationStats = {};
            filteredData.forEach(r => {
                const code = r.shipToCode || 'UNKNOWN';
                const name = r.shipToName || '-';
                if (!locationStats[code]) {
                    locationStats[code] = {
                        name,
                        count: 0,
                        times: [],
                        distances: [],
                        gpsValid: 0,
                        gpsTotal: 0
                    };
                }
                locationStats[code].count++;
                if (r.checkIn && r.checkOut) {
                    const checkIn = parseThaiDate(r.checkIn);
                    const checkOut = parseThaiDate(r.checkOut);
                    if (checkIn && checkOut) {
                        locationStats[code].times.push((checkOut - checkIn) / 1000 / 60);
                    }
                }
                if (r['Distance (km)']) {
                    locationStats[code].distances.push(parseFloat(r['Distance (km)']) || 0);
                }
                locationStats[code].gpsTotal++;
                if (r.checkInLat && r.checkInLng) {
                    locationStats[code].gpsValid++;
                }
            });

            const sorted = Object.entries(locationStats)
                .map(([code, stats]) => ({ code, stats }))
                .sort((a, b) => b.stats.count - a.stats.count);

            const tbody = document.getElementById('locationTableBody');
            tbody.innerHTML = sorted.map(loc => {
                const avgTime = loc.stats.times.length > 0
                    ? (loc.stats.times.reduce((a, b) => a + b, 0) / loc.stats.times.length).toFixed(1)
                    : '-';
                const avgDist = loc.stats.distances.length > 0
                    ? (loc.stats.distances.reduce((a, b) => a + b, 0) / loc.stats.distances.length).toFixed(1)
                    : '-';
                const gpsRate = loc.stats.gpsTotal > 0
                    ? ((loc.stats.gpsValid / loc.stats.gpsTotal) * 100).toFixed(1)
                    : '-';

                return `
                    <tr>
                        <td><strong>${loc.code}</strong></td>
                        <td>${loc.stats.name}</td>
                        <td>${loc.stats.count}</td>
                        <td>${avgTime} ‡∏ô‡∏≤‡∏ó‡∏µ</td>
                        <td>${avgDist} ‡∏Å‡∏°.</td>
                        <td>${gpsRate}%</td>
                    </tr>
                `;
            }).join('');
        }

        // Dwell Time Chart
        function renderDwellTimeChart() {
            const dwellTimes = filteredData
                .filter(r => r.checkIn && r.checkOut)
                .map(r => {
                    const checkIn = parseThaiDate(r.checkIn);
                    const checkOut = parseThaiDate(r.checkOut);
                    return checkIn && checkOut ? (checkOut - checkIn) / 1000 / 60 : null;
                })
                .filter(t => t !== null && t >= 0 && t <= 300);

            const bins = {
                '0-15 ‡∏ô‡∏≤‡∏ó‡∏µ': 0,
                '15-30 ‡∏ô‡∏≤‡∏ó‡∏µ': 0,
                '30-60 ‡∏ô‡∏≤‡∏ó‡∏µ': 0,
                '60-120 ‡∏ô‡∏≤‡∏ó‡∏µ': 0,
                '> 120 ‡∏ô‡∏≤‡∏ó‡∏µ': 0
            };

            dwellTimes.forEach(t => {
                if (t < 15) bins['0-15 ‡∏ô‡∏≤‡∏ó‡∏µ']++;
                else if (t < 30) bins['15-30 ‡∏ô‡∏≤‡∏ó‡∏µ']++;
                else if (t < 60) bins['30-60 ‡∏ô‡∏≤‡∏ó‡∏µ']++;
                else if (t < 120) bins['60-120 ‡∏ô‡∏≤‡∏ó‡∏µ']++;
                else bins['> 120 ‡∏ô‡∏≤‡∏ó‡∏µ']++;
            });

            if (charts.dwellTime) charts.dwellTime.destroy();
            charts.dwellTime = new Chart(document.getElementById('dwellTimeChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(bins),
                    datasets: [{
                        label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô',
                        data: Object.values(bins),
                        backgroundColor: ['#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#64748b'],
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        // Hourly Chart
        function renderHourlyChart() {
            const hourlyData = {};
            for (let i = 0; i < 24; i++) {
                hourlyData[i] = 0;
            }

            filteredData.forEach(r => {
                const checkIn = parseThaiDate(r.checkIn);
                if (checkIn) {
                    const hour = checkIn.getHours();
                    hourlyData[hour]++;
                }
            });

            if (charts.hourly) charts.hourly.destroy();
            charts.hourly = new Chart(document.getElementById('hourlyChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(hourlyData).map(h => `${h}:00`),
                    datasets: [{
                        label: 'Check-in',
                        data: Object.values(hourlyData),
                        backgroundColor: '#2563eb',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        // Status Grid
        function renderStatusGrid() {
            const statusCounts = {};
            filteredData.forEach(r => {
                const status = r.status || 'UNKNOWN';
                statusCounts[status] = (statusCounts[status] || 0) + 1;
            });

            const total = filteredData.length;
            const grid = document.getElementById('statusGrid');
            grid.innerHTML = Object.entries(statusCounts).map(([status, count]) => {
                const percent = ((count / total) * 100).toFixed(1);
                const statusInfo = getStatusInfo(status);
                return `
                    <div class="status-item" style="border-left: 4px solid ${statusInfo.color}">
                        <div class="status-item-label">${statusInfo.label}</div>
                        <div class="status-item-value">${count}</div>
                        <div class="status-item-percent">${percent}%</div>
                    </div>
                `;
            }).join('');
        }

        // Pending Table
        function renderPendingTable() {
            const pending = filteredData.filter(r =>
                r.status !== 'END_TRIP' && r.status !== 'JOB_DONE' && r.status !== 'REVIEWED'
            ).slice(0, 20);

            const tbody = document.getElementById('pendingTableBody');
            tbody.innerHTML = pending.map(r => {
                const checkIn = parseThaiDate(r.checkIn);
                const waitTime = checkIn ? ((new Date() - checkIn) / 1000 / 60).toFixed(0) : '-';

                return `
                    <tr>
                        <td><code>${r.referenceNo || '-'}</code></td>
                        <td><code>${r.shipmentNo || '-'}</code></td>
                        <td>${r.shipToName || r.shipToCode || '-'}</td>
                        <td><span class="status-badge ${getStatusBadgeClass(r.status)}">${getStatusLabel(r.status)}</span></td>
                        <td>${r.checkIn || '-'}</td>
                        <td>${waitTime} ‡∏ô‡∏≤‡∏ó‡∏µ</td>
                    </tr>
                `;
            }).join('');
        }

        // Helper Functions
        function getStatusLabel(status) {
            const labels = {
                'NEW': '‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà',
                'CHECKIN': '‡∏ñ‡∏∂‡∏á‡∏à‡∏∏‡∏î‡∏à‡∏±‡∏î‡∏™‡πà‡∏á',
                'CHECKOUT': '‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à',
                'FUELING': '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô',
                'UNLOAD_DONE': '‡∏Ç‡∏ô‡∏ñ‡πà‡∏≤‡∏¢‡πÄ‡∏™‡∏£‡πá‡∏à',
                'REVIEWED': '‡∏ñ‡∏π‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß',
                'JOB_DONE': '‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå',
                'END_TRIP': '‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ'
            };
            return labels[status] || status;
        }

        function getStatusInfo(status) {
            const info = {
                'NEW': { label: '‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà', color: '#64748b' },
                'CHECKIN': { label: '‡∏ñ‡∏∂‡∏á‡∏à‡∏∏‡∏î‡∏à‡∏±‡∏î‡∏™‡πà‡∏á', color: '#f59e0b' },
                'CHECKOUT': { label: '‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à', color: '#06b6d4' },
                'FUELING': { label: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô', color: '#8b5cf6' },
                'UNLOAD_DONE': { label: '‡∏Ç‡∏ô‡∏ñ‡πà‡∏≤‡∏¢‡πÄ‡∏™‡∏£‡πá‡∏à', color: '#10b981' },
                'REVIEWED': { label: '‡∏ñ‡∏π‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß', color: '#2563eb' },
                'JOB_DONE': { label: '‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå', color: '#10b981' },
                'END_TRIP': { label: '‡∏à‡∏ö‡∏ó‡∏£‡∏¥‡∏õ', color: '#059669' }
            };
            return info[status] || { label: status, color: '#64748b' };
        }

        function getStatusBadgeClass(status) {
            if (['END_TRIP', 'JOB_DONE', 'REVIEWED'].includes(status)) return 'success';
            if (['CHECKOUT', 'UNLOAD_DONE'].includes(status)) return 'info';
            if (['CHECKIN', 'FUELING'].includes(status)) return 'warning';
            return 'danger';
        }

        function getStatusColors(statuses) {
            return statuses.map(s => getStatusInfo(s).color);
        }

        // Tab Switching
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        // UI Helpers
        function showLoading(show) {
            document.getElementById('loadingContainer').style.display = show ? 'block' : 'none';
        }

        function showDashboard() {
            document.getElementById('dashboard').classList.add('loaded');
        }

        function showError(message) {
            document.getElementById('errorDetails').textContent = message;
            document.getElementById('errorContainer').classList.add('show');
        }

        function hideError() {
            document.getElementById('errorContainer').classList.remove('show');
        }

        function updateLastUpdate() {
            const now = new Date();
            const options = {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            };
            document.getElementById('lastUpdate').textContent =
                `‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${now.toLocaleDateString('th-TH', options)}`;
        }

        // ==================== TIME ANALYSIS BY STATION ====================

        // Station Dwell Time Data Store
        let stationDwellData = [];

        // Calculate Dwell Time by Station
        function calculateStationDwellTime() {
            const stationData = {};

            filteredData.forEach(r => {
                if (!r.shipToCode || !r.checkIn || !r.checkOut) return;

                const checkIn = parseThaiDate(r.checkIn);
                const checkOut = parseThaiDate(r.checkOut);
                if (!checkIn || !checkOut) return;

                const dwellTime = (checkOut - checkIn) / 1000 / 60; // minutes
                if (dwellTime < 0 || dwellTime > 600) return; // Filter invalid data

                const stationCode = r.shipToCode;
                if (!stationData[stationCode]) {
                    stationData[stationCode] = {
                        code: stationCode,
                        name: r.shipToName || '-',
                        times: [],
                        checkIns: [],
                        visits: 0,
                        totalDwell: 0
                    };
                }

                stationData[stationCode].times.push(dwellTime);
                stationData[stationCode].checkIns.push(checkIn);
                stationData[stationCode].visits++;
                stationData[stationCode].totalDwell += dwellTime;
            });

            // Convert to array and calculate stats
            stationDwellData = Object.values(stationData).map(station => {
                const times = station.times.sort((a, b) => a - b);
                const avg = times.reduce((a, b) => a + b, 0) / times.length;
                const min = times[0];
                const max = times[times.length - 1];
                const median = times[Math.floor(times.length / 2)];

                // Calculate standard deviation
                const variance = times.reduce((sum, t) => sum + Math.pow(t - avg, 2), 0) / times.length;
                const stdDev = Math.sqrt(variance);

                // Calculate 7-day trend
                const now = new Date();
                const sevenDaysAgo = new Date(now);
                sevenDaysAgo.setDate(now.getDate() - 7);

                const recentTimes = station.times.filter((_, i) =>
                    station.checkIns[i] >= sevenDaysAgo
                );
                const fourteenDaysAgo = new Date(now);
                fourteenDaysAgo.setDate(now.getDate() - 14);
                sevenDaysAgo.setDate(now.getDate() - 7);

                const previousTimes = station.times.filter((_, i) =>
                    station.checkIns[i] >= fourteenDaysAgo && station.checkIns[i] < sevenDaysAgo
                );

                const recentAvg = recentTimes.length > 0
                    ? recentTimes.reduce((a, b) => a + b, 0) / recentTimes.length
                    : avg;
                const previousAvg = previousTimes.length > 0
                    ? previousTimes.reduce((a, b) => a + b, 0) / previousTimes.length
                    : avg;

                const trend = previousAvg > 0
                    ? ((recentAvg - previousAvg) / previousAvg * 100).toFixed(1)
                    : '0';

                // Determine benchmark based on station type
                const benchmark = getBenchmarkForStation(station.code, station.name);

                // Determine status
                let status = 'good';
                if (avg > benchmark * 2) status = 'critical';
                else if (avg > benchmark * 1.5) status = 'warning';
                else if (avg > benchmark) status = 'normal';

                return {
                    ...station,
                    avg: avg.toFixed(1),
                    min: min.toFixed(1),
                    max: max.toFixed(1),
                    median: median.toFixed(1),
                    stdDev: stdDev.toFixed(1),
                    benchmark,
                    status,
                    trend,
                    recentVisits: recentTimes.length
                };
            }).sort((a, b) => parseFloat(a.avg) - parseFloat(b.avg));

            return stationDwellData;
        }

        // Get benchmark based on station type
        function getBenchmarkForStation(code, name) {
            // Main depots
            if (code === 'TOP SR' || name.includes('‡∏®‡∏£‡∏µ‡∏£‡∏≤‡∏ä‡∏≤') || name.includes('‡∏Ñ‡∏•‡∏±‡∏á')) return 30;

            // Rural stations (typically farther)
            if (name.includes('‡∏ä‡∏ô‡∏ö‡∏ó') || name.includes('‡∏´‡πà‡∏≤‡∏á')) return 45;

            // High traffic stations
            if (name.includes('‡∏´‡∏•‡∏±‡∏Å') || name.includes('‡πÉ‡∏´‡∏ç‡πà')) return 25;

            // Standard PTC stations
            if (code.startsWith('PTC-STA') || code.startsWith('S') || code.startsWith('SF')) return 20;

            // Default
            return 20;
        }

        // Render Station Dwell Time Summary Cards
        function renderStationDwellSummary() {
            const summary = {
                withinBenchmark: 0,
                needsAttention: 0,
                critical: 0
            };

            stationDwellData.forEach(s => {
                const avg = parseFloat(s.avg);
                if (avg <= 20) summary.withinBenchmark++;
                else if (avg <= 40) summary.needsAttention++;
                else summary.critical++;
            });

            document.getElementById('withinBenchmark').textContent = summary.withinBenchmark;
            document.getElementById('needsAttention').textContent = summary.needsAttention;
            document.getElementById('criticalStations').textContent = summary.critical;

            // Calculate trend
            const trends = stationDwellData
                .filter(s => s.trend !== '0')
                .map(s => parseFloat(s.trend));
            const avgTrend = trends.length > 0
                ? (trends.reduce((a, b) => a + b, 0) / trends.length).toFixed(1)
                : '0';

            const trendEl = document.getElementById('dwellTrendValue');
            if (avgTrend === '0') {
                trendEl.textContent = '-';
            } else {
                const isImproving = avgTrend < 0;
                trendEl.textContent = `${isImproving ? '' : '+'}${avgTrend}%`;
                trendEl.style.color = isImproving ? '#10b981' : '#ef4444';
            }
        }

        // Render Station Dwell Time Chart
        function renderStationDwellTimeChart() {
            const topStations = stationDwellData.slice(0, 20);
            const labels = topStations.map(s => s.code);
            const avgTimes = topStations.map(s => parseFloat(s.avg));
            const benchmarks = topStations.map(s => s.benchmark);

            // Color by status
            const colors = topStations.map(s => {
                if (s.status === 'critical') return '#ef4444';
                if (s.status === 'warning') return '#f59e0b';
                if (s.status === 'normal') return '#06b6d4';
                return '#10b981';
            });

            if (charts.stationDwellTime) charts.stationDwellTime.destroy();
            charts.stationDwellTime = new Chart(document.getElementById('stationDwellTimeChart'), {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        {
                            label: '‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (‡∏ô‡∏≤‡∏ó‡∏µ)',
                            data: avgTimes,
                            backgroundColor: colors,
                            borderRadius: 4
                        },
                        {
                            label: 'Benchmark',
                            data: benchmarks,
                            type: 'line',
                            borderColor: '#64748b',
                            borderDash: [5, 5],
                            pointRadius: 0,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: true },
                        tooltip: {
                            callbacks: {
                                labels: function(context) {
                                    return `‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢: ${context.raw} ‡∏ô‡∏≤‡∏ó‡∏µ`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: { display: true, text: '‡∏ô‡∏≤‡∏ó‡∏µ' }
                        }
                    }
                }
            });
        }

        // Render Station Dwell Table
        function renderStationDwellTable() {
            const tbody = document.getElementById('stationDwellTableBody');
            const filter = document.getElementById('stationFilter').value;

            let filtered = stationDwellData;
            if (filter !== 'all') {
                filtered = stationDwellData.filter(s => s.status === filter);
            }

            tbody.innerHTML = filtered.map((s, i) => {
                const avg = parseFloat(s.avg);
                const benchmarkPct = ((avg / s.benchmark) * 100).toFixed(0);

                let statusBadge, statusText;
                if (s.status === 'critical') {
                    statusBadge = 'status-badge danger';
                    statusText = '‡∏ß‡∏¥‡∏Å‡∏§‡∏ï‡∏¥';
                } else if (s.status === 'warning') {
                    statusBadge = 'status-badge warning';
                    statusText = '‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°';
                } else if (s.status === 'normal') {
                    statusBadge = 'status-badge info';
                    statusText = '‡∏õ‡∏Å‡∏ï‡∏¥';
                } else {
                    statusBadge = 'status-badge success';
                    statusText = '‡∏î‡∏µ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°';
                }

                // Trend icon
                let trendIcon = '';
                if (s.trend !== '0') {
                    const isImproving = parseFloat(s.trend) < 0;
                    trendIcon = isImproving
                        ? '<span style="color: #10b981">‚Üì</span>'
                        : '<span style="color: #ef4444">‚Üë</span>';
                }

                return `
                    <tr>
                        <td>${i + 1}</td>
                        <td><strong>${s.code}</strong></td>
                        <td>${s.name}</td>
                        <td>${s.visits}</td>
                        <td><strong>${s.avg}</strong> ‡∏ô‡∏≤‡∏ó‡∏µ</td>
                        <td>${s.min} ‡∏ô‡∏≤‡∏ó‡∏µ</td>
                        <td>${s.max} ‡∏ô‡∏≤‡∏ó‡∏µ</td>
                        <td>¬±${s.stdDev}</td>
                        <td>${s.benchmark} ‡∏ô‡∏≤‡∏ó‡∏µ (${benchmarkPct}%)</td>
                        <td><span class="${statusBadge}">${statusText}</span></td>
                        <td>${trendIcon} ${s.trend !== '0' ? Math.abs(s.trend) + '%' : '-'}</td>
                    </tr>
                `;
            }).join('');
        }

        // Filter Station Table
        function filterStationTable() {
            renderStationDwellTable();
        }

        // Render Heatmap (Hour vs Station)
        function renderDwellTimeHeatmap() {
            // Get top 10 stations
            const topStations = stationDwellData.slice(0, 10);

            // Build hourly data
            const heatmapData = [];
            for (let hour = 0; hour < 24; hour++) {
                topStations.forEach(station => {
                    const hourVisits = filteredData.filter(r => {
                        if (r.shipToCode !== station.code || !r.checkIn) return false;
                        const checkIn = parseThaiDate(r.checkIn);
                        return checkIn && checkIn.getHours() === hour;
                    });

                    const avgTime = hourVisits.length > 0
                        ? hourVisits.reduce((sum, r) => {
                            const checkIn = parseThaiDate(r.checkIn);
                            const checkOut = parseThaiDate(r.checkOut);
                            return sum + (checkIn && checkOut ? (checkOut - checkIn) / 1000 / 60 : 0);
                        }, 0) / hourVisits.length
                        : 0;

                    heatmapData.push({
                        x: hour,
                        y: station.code,
                        v: avgTime
                    });
                });
            }

            // Create heatmap using scatter with colors
            if (charts.heatmap) charts.heatmap.destroy();
            charts.heatmap = new Chart(document.getElementById('heatmapChart'), {
                type: 'matrix',
                data: {
                    datasets: [{
                        label: '‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (‡∏ô‡∏≤‡∏ó‡∏µ)',
                        data: heatmapData,
                        backgroundColor: function(ctx) {
                            const value = ctx.dataset.data[ctx.dataIndex].v;
                            const alpha = Math.min(value / 60, 1);
                            return `rgba(239, 68, 68, ${alpha})`;
                        },
                        borderColor: function(ctx) {
                            const value = ctx.dataset.data[ctx.dataIndex].v;
                            return value > 30 ? '#ef4444' : value > 15 ? '#f59e0b' : '#10b981';
                        },
                        borderWidth: 1,
                        width: ({ chart }) => (chart.chartArea || {}).width / 24 - 1,
                        height: ({ chart }) => (chart.chartArea || {}).height / topStations.length - 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return `${context[0].raw.y}:00 ‡∏ô.`;
                                },
                                label: function(context) {
                                    return `‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢: ${context.raw.v.toFixed(1)} ‡∏ô‡∏≤‡∏ó‡∏µ`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            min: -0.5,
                            max: 23.5,
                            ticks: {
                                stepSize: 1,
                                callback: function(value) {
                                    return value + ':00';
                                }
                            },
                            title: { display: true, text: '‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á' }
                        },
                        y: {
                            type: 'category',
                            labels: topStations.map(s => s.code),
                            title: { display: true, text: '‡∏à‡∏∏‡∏î‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£' }
                        }
                    }
                }
            });
        }

        // Render Exception Report
        function renderExceptionReport() {
            const exceptions = [];
            const benchmark = 45; // minutes

            filteredData.forEach(r => {
                if (!r.checkIn || !r.checkOut) return;
                const checkIn = parseThaiDate(r.checkIn);
                const checkOut = parseThaiDate(r.checkOut);
                if (!checkIn || !checkOut) return;

                const dwellTime = (checkOut - checkIn) / 1000 / 60;
                if (dwellTime > benchmark) {
                    exceptions.push({
                        ...r,
                        dwellTime,
                        overBenchmark: (dwellTime - benchmark).toFixed(1)
                    });
                }
            });

            // Sort by dwell time descending
            exceptions.sort((a, b) => b.dwellTime - a.dwellTime);

            const tbody = document.getElementById('exceptionTableBody');
            tbody.innerHTML = exceptions.slice(0, 20).map(r => {
                const severity = r.dwellTime > 90 ? 'critical' : r.dwellTime > 60 ? 'warning' : 'info';

                return `
                    <tr>
                        <td><code>${r.referenceNo || '-'}</code></td>
                        <td>${r.shipToCode || '-'}</td>
                        <td><code>${r.updatedBy ? r.updatedBy.substring(0, 15) + '...' : '-'}</code></td>
                        <td>${r.checkIn || '-'}</td>
                        <td>${r.checkOut || '-'}</td>
                        <td><strong>${r.dwellTime.toFixed(1)}</strong> ‡∏ô‡∏≤‡∏ó‡∏µ</td>
                        <td style="color: #ef4444">+${r.overBenchmark} ‡∏ô‡∏≤‡∏ó‡∏µ</td>
                        <td><span class="status-badge ${severity === 'critical' ? 'danger' : severity === 'warning' ? 'warning' : 'info'}">${severity === 'critical' ? '‡∏ß‡∏¥‡∏Å‡∏§‡∏ï‡∏¥' : severity === 'warning' ? '‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á' : '‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå'}</span></td>
                    </tr>
                `;
            }).join('');
        }

        // Export Report
        function exportReport() {
            const kpi = calculateKPIs();
            const report = {
                generatedAt: new Date().toISOString(),
                period: {
                    start: document.getElementById('startDate').value,
                    end: document.getElementById('endDate').value
                },
                kpi: kpi,
                stationDwellTime: stationDwellData,
                data: filteredData
            };

            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `performance-report-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
