<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DriverConnect - Supply Chain Performance Report</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #06b6d4;
            --purple: #8b5cf6;
            --dark: #1e293b;
            --light: #f8fafc;
            --gray: #64748b;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-lg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .header-left h1 {
            font-size: 24px;
            font-weight: 700;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-left h1 i {
            color: var(--primary);
        }

        .header-left p {
            color: var(--gray);
            margin-top: 4px;
        }

        .header-controls {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-family: inherit;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-outline {
            background: white;
            border: 1px solid var(--border);
            color: var(--gray);
        }

        .btn-outline:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .date-filter {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--light);
            padding: 8px 16px;
            border-radius: 8px;
        }

        .date-filter input {
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 6px 12px;
            font-family: inherit;
        }

        /* Loading State */
        .loading-container {
            background: white;
            border-radius: 16px;
            padding: 60px;
            text-align: center;
            box-shadow: var(--shadow-lg);
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--gray);
            font-size: 16px;
        }

        /* Dashboard */
        .dashboard {
            display: none;
        }

        .dashboard.loaded {
            display: block;
        }

        /* KPI Cards */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .kpi-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--shadow);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .kpi-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .kpi-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .kpi-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .kpi-icon.blue { background: #dbeafe; color: #2563eb; }
        .kpi-icon.green { background: #d1fae5; color: #10b981; }
        .kpi-icon.yellow { background: #fef3c7; color: #f59e0b; }
        .kpi-icon.purple { background: #ede9fe; color: #8b5cf6; }
        .kpi-icon.cyan { background: #cffafe; color: #06b6d4; }
        .kpi-icon.red { background: #fee2e2; color: #ef4444; }

        .kpi-trend {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            font-weight: 500;
            padding: 4px 8px;
            border-radius: 20px;
        }

        .kpi-trend.up { background: #d1fae5; color: #10b981; }
        .kpi-trend.down { background: #fee2e2; color: #ef4444; }
        .kpi-trend.neutral { background: #f1f5f9; color: #64748b; }

        .kpi-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 4px;
        }

        .kpi-label {
            color: var(--gray);
            font-size: 14px;
        }

        .kpi-target {
            font-size: 12px;
            color: var(--gray);
            margin-top: 8px;
        }

        /* Charts Section */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }

        .chart-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--shadow);
        }

        .chart-card.full-width {
            grid-column: 1 / -1;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chart-legend {
            display: flex;
            gap: 16px;
            font-size: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--gray);
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        .chart-container {
            position: relative;
            height: 280px;
        }

        /* Tables */
        .table-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--shadow);
            margin-bottom: 24px;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .table-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .data-table th {
            background: var(--light);
            font-weight: 600;
            color: var(--gray);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-table td {
            font-size: 14px;
            color: var(--dark);
        }

        .data-table tr:hover {
            background: var(--light);
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-badge.success { background: #d1fae5; color: #065f46; }
        .status-badge.warning { background: #fef3c7; color: #92400e; }
        .status-badge.danger { background: #fee2e2; color: #991b1b; }
        .status-badge.info { background: #dbeafe; color: #1e40af; }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .progress-fill.green { background: var(--secondary); }
        .progress-fill.yellow { background: var(--warning); }
        .progress-fill.red { background: var(--danger); }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            background: white;
            padding: 8px;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        .tab {
            padding: 10px 20px;
            border: none;
            background: transparent;
            border-radius: 8px;
            font-family: inherit;
            font-weight: 500;
            color: var(--gray);
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab:hover {
            color: var(--primary);
            background: var(--light);
        }

        .tab.active {
            background: var(--primary);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Status Distribution */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 16px;
        }

        .status-item {
            background: var(--light);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }

        .status-item-label {
            font-size: 12px;
            color: var(--gray);
            margin-bottom: 8px;
        }

        .status-item-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--dark);
        }

        .status-item-percent {
            font-size: 12px;
            color: var(--gray);
            margin-top: 4px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }

            .header {
                flex-direction: column;
                align-items: flex-start;
            }

            .header-controls {
                width: 100%;
            }

            .data-table {
                font-size: 12px;
            }

            .data-table th,
            .data-table td {
                padding: 8px;
            }
        }

        /* Last Update */
        .last-update {
            text-align: center;
            color: white;
            font-size: 14px;
            margin-top: 20px;
            opacity: 0.8;
        }

        /* Error State */
        .error-container {
            background: white;
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            box-shadow: var(--shadow-lg);
            display: none;
        }

        .error-container.show {
            display: block;
        }

        .error-icon {
            font-size: 48px;
            color: var(--danger);
            margin-bottom: 16px;
        }

        .error-message {
            color: var(--dark);
            font-size: 18px;
            margin-bottom: 20px;
        }

        .error-details {
            color: var(--gray);
            font-size: 14px;
            max-width: 500px;
            margin: 0 auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <h1><i class="fas fa-truck-fast"></i> DriverConnect</h1>
                <p>ระบบรายงานสมรรถนะห่วงโซ่อุปทาน (Supply Chain Performance Report)</p>
            </div>
            <div class="header-controls">
                <div class="date-filter">
                    <i class="fas fa-calendar"></i>
                    <input type="date" id="startDate">
                    <span>ถึง</span>
                    <input type="date" id="endDate">
                </div>
                <button class="btn btn-primary" onclick="loadData()">
                    <i class="fas fa-sync-alt"></i> โหลดข้อมูล
                </button>
                <button class="btn btn-outline" onclick="exportReport()">
                    <i class="fas fa-download"></i> ส่งออกรายงาน
                </button>
            </div>
        </div>

        <!-- Loading State -->
        <div class="loading-container" id="loadingContainer">
            <div class="loading-spinner"></div>
            <p class="loading-text">กำลังดึงข้อมูลจาก Google Sheets...</p>
        </div>

        <!-- Error State -->
        <div class="error-container" id="errorContainer">
            <div class="error-icon"><i class="fas fa-exclamation-triangle"></i></div>
            <p class="error-message">ไม่สามารถดึงข้อมูลได้</p>
            <p class="error-details" id="errorDetails"></p>
        </div>

        <!-- Dashboard -->
        <div class="dashboard" id="dashboard">
            <!-- KPI Cards -->
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-header">
                        <div class="kpi-icon blue"><i class="fas fa-clipboard-list"></i></div>
                        <span class="kpi-trend neutral" id="totalJobsTrend">-</span>
                    </div>
                    <div class="kpi-value" id="totalJobs">0</div>
                    <div class="kpi-label">งานทั้งหมด</div>
                    <div class="kpi-target">เป้าหมาย: 100% ดำเนินการ</div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-header">
                        <div class="kpi-icon green"><i class="fas fa-check-circle"></i></div>
                        <span class="kpi-trend up" id="completionTrend"><i class="fas fa-arrow-up"></i> -</span>
                    </div>
                    <div class="kpi-value" id="completionRate">0%</div>
                    <div class="kpi-label">อัตราการเสร็จสิ้นงาน</div>
                    <div class="kpi-target">เป้าหมาย: 95%+ (World-Class: 98%+)</div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-header">
                        <div class="kpi-icon yellow"><i class="fas fa-clock"></i></div>
                        <span class="kpi-trend down" id="dwellTimeTrend"><i class="fas fa-arrow-down"></i> ดี</span>
                    </div>
                    <div class="kpi-value" id="avgDwellTime">0 นาที</div>
                    <div class="kpi-label">เวลาเฉลี่ยต่อจุดจัดส่ง</div>
                    <div class="kpi-target">เป้าหมาย: < 20 นาที (World-Class: <15 นาที)</div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-header">
                        <div class="kpi-icon purple"><i class="fas fa-route"></i></div>
                        <span class="kpi-trend neutral" id="distanceTrend">-</span>
                    </div>
                    <div class="kpi-value" id="totalDistance">0 กม.</div>
                    <div class="kpi-label">ระยะทางรวม</div>
                    <div class="kpi-target">รวมทุกงานในช่วงเวลาที่เลือก</div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-header">
                        <div class="kpi-icon cyan"><i class="fas fa-map-marker-alt"></i></div>
                        <span class="kpi-trend up" id="gpsTrend"><i class="fas fa-arrow-up"></i> -</span>
                    </div>
                    <div class="kpi-value" id="gpsAccuracy">0%</div>
                    <div class="kpi-label">ความแม่นยำ GPS</div>
                    <div class="kpi-target">เป้าหมาย: 95%+ (World-Class: 99%+)</div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-header">
                        <div class="kpi-icon red"><i class="fas fa-users"></i></div>
                        <span class="kpi-trend neutral" id="driverTrend">-</span>
                    </div>
                    <div class="kpi-value" id="activeDrivers">0</div>
                    <div class="kpi-label">พนักงานขับที่ใช้งาน</div>
                    <div class="kpi-target">จำนวนคนที่มีการดำเนินการงาน</div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('overview')"><i class="fas fa-chart-line"></i> ภาพรวม</button>
                <button class="tab" onclick="switchTab('drivers')"><i class="fas fa-user-tie"></i> ประสิทธิภาพพนักงาน</button>
                <button class="tab" onclick="switchTab('locations')"><i class="fas fa-map-marked-alt"></i> จุดจัดส่ง</button>
                <button class="tab" onclick="switchTab('time')"><i class="fas fa-hourglass-half"></i> การวิเคราะห์เวลา</button>
                <button class="tab" onclick="switchTab('status')"><i class="fas fa-tasks"></i> สถานะงาน</button>
            </div>

            <!-- Overview Tab -->
            <div class="tab-content active" id="tab-overview">
                <div class="charts-grid">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title"><i class="fas fa-chart-pie"></i> สถานะงานทั้งหมด</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="statusChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title"><i class="fas fa-chart-bar"></i> งานต่อวัน</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="dailyJobsChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card full-width">
                        <div class="chart-header">
                            <h3 class="chart-title"><i class="fas fa-chart-line"></i> แนวโน้มประสิทธิภาพการทำงาน</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Drivers Tab -->
            <div class="tab-content" id="tab-drivers">
                <div class="charts-grid">
                    <div class="chart-card full-width">
                        <div class="chart-header">
                            <h3 class="chart-title"><i class="fas fa-trophy"></i> อันดับประสิทธิภาพพนักงานขับ</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="driverPerformanceChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="table-card">
                    <div class="table-header">
                        <h3 class="table-title">รายละเอียดประสิทธิภาพพนักงานขับ</h3>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>อันดับ</th>
                                <th>พนักงานขับ (Driver ID)</th>
                                <th>งานที่ทำ</th>
                                <th>เวลาเฉลี่ย/งาน</th>
                                <th>ระยะทางรวม</th>
                                <th>อัตราสำเร็จ</th>
                                <th>สถานะ</th>
                            </tr>
                        </thead>
                        <tbody id="driverTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Locations Tab -->
            <div class="tab-content" id="tab-locations">
                <div class="charts-grid">
                    <div class="chart-card full-width">
                        <div class="chart-header">
                            <h3 class="chart-title"><i class="fas fa-map-marker-alt"></i> จำนวนงานต่อจุดจัดส่ง</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="locationChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="table-card">
                    <div class="table-header">
                        <h3 class="table-title">รายละเอียดจุดจัดส่ง</h3>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>จุดจัดส่ง</th>
                                <th>ชื่อสถานที่</th>
                                <th>จำนวนงาน</th>
                                <th>เวลาเฉลี่ย</th>
                                <th>ระยะทางเฉลี่ย</th>
                                <th>GPS Accuracy</th>
                            </tr>
                        </thead>
                        <tbody id="locationTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Time Analysis Tab -->
            <div class="tab-content" id="tab-time">
                <div class="charts-grid">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title"><i class="fas fa-stopwatch"></i> Dwell Time Distribution</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="dwellTimeChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title"><i class="fas fa-clock"></i> Check-in ต่อชั่วโมง</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="hourlyChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card full-width">
                        <div class="chart-header">
                            <h3 class="chart-title"><i class="fas fa-business-time"></i> เวลาในการทำงานแต่ละขั้นตอน</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="processTimeChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status Tab -->
            <div class="tab-content" id="tab-status">
                <div class="status-grid" id="statusGrid">
                </div>

                <div class="table-card" style="margin-top: 24px;">
                    <div class="table-header">
                        <h3 class="table-title">งานที่รอดำเนินการ (Pending Jobs)</h3>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Reference No</th>
                                <th>Shipment No</th>
                                <th>จุดจัดส่ง</th>
                                <th>สถานะ</th>
                                <th>Check-in Time</th>
                                <th>ระยะเวลารอ</th>
                            </tr>
                        </thead>
                        <tbody id="pendingTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="last-update" id="lastUpdate">
            อัปเดตล่าสุด: -
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            spreadsheetId: '1UK6pdRrCGEjXmdtGe2FeSFflSimz0JhhGxAei_OKyLU',
            sheetId: '916029009',
            // For public access, we'll use the CSV export endpoint
            // Alternative: Use Google Sheets API with API key
            csvUrl: `https://docs.google.com/spreadsheets/d/e/2PACX-1vR9OlfC413WyLYWDruzoaic6QPqKoovyEpV8vee8Y9dfKtSrtEbyWEx5GCpb7xWN6nBpHGYnEcPIS8k/pub?output=csv`
        };

        // Global State
        let rawData = [];
        let charts = {};
        let filteredData = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initializeDates();
            loadData();
        });

        // Set default dates (last 7 days)
        function initializeDates() {
            const end = new Date();
            const start = new Date(end);
            start.setDate(start.getDate() - 7);

            document.getElementById('endDate').value = end.toISOString().split('T')[0];
            document.getElementById('startDate').value = start.toISOString().split('T')[0];
        }

        // Load Data from Google Sheets
        async function loadData() {
            showLoading(true);
            hideError();

            try {
                // Method 1: Try CSV export (requires sheet to be published)
                const csvData = await fetchCSV(CONFIG.csvUrl);
                rawData = parseCSV(csvData);

                if (rawData.length === 0) {
                    throw new Error('ไม่พบข้อมูลใน Google Sheet');
                }

                filterAndProcessData();
                renderDashboard();
                showDashboard();
                updateLastUpdate();

            } catch (error) {
                console.error('Error loading data:', error);
                showError(error.message);
            } finally {
                showLoading(false);
            }
        }

        // Fetch CSV
        async function fetchCSV(url) {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP Error: ${response.status}`);
            }
            return await response.text();
        }

        // Parse CSV to JSON
        function parseCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim());
            if (lines.length < 2) return [];

            // Parse header
            const headers = parseCSVLine(lines[0]);

            // Parse data rows
            const result = [];
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length >= headers.length) {
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header.trim()] = values[index] ? values[index].trim() : '';
                    });
                    result.push(row);
                }
            }

            return result;
        }

        // Parse CSV line handling quoted values
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result;
        }

        // Filter and Process Data
        function filterAndProcessData() {
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            endDate.setHours(23, 59, 59);

            filteredData = rawData.filter(row => {
                const createdAt = parseThaiDate(row.createdAt);
                return createdAt && createdAt >= startDate && createdAt <= endDate;
            });
        }

        // Parse Thai Date
        function parseThaiDate(dateStr) {
            if (!dateStr) return null;
            try {
                // Format: "11/12/2025 15:42:05" or "12/12/2025 16:02:43"
                const parts = dateStr.split(' ');
                if (parts.length < 2) return null;

                const [day, month, year] = parts[0].split('/');
                const [time] = parts.slice(1);

                // Handle Thai year (2567 = 2024)
                let yearNum = parseInt(year);
                if (yearNum > 2500) yearNum -= 543;

                return new Date(`${yearNum}-${month}-${day} ${time}`);
            } catch (e) {
                console.error('Date parse error:', dateStr, e);
                return null;
            }
        }

        // Calculate KPIs
        function calculateKPIs() {
            const total = filteredData.length;
            const completed = filteredData.filter(r => r.status === 'END_TRIP' || r.status === 'JOB_DONE').length;
            const completionRate = total > 0 ? ((completed / total) * 100).toFixed(1) : 0;

            // Average dwell time
            const dwellTimes = filteredData
                .filter(r => r.checkIn && r.checkOut)
                .map(r => {
                    const checkIn = parseThaiDate(r.checkIn);
                    const checkOut = parseThaiDate(r.checkOut);
                    return checkIn && checkOut ? (checkOut - checkIn) / 1000 / 60 : null;
                })
                .filter(t => t !== null && t >= 0 && t <= 300); // 0-300 minutes
            const avgDwellTime = dwellTimes.length > 0
                ? (dwellTimes.reduce((a, b) => a + b, 0) / dwellTimes.length).toFixed(1)
                : 0;

            // Total distance
            const totalDistance = filteredData
                .filter(r => r['Distance (km)'])
                .map(r => parseFloat(r['Distance (km)']) || 0)
                .reduce((a, b) => a + b, 0)
                .toFixed(0);

            // GPS Accuracy
            const withGPS = filteredData.filter(r => r.checkInLat && r.checkInLng).length;
            const gpsAccuracy = total > 0 ? ((withGPS / total) * 100).toFixed(1) : 0;

            // Unique drivers
            const uniqueDrivers = [...new Set(filteredData.map(r => r.updatedBy).filter(Boolean))].length;

            return {
                total,
                completed,
                completionRate,
                avgDwellTime,
                totalDistance,
                gpsAccuracy,
                uniqueDrivers
            };
        }

        // Render Dashboard
        function renderDashboard() {
            const kpi = calculateKPIs();

            // Update KPI cards
            document.getElementById('totalJobs').textContent = kpi.total.toLocaleString('th-TH');
            document.getElementById('completionRate').textContent = `${kpi.completionRate}%`;
            document.getElementById('avgDwellTime').textContent = `${kpi.avgDwellTime} นาที`;
            document.getElementById('totalDistance').textContent = `${parseInt(kpi.totalDistance).toLocaleString('th-TH')} กม.`;
            document.getElementById('gpsAccuracy').textContent = `${kpi.gpsAccuracy}%`;
            document.getElementById('activeDrivers').textContent = kpi.uniqueDrivers;

            // Update trends
            updateTrend('completionTrend', kpi.completionRate >= 95 ? 'up' : kpi.completionRate >= 80 ? 'neutral' : 'down');
            updateTrend('dwellTimeTrend', kpi.avgDwellTime <= 15 ? 'up' : kpi.avgDwellTime <= 20 ? 'neutral' : 'down', kpi.avgDwellTime <= 20 ? 'ดี' : 'ต้องปรับปรุง');
            updateTrend('gpsTrend', kpi.gpsAccuracy >= 95 ? 'up' : kpi.gpsAccuracy >= 80 ? 'neutral' : 'down');

            // Render charts
            renderStatusChart();
            renderDailyJobsChart();
            renderTrendChart();
            renderDriverPerformanceChart();
            renderDriverTable();
            renderLocationChart();
            renderLocationTable();
            renderDwellTimeChart();
            renderHourlyChart();
            renderProcessTimeChart();
            renderStatusGrid();
            renderPendingTable();
        }

        // Update trend badge
        function updateTrend(id, direction, text) {
            const element = document.getElementById(id);
            element.className = `kpi-trend ${direction}`;
            if (text) {
                element.innerHTML = direction === 'up' || direction === 'down' ?
                    `<i class="fas fa-arrow-${direction}"></i> ${text}` : text;
            }
        }

        // Status Chart
        function renderStatusChart() {
            const statusCounts = {};
            filteredData.forEach(r => {
                const status = r.status || 'UNKNOWN';
                statusCounts[status] = (statusCounts[status] || 0) + 1;
            });

            const labels = Object.keys(statusCounts).map(s => getStatusLabel(s));
            const data = Object.values(statusCounts);
            const colors = getStatusColors(Object.keys(statusCounts));

            if (charts.status) charts.status.destroy();
            charts.status = new Chart(document.getElementById('statusChart'), {
                type: 'doughnut',
                data: {
                    labels,
                    datasets: [{
                        data,
                        backgroundColor: colors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { font: { family: 'Sarabun' } }
                        }
                    }
                }
            });
        }

        // Daily Jobs Chart
        function renderDailyJobsChart() {
            const dailyData = {};
            filteredData.forEach(r => {
                const date = parseThaiDate(r.createdAt);
                if (date) {
                    const key = date.toISOString().split('T')[0];
                    dailyData[key] = (dailyData[key] || 0) + 1;
                }
            });

            const sortedDates = Object.keys(dailyData).sort();
            const labels = sortedDates.map(d => {
                const date = new Date(d);
                return `${date.getDate()}/${date.getMonth() + 1}`;
            });
            const data = sortedDates.map(d => dailyData[d]);

            if (charts.dailyJobs) charts.dailyJobs.destroy();
            charts.dailyJobs = new Chart(document.getElementById('dailyJobsChart'), {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'จำนวนงาน',
                        data,
                        backgroundColor: '#2563eb',
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        // Trend Chart
        function renderTrendChart() {
            const dailyStats = {};
            filteredData.forEach(r => {
                const date = parseThaiDate(r.createdAt);
                if (date) {
                    const key = date.toISOString().split('T')[0];
                    if (!dailyStats[key]) {
                        dailyStats[key] = { total: 0, completed: 0, avgTime: [], totalDist: 0 };
                    }
                    dailyStats[key].total++;
                    if (r.status === 'END_TRIP' || r.status === 'JOB_DONE') {
                        dailyStats[key].completed++;
                    }
                    if (r.checkIn && r.checkOut) {
                        const checkIn = parseThaiDate(r.checkIn);
                        const checkOut = parseThaiDate(r.checkOut);
                        if (checkIn && checkOut) {
                            dailyStats[key].avgTime.push((checkOut - checkIn) / 1000 / 60);
                        }
                    }
                    if (r['Distance (km)']) {
                        dailyStats[key].totalDist += parseFloat(r['Distance (km)']) || 0;
                    }
                }
            });

            const sortedDates = Object.keys(dailyStats).sort();
            const labels = sortedDates.map(d => {
                const date = new Date(d);
                return `${date.getDate()}/${date.getMonth() + 1}`;
            });

            const completionRates = sortedDates.map(d => {
                const stats = dailyStats[d];
                return stats.total > 0 ? ((stats.completed / stats.total) * 100).toFixed(1) : 0;
            });

            const avgTimes = sortedDates.map(d => {
                const stats = dailyStats[d];
                if (stats.avgTime.length === 0) return 0;
                return (stats.avgTime.reduce((a, b) => a + b, 0) / stats.avgTime.length).toFixed(1);
            });

            if (charts.trend) charts.trend.destroy();
            charts.trend = new Chart(document.getElementById('trendChart'), {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'อัตราเสร็จสิ้น (%)',
                            data: completionRates,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            tension: 0.4,
                            yAxisID: 'y'
                        },
                        {
                            label: 'เวลาเฉลี่ย (นาที)',
                            data: avgTimes,
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            fill: true,
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            min: 0,
                            max: 100,
                            title: { display: true, text: 'อัตราเสร็จสิ้น (%)' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            min: 0,
                            title: { display: true, text: 'เวลาเฉลี่ย (นาที)' },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }

        // Driver Performance Chart
        function renderDriverPerformanceChart() {
            const driverStats = {};
            filteredData.forEach(r => {
                if (!r.updatedBy) return;
                if (!driverStats[r.updatedBy]) {
                    driverStats[r.updatedBy] = { total: 0, completed: 0, time: [], distance: 0 };
                }
                driverStats[r.updatedBy].total++;
                if (r.status === 'END_TRIP' || r.status === 'JOB_DONE') {
                    driverStats[r.updatedBy].completed++;
                }
                if (r.checkIn && r.checkOut) {
                    const checkIn = parseThaiDate(r.checkIn);
                    const checkOut = parseThaiDate(r.checkOut);
                    if (checkIn && checkOut) {
                        driverStats[r.updatedBy].time.push((checkOut - checkIn) / 1000 / 60);
                    }
                }
                if (r['Distance (km)']) {
                    driverStats[r.updatedBy].distance += parseFloat(r['Distance (km)']) || 0;
                }
            });

            const sortedDrivers = Object.entries(driverStats)
                .map(([id, stats]) => ({
                    id: id.substring(0, 12) + '...',
                    stats
                }))
                .sort((a, b) => b.stats.completed - a.stats.completed)
                .slice(0, 10);

            const labels = sortedDrivers.map(d => d.id);
            const data = sortedDrivers.map(d => d.stats.completed);

            if (charts.driver) charts.driver.destroy();
            charts.driver = new Chart(document.getElementById('driverPerformanceChart'), {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'งานที่เสร็จสิ้น',
                        data,
                        backgroundColor: '#8b5cf6',
                        borderRadius: 8
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        // Driver Table
        function renderDriverTable() {
            const driverStats = {};
            filteredData.forEach(r => {
                if (!r.updatedBy) return;
                if (!driverStats[r.updatedBy]) {
                    driverStats[r.updatedBy] = {
                        total: 0,
                        completed: 0,
                        time: [],
                        distance: 0
                    };
                }
                driverStats[r.updatedBy].total++;
                if (r.status === 'END_TRIP' || r.status === 'JOB_DONE') {
                    driverStats[r.updatedBy].completed++;
                }
                if (r.checkIn && r.checkOut) {
                    const checkIn = parseThaiDate(r.checkIn);
                    const checkOut = parseThaiDate(r.checkOut);
                    if (checkIn && checkOut) {
                        driverStats[r.updatedBy].time.push((checkOut - checkIn) / 1000 / 60);
                    }
                }
                if (r['Distance (km)']) {
                    driverStats[r.updatedBy].distance += parseFloat(r['Distance (km)']) || 0;
                }
            });

            const sortedDrivers = Object.entries(driverStats)
                .map(([id, stats]) => ({
                    id,
                    stats
                }))
                .sort((a, b) => b.stats.completed - a.stats.completed);

            const tbody = document.getElementById('driverTableBody');
            tbody.innerHTML = sortedDrivers.map((d, i) => {
                const avgTime = d.stats.time.length > 0
                    ? (d.stats.time.reduce((a, b) => a + b, 0) / d.stats.time.length).toFixed(1)
                    : '-';
                const successRate = ((d.stats.completed / d.stats.total) * 100).toFixed(1);
                const statusClass = successRate >= 95 ? 'success' : successRate >= 80 ? 'warning' : 'danger';

                return `
                    <tr>
                        <td>${i + 1}</td>
                        <td><code>${d.id.substring(0, 20)}...</code></td>
                        <td>${d.stats.completed}</td>
                        <td>${avgTime} นาที</td>
                        <td>${d.stats.distance.toFixed(0)} กม.</td>
                        <td>
                            <div class="progress-bar">
                                <div class="progress-fill ${statusClass}" style="width: ${successRate}%"></div>
                            </div>
                            <small>${successRate}%</small>
                        </td>
                        <td><span class="status-badge ${statusClass}">${statusClass === 'success' ? 'ดีมาก' : statusClass === 'warning' ? 'ปานกลาง' : 'ต้องปรับปรุง'}</span></td>
                    </tr>
                `;
            }).join('');
        }

        // Location Chart
        function renderLocationChart() {
            const locationCounts = {};
            filteredData.forEach(r => {
                const loc = r.shipToCode || r.shipToName || 'UNKNOWN';
                locationCounts[loc] = (locationCounts[loc] || 0) + 1;
            });

            const sorted = Object.entries(locationCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 15);

            const labels = sorted.map(s => s[0]);
            const data = sorted.map(s => s[1]);

            if (charts.location) charts.location.destroy();
            charts.location = new Chart(document.getElementById('locationChart'), {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'จำนวนงาน',
                        data,
                        backgroundColor: '#06b6d4',
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        // Location Table
        function renderLocationTable() {
            const locationStats = {};
            filteredData.forEach(r => {
                const code = r.shipToCode || 'UNKNOWN';
                const name = r.shipToName || '-';
                if (!locationStats[code]) {
                    locationStats[code] = {
                        name,
                        count: 0,
                        times: [],
                        distances: [],
                        gpsValid: 0,
                        gpsTotal: 0
                    };
                }
                locationStats[code].count++;
                if (r.checkIn && r.checkOut) {
                    const checkIn = parseThaiDate(r.checkIn);
                    const checkOut = parseThaiDate(r.checkOut);
                    if (checkIn && checkOut) {
                        locationStats[code].times.push((checkOut - checkIn) / 1000 / 60);
                    }
                }
                if (r['Distance (km)']) {
                    locationStats[code].distances.push(parseFloat(r['Distance (km)']) || 0);
                }
                locationStats[code].gpsTotal++;
                if (r.checkInLat && r.checkInLng) {
                    locationStats[code].gpsValid++;
                }
            });

            const sorted = Object.entries(locationStats)
                .map(([code, stats]) => ({ code, stats }))
                .sort((a, b) => b.stats.count - a.stats.count);

            const tbody = document.getElementById('locationTableBody');
            tbody.innerHTML = sorted.map(loc => {
                const avgTime = loc.stats.times.length > 0
                    ? (loc.stats.times.reduce((a, b) => a + b, 0) / loc.stats.times.length).toFixed(1)
                    : '-';
                const avgDist = loc.stats.distances.length > 0
                    ? (loc.stats.distances.reduce((a, b) => a + b, 0) / loc.stats.distances.length).toFixed(1)
                    : '-';
                const gpsRate = loc.stats.gpsTotal > 0
                    ? ((loc.stats.gpsValid / loc.stats.gpsTotal) * 100).toFixed(1)
                    : '-';

                return `
                    <tr>
                        <td><strong>${loc.code}</strong></td>
                        <td>${loc.stats.name}</td>
                        <td>${loc.stats.count}</td>
                        <td>${avgTime} นาที</td>
                        <td>${avgDist} กม.</td>
                        <td>${gpsRate}%</td>
                    </tr>
                `;
            }).join('');
        }

        // Dwell Time Chart
        function renderDwellTimeChart() {
            const dwellTimes = filteredData
                .filter(r => r.checkIn && r.checkOut)
                .map(r => {
                    const checkIn = parseThaiDate(r.checkIn);
                    const checkOut = parseThaiDate(r.checkOut);
                    return checkIn && checkOut ? (checkOut - checkIn) / 1000 / 60 : null;
                })
                .filter(t => t !== null && t >= 0 && t <= 300);

            const bins = {
                '0-15 นาที': 0,
                '15-30 นาที': 0,
                '30-60 นาที': 0,
                '60-120 นาที': 0,
                '> 120 นาที': 0
            };

            dwellTimes.forEach(t => {
                if (t < 15) bins['0-15 นาที']++;
                else if (t < 30) bins['15-30 นาที']++;
                else if (t < 60) bins['30-60 นาที']++;
                else if (t < 120) bins['60-120 นาที']++;
                else bins['> 120 นาที']++;
            });

            if (charts.dwellTime) charts.dwellTime.destroy();
            charts.dwellTime = new Chart(document.getElementById('dwellTimeChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(bins),
                    datasets: [{
                        label: 'จำนวน',
                        data: Object.values(bins),
                        backgroundColor: ['#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#64748b'],
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        // Hourly Chart
        function renderHourlyChart() {
            const hourlyData = {};
            for (let i = 0; i < 24; i++) {
                hourlyData[i] = 0;
            }

            filteredData.forEach(r => {
                const checkIn = parseThaiDate(r.checkIn);
                if (checkIn) {
                    const hour = checkIn.getHours();
                    hourlyData[hour]++;
                }
            });

            if (charts.hourly) charts.hourly.destroy();
            charts.hourly = new Chart(document.getElementById('hourlyChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(hourlyData).map(h => `${h}:00`),
                    datasets: [{
                        label: 'Check-in',
                        data: Object.values(hourlyData),
                        backgroundColor: '#2563eb',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        // Process Time Chart
        function renderProcessTimeChart() {
            // Calculate average times for each process step
            const processTimes = {
                'Check-in to Checkout': [],
                'Checkout to Fueling': [],
                'Fueling to Unload': [],
                'Unload to Review': [],
                'Review to Job Done': []
            };

            filteredData.forEach(r => {
                if (r.checkIn && r.checkOut) {
                    const checkIn = parseThaiDate(r.checkIn);
                    const checkOut = parseThaiDate(r.checkOut);
                    if (checkIn && checkOut) {
                        processTimes['Check-in to Checkout'].push((checkOut - checkIn) / 1000 / 60);
                    }
                }
                if (r.checkOut && r.fuelingAt) {
                    const checkOut = parseThaiDate(r.checkOut);
                    const fueling = parseThaiDate(r.fuelingAt);
                    if (checkOut && fueling) {
                        processTimes['Checkout to Fueling'].push((fueling - checkOut) / 1000 / 60);
                    }
                }
                // Add more process steps as needed
            });

            const labels = Object.keys(processTimes);
            const data = labels.map(label => {
                const times = processTimes[label];
                return times.length > 0 ? (times.reduce((a, b) => a + b, 0) / times.length).toFixed(1) : 0;
            });

            if (charts.processTime) charts.processTime.destroy();
            charts.processTime = new Chart(document.getElementById('processTimeChart'), {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'เวลาเฉลี่ย (นาที)',
                        data,
                        backgroundColor: ['#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4'],
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        // Status Grid
        function renderStatusGrid() {
            const statusCounts = {};
            filteredData.forEach(r => {
                const status = r.status || 'UNKNOWN';
                statusCounts[status] = (statusCounts[status] || 0) + 1;
            });

            const total = filteredData.length;
            const grid = document.getElementById('statusGrid');
            grid.innerHTML = Object.entries(statusCounts).map(([status, count]) => {
                const percent = ((count / total) * 100).toFixed(1);
                const statusInfo = getStatusInfo(status);
                return `
                    <div class="status-item" style="border-left: 4px solid ${statusInfo.color}">
                        <div class="status-item-label">${statusInfo.label}</div>
                        <div class="status-item-value">${count}</div>
                        <div class="status-item-percent">${percent}%</div>
                    </div>
                `;
            }).join('');
        }

        // Pending Table
        function renderPendingTable() {
            const pending = filteredData.filter(r =>
                r.status !== 'END_TRIP' && r.status !== 'JOB_DONE' && r.status !== 'REVIEWED'
            ).slice(0, 20);

            const tbody = document.getElementById('pendingTableBody');
            tbody.innerHTML = pending.map(r => {
                const checkIn = parseThaiDate(r.checkIn);
                const waitTime = checkIn ? ((new Date() - checkIn) / 1000 / 60).toFixed(0) : '-';

                return `
                    <tr>
                        <td><code>${r.referenceNo || '-'}</code></td>
                        <td><code>${r.shipmentNo || '-'}</code></td>
                        <td>${r.shipToName || r.shipToCode || '-'}</td>
                        <td><span class="status-badge ${getStatusBadgeClass(r.status)}">${getStatusLabel(r.status)}</span></td>
                        <td>${r.checkIn || '-'}</td>
                        <td>${waitTime} นาที</td>
                    </tr>
                `;
            }).join('');
        }

        // Helper Functions
        function getStatusLabel(status) {
            const labels = {
                'NEW': 'งานใหม่',
                'CHECKIN': 'ถึงจุดจัดส่ง',
                'CHECKOUT': 'จัดส่งเสร็จ',
                'FUELING': 'กำลังเติมน้ำมัน',
                'UNLOAD_DONE': 'ขนถ่ายเสร็จ',
                'REVIEWED': 'ถูกประเมินแล้ว',
                'JOB_DONE': 'งานเสร็จสมบูรณ์',
                'END_TRIP': 'จบทริป'
            };
            return labels[status] || status;
        }

        function getStatusInfo(status) {
            const info = {
                'NEW': { label: 'งานใหม่', color: '#64748b' },
                'CHECKIN': { label: 'ถึงจุดจัดส่ง', color: '#f59e0b' },
                'CHECKOUT': { label: 'จัดส่งเสร็จ', color: '#06b6d4' },
                'FUELING': { label: 'กำลังเติมน้ำมัน', color: '#8b5cf6' },
                'UNLOAD_DONE': { label: 'ขนถ่ายเสร็จ', color: '#10b981' },
                'REVIEWED': { label: 'ถูกประเมินแล้ว', color: '#2563eb' },
                'JOB_DONE': { label: 'งานเสร็จสมบูรณ์', color: '#10b981' },
                'END_TRIP': { label: 'จบทริป', color: '#059669' }
            };
            return info[status] || { label: status, color: '#64748b' };
        }

        function getStatusBadgeClass(status) {
            if (['END_TRIP', 'JOB_DONE', 'REVIEWED'].includes(status)) return 'success';
            if (['CHECKOUT', 'UNLOAD_DONE'].includes(status)) return 'info';
            if (['CHECKIN', 'FUELING'].includes(status)) return 'warning';
            return 'danger';
        }

        function getStatusColors(statuses) {
            return statuses.map(s => getStatusInfo(s).color);
        }

        // Tab Switching
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        // UI Helpers
        function showLoading(show) {
            document.getElementById('loadingContainer').style.display = show ? 'block' : 'none';
        }

        function showDashboard() {
            document.getElementById('dashboard').classList.add('loaded');
        }

        function showError(message) {
            document.getElementById('errorDetails').textContent = message;
            document.getElementById('errorContainer').classList.add('show');
        }

        function hideError() {
            document.getElementById('errorContainer').classList.remove('show');
        }

        function updateLastUpdate() {
            const now = new Date();
            const options = {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            };
            document.getElementById('lastUpdate').textContent =
                `อัปเดตล่าสุด: ${now.toLocaleDateString('th-TH', options)}`;
        }

        // Export Report
        function exportReport() {
            const kpi = calculateKPIs();
            const report = {
                generatedAt: new Date().toISOString(),
                period: {
                    start: document.getElementById('startDate').value,
                    end: document.getElementById('endDate').value
                },
                kpi: kpi,
                data: filteredData
            };

            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `performance-report-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
