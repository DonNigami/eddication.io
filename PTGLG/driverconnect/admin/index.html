<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DriverConnect Admin Panel</title>
    <link rel="stylesheet" href="admin.css">
    <!-- Leaflet CSS for map view -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
</head>
<body>
    <div id="notification-container"></div>
    <div id="auth-container">
        <div class="auth-box">
            <h1>DriverConnect Admin</h1>
            <p id="auth-status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå...</p>
        </div>
    </div>

    <div id="admin-container" class="hidden">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>Admin Panel</h2>
            </div>
            <nav class="sidebar-nav">
                <ul>
                    <!-- Dashboard & Overview -->
                    <li class="nav-section-header">üìä Dashboard & Reports</li>
                    <li><a href="#" class="nav-link active" data-target="dashboard">üìà Dashboard</a></li>
                    <li><a href="#" class="nav-link" data-target="logistics-performance">üìä Logistics Performance</a></li>
                    <li><a href="#" class="nav-link" data-target="driver-reports">üë§ Driver Reports</a></li>
                    <li><a href="#" class="nav-link" data-target="scheduled-reports">üìÑ Scheduled Reports</a></li>
                    
                    <!-- Operations Management -->
                    <li class="nav-section-header">üöö Operations Management</li>
                    <li><a href="#" class="nav-link" data-target="jobs">üöö Job Management</a></li>
                    <li><a href="#" class="nav-link" data-target="b100-jobs">üõ¢Ô∏è B100 Jobs</a></li>
                    <li><a href="#" class="nav-link" data-target="b100-outstanding">üí∞ B100 Outstanding</a></li>
                    <li><a href="#" class="nav-link" data-target="holiday-work">üéå Holiday Work</a></li>
                    
                    <!-- Fleet & Maintenance -->
                    <li class="nav-section-header">üîß Fleet & Maintenance</li>
                    <li><a href="#" class="nav-link" data-target="vehicle-breakdown">üîß Vehicle Breakdown</a></li>
                    <li><a href="#" class="nav-link" data-target="fuel-siphoning">‚õΩ Fuel Siphoning</a></li>
                    
                    <!-- System Management -->
                    <li class="nav-section-header">‚öôÔ∏è System Management</li>
                    <li><a href="#" class="nav-link" data-target="users">üë• User Management</a></li>
                    <li><a href="#" class="nav-link" data-target="alerts">üö® Alerts <span id="alerts-badge" class="badge hidden">0</span></a></li>
                    <li><a href="#" class="nav-link" data-target="settings">‚öôÔ∏è Settings</a></li>
                    
                    <!-- Developer Tools -->
                    <li class="nav-section-header">üõ†Ô∏è Developer Tools</li>
                    <li><a href="#" class="nav-link" data-target="logs">üìú Log Viewer</a></li>
                    <li><a href="#" class="nav-link" data-target="debug-import-tool">üîç Debug Import</a></li>
                </ul>
            </nav>
            <div class="sidebar-footer">
                <p id="admin-username"></p>
                <button id="logout-button">Logout</button>
            </div>
        </aside>
        <main class="main-content">
            <!-- Notification Bell -->
            <div class="notification-bell-container">
                <button class="notification-bell" id="notificationBell" title="‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô">
                    üîî
                    <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                </button>
                
                <div class="notification-dropdown" id="notificationDropdown">
                    <div class="notification-dropdown-header">
                        <h3>üîî ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h3>
                        <button class="btn-text" id="markAllRead">‡∏≠‡πà‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                    </div>
                    <div class="notification-list" id="notificationList">
                        <div class="notification-empty">
                            <div class="notification-empty-icon">üîï</div>
                            <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <section id="dashboard" class="content-section active">
                <h1>Dashboard</h1>
                <div class="kpi-cards">
                    <div class="kpi-card">
                        <h3>Total Users</h3>
                        <p id="kpi-total-users">0</p>
                    </div>
                    <div class="kpi-card">
                        <h3>Active Jobs</h3>
                        <p id="kpi-active-jobs">0</p>
                    </div>
                    <div class="kpi-card">
                        <h3>Pending Approvals</h3>
                        <p id="kpi-pending-approvals">0</p>
                    </div>
                </div>
                <div id="map" style="height: 400px; width: 100%; margin-top: 20px;"></div>

                <div class="map-playback-controls" style="margin-top: 20px; background-color: var(--card-bg); padding: 15px; border-radius: 8px;">
                    <h3>Driver History Playback</h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: flex-end;">
                        <div style="flex-grow: 1;">
                            <label for="playback-driver-select">Driver:</label>
                            <select id="playback-driver-select" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid var(--border-color); background-color: #333; color: var(--text-color);"></select>
                        </div>
                        <div style="flex-grow: 1;">
                            <label for="playback-start-datetime">Start:</label>
                            <input type="datetime-local" id="playback-start-datetime" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid var(--border-color); background-color: #333; color: var(--text-color);">
                        </div>
                        <div style="flex-grow: 1;">
                            <label for="playback-end-datetime">End:</label>
                            <input type="datetime-local" id="playback-end-datetime" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid var(--border-color); background-color: #333; color: var(--text-color);">
                        </div>
                        <div>
                            <label for="playback-speed">Speed (x):</label>
                            <input type="number" id="playback-speed" value="1" min="0.1" step="0.1" style="width: 80px; padding: 8px; border-radius: 5px; border: 1px solid var(--border-color); background-color: #333; color: var(--text-color);">
                        </div>
                        <button id="load-playback-data-btn" class="control-btn" style="padding: 8px 12px; background-color: var(--primary-color); color: #fff; border: none; border-radius: 5px; cursor: pointer;">Load Data</button>
                        <button id="play-button" class="control-btn" style="padding: 8px 12px; background-color: #28a745; color: #fff; border: none; border-radius: 5px; cursor: pointer;">‚ñ∂ Play</button>
                        <button id="pause-button" class="control-btn" style="padding: 8px 12px; background-color: #ffc107; color: #fff; border: none; border-radius: 5px; cursor: pointer;">‚è∏ Pause</button>
                        <button id="stop-button" class="control-btn" style="padding: 8px 12px; background-color: #dc3545; color: #fff; border: none; border-radius: 5px; cursor: pointer;">‚èπ Stop</button>
                    </div>
                </div>
            </section>
            <section id="users" class="content-section hidden">
                <h1>User Management</h1>
                <div class="table-container">
                    <table id="users-table">
                        <thead>
                            <tr>
                                <th>Display Name</th>
                                <th>LINE User ID</th>
                                <th>Status</th>
                                <th>Role</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- User rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </section>
            <section id="jobs" class="content-section hidden">
                <h1>Job Management</h1>
                <div class="job-controls">
                    <input type="text" id="job-search-input" placeholder="Search by Reference No., Shipment No., or Driver">
                    <button id="create-job-btn">Create New Job</button>
                </div>
                <div class="table-container" style="margin-top: 20px;">
                    <table id="jobs-table">
                        <thead>
                            <tr>
                                <th>Reference</th>
                                <th>Shipment No.</th>
                                <th>Driver</th>
                                <th>Status</th>
                                <th>Trip Ended</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Job rows will be inserted here -->
                        </tbody>
                    </table>
                </div>

                <!-- Job Edit/Create Modal -->
                <div id="job-modal" class="modal hidden">
                    <div class="modal-content">
                        <span class="close-button">&times;</span>
                        <h2>Job Details</h2>
                        <form id="job-form">
                            <input type="hidden" id="job-id">
                            <label for="job-reference">Reference:</label>
                            <input type="text" id="job-reference" required>

                            <label for="job-shipment-no">Shipment No.:</label>
                            <input type="text" id="job-shipment-no">

                            <label for="job-driver">Driver (LINE User ID):</label>
                            <input type="text" id="job-driver">

                            <label for="job-status">Status:</label>
                            <select id="job-status">
                                <option value="pending">Pending</option>
                                <option value="active">Active</option>
                                <option value="completed">Completed</option>
                                <option value="cancelled">Cancelled</option>
                            </select>

                            <label for="job-trip-ended">Trip Ended:</label>
                            <input type="checkbox" id="job-trip-ended">

                            <button type="submit">Save Job</button>
                        </form>
                    </div>
                </div>

                <!-- Job Details Modal -->
                <div id="job-details-modal" class="modal hidden">
                    <div class="modal-content large-modal">
                        <span class="close-button" id="job-details-close">&times;</span>
                        <h2>Job Details: <span id="job-details-reference"></span></h2>
                        <div class="job-details-sections">
                            <div class="job-details-section">
                                <h3>Basic Info</h3>
                                <p><strong>Reference:</strong> <span id="detail-job-reference"></span></p>
                                <p><strong>Shipment No.:</strong> <span id="detail-job-shipment-no"></span></p>
                                <p><strong>Driver:</strong> <span id="detail-job-driver"></span></p>
                                <p><strong>Status:</strong> <span id="detail-job-status"></span></p>
                                <p><strong>Trip Ended:</strong> <span id="detail-job-trip-ended"></span></p>
                                <p><strong>Created At:</strong> <span id="detail-job-created-at"></span></p>
                                <p><strong>Updated At:</strong> <span id="detail-job-updated-at"></span></p>
                            </div>
                            <div class="job-details-section">
                                <h3>Trip Stops</h3>
                                <div class="table-container">
                                    <table id="job-details-stops-table">
                                        <thead>
                                            <tr>
                                                <th>Seq</th>
                                                <th>Destination</th>
                                                <th>Status</th>
                                                <th>Check-in Time</th>
                                                <th>Check-out Time</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="job-details-section">
                                <h3>Alcohol Checks</h3>
                                <div class="table-container">
                                    <table id="job-details-alcohol-table">
                                        <thead>
                                            <tr>
                                                <th>Driver</th>
                                                <th>Value</th>
                                                <th>Checked At</th>
                                                <th>Image</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="job-details-section">
                                <h3>Driver Logs</h3>
                                <div class="table-container">
                                    <table id="job-details-logs-table">
                                        <thead>
                                            <tr>
                                                <th>Time</th>
                                                <th>Action</th>
                                                <th>User</th>
                                                <th>Location</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <section id="driver-reports" class="content-section hidden">
                <h1>Driver Performance Reports</h1>
                <div class="report-controls">
                    <label for="report-driver-select">Select Driver:</label>
                    <select id="report-driver-select"></select>

                    <label for="report-start-date">Start Date:</label>
                    <input type="date" id="report-start-date">

                    <label for="report-end-date">End Date:</label>
                    <input type="date" id="report-end-date">

                    <button id="generate-report-btn">Generate Report</button>
                </div>
                <div id="driver-report-results" class="table-container" style="margin-top: 20px;">
                    <h3>Summary</h3>
                    <p><strong>Total Jobs:</strong> <span id="report-total-jobs">0</span></p>
                    <p><strong>Completed Jobs:</strong> <span id="report-completed-jobs">0</span></p>
                    <p><strong>Alcohol Checks:</strong> <span id="report-alcohol-checks">0</span></p>
                    
                    <h3>Jobs in Period</h3>
                    <table id="driver-jobs-table">
                        <thead>
                            <tr>
                                <th>Reference</th>
                                <th>Shipment No.</th>
                                <th>Status</th>
                                <th>Trip Ended</th>
                                <th>Created At</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>
            <section id="settings" class="content-section hidden">
                <h1>Application Settings</h1>
                <form id="settings-form">
                    <div class="settings-group">
                        <label for="geofencing_radius_m">Geofencing Radius (meters):</label>
                        <input type="number" id="geofencing_radius_m" min="1" required>
                        <p class="setting-description">Radius around destination for driver check-in validation.</p>
                    </div>
                    <div class="settings-group">
                        <label for="driver_app_auto_refresh_interval_s">Driver App Auto-Refresh Interval (seconds):</label>
                        <input type="number" id="driver_app_auto_refresh_interval_s" min="5" required>
                        <p class="setting-description">How often the driver app refreshes job data.</p>
                    </div>
                    <div class="settings-group">
                        <label for="admin_panel_map_zoom">Admin Panel Map Default Zoom:</label>
                        <input type="number" id="admin_panel_map_zoom" min="1" max="18" required>
                        <p class="setting-description">Default zoom level for the map on the admin dashboard.</p>
                    </div>
                    <div class="settings-group">
                        <label for="admin_panel_map_center_lat">Admin Panel Map Center Latitude:</label>
                        <input type="number" id="admin_panel_map_center_lat" step="any" required>
                        <p class="setting-description">Default latitude for the map center on the admin dashboard.</p>
                    </div>
                    <div class="settings-group">
                        <label for="admin_panel_map_center_lng">Admin Panel Map Center Longitude:</label>
                        <input type="number" id="admin_panel_map_center_lng" step="any" required>
                        <p class="setting-description">Default longitude for the map center on the admin dashboard.</p>
                    </div>
                    <button type="submit">Save Settings</button>
                </form>
            </section>
            <section id="scheduled-reports" class="content-section hidden">
                <h1>Scheduled Reports Management</h1>
                <div class="report-schedule-controls">
                    <button id="create-report-schedule-btn">Create New Schedule</button>
                </div>
                <div class="table-container" style="margin-top: 20px;">
                    <table id="report-schedules-table">
                        <thead>
                            <tr>
                                <th>Report Name</th>
                                <th>Type</th>
                                <th>Frequency</th>
                                <th>Next Run</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Report schedules will be inserted here -->
                        </tbody>
                    </table>
                </div>

                <!-- Report Schedule Modal (for Create/Edit) -->
                <div id="report-schedule-modal" class="modal hidden">
                    <div class="modal-content">
                        <span class="close-button">&times;</span>
                        <h2>Report Schedule Details</h2>
                        <form id="report-schedule-form">
                            <input type="hidden" id="schedule-id">
                            <label for="schedule-report-name">Report Name:</label>
                            <input type="text" id="schedule-report-name" required>

                            <label for="schedule-report-type">Report Type:</label>
                            <select id="schedule-report-type" required>
                                <option value="driver_performance">Driver Performance</option>
                                <option value="job_summary">Job Summary</option>
                            </select>

                            <label for="schedule-frequency">Frequency:</label>
                            <select id="schedule-frequency" required>
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                            </select>

                            <label for="schedule-recipients">Recipients (JSON, e.g., [{"type":"email", "address":"a@b.com"}] or [{"type":"line", "id":"Uxxx"}]):</label>
                            <textarea id="schedule-recipients" rows="3"></textarea>
                            <p class="setting-description">JSON array of recipient objects. e.g., `[{"type":"email", "address":"a@b.com"}, {"type":"line", "id":"Uxxx"}]`</p>

                            <label for="schedule-status">Status:</label>
                            <select id="schedule-status">
                                <option value="active">Active</option>
                                <option value="paused">Paused</option>
                            </select>

                            <button type="submit">Save Schedule</button>
                        </form>
                    </div>
                </div>
            </section>
            <section id="alerts" class="content-section hidden">
                <h1>Triggered Alerts</h1>
                <div class="table-container">
                    <table id="alerts-table">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Rule Name</th>
                                <th>Driver ID</th>
                                <th>Trip ID</th>
                                <th>Message</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Alert rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </section>
            <section id="logs" class="content-section hidden">
                <h1>Log Viewer</h1>
                <div class="log-controls">
                    <input type="text" id="log-search-reference" placeholder="Filter by Reference">
                    <input type="text" id="log-search-action" placeholder="Filter by Action">
                    <input type="text" id="log-search-user-id" placeholder="Filter by User ID">
                </div>
                <div class="table-container" style="margin-top: 20px;">
                    <table id="logs-table">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Reference</th>
                                <th>Action</th>
                                <th>User ID</th>
                                <th>Details</th>
                                <th>Location</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Log rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- NEW: Debug Import Section -->
            <section id="debug-import-tool" class="content-section hidden">
                <!-- Content will be loaded dynamically from debug-import-content.html -->
            </section>

            <!-- Holiday Work Section -->
            <section id="holiday-work" class="content-section hidden">
                <h1>üéä Holiday Work Approval</h1>
                
                <!-- Summary Cards -->
                <div class="kpi-cards" style="margin-bottom: 20px;">
                    <div class="kpi-card">
                        <h3>‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h3>
                        <p id="pending-holiday-count" style="color: #ff9800;">0</p>
                    </div>
                    <div class="kpi-card">
                        <h3>‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</h3>
                        <p id="approved-holiday-count" style="color: #4caf50;">0</p>
                    </div>
                    <div class="kpi-card">
                        <h3>‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</h3>
                        <p id="rejected-holiday-count" style="color: #f44336;">0</p>
                    </div>
                </div>
                
                <!-- Filters -->
                <div class="holiday-work-controls" style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                    <input type="text" id="holiday-work-search" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Reference, ‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö..." style="flex: 1; min-width: 200px; padding: 8px; border-radius: 5px; border: 1px solid var(--border);">
                    
                    <select id="holiday-status-filter" style="padding: 8px; border-radius: 5px; border: 1px solid var(--border);">
                        <option value="all">üìã ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                        <option value="pending" selected>‚è≥ ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option>
                        <option value="approved">‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</option>
                        <option value="rejected">‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</option>
                    </select>
                    
                    <input type="date" id="holiday-date-from" style="padding: 8px; border-radius: 5px; border: 1px solid var(--border);">
                    <input type="date" id="holiday-date-to" style="padding: 8px; border-radius: 5px; border: 1px solid var(--border);">
                    
                    <button id="holiday-refresh-btn" style="padding: 8px 16px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer;">
                        üîÑ Refresh
                    </button>
                </div>
                
                <!-- Table -->
                <div class="table-container" style="margin-top: 20px;">
                    <table id="holiday-work-table">
                        <thead>
                            <tr>
                                <th>Reference</th>
                                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô</th>
                                <th>‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö</th>
                                <th>‡∏£‡∏ñ</th>
                                <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏∏‡∏î</th>
                                <th>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•/‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                <th>‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="holiday-work-tbody">
                            <tr>
                                <td colspan="8" style="text-align: center; padding: 40px; color: var(--text-sub);">
                                    <div style="font-size: 48px; margin-bottom: 10px;">‚è≥</div>
                                    <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Approve/Reject Modal -->
                <div id="holiday-approval-modal" class="modal hidden">
                    <div class="modal-content" style="max-width: 600px;">
                        <span class="close-button" id="holiday-approval-modal-close">&times;</span>
                        <h2 id="approval-modal-title">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î</h2>
                        
                        <div style="background: var(--bg); padding: 15px; border-radius: 8px; margin: 15px 0;">
                            <p><strong>Reference:</strong> <span id="approval-reference"></span></p>
                            <p><strong>‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö:</strong> <span id="approval-driver"></span></p>
                            <p><strong>‡∏£‡∏ñ:</strong> <span id="approval-vehicle"></span></p>
                            <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> <span id="approval-date"></span></p>
                            <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 5px;">
                                <strong>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏à‡∏≤‡∏Å‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö:</strong>
                                <p id="approval-notes" style="margin: 5px 0; color: var(--text-main);"></p>
                            </div>
                        </div>
                        
                        <form id="holiday-approval-form">
                            <input type="hidden" id="approval-job-id">
                            <input type="hidden" id="approval-reference-input">
                            <input type="hidden" id="approval-action">
                            
                            <label for="approval-comment">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô/‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: <span id="approval-comment-required" style="color: red; display: none;">*</span></label>
                            <textarea id="approval-comment" rows="3" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•..." style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid var(--border); resize: vertical;"></textarea>
                            
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button type="submit" id="approve-btn" style="flex: 1; padding: 12px; background: #4caf50; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">
                                    ‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                                </button>
                                <button type="button" id="reject-btn" style="flex: 1; padding: 12px; background: #f44336; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">
                                    ‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò
                                </button>
                                <button type="button" class="cancel-btn" style="padding: 12px 20px; background: var(--border); color: var(--text-main); border: none; border-radius: 5px; cursor: pointer;">
                                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </section>

            <!-- Vehicle Breakdown Section -->
            <section id="vehicle-breakdown" class="content-section hidden">
                <h1>Vehicle Breakdown Management</h1>
                <div class="breakdown-controls">
                    <input type="text" id="breakdown-search" placeholder="Search by Reference, Driver...">
                    <button id="process-breakdown-btn">Process New Breakdown</button>
                </div>
                <div class="table-container" style="margin-top: 20px;">
                    <h3>Breakdown Records</h3>
                    <table id="breakdown-table">
                        <thead>
                            <tr>
                                <th>Original Ref</th>
                                <th>New Ref</th>
                                <th>Driver</th>
                                <th>Reason</th>
                                <th>Date</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <!-- Vehicle Breakdown Process Modal -->
                <div id="breakdown-modal" class="modal hidden">
                    <div class="modal-content">
                        <span class="close-button" id="breakdown-modal-close">&times;</span>
                        <h2>Process Vehicle Breakdown</h2>
                        <form id="breakdown-form">
                            <label for="breakdown-job-select">Select Active Job:</label>
                            <select id="breakdown-job-select" required>
                                <option value="">-- Select Job --</option>
                            </select>

                            <div id="breakdown-job-details" class="hidden">
                                <p><strong>Reference:</strong> <span id="breakdown-original-ref"></span></p>
                                <p><strong>Driver:</strong> <span id="breakdown-driver"></span></p>
                                <p><strong>Vehicle:</strong> <span id="breakdown-vehicle"></span></p>
                            </div>

                            <label for="breakdown-reason">Breakdown Reason:</label>
                            <textarea id="breakdown-reason" rows="3" placeholder="Describe the breakdown reason..." required></textarea>

                            <label for="breakdown-new-vehicle">New Vehicle Plate (optional):</label>
                            <input type="text" id="breakdown-new-vehicle" placeholder="Enter new vehicle plate if changing">

                            <div class="breakdown-preview hidden" id="breakdown-preview">
                                <p><strong>New Reference will be:</strong> <span id="breakdown-new-ref-preview"></span></p>
                            </div>

                            <button type="submit">Process Breakdown & Create New Job</button>
                        </form>
                    </div>
                </div>
            </section>

            <!-- Fuel Siphoning Section -->
            <section id="fuel-siphoning" class="content-section hidden">
                <h1>Fuel Siphoning Records</h1>
                <div class="siphoning-controls">
                    <input type="text" id="siphoning-search" placeholder="Search by Station, Driver, Vehicle...">
                    <input type="date" id="siphoning-date-filter">
                    <button id="create-siphoning-btn">Record New Siphoning</button>
                </div>
                <div class="table-container" style="margin-top: 20px;">
                    <table id="siphoning-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Station</th>
                                <th>Driver</th>
                                <th>Vehicle</th>
                                <th>Liters</th>
                                <th>Evidence</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <!-- Fuel Siphoning Create/Edit Modal -->
                <div id="siphoning-modal" class="modal hidden">
                    <div class="modal-content">
                        <span class="close-button" id="siphoning-modal-close">&times;</span>
                        <h2 id="siphoning-modal-title">Record Fuel Siphoning</h2>
                        <form id="siphoning-form">
                            <input type="hidden" id="siphoning-id">

                            <label for="siphoning-reference">Reference:</label>
                            <input type="text" id="siphoning-reference" required placeholder="Auto-generated" readonly style="background-color: #444; cursor: not-allowed;">

                            <label for="siphoning-station">Station:</label>
                            <select id="siphoning-station" required>
                                <option value="">-- Select Station --</option>
                            </select>

                            <label for="siphoning-driver">Driver:</label>
                            <select id="siphoning-driver" required>
                                <option value="">-- Select Driver --</option>
                            </select>

                            <label for="siphoning-vehicle">Vehicle Plate:</label>
                            <input type="text" id="siphoning-vehicle" required placeholder="e.g., ‡∏Å‡∏Ç-1234">

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div>
                                    <label for="siphoning-date">Date:</label>
                                    <input type="date" id="siphoning-date" required>
                                </div>
                                <div>
                                    <label for="siphoning-time">Time:</label>
                                    <input type="time" id="siphoning-time">
                                </div>
                            </div>

                            <label for="siphoning-liters">Liters:</label>
                            <input type="number" id="siphoning-liters" step="0.01" min="0" required placeholder="Enter amount in liters">

                            <label for="siphoning-evidence">Evidence Image:</label>
                            <input type="file" id="siphoning-evidence" accept="image/*">
                            <div id="siphoning-evidence-preview" class="evidence-preview hidden">
                                <img id="siphoning-evidence-img" src="" alt="Evidence Preview">
                            </div>

                            <label for="siphoning-notes">Notes:</label>
                            <textarea id="siphoning-notes" rows="3" placeholder="Additional notes..."></textarea>

                            <button type="submit">Save Record</button>
                        </form>
                    </div>
                </div>
            </section>

            <!-- B100 Jobs Section -->
            <section id="b100-jobs" class="content-section hidden">
                <h1>B100 Jobs Management</h1>
                <div class="b100-controls">
                    <input type="text" id="b100-search" placeholder="Search by Reference, Driver...">
                    <select id="b100-status-filter">
                        <option value="">All Statuses</option>
                        <option value="pending">Pending</option>
                        <option value="paid">Paid</option>
                        <option value="outstanding">Outstanding</option>
                    </select>
                    <button id="create-b100-btn">Create B100 Job</button>
                </div>
                <div class="table-container" style="margin-top: 20px;">
                    <table id="b100-jobs-table">
                        <thead>
                            <tr>
                                <th>Reference</th>
                                <th>Driver</th>
                                <th>Date</th>
                                <th>Vehicle</th>
                                <th>Amount (‡∏ø)</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <!-- B100 Job Create Modal -->
                <div id="b100-modal" class="modal hidden">
                    <div class="modal-content">
                        <span class="close-button" id="b100-modal-close">&times;</span>
                        <h2>Create B100 Job</h2>
                        <form id="b100-form">
                            <input type="hidden" id="b100-job-id">

                            <label for="b100-reference">Reference:</label>
                            <input type="text" id="b100-reference" required placeholder="Auto-generated" readonly style="background-color: #444; cursor: not-allowed;">

                            <label for="b100-driver">Driver:</label>
                            <select id="b100-driver" required>
                                <option value="">-- Select Driver --</option>
                            </select>

                            <label for="b100-vehicle">Vehicle Plate:</label>
                            <input type="text" id="b100-vehicle" required placeholder="e.g., ‡∏Å‡∏Ç-1234">

                            <label for="b100-origin">‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á (Origin):</label>
                            <select id="b100-origin" required>
                                <option value="">-- Select Origin --</option>
                            </select>

                            <label for="b100-destination">‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á (Destination):</label>
                            <select id="b100-destination" required>
                                <option value="">-- Select Destination --</option>
                            </select>

                            <label for="b100-materials">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Materials):</label>
                            <select id="b100-materials" required>
                                <option value="">-- Select Product --</option>
                                <option value="B100">B100</option>
                                <option value="‡πÑ‡∏ö‡πÇ‡∏≠‡∏î‡∏µ‡πÄ‡∏ã‡∏• B100">‡πÑ‡∏ö‡πÇ‡∏≠‡∏î‡∏µ‡πÄ‡∏ã‡∏• B100</option>
                                <option value="‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏õ‡∏≤‡∏•‡πå‡∏°">‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏õ‡∏≤‡∏•‡πå‡∏°</option>
                                <option value="Other">Other</option>
                            </select>

                            <label for="b100-quantity">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (Liters):</label>
                            <input type="number" id="b100-quantity" step="0.01" min="0" required placeholder="Enter quantity in liters">

                            <label for="b100-amount">B100 Amount (‡∏ø):</label>
                            <input type="number" id="b100-amount" step="0.01" min="0" required placeholder="Enter amount in Baht">

                            <label for="b100-notes">Notes:</label>
                            <textarea id="b100-notes" rows="3" placeholder="Additional notes..."></textarea>

                            <button type="submit">Create B100 Job</button>
                        </form>
                    </div>
                </div>
            </section>

            <!-- B100 Outstanding Section -->
            <section id="b100-outstanding" class="content-section hidden">
                <h1>B100 Outstanding Summary</h1>

                <!-- Summary Cards -->
                <div class="b100-summary-cards">
                    <div class="summary-card">
                        <h3>Total Outstanding Jobs</h3>
                        <p id="b100-total-jobs">0</p>
                    </div>
                    <div class="summary-card">
                        <h3>Total Outstanding Amount</h3>
                        <p id="b100-total-amount">‡∏ø0.00</p>
                    </div>
                    <div class="summary-card">
                        <h3>Drivers with Outstanding</h3>
                        <p id="b100-driver-count">0</p>
                    </div>
                </div>

                <!-- Outstanding by Driver Table -->
                <div class="table-container" style="margin-top: 20px;">
                    <h3>Outstanding by Driver</h3>
                    <table id="b100-outstanding-table">
                        <thead>
                            <tr>
                                <th>Driver</th>
                                <th>Outstanding Jobs</th>
                                <th>Total Amount (‡∏ø)</th>
                                <th>Last Job Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <!-- Driver Outstanding Detail Modal -->
                <div id="b100-detail-modal" class="modal hidden">
                    <div class="modal-content large-modal">
                        <span class="close-button" id="b100-detail-modal-close">&times;</span>
                        <h2>Outstanding Jobs: <span id="b100-detail-driver-name"></span></h2>
                        <div class="table-container">
                            <table id="b100-detail-table">
                                <thead>
                                    <tr>
                                        <th>Reference</th>
                                        <th>Date</th>
                                        <th>Amount (‡∏ø)</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div class="b100-detail-summary" style="margin-top: 15px; text-align: right;">
                            <strong>Total: ‡∏ø<span id="b100-detail-total">0.00</span></strong>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Logistics Performance Section -->
            <section id="logistics-performance" class="content-section">
                <h1>üìä Logistics Performance Report</h1>
                
                <!-- Date Range Filter -->
                <div class="filter-bar" style="margin-bottom: 20px; background: var(--card-bg); padding: 15px; border-radius: 8px;">
                    <div style="display: flex; gap: 15px; align-items: end; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <label for="perf-start-date">Start Date:</label>
                            <input type="date" id="perf-start-date" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid var(--border-color); background-color: #333; color: var(--text-color);">
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <label for="perf-end-date">End Date:</label>
                            <input type="date" id="perf-end-date" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid var(--border-color); background-color: #333; color: var(--text-color);">
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <label for="perf-vehicle-filter">Vehicle:</label>
                            <select id="perf-vehicle-filter" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid var(--border-color); background-color: #333; color: var(--text-color);">
                                <option value="">All Vehicles</option>
                            </select>
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <label for="perf-driver-filter">Driver:</label>
                            <select id="perf-driver-filter" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid var(--border-color); background-color: #333; color: var(--text-color);">
                                <option value="">All Drivers</option>
                            </select>
                        </div>
                        <button id="perf-load-btn" class="btn btn-primary" style="padding: 8px 20px;">Load Report</button>
                        <button id="perf-export-btn" class="btn btn-secondary" style="padding: 8px 20px;">üì• Export Excel</button>
                    </div>
                </div>

                <!-- KPI Summary Cards -->
                <div class="kpi-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div class="kpi-card">
                        <h3>Total Trips</h3>
                        <p id="perf-total-trips" style="font-size: 2em; font-weight: bold; color: #4CAF50;">0</p>
                        <small id="perf-trips-trend" style="color: #888;">-</small>
                    </div>
                    <div class="kpi-card">
                        <h3>On-Time Delivery</h3>
                        <p id="perf-on-time-rate" style="font-size: 2em; font-weight: bold; color: #2196F3;">0%</p>
                        <small id="perf-on-time-trend" style="color: #888;">-</small>
                    </div>
                    <div class="kpi-card">
                        <h3>Avg Trip Time</h3>
                        <p id="perf-avg-trip-time" style="font-size: 2em; font-weight: bold; color: #FF9800;">0h</p>
                        <small id="perf-time-trend" style="color: #888;">-</small>
                    </div>
                    <div class="kpi-card">
                        <h3>Total Distance</h3>
                        <p id="perf-total-distance" style="font-size: 2em; font-weight: bold; color: #9C27B0;">0 km</p>
                        <small id="perf-distance-trend" style="color: #888;">-</small>
                    </div>
                    <div class="kpi-card">
                        <h3>Fuel Efficiency</h3>
                        <p id="perf-fuel-efficiency" style="font-size: 2em; font-weight: bold; color: #00BCD4;">- km/L</p>
                        <small id="perf-fuel-trend" style="color: #888;">-</small>
                    </div>
                    <div class="kpi-card">
                        <h3>Vehicle Utilization</h3>
                        <p id="perf-utilization" style="font-size: 2em; font-weight: bold; color: #E91E63;">0%</p>
                        <small id="perf-util-trend" style="color: #888;">-</small>
                    </div>
                </div>

                <!-- Charts Section -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 20px;">
                    <!-- Trips Trend Chart -->
                    <div class="chart-card" style="background: var(--card-bg); padding: 20px; border-radius: 8px;">
                        <h3>üìà Trip Trend (Last 30 Days)</h3>
                        <canvas id="trips-trend-chart" style="max-height: 300px;"></canvas>
                    </div>

                    <!-- On-Time Performance Chart -->
                    <div class="chart-card" style="background: var(--card-bg); padding: 20px; border-radius: 8px;">
                        <h3>üéØ On-Time vs Late Deliveries</h3>
                        <canvas id="on-time-chart" style="max-height: 300px;"></canvas>
                    </div>

                    <!-- Vehicle Performance Chart -->
                    <div class="chart-card" style="background: var(--card-bg); padding: 20px; border-radius: 8px;">
                        <h3>üöõ Top 10 Vehicles by Trips</h3>
                        <canvas id="vehicle-performance-chart" style="max-height: 300px;"></canvas>
                    </div>

                    <!-- Driver Performance Chart -->
                    <div class="chart-card" style="background: var(--card-bg); padding: 20px; border-radius: 8px;">
                        <h3>üë§ Top 10 Drivers by Trips</h3>
                        <canvas id="driver-performance-chart" style="max-height: 300px;"></canvas>
                    </div>
                </div>

                <!-- Performance Tables -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <!-- Vehicle Performance Table -->
                    <div class="table-container" style="background: var(--card-bg); padding: 20px; border-radius: 8px;">
                        <h3>üöõ Vehicle Performance Ranking</h3>
                        <table id="perf-vehicle-table" style="width: 100%; font-size: 0.9em;">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Vehicle</th>
                                    <th>Trips</th>
                                    <th>Distance (km)</th>
                                    <th>On-Time %</th>
                                    <th>Avg Time</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 20px; color: #888;">
                                        No data available. Please load report.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Driver Performance Table -->
                    <div class="table-container" style="background: var(--card-bg); padding: 20px; border-radius: 8px;">
                        <h3>üë§ Driver Performance Ranking</h3>
                        <table id="perf-driver-table" style="width: 100%; font-size: 0.9em;">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Driver</th>
                                    <th>Trips</th>
                                    <th>Distance (km)</th>
                                    <th>On-Time %</th>
                                    <th>Avg Time</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 20px; color: #888;">
                                        No data available. Please load report.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Route Analysis Table -->
                <div class="table-container" style="background: var(--card-bg); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3>üó∫Ô∏è Route Performance Analysis</h3>
                    <table id="perf-route-table" style="width: 100%;">
                        <thead>
                            <tr>
                                <th>Route</th>
                                <th>Trips</th>
                                <th>Avg Distance (km)</th>
                                <th>Avg Duration (h)</th>
                                <th>On-Time %</th>
                                <th>Success Rate</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 20px; color: #888;">
                                    No data available. Please load report.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Detailed Trip List -->
                <div class="table-container" style="background: var(--card-bg); padding: 20px; border-radius: 8px;">
                    <h3>üìã Detailed Trip List</h3>
                    <div style="margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                        <input type="text" id="perf-search" placeholder="Search by reference, vehicle, driver..." style="padding: 8px; border-radius: 5px; border: 1px solid var(--border-color); background-color: #333; color: var(--text-color); flex: 1; max-width: 400px;">
                        <span id="perf-trip-count" style="color: #888;">0 trips</span>
                    </div>
                    <div style="max-height: 500px; overflow-y: auto;">
                        <table id="perf-trips-table" style="width: 100%;">
                            <thead style="position: sticky; top: 0; background: var(--card-bg); z-index: 1;">
                                <tr>
                                    <th>Date</th>
                                    <th>Reference</th>
                                    <th>Vehicle</th>
                                    <th>Driver</th>
                                    <th>Route</th>
                                    <th>Distance (km)</th>
                                    <th>Duration</th>
                                    <th>Status</th>
                                    <th>On-Time</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="9" style="text-align: center; padding: 20px; color: #888;">
                                        No data available. Please load report.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Leaflet JS for map view -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <!-- Chart.js for performance charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>
    <!-- Admin App Logic -->
    <script type="module" src="admin.js"></script>
    <!-- Debug Import Logic -->
    <script type="module" src="debug-import.js"></script>
    <!-- Logistics Performance Logic -->
    <script type="module" src="logistics-performance.js"></script>
</body>
</html>
