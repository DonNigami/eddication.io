<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Debug Import - Test Single Row</title>
  <style>
    body {
      font-family: monospace;
      padding: 20px;
      background: #1e1e1e;
      color: #d4d4d4;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    h1 {
      color: #4ec9b0;
    }
    button {
      padding: 10px 20px;
      margin: 5px;
      background: #0e639c;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover {
      background: #1177bb;
    }
    pre {
      background: #252526;
      padding: 15px;
      border-radius: 5px;
      overflow-x: auto;
      border-left: 3px solid #4ec9b0;
    }
    .success { color: #4ec9b0; }
    .error { color: #f48771; }
    .warning { color: #dcdcaa; }
    .section {
      margin: 20px 0;
      padding: 15px;
      background: #252526;
      border-radius: 5px;
    }
    input, select {
      padding: 8px;
      margin: 5px;
      background: #3c3c3c;
      border: 1px solid #555;
      color: #d4d4d4;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç Debug Import Tool</h1>
    
    <div class="section">
      <h3>1. Fetch Data from Google Sheets</h3>
      <div style="margin-bottom: 10px;">
        <label style="display: block; margin-bottom: 5px; color: #4ec9b0;">Sheet ID:</label>
        <input type="text" id="sheetId" value="1iwPr3RSBUT4frRfyFJxW5C2qP-TPseEBW_80CDitbuE" style="width: 400px;">
      </div>
      <div style="margin-bottom: 10px;">
        <label style="display: block; margin-bottom: 5px; color: #4ec9b0;">Sheet Name:</label>
        <select id="sheetName" style="width: 250px; padding: 8px; font-size: 14px;">
          <option value="">Loading sheets...</option>
        </select>
        <button onclick="loadSheetNames()" style="padding: 8px 15px;">üîÑ Refresh Sheets</button>
      </div>
      <button onclick="fetchSheetData()">Fetch Sheet Data</button>
      <pre id="fetchResult">Waiting...</pre>
    </div>

    <div class="section">
      <h3>2. Check Database Schema</h3>
      <button onclick="checkSchema()">Check driver_jobs Columns</button>
      <pre id="schemaResult">Waiting...</pre>
    </div>

    <div class="section">
      <h3>3. Test Row Mapping</h3>
      <label>Select Row: <select id="rowSelect"></select></label>
      <button onclick="testMapping()">Test Mapping</button>
      <pre id="mappingResult">Waiting...</pre>
    </div>

    <div class="section">
      <h3>4. Test Single Insert</h3>
      <button onclick="testInsert()">Insert Selected Row</button>
      <pre id="insertResult">Waiting...</pre>
    </div>

    <div class="section">
      <h3>5. Import All Rows</h3>
      <div style="margin-bottom: 15px; background: #3c3c3c; padding: 15px; border-radius: 5px;">
        <label style="display: block; margin-bottom: 10px;">
          <input type="radio" name="importMode" value="upsert" checked>
          <strong style="color: #4ec9b0;">Upsert Mode</strong> - Update if reference exists, Insert if new
        </label>
        <label style="display: block;">
          <input type="radio" name="importMode" value="insert">
          <strong style="color: #dcdcaa;">Insert All Mode</strong> - Import every row (allow duplicate references)
        </label>
      </div>
      <button onclick="importAllRows()" style="background: #0e7490; font-weight: bold;">üì• Import ALL Rows</button>
      <button onclick="stopImport()" style="background: #991b1b;">‚èπ Stop Import</button>
      <div style="margin-top: 10px;">
        <label>
          <input type="checkbox" id="skipErrors" checked>
          Skip errors and continue
        </label>
      </div>
      <pre id="importAllResult">Waiting...</pre>
      <div id="progressBar" style="display: none; margin-top: 10px;">
        <div style="background: #3c3c3c; height: 30px; border-radius: 5px; overflow: hidden;">
          <div id="progressFill" style="background: linear-gradient(90deg, #0e7490, #06b6d4); height: 100%; width: 0%; transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;"></div>
        </div>
      </div>
    </div>

    <div class="section">
      <h3>6. Check Existing Data</h3>
      <button onclick="checkData()">List All Jobs</button>
      <pre id="dataResult">Waiting...</pre>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

    const SUPABASE_URL = 'https://myplpshpcordggbbtblg.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im15cGxwc2hwY29yZGdnYmJ0YmxnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0MDI2ODgsImV4cCI6MjA4Mzk3ODY4OH0.UC42xLgqSdqgaogHmyRpES_NMy5t1j7YhdEZVwWUsJ8';
    
    window.supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    window.sheetData = null;
    window.importStopped = false;
    window.availableSheets = [];

    function getSheetCSVUrl(sheetId, sheetName) {
      return `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
    }

    // Load available sheet names from Google Sheets
    window.loadSheetNames = async function() {
      const sheetId = document.getElementById('sheetId').value;
      const selectEl = document.getElementById('sheetName');
      
      selectEl.innerHTML = '<option value="">Loading...</option>';
      
      try {
        // Fetch the spreadsheet HTML page to extract sheet names
        const response = await fetch(`https://docs.google.com/spreadsheets/d/${sheetId}/edit`, {
          mode: 'cors',
          credentials: 'omit'
        });
        
        if (!response.ok) {
          throw new Error('Cannot access spreadsheet. Make sure it is public.');
        }
        
        const html = await response.text();
        
        // Extract sheet names from HTML (they're in the page as JSON data)
        // Look for sheet names in the format: "sheets":[{"properties":{"sheetId":...,"title":"SheetName"
        const sheetMatches = html.match(/"title":"([^"]+)"/g);
        
        if (!sheetMatches || sheetMatches.length === 0) {
          throw new Error('No sheets found. Try using Sheet1 or InputZoile30');
        }
        
        // Extract unique sheet names
        const sheets = [...new Set(
          sheetMatches
            .map(m => m.match(/"title":"([^"]+)"/)[1])
            .filter(name => 
              // Filter out non-sheet titles (keep reasonable sheet names)
              name.length < 50 && 
              !name.includes('http') && 
              !name.includes('www.')
            )
        )];
        
        window.availableSheets = sheets;
        
        // Populate select dropdown
        selectEl.innerHTML = '';
        
        // Find InputZoile30 and put it first (default)
        const defaultSheet = sheets.find(s => s === 'InputZoile30');
        if (defaultSheet) {
          const option = document.createElement('option');
          option.value = defaultSheet;
          option.text = `üìä ${defaultSheet} (Default)`;
          option.selected = true;
          selectEl.appendChild(option);
        }
        
        // Add rest of sheets
        sheets
          .filter(s => s !== 'InputZoile30')
          .forEach(sheetName => {
            const option = document.createElement('option');
            option.value = sheetName;
            option.text = sheetName;
            selectEl.appendChild(option);
          });
        
        if (sheets.length === 0) {
          selectEl.innerHTML = '<option value="InputZoile30">InputZoile30 (Default)</option>';
        }
        
        console.log('Available sheets:', sheets);
        
      } catch (error) {
        console.error('Error loading sheet names:', error);
        // Fallback to common sheet names
        selectEl.innerHTML = '
          <option value="InputZoile30" selected>InputZoile30 (Default)</option>
          <option value="Sheet1">Sheet1</option>
          <option value="Sheet2">Sheet2</option>
        ';
      }
    };

    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;

      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          result.push(current.trim().replace(/^"|"$/g, ''));
          current = '';
        } else {
          current += char;
        }
      }
      result.push(current.trim().replace(/^"|"$/g, ''));
      return result;
    }

    function parseCSV(csvText) {
      const lines = csvText.split('\n').filter(line => line.trim());
      const headers = parseCSVLine(lines[0]);
      const data = [];

      for (let i = 1; i < lines.length; i++) {
        const values = parseCSVLine(lines[i]);
        const row = {};
        headers.forEach((header, index) => {
          row[header] = values[index] || '';
        });
        data.push(row);
      }

      return { headers, data };
    }

    function convertDateFormat(dateStr) {
      if (!dateStr || dateStr.trim() === '') return null;
      
      dateStr = dateStr.trim();
      
      // Already in YYYY-MM-DD format
      if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
        return dateStr;
      }
      
      // Convert DD/MM/YYYY to YYYY-MM-DD
      if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dateStr)) {
        const [day, month, year] = dateStr.split('/');
        const converted = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
        console.log(`Date converted: ${dateStr} ‚Üí ${converted}`);
        return converted;
      }
      
      // Convert DD.MM.YYYY to YYYY-MM-DD
      if (/^\d{1,2}\.\d{1,2}\.\d{4}$/.test(dateStr)) {
        const [day, month, year] = dateStr.split('.');
        const converted = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
        console.log(`Date converted: ${dateStr} ‚Üí ${converted}`);
        return converted;
      }
      
      // Try parsing with Date object
      try {
        const date = new Date(dateStr);
        if (!isNaN(date.getTime())) {
          const converted = date.toISOString().split('T')[0];
          console.log(`Date parsed: ${dateStr} ‚Üí ${converted}`);
          return converted;
        }
      } catch (e) {
        console.warn('Failed to parse date:', dateStr, e);
      }
      
      console.warn('Date format not recognized:', dateStr);
      return null;
    }

    // Map row to database format with ALL columns
    function mapRowToDatabase(row) {
      const mapped = {
        status: 'pending',
        created_at: new Date().toISOString(),
        updated_at: new Date().toISOString()
      };

      // Column mapping
      const columnMapping = {
        'Shipment No.': 'shipment_no',
        'Reference': 'reference',
        'Sts': 'sts',
        'Sts Text': 'sts_text',
        'Vehicle': 'vehicle',
        'Vehicle Description': 'vehicle_desc',
        'Trip': 'trip',
        'Carrier': 'carrier',
        'Carrier Name': 'carrier_name',
        'Driver': 'driver',
        'Driver name': 'driver_name',
        'Route': 'route',
        'Distance': 'distance',
        'Distance UOM': 'distance_uom',
        'Scheduling end': 'scheduling_end',
        'Planned load start (Date)': 'planned_load_start_date',
        'Planned load start (Time)': 'planned_load_start_time',
        'Actual load start (Date)': 'actual_load_start_date',
        'Actual load start (Time)': 'actual_load_start_time',
        'Actual load end (Date)': 'actual_load_end_date',
        'Actual load end (Time)': 'actual_load_end_time',
        'Actual del.conf.end (Date)': 'actual_del_conf_end_date',
        'Transport Plan Pt': 'transport_plan_pt',
        'Transport Plan Pt Desc': 'transport_plan_pt_desc',
        'Shipment Type': 'shipment_type',
        'Shipment Type Desc': 'shipment_type_desc',
        'ShpCosting': 'shp_costing',
        'ShpCostSettl': 'shp_cost_settl',
        'Shipment Item': 'shipment_item',
        'Delivery': 'delivery',
        'Ship to': 'ship_to',
        'Ship to Name': 'ship_to_name',
        'Ship to Address': 'ship_to_address',
        'Street 5': 'street_5',
        'Receiving plant': 'receiving_plant',
        'Del Date': 'del_date',
        'Delivery Item': 'delivery_item',
        'Material': 'material',
        'Material Desc': 'material_desc',
        'Delivery Qty': 'delivery_qty',
        'Delivery UOM': 'delivery_uom',
        'Order': 'order_no',
        'Billing Doc': 'billing_doc',
        'Canceled': 'canceled',
        // Additional possible date columns
        'Actual del.conf.end (Time)': 'actual_del_conf_end_time'
      };

      // Map all columns
      Object.entries(columnMapping).forEach(([sheetCol, dbCol]) => {
        if (row[sheetCol] !== undefined && row[sheetCol] !== '') {
          let value = row[sheetCol];
          const originalValue = value;

          // Type conversions
          if (dbCol === 'distance' || dbCol === 'delivery_qty') {
            value = parseFloat(value) || null;
          } else if (dbCol.includes('_date') && value) {
            // Convert date format
            value = convertDateFormat(value);
            if (value === null) {
              console.warn(`Failed to convert date for ${dbCol} (${sheetCol}):`, originalValue);
            } else {
              console.log(`‚úì Converted ${dbCol}: ${originalValue} ‚Üí ${value}`);
            }
          } else if (dbCol === 'scheduling_end' && value) {
            // scheduling_end might be a date too
            if (/\d{1,2}\/\d{1,2}\/\d{4}/.test(value)) {
              const converted = convertDateFormat(value);
              if (converted) {
                value = converted + 'T00:00:00Z'; // Make it a timestamp
                console.log(`‚úì Converted scheduling_end: ${originalValue} ‚Üí ${value}`);
              }
            }
          } else if (dbCol.includes('_time') && value) {
            value = value.trim() || null;
          } else if (dbCol === 'canceled') {
            value = value.toLowerCase() === 'true' || value === '1' || value.toLowerCase() === 'x';
          }

          // Only set if value is not null
          if (value !== null && value !== undefined) {
            mapped[dbCol] = value;
          }
        }
      });

      // IMPORTANT: Check if any unmapped columns contain dates
      Object.entries(row).forEach(([sheetCol, value]) => {
        if (value && typeof value === 'string' && /\d{1,2}\/\d{1,2}\/\d{4}/.test(value)) {
          if (!columnMapping[sheetCol]) {
            console.warn(`‚ö†Ô∏è Unmapped column with date format: "${sheetCol}" = "${value}"`);
          }
        }
      });

      // Ensure reference exists
      if (!mapped.reference && mapped.shipment_no) {
        mapped.reference = mapped.shipment_no;
      }

      // Set drivers field
      if (!mapped.drivers && mapped.driver_name) {
        mapped.drivers = mapped.driver_name;
      }

      return mapped;
    }

    window.fetchSheetData = async function() {
      const result = document.getElementById('fetchResult');
      result.innerHTML = '<span class="warning">Fetching...</span>';
      
      try {
        const sheetId = document.getElementById('sheetId').value;
        const sheetName = document.getElementById('sheetName').value;
        
        if (!sheetName) {
          throw new Error('Please select a sheet name');
        }
        
        const url = getSheetCSVUrl(sheetId, sheetName);
        
        const response = await fetch(url);
        if (!response.ok) throw new Error('Cannot access sheet');
        
        const csvText = await response.text();
        const { headers, data } = parseCSV(csvText);
        
        window.sheetData = { headers, data };
        
        // Populate row select
        const rowSelect = document.getElementById('rowSelect');
        rowSelect.innerHTML = '';
        data.forEach((row, i) => {
          const option = document.createElement('option');
          option.value = i;
          option.text = `Row ${i + 2}: ${row['Shipment No.'] || row['Reference'] || 'No ID'}`;
          rowSelect.appendChild(option);
        });
        
        result.innerHTML = `<span class="success">‚úì Success!</span>\n\n` +
          `Total Rows: ${data.length}\n` +
          `Columns: ${headers.length}\n\n` +
          `Headers:\n${JSON.stringify(headers, null, 2)}`;
      } catch (error) {
        result.innerHTML = `<span class="error">‚úó Error:</span>\n${error.message}\n${error.stack}`;
      }
    };

    window.checkSchema = async function() {
      const result = document.getElementById('schemaResult');
      result.innerHTML = '<span class="warning">Checking...</span>';
      
      try {
        const { data, error } = await supabase
          .from('driver_jobs')
          .select('*')
          .limit(1);
        
        if (error) throw error;
        
        const columns = data.length > 0 ? Object.keys(data[0]) : [];
        
        result.innerHTML = `<span class="success">‚úì Table exists!</span>\n\n` +
          `Columns (${columns.length}):\n${JSON.stringify(columns, null, 2)}`;
      } catch (error) {
        result.innerHTML = `<span class="error">‚úó Error:</span>\n${error.message}\n\n` +
          `Details: ${JSON.stringify(error, null, 2)}`;
      }
    };

    window.testMapping = function() {
      const result = document.getElementById('mappingResult');
      
      if (!window.sheetData) {
        result.innerHTML = '<span class="error">‚úó Please fetch sheet data first!</span>';
        return;
      }
      
      const rowIndex = parseInt(document.getElementById('rowSelect').value);
      const row = window.sheetData.data[rowIndex];
      
      const mapped = mapRowToDatabase(row);
      
      result.innerHTML = `<span class="success">‚úì Mapped!</span>\n\n` +
        `Original Row (first 5 fields):\n${JSON.stringify(Object.fromEntries(Object.entries(row).slice(0, 5)), null, 2)}\n\n` +
        `Mapped Data:\n${JSON.stringify(mapped, null, 2)}`;
      
      window.testMappedData = mapped;
    };

    window.testInsert = async function() {
      const result = document.getElementById('insertResult');
      
      if (!window.testMappedData) {
        result.innerHTML = '<span class="error">‚úó Please test mapping first!</span>';
        return;
      }
      
      result.innerHTML = '<span class="warning">Inserting...</span>';
      
      console.log('=== TEST INSERT ===');
      console.log('Mapped data:', window.testMappedData);
      
      // Check ALL fields for date formats that aren't converted
      const problematicFields = [];
      Object.entries(window.testMappedData).forEach(([key, value]) => {
        if (value && typeof value === 'string') {
          // Check if value looks like a date in DD/MM/YYYY format
          if (/\d{1,2}\/\d{1,2}\/\d{4}/.test(value)) {
            problematicFields.push({ field: key, value: value });
            console.error(`‚ùå UNCONVERTED DATE FOUND: ${key} = "${value}"`);
          }
        }
      });
      
      if (problematicFields.length > 0) {
        result.innerHTML = `<span class="error">‚ùå Found unconverted dates!</span>\n\n` +
          `These fields still have DD/MM/YYYY format:\n` +
          problematicFields.map(f => `- ${f.field}: "${f.value}"`).join('\n') + 
          `\n\nPlease check the column mapping and convert these fields.`;
        return;
      }
      
      // Check for date fields
      const dateFields = Object.entries(window.testMappedData)
        .filter(([key, value]) => key.includes('_date') && value);
      
      console.log('Date fields:', dateFields);
      
      try {
        const { data, error } = await supabase
          .from('driver_jobs')
          .upsert(window.testMappedData, { 
            onConflict: 'reference'
          })
          .select();
        
        if (error) throw error;
        
        result.innerHTML = `<span class="success">‚úì Insert Success!</span>\n\n` +
          `Inserted Data:\n${JSON.stringify(data, null, 2)}`;
      } catch (error) {
        console.error('Insert error:', error);
        result.innerHTML = `<span class="error">‚úó Insert Failed!</span>\n\n` +
          `Error Message: ${error.message}\n\n` +
          `Error Code: ${error.code}\n\n` +
          `Error Details:\n${JSON.stringify(error, null, 2)}\n\n` +
          `Data Attempted:\n${JSON.stringify(window.testMappedData, null, 2)}`;
      }
    };

    window.checkData = async function() {
      const result = document.getElementById('dataResult');
      result.innerHTML = '<span class="warning">Loading...</span>';
      
      try {
        const { data, error } = await supabase
          .from('driver_jobs')
          .select('id, reference, shipment_no, vehicle_desc, driver_name, delivery, material')
          .order('created_at', { ascending: false })
          .limit(10);
        
        if (error) throw error;
        
        result.innerHTML = `<span class="success">‚úì Found ${data.length} rows!</span>\n\n` +
          JSON.stringify(data, null, 2);
      } catch (error) {
        result.innerHTML = `<span class="error">‚úó Error:</span>\n${error.message}\n\n` +
          JSON.stringify(error, null, 2);
      }
    };

    window.importAllRows = async function() {
      const result = document.getElementById('importAllResult');
      const progressBar = document.getElementById('progressBar');
      const progressFill = document.getElementById('progressFill');
      const skipErrors = document.getElementById('skipErrors').checked;
      const importMode = document.querySelector('input[name="importMode"]:checked').value;
      
      if (!window.sheetData) {
        result.innerHTML = '<span class="error">‚úó Please fetch sheet data first!</span>';
        return;
      }
      
      window.importStopped = false;
      progressBar.style.display = 'block';
      
      const data = window.sheetData.data;
      const stats = {
        total: data.length,
        success: 0,
        failed: 0,
        skipped: 0,
        errors: []
      };
      
      const modeText = importMode === 'upsert' ? 'Upsert' : 'Insert All';
      result.innerHTML = `<span class="warning">‚è≥ Importing ${data.length} rows (${modeText} mode)...</span>\n\n`;
      
      for (let i = 0; i < data.length; i++) {
        if (window.importStopped) {
          result.innerHTML += `\n<span class="warning">‚èπ Import stopped by user at row ${i + 2}</span>`;
          break;
        }
        
        try {
          const row = data[i];
          const mapped = mapRowToDatabase(row);
          
          // Check for unconverted dates (warning only, don't stop)
          const unconvertedDates = [];
          Object.entries(mapped).forEach(([key, value]) => {
            if (value && typeof value === 'string' && /\d{1,2}\/\d{1,2}\/\d{4}/.test(value)) {
              unconvertedDates.push({ field: key, value: value });
              // Convert it now instead of failing
              const converted = convertDateFormat(value);
              if (converted) {
                mapped[key] = converted;
              }
            }
          });
          
          if (unconvertedDates.length > 0) {
            console.warn(`Row ${i + 2}: Unconverted dates found and fixed:`, unconvertedDates);
          }
          
          // Auto-generate reference if missing
          if (!mapped.reference) {
            // Try to use shipment_no
            if (mapped.shipment_no) {
              mapped.reference = mapped.shipment_no;
            } else {
              // Use row number as reference
              mapped.reference = `ROW-${i + 2}`;
              console.log(`Generated reference for row ${i + 2}: ${mapped.reference}`);
            }
          }
          
          let insertData, error;
          
          if (importMode === 'upsert') {
            // Upsert mode - update if exists, insert if new
            ({ data: insertData, error } = await supabase
              .from('driver_jobs')
              .upsert(mapped, { 
                onConflict: 'reference'
              })
              .select());
          } else {
            // Insert all mode - insert every row using original reference
            const insertPayload = { ...mapped };
            
            ({ data: insertData, error } = await supabase
              .from('driver_jobs')
              .insert(insertPayload)
              .select());
          }
          
          if (error) throw error;
          
          stats.success++;
          
        } catch (error) {
          stats.failed++;
          const errorMsg = error.message || String(error);
          const errorDetail = `Row ${i + 2} (${row['Reference'] || row['Shipment No.'] || 'Unknown'}): ${errorMsg}`;
          stats.errors.push(errorDetail);
          console.error(errorDetail, error);
          
          // Always continue to next row (skipErrors is always on for importing all rows)
          // Don't stop import even if skipErrors is unchecked
        }
        
        // Update progress
        const progress = ((i + 1) / data.length) * 100;
        progressFill.style.width = `${progress}%`;
        progressFill.textContent = `${Math.round(progress)}%`;
        
        // Update result every 10 rows
        if ((i + 1) % 10 === 0 || i === data.length - 1) {
          result.innerHTML = `<span class="warning">‚è≥ Importing (${modeText})...</span>\n\n` +
            `Progress: ${i + 1}/${data.length}\n` +
            `Success: ${stats.success}\n` +
            `Failed: ${stats.failed}\n` +
            (stats.skipped > 0 ? `Skipped: ${stats.skipped}\n` : '');
        }
      }
      
      // Final result
      const summaryStats = `Total: ${stats.total}\nSuccess: ${stats.success}\nFailed: ${stats.failed}` +
        (stats.skipped > 0 ? `\nSkipped: ${stats.skipped}` : '');
      
      if (stats.failed === 0 && stats.skipped === 0) {
        result.innerHTML = `<span class="success">‚úì Import Complete!</span>\n\n` + summaryStats;
      } else {
        result.innerHTML = `<span class="warning">‚ö† Import Complete with Issues</span>\n\n` +
          summaryStats + `\n\n` +
          `Errors (first 20):\n${stats.errors.slice(0, 20).join('\n')}\n` +
          (stats.errors.length > 20 ? `\n...and ${stats.errors.length - 20} more` : '');
      }
      
      progressFill.style.width = '100%';
      progressFill.textContent = '100%';
    };

    window.stopImport = function() {
      window.importStopped = true;
      document.getElementById('importAllResult').innerHTML += '\n<span class="warning">‚èπ Stopping import...</span>';
    };

    // Auto-load sheet names on page load
    setTimeout(async () => {
      document.getElementById('fetchResult').innerHTML = '<span class="warning">Loading sheet names...</span>';
      await loadSheetNames();
      document.getElementById('fetchResult').innerHTML = '<span class="warning">Ready! Click "Fetch Sheet Data" to start</span>';
    }, 500);
  </script>
</body>
</html>