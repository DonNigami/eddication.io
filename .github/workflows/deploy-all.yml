name: Deploy All Apps to GitHub Pages

on:
  # Runs on pushes targeting the default branch
  push:
    branches: ["main"]
    paths:
      - 'PTGLG/driverconnect/**'
      - 'project/line/clinic-connect-saas/**'
      - '.github/workflows/deploy-all.yml'

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      # Build clinic-connect-saas LIFF apps only (web app has build issues)
      - name: Build Clinic Connect LIFF apps
        working-directory: ./project/line/clinic-connect-saas
        run: |
          pnpm install --frozen-lockfile
          # Build LIFF apps directly, skipping the web app
          cd apps/liff-patient && pnpm build
          cd ../liff-doctor && pnpm build

      # Copy full directory structure
      - name: Create deployment structure
        run: |
          mkdir -p deploy-pages
          # Preserve full directory structure
          cp -r PTGLG deploy-pages/
          cp -r project deploy-pages/

      # Create index page with links to all apps
      - name: Create index page
        run: |
          cat > deploy-pages/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="th">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Eddication.io - Apps</title>
            <style>
              * { box-sizing: border-box; margin: 0; padding: 0; }
              body {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                min-height: 100vh;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
              }
              .container {
                max-width: 600px;
                width: 100%;
              }
              h1 {
                color: #fff;
                text-align: center;
                margin-bottom: 30px;
                font-size: 2rem;
              }
              .app-grid {
                display: grid;
                gap: 20px;
              }
              .app-card {
                background: rgba(255,255,255,0.1);
                backdrop-filter: blur(10px);
                border-radius: 16px;
                padding: 24px;
                text-decoration: none;
                color: #fff;
                transition: transform 0.2s, background 0.2s;
                border: 1px solid rgba(255,255,255,0.1);
              }
              .app-card:hover {
                transform: translateY(-4px);
                background: rgba(255,255,255,0.15);
              }
              .app-card h2 {
                font-size: 1.5rem;
                margin-bottom: 8px;
                display: flex;
                align-items: center;
                gap: 12px;
              }
              .app-card p {
                opacity: 0.7;
                font-size: 0.95rem;
              }
            </style>
          </head>
          <body>
            <div class="container">
              <h1>Eddication.io Applications</h1>
              <div class="app-grid">
                <a href="/PTGLG/driverconnect/driverapp/index-supabase-modular.html" class="app-card">
                  <h2>üöö DriverConnect</h2>
                  <p>Driver Tracking & Delivery Management System</p>
                </a>
                <a href="/project/line/clinic-connect-saas/apps/" class="app-card">
                  <h2>üè• Clinic Connect</h2>
                  <p>Clinic Management SaaS Platform</p>
                </a>
                <a href="/project/line/clinic-connect-saas/apps/liff-doctor/" class="app-card">
                  <h2>üë®‚Äç‚öïÔ∏è LIFF Doctor</h2>
                  <p>Doctor LIFF Application</p>
                </a>
                <a href="/project/line/clinic-connect-saas/apps/liff-patient/" class="app-card">
                  <h2>üë§ LIFF Patient</h2>
                  <p>Patient Registration & Management</p>
                </a>
              </div>
            </div>
          </body>
          </html>
          EOF

      - name: List deployed files
        run: |
          echo "=== Deployment Structure ==="
          ls -la deploy-pages/
          echo ""
          echo "=== PTGLG ==="
          ls deploy-pages/PTGLG/ 2>/dev/null | head -5
          echo ""
          echo "=== project/line/clinic-connect-saas/apps ==="
          ls deploy-pages/project/line/clinic-connect-saas/apps/ 2>/dev/null | head -10
          echo ""
          echo "=== Checking dist folders ==="
          ls deploy-pages/project/line/clinic-connect-saas/apps/liff-patient/dist/ 2>/dev/null | head -5 || echo "liff-patient/dist not found"
          ls deploy-pages/project/line/clinic-connect-saas/apps/liff-doctor/dist/ 2>/dev/null | head -5 || echo "liff-doctor/dist not found"

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'deploy-pages'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
