<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="UTF-8">
    <title>LINE OA Broadcast Studio Enterprise</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <!-- Google Picker (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å Drive) -->
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: #f5f5f7;
        margin: 0;
        padding: 24px;
      }

      .container {
        max-width: 960px;
        margin: 0 auto;
        background: #ffffff;
        border-radius: 16px;
        padding: 24px 28px 28px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.06);
      }

      h1 {
        margin-top: 0;
        font-size: 22px;
        text-align: center;
      }

      .section-title {
        font-weight: 600;
        margin-top: 16px;
        margin-bottom: 8px;
      }

      textarea {
        width: 100%;
        min-height: 120px;
        padding: 10px 12px;
        font-size: 14px;
        border-radius: 8px;
        border: 1px solid #d0d0d5;
        box-sizing: border-box;
        resize: vertical;
      }

      input[type="url"],
      input[type="text"],
      input[type="datetime-local"],
      select {
        width: 100%;
        padding: 8px 10px;
        font-size: 14px;
        border-radius: 8px;
        border: 1px solid #d0d0d5;
        box-sizing: border-box;
      }

      .image-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 8px 16px;
      }

      .image-item {
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 8px;
        background: #fafafa;
      }

      .image-item label {
        font-size: 12px;
        color: #555;
      }

      .image-actions {
        display: flex;
        gap: 6px;
        margin-top: 4px;
        flex-wrap: wrap;
      }

      .image-local-preview {
        margin-top: 6px;
        display: flex;
        justify-content: center;
      }

      .image-local-preview img {
        max-width: 100%;
        max-height: 120px;
        border-radius: 8px;
        object-fit: cover;
      }

      .radio-group {
        display: flex;
        gap: 16px;
        margin: 8px 0 6px;
        align-items: center;
        flex-wrap: wrap;
      }

      .row-inline {
        display: flex;
        gap: 12px;
        align-items: flex-start;
      }

      .row-inline > div {
        flex: 1;
      }

      .hint {
        font-size: 12px;
        color: #777;
        margin-top: 4px;
      }

      .btn {
        border: none;
        border-radius: 999px;
        padding: 8px 18px;
        font-size: 13px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        white-space: nowrap;
      }

      .btn-primary {
        background: #06c755;
        color: #fff;
      }

      .btn-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .btn-secondary {
        background: #e5e7eb;
        color: #111827;
      }

      .btn-small {
        border-radius: 999px;
        padding: 4px 10px;
        font-size: 11px;
      }

      .btn-danger {
        background: #fee2e2;
        color: #b91c1c;
      }

      .btn-ghost {
        background: transparent;
        border: 1px solid #d1d5db;
        color: #374151;
      }

      .status-bar {
        margin-top: 12px;
        font-size: 13px;
      }

      .status-bar span {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 999px;
      }

      .status-ok {
        background: #e7f7ee;
        color: #137d3b;
      }

      .status-error {
        background: #fde8e8;
        color: #b91c1c;
      }

      .tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
        border-bottom: 1px solid #e5e7eb;
        flex-wrap: wrap;
      }

      .tab-btn {
        border: none;
        background: transparent;
        padding: 8px 16px 10px;
        font-size: 13px;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        color: #6b7280;
      }

      .tab-btn.active {
        color: #111827;
        border-bottom-color: #06c755;
        font-weight: 600;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 10px;
        text-transform: uppercase;
      }

      .pill-pending {
        background: #fef3c7;
        color: #92400e;
      }

      .pill-sent {
        background: #e7f7ee;
        color: #166534;
      }

      .pill-error {
        background: #fee2e2;
        color: #b91c1c;
      }

      .pill-cancelled {
        background: #e5e7eb;
        color: #4b5563;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        font-size: 12px;
      }

      thead {
        background: #f3f4f6;
      }

      th, td {
        padding: 6px 8px;
        border-bottom: 1px solid #e5e7eb;
        vertical-align: top;
      }

      th {
        text-align: left;
        font-weight: 600;
        font-size: 11px;
        color: #4b5563;
      }

      tbody tr:nth-child(even) {
        background: #fafafa;
      }

      .text-muted {
        color: #6b7280;
      }

      .no-access {
        text-align: center;
        padding: 32px 16px;
      }

      .badge-mode {
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 999px;
        background: #e5e7eb;
        color: #374151;
        display: inline-block;
      }

      .log-preview {
        max-width: 220px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .text-preview {
        max-width: 260px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .preview-wrapper {
        margin-top: 8px;
        display: flex;
        justify-content: center;
      }

      .phone-frame {
        width: 260px;
        border-radius: 24px;
        border: 1px solid #e5e7eb;
        padding: 10px;
        background: #f3f4f6;
        box-shadow: inset 0 0 0 1px rgba(255,255,255,0.5);
      }

      .phone-header {
        display: flex;
        justify-content: center;
        gap: 4px;
        margin-bottom: 6px;
      }

      .phone-dot {
        width: 4px;
        height: 4px;
        border-radius: 999px;
        background: #d1d5db;
      }

      .bubble {
        background: #ffffff;
        border-radius: 16px;
        padding: 8px 10px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      }

      .preview-meta {
        font-size: 10px;
        color: #6b7280;
        margin-bottom: 6px;
        text-align: left;
      }

      .preview-text {
        font-size: 13px;
        margin-bottom: 6px;
        white-space: pre-wrap;
      }

      .image-grid-preview {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 4px;
      }

      .image-grid-preview img {
        width: 100%;
        border-radius: 8px;
        object-fit: cover;
        aspect-ratio: 1/1;
      }

      .template-row {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
      }

      .template-action-group {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
      }

      /* Token tab */
      .token-status-box {
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        padding: 12px 14px;
        background: #fafafa;
        margin-top: 8px;
      }

      .token-status-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
      }

      .token-status-summary {
        font-size: 14px;
        font-weight: 500;
      }

      .token-status-tag-ok {
        background: #e7f7ee;
        color: #166534;
      }

      .token-status-tag-expired {
        background: #fee2e2;
        color: #b91c1c;
      }

      .token-status-tag-none {
        background: #e5e7eb;
        color: #374151;
      }

      .token-status-tag {
        font-size: 11px;
        border-radius: 999px;
        padding: 2px 8px;
        display: inline-block;
      }

      .token-status-detail {
        font-size: 12px;
        color: #4b5563;
        margin-top: 6px;
        line-height: 1.5;
      }

      .token-status-error {
        font-size: 12px;
        color: #b91c1c;
        margin-top: 6px;
      }
    </style>
  </head>
  <body>
    <div class="container" id="appContainer">
      <h1>LINE OA Broadcast Studio Enterprise</h1>

      <div id="notAdminBox" class="no-access" style="display:none;">
        <p style="font-size:14px; margin-bottom:8px;">
          ‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Broadcast Studio
        </p>
        <p class="text-muted" style="font-size:12px;">
          ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏° LINE User ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏•‡∏á‡πÉ‡∏ô‡∏ä‡∏µ‡∏ó <b>Admin</b>
        </p>
      </div>

      <div id="appMain" style="display:none;">

        <div class="tabs">
          <button class="tab-btn active" id="tabSend" onclick="showTab('send')">‡∏™‡πà‡∏á Broadcast</button>
          <button class="tab-btn" id="tabHistory" onclick="showTab('history')">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á</button>
          <button class="tab-btn" id="tabSystem" onclick="showTab('system')">Token &amp; System</button>
        </div>

        <!-- TAB: ‡∏™‡πà‡∏á Broadcast -->
        <div id="tabSendPane">
          <div class="row-inline">
            <!-- ‡∏ã‡πâ‡∏≤‡∏¢: ‡∏ü‡∏≠‡∏£‡πå‡∏° -->
            <div style="flex:3; min-width:0;">

              <!-- Templates -->
              <div class="section">
                <div class="section-title">Template ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</div>
                <div class="template-row">
                  <div style="flex:1;">
                    <select id="templateSelect">
                      <option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï ‚Äî</option>
                    </select>
                    <div class="hint" id="templateHint">0 ‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï</div>
                  </div>
                  <div class="template-action-group">
                    <button class="btn btn-ghost btn-small" type="button" onclick="applySelectedTemplate()">
                      ‡πÉ‡∏ä‡πâ‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï
                    </button>
                    <button class="btn btn-secondary btn-small" type="button" onclick="saveAsNewTemplate()">
                      ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï‡πÉ‡∏´‡∏°‡πà
                    </button>
                    <button class="btn btn-secondary btn-small" type="button" onclick="updateCurrentTemplate()">
                      ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï‡∏ô‡∏µ‡πâ
                    </button>
                  </div>
                </div>
              </div>

              <div class="section">
                <div class="section-title">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Broadcast</div>
                <textarea id="message" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡∏ñ‡∏∂‡∏á‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÉ‡∏ô LINE OA"></textarea>
                <div class="hint">‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏î‡πâ ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏π‡∏õ</div>
              </div>

              <!-- Form ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Upload -->
              <form id="uploadForm" onsubmit="return false;">
                <div class="section">
                  <div class="section-title">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 10 ‡∏£‡∏π‡∏õ)</div>
                  <div class="hint">
                    ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ä‡πà‡∏≠‡∏á‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ: ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á / ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Drive / ‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
                  </div>
                  <div class="image-grid" id="imageGrid"></div>
                </div>
              </form>

              <div class="section">
                <div class="section-title">‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á</div>
                <div class="radio-group">
                  <label>
                    <input type="radio" name="sendMode" value="now" checked>
                    ‡∏™‡πà‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                  </label>
                  <label>
                    <input type="radio" name="sendMode" value="schedule">
                    ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤
                  </label>
                </div>
                <div class="row-inline">
                  <div>
                    <input type="datetime-local" id="scheduleAt">
                  </div>
                  <div style="flex:0 0 auto; font-size:12px; color:#666;">
                    *‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏¥‡∏á Timezone ‡∏Ç‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå Apps Script
                  </div>
                </div>
              </div>

              <div class="section">
                <div class="section-title">‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</div>
                <div class="radio-group">
                  <label>
                    <input type="radio" name="targetType" value="all" checked>
                    ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÉ‡∏ô OA
                  </label>
                  <label>
                    <input type="radio" name="targetType" value="test">
                    ‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö (‡∏™‡πà‡∏á‡∏´‡∏≤‡πÄ‡∏£‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
                  </label>
                </div>
                <div class="hint">
                  ‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏à‡∏∞‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏≤ LINE ID ‡∏Ç‡∏≠‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏ú‡πà‡∏≤‡∏ô LIFF ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
                </div>
              </div>

              <div class="section" style="margin-top: 18px;">
                <button class="btn btn-primary" id="btnSubmit" onclick="handleSubmit()">
                  üöÄ ‡∏™‡πà‡∏á Broadcast
                </button>
                <button class="btn btn-secondary" type="button" onclick="clearForm()">
                  ‚ú® ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
                </button>
              </div>

              <div class="status-bar" id="statusBar" style="display:none;">
                <span id="statusText"></span>
              </div>
            </div>

            <!-- ‡∏Ç‡∏ß‡∏≤: Preview -->
            <div style="flex:2; min-width:260px; margin-left:16px;">
              <div class="section-title">Preview (‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠)</div>
              <div class="preview-wrapper">
                <div class="phone-frame">
                  <div class="phone-header">
                    <div class="phone-dot"></div>
                    <div class="phone-dot"></div>
                    <div class="phone-dot"></div>
                  </div>
                  <div class="preview-meta" id="previewMeta">
                    ‡∏™‡πà‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ | ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÉ‡∏ô OA
                  </div>
                  <div class="bubble">
                    <div class="preview-text" id="previewText">(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°)</div>
                    <div class="image-grid-preview" id="previewImages"></div>
                  </div>
                </div>
              </div>
            </div>
          </div> <!-- row-inline -->
        </div>

        <!-- TAB: History -->
        <div id="tabHistoryPane" style="display:none;">
          <div class="section-title">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£ Broadcast ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
          <div class="hint">
            ‡πÅ‡∏™‡∏î‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î 50 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ | ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡∏£‡∏≠‡∏™‡πà‡∏á (pending) ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î‡∏™‡πà‡∏á‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ
          </div>

          <div style="margin-top:8px; margin-bottom:8px;">
            <button class="btn btn-ghost btn-small" type="button" onclick="loadHistory()">
              üîÑ ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏´‡∏°‡πà
            </button>
          </div>

          <table>
            <thead>
              <tr>
                <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
                <th>‡πÇ‡∏´‡∏°‡∏î</th>
                <th>‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</th>
                <th>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</th>
                <th>‡∏£‡∏π‡∏õ</th>
                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                <th>Log</th>
                <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
              </tr>
            </thead>
            <tbody id="historyBody">
              <tr><td colspan="8" class="text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>
            </tbody>
          </table>
        </div>

        <!-- TAB: Token & System -->
        <div id="tabSystemPane" style="display:none;">
          <div class="section-title">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ LINE Channel Access Token</div>
          <div class="hint">
            ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö debug ‡∏£‡∏∞‡∏ö‡∏ö token ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡∏à‡∏≤‡∏Å LINE (‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á token ‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢)
          </div>

          <div style="margin-top:8px; margin-bottom:8px; display:flex; gap:8px; flex-wrap:wrap;">
            <button class="btn btn-ghost btn-small" type="button" onclick="loadTokenStatus()">
              üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            </button>
            <button class="btn btn-danger btn-small" type="button" onclick="forceRefreshToken()">
              ‚ôªÔ∏è Force refresh token ‡πÉ‡∏´‡∏°‡πà
            </button>
          </div>

          <div class="token-status-box">
            <div class="token-status-header">
              <div class="token-status-summary" id="tokenStatusSummary">
                ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ token
              </div>
              <div>
                <span class="token-status-tag token-status-tag-none" id="tokenStatusTag">
                  UNKNOWN
                </span>
              </div>
            </div>
            <div class="token-status-detail" id="tokenStatusDetail">
              ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• token
            </div>
            <div class="token-status-error" id="tokenStatusError" style="display:none;"></div>
          </div>
        </div>

      </div>
    </div>

    <script>
      const LIFF_ID = '2007213966-G3n3wn8v';

      const PICKER_API_KEY   = 'YOUR_GOOGLE_PICKER_API_KEY';
      const PICKER_CLIENT_ID = 'YOUR_GOOGLE_PICKER_CLIENT_ID';

      let currentUser = null;
      let templatesList = [];
      let pickerInited = false;

      document.addEventListener('DOMContentLoaded', function () {
        initImageInputs();
        attachPreviewListeners();
        initLiff();
        initPickerApi();
      });

      function initImageInputs() {
        const grid = document.getElementById('imageGrid');
        for (let i = 1; i <= 10; i++) {
          const div = document.createElement('div');
          div.className = 'image-item';
          div.innerHTML = `
            <label>‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà ${i}</label>
            <input type="url" id="imageUrl${i}" placeholder="https://..." />
            <div class="image-actions">
              <button class="btn btn-ghost btn-small" type="button" onclick="triggerFileUpload(${i})">
                ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á
              </button>
              <button class="btn btn-ghost btn-small" type="button" onclick="openDrivePicker(${i})">
                ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Drive
              </button>
            </div>
            <input type="file" id="file${i}" name="file${i}" accept="image/*" style="display:none" />
            <div class="image-local-preview" id="localPreview${i}" style="display:none;">
              <img src="" alt="preview" />
            </div>
          `;
          grid.appendChild(div);
        }
      }

      function attachPreviewListeners() {
        document.getElementById('message').addEventListener('input', updatePreview);

        for (let i = 1; i <= 10; i++) {
          document.getElementById('imageUrl' + i).addEventListener('input', updatePreview);
          document.getElementById('file' + i).addEventListener('change', () => handleFileChange(i));
        }

        document.getElementById('scheduleAt').addEventListener('change', updatePreview);

        document.querySelectorAll('input[name="sendMode"]').forEach(r => {
          r.addEventListener('change', updatePreview);
        });
        document.querySelectorAll('input[name="targetType"]').forEach(r => {
          r.addEventListener('change', updatePreview);
        });

        updatePreview();
      }

      function initLiff() {
        liff.init({ liffId: LIFF_ID })
          .then(() => {
            if (!liff.isLoggedIn()) {
              liff.login();
              return;
            }
            return liff.getProfile();
          })
          .then(profile => {
            if (!profile) return;
            currentUser = {
              lineUserId: profile.userId,
              displayName: profile.displayName,
              pictureUrl: profile.pictureUrl
            };

            const container = document.getElementById('appContainer');
            container.insertAdjacentHTML('afterbegin',
              `<div style="font-size:11px; color:#6b7280; text-align:right; margin-bottom:6px;">
                Login: ${escapeHtml(currentUser.displayName)}
              </div>`
            );

            google.script.run
              .withSuccessHandler(function (res) {
                if (res && res.ok) {
                  document.getElementById('notAdminBox').style.display = 'none';
                  document.getElementById('appMain').style.display = 'block';
                  loadHistory();
                  loadTemplates();
                  updatePreview();
                } else {
                  document.getElementById('notAdminBox').style.display = 'block';
                  document.getElementById('appMain').style.display = 'none';
                }
              })
              .withFailureHandler(function () {
                document.getElementById('notAdminBox').style.display = 'block';
                document.getElementById('appMain').style.display = 'none';
              })
              .isAdminByLineUserId(currentUser.lineUserId);
          })
          .catch(err => {
            console.error('LIFF error', err);
            document.getElementById('notAdminBox').style.display = 'block';
            document.getElementById('appMain').style.display = 'none';
          });
      }

      function initPickerApi() {
        gapi.load('picker', () => {
          pickerInited = true;
        });
      }

      // -------- Tabs ----------
      function showTab(tab) {
        const sendPane = document.getElementById('tabSendPane');
        const historyPane = document.getElementById('tabHistoryPane');
        const systemPane = document.getElementById('tabSystemPane');

        const tabSend = document.getElementById('tabSend');
        const tabHistory = document.getElementById('tabHistory');
        const tabSystem = document.getElementById('tabSystem');

        if (tab === 'send') {
          sendPane.style.display = 'block';
          historyPane.style.display = 'none';
          systemPane.style.display = 'none';
          tabSend.classList.add('active');
          tabHistory.classList.remove('active');
          tabSystem.classList.remove('active');
        } else if (tab === 'history') {
          sendPane.style.display = 'none';
          historyPane.style.display = 'block';
          systemPane.style.display = 'none';
          tabSend.classList.remove('active');
          tabHistory.classList.add('active');
          tabSystem.classList.remove('active');
          loadHistory();
        } else if (tab === 'system') {
          sendPane.style.display = 'none';
          historyPane.style.display = 'none';
          systemPane.style.display = 'block';
          tabSend.classList.remove('active');
          tabHistory.classList.remove('active');
          tabSystem.classList.add('active');
          loadTokenStatus();
        }
      }

      // -------- Status ----------
      function setStatus(msg, ok) {
        const bar = document.getElementById('statusBar');
        const textEl = document.getElementById('statusText');
        bar.style.display = 'block';
        textEl.textContent = msg;
        textEl.className = ok ? 'status-ok' : 'status-error';
      }

      function getSelectedSendMode() {
        const radios = document.querySelectorAll('input[name="sendMode"]');
        for (const r of radios) {
          if (r.checked) return r.value;
        }
        return 'now';
      }

      function getTargetType() {
        const radios = document.querySelectorAll('input[name="targetType"]');
        for (const r of radios) {
          if (r.checked) return r.value;
        }
        return 'all';
      }

      // -------- Submit ----------
      function handleSubmit() {
        if (!currentUser) {
          alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå LINE ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
          return;
        }

        const btn = document.getElementById('btnSubmit');
        btn.disabled = true;
        setStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠...', true);

        const text = document.getElementById('message').value || '';
        const imageUrls = [];

        for (let i = 1; i <= 10; i++) {
          const val = (document.getElementById('imageUrl' + i).value || '').trim();
          if (val) imageUrls.push(val);
        }

        const mode = getSelectedSendMode();
        const targetType = getTargetType();
        let scheduleTimestamp = null;

        if (mode === 'schedule') {
          const dtVal = document.getElementById('scheduleAt').value;
          if (!dtVal) {
            setStatus('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤', false);
            btn.disabled = false;
            return;
          }
          const d = new Date(dtVal);
          if (isNaN(d.getTime())) {
            setStatus('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', false);
            btn.disabled = false;
            return;
          }
          scheduleTimestamp = d.getTime();
        }

        if (!text.trim() && imageUrls.length === 0) {
          setStatus('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏™‡πà URL ‡∏£‡∏π‡∏õ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', false);
          btn.disabled = false;
          return;
        }

        google.script.run
          .withSuccessHandler(function (res) {
            if (res && res.mode === 'scheduled') {
              setStatus('‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡πà‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢: ' + new Date(res.scheduleAt).toLocaleString(), true);
            } else if (res && res.mode === 'now') {
              setStatus('‡∏™‡πà‡∏á Broadcast ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß', true);
            } else {
              setStatus('‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô', true);
            }
            btn.disabled = false;
            loadHistory();
          })
          .withFailureHandler(function (err) {
            setStatus('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (err && err.message ? err.message : err), false);
            btn.disabled = false;
          })
          .createBroadcast(text, imageUrls, scheduleTimestamp, currentUser.lineUserId, targetType);
      }

      function clearForm() {
        document.getElementById('message').value = '';
        for (let i = 1; i <= 10; i++) {
          document.getElementById('imageUrl' + i).value = '';
          const f = document.getElementById('file' + i);
          if (f) f.value = '';
          const prevBox = document.getElementById('localPreview' + i);
          prevBox.style.display = 'none';
          prevBox.querySelector('img').src = '';
        }
        document.getElementById('scheduleAt').value = '';
        const bar = document.getElementById('statusBar');
        bar.style.display = 'none';
        updatePreview();
      }

      // -------- Preview ----------
      function updatePreview() {
        const text = document.getElementById('message').value || '';
        const previewText = document.getElementById('previewText');
        previewText.textContent = text.trim() ? text : '(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°)';

        const imageUrls = [];
        for (let i = 1; i <= 10; i++) {
          const val = (document.getElementById('imageUrl' + i).value || '').trim();
          if (val) imageUrls.push(val);
        }

        const imgContainer = document.getElementById('previewImages');
        imgContainer.innerHTML = '';
        imageUrls.slice(0, 4).forEach(u => {
          const img = document.createElement('img');
          img.src = u;
          img.alt = 'image';
          imgContainer.appendChild(img);
        });

        const mode = getSelectedSendMode();
        const targetType = getTargetType();
        const dtVal = document.getElementById('scheduleAt').value;

        let modeLabel = mode === 'schedule' ? '‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤' : '‡∏™‡πà‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ';
        let targetLabel = targetType === 'test' ? '‡∏ó‡∏î‡∏™‡∏≠‡∏ö (‡∏™‡πà‡∏á‡∏´‡∏≤‡πÄ‡∏£‡∏≤)' : '‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÉ‡∏ô OA';
        let timeLabel = '';

        if (mode === 'schedule' && dtVal) {
          const d = new Date(dtVal);
          if (!isNaN(d.getTime())) {
            timeLabel = ' @ ' + d.toLocaleString();
          }
        }

        document.getElementById('previewMeta').textContent =
          modeLabel + (timeLabel ? timeLabel : '') + ' | ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: ' + targetLabel;
      }

      // -------- Upload from Computer ----------
      function triggerFileUpload(slotIndex) {
        const input = document.getElementById('file' + slotIndex);
        if (input) input.click();
      }

      function handleFileChange(slotIndex) {
        const input = document.getElementById('file' + slotIndex);
        if (!input || !input.files || input.files.length === 0) return;

        const file = input.files[0];

        const reader = new FileReader();
        reader.onload = function (e) {
          const prevBox = document.getElementById('localPreview' + slotIndex);
          const img = prevBox.querySelector('img');
          img.src = e.target.result;
          prevBox.style.display = 'block';
        };
        reader.readAsDataURL(file);

        const form = document.getElementById('uploadForm');

        google.script.run
          .withSuccessHandler(function (res) {
            if (res && res.url) {
              document.getElementById('imageUrl' + res.slotIndex).value = res.url;
              updatePreview();
            } else {
              alert('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ URL ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤');
            }
          })
          .withFailureHandler(function (err) {
            alert('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (err && err.message ? err.message : err));
          })
          .uploadImageToDrive(form, slotIndex);
      }

      // -------- Google Drive Picker ----------
      function openDrivePicker(slotIndex) {
        if (!PICKER_API_KEY || !PICKER_CLIENT_ID) {
          alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Google Picker API Key / Client ID');
          return;
        }
        if (!pickerInited) {
          alert('Google Picker ‡∏¢‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
          return;
        }

        const token = liff.getAccessToken();
        if (!token) {
          alert('‡πÑ‡∏°‡πà‡∏û‡∏ö AccessToken ‡∏à‡∏≤‡∏Å LIFF (‡∏ñ‡πâ‡∏≤‡∏à‡∏∞‡πÉ‡∏ä‡πâ Drive Picker ‡∏à‡∏£‡∏¥‡∏á‡∏Ñ‡∏ß‡∏£‡∏ú‡∏π‡∏Å OAuth ‡πÄ‡∏û‡∏¥‡πà‡∏°)');
          return;
        }

        buildPicker(token, slotIndex);
      }

      function buildPicker(accessToken, slotIndex) {
        const view = new google.picker.DocsView(google.picker.ViewId.DOCS_IMAGES)
          .setIncludeFolders(true)
          .setSelectFolderEnabled(false);

        const picker = new google.picker.PickerBuilder()
          .setOAuthToken(accessToken)
          .setDeveloperKey(PICKER_API_KEY)
          .addView(view)
          .setCallback(function (data) {
            if (data.action === google.picker.Action.PICKED) {
              const doc = data.docs[0];
              const fileId = doc.id;
              google.script.run
                .withSuccessHandler(function (res) {
                  if (res && res.url) {
                    document.getElementById('imageUrl' + slotIndex).value = res.url;
                    updatePreview();
                  } else {
                    alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏à‡∏≤‡∏Å Drive ‡πÑ‡∏î‡πâ');
                  }
                })
                .withFailureHandler(function (err) {
                  alert('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ï‡∏≠‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏à‡∏≤‡∏Å Drive: ' + (err && err.message ? err.message : err));
                })
                .getDriveFilePublicUrl(fileId);
            }
          })
          .build();
        picker.setVisible(true);
      }

      // -------- History ----------
      function loadHistory() {
        if (!currentUser) return;
        const body = document.getElementById('historyBody');
        body.innerHTML = '<tr><td colspan="8" class="text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>';

        google.script.run
          .withSuccessHandler(renderHistory)
          .withFailureHandler(function (err) {
            body.innerHTML = '<tr><td colspan="8" class="text-muted">‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' +
              (err && err.message ? err.message : err) + '</td></tr>';
          })
          .getBroadcastHistory(50, currentUser.lineUserId);
      }

      function renderHistory(list) {
        const body = document.getElementById('historyBody');
        if (!list || list.length === 0) {
          body.innerHTML = '<tr><td colspan="8" class="text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ Broadcast</td></tr>';
          return;
        }

        const now = new Date();
        let html = '';

        list.forEach(item => {
          const created = item.createdAt ? new Date(item.createdAt) : null;
          const scheduleAt = item.scheduleAt ? new Date(item.scheduleAt) : null;
          const sentAt = item.sentAt ? new Date(item.sentAt) : null;

          const createdText = created ? created.toLocaleString() : '-';
          const scheduleText = scheduleAt ? scheduleAt.toLocaleString() : '-';
          const sentText = sentAt ? sentAt.toLocaleString() : '-';

          const modeBadge = item.mode === 'scheduled' ? '‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤' : '‡∏™‡πà‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ';
          const targetBadge = item.targetType === 'test' ? '‡∏ó‡∏î‡∏™‡∏≠‡∏ö' : '‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô';

          let statusClass = 'pill-cancelled';
          if (item.status === 'pending') statusClass = 'pill-pending';
          else if (item.status === 'sent') statusClass = 'pill-sent';
          else if (item.status === 'error') statusClass = 'pill-error';

          const statusLabel = item.status || '-';

          const textPreview = (item.text || '').trim();
          const textShort = textPreview.length > 60
            ? textPreview.slice(0, 60) + '‚Ä¶'
            : (textPreview || '-');

          const logText = (item.log || '').toString();
          const logShort = logText
            ? (logText.length > 60 ? logText.slice(0, 60) + '‚Ä¶' : logText)
            : '-';

          const isFuturePending = (item.status === 'pending' && scheduleAt && scheduleAt > now);

          let actions = '';

          if (isFuturePending) {
            actions += `
              <button class="btn btn-small btn-danger" type="button" onclick="confirmCancel('${item.jobId}')">
                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
              </button>
            `;
          }

          if (item.status === 'sent' || item.status === 'error' || isFuturePending) {
            actions += `
              <button class="btn btn-small btn-secondary" type="button" onclick="confirmRetry('${item.jobId}')">
                ‡∏™‡πà‡∏á‡∏ã‡πâ‡∏≥
              </button>
            `;
          }

          if (!actions) {
            actions = '<span class="text-muted">-</span>';
          }

          html += `
            <tr>
              <td>
                <div>${createdText}</div>
                <div class="text-muted" style="font-size:10px;">Schedule: ${scheduleText}<br>Sent: ${sentText}</div>
              </td>
              <td><span class="badge-mode">${modeBadge}</span></td>
              <td><span class="badge-mode">${targetBadge}</span></td>
              <td><div class="text-preview">${escapeHtml(textShort)}</div></td>
              <td>${item.imageCount || 0}</td>
              <td><span class="pill ${statusClass}">${statusLabel}</span></td>
              <td><div class="log-preview text-muted">${escapeHtml(logShort)}</div></td>
              <td>${actions}</td>
            </tr>
          `;
        });

        body.innerHTML = html;
      }

      function confirmCancel(jobId) {
        if (!currentUser) return;
        if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å Broadcast ‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;

        const body = document.getElementById('historyBody');
        body.insertAdjacentHTML('afterbegin',
          '<tr id="tempRow"><td colspan="8" class="text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å...</td></tr>'
        );

        google.script.run
          .withSuccessHandler(function () {
            const temp = document.getElementById('tempRow');
            if (temp) temp.remove();
            loadHistory();
          })
          .withFailureHandler(function (err) {
            const temp = document.getElementById('tempRow');
            if (temp) temp.remove();
            alert('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (err && err.message ? err.message : err));
          })
          .cancelBroadcast(jobId, currentUser.lineUserId);
      }

      function confirmRetry(jobId) {
        if (!currentUser) return;
        if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ã‡πâ‡∏≥ Broadcast ‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;

        const body = document.getElementById('historyBody');
        body.insertAdjacentHTML('afterbegin',
          '<tr id="tempRowRetry"><td colspan="8" class="text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏ã‡πâ‡∏≥...</td></tr>'
        );

        google.script.run
          .withSuccessHandler(function () {
            const temp = document.getElementById('tempRowRetry');
            if (temp) temp.remove();
            loadHistory();
          })
          .withFailureHandler(function (err) {
            const temp = document.getElementById('tempRowRetry');
            if (temp) temp.remove();
            alert('‡∏™‡πà‡∏á‡∏ã‡πâ‡∏≥‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (err && err.message ? err.message : err));
          })
          .retryBroadcast(jobId, currentUser.lineUserId);
      }

      // -------- Templates ----------
      function loadTemplates() {
        if (!currentUser) return;

        google.script.run
          .withSuccessHandler(function (list) {
            templatesList = Array.isArray(list) ? list : [];
            const select = document.getElementById('templateSelect');
            const hint = document.getElementById('templateHint');

            select.innerHTML = '<option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï ‚Äî</option>';

            templatesList.forEach(t => {
              const opt = document.createElement('option');
              opt.value = t.templateId;
              const dateStr = t.updatedAt ? new Date(t.updatedAt).toLocaleString() : '';
              opt.textContent = t.name + (dateStr ? ` (${dateStr})` : '');
              select.appendChild(opt);
            });

            hint.textContent = (templatesList.length || 0) + ' ‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï';
          })
          .withFailureHandler(function (err) {
            console.error('loadTemplates error:', err);
          })
          .getTemplates(currentUser.lineUserId);
      }

      function applySelectedTemplate() {
        const select = document.getElementById('templateSelect');
        const id = select.value;
        if (!id) {
          alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï‡∏Å‡πà‡∏≠‡∏ô');
          return;
        }

        const tpl = templatesList.find(t => t.templateId === id);
        if (!tpl) {
          alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å');
          return;
        }

        document.getElementById('message').value = tpl.text || '';

        for (let i = 1; i <= 10; i++) {
          document.getElementById('imageUrl' + i).value = '';
          const prevBox = document.getElementById('localPreview' + i);
          prevBox.style.display = 'none';
          prevBox.querySelector('img').src = '';
        }

        if (Array.isArray(tpl.imageUrls)) {
          tpl.imageUrls.slice(0, 10).forEach((u, idx) => {
            const input = document.getElementById('imageUrl' + (idx + 1));
            if (input) input.value = u;
          });
        }

        updatePreview();
      }

      function saveAsNewTemplate() {
        if (!currentUser) return;
        const name = prompt('‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï‡πÉ‡∏´‡∏°‡πà:');
        if (!name || !name.trim()) return;

        const text = document.getElementById('message').value || '';
        const imageUrls = [];
        for (let i = 1; i <= 10; i++) {
          const val = (document.getElementById('imageUrl' + i).value || '').trim();
          if (val) imageUrls.push(val);
        }

        google.script.run
          .withSuccessHandler(function () {
            alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
            loadTemplates();
          })
          .withFailureHandler(function (err) {
            alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (err && err.message ? err.message : err));
          })
          .saveTemplate(name, text, imageUrls, null, currentUser.lineUserId);
      }

      function updateCurrentTemplate() {
        if (!currentUser) return;
        const select = document.getElementById('templateSelect');
        const id = select.value;
        if (!id) {
          alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡πà‡∏≠‡∏ô');
          return;
        }

        const tpl = templatesList.find(t => t.templateId === id);
        if (!tpl) {
          alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å');
          return;
        }

        const text = document.getElementById('message').value || '';
        const imageUrls = [];
        for (let i = 1; i <= 10; i++) {
          const val = (document.getElementById('imageUrl' + i).value || '').trim();
          if (val) imageUrls.push(val);
        }

        const name = tpl.name || prompt('‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï (‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏¥‡∏°):') || tpl.name;

        google.script.run
          .withSuccessHandler(function () {
            alert('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
            loadTemplates();
          })
          .withFailureHandler(function (err) {
            alert('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (err && err.message ? err.message : err));
          })
          .saveTemplate(name, text, imageUrls, id, currentUser.lineUserId);
      }

      // -------- Token Status ----------
      function loadTokenStatus() {
        google.script.run
          .withSuccessHandler(renderTokenStatus)
          .withFailureHandler(function (err) {
            const summary = document.getElementById('tokenStatusSummary');
            const tag = document.getElementById('tokenStatusTag');
            const detail = document.getElementById('tokenStatusDetail');
            const errBox = document.getElementById('tokenStatusError');

            summary.textContent = '‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ token ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
            tag.textContent = 'ERROR';
            tag.className = 'token-status-tag token-status-tag-expired';
            detail.textContent = (err && err.message ? err.message : err);
            errBox.style.display = 'none';
          })
          .getChannelAccessTokenStatus();
      }

      function forceRefreshToken() {
        if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠ token ‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å LINE ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;

        const summary = document.getElementById('tokenStatusSummary');
        const detail = document.getElementById('tokenStatusDetail');
        const tag = document.getElementById('tokenStatusTag');
        const errBox = document.getElementById('tokenStatusError');

        summary.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ç‡∏≠ token ‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å LINE...';
        tag.textContent = 'LOADING';
        tag.className = 'token-status-tag token-status-tag-none';
        detail.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...';
        errBox.style.display = 'none';

        google.script.run
          .withSuccessHandler(renderTokenStatus)
          .withFailureHandler(function (err) {
            summary.textContent = 'Force refresh token ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
            tag.textContent = 'ERROR';
            tag.className = 'token-status-tag token-status-tag-expired';
            detail.textContent = (err && err.message ? err.message : err);
            errBox.style.display = 'none';
          })
          .refreshChannelAccessToken();
      }

      function renderTokenStatus(status) {
        const summary = document.getElementById('tokenStatusSummary');
        const tag = document.getElementById('tokenStatusTag');
        const detail = document.getElementById('tokenStatusDetail');
        const errBox = document.getElementById('tokenStatusError');

        if (!status || typeof status.hasToken === 'undefined') {
          summary.textContent = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ token';
          tag.textContent = 'UNKNOWN';
          tag.className = 'token-status-tag token-status-tag-none';
          detail.textContent = '‡∏•‡∏≠‡∏á‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
          errBox.style.display = 'none';
          return;
        }

        const hasToken = !!status.hasToken;
        const isExpired = !!status.isExpired;
        const remainingSeconds = Number(status.remainingSeconds || 0);
        const expiresAt = status.expiresAt ? new Date(status.expiresAt) : null;

        let tagText = 'NONE';
        let tagClass = 'token-status-tag token-status-tag-none';
        let summaryText = '';
        let detailText = '';

        if (!hasToken) {
          tagText = 'NO TOKEN';
          tagClass = 'token-status-tag token-status-tag-none';
          summaryText = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ token ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà';
          detailText = '‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ç‡∏≠ token ‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á Broadcast ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î Force refresh token';
        } else if (isExpired) {
          tagText = 'EXPIRED';
          tagClass = 'token-status-tag token-status-tag-expired';
          summaryText = 'token ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß';
          detailText = '‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ç‡∏≠ token ‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á Broadcast ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏î Force refresh token ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ';
        } else {
          tagText = 'ACTIVE';
          tagClass = 'token-status-tag token-status-tag-ok';
          summaryText = 'token ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏õ‡∏Å‡∏ï‡∏¥';

          const mins = Math.floor(remainingSeconds / 60);
          const secs = remainingSeconds % 60;
          const remainText =
            mins > 0
              ? `${mins} ‡∏ô‡∏≤‡∏ó‡∏µ ${secs} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ`
              : `${secs} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ`;

          const expiresStr = expiresAt ? expiresAt.toLocaleString() : '-';

          detailText =
            `‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ~ ${remainText}\n` +
            `‡∏à‡∏∞‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì: ${expiresStr}`;
        }

        summary.textContent = summaryText || '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Token';
        tag.textContent = tagText;
        tag.className = tagClass;
        detail.textContent = detailText;

        if (status.error) {
          errBox.style.display = 'block';
          errBox.textContent = 'Error ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠ token: ' + status.error;
        } else {
          errBox.style.display = 'none';
        }
      }

      // -------- Utils ----------
      function escapeHtml(str) {
        if (!str) return '';
        return str
          .replace(/&/g, '&amp;')
          .replace(/"/g, '&quot;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;');
      }
    </script>
  </body>
</html>
