<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>LINE OA Broadcast Enterprise++</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f172a;
      color: #e5e7eb;
    }
    .app {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
    }
    .card {
      background: #020617;
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 20px 40px rgba(15,23,42,0.6);
      border: 1px solid #1e293b;
    }
    .flex {
      display: flex;
    }
    .flex-row {
      display: flex;
      flex-direction: row;
      gap: 16px;
    }
    .flex-col {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .w-1-2 { flex: 1 1 0; }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 10px;
    }
    h1 {
      margin: 0 0 4px 0;
      font-size: 20px;
      font-weight: 600;
    }
    .sub {
      font-size: 12px;
      color: #9ca3af;
    }
    label {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 2px;
    }
    input[type="text"],
    input[type="datetime-local"],
    input[type="url"],
    select,
    textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      font-size: 13px;
      box-sizing: border-box;
    }
    textarea {
      min-height: 80px;
      resize: vertical;
    }
    input::placeholder, textarea::placeholder {
      color: #6b7280;
    }
    .btn {
      border-radius: 999px;
      border: none;
      padding: 8px 14px;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: #4f46e5;
      color: white;
    }
    .btn-secondary {
      background: #111827;
      color: #e5e7eb;
      border: 1px solid #374151;
    }
    .btn-danger {
      background: #b91c1c;
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: default;
    }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #111827;
      color: #e5e7eb;
    }
    .pill {
      border-radius: 999px;
      font-size: 11px;
      padding: 2px 8px;
      display: inline-block;
    }
    .pill-pending { background:#fbbf24; color:#111827; }
    .pill-sent    { background:#16a34a; color:#0f172a; }
    .pill-error   { background:#b91c1c; color:#fee2e2; }
    .pill-cancel  { background:#4b5563; color:#e5e7eb; }
    .tag-pill {
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      border:1px solid #4b5563;
      background: #020617;
      color:#e5e7eb;
      white-space: nowrap;
    }
    .tabs {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      border-bottom: 1px solid #1e293b;
      padding-bottom: 4px;
    }
    .tab-btn {
      border: none;
      background: transparent;
      color: #9ca3af;
      padding: 6px 10px;
      font-size: 13px;
      cursor: pointer;
      border-radius: 999px;
    }
    .tab-btn.active {
      background: #111827;
      color: #e5e7eb;
    }
    .image-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    .image-item {
      border-radius: 12px;
      border:1px solid #1f2937;
      padding: 6px;
      background:#020617;
    }
    .preview-box {
      border-radius: 12px;
      border: 1px solid #1f2937;
      padding: 10px;
      background: #020617;
      min-height: 160px;
    }
    .preview-images {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 6px;
    }
    .preview-images img {
      width: 68px;
      height: 68px;
      object-fit: cover;
      border-radius: 8px;
      border:1px solid #111827;
    }
    .status-bar {
      margin-top: 10px;
      font-size: 12px;
      color: #e5e7eb;
    }
    .status-chip-ok {
      background:#16a34a; color:#0f172a;
      padding:2px 8px; border-radius:999px; font-size:11px;
    }
    .status-chip-err {
      background:#b91c1c; color:#fee2e2;
      padding:2px 8px; border-radius:999px; font-size:11px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    th, td {
      border-bottom: 1px solid #1f2937;
      padding: 6px 4px;
      vertical-align: top;
    }
    th { text-align:left; color:#9ca3af; font-weight:500; }
    .text-muted { color:#9ca3af; font-size:11px; }
    .log-preview { max-width:180px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .text-preview { max-width:200px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .mt-2 { margin-top: 8px; }
    .mt-3 { margin-top: 12px; }
    .mt-4 { margin-top: 16px; }
    .gap-2 { gap:8px; }
    .gap-3 { gap:12px; }
    .hidden { display:none; }
    @media (max-width: 900px) {
      .flex-row { flex-direction: column; }
    }
  </style>
</head>
<body>
<div class="app">
  <div class="card">
    <div class="top-bar">
      <div>
        <h1>LINE OA Broadcast Enterprise++</h1>
        <div class="sub" id="userInfo">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
      </div>
      <div class="flex-col" style="align-items:flex-end;">
        <div>
          <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å OA</label><br>
          <select id="oaSelect" onchange="handleOaChanged()">
            <option value="">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î OA...</option>
          </select>
        </div>
        <div style="margin-top:4px;">
          <span id="oaModeTag" class="tag-pill">OA: - | MODE: -</span>
        </div>
      </div>
    </div>

    <div class="tabs">
      <button id="tabSend" class="tab-btn active" onclick="showTab('send')">‡∏™‡πà‡∏á Broadcast</button>
      <button id="tabHistory" class="tab-btn" onclick="showTab('history')">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
      <button id="tabSystem" class="tab-btn" onclick="showTab('system')">System</button>
    </div>

    <!-- not admin -->
    <div id="notAdminBox" class="mt-3 hidden">
      <div class="sub">
        ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏µ‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏ä‡∏µ‡∏ó <b>Admin</b>.
      </div>
    </div>

    <!-- ‡∏™‡πà‡∏á broadcast -->
    <div id="tabSendPane" class="mt-3">
      <div class="flex-row">
        <div class="w-1-2 flex-col">
          <div class="flex-col">
            <label>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</label>
            <textarea id="message" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." oninput="updatePreview()"></textarea>
          </div>

          <div class="flex-col mt-2">
            <label>‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 10 ‡∏£‡∏π‡∏õ / ‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ)</label>
            <div class="image-grid" id="imageGrid"></div>
          </div>

          <div class="flex-col mt-2">
            <label>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≠‡∏° (‡∏´‡∏•‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ)</label>
            <input type="file" id="multiFiles" accept="image/*" multiple />
            <button class="btn btn-secondary mt-2" type="button" onclick="handleMultiUpload()">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î & ‡πÄ‡∏ï‡∏¥‡∏°‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</button>
            <div class="sub">‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Drive ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡πÅ‡∏•‡πâ‡∏ß‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏î‡∏π‡∏†‡∏≤‡∏û‡πÉ‡∏´‡πâ</div>
          </div>

          <div class="flex-row mt-3 gap-3">
            <div class="flex-col" style="flex:1;">
              <label>‡πÇ‡∏´‡∏°‡∏î‡∏™‡πà‡∏á</label>
              <div>
                <label><input type="radio" name="sendMode" value="now" checked onchange="updatePreview()"> ‡∏™‡πà‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</label><br>
                <label><input type="radio" name="sendMode" value="schedule" onchange="updatePreview()"> ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤</label>
              </div>
              <input id="scheduleAt" type="datetime-local" class="mt-2" onchange="updatePreview()" />
            </div>
            <div class="flex-col" style="flex:1;">
              <label>‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</label>
              <div>
                <label><input type="radio" name="targetType" value="all" checked> ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÉ‡∏ô OA</label><br>
                <label><input type="radio" name="targetType" value="test"> ‡∏ó‡∏î‡∏™‡∏≠‡∏ö (‡∏™‡πà‡∏á‡∏´‡∏≤‡πÄ‡∏£‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)</label>
              </div>
            </div>
          </div>

          <div class="mt-3">
            <button id="btnSubmit" class="btn" type="button" onclick="handleSubmit()">üöÄ ‡∏™‡πà‡∏á Broadcast</button>
            <button class="btn btn-secondary" type="button" onclick="clearForm()" style="margin-left:8px;">‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
          </div>

          <div id="statusBar" class="status-bar hidden">
            <span id="statusChip" class="status-chip-ok"></span>
            <span id="statusText"></span>
          </div>
        </div>

        <div class="w-1-2 flex-col">
          <div class="flex-col">
            <label>‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á Preview</label>
            <div class="preview-box">
              <div class="sub" id="previewMeta">-</div>
              <div style="margin-top:6px; font-size:13px;" id="previewText">(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°)</div>
              <div class="preview-images" id="previewImages"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- history -->
    <div id="tabHistoryPane" class="mt-3 hidden">
      <div class="sub">‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (filter ‡∏ï‡∏≤‡∏° OA ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô)</div>
      <div class="mt-2" style="overflow-x:auto;">
        <table>
          <thead>
            <tr>
              <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
              <th>‡πÇ‡∏´‡∏°‡∏î</th>
              <th>‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</th>
              <th>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</th>
              <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏π‡∏õ</th>
              <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
              <th>Log</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="historyBody">
            <tr><td colspan="8" class="text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- system -->
    <div id="tabSystemPane" class="mt-3 hidden">
      <div class="flex-col">
        <label>Token Status (OA ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)</label>
        <div class="preview-box">
          <div id="tokenStatusSummary">‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</div>
          <div class="mt-2">
            <span id="tokenStatusTag" class="tag-pill">-</span>
          </div>
          <pre id="tokenStatusDetail" style="font-size:11px; margin-top:8px; white-space:pre-wrap;"></pre>
          <div id="tokenStatusError" class="text-muted mt-2 hidden"></div>
          <div class="mt-3">
            <button class="btn btn-secondary" type="button" onclick="loadTokenStatus()">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö token</button>
            <button class="btn" type="button" onclick="forceRefreshToken()" style="margin-left:8px;">Force refresh token</button>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
  // ================= CONFIG =================
  const API_BASE_URL = "https://script.google.com/macros/s/AKfycbzel2xyggGjFFqMpZkbOh561hAXzaPREJlVScmWnzwhC-NjnmLiifi6NaywMA_y7haj/exec";   // ‡πÄ‡∏ä‡πà‡∏ô https://script.google.com/macros/s/xxx/exec
  const LIFF_ID      = "2007213966-G3n3wn8v";

  let currentUser = null;
  let frontendConfig = {
    useLiffLogin: true,
    defaultAdminUserId: '',
    defaultOaId: ''
  };
  let oaList = [];
  let currentOaId = '';

  // ================ Helper ================
  function escapeHtml(str) {
    if (!str) return '';
    return str
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;');
  }

  async function apiJson(action, data) {
    const payload = Object.assign({}, data || {}, { action });
    const res = await fetch(API_BASE_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    if (!res.ok) throw new Error("HTTP "+res.status);
    return res.json();
  }

  function setStatus(msg, ok) {
    const bar = document.getElementById("statusBar");
    const chip = document.getElementById("statusChip");
    const text = document.getElementById("statusText");
    bar.classList.remove("hidden");
    chip.className = ok ? "status-chip-ok" : "status-chip-err";
    chip.textContent = ok ? "OK" : "ERROR";
    text.textContent = msg;
  }

  // ================ Tabs ===================
  function showTab(tab) {
    const send = document.getElementById("tabSendPane");
    const hist = document.getElementById("tabHistoryPane");
    const sys  = document.getElementById("tabSystemPane");
    const t1 = document.getElementById("tabSend");
    const t2 = document.getElementById("tabHistory");
    const t3 = document.getElementById("tabSystem");
    send.classList.add("hidden");
    hist.classList.add("hidden");
    sys.classList.add("hidden");
    t1.classList.remove("active");
    t2.classList.remove("active");
    t3.classList.remove("active");
    if (tab === 'send') {
      send.classList.remove("hidden");
      t1.classList.add("active");
    } else if (tab === 'history') {
      hist.classList.remove("hidden");
      t2.classList.add("active");
      loadHistory();
    } else {
      sys.classList.remove("hidden");
      t3.classList.add("active");
      loadTokenStatus();
    }
  }

  // ================ LIFF / No-LIFF ===================
  async function initApp() {
    try {
      // 1) frontend config
      const cfg = await apiJson("getFrontendConfig", {});
      if (cfg && cfg.ok) {
        frontendConfig.useLiffLogin = !!cfg.useLiffLogin;
        frontendConfig.defaultAdminUserId = cfg.defaultAdminUserId || '';
        frontendConfig.defaultOaId = cfg.defaultOaId || '';
      }

      // 2) OA list
      const oaRes = await apiJson("getOAs", {});
      if (oaRes && oaRes.ok) {
        oaList = oaRes.list || [];
      }
      initOaSelect();

      // 3) user
      if (frontendConfig.useLiffLogin) {
        await initLiffFlow();
      } else {
        initNoLiffFlow();
      }
    } catch (e) {
      console.error("initApp error", e);
      document.getElementById("userInfo").textContent =
        "‡πÇ‡∏´‡∏•‡∏î config/LIFF ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: "+(e.message || e);
      document.getElementById("notAdminBox").classList.remove("hidden");
    }
  }

  async function initLiffFlow() {
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) {
      liff.login();
      return;
    }
    const profile = await liff.getProfile();
    currentUser = { id: profile.userId, displayName: profile.displayName };
    document.getElementById("userInfo").textContent =
      "Login (LIFF): "+profile.displayName;

    const res = await apiJson("isAdmin", { userId: currentUser.id });
    if (!res || !res.ok) {
      document.getElementById("notAdminBox").classList.remove("hidden");
      return;
    }
    document.getElementById("notAdminBox").classList.add("hidden");
    loadHistory();
    updatePreview();
  }

  function initNoLiffFlow() {
    const id = frontendConfig.defaultAdminUserId;
    if (!id) {
      document.getElementById("userInfo").textContent =
        "No-LIFF mode ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á DEFAULT_ADMIN_USER_ID ‡πÉ‡∏ô Settings";
      document.getElementById("notAdminBox").classList.remove("hidden");
      return;
    }
    currentUser = { id, displayName: "Admin (No-LIFF)" };
    document.getElementById("userInfo").textContent =
      "No-LIFF mode: userId="+id;

    apiJson("isAdmin", { userId:id }).then(res => {
      if (!res || !res.ok) {
        document.getElementById("notAdminBox").classList.remove("hidden");
      } else {
        document.getElementById("notAdminBox").classList.add("hidden");
        loadHistory();
        updatePreview();
      }
    }).catch(e => {
      document.getElementById("userInfo").textContent =
        "No-LIFF error: "+(e.message || e);
      document.getElementById("notAdminBox").classList.remove("hidden");
    });
  }

  // ================ OA Select ===================
  function initOaSelect() {
    const sel = document.getElementById("oaSelect");
    sel.innerHTML = "";
    if (!oaList.length) {
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "‡πÑ‡∏°‡πà‡∏û‡∏ö OA ‡∏ó‡∏µ‡πà Active";
      sel.appendChild(opt);
      currentOaId = "";
      updateOaModeTag();
      return;
    }
    const def = frontendConfig.defaultOaId;
    const found = def && oaList.find(o => o.oaId === def);
    currentOaId = found ? found.oaId : oaList[0].oaId;

    oaList.forEach(o => {
      const opt = document.createElement("option");
      opt.value = o.oaId;
      opt.textContent = `${o.name} (${o.tokenMode})`;
      if (o.oaId === currentOaId) opt.selected = true;
      sel.appendChild(opt);
    });
    updateOaModeTag();
  }

  function handleOaChanged() {
    const sel = document.getElementById("oaSelect");
    currentOaId = sel.value || '';
    updateOaModeTag();
    loadHistory();
    loadTokenStatus();
  }

  function updateOaModeTag() {
    const tag = document.getElementById("oaModeTag");
    if (!currentOaId) {
      tag.textContent = "OA: - | MODE: -";
      return;
    }
    const oa = oaList.find(o => o.oaId === currentOaId);
    if (!oa) {
      tag.textContent = "OA: - | MODE: -";
      return;
    }
    tag.textContent = `OA: ${oa.name} | MODE: ${oa.tokenMode}`;
  }

  // ================ Image Grid & Preview ===================
  function initImageGrid() {
    const grid = document.getElementById("imageGrid");
    for (let i=1;i<=10;i++) {
      const div = document.createElement("div");
      div.className = "image-item";
      div.innerHTML = `
        <label>‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà ${i}</label>
        <input type="url" id="imageUrl${i}" placeholder="https://..." oninput="updatePreview()" />
      `;
      grid.appendChild(div);
    }
  }

  function collectImageUrls() {
    const urls = [];
    for (let i=1;i<=10;i++) {
      const v = (document.getElementById("imageUrl"+i).value || "").trim();
      if (v) urls.push(v);
    }
    return urls;
  }

  function getSendMode() {
    const radios = document.querySelectorAll("input[name='sendMode']");
    for (const r of radios) if (r.checked) return r.value;
    return "now";
  }

  function getTargetType() {
    const radios = document.querySelectorAll("input[name='targetType']");
    for (const r of radios) if (r.checked) return r.value;
    return "all";
  }

  function updatePreview() {
    const text = document.getElementById("message").value || "";
    const urls = collectImageUrls();
    document.getElementById("previewText").textContent =
      text.trim() ? text : "(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°)";
    const box = document.getElementById("previewImages");
    box.innerHTML = "";
    urls.slice(0,4).forEach(u => {
      const img = document.createElement("img");
      img.src = u;
      box.appendChild(img);
    });

    const mode = getSendMode();
    const target = getTargetType();
    const schedule = document.getElementById("scheduleAt").value;
    let modeLabel = mode === "schedule" ? "‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤" : "‡∏™‡πà‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ";
    let targetLabel = target === "test" ? "‡∏ó‡∏î‡∏™‡∏≠‡∏ö" : "‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô";
    let timeLabel = "";
    if (mode === "schedule" && schedule) {
      const d = new Date(schedule);
      if (!isNaN(d.getTime())) timeLabel = " @ "+d.toLocaleString();
    }
    document.getElementById("previewMeta").textContent =
      `${modeLabel}${timeLabel} | ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: ${targetLabel}`;
  }

  // ================ Multi Upload (base64) ===================
  async function handleMultiUpload() {
    if (!currentUser) { alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏ user (LIFF/No-LIFF)"); return; }
    if (!currentOaId) { alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å OA"); return; }
    const input = document.getElementById("multiFiles");
    if (!input.files.length) {
      alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå");
      return;
    }
    setStatus("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ...", true);
    const files = [];
    for (let file of input.files) {
      const base64 = await fileToBase64(file);
      files.push({
        name: file.name,
        mimeType: file.type || 'image/png',
        dataBase64: base64
      });
    }
    try {
      const res = await apiJson("uploadImages", {
        userId: currentUser.id,
        oaId: currentOaId,
        files
      });
      if (!res || !res.ok || !Array.isArray(res.urls)) {
        throw new Error("uploadImages response ‡∏ú‡∏¥‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö");
      }
      fillImageSlotsWithUrls(res.urls);
      setStatus("‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à "+res.urls.length+" ‡∏£‡∏π‡∏õ", true);
      updatePreview();
    } catch (e) {
      console.error(e);
      setStatus("‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: "+(e.message || e), false);
    } finally {
      input.value = "";
    }
  }

  function fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = e => {
        const result = e.target.result; // data:...;base64,xxx
        const commaIndex = result.indexOf(",");
        const b64 = commaIndex >= 0 ? result.substring(commaIndex+1) : result;
        resolve(b64);
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  function fillImageSlotsWithUrls(urls) {
    let idx = 0;
    for (let i=1;i<=10 && idx<urls.length;i++) {
      const input = document.getElementById("imageUrl"+i);
      if (!input.value.trim()) {
        input.value = urls[idx++];
      }
    }
  }

  // ================ Submit ===================
  async function handleSubmit() {
    if (!currentUser) { alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏ user (LIFF/No-LIFF)"); return; }
    if (!currentOaId) { alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å OA"); return; }
    const btn = document.getElementById("btnSubmit");
    btn.disabled = true;
    setStatus("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÑ‡∏õ‡∏¢‡∏±‡∏á backend...", true);

    const text   = document.getElementById("message").value || '';
    const images = collectImageUrls();
    const mode   = getSendMode();
    const target = getTargetType();
    let scheduleAt = null;

    if (mode === "schedule") {
      const val = document.getElementById("scheduleAt").value;
      if (!val) {
        setStatus("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤", false);
        btn.disabled = false;
        return;
      }
      scheduleAt = val;
    }
    if (!text.trim() && images.length === 0) {
      setStatus("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏π‡∏õ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£", false);
      btn.disabled = false;
      return;
    }

    try {
      const res = await apiJson("createBroadcast", {
        oaId: currentOaId,
        userId: currentUser.id,
        text,
        images,
        mode,
        target,
        scheduleAt
      });
      if (!res || !res.ok) {
        throw new Error(JSON.stringify(res));
      }
      if (res.mode === 'scheduled') {
        setStatus("‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤ Broadcast ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢", true);
      } else {
        setStatus("‡∏™‡πà‡∏á Broadcast ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß", true);
      }
      loadHistory();
    } catch (e) {
      console.error(e);
      setStatus("‡∏™‡πà‡∏á Broadcast ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: "+(e.message || e), false);
    } finally {
      btn.disabled = false;
    }
  }

  function clearForm() {
    document.getElementById("message").value = "";
    document.getElementById("scheduleAt").value = "";
    for (let i=1;i<=10;i++) {
      document.getElementById("imageUrl"+i).value = "";
    }
    document.getElementById("statusBar").classList.add("hidden");
    updatePreview();
  }

  // ================ History ===================
  async function loadHistory() {
    if (!currentUser || !currentOaId) return;
    const body = document.getElementById("historyBody");
    body.innerHTML = `<tr><td colspan="8" class="text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>`;
    try {
      const res = await apiJson("history", {
        oaId: currentOaId,
        userId: currentUser.id,
        limit: 50
      });
      if (!res || !res.ok || !Array.isArray(res.list) || !res.list.length) {
        body.innerHTML = `<tr><td colspan="8" class="text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</td></tr>`;
        return;
      }
      const now = new Date();
      const rows = res.list.map(item => {
        const created = item.createdAt ? new Date(item.createdAt) : null;
        const schedule= item.scheduleAt ? new Date(item.scheduleAt) : null;
        const sent    = item.sentAt ? new Date(item.sentAt) : null;
        const createdText  = created ? created.toLocaleString() : "-";
        const scheduleText = schedule? schedule.toLocaleString() : "-";
        const sentText     = sent   ? sent.toLocaleString() : "-";
        const modeLabel   = item.mode === 'scheduled' ? '‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤' : '‡∏™‡πà‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ';
        const targetLabel = item.targetType === 'test' ? '‡∏ó‡∏î‡∏™‡∏≠‡∏ö' : '‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô';
        let statusClass = 'pill-cancel';
        if (item.status === 'pending') statusClass = 'pill-pending';
        else if (item.status === 'sent') statusClass = 'pill-sent';
        else if (item.status === 'error') statusClass = 'pill-error';

        const textShort = (item.text || '').trim();
        const tShort = textShort.length > 50 ? textShort.slice(0,50)+'‚Ä¶' : (textShort || '-');

        const logText = (item.log || '').toString();
        const lShort = logText ? (logText.length>50?logText.slice(0,50)+'‚Ä¶':logText) : '-';

        const imagesCount = item.imageCount || (Array.isArray(item.images)?item.images.length:0);
        const futurePending = (item.status === 'pending' && schedule && schedule > now);

        let actions = "";
        if (futurePending) {
          actions += `<button class="btn btn-secondary" type="button" onclick="onCancel('${item.jobId}')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button> `;
        }
        actions += `<button class="btn btn-secondary" type="button" onclick="onRetry('${item.jobId}')">‡∏™‡πà‡∏á‡∏ã‡πâ‡∏≥</button>`;
        return `
          <tr>
            <td>
              <div>${createdText}</div>
              <div class="text-muted">Schedule: ${scheduleText}<br>Sent: ${sentText}</div>
            </td>
            <td>${modeLabel}</td>
            <td>${targetLabel}</td>
            <td><div class="text-preview">${escapeHtml(tShort)}</div></td>
            <td>${imagesCount}</td>
            <td><span class="pill ${statusClass}">${item.status}</span></td>
            <td><div class="log-preview text-muted">${escapeHtml(lShort)}</div></td>
            <td>${actions}</td>
          </tr>
        `;
      });
      body.innerHTML = rows.join("");
    } catch (e) {
      console.error(e);
      body.innerHTML = `<tr><td colspan="8" class="text-muted">‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${escapeHtml(e.message || e)}</td></tr>`;
    }
  }

  async function onCancel(jobId) {
    if (!currentUser) return;
    if (!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å Broadcast ‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;
    try {
      const res = await apiJson("cancel", { userId: currentUser.id, jobId });
      if (!res || !res.ok) alert("‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: "+JSON.stringify(res));
      loadHistory();
    } catch (e) {
      alert("‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: "+(e.message || e));
    }
  }

  async function onRetry(jobId) {
    if (!currentUser) return;
    if (!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ã‡πâ‡∏≥ Broadcast ‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;
    try {
      const res = await apiJson("retry", { userId: currentUser.id, jobId });
      if (!res || !res.ok) alert("‡∏™‡πà‡∏á‡∏ã‡πâ‡∏≥‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: "+JSON.stringify(res));
      loadHistory();
    } catch (e) {
      alert("‡∏™‡πà‡∏á‡∏ã‡πâ‡∏≥‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: "+(e.message || e));
    }
  }

  // ================ Token Status ===================
  async function loadTokenStatus() {
    if (!currentUser || !currentOaId) return;
    const summary = document.getElementById("tokenStatusSummary");
    const tag     = document.getElementById("tokenStatusTag");
    const detail  = document.getElementById("tokenStatusDetail");
    const errBox  = document.getElementById("tokenStatusError");
    summary.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö token...";
    tag.textContent = "LOADING";
    detail.textContent = "";
    errBox.classList.add("hidden");
    try {
      const st = await apiJson("tokenStatus", {
        userId: currentUser.id,
        oaId: currentOaId
      });
      if (!st || !st.ok) throw new Error(JSON.stringify(st));
      renderTokenStatus(st);
    } catch (e) {
      summary.textContent = "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö token ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
      tag.textContent = "ERROR";
      detail.textContent = e.message || e;
      errBox.classList.add("hidden");
    }
  }

  async function forceRefreshToken() {
    if (!currentUser || !currentOaId) return;
    if (!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ Force refresh token ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö OA ‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;
    const summary = document.getElementById("tokenStatusSummary");
    const tag     = document.getElementById("tokenStatusTag");
    const detail  = document.getElementById("tokenStatusDetail");
    const errBox  = document.getElementById("tokenStatusError");
    summary.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á refresh token...";
    tag.textContent = "LOADING";
    detail.textContent = "";
    errBox.classList.add("hidden");
    try {
      const st = await apiJson("refreshToken", {
        userId: currentUser.id,
        oaId: currentOaId
      });
      if (!st || !st.ok) throw new Error(JSON.stringify(st));
      renderTokenStatus(st);
    } catch (e) {
      summary.textContent = "Force refresh token ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
      tag.textContent = "ERROR";
      detail.textContent = e.message || e;
      errBox.classList.add("hidden");
    }
  }

  function renderTokenStatus(st) {
    const summary = document.getElementById("tokenStatusSummary");
    const tag     = document.getElementById("tokenStatusTag");
    const detail  = document.getElementById("tokenStatusDetail");
    const errBox  = document.getElementById("tokenStatusError");

    const mode = st.tokenMode || '-';
    if (mode === 'LONG') {
      summary.textContent = "‡πÇ‡∏´‡∏°‡∏î LONG-LIVED TOKEN";
      tag.textContent = st.hasToken ? "ACTIVE" : "NO TOKEN";
      detail.textContent = st.hasToken
        ? "‡πÉ‡∏ä‡πâ long-lived token ‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ó OA_Config\n(‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏ô‡∏ä‡∏µ‡∏ó‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á)"
        : "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏™‡πà long_lived_token ‡πÉ‡∏ô OA_Config";
    } else {
      // SHORT
      if (!st.hasToken) {
        summary.textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ short token ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß";
        tag.textContent = "EXPIRED/EMPTY";
        detail.textContent = "‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ç‡∏≠ token ‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á Broadcast ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ Force refresh token";
      } else if (st.isExpired) {
        summary.textContent = "short token ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß";
        tag.textContent = "EXPIRED";
        detail.textContent = "‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ç‡∏≠ token ‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á Broadcast ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ Force refresh token";
      } else {
        const mins = Math.floor((st.remainingSeconds || 0)/60);
        const secs = (st.remainingSeconds || 0) % 60;
        const remain = mins>0 ? `${mins} ‡∏ô‡∏≤‡∏ó‡∏µ ${secs} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ` : `${secs} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ`;
        summary.textContent = "short token ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏õ‡∏Å‡∏ï‡∏¥";
        tag.textContent = "ACTIVE";
        detail.textContent =
          `‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ~ ${remain}\n‡∏à‡∏∞‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì: ${
            st.expiresAt ? new Date(st.expiresAt).toLocaleString() : '-'
          }`;
      }
    }
    if (st.error) {
      errBox.classList.remove("hidden");
      errBox.textContent = "Error ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å backend: "+st.error;
    } else {
      errBox.classList.add("hidden");
    }
  }

  // ================ DOM Ready ===================
  document.addEventListener("DOMContentLoaded", () => {
    initImageGrid();
    updatePreview();
    initApp();
  });
</script>
</body>
</html>
