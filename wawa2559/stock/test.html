<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ“¦ à¸ªà¹à¸à¸™à¹à¸¥à¸°à¹à¸à¹‰à¹„à¸‚à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸´à¸™à¸„à¹‰à¸²</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f4f4f4; }
    .box, .result-box, .btn-box, .sheet-box, .login-box {
      background: #fff; margin-top: 20px; padding: 15px;
      border-radius: 8px; box-shadow: 0 0 6px rgba(0,0,0,0.1);
    }
    .label { font-weight: bold; color: #333; }
    button {
      padding: 10px; margin-top: 10px; width: 100%;
      background: #007bff; color: white; border: none; border-radius: 5px;
      font-size: 1rem; cursor: pointer;
    }
    button:hover { background: #0056b3; }
    .logout { background: crimson; margin-bottom: 10px; }
    .vertical-table { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }
    .v-row { display: flex; flex-direction: column; }
    .v-row label { font-weight: bold; }
    .v-row input, .v-row span {
      padding: 8px; border-radius: 5px;
    }
    .v-row input { border: 1px solid #ccc; }
    .v-row span { background: #eee; border: 1px solid #ccc; }
    #scanHistory li { padding: 5px 0; border-bottom: 1px solid #eee; }
  </style>
</head>
<body>

<div class="login-box" id="loginBox">
  <h2>ğŸ” à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸š</h2>
  <label>ğŸ‘¤ à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰</label>
  <input type="text" id="username">
  <label>ğŸ”‘ à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™</label>
  <input type="password" id="password">
  <button onclick="login()">ğŸ”“ à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸š</button>
</div>

<div id="mainApp" style="display:none">
  <button class="logout" onclick="logout()">ğŸšª à¸­à¸­à¸à¸ˆà¸²à¸à¸£à¸°à¸šà¸š</button>
  <h2>ğŸ” à¸ªà¹à¸à¸™ Barcode à¸ªà¸´à¸™à¸„à¹‰à¸²</h2>
  <div id="reader" style="width: 100%;"></div>

  <div class="result-box" id="result" style="display: none;">
    <div><span class="label">ğŸ“Œ Barcode:</span> <span id="barcodeText"></span></div>
    <div><span class="label">ğŸ”‘ IC Code:</span> <span id="icCode"></span></div>
    <div><span class="label">ğŸ“¦ à¸«à¸™à¹ˆà¸§à¸¢:</span> <span id="unitCode"></span></div>
  </div>

  <div class="btn-box" id="actionButtons" style="display:none;">
    <button onclick="startScan()">ğŸ”„ à¸ªà¹à¸à¸™à¹ƒà¸«à¸¡à¹ˆ</button>
    <button onclick="getSmlData()">ğŸ” à¸”à¸¹à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸ SML</button>
    <button onclick="getSheetData()">ğŸ“„ à¸”à¸¹à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸ Sheet</button>
  </div>

  <div class="sheet-box" id="sheetDataResult" style="display:none;">
    <h3>ğŸ“‹ à¹à¸à¹‰à¹„à¸‚à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸ Sheet</h3>
    <form id="sheetForm" onsubmit="saveSheetData(event)">
      <button type="submit">ğŸ’¾ à¸šà¸±à¸™à¸—à¸¶à¸à¸à¸¥à¸±à¸š Google Sheet</button>
      <div id="sheetVerticalTable" class="vertical-table"></div>
    </form>
  </div>

  <div class="sheet-box" id="smlDataResult" style="display:none;">
    <h3>ğŸ§¾ à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸ SML</h3>
    <form id="smlForm" onsubmit="submitSmlUpdate(event)">
      <div id="smlFields" class="vertical-table"></div>
      <button type="submit">ğŸ“¤ à¸­à¸±à¸›à¹€à¸”à¸•à¸à¸¥à¸±à¸š SML</button>
    </form>
  </div>

  <div class="sheet-box" id="scanHistoryBox">
    <h3>ğŸ•˜ à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸à¸²à¸£à¸ªà¹à¸à¸™à¸¥à¹ˆà¸²à¸ªà¸¸à¸”</h3>
    <ul id="scanHistory" style="list-style: none; padding-left: 0;"></ul>
  </div>
</div>

<audio id="beepSound" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg" preload="auto"></audio>

<script>
// âœ… à¸¥à¸´à¸‡à¸à¹Œ API à¹à¸¢à¸à¸Šà¸±à¸”à¹€à¸ˆà¸™
const authAPI = "https://script.google.com/macros/s/AKfycbyuxwEJM0q--XhbXTCD4lr275v8GJ2dyUP0t5QzayiBQREDVRpBaKUJLDQ0vOr9cxmF/exec"; // ğŸ” Login
const sheetAPI = "https://script.google.com/macros/s/AKfycbxkue2j9mKYMkDxNCcsyihRVPH87qHeQygNBhxsLqhj4FfRmbyFpO00XCm6CBTGvKkI/exec"; // ğŸ“„ Sheet
const smlBackendAPI = "https://script.google.com/macros/s/AKfycby9rFdE4cN5fzMGIgs66psVHe9SukVKpDtt3IiASeXlk2S1POKuHpJXInUQ7-lzsuteDQ/exec"; // ğŸ§¾ SML
const barcodeAPI = "https://script.google.com/macros/s/AKfycbwQtPsLfDLqG9wYtpG6zO4GgY7zUzdtKkPa4oLToQ6Ng8JIq5XDbJYvzvOOayZWIvg8hA/exec?barcode=";

let currentIC = "";
let currentUser = "";
let currentPass = "";
const SESSION_TIMEOUT = 30 * 60 * 1000;
const scanHistory = [];

function encrypt(text) { return btoa(unescape(encodeURIComponent(text))); }
function decrypt(text) { try { return decodeURIComponent(escape(atob(text))); } catch (e) { return ""; } }

function checkSession() {
  const session = sessionStorage.getItem("login");
  if (session) {
    const obj = JSON.parse(decrypt(session));
    if (Date.now() - obj.timestamp < SESSION_TIMEOUT) {
      currentUser = obj.username;
      currentPass = obj.password;
      document.getElementById("loginBox").style.display = "none";
      document.getElementById("mainApp").style.display = "block";
      startScan(); return;
    }
  }
  const lastUser = localStorage.getItem("lastUsername");
  if (lastUser) document.getElementById("username").value = lastUser;
}

function login() {
  const u = document.getElementById("username").value.trim();
  const p = document.getElementById("password").value.trim();
  if (!u || !p) return Swal.fire("âŒ à¸œà¸´à¸”à¸à¸¥à¸²à¸”", "à¸à¸£à¸­à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸«à¹‰à¸„à¸£à¸š", "error");
  currentUser = u; currentPass = p;
  Swal.fire({ title: "ğŸ” à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š...", didOpen: () => Swal.showLoading() });
  fetch(authAPI, {
    method: "POST",
    body: new URLSearchParams({ username: u, password: p, action: "ping" })
  }).then(r => r.json()).then(res => {
    Swal.close();
    if (res.success !== false) {
      localStorage.setItem("lastUsername", u);
      sessionStorage.setItem("login", encrypt(JSON.stringify({ username: u, password: p, timestamp: Date.now() })));
      document.getElementById("loginBox").style.display = "none";
      document.getElementById("mainApp").style.display = "block";
      startScan();
    } else Swal.fire("âŒ", "Login à¸œà¸´à¸”à¸à¸¥à¸²à¸”", "error");
  });
}

function logout() {
  sessionStorage.removeItem("login");
  location.reload();
}

function showResult(data) {
  document.getElementById("barcodeText").innerText = data.barcode || "-";
  document.getElementById("icCode").innerText = data.ic_code || "-";
  document.getElementById("unitCode").innerText = data.unit_code || "-";
  currentIC = data.ic_code || "";
  document.getElementById("result").style.display = "block";
  document.getElementById("actionButtons").style.display = "block";
  document.getElementById("sheetDataResult").style.display = "none";
  document.getElementById("smlDataResult").style.display = "none";
  document.getElementById("beepSound").play();
  navigator.vibrate && navigator.vibrate([100]);
  Swal.close();
  addToScanHistory(data.barcode || "-", data.ic_code || "-");
}

function addToScanHistory(barcode, ic_code) {
  const timestamp = new Date().toLocaleTimeString();
  scanHistory.unshift({ barcode, ic_code, timestamp });
  if (scanHistory.length > 5) scanHistory.pop();
  const ul = document.getElementById("scanHistory");
  ul.innerHTML = "";
  scanHistory.forEach(item => {
    const li = document.createElement("li");
    li.innerHTML = `<span class="label">[${item.timestamp}]</span> Barcode: ${item.barcode}, IC: ${item.ic_code}`;
    ul.appendChild(li);
  });
}

function onScanSuccess(decodedText) {
  Swal.fire({ title: "ğŸ“¥ à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”...", allowOutsideClick: false, didOpen: () => Swal.showLoading() });
  html5QrcodeScanner.clear().then(() => {
    fetch(barcodeAPI + encodeURIComponent(decodedText))
      .then(res => res.json())
      .then(data => showResult(data))
      .catch(err => { Swal.close(); alert("âŒ à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ: " + err); });
  });
}

let html5QrcodeScanner;
function startScan() {
  document.getElementById("result").style.display = "none";
  document.getElementById("actionButtons").style.display = "none";
  document.getElementById("sheetDataResult").style.display = "none";
  document.getElementById("smlDataResult").style.display = "none";
  html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: { width: 250, height: 100 } }, false);
  html5QrcodeScanner.render(onScanSuccess);
}

function getSheetData() {
  if (!currentIC) return alert("à¹„à¸¡à¹ˆà¸à¸š IC Code");
  Swal.fire({ title: "à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸ Sheet...", allowOutsideClick: false, didOpen: () => Swal.showLoading() });
  fetch(`${sheetAPI}?ic_code=${encodeURIComponent(currentIC)}`)
    .then(res => res.json())
    .then(data => {
      const container = document.getElementById("sheetVerticalTable");
      container.innerHTML = "";
      for (const key in data) {
        const row = document.createElement("div");
        row.className = "v-row";
        row.innerHTML = `<label>${key}</label>`;
        if (["minimum_qty", "maximum_qty"].includes(key)) {
          row.innerHTML += `<input name="${key}" value="${data[key]}">`;
        } else {
          row.innerHTML += `<span>${data[key]}</span>`;
        }
        container.appendChild(row);
      }
      document.getElementById("sheetForm").dataset.ic_code = currentIC;
      document.getElementById("sheetDataResult").style.display = "block";
      document.getElementById("smlDataResult").style.display = "none";
      Swal.close();
    });
}

function saveSheetData(e) {
  e.preventDefault();
  const form = document.getElementById("sheetForm");
  const ic_code = form.dataset.ic_code;
  const data = new URLSearchParams({ username: currentUser, password: currentPass, action: "updateSheet", ic_code });
  form.querySelectorAll("input").forEach(i => data.append(i.name, i.value));
  Swal.fire({ title: "à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥...", didOpen: () => Swal.showLoading() });
  fetch(sheetAPI, { method: "POST", body: data })
    .then(r => r.json())
    .then(r => Swal.fire(r.success ? "âœ… à¸ªà¸³à¹€à¸£à¹‡à¸ˆ" : "âŒ", r.success ? "à¸šà¸±à¸™à¸—à¸¶à¸à¹à¸¥à¹‰à¸§" : r.message, r.success ? "success" : "error"));
}

function getSmlData() {
  if (!currentIC) return alert("à¹„à¸¡à¹ˆà¸à¸š IC Code");
  Swal.fire({ title: "à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸ SML...", allowOutsideClick: false, didOpen: () => Swal.showLoading() });
  fetch(`${smlBackendAPI}?ic_code=${encodeURIComponent(currentIC)}&username=${currentUser}&password=${currentPass}`)
    .then(res => res.json())
    .then(result => {
      const data = result.data || {};
      const container = document.getElementById("smlFields");
      container.innerHTML = "";
      const inv = data.inventory_detail || {};
      const bar = (data.inventory_barcode || [])[0] || {};
      const fieldsToShow = {
        code: data.code,
        name_1: data.name_1,
        barcode: bar.barcode,
        balance_qty: data.balance_qty,
        minimum_qty: inv.minimum_qty,
        maximum_qty: inv.maximum_qty,
        purchase_point: inv.purchase_point,
        is_hold_purchase: inv.is_hold_purchase,
        is_hold_sale: inv.is_hold_sale
      };
      Object.entries(fieldsToShow).forEach(([key, value]) => {
        const row = document.createElement("div");
        row.className = "v-row";
        row.innerHTML = `<label>${key}</label>`;
        if (["minimum_qty", "maximum_qty", "purchase_point"].includes(key)) {
          row.innerHTML += `<input name="${key}" value="${value ?? ""}">`;
        } else {
          row.innerHTML += `<span>${value ?? ""}</span>`;
        }
        container.appendChild(row);
      });
      document.getElementById("smlForm").dataset.ic_code = currentIC;
      document.getElementById("smlDataResult").style.display = "block";
      document.getElementById("sheetDataResult").style.display = "none";
      Swal.close();
    })
    .catch(err => {
      Swal.close();
      Swal.fire("âŒ à¸œà¸´à¸”à¸à¸¥à¸²à¸”", "à¹‚à¸«à¸¥à¸” SML à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ: " + err, "error");
    });
}

function submitSmlUpdate(e) {
  e.preventDefault();
  const form = document.getElementById("smlForm");
  const ic_code = form.dataset.ic_code;
  const data = new URLSearchParams({ username: currentUser, password: currentPass, action: "updateSML", ic_code });
  form.querySelectorAll("input").forEach(i => data.append(i.name, i.value));
  Swal.fire({ title: "à¸à¸³à¸¥à¸±à¸‡à¸­à¸±à¸›à¹€à¸”à¸• SML...", didOpen: () => Swal.showLoading() });
  fetch(smlBackendAPI, { method: "POST", body: data })
    .then(r => r.json())
    .then(r => Swal.fire(r.success ? "âœ… à¸ªà¸³à¹€à¸£à¹‡à¸ˆ" : "âŒ", r.success ? "à¸šà¸±à¸™à¸—à¸¶à¸à¹à¸¥à¹‰à¸§" : r.message, r.success ? "success" : "error"));
}

window.onload = checkSession;
</script>
</body>
</html>
